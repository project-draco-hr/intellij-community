{
  if (ClassUtilCore.isLoadingOfExternalPluginsDisabled()) {
    return IdeaPluginDescriptorImpl.EMPTY_ARRAY;
  }
  final List<IdeaPluginDescriptorImpl> result=new ArrayList<IdeaPluginDescriptorImpl>();
  int pluginsCount=countPlugins(PathManager.getPluginsPath()) + countPlugins(PathManager.getPreInstalledPluginsPath());
  loadDescriptors(PathManager.getPluginsPath(),result,progress,pluginsCount);
  Application application=ApplicationManager.getApplication();
  boolean fromSources=false;
  if (application == null || !application.isUnitTestMode()) {
    int size=result.size();
    loadDescriptors(PathManager.getPreInstalledPluginsPath(),result,progress,pluginsCount);
    fromSources=size == result.size();
  }
  loadDescriptorsFromProperty(result);
  loadDescriptorsFromClassPath(result,getClassLoaderUrls(),fromSources ? progress : null);
  return topoSortPlugins(result,errors);
}
