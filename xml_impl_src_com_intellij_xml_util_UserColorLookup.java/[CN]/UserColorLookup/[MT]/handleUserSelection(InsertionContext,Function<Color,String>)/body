{
  Color myColorAtCaret=null;
  Editor selectedTextEditor=context.getEditor();
  PsiElement element=context.getFile().findElementAt(selectedTextEditor.getCaretModel().getOffset());
  if (element instanceof XmlToken) {
    myColorAtCaret=getColorFromElement(element);
  }
  context.getDocument().deleteString(context.getStartOffset(),context.getTailOffset());
  ColorPickerListener[] listeners=ColorPickerListenerFactory.createListenersFor(element);
  Color color=ColorChooser.chooseColor(WindowManager.getInstance().suggestParentWindow(context.getProject()),XmlBundle.message("choose.color.dialog.title"),myColorAtCaret,true,listeners,true);
  if (color != null) {
    String colorString=colorToStringConverter.fun(color);
    context.getDocument().insertString(context.getStartOffset(),colorString);
    context.getEditor().getCaretModel().moveToOffset(context.getTailOffset());
  }
}
