{
  if (pathMacroSubstitutor != null) {
    pathMacroSubstitutor.expandPaths(rootElement);
  }
  StringInterner interner=intern ? new StringInterner() : null;
  List<Element> children=rootElement.getChildren(COMPONENT);
  TreeMap<String,Element> map=new TreeMap<String,Element>();
  for (  Element element : children) {
    String name=getComponentNameIfValid(element);
    if (name == null || !(element.getAttributes().size() > 1 || !element.getChildren().isEmpty())) {
      continue;
    }
    if (interner != null) {
      JDOMUtil.internElement(element,interner);
    }
    map.put(name,element);
    if (pathMacroSubstitutor instanceof TrackingPathMacroSubstitutor) {
      ((TrackingPathMacroSubstitutor)pathMacroSubstitutor).addUnknownMacros(name,PathMacrosCollector.getMacroNames(element));
    }
    element.removeAttribute(NAME);
  }
  return fromMap(map);
}
