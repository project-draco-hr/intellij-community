{
  Project project=CommonDataKeys.PROJECT.getData(dataContext);
  if (project == null) {
    return null;
  }
  ToolWindowManagerEx mgr=ToolWindowManagerEx.getInstanceEx(project);
  String id=mgr.getActiveToolWindowId();
  if (id == null) {
    if (mgr.isEditorComponentActive()) {
      id=mgr.getLastActiveToolWindowId();
    }
  }
  ToolWindowEx toolWindow=id != null ? (ToolWindowEx)mgr.getToolWindow(id) : null;
  if (requiresVisibleToolWindow && (toolWindow == null || !toolWindow.isVisible())) {
    return null;
  }
  ContentManager fromToolWindow=toolWindow != null ? toolWindow.getContentManager() : null;
  ContentManager fromContext=PlatformDataKeys.CONTENT_MANAGER.getData(dataContext);
  return ObjectUtils.chooseNotNull(fromContext,fromToolWindow);
}
