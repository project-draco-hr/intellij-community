{
  PsiElement element=null;
  final Editor editor=CommonDataKeys.EDITOR.getData(dataContext);
  if (editor != null) {
    final PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (psiFile != null) {
      final int offset=editor.getCaretModel().getOffset();
      element=psiFile.findElementAt(offset);
      if (element == null && offset > 0 && offset == psiFile.getTextLength()) {
        element=psiFile.findElementAt(offset - 1);
      }
    }
  }
  if (element == null) {
    final PsiElement[] elements=LangDataKeys.PSI_ELEMENT_ARRAY.getData(dataContext);
    element=elements != null && elements.length >= 1 ? elements[0] : null;
  }
  if (element == null) {
    final VirtualFile file=CommonDataKeys.VIRTUAL_FILE.getData(dataContext);
    if (file != null) {
      element=PsiManager.getInstance(project).findFile(file);
    }
  }
  return element;
}
