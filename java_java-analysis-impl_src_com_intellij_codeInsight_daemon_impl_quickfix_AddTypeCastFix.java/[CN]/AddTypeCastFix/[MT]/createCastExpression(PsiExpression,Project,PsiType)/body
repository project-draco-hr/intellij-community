{
  PsiElement expression=PsiUtil.deparenthesizeExpression(original);
  if (expression == null)   return null;
  PsiElementFactory factory=JavaPsiFacade.getInstance(original.getProject()).getElementFactory();
  if (type instanceof PsiEllipsisType)   type=((PsiEllipsisType)type).toArrayType();
  String text="(" + type.getCanonicalText(false) + ")value";
  PsiTypeCastExpression typeCast=(PsiTypeCastExpression)factory.createExpressionFromText(text,original);
  typeCast=(PsiTypeCastExpression)CodeStyleManager.getInstance(project).reformat(typeCast);
  if (expression instanceof PsiConditionalExpression) {
    PsiConditionalExpression conditional=(PsiConditionalExpression)expression.copy();
    PsiExpression thenE=conditional.getThenExpression();
    PsiExpression elseE=conditional.getElseExpression();
    PsiType thenType=thenE == null ? null : thenE.getType();
    PsiType elseType=elseE == null ? null : elseE.getType();
    if (elseType != null && thenType != null) {
      boolean replaceThen=!TypeConversionUtil.isAssignable(type,thenType);
      boolean replaceElse=!TypeConversionUtil.isAssignable(type,elseType);
      if (replaceThen != replaceElse) {
        if (replaceThen) {
          assertNotNull(typeCast.getOperand()).replace(thenE);
          thenE.replace(typeCast);
        }
 else {
          assertNotNull(typeCast.getOperand()).replace(elseE);
          elseE.replace(typeCast);
        }
        return conditional;
      }
    }
  }
  assertNotNull(typeCast.getOperand()).replace(expression);
  return typeCast;
}
