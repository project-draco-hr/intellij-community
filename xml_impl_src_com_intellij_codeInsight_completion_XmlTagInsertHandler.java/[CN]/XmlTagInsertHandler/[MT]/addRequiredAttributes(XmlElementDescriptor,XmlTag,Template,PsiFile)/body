{
  boolean htmlCode=HtmlUtil.hasHtml(containingFile) || HtmlUtil.supportsXmlTypedHandlers(containingFile);
  Set<String> notRequiredAttributes=Collections.emptySet();
  if (tag instanceof HtmlTag) {
    final InspectionProfile profile=InspectionProjectProfileManager.getInstance(tag.getProject()).getCurrentProfile();
    XmlEntitiesInspection inspection=(XmlEntitiesInspection)profile.getUnwrappedTool(XmlEntitiesInspection.REQUIRED_ATTRIBUTES_SHORT_NAME,tag);
    if (inspection != null) {
      StringTokenizer tokenizer=new StringTokenizer(inspection.getAdditionalEntries());
      notRequiredAttributes=new HashSet<>();
      while (tokenizer.hasMoreElements())       notRequiredAttributes.add(tokenizer.nextToken());
    }
  }
  XmlAttributeDescriptor[] attributes=descriptor.getAttributesDescriptors(tag);
  StringBuilder indirectRequiredAttrs=null;
  if (WebEditorOptions.getInstance().isAutomaticallyInsertRequiredAttributes()) {
    final XmlExtension extension=XmlExtension.getExtension(containingFile);
    for (    XmlAttributeDescriptor attributeDecl : attributes) {
      String attributeName=attributeDecl.getName(tag);
      boolean shouldBeInserted=extension.shouldBeInserted(attributeDecl);
      if (shouldBeInserted && (tag == null || tag.getAttributeValue(attributeName) == null)) {
        if (!notRequiredAttributes.contains(attributeName)) {
          if (!extension.isIndirectSyntax(attributeDecl)) {
            template.addTextSegment(" " + attributeName + "="+ XmlAttributeInsertHandler.getAttributeQuote(htmlCode));
            template.addVariable(new MacroCallNode(new CompleteMacro()),true);
            template.addTextSegment(XmlAttributeInsertHandler.getAttributeQuote(htmlCode));
          }
 else {
            if (indirectRequiredAttrs == null)             indirectRequiredAttrs=new StringBuilder();
            indirectRequiredAttrs.append("\n<jsp:attribute name=\"").append(attributeName).append("\"></jsp:attribute>\n");
          }
        }
      }
 else       if (shouldBeInserted && attributeDecl.isFixed() && attributeDecl.getDefaultValue() != null && !htmlCode) {
        template.addTextSegment(" " + attributeName + "="+ XmlAttributeInsertHandler.getAttributeQuote(false)+ attributeDecl.getDefaultValue()+ XmlAttributeInsertHandler.getAttributeQuote(false));
      }
    }
  }
  return indirectRequiredAttrs;
}
