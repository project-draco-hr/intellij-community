{
  final Ref<Throwable> exceptionRef=new Ref<Throwable>();
  ProgressManager.getInstance().run(new Task.Modal(project,caption,true){
    public void run(    @NotNull ProgressIndicator indicator){
      try {
        task.consume(indicator);
      }
 catch (      Throwable e) {
        exceptionRef.set(e);
      }
    }
  }
);
  if (!exceptionRef.isNull()) {
    Throwable e=exceptionRef.get();
    if (e instanceof RuntimeException)     throw ((RuntimeException)e);
    if (e instanceof Error)     throw ((Error)e);
    throw new RuntimeException(e);
  }
}
