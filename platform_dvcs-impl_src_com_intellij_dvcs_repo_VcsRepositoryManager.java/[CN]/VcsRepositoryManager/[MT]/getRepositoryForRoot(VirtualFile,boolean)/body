{
  if (root == null)   return null;
  Repository result;
  try {
    repoLock.readLock().lock();
    Repository repo=myRepositories.get(root);
    result=repo != null ? repo : myExternalRepositories.get(root);
  }
  finally {
    repoLock.readLock().unlock();
  }
  if (updateIfNeeded && result == null && ArrayUtil.contains(root,myVcsManager.getAllVersionedRoots())) {
    checkAndUpdateRepositoriesCollection(root);
    try {
      repoLock.readLock().lock();
      return myRepositories.get(root);
    }
  finally {
      repoLock.readLock().unlock();
    }
  }
 else {
    return result;
  }
}
