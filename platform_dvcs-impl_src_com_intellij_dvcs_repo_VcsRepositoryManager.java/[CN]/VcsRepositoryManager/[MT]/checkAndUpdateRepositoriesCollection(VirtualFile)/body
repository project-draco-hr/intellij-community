{
  Map<VirtualFile,Repository> repositories;
  try {
    modifyLock.lock();
    try {
      repoLock.readLock().lock();
      if (myRepositories.containsKey(checkedRoot)) {
        return;
      }
      repositories=ContainerUtil.newHashMap(myRepositories);
    }
  finally {
      repoLock.readLock().unlock();
    }
    Collection<VirtualFile> invalidRoots=findInvalidRoots(repositories.keySet());
    repositories.keySet().removeAll(invalidRoots);
    Map<VirtualFile,Repository> newRoots=findNewRoots(repositories.keySet());
    repositories.putAll(newRoots);
    repoLock.writeLock().lock();
    try {
      myRepositories.clear();
      myRepositories.putAll(repositories);
    }
  finally {
      repoLock.writeLock().unlock();
    }
  }
  finally {
    modifyLock.unlock();
  }
}
