{
  int textLength=text.length;
  if (view.getEditor().myDisableRtl)   return Collections.singletonList(new BidiRun((byte)0,0,textLength));
  List<BidiRun> runs=new ArrayList<BidiRun>();
  EditorHighlighter highlighter=view.getHighlighter();
  if (startOffsetInEditor >= 0 && highlighter != null) {
    int lastOffset=startOffsetInEditor;
    IElementType lastToken=null;
    HighlighterIterator iterator=highlighter.createIterator(startOffsetInEditor);
    int endOffsetInEditor=startOffsetInEditor + textLength;
    while (!iterator.atEnd() && iterator.getStart() < endOffsetInEditor) {
      IElementType currentToken=iterator.getTokenType();
      if (currentToken != lastToken) {
        int tokenStart=Math.max(iterator.getStart(),startOffsetInEditor);
        addRuns(runs,text,lastOffset - startOffsetInEditor,tokenStart - startOffsetInEditor);
        lastToken=currentToken;
        lastOffset=tokenStart;
      }
      iterator.advance();
    }
    addRuns(runs,text,lastOffset - startOffsetInEditor,endOffsetInEditor - startOffsetInEditor);
  }
 else {
    addRuns(runs,text,0,textLength);
  }
  return runs;
}
