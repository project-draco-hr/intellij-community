{
  final Module module=ProjectRootManager.getInstance(myProject).getFileIndex().getModuleForFile(codePanel.getFileEditor().getVirtualFile());
  if (module != null) {
    final Sdk sdk=PythonSdkType.findPythonSdk(module);
    if (sdk != null) {
      try {
        final PyPackage ipython=PyPackageManager.getInstance(sdk).findPackage("ipython",true);
        if (ipython != null && VersionComparatorUtil.compare(ipython.getVersion(),"3.0") <= 0) {
          return new IpnbConnection(urlString,listener);
        }
      }
 catch (      ExecutionException e) {
        return new IpnbConnectionV3(urlString,listener);
      }
    }
  }
  return new IpnbConnectionV3(urlString,listener);
}
