{
  try {
    final IpnbConnectionListenerBase listener=new IpnbConnectionListenerBase(){
      @Override public void onOpen(      @NotNull IpnbConnection connection){
        final String messageId=connection.execute(codePanel.getCell().getSourceAsString());
        myUpdateMap.put(messageId,codePanel);
      }
      @Override public void onOutput(      @NotNull IpnbConnection connection,      @NotNull String parentMessageId,      @NotNull List<IpnbOutputCell> outputs,      @Nullable Integer execCount){
        if (!myUpdateMap.containsKey(parentMessageId))         return;
        final IpnbCodePanel cell=myUpdateMap.remove(parentMessageId);
        cell.getCell().setPromptNumber(execCount);
        cell.updatePanel(outputs);
      }
    }
;
    final URI url=new URI(urlString);
    HttpRequests.request(urlString + "/api").connect(new HttpRequests.RequestProcessor<Object>(){
      @Override public Object process(      @NotNull HttpRequests.Request request) throws IOException {
        final IpnbConnection connection;
        try {
          if (request.isSuccessful()) {
            connection=new IpnbConnectionV3(url,listener);
          }
 else {
            connection=new IpnbConnection(url,listener);
          }
          myKernels.put(path,connection);
        }
 catch (        URISyntaxException e) {
          if (showNotification) {
            showWarning(codePanel.getFileEditor(),"IPython Notebook connection refused");
          }
          LOG.warn("IPython Notebook connection refused: " + e.getMessage());
        }
        return null;
      }
    }
);
  }
 catch (  URISyntaxException e) {
    if (showNotification)     showWarning(codePanel.getFileEditor(),"Please, check IPython Notebook URL in <a href=\"\">Settings->Tools->IPython Notebook</a>",new HyperlinkAdapter(){
      @Override protected void hyperlinkActivated(      HyperlinkEvent e){
        ShowSettingsUtil.getInstance().showSettingsDialog(myProject,"IPython Notebook");
      }
    }
);
    LOG.warn("IPython Notebook URI Syntax Error: " + e.getMessage());
    return false;
  }
catch (  IOException e) {
    if (showNotification)     showWarning(codePanel.getFileEditor(),"IPython Notebook connection refused");
    LOG.warn("IPython Notebook connection refused: " + e.getMessage());
    return false;
  }
  return true;
}
