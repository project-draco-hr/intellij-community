{
  final IpnbFileEditor fileEditor=codePanel.getFileEditor();
  final VirtualFile virtualFile=fileEditor.getVirtualFile();
  final String path=virtualFile.getPath();
  if (!myKernels.containsKey(path)) {
    String url=IpnbSettings.getInstance(myProject).getURL();
    if (url == null) {
      url=DEFAULT_URL;
    }
    if (!isAvailable(url)) {
      url=showDialogUrl(url);
      if (url == null)       return;
      startIpythonServer(url,fileEditor);
      if (myProcessHandler != null) {
        waitForIpythonServer();
        startConnection(codePanel,path,url);
        return;
      }
 else {
        showWarning(fileEditor,"Could not start IPython Notebook");
        return;
      }
    }
    if (StringUtil.isEmptyOrSpaces(url)) {
      showWarning(fileEditor,"Please, specify IPython Notebook URL in <a href=\"\">Settings->IPython Notebook</a>");
      return;
    }
    startConnection(codePanel,path,url);
  }
 else {
    final IpnbConnection connection=myKernels.get(path);
    if (connection != null) {
      final String messageId=connection.execute(codePanel.getCell().getSourceAsString());
      myUpdateMap.put(messageId,codePanel);
    }
  }
}
