{
  String text=EditorModificationUtil.getStringContent(content);
  if (text == null)   return null;
  if (editor.getCaretModel().supportsMultipleCarets()) {
    int caretCount=editor.getCaretModel().getCaretCount();
    if (caretCount == 1 && editor.isColumnMode()) {
      int pastedLineCount=LineTokenizer.calcLineCount(text,true);
      EditorModificationUtil.deleteSelectedText(editor);
      Caret caret=editor.getCaretModel().getPrimaryCaret();
      for (int i=0; i < pastedLineCount - 1; i++) {
        caret=caret.clone(false);
        if (caret == null) {
          break;
        }
      }
      caretCount=editor.getCaretModel().getCaretCount();
    }
    CaretStateTransferableData caretData=null;
    try {
      caretData=content.isDataFlavorSupported(CaretStateTransferableData.FLAVOR) ? (CaretStateTransferableData)content.getTransferData(CaretStateTransferableData.FLAVOR) : null;
    }
 catch (    Exception e) {
      LOG.error(e);
    }
    final TextRange[] ranges=new TextRange[caretCount];
    final Iterator<String> segments=new ClipboardTextPerCaretSplitter().split(text,caretData,caretCount).iterator();
    final int[] index={0};
    editor.getCaretModel().runForEachCaret(new CaretAction(){
      @Override public void perform(      Caret caret){
        String normalizedText=TextBlockTransferable.convertLineSeparators(editor,segments.next());
        int caretOffset=caret.getOffset();
        ranges[index[0]++]=new TextRange(caretOffset,caretOffset + normalizedText.length());
        EditorModificationUtil.insertStringAtCaret(editor,normalizedText,false,true);
      }
    }
);
    return ranges;
  }
 else {
    int caretOffset=editor.getCaretModel().getOffset();
    String normalizedText=TextBlockTransferable.convertLineSeparators(editor,text);
    EditorModificationUtil.insertStringAtCaret(editor,normalizedText,false,true);
    return new TextRange[]{new TextRange(caretOffset,caretOffset + text.length())};
  }
}
