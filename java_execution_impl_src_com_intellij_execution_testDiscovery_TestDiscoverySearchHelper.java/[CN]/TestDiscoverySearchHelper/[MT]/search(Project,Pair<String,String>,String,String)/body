{
  final Set<String> patterns=new LinkedHashSet<String>();
  if (position != null) {
    try {
      collectPatterns(project,patterns,position.first,position.second,frameworkPrefix);
    }
 catch (    IOException ignore) {
    }
  }
 else {
    final List<VirtualFile> files=getAffectedFiles(changeList,project);
    final PsiManager psiManager=PsiManager.getInstance(project);
    for (    final VirtualFile file : files) {
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        @Override public void run(){
          final PsiFile psiFile=psiManager.findFile(file);
          if (psiFile != null) {
            try {
              final List<TextRange> changedTextRanges=FormatChangedTextUtil.getChangedTextRanges(project,psiFile);
              for (              TextRange textRange : changedTextRanges) {
                final PsiElement start=psiFile.findElementAt(textRange.getStartOffset());
                final PsiElement end=psiFile.findElementAt(textRange.getEndOffset());
                final PsiElement parent=PsiTreeUtil.findCommonParent(new PsiElement[]{start,end});
                final Collection<PsiMethod> methods=new ArrayList<PsiMethod>(PsiTreeUtil.findChildrenOfType(parent,PsiMethod.class));
                final PsiMethod containingMethod=PsiTreeUtil.getParentOfType(parent,PsiMethod.class);
                if (containingMethod != null) {
                  methods.add(containingMethod);
                }
                for (                PsiMethod changedMethod : methods) {
                  final LinkedHashSet<String> detectedPatterns=collectPatterns(changedMethod,frameworkPrefix);
                  if (detectedPatterns != null) {
                    patterns.addAll(detectedPatterns);
                  }
                }
              }
            }
 catch (            FilesTooBigForDiffException ignore) {
            }
          }
        }
      }
);
    }
  }
  return patterns;
}
