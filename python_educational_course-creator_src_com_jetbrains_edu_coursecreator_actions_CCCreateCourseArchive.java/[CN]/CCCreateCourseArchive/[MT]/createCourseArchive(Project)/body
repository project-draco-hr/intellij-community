{
  final CCProjectService service=CCProjectService.getInstance(project);
  final Course course=service.getCourse();
  if (course == null)   return;
  CreateCourseArchiveDialog dlg=new CreateCourseArchiveDialog(project,this);
  dlg.show();
  if (dlg.getExitCode() != DialogWrapper.OK_EXIT_CODE) {
    return;
  }
  final VirtualFile baseDir=project.getBaseDir();
  final List<Lesson> lessons=course.getLessons();
  final Map<TaskFile,TaskFile> savedTaskFiles=new HashMap<TaskFile,TaskFile>();
  for (  Lesson lesson : lessons) {
    final VirtualFile lessonDir=baseDir.findChild(EduNames.LESSON + String.valueOf(lesson.getIndex()));
    if (lessonDir == null)     continue;
    for (    Task task : lesson.getTaskList()) {
      final VirtualFile taskDir=lessonDir.findChild(EduNames.TASK + String.valueOf(task.getIndex()));
      if (taskDir == null)       continue;
      for (      final Map.Entry<String,TaskFile> entry : task.getTaskFiles().entrySet()) {
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          @Override public void run(){
            TaskFile taskFileCopy=new TaskFile();
            TaskFile taskFile=entry.getValue();
            TaskFile.copy(taskFile,taskFileCopy);
            savedTaskFiles.put(taskFile,taskFileCopy);
            EduUtils.createStudentFileFromAnswer(project,taskDir,taskDir,entry.getKey(),taskFile);
          }
        }
);
      }
    }
  }
  generateJson(project);
  VirtualFileManager.getInstance().refreshWithoutFileWatcher(false);
  packCourse(baseDir,course);
  synchronize(project);
  resetTaskFiles(savedTaskFiles);
}
