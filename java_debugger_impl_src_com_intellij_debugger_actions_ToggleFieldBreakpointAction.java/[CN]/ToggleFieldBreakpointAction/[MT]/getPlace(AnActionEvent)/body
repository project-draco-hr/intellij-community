{
  final DataContext dataContext=event.getDataContext();
  final Project project=event.getData(CommonDataKeys.PROJECT);
  if (project == null) {
    return null;
  }
  if (ActionPlaces.PROJECT_VIEW_POPUP.equals(event.getPlace()) || ActionPlaces.STRUCTURE_VIEW_POPUP.equals(event.getPlace()) || ActionPlaces.FAVORITES_VIEW_POPUP.equals(event.getPlace())) {
    final PsiElement psiElement=event.getData(CommonDataKeys.PSI_ELEMENT);
    if (psiElement instanceof PsiField) {
      return SourcePosition.createFromElement(psiElement);
    }
    return null;
  }
  final DebuggerTreeNodeImpl selectedNode=DebuggerAction.getSelectedNode(dataContext);
  if (selectedNode != null && selectedNode.getDescriptor() instanceof FieldDescriptorImpl) {
    final DebuggerContextImpl debuggerContext=DebuggerAction.getDebuggerContext(dataContext);
    final DebugProcessImpl debugProcess=debuggerContext.getDebugProcess();
    if (debugProcess != null) {
      final Ref<SourcePosition> positionRef=new Ref<SourcePosition>(null);
      debugProcess.getManagerThread().invokeAndWait(new DebuggerContextCommandImpl(debuggerContext){
        public Priority getPriority(){
          return Priority.HIGH;
        }
        public void threadAction(){
          ApplicationManager.getApplication().runReadAction(new Runnable(){
            public void run(){
              positionRef.set(SourcePositionProvider.getSourcePosition(selectedNode.getDescriptor(),project,debuggerContext));
            }
          }
);
        }
      }
);
      final SourcePosition sourcePosition=positionRef.get();
      if (sourcePosition != null) {
        return sourcePosition;
      }
    }
  }
  if (DebuggerAction.isContextView(event)) {
    DebuggerTree tree=DebuggerTree.DATA_KEY.getData(dataContext);
    if (tree != null && tree.getSelectionPath() != null) {
      DebuggerTreeNodeImpl node=((DebuggerTreeNodeImpl)tree.getSelectionPath().getLastPathComponent());
      if (node != null && node.getDescriptor() instanceof FieldDescriptorImpl) {
        Field field=((FieldDescriptorImpl)node.getDescriptor()).getField();
        DebuggerSession session=tree.getDebuggerContext().getDebuggerSession();
        PsiClass psiClass=DebuggerUtils.findClass(field.declaringType().name(),project,(session != null) ? session.getSearchScope() : GlobalSearchScope.allScope(project));
        if (psiClass != null) {
          psiClass=(PsiClass)psiClass.getNavigationElement();
          final PsiField psiField=psiClass.findFieldByName(field.name(),true);
          if (psiField != null) {
            return SourcePosition.createFromElement(psiField);
          }
        }
      }
    }
    return null;
  }
  Editor editor=event.getData(CommonDataKeys.EDITOR);
  if (editor == null) {
    editor=FileEditorManager.getInstance(project).getSelectedTextEditor();
  }
  if (editor != null) {
    final Document document=editor.getDocument();
    PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
    if (file != null) {
      final VirtualFile virtualFile=file.getVirtualFile();
      FileType fileType=virtualFile != null ? virtualFile.getFileType() : null;
      if (StdFileTypes.JAVA == fileType || StdFileTypes.CLASS == fileType) {
        final PsiField field=FieldBreakpoint.findField(project,document,editor.getCaretModel().getOffset());
        if (field != null) {
          return SourcePosition.createFromElement(field);
        }
      }
    }
  }
  return null;
}
