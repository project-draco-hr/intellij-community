{
  EventLoopGroup eventLoopGroup=null;
  if (shutdownEventLoopGroup) {
    for (    Channel channel : openChannels) {
      if (channel instanceof ServerChannel) {
        eventLoopGroup=channel.eventLoop().parent();
        break;
      }
    }
  }
  Future<?> result;
  try {
    Object[] channels=openChannels.toArray(new Channel[]{});
    ChannelGroupFuture groupFuture=openChannels.close();
    if (!groupFuture.awaitUninterruptibly(10,TimeUnit.SECONDS)) {
      LOG.warn("Cannot close all channels for 10 seconds, channels: " + Arrays.toString(channels));
    }
    result=groupFuture;
  }
  finally {
    if (eventLoopGroup != null) {
      result=eventLoopGroup.shutdownGracefully(1,2,TimeUnit.NANOSECONDS);
    }
  }
  return result;
}
