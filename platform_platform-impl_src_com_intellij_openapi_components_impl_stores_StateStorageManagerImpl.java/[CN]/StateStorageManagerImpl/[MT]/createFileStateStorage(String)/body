{
  String expandedFile=expandMacros(fileSpec);
  if (expandedFile == null) {
    myStorages.put(fileSpec,null);
    return null;
  }
  if (!ourHeadlessEnvironment && PathUtilRt.getFileName(expandedFile).lastIndexOf('.') < 0) {
    throw new IllegalArgumentException("Extension is missing for storage file: " + expandedFile);
  }
  return new FileBasedStorage(getMacroSubstitutor(fileSpec),getStreamProvider(),expandedFile,fileSpec,myRootTagName,this,myPicoContainer,ComponentRoamingManager.getInstance(),this){
    @Override @NotNull protected StorageData createStorageData(){
      return StateStorageManagerImpl.this.createStorageData(fileSpec);
    }
  }
;
}
