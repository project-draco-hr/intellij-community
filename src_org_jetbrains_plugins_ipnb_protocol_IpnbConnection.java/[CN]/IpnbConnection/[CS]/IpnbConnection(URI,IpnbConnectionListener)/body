{
  myURI=uri;
  myListener=listener;
  mySessionId=UUID.randomUUID().toString();
  myKernelId=startKernel();
  final Draft draft=new Draft17WithOrigin();
  final String authMessage="identity:foo";
  myShellClient=new WebSocketClient(getShellURI(),draft){
    @Override public void onOpen(    @NotNull ServerHandshake handshakeData){
      send(authMessage);
      myIsShellOpen=true;
      notifyOpen();
    }
    @Override public void onMessage(    @NotNull String message){
    }
    @Override public void onClose(    int code,    @NotNull String reason,    boolean remote){
    }
    @Override public void onError(    @NotNull Exception e){
    }
  }
;
  myShellThread=new Thread(myShellClient);
  myShellThread.start();
  myIOPubClient=new WebSocketClient(getIOPubURI(),draft){
    private LinkedHashMap<String,String> myOutput=new LinkedHashMap<String,String>();
    @Override public void onOpen(    ServerHandshake handshakeData){
      send(authMessage);
      myIsIOPubOpen=true;
      notifyOpen();
    }
    @Override public void onMessage(    String message){
      final Gson gson=new Gson();
      final Message msg=gson.fromJson(message,Message.class);
      final Header header=msg.getHeader();
      final Header parentHeader=gson.fromJson(msg.getParentHeader(),Header.class);
      final String messageType=header.getMessageType();
      if ("pyout".equals(messageType)) {
        final PyOutContent content=gson.fromJson(msg.getContent(),PyOutContent.class);
        myOutput.putAll(content.getData());
      }
 else       if ("pyerr".equals(messageType)) {
        final PyErrContent content=gson.fromJson(msg.getContent(),PyErrContent.class);
        myOutput.putAll(ImmutableMap.of("error",content.getEvalue()));
      }
 else       if ("stream".equals(messageType)) {
        final PyStreamContent content=gson.fromJson(msg.getContent(),PyStreamContent.class);
        myOutput.putAll(ImmutableMap.of("stream",content.getData()));
      }
 else       if ("status".equals(messageType)) {
        final PyStatusContent content=gson.fromJson(msg.getContent(),PyStatusContent.class);
        if (content.getExecutionState().equals("idle")) {
          myListener.onOutput(IpnbConnection.this,parentHeader.getMessageId(),(Map<String,String>)myOutput.clone());
          myOutput.clear();
        }
      }
    }
    @Override public void onClose(    int code,    String reason,    boolean remote){
    }
    @Override public void onError(    Exception ex){
    }
  }
;
  myIOPubThread=new Thread(myIOPubClient);
  myIOPubThread.start();
}
