{
  final Ref<Boolean> evaluated=Ref.create(false);
  final IpnbConnection connection=new IpnbConnection(getTestServerURI(),new IpnbConnectionListenerBase(){
    private String myMessageId;
    @Override public void onOpen(    @NotNull IpnbConnection connection){
      myMessageId=connection.execute("2 + 2");
    }
    @Override public void onOutput(    @NotNull IpnbConnection connection,    @NotNull String parentMessageId,    @NotNull Map<String,String> outputs){
      if (myMessageId.equals(parentMessageId)) {
        assertEquals("4",outputs.get("text/plain"));
        evaluated.set(true);
        connection.shutdown();
      }
    }
  }
);
  connection.close();
  assertTrue(evaluated.get());
}
