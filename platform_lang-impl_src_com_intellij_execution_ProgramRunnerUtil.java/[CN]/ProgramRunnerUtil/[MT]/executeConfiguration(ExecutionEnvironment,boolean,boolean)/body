{
  if (ExecutorRegistry.getInstance().isStarting(environment)) {
    return;
  }
  RunnerAndConfigurationSettings runnerAndConfigurationSettings=environment.getRunnerAndConfigurationSettings();
  if (runnerAndConfigurationSettings != null) {
    if (!ExecutionTargetManager.canRun(environment)) {
      ExecutionUtil.handleExecutionError(environment,new ExecutionException(StringUtil.escapeXml("Cannot run '" + environment.getRunProfile().getName() + "' on '"+ environment.getExecutionTarget().getDisplayName()+ "'")));
      return;
    }
    if (!RunManagerImpl.canRunConfiguration(environment) || (showSettings && runnerAndConfigurationSettings.isEditBeforeRun())) {
      if (!RunDialog.editConfiguration(environment,"Edit configuration")) {
        return;
      }
      while (!RunManagerImpl.canRunConfiguration(environment)) {
        if (Messages.YES == Messages.showYesNoDialog(environment.getProject(),"Configuration is still incorrect. Do you want to edit it again?","Change Configuration Settings","Edit","Continue Anyway",Messages.getErrorIcon())) {
          if (!RunDialog.editConfiguration(environment,"Edit configuration")) {
            return;
          }
        }
 else {
          break;
        }
      }
    }
    ConfigurationType configurationType=runnerAndConfigurationSettings.getType();
    if (configurationType != null) {
      UsageTrigger.trigger("execute." + ConvertUsagesUtil.ensureProperKey(configurationType.getId()) + "."+ environment.getExecutor().getId());
    }
  }
  try {
    if (assignNewId) {
      environment.assignNewExecutionId();
    }
    final Project project=environment.getProject();
    if (DumbService.isDumb(project) && Registry.is("dumb.aware.run.configurations")) {
      UIUtil.invokeLaterIfNeeded(new Runnable(){
        @Override public void run(){
          if (project.isDisposed()) {
            return;
          }
          final String toolWindowId=environment.getExecutor().getToolWindowId();
          ToolWindowManager toolWindowManager=ToolWindowManager.getInstance(project);
          if (toolWindowManager.canShowNotification(toolWindowId)) {
            toolWindowManager.notifyByBalloon(toolWindowId,MessageType.INFO,"Some actions may not work as expected if you start a Run/debug configuration while indexing is in progress.");
          }
        }
      }
);
    }
    environment.getRunner().execute(environment);
  }
 catch (  ExecutionException e) {
    String name=runnerAndConfigurationSettings != null ? runnerAndConfigurationSettings.getName() : null;
    if (name == null) {
      name=environment.getRunProfile().getName();
    }
    if (name == null && environment.getContentToReuse() != null) {
      name=environment.getContentToReuse().getDisplayName();
    }
    if (name == null) {
      name="<Unknown>";
    }
    ExecutionUtil.handleExecutionError(environment.getProject(),environment.getExecutor().getToolWindowId(),name,e);
  }
}
