{
  if (range != null) {
    doRollback(tracker,range);
    return;
  }
  if (editor == null)   return;
  Document document=editor.getDocument();
  int totalLines=getLineCount(document);
  SegmentTree lines=new SegmentTree(totalLines + 1);
  List<Caret> carets=editor.getCaretModel().getAllCarets();
  for (  Caret caret : carets) {
    if (caret.hasSelection()) {
      int line1=editor.offsetToLogicalPosition(caret.getSelectionStart()).line;
      int line2=editor.offsetToLogicalPosition(caret.getSelectionEnd()).line;
      lines.mark(line1,line2 + 1);
      if (caret.getSelectionEnd() == document.getTextLength())       lines.mark(totalLines);
    }
 else {
      lines.mark(caret.getLogicalPosition().line);
      if (caret.getOffset() == document.getTextLength())       lines.mark(totalLines);
    }
  }
  doRollback(tracker,lines);
}
