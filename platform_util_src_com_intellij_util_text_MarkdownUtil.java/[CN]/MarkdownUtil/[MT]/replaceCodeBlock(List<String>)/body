{
  boolean insideQuotedBlock=false;
  boolean started=false;
  for (int i=0; i < lines.size(); i++) {
    String line=lines.get(i);
    boolean codeBlock=false;
    if (line.startsWith("```")) {
      insideQuotedBlock=!insideQuotedBlock;
      if (insideQuotedBlock) {
        if (started) {
          String lastCodeBlockLine=lines.get(lines.size() - 1);
          lastCodeBlockLine+="</code></pre>";
          lines.set(lines.size() - 1,lastCodeBlockLine);
          started=false;
        }
        line="<pre><code>";
      }
 else {
        line="</code></pre>";
      }
    }
    if (!insideQuotedBlock) {
      if (line.startsWith("    ")) {
        line=line.substring(4);
        codeBlock=true;
      }
 else       if (line.startsWith("\t")) {
        line=line.substring(1);
        codeBlock=true;
      }
      if (!started && codeBlock) {
        started=true;
        line="<pre><code>" + line;
      }
    }
    lines.set(i,line);
    if (!insideQuotedBlock) {
      if (started && !codeBlock) {
        String lastCodeBlockLine=lines.get(i - 1);
        lastCodeBlockLine+="</code></pre>";
        lines.set(i - 1,lastCodeBlockLine);
        started=false;
      }
    }
  }
  if (started) {
    String lastCodeBlockLine=lines.get(lines.size() - 1);
    lastCodeBlockLine+="</code></pre>";
    lines.set(lines.size() - 1,lastCodeBlockLine);
  }
}
