{
  Map<PsiElement,String> errors=new LinkedHashMap<PsiElement,String>();
  if (PsiType.VOID.equals(functionalInterfaceReturnType)) {
    final PsiElement body=lambdaExpression.getBody();
    if (body instanceof PsiCodeBlock) {
      for (      PsiExpression expression : getReturnExpressions(lambdaExpression)) {
        errors.put(expression,"Unexpected return value");
      }
    }
 else     if (body instanceof PsiExpression) {
      final PsiType type=((PsiExpression)body).getType();
      try {
        if (!PsiUtil.isStatement(JavaPsiFacade.getElementFactory(body.getProject()).createStatementFromText(body.getText(),body))) {
          if (PsiType.VOID.equals(type)) {
            errors.put(body,"Lambda body must be a statement expression");
          }
 else {
            errors.put(body,"Bad return type in lambda expression: " + (type == PsiType.NULL || type == null ? "<null>" : type.getPresentableText()) + " cannot be converted to void");
          }
        }
      }
 catch (      IncorrectOperationException ignore) {
      }
    }
  }
 else   if (functionalInterfaceReturnType != null) {
    final List<PsiExpression> returnExpressions=getReturnExpressions(lambdaExpression);
    for (    final PsiExpression expression : returnExpressions) {
      final PsiType expressionType=PsiResolveHelper.ourGraphGuard.doPreventingRecursion(expression,true,new Computable<PsiType>(){
        @Override public PsiType compute(){
          return expression.getType();
        }
      }
);
      if (expressionType != null && !functionalInterfaceReturnType.isAssignableFrom(expressionType)) {
        errors.put(expression,"Bad return type in lambda expression: " + expressionType.getPresentableText() + " cannot be converted to "+ functionalInterfaceReturnType.getPresentableText());
      }
    }
    final PsiReturnStatement[] returnStatements=getReturnStatements(lambdaExpression);
    if (returnStatements.length > returnExpressions.size()) {
      for (      PsiReturnStatement statement : returnStatements) {
        final PsiExpression value=statement.getReturnValue();
        if (value == null) {
          errors.put(statement,"Missing return value");
        }
      }
    }
 else     if (returnExpressions.isEmpty() && !lambdaExpression.isVoidCompatible()) {
      errors.put(lambdaExpression,"Missing return value");
    }
  }
  return errors.isEmpty() ? null : errors;
}
