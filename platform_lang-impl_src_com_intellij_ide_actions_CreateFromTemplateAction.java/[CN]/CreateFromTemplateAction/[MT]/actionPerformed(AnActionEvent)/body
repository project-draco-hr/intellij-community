{
  final DataContext dataContext=e.getDataContext();
  final IdeView view=LangDataKeys.IDE_VIEW.getData(dataContext);
  if (view == null) {
    return;
  }
  final Project project=CommonDataKeys.PROJECT.getData(dataContext);
  final PsiDirectory dir=view.getOrChooseDirectory();
  if (dir == null || project == null)   return;
  final CreateFileFromTemplateDialog.Builder builder=CreateFileFromTemplateDialog.createDialog(project);
  buildDialog(project,dir,builder);
  final Ref<T> createdElement=Ref.create(null);
  final Ref<PsiFile> createdFile=Ref.create(null);
  final Ref<String> selectedTemplateName=Ref.create(null);
  builder.show(getErrorTitle(),getDefaultTemplateName(dir),new CreateFileFromTemplateDialog.FileCreator<T>(){
    @Override public T createFile(    @NotNull String name,    @NotNull String templateName){
      if (StringUtil.countChars(name,'.') == 1) {
        FileType fileType=CreateDirectoryOrPackageHandler.findFileTypeBoundToName(name);
        if (fileType != null) {
          String message="The name you entered looks like a file name. Do you want to create a file named " + name + " instead?";
          int ec=Messages.showYesNoDialog(project,message,"File Name Detected","Yes, create " + name,"No, create " + e.getPresentation().getText(),fileType.getIcon());
          if (ec == Messages.OK) {
            PsiFile newFile=dir.createFile(name);
            createdFile.set(newFile);
            return (T)newFile;
          }
        }
      }
      selectedTemplateName.set(templateName);
      T created=CreateFromTemplateAction.this.createFile(name,templateName,dir);
      createdElement.set(created);
      return created;
    }
    @Override @NotNull public String getActionName(    @NotNull String name,    @NotNull String templateName){
      return CreateFromTemplateAction.this.getActionName(dir,name,templateName);
    }
  }
);
  if (!createdFile.isNull()) {
    view.selectElement(createdFile.get());
  }
 else   if (!createdElement.isNull()) {
    view.selectElement(createdElement.get());
    postProcess(createdElement.get(),selectedTemplateName.get(),builder.getCustomProperties());
  }
}
