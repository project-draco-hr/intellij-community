{
  UpdaterUI ui=new ConsoleUpdaterUI();
  try {
    File tempPatchFile=Utils.createTempFile();
    PatchFileCreator.create(new File(oldFolder),new File(newFolder),tempPatchFile,ignoredFiles,criticalFiles,optionalFiles,ui);
    logger.info("Packing jar file: " + patchFile);
    ui.startProcess("Packing jar file '" + patchFile + "'...");
    FileOutputStream fileOut=new FileOutputStream(patchFile);
    try {
      ZipOutputWrapper out=new ZipOutputWrapper(fileOut);
      ZipInputStream in=new ZipInputStream(new FileInputStream(resolveJarFile()));
      try {
        ZipEntry e;
        while ((e=in.getNextEntry()) != null) {
          out.zipEntry(e,in);
        }
      }
  finally {
        in.close();
      }
      ByteArrayOutputStream byteOut=new ByteArrayOutputStream();
      try {
        Properties props=new Properties();
        props.setProperty(OLD_BUILD_DESCRIPTION,oldBuildDesc);
        props.setProperty(NEW_BUILD_DESCRIPTION,newBuildDesc);
        props.store(byteOut,"");
      }
  finally {
        byteOut.close();
      }
      out.zipBytes(PATCH_PROPERTIES_ENTRY,byteOut);
      out.zipFile(PATCH_FILE_NAME,tempPatchFile);
      out.finish();
    }
  finally {
      fileOut.close();
    }
  }
  finally {
    cleanup(ui);
  }
}
