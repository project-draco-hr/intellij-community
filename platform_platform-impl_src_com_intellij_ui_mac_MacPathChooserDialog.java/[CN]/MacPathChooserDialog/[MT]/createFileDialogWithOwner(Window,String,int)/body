{
  FileDialog fileDialog;
  IdePopupManager manager=IdeEventQueue.getInstance().getPopupManager();
  if (manager.isPopupWindow(owner)) {
    manager.closeAllPopups();
    owner=owner.getOwner();
    while (owner != null && !(owner instanceof Dialog) && !(owner instanceof Frame)) {
      owner=owner.getOwner();
    }
  }
  if (owner instanceof Dialog) {
    Dialog ownerDialog=(Dialog)owner;
    if (ownerDialog.isModal()) {
      owner=ownerDialog;
    }
 else {
      while (owner instanceof Dialog && !((Dialog)owner).isModal()) {
        owner=owner.getOwner();
      }
    }
  }
  if (owner == null) {
    fileDialog=createFileDialogWithoutOwner(title,mode);
  }
 else {
    if (owner instanceof Frame) {
      if (owner instanceof IdeFrame.Child) {
        IdeFrame.Child ideFrameChild=(IdeFrame.Child)owner;
        owner=WindowManager.getInstance().getFrame(ideFrameChild.getProject());
      }
      fileDialog=new FileDialog((Frame)owner,title,mode);
    }
 else     if (owner instanceof Dialog) {
      fileDialog=new FileDialog((Dialog)owner,title,mode);
    }
 else {
      throw new RuntimeException("Owner should be a frame or a dialog");
    }
  }
  return fileDialog;
}
