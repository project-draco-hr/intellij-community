{
  Collection<DataNode<ModuleData>> result=ContainerUtilRt.newArrayList();
  for (  DataNode<ModuleData> node : modules) {
    ModuleData moduleData=node.getData();
    Module module=myProjectStructureHelper.findIdeModule(moduleData,project);
    if (module == null) {
      result.add(node);
    }
 else {
      module.setOption(ExternalSystemConstants.EXTERNAL_SYSTEM_ID_KEY,moduleData.getOwner().toString());
      final ProjectData projectData=node.getData(ProjectKeys.PROJECT);
      final String linkedExternalProjectPath=projectData == null ? moduleData.getLinkedExternalProjectPath() : projectData.getLinkedExternalProjectPath();
      module.setOption(ExternalSystemConstants.LINKED_PROJECT_PATH_KEY,linkedExternalProjectPath);
    }
  }
  return result;
}
