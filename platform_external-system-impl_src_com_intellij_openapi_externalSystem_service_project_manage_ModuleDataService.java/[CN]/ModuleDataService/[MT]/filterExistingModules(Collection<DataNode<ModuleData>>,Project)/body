{
  Collection<DataNode<ModuleData>> result=ContainerUtilRt.newArrayList();
  for (  DataNode<ModuleData> node : modules) {
    ModuleData moduleData=node.getData();
    Module module=myProjectStructureHelper.findIdeModule(moduleData,project);
    if (module == null) {
      result.add(node);
    }
 else {
      module.setOption(ExternalSystemConstants.EXTERNAL_SYSTEM_ID_KEY,moduleData.getOwner().toString());
      module.setOption(ExternalSystemConstants.LINKED_PROJECT_PATH_KEY,moduleData.getLinkedExternalProjectPath());
      final ProjectData projectData=node.getData(ProjectKeys.PROJECT);
      module.setOption(ExternalSystemConstants.ROOT_PROJECT_PATH_KEY,projectData != null ? projectData.getLinkedExternalProjectPath() : "");
    }
  }
  return result;
}
