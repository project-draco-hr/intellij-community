{
  myNewMarkup.ranges.clear();
  myOldMarkup.document=beforeDocument;
  myNewMarkup.document=currentDocument;
  List<LineFragment> lineFragments;
  try {
    lineFragments=myCompareProcessor.process(beforeDocument.getText(),currentDocument.getText());
  }
 catch (  FilesTooBigForDiffException e) {
    LOG.info(e);
    return Collections.emptyList();
  }
  final FragmentHighlighterImpl fragmentHighlighter=new FragmentHighlighterImpl(myOldMarkup,myNewMarkup);
  for (Iterator<LineFragment> iterator=lineFragments.iterator(); iterator.hasNext(); ) {
    LineFragment fragment=iterator.next();
    fragmentHighlighter.setIsLast(!iterator.hasNext());
    fragment.highlight(fragmentHighlighter);
  }
  List<TextRange> ranges=new ArrayList<>(myNewMarkup.ranges);
  for (  TextRange range : myNewMarkup.ranges) {
    if (range.getStartOffset() >= currentDocument.getTextLength()) {
      continue;
    }
    ranges.add(calculateChangeHighlightRange(currentDocument,range));
  }
  return ranges;
}
