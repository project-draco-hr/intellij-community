{
  myTree=new Tree();
  myTree.setBorder(BORDER);
  myTree.setShowsRootHandles(true);
  myTree.setRootVisible(false);
  myTree.setExpandableItemsEnabled(false);
  FileChooserDescriptor descriptor=FileChooserDescriptorFactory.createAllButJarContentsDescriptor();
  ArrayList<VirtualFile> list=new ArrayList<VirtualFile>(myRoots);
  descriptor.setRoots(list);
  final MyCheckboxTreeCellRenderer cellRenderer=new MyCheckboxTreeCellRenderer(mySelectionManager,myModulesSet,myProject,myTree,myRoots);
  FileSystemTreeImpl fileSystemTree=new FileSystemTreeImpl(myProject,descriptor,myTree,cellRenderer,null,new Convertor<TreePath,String>(){
    @Override public String convert(    TreePath o){
      final DefaultMutableTreeNode lastPathComponent=((DefaultMutableTreeNode)o.getLastPathComponent());
      final Object uo=lastPathComponent.getUserObject();
      if (uo instanceof FileNodeDescriptor) {
        final VirtualFile file=((FileNodeDescriptor)uo).getElement().getFile();
        final String module=myModulesSet.get(file);
        if (module != null)         return module;
        return file == null ? "" : file.getName();
      }
      return o.toString();
    }
  }
);
  fileSystemTree.getTreeBuilder().getUi().setNodeDescriptorComparator(new Comparator<NodeDescriptor>(){
    @Override public int compare(    NodeDescriptor o1,    NodeDescriptor o2){
      if (o1 instanceof FileNodeDescriptor && o2 instanceof FileNodeDescriptor) {
        VirtualFile f1=((FileNodeDescriptor)o1).getElement().getFile();
        VirtualFile f2=((FileNodeDescriptor)o2).getElement().getFile();
        boolean isDir1=f1.isDirectory();
        boolean isDir2=f2.isDirectory();
        if (isDir1 != isDir2)         return isDir1 ? -1 : 1;
        return f1.getPath().compareToIgnoreCase(f2.getPath());
      }
      return o1.getIndex() - o2.getIndex();
    }
  }
);
  new ClickListener(){
    @Override public boolean onClick(    @NotNull MouseEvent e,    int clickCount){
      int row=myTree.getRowForLocation(e.getX(),e.getY());
      if (row < 0)       return false;
      final Object o=myTree.getPathForRow(row).getLastPathComponent();
      if (getTreeRoot() == o || getFile(o) == null)       return false;
      Rectangle rowBounds=myTree.getRowBounds(row);
      cellRenderer.setBounds(rowBounds);
      Rectangle checkBounds=cellRenderer.myCheckbox.getBounds();
      checkBounds.setLocation(rowBounds.getLocation());
      if (checkBounds.height == 0)       checkBounds.height=rowBounds.height;
      if (checkBounds.contains(e.getPoint())) {
        mySelectionManager.toggleSelection((DefaultMutableTreeNode)o);
        myTree.revalidate();
        myTree.repaint();
      }
      return true;
    }
  }
.installOn(myTree);
  myTree.addKeyListener(new KeyAdapter(){
    public void keyPressed(    KeyEvent e){
      if (e.getKeyCode() == KeyEvent.VK_SPACE) {
        TreePath[] paths=myTree.getSelectionPaths();
        if (paths == null)         return;
        for (        TreePath path : paths) {
          if (path == null)           continue;
          final Object o=path.getLastPathComponent();
          if (getTreeRoot() == o || getFile(o) == null)           return;
          mySelectionManager.toggleSelection((DefaultMutableTreeNode)o);
        }
        myTree.revalidate();
        myTree.repaint();
        e.consume();
      }
    }
  }
);
  JBPanel panel=new JBPanel(new BorderLayout());
  panel.add(new JBScrollPane(fileSystemTree.getTree()),BorderLayout.CENTER);
  final JLabel selectedLabel=new JLabel("");
  selectedLabel.setBorder(BorderFactory.createEmptyBorder(2,0,2,0));
  panel.add(selectedLabel,BorderLayout.SOUTH);
  mySelectionManager.setSelectionChangeListener(new PlusMinus<VirtualFile>(){
    @Override public void plus(    VirtualFile virtualFile){
      mySelectedFiles.add(virtualFile);
      recalculateErrorText();
    }
    private void recalculateErrorText(){
      checkEmpty();
      if (mySelectionManager.canAddSelection()) {
        selectedLabel.setText("");
      }
 else {
        selectedLabel.setText(CAN_NOT_ADD_TEXT);
      }
      selectedLabel.revalidate();
    }
    @Override public void minus(    VirtualFile virtualFile){
      mySelectedFiles.remove(virtualFile);
      recalculateErrorText();
    }
  }
);
  panel.setPreferredSize(JBUI.size(400,300));
  return panel;
}
