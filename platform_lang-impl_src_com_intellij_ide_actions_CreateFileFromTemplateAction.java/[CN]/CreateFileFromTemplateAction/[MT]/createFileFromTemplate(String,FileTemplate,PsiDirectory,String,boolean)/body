{
  if (name != null) {
    CreateFileAction.MkDirs mkdirs=new CreateFileAction.MkDirs(name,dir);
    name=mkdirs.newName;
    dir=mkdirs.directory;
  }
  PsiElement element;
  Project project=dir.getProject();
  try {
    element=FileTemplateUtil.createFromTemplate(template,name,FileTemplateManager.getInstance(dir.getProject()).getDefaultProperties(),dir);
    final PsiFile psiFile=element.getContainingFile();
    final VirtualFile virtualFile=psiFile.getVirtualFile();
    if (virtualFile != null) {
      if (openFile) {
        FileEditorManager.getInstance(project).openFile(virtualFile,true);
      }
      if (defaultTemplateProperty != null) {
        PropertiesComponent.getInstance(project).setValue(defaultTemplateProperty,template.getName());
      }
      return psiFile;
    }
  }
 catch (  ParseException e) {
    Messages.showErrorDialog(project,"Error parsing Velocity template: " + e.getMessage(),"Create File from Template");
    return null;
  }
catch (  IncorrectOperationException e) {
    throw e;
  }
catch (  Exception e) {
    LOG.error(e);
  }
  return null;
}
