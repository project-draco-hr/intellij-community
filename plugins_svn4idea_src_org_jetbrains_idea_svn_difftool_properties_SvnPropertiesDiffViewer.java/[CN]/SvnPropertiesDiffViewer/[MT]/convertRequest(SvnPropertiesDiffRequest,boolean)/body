{
  List<PropertyRecord> records=collectRecords(request);
  StringBuilder builder1=new StringBuilder();
  StringBuilder builder2=new StringBuilder();
  List<DiffChange> diffChanges=new ArrayList<DiffChange>();
  int totalLines=0;
  for (  PropertyRecord record : records) {
    int start=totalLines;
    String before=StringUtil.notNullize(record.getBefore());
    String after=StringUtil.notNullize(record.getAfter());
    builder1.append(before);
    builder2.append(after);
    int lines1=StringUtil.countNewLines(before);
    int lines2=StringUtil.countNewLines(after);
    int appendedLines=Math.max(lines1,lines2) + 1;
    totalLines+=appendedLines;
    for (int i=lines1; i < appendedLines; i++) {
      builder1.append('\n');
    }
    for (int i=lines2; i < appendedLines; i++) {
      builder2.append('\n');
    }
    diffChanges.add(new DiffChange(record,start,totalLines,start,totalLines));
  }
  Document document1=new DocumentImpl(builder1);
  Document document2=new DocumentImpl(builder2);
  return Pair.create(new WrapperRequest(request,document1,document2,embedded),diffChanges);
}
