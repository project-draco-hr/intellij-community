{
  Reference<RefCountHolder> ref=file.getUserData(REF_COUNT_HOLDER_IN_FILE_KEY);
  RefCountHolder holder=com.intellij.reference.SoftReference.dereference(ref);
  if (holder == null) {
    holder=new RefCountHolder(file);
    Reference<RefCountHolder> newRef=new SoftReference<>(holder);
    while (true) {
      boolean replaced=((UserDataHolderEx)file).replace(REF_COUNT_HOLDER_IN_FILE_KEY,ref,newRef);
      if (replaced) {
        break;
      }
      ref=file.getUserData(REF_COUNT_HOLDER_IN_FILE_KEY);
      RefCountHolder newHolder=com.intellij.reference.SoftReference.dereference(ref);
      if (newHolder != null) {
        holder=newHolder;
        break;
      }
    }
  }
  return holder;
}
