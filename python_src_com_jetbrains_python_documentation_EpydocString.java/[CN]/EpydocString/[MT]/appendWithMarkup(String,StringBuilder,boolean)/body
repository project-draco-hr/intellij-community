{
  int pos=0;
  while (true) {
    int bracePos=s.indexOf('{',pos);
    if (bracePos < 1)     break;
    char prevChar=s.charAt(bracePos - 1);
    if (prevChar >= 'A' && prevChar <= 'Z') {
      resultBuilder.append(s.substring(pos,bracePos - 1));
      int rbracePos=findMatchingEndBrace(s,bracePos);
      if (rbracePos < 0) {
        pos=bracePos + 1;
        break;
      }
      final String inlineMarkupContent=s.substring(bracePos + 1,rbracePos);
      if (toHTML) {
        appendInlineMarkup(resultBuilder,prevChar,inlineMarkupContent);
      }
 else {
        resultBuilder.append(inlineMarkupContent);
      }
      pos=rbracePos + 1;
    }
 else {
      resultBuilder.append(StringUtil.escapeXml(joinLines(s.substring(pos,bracePos + 1),true)));
      pos=bracePos + 1;
    }
  }
  resultBuilder.append(StringUtil.escapeXml(joinLines(s.substring(pos),true)));
}
