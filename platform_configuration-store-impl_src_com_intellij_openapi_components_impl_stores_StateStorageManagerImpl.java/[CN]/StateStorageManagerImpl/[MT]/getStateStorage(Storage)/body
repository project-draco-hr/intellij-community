{
  String key=storageSpec.storageClass().equals(StateStorage.class) ? storageSpec.file() : storageSpec.storageClass().getName();
  myStorageLock.lock();
  try {
    StateStorage stateStorage=myStorages.get(key);
    if (stateStorage == null) {
      stateStorage=createStateStorage(storageSpec.storageClass(),storageSpec.file(),storageSpec.roamingType(),storageSpec.stateSplitter());
      myStorages.put(key,stateStorage);
    }
    return stateStorage;
  }
  finally {
    myStorageLock.unlock();
  }
}
