{
  Map<VirtualFile,List<? extends TimedVcsCommit>> logsToBuild=ContainerUtil.newHashMap();
  Map<VirtualFile,Collection<VcsRef>> refsByRoot=ContainerUtil.newHashMap();
  for (  Map.Entry<VirtualFile,RecentCommitsInfo> entry : collectInfoFromVcs(true,commitCount)) {
    VirtualFile root=entry.getKey();
    RecentCommitsInfo info=entry.getValue();
    List<TimedVcsCommit> firstBlockCommits=new VcsLogSorter<TimedVcsCommit>().sortByDateTopoOrder(info.firstBlockCommits);
    logsToBuild.put(root,firstBlockCommits);
    refsByRoot.put(root,info.newRefs);
  }
  List<? extends TimedVcsCommit> compoundLog=myMultiRepoJoiner.join(logsToBuild.values());
  DataPack dataPack=DataPack.build(convertToGraphCommits(compoundLog),collectAllRefs(refsByRoot),indicator,myIndexGetter,myHashGetter,myLogProviders);
  if (myLogData != null && myLogData.isFullLogReady()) {
    myLogData=new LogData(myLogData.getLogs(),myLogData.getRefs(),compoundLog,dataPack,true);
  }
 else {
    myLogData=new LogData(logsToBuild,refsByRoot,compoundLog,dataPack,false);
  }
  myContainingBranchesGetter.clearCache();
  handleOnSuccessInEdt(onSuccess,dataPack);
}
