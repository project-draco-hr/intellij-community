{
  final FileBasedIndexImpl index=(FileBasedIndexImpl)FileBasedIndex.getInstance();
  final Collection<VirtualFile> files=index.getFilesToUpdate(project);
  if (files.isEmpty())   return null;
  if (files.size() + index.getNumberOfPendingInvalidations() < 20 && !DumbService.isDumb(project)) {
    try {
      HeavyProcessLatch.INSTANCE.processStarted();
      reindexRefreshedFiles(new EmptyProgressIndicator(),files,project,index);
    }
  finally {
      HeavyProcessLatch.INSTANCE.processFinished();
    }
    return null;
  }
  return new DumbModeTask(){
    @Override public void performInDumbMode(    @NotNull ProgressIndicator indicator){
      indicator.setIndeterminate(false);
      indicator.setText(IdeBundle.message("progress.indexing.updating"));
      reindexRefreshedFiles(indicator,files,project,index);
    }
  }
;
}
