{
  if (fontMetrics.stringWidth(refName) > availableWidth && refName.length() > MAX_LENGTH) {
    int separatorIndex=refName.indexOf(SEPARATOR);
    if (separatorIndex > TWO_DOTS.length()) {
      refName=TWO_DOTS + refName.substring(separatorIndex);
    }
    if (fontMetrics.stringWidth(refName) <= availableWidth)     return refName;
    if (availableWidth > 0) {
      for (int i=refName.length(); i > MAX_LENGTH; i--) {
        String result=StringUtil.shortenTextWithEllipsis(refName,i,0,THREE_DOTS);
        if (fontMetrics.stringWidth(result) <= availableWidth) {
          return result;
        }
      }
    }
    return StringUtil.shortenTextWithEllipsis(refName,MAX_LENGTH,0,THREE_DOTS);
  }
  return refName;
}
