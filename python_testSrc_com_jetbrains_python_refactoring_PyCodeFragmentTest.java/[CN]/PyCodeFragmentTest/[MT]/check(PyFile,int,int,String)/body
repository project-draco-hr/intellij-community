{
  final PsiElement startElement=myFile.findElementAt(beginMarker);
  final PsiElement endElement=myFile.findElementAt(endMarker - BEGIN_MARKER.length());
  PsiElement context=PsiTreeUtil.findCommonParent(startElement,endElement);
  if (!(context instanceof ScopeOwner)) {
    context=PsiTreeUtil.getParentOfType(context,ScopeOwner.class);
  }
  final StringBuffer buffer=new StringBuffer();
  final CodeFragment fragment=PyCodeFragmentUtil.createCodeFragment((ScopeOwner)context,startElement,endElement);
  if (fragment.isReturnInstructonInside()) {
    buffer.append("Return instruction inside found").append("\n");
  }
  buffer.append("In:\n");
  for (  String inputVariable : new TreeSet<String>(fragment.getInputVariables())) {
    buffer.append(inputVariable).append('\n');
  }
  buffer.append("Out:\n");
  for (  String outputVariable : new TreeSet<String>(fragment.getOutputVariables())) {
    buffer.append(outputVariable).append('\n');
  }
  assertEquals(result.trim(),buffer.toString().trim());
}
