{
  PsiElement element=findElementAt(offset);
  if (element == null || element instanceof OuterLanguageElement)   return null;
  offset=getTextRange().getStartOffset() + offset - element.getTextRange().getStartOffset();
  List<PsiReference> referencesList=new ArrayList<PsiReference>();
  final PsiFile file=element.getContainingFile();
  final PyResolveContext resolveContext=file != null ? PyResolveContext.defaultContext().withTypeEvalContext(TypeEvalContext.codeAnalysis(file)) : PyResolveContext.defaultContext();
  while (element != null) {
    addReferences(offset,element,referencesList,resolveContext);
    offset=element.getStartOffsetInParent() + offset;
    if (element instanceof PsiFile)     break;
    element=element.getParent();
  }
  if (referencesList.isEmpty())   return null;
  if (referencesList.size() == 1)   return referencesList.get(0);
  return new PsiMultiReference(referencesList.toArray(new PsiReference[referencesList.size()]),referencesList.get(referencesList.size() - 1).getElement());
}
