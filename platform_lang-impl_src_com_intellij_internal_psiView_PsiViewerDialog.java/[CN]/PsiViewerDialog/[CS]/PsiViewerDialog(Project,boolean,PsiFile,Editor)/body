{
  super(project,true);
  myCurrentFile=currentFile;
  myProject=project;
  setModal(modal);
  setOKButtonText("&Build PSI Tree");
  setCancelButtonText("&Close");
  Disposer.register(myProject,getDisposable());
  EditorEx editor=null;
  final Ref<Integer> initOffset=Ref.create();
  if (myCurrentFile == null) {
    setTitle("PSI Viewer");
  }
 else {
    setTitle("PSI Context Viewer: " + myCurrentFile.getName());
    myFileType=myCurrentFile.getLanguage().getDisplayName();
    if (currentEditor != null) {
      myInitText=currentEditor.getSelectionModel().getSelectedText();
      if (myInitText == null) {
        initOffset.set(currentEditor.getCaretModel().getOffset());
      }
    }
    if (myInitText == null) {
      myInitText=currentFile.getText();
      editor=(EditorEx)EditorFactory.getInstance().createEditor(currentFile.getViewProvider().getDocument(),myProject);
    }
  }
  if (editor == null) {
    final Document document=EditorFactory.getInstance().createDocument("");
    editor=(EditorEx)EditorFactory.getInstance().createEditor(document,myProject);
  }
  editor.getSettings().setLineMarkerAreaShown(false);
  myEditor=editor;
  init();
  if (myCurrentFile != null) {
    doOKAction();
    if (!initOffset.isNull()) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          myEditor.getCaretModel().moveToOffset(initOffset.get());
          myEditor.getScrollingModel().scrollToCaret(ScrollType.MAKE_VISIBLE);
        }
      }
);
    }
  }
}
