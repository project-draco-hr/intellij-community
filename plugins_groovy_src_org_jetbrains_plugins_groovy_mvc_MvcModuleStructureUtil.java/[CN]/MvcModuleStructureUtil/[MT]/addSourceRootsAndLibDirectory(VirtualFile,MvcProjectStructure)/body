{
  ModuleRootManager moduleRootManager=ModuleRootManager.getInstance(structure.myModule);
  Map<VirtualFile,JpsModuleSourceRootType> sourceRoots=new HashMap<VirtualFile,JpsModuleSourceRootType>();
  for (  ContentEntry entry : moduleRootManager.getContentEntries()) {
    for (    SourceFolder folder : entry.getSourceFolders()) {
      sourceRoots.put(folder.getFile(),folder.getRootType());
    }
  }
  root.refresh(false,true);
  final List<Consumer<ContentEntry>> actions=ContainerUtil.newArrayList();
  for (  Map.Entry<JpsModuleSourceRootType<?>,Collection<String>> entry : structure.getSourceFolders().entrySet()) {
    JpsModuleSourceRootType rootType=entry.getKey();
    for (    String src : entry.getValue()) {
      addSourceFolder(root,src,rootType,actions,sourceRoots);
    }
  }
  for (  final String src : structure.getInvalidSourceFolders()) {
    removeSrcFolderFromRoots(root.findFileByRelativePath(src),actions,sourceRoots);
  }
  for (  final VirtualFile excluded : structure.getExcludedFolders(root)) {
    if (moduleRootManager.getFileIndex().isInContent(excluded)) {
      actions.add(new Consumer<ContentEntry>(){
        public void consume(        ContentEntry contentEntry){
          contentEntry.addExcludeFolder(excluded);
        }
      }
);
    }
  }
  final Consumer<ModifiableRootModel> modifyLib=addJarDirectory(root,structure.myModule,structure.getUserLibraryName());
  if (actions.isEmpty() && modifyLib == null && findContentEntry(moduleRootManager,root) != null) {
    return null;
  }
  return new Consumer<ModifiableRootModel>(){
    public void consume(    ModifiableRootModel model){
      ContentEntry contentEntry=findContentEntry(model,root);
      if (contentEntry == null) {
        contentEntry=model.addContentEntry(root);
      }
      for (      final Consumer<ContentEntry> action : actions) {
        action.consume(contentEntry);
      }
      if (modifyLib != null) {
        modifyLib.consume(model);
      }
    }
  }
;
}
