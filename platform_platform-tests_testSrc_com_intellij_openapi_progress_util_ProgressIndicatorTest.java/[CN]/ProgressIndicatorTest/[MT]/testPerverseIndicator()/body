{
  checkCanceledCalled=false;
  ProgressIndicator indicator=new ProgressIndicatorStub(){
    @Override public void checkCanceled() throws ProcessCanceledException {
      checkCanceledCalled=true;
      if (myFlag)       throw new ProcessCanceledException();
    }
  }
;
  myFlag=false;
  Alarm alarm=new Alarm(myTestRootDisposable);
  alarm.addRequest(new Runnable(){
    @Override public void run(){
      myFlag=true;
    }
  }
,100);
  final long start=System.currentTimeMillis();
  ProgressManager.getInstance().executeProcessUnderProgress(new Runnable(){
    @Override public void run(){
      while (System.currentTimeMillis() - start < 10000) {
        ProgressManager.checkCanceled();
      }
    }
  }
,indicator);
  assertTrue(checkCanceledCalled);
}
