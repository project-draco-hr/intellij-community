{
  LineFragments lineFragments=doCompareWithCache(request,text1,text2,stamp1,stamp2,config,indicator);
  if (!config.squashFragments && !config.trimFragments)   return lineFragments;
  if (lineFragments.isFine()) {
    List<? extends FineLineFragment> fragments=lineFragments.getFineFragments();
    if (config.squashFragments) {
      indicator.checkCanceled();
      fragments=ComparisonUtil.squashFine(fragments);
    }
    if (config.trimFragments) {
      indicator.checkCanceled();
      fragments=ComparisonUtil.trimFine(fragments,config.policy);
    }
    return LineFragments.createFine(fragments);
  }
 else {
    List<? extends LineFragment> fragments=lineFragments.getFragments();
    if (config.squashFragments) {
      indicator.checkCanceled();
      fragments=ComparisonUtil.squash(fragments);
    }
    if (config.trimFragments) {
      indicator.checkCanceled();
      fragments=ComparisonUtil.trim(fragments,config.policy);
    }
    return LineFragments.createFine(fragments);
  }
}
