{
  indicator.checkCanceled();
  LineFragments lineFragments=getFromCache(request,config,stamp1,stamp2);
  LineFragments newLineFragments;
  if (lineFragments != null) {
    if (lineFragments.getFragments().isEmpty())     return lineFragments;
    if (!config.fineFragments)     return lineFragments;
    if (lineFragments.isFine())     return lineFragments;
    List<FineLineFragment> result=ComparisonUtil.compareFineLines(text1,text2,lineFragments.getFragments(),config.policy,indicator);
    newLineFragments=LineFragments.createFine(result);
  }
 else {
    if (config.fineFragments) {
      List<FineLineFragment> result=ComparisonUtil.compareFineLines(text1,text2,config.policy,indicator);
      newLineFragments=LineFragments.createFine(result);
    }
 else {
      List<LineFragment> result=ComparisonUtil.compareLines(text1,text2,config.policy,indicator);
      newLineFragments=LineFragments.create(result);
    }
  }
  indicator.checkCanceled();
  putToCache(request,config,stamp1,stamp2,newLineFragments);
  return newLineFragments;
}
