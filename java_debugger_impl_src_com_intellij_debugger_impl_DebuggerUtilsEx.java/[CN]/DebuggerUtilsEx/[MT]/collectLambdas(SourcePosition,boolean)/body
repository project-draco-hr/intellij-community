{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  PsiFile file=position.getFile();
  int line=position.getLine();
  Document document=PsiDocumentManager.getInstance(file.getProject()).getDocument(file);
  if (document == null || line >= document.getLineCount()) {
    return Collections.emptyList();
  }
  PsiElement element=position.getElementAt();
  final TextRange lineRange=DocumentUtil.getLineTextRange(document,line);
  do {
    PsiElement parent=element.getParent();
    if (parent == null || (parent.getTextOffset() < lineRange.getStartOffset())) {
      break;
    }
    element=parent;
  }
 while (true);
  final List<PsiLambdaExpression> lambdas=new ArrayList<PsiLambdaExpression>(3);
  final PsiElementVisitor lambdaCollector=new JavaRecursiveElementVisitor(){
    @Override public void visitLambdaExpression(    PsiLambdaExpression expression){
      super.visitLambdaExpression(expression);
      PsiElement body=expression.getBody();
      if (!onlyOnTheLine || (body != null && lineRange.intersects(body.getTextRange()))) {
        lambdas.add(expression);
      }
    }
  }
;
  element.accept(lambdaCollector);
  NavigatablePsiElement method=PsiTreeUtil.getParentOfType(element,PsiMethod.class,PsiLambdaExpression.class);
  if (method instanceof PsiLambdaExpression) {
    lambdas.add((PsiLambdaExpression)method);
  }
  for (PsiElement sibling=getNextElement(element); sibling != null; sibling=getNextElement(sibling)) {
    if (!lineRange.intersects(sibling.getTextRange())) {
      break;
    }
    sibling.accept(lambdaCollector);
  }
  return lambdas;
}
