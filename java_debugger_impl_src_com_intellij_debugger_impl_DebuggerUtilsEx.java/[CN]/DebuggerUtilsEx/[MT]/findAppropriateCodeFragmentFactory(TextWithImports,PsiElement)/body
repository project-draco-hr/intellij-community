{
  CodeFragmentFactory factory=ApplicationManager.getApplication().runReadAction(new Computable<CodeFragmentFactory>(){
    @Override public CodeFragmentFactory compute(){
      for (      CodeFragmentFactory factory : getCodeFragmentFactories(context)) {
        if (factory.getFileType().equals(text.getFileType())) {
          return factory;
        }
      }
      return DefaultCodeFragmentFactory.getInstance();
    }
  }
);
  return new CodeFragmentFactoryContextWrapper(factory);
}
