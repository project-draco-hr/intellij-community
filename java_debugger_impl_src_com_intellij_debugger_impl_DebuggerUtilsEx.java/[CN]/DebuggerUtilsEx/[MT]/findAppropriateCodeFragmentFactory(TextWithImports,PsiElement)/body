{
  CodeFragmentFactory factory=ApplicationManager.getApplication().runReadAction(new Computable<CodeFragmentFactory>(){
    @Override public CodeFragmentFactory compute(){
      final FileType fileType=text.getFileType();
      final List<CodeFragmentFactory> factories=getCodeFragmentFactories(context);
      if (fileType == null) {
        return factories.get(0);
      }
      for (      CodeFragmentFactory factory : factories) {
        if (factory.getFileType().equals(fileType)) {
          return factory;
        }
      }
      return DefaultCodeFragmentFactory.getInstance();
    }
  }
);
  return new CodeFragmentFactoryContextWrapper(factory);
}
