{
  GeneralCommandLine commandLine=new GeneralCommandLine();
  commandLine.setExePath(exePath);
  commandLine.setPassParentEnvironment(true);
  if (scriptFile != null) {
    commandLine.addParameter(scriptFile.getPresentableUrl());
  }
  commandLine.addParameters(parameters);
  if (workingDirectory != null) {
    commandLine.setWorkDirectory(workingDirectory);
  }
  LOG.debug("Command line: ",commandLine.getCommandLineString());
  LOG.debug("Command line env: ",commandLine.getEnvironment());
  if (charset == null) {
    charset=EncodingManager.getInstance().getDefaultCharset();
  }
  final OSProcessHandler processHandler=new ColoredProcessHandler(commandLine.createProcess(),commandLine.getCommandLineString(),charset);
  if (LOG.isDebugEnabled()) {
    processHandler.addProcessListener(new ProcessAdapter(){
      @Override public void onTextAvailable(      ProcessEvent event,      Key outputType){
        LOG.debug(outputType + ": " + event.getText());
      }
    }
);
  }
  return processHandler;
}
