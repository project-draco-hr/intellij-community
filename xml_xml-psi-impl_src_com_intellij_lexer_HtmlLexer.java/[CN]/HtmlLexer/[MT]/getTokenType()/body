{
  if (myTokenType != null)   return myTokenType;
  IElementType tokenType=super.getTokenType();
  myTokenStart=super.getTokenStart();
  myTokenEnd=super.getTokenEnd();
  if (hasSeenStyle()) {
    if (hasSeenTag() && isStartOfEmbeddmentTagContent(tokenType)) {
      Language stylesheetLanguage=getStyleLanguage();
      if (stylesheetLanguage == null || LanguageUtil.isInjectableLanguage(stylesheetLanguage)) {
        myTokenEnd=skipToTheEndOfTheEmbeddment();
        IElementType currentStylesheetElementType=getCurrentStylesheetElementType();
        tokenType=currentStylesheetElementType == null ? XmlTokenType.XML_DATA_CHARACTERS : currentStylesheetElementType;
      }
    }
 else     if (ourInlineStyleElementType != null && isStartOfEmbeddmentAttributeValue(tokenType) && hasSeenAttribute()) {
      tokenType=ourInlineStyleElementType;
    }
  }
 else   if (hasSeenScript()) {
    if (hasSeenTag() && isStartOfEmbeddmentTagContent(tokenType)) {
      Language scriptLanguage=getScriptLanguage();
      if (scriptLanguage == null || LanguageUtil.isInjectableLanguage(scriptLanguage)) {
        myTokenEnd=skipToTheEndOfTheEmbeddment();
        IElementType currentScriptElementType=getCurrentScriptElementType();
        tokenType=currentScriptElementType == null ? XmlTokenType.XML_DATA_CHARACTERS : currentScriptElementType;
      }
    }
 else     if (hasSeenAttribute() && isStartOfEmbeddmentAttributeValue(tokenType) && ourInlineScriptElementType != null) {
      myTokenEnd=skipToTheEndOfTheEmbeddment();
      tokenType=ourInlineScriptElementType;
    }
  }
  return myTokenType=tokenType;
}
