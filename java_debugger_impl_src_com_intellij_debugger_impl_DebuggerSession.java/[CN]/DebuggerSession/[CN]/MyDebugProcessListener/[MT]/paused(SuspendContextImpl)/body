{
  if (LOG.isDebugEnabled()) {
    LOG.debug("paused");
  }
  if (!shouldSetAsActiveContext(suspendContext)) {
    DebuggerInvocationUtil.invokeLater(getProject(),new Runnable(){
      @Override public void run(){
        getContextManager().fireStateChanged(getContextManager().getContext(),EVENT_THREADS_REFRESH);
      }
    }
);
    final ThreadReferenceProxyImpl thread=suspendContext.getThread();
    if (thread != null) {
      List<Pair<Breakpoint,Event>> descriptors=DebuggerUtilsEx.getEventDescriptors(suspendContext);
      if (!descriptors.isEmpty()) {
        XDebugSessionImpl.NOTIFICATION_GROUP.createNotification(DebuggerBundle.message("status.breakpoint.reached.in.thread",thread.name()),DebuggerBundle.message("status.breakpoint.reached.in.thread.switch"),NotificationType.INFORMATION,new NotificationListener(){
          @Override public void hyperlinkUpdate(          @NotNull Notification notification,          @NotNull HyperlinkEvent event){
            if (event.getEventType() == HyperlinkEvent.EventType.ACTIVATED) {
              notification.expire();
              getProcess().getManagerThread().schedule(new SuspendContextCommandImpl(suspendContext){
                @Override public void contextAction() throws Exception {
                  final DebuggerContextImpl debuggerContext=DebuggerContextImpl.createDebuggerContext(DebuggerSession.this,suspendContext,thread,null);
                  DebuggerInvocationUtil.invokeLater(getProject(),new Runnable(){
                    @Override public void run(){
                      getContextManager().setState(debuggerContext,STATE_PAUSED,EVENT_PAUSE,null);
                    }
                  }
);
                }
              }
);
            }
          }
        }
).notify(getProject());
      }
    }
    return;
  }
  ThreadReferenceProxyImpl currentThread=suspendContext.getThread();
  final StackFrameContext positionContext;
  if (currentThread == null) {
    LOG.assertTrue(suspendContext.getSuspendPolicy() == EventRequest.SUSPEND_ALL);
    SuspendContextImpl oldContext=getProcess().getSuspendManager().getPausedContext();
    if (oldContext != null) {
      currentThread=oldContext.getThread();
    }
    if (currentThread == null) {
      final Collection<ThreadReferenceProxyImpl> allThreads=getProcess().getVirtualMachineProxy().allThreads();
      for (      final ThreadReferenceProxyImpl thread : allThreads) {
        if (ThreadState.isEDT(thread.name())) {
          currentThread=thread;
          break;
        }
      }
      if (currentThread == null) {
        for (        final ThreadReferenceProxyImpl thread : allThreads) {
          currentThread=thread;
          if (currentThread.status() == ThreadReference.THREAD_STATUS_RUNNING) {
            break;
          }
        }
      }
    }
    StackFrameProxyImpl proxy=null;
    if (currentThread != null) {
      try {
        while (!currentThread.isSuspended()) {
          TimeoutUtil.sleep(10);
        }
        proxy=(currentThread.frameCount() > 0) ? currentThread.frame(0) : null;
      }
 catch (      ObjectCollectedException ignored) {
        proxy=null;
      }
catch (      EvaluateException e) {
        proxy=null;
        LOG.error(e);
      }
    }
    positionContext=new SimpleStackFrameContext(proxy,myDebugProcess);
  }
 else {
    positionContext=suspendContext;
  }
  if (currentThread != null) {
    try {
      final int frameCount=currentThread.frameCount();
      if (frameCount == 0 || (frameCount <= myIgnoreFiltersFrameCountThreshold)) {
        resetIgnoreStepFiltersFlag();
      }
    }
 catch (    EvaluateException e) {
      LOG.info(e);
      resetIgnoreStepFiltersFlag();
    }
  }
  SourcePosition position=PsiDocumentManager.getInstance(getProject()).commitAndRunReadAction(new Computable<SourcePosition>(){
    @Override public @Nullable SourcePosition compute(){
      return ContextUtil.getSourcePosition(positionContext);
    }
  }
);
  if (position != null) {
    final List<Pair<Breakpoint,Event>> eventDescriptors=DebuggerUtilsEx.getEventDescriptors(suspendContext);
    final RequestManagerImpl requestsManager=suspendContext.getDebugProcess().getRequestsManager();
    final PsiFile foundFile=position.getFile();
    final boolean sourceMissing=foundFile instanceof PsiCompiledElement;
    for (    Pair<Breakpoint,Event> eventDescriptor : eventDescriptors) {
      Breakpoint breakpoint=eventDescriptor.getFirst();
      if (breakpoint instanceof LineBreakpoint) {
        final SourcePosition breakpointPosition=((BreakpointWithHighlighter)breakpoint).getSourcePosition();
        if (breakpointPosition == null || (!sourceMissing && breakpointPosition.getLine() != position.getLine())) {
          requestsManager.deleteRequest(breakpoint);
          requestsManager.setInvalid(breakpoint,DebuggerBundle.message("error.invalid.breakpoint.source.changed"));
          breakpoint.updateUI();
        }
 else         if (sourceMissing) {
          position=breakpointPosition;
          final StackFrameProxy frameProxy=positionContext.getFrameProxy();
          String className;
          try {
            className=frameProxy != null ? frameProxy.location().declaringType().name() : "";
          }
 catch (          EvaluateException ignored) {
            className="";
          }
          requestsManager.setInvalid(breakpoint,DebuggerBundle.message("error.invalid.breakpoint.source.not.found",className));
          breakpoint.updateUI();
        }
      }
    }
  }
  final DebuggerContextImpl debuggerContext=DebuggerContextImpl.createDebuggerContext(DebuggerSession.this,suspendContext,currentThread,null);
  debuggerContext.setPositionCache(position);
  DebuggerInvocationUtil.invokeLater(getProject(),new Runnable(){
    @Override public void run(){
      getContextManager().setState(debuggerContext,STATE_PAUSED,EVENT_PAUSE,null);
    }
  }
);
}
