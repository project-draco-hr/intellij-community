{
  Project project=file.getProject();
  final PsiDocumentManager manager=PsiDocumentManager.getInstance(project);
  Document document=manager.getDocument(file);
  if (document == null) {
    PsiUtilCore.ensureValid(file);
    LOG.error("No document for " + file);
    return;
  }
  manager.commitDocument(document);
  final PsiReference ref=file.findReferenceAt(offset);
  if (ref != null) {
    PsiElement element=ref.getElement();
    if (element != null) {
      JavaCodeStyleManager.getInstance(project).shortenClassReferences(element);
      PsiDocumentManager.getInstance(project).doPostponedOperationsAndUnblockDocument(document);
    }
  }
}
