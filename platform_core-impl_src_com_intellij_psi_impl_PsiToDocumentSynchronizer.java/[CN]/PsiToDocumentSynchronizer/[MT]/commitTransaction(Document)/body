{
  ApplicationManager.getApplication().assertIsDispatchThread();
  final DocumentChangeTransaction documentChangeTransaction=removeTransaction(document);
  if (documentChangeTransaction == null)   return false;
  final PsiFile changeScope=documentChangeTransaction.myChangeScope;
  try {
    mySyncDocument=document;
    final PsiTreeChangeEventImpl fakeEvent=new PsiTreeChangeEventImpl(changeScope.getManager());
    fakeEvent.setParent(changeScope);
    fakeEvent.setFile(changeScope);
    checkPsiModificationAllowed(fakeEvent);
    doSync(fakeEvent,true,new DocSyncAction(){
      @Override public void syncDocument(      @NotNull Document document,      @NotNull PsiTreeChangeEventImpl event){
        doCommitTransaction(document,documentChangeTransaction);
      }
    }
);
    myBus.syncPublisher(PsiDocumentTransactionListener.TOPIC).transactionCompleted(document,changeScope);
  }
 catch (  Throwable e) {
    myPsiDocumentManager.forceReload(changeScope.getViewProvider().getVirtualFile(),changeScope.getViewProvider());
    ExceptionUtil.rethrowAllAsUnchecked(e);
  }
 finally {
    mySyncDocument=null;
  }
  return true;
}
