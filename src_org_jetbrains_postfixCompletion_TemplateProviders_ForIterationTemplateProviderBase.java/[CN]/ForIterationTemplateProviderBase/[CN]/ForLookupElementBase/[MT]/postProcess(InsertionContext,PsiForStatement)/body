{
  final SmartPointerManager pointerManager=SmartPointerManager.getInstance(context.getProject());
  final SmartPsiElementPointer<PsiForStatement> statementPointer=pointerManager.createSmartPsiElementPointer(forStatement);
  final Runnable runnable=new Runnable(){
    @Override public void run(){
      PsiForStatement statement=statementPointer.getElement();
      if (statement == null)       return;
      TemplateBuilderImpl builder=new TemplateBuilderImpl(statement);
      buildTemplate(builder,statement);
      Template template=builder.buildInlineTemplate();
      Editor editor=context.getEditor();
      CaretModel caretModel=editor.getCaretModel();
      caretModel.moveToOffset(statement.getTextRange().getStartOffset());
      TemplateManager manager=TemplateManager.getInstance(context.getProject());
      manager.startTemplate(editor,template);
    }
  }
;
  context.setLaterRunnable(new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          CommandProcessor.getInstance().runUndoTransparentAction(runnable);
        }
      }
);
    }
  }
);
}
