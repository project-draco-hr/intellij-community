{
  if (mySelectedRange != null) {
    Editor editor=InjectedLanguageUtil.getTopLevelEditor(myEditor);
    TextRange selectedRange;
    if (myEditor instanceof EditorWindow) {
      PsiFile injected=((EditorWindow)myEditor).getInjectedFile();
      selectedRange=InjectedLanguageManager.getInstance(editor.getProject()).injectedToHost(injected,mySelectedRange);
    }
 else {
      selectedRange=mySelectedRange;
    }
    TemplateState state=TemplateManagerImpl.getTemplateState(editor);
    if (state != null) {
      for (int i=0; i < state.getSegmentsCount(); i++) {
        final TextRange segmentRange=state.getSegmentRange(i);
        TextRange intersection=segmentRange.intersection(selectedRange);
        if (intersection != null) {
          editor.getSelectionModel().setSelection(intersection.getStartOffset(),intersection.getEndOffset());
          return;
        }
      }
    }
    myEditor.getSelectionModel().setSelection(mySelectedRange.getStartOffset(),mySelectedRange.getEndOffset());
  }
 else   if (!shouldSelectAll()) {
    myEditor.getSelectionModel().removeSelection();
  }
}
