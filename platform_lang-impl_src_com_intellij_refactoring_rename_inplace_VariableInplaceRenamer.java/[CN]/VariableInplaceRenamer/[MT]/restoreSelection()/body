{
  if (mySelectedRange != null) {
    TemplateState state=TemplateManagerImpl.getTemplateState(InjectedLanguageUtil.getTopLevelEditor(myEditor));
    if (state != null) {
      for (int i=0; i < state.getSegmentsCount(); i++) {
        final TextRange segmentRange=state.getSegmentRange(i);
        TextRange intersection=segmentRange.intersection(mySelectedRange);
        if (intersection != null) {
          myEditor.getSelectionModel().setSelection(intersection.getStartOffset(),intersection.getEndOffset());
          return;
        }
      }
    }
    myEditor.getSelectionModel().setSelection(mySelectedRange.getStartOffset(),mySelectedRange.getEndOffset());
  }
 else   if (!shouldSelectAll()) {
    myEditor.getSelectionModel().removeSelection();
  }
}
