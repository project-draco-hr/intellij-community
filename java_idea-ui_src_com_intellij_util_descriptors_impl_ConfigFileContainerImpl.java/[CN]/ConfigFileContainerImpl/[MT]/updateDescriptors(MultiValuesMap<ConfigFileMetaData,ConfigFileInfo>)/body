{
  Set<ConfigFile> toDelete=myConfigFiles.isEmpty() ? Collections.<ConfigFile>emptySet() : new HashSet<>(myConfigFiles.values());
  Set<ConfigFile> added=null;
  for (  Map.Entry<ConfigFileMetaData,Collection<ConfigFileInfo>> entry : descriptorsMap.entrySet()) {
    ConfigFileMetaData metaData=entry.getKey();
    Set<ConfigFileInfo> newDescriptors=new HashSet<>(entry.getValue());
    final Collection<ConfigFile> oldDescriptors=myConfigFiles.get(metaData);
    if (oldDescriptors != null) {
      for (      ConfigFile descriptor : oldDescriptors) {
        if (newDescriptors.remove(descriptor.getInfo())) {
          toDelete.remove(descriptor);
        }
      }
    }
    for (    ConfigFileInfo configuration : newDescriptors) {
      final ConfigFileImpl configFile=new ConfigFileImpl(this,configuration);
      Disposer.register(this,configFile);
      myConfigFiles.put(metaData,configFile);
      if (added == null) {
        added=new THashSet<>();
      }
      added.add(configFile);
    }
  }
  for (  ConfigFile descriptor : toDelete) {
    myConfigFiles.remove(descriptor.getMetaData(),descriptor);
    Disposer.dispose(descriptor);
  }
  myCachedConfigFiles=null;
  if (added != null) {
    for (    ConfigFile configFile : added) {
      incModificationCount();
      myDispatcher.getMulticaster().configFileAdded(configFile);
    }
  }
  for (  ConfigFile configFile : toDelete) {
    incModificationCount();
    myDispatcher.getMulticaster().configFileRemoved(configFile);
  }
}
