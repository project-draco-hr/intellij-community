{
  PsiSubstitutor substitutor=PsiResolveHelper.SERVICE.getInstance(method.getProject()).inferTypeArguments(typeParameters,types1,types2,languageLevel);
  for (  PsiTypeParameter typeParameter : PsiUtil.typeParametersIterable(method)) {
    ProgressManager.checkCanceled();
    LOG.assertTrue(typeParameter != null);
    if (!substitutor.getSubstitutionMap().containsKey(typeParameter)) {
      PsiType type=siteSubstitutor.substitute(typeParameter);
      if (type instanceof PsiClassType && ((PsiClassType)type).resolve() instanceof PsiTypeParameter) {
        type=TypeConversionUtil.erasure(type,substitutor);
      }
      substitutor=substitutor.put(typeParameter,type);
    }
  }
  return substitutor;
}
