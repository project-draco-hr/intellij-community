{
  final GlobalSearchScope searchScope=GlobalSearchScope.projectScope(rootPackage.getProject());
  final PsiPackage[] subPackages=rootPackage.getSubPackages();
  for (  PsiPackage aPackage : subPackages) {
    final PsiDirectory[] directories=aPackage.getDirectories(searchScope);
    if (directories.length == 0)     continue;
    if (contains(aPackage.getQualifiedName(),filteredPackages)) {
      final CoverageListNode node=new CoverageListNode(aPackage,data,packages,stateBean,filteredPackages,filteredClasses);
      children.add(node);
    }
 else     if (!flattenPackages) {
      collectSubPackages(children,aPackage,data,packages,stateBean,filteredPackages,filteredClasses,flattenPackages);
    }
    if (flattenPackages) {
      collectSubPackages(children,aPackage,data,packages,stateBean,filteredPackages,filteredClasses,flattenPackages);
    }
  }
}
