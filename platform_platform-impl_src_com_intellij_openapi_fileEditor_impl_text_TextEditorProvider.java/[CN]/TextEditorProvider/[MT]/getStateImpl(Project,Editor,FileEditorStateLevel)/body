{
  TextEditorState state=new TextEditorState();
  CaretModel caretModel=editor.getCaretModel();
  if (caretModel.supportsMultipleCarets()) {
    Collection<Caret> allCarets=caretModel.getAllCarets();
    state.CARETS=new TextEditorState.CaretState[allCarets.size()];
    int i=0;
    for (    Caret caret : allCarets) {
      state.CARETS[i]=new TextEditorState.CaretState();
      state.CARETS[i].LINE=caret.getLogicalPosition().line;
      state.CARETS[i].COLUMN=caret.getLogicalPosition().column;
      state.CARETS[i].SELECTION_START=caret.getSelectionStart();
      state.CARETS[i++].SELECTION_END=caret.getSelectionEnd();
    }
  }
 else {
    state.CARETS=new TextEditorState.CaretState[1];
    state.CARETS[0]=new TextEditorState.CaretState();
    state.CARETS[0].LINE=editor.getCaretModel().getLogicalPosition().line;
    state.CARETS[0].COLUMN=editor.getCaretModel().getLogicalPosition().column;
    state.CARETS[0].SELECTION_START=editor.getSelectionModel().getSelectionStart();
    state.CARETS[0].SELECTION_END=editor.getSelectionModel().getSelectionEnd();
  }
  state.VERTICAL_SCROLL_PROPORTION=level == FileEditorStateLevel.UNDO ? -1 : EditorUtil.calcVerticalScrollProportion(editor);
  if (editor instanceof EditorEx) {
    state.VERTICAL_SCROLL_OFFSET=editor.getScrollingModel().getVerticalScrollOffset();
    JScrollBar scrollBar=((EditorEx)editor).getScrollPane().getVerticalScrollBar();
    state.MAX_VERTICAL_SCROLL_OFFSET=scrollBar == null ? 0 : scrollBar.getMaximum();
  }
  return state;
}
