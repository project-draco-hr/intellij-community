{
  if (project.isDisposed()) {
    return Collections.emptyList();
  }
  List<Runnable> tasks=new ArrayList<Runnable>();
  final ProjectFileIndex projectFileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  tasks.add(new Runnable(){
    @Override public void run(){
      projectFileIndex.iterateContent(processor);
    }
  }
);
  final Set<VirtualFile> visitedRoots=ContainerUtil.newConcurrentSet();
  for (  IndexableSetContributor contributor : Extensions.getExtensions(IndexableSetContributor.EP_NAME)) {
    if (project.isDisposed()) {
      return tasks;
    }
    for (    final VirtualFile root : IndexableSetContributor.getRootsToIndex(contributor)) {
      if (visitedRoots.add(root)) {
        tasks.add(new Runnable(){
          @Override public void run(){
            if (project.isDisposed() || !root.isValid())             return;
            iterateRecursively(root,processor,indicator,visitedRoots,null);
          }
        }
);
      }
    }
    for (    final VirtualFile root : IndexableSetContributor.getProjectRootsToIndex(contributor,project)) {
      if (visitedRoots.add(root)) {
        tasks.add(new Runnable(){
          @Override public void run(){
            if (project.isDisposed() || !root.isValid())             return;
            iterateRecursively(root,processor,indicator,visitedRoots,null);
          }
        }
);
      }
    }
  }
  for (  final Module module : ModuleManager.getInstance(project).getModules()) {
    OrderEntry[] orderEntries=ModuleRootManager.getInstance(module).getOrderEntries();
    for (    OrderEntry orderEntry : orderEntries) {
      if (orderEntry instanceof LibraryOrSdkOrderEntry) {
        if (orderEntry.isValid()) {
          final LibraryOrSdkOrderEntry entry=(LibraryOrSdkOrderEntry)orderEntry;
          final VirtualFile[] libSources=entry.getRootFiles(OrderRootType.SOURCES);
          final VirtualFile[] libClasses=entry.getRootFiles(OrderRootType.CLASSES);
          for (          VirtualFile[] roots : new VirtualFile[][]{libSources,libClasses}) {
            for (            final VirtualFile root : roots) {
              if (visitedRoots.add(root)) {
                tasks.add(new Runnable(){
                  @Override public void run(){
                    if (project.isDisposed() || module.isDisposed() || !root.isValid())                     return;
                    iterateRecursively(root,processor,indicator,visitedRoots,projectFileIndex);
                  }
                }
);
              }
            }
          }
        }
      }
    }
  }
  return tasks;
}
