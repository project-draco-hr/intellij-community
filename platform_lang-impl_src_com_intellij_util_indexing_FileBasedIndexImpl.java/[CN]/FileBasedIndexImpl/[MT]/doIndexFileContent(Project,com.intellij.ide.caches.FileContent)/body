{
  final VirtualFile file=content.getVirtualFile();
  final FileType fileType=file.getFileType();
  final Project finalProject=project == null ? ProjectUtil.guessProjectForFile(file) : project;
  myFileTypeManager.freezeFileTypeTemporarilyIn(file,new Runnable(){
    @Override public void run(){
      PsiFile psiFile=null;
      FileContentImpl fc=null;
      int inputId=-1;
      final List<ID<?,?>> affectedIndexCandidates=getAffectedIndexCandidates(file);
      for (int i=0, size=affectedIndexCandidates.size(); i < size; ++i) {
        final ID<?,?> indexId=affectedIndexCandidates.get(i);
        if (shouldIndexFile(file,indexId)) {
          if (fc == null) {
            byte[] currentBytes;
            try {
              currentBytes=content.getBytes();
            }
 catch (            IOException e) {
              currentBytes=ArrayUtil.EMPTY_BYTE_ARRAY;
            }
            fc=new FileContentImpl(file,currentBytes);
            if (!fileType.isBinary() && IdIndex.ourSnapshotMappingsEnabled) {
              try {
                byte[] hash=ContentHashesSupport.calcContentHashWithFileType(currentBytes,fc.getCharset(),SubstitutedFileType.substituteFileType(file,fileType,finalProject));
                fc.setHash(hash);
              }
 catch (              IOException e) {
                LOG.error(e);
              }
            }
            psiFile=content.getUserData(IndexingDataKeys.PSI_FILE);
            initFileContent(fc,finalProject,psiFile);
            inputId=Math.abs(getFileId(file));
          }
          try {
            ProgressManager.checkCanceled();
            updateSingleIndex(indexId,inputId,fc);
          }
 catch (          ProcessCanceledException e) {
            cleanFileContent(fc,psiFile);
            throw e;
          }
catch (          StorageException e) {
            requestRebuild(indexId);
            LOG.info(e);
          }
        }
      }
      if (psiFile != null) {
        psiFile.putUserData(PsiFileImpl.BUILDING_STUB,null);
      }
    }
  }
);
}
