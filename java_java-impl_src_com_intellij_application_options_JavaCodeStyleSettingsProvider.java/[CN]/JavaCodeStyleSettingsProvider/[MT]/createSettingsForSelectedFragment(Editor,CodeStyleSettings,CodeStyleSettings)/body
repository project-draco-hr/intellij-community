{
  TabbedLanguageCodeStylePanel panel=new TabbedLanguageCodeStylePanel(getLanguage(),settings,settings){
    @Override protected void initTabs(    CodeStyleSettings settings){
      addSpacesTab(settings);
      addWrappingAndBracesTab(settings);
    }
    @Override protected void somethingChanged(){
      super.somethingChanged();
      final SelectionModel model=editor.getSelectionModel();
      if (model.hasSelection()) {
        CodeStyleSettings clone=getSettings().clone();
        Project project=editor.getProject();
        if (project == null)         return;
        try {
          CodeStyleSettingsManager.getInstance(project).setTemporarySettings(clone);
          Document document=editor.getDocument();
          PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
          if (file != null) {
            reformatSelectedFragment(model,file);
          }
        }
  finally {
          CodeStyleSettingsManager.getInstance(project).dropTemporarySettings();
        }
      }
    }
    private void reformatSelectedFragment(    final SelectionModel model,    final PsiFile file){
      final Project project=file.getProject();
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        @Override public void run(){
          ApplicationManager.getApplication().runWriteAction(new Runnable(){
            @Override public void run(){
              CodeStyleManager.getInstance(project).reformatText(file,model.getSelectionStart(),model.getSelectionEnd());
            }
          }
);
        }
      }
,"Reformat",null);
    }
  }
;
  return panel.getPanel();
}
