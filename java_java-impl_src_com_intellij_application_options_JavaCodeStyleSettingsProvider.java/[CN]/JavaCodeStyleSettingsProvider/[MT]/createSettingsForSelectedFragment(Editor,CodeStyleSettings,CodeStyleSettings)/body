{
  return new TabbedLanguageCodeStylePanel(getLanguage(),currentSettings,settings){
    @Override protected void initTabs(    CodeStyleSettings settings){
      MySpacesPanel spacesPanel=new MySpacesPanel(settings){
        @Override protected void somethingChanged(){
          reformatWithNewSettings();
        }
      }
;
      MyWrappingAndBracesPanel bracesPanel=new MyWrappingAndBracesPanel(settings){
        @Override protected void somethingChanged(){
          reformatWithNewSettings();
        }
      }
;
      addTab(spacesPanel);
      addTab(bracesPanel);
      reset(getSettings());
    }
    private void reformatWithNewSettings(){
      final SelectionModel model=editor.getSelectionModel();
      if (model.hasSelection()) {
        try {
          apply(getSettings());
        }
 catch (        ConfigurationException e) {
          e.printStackTrace();
        }
        CodeStyleSettings clone=getSettings().clone();
        Project project=editor.getProject();
        if (project == null)         return;
        try {
          CodeStyleSettingsManager.getInstance(project).setTemporarySettings(clone);
          Document document=editor.getDocument();
          PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
          if (file != null) {
            reformatSelectedFragment(model,file);
          }
        }
  finally {
          CodeStyleSettingsManager.getInstance(project).dropTemporarySettings();
        }
      }
    }
    private void reformatSelectedFragment(    final SelectionModel model,    final PsiFile file){
      final Project project=file.getProject();
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        @Override public void run(){
          ApplicationManager.getApplication().runWriteAction(new Runnable(){
            @Override public void run(){
              CodeStyleManager.getInstance(project).reformatText(file,model.getSelectionStart(),model.getSelectionEnd());
            }
          }
);
        }
      }
,"Reformat",null);
    }
  }
;
}
