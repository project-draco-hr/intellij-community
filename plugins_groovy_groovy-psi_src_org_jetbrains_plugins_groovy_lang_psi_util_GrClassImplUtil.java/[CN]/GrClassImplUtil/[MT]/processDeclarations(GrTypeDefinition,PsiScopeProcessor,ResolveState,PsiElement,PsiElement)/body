{
  if (place instanceof GrCodeReferenceElement && lastParent instanceof GrModifierList) {
    final PsiElement possibleAnnotation=PsiTreeUtil.skipParentsOfType(place,GrCodeReferenceElement.class);
    if (possibleAnnotation instanceof GrAnnotation && possibleAnnotation.getParent() == lastParent) {
      return true;
    }
  }
  for (  final PsiTypeParameter typeParameter : grType.getTypeParameters()) {
    if (!ResolveUtil.processElement(processor,typeParameter,state))     return false;
  }
  NameHint nameHint=processor.getHint(NameHint.KEY);
  String name=nameHint == null ? null : nameHint.getName(state);
  ElementClassHint classHint=processor.getHint(ElementClassHint.KEY);
  final PsiSubstitutor substitutor=state.get(PsiSubstitutor.KEY);
  final PsiElementFactory factory=JavaPsiFacade.getElementFactory(place.getProject());
  boolean processInstanceMethods=(ResolveUtil.shouldProcessMethods(classHint) || ResolveUtil.shouldProcessProperties(classHint)) && shouldProcessInstanceMembers(grType,lastParent);
  LanguageLevel level=PsiUtil.getLanguageLevel(place);
  if (ResolveUtil.shouldProcessProperties(classHint)) {
    Map<String,CandidateInfo> fieldsMap=CollectClassMembersUtil.getAllFields(grType);
    if (name != null) {
      CandidateInfo fieldInfo=fieldsMap.get(name);
      if (fieldInfo != null) {
        if (!processField(grType,processor,state,place,processInstanceMethods,substitutor,factory,level,fieldInfo)) {
          return false;
        }
      }
 else       if (grType.isTrait() && lastParent != null) {
        PsiField field=findFieldByName(grType,name,false,true);
        if (field != null && field.hasModifierProperty(PsiModifier.PUBLIC)) {
          if (!processField(grType,processor,state,place,processInstanceMethods,substitutor,factory,level,new CandidateInfo(field,PsiSubstitutor.EMPTY))) {
            return false;
          }
        }
      }
    }
 else {
      for (      CandidateInfo info : fieldsMap.values()) {
        if (!processField(grType,processor,state,place,processInstanceMethods,substitutor,factory,level,info)) {
          return false;
        }
      }
      if (grType.isTrait() && lastParent != null) {
        for (        PsiField field : CollectClassMembersUtil.getFields(grType,true)) {
          if (field.hasModifierProperty(PsiModifier.PUBLIC)) {
            if (!processField(grType,processor,state,place,processInstanceMethods,substitutor,factory,level,new CandidateInfo(field,PsiSubstitutor.EMPTY))) {
              return false;
            }
          }
        }
      }
    }
  }
  if (ResolveUtil.shouldProcessMethods(classHint)) {
    Map<String,List<CandidateInfo>> methodsMap=CollectClassMembersUtil.getAllMethods(grType,true);
    boolean isPlaceGroovy=place.getLanguage() == GroovyLanguage.INSTANCE;
    if (name == null) {
      for (      List<CandidateInfo> list : methodsMap.values()) {
        for (        CandidateInfo info : list) {
          if (!processMethod(grType,processor,state,place,processInstanceMethods,substitutor,factory,level,isPlaceGroovy,info)) {
            return false;
          }
        }
      }
    }
 else {
      List<CandidateInfo> byName=methodsMap.get(name);
      if (byName != null) {
        for (        CandidateInfo info : byName) {
          if (!processMethod(grType,processor,state,place,processInstanceMethods,substitutor,factory,level,isPlaceGroovy,info)) {
            return false;
          }
        }
      }
    }
  }
  final GrTypeDefinitionBody body=grType.getBody();
  if (body != null) {
    if (ResolveUtil.shouldProcessClasses(classHint)) {
      for (      PsiClass innerClass : getInnerClassesForResolve(grType,lastParent,place)) {
        final String innerClassName=innerClass.getName();
        if (nameHint != null && !innerClassName.equals(nameHint.getName(state))) {
          continue;
        }
        if (!processor.execute(innerClass,state)) {
          return false;
        }
      }
    }
  }
  return true;
}
