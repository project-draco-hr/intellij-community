{
  final Project project=e.getProject();
  Module module=LangDataKeys.MODULE.getData(e.getDataContext());
  if (project == null || module == null) {
    return;
  }
  final PsiFile file=CommonDataKeys.PSI_FILE.getData(e.getDataContext());
  if (file == null) {
    return;
  }
  final CCProjectService service=CCProjectService.getInstance(project);
  Course course=service.getCourse();
  if (course == null) {
    return;
  }
  VirtualFile virtualFile=file.getVirtualFile();
  TaskFile taskFile=service.getTaskFile(virtualFile);
  if (taskFile == null) {
    return;
  }
  final PsiDirectory taskDir=file.getContainingDirectory();
  if (taskDir == null) {
    return;
  }
  PsiDirectory lessonDir=taskDir.getParentDirectory();
  if (lessonDir == null) {
    return;
  }
  if (taskFile.getAnswerPlaceholders().isEmpty()) {
    Messages.showInfoMessage("Preview is available for task files with answer placeholders only","No Preview for This File");
    return;
  }
  final TaskFile taskFileCopy=new TaskFile();
  TaskFile.copy(taskFile,taskFileCopy);
  VirtualFile generatedFilesFolder=CCUtils.getGeneratedFilesFolder(project,module);
  if (generatedFilesFolder == null) {
    return;
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      EduUtils.createStudentFileFromAnswer(project,generatedFilesFolder,taskDir.getVirtualFile(),virtualFile.getName(),taskFileCopy);
    }
  }
);
  VirtualFile userFile=generatedFilesFolder.findChild(virtualFile.getName());
  if (userFile == null) {
    LOG.info("Generated file " + virtualFile.getName() + "was not found");
    return;
  }
  final FrameWrapper showPreviewFrame=new FrameWrapper(project);
  showPreviewFrame.setTitle(virtualFile.getName());
  LabeledEditor labeledEditor=new LabeledEditor(null);
  final EditorFactory factory=EditorFactory.getInstance();
  Document document=FileDocumentManager.getInstance().getDocument(userFile);
  if (document == null) {
    return;
  }
  final EditorEx createdEditor=(EditorEx)factory.createEditor(document,project,userFile,true);
  Disposer.register(project,new Disposable(){
    public void dispose(){
      factory.releaseEditor(createdEditor);
    }
  }
);
  for (  AnswerPlaceholder answerPlaceholder : taskFileCopy.getAnswerPlaceholders()) {
    EduAnswerPlaceholderPainter.drawAnswerPlaceholder(createdEditor,answerPlaceholder,true,JBColor.BLUE);
  }
  JPanel header=new JPanel();
  header.setLayout(new BoxLayout(header,BoxLayout.Y_AXIS));
  header.setBorder(new EmptyBorder(10,10,10,10));
  header.add(new JLabel("Read-only preview."));
  String timeStamp=new SimpleDateFormat("yyyy/MM/dd HH:mm:ss").format(Calendar.getInstance().getTime());
  header.add(new JLabel(String.format("Created %s.",timeStamp)));
  JComponent editorComponent=createdEditor.getComponent();
  labeledEditor.setComponent(editorComponent,header);
  createdEditor.setCaretVisible(false);
  createdEditor.setCaretEnabled(false);
  showPreviewFrame.setComponent(labeledEditor);
  showPreviewFrame.setSize(new Dimension(500,500));
  showPreviewFrame.show();
}
