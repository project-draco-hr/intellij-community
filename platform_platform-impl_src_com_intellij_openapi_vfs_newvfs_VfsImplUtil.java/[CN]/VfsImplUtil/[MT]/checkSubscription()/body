{
  if (ourSubscribed.getAndSet(true))   return;
  MessageBus bus=ApplicationManager.getApplication().getMessageBus();
  bus.connect().subscribe(VirtualFileManager.VFS_CHANGES,new BulkFileListener.Adapter(){
    @Override public void after(    @NotNull List<? extends VFileEvent> events){
      InvalidationState state=null;
synchronized (ourLock) {
        for (        VFileEvent event : events) {
          if (!(event.getFileSystem() instanceof LocalFileSystem))           continue;
          if (event instanceof VFileCreateEvent)           continue;
          if (event instanceof VFilePropertyChangeEvent && VirtualFile.PROP_HIDDEN.equals(((VFilePropertyChangeEvent)event).getPropertyName())) {
            continue;
          }
          VirtualFile file=event.getFile();
          String path=event.getPath();
          if (event instanceof VFilePropertyChangeEvent) {
            path=((VFilePropertyChangeEvent)event).getOldPath();
          }
 else           if (event instanceof VFileMoveEvent) {
            path=((VFileMoveEvent)event).getOldPath();
          }
          if (file == null || !file.isDirectory()) {
            if (state == null)             state=new InvalidationState();
            state.invalidateHandlerForPath(path);
          }
 else {
            Collection<String> affectedPaths=ourDominatorsMap.get(path);
            if (affectedPaths != null) {
              affectedPaths=new ArrayList<String>(affectedPaths);
              if (state == null)               state=new InvalidationState();
              for (              String affectedPath : affectedPaths)               state.invalidateHandlerForPath(affectedPath);
            }
          }
        }
      }
      if (state != null)       state.scheduleRefresh();
    }
  }
);
}
