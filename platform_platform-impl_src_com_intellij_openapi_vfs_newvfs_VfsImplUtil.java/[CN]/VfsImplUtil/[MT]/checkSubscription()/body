{
  if (ourSubscribed.getAndSet(true))   return;
  MessageBus bus=ApplicationManager.getApplication().getMessageBus();
  bus.connect().subscribe(VirtualFileManager.VFS_CHANGES,new BulkFileListener.Adapter(){
    @Override public void after(    @NotNull List<? extends VFileEvent> events){
      Map<String,VirtualFile> rootsToRefresh=null;
synchronized (ourLock) {
        for (        VFileEvent event : events) {
          if (!(event.getFileSystem() instanceof LocalFileSystem))           continue;
          if (event instanceof VFileCreateEvent)           continue;
          if (event instanceof VFilePropertyChangeEvent && VirtualFile.PROP_HIDDEN.equals(((VFilePropertyChangeEvent)event).getPropertyName())) {
            continue;
          }
          VirtualFile file=event.getFile();
          String path=event.getPath();
          if (file == null || !file.isDirectory()) {
            rootsToRefresh=invalidateHandlerForPath(path,rootsToRefresh);
          }
 else {
            Collection<String> affectedPaths=ourDominatorsMap.get(path);
            if (affectedPaths != null) {
              affectedPaths=new ArrayList<String>(affectedPaths);
              for (              String affectedPath : affectedPaths)               rootsToRefresh=invalidateHandlerForPath(affectedPath,rootsToRefresh);
            }
          }
        }
      }
      if (rootsToRefresh != null) {
        ZipFileCache.reset(rootsToRefresh.keySet());
        boolean async=!ApplicationManager.getApplication().isUnitTestMode();
        RefreshQueue.getInstance().refresh(async,true,null,rootsToRefresh.values());
      }
    }
  }
);
}
