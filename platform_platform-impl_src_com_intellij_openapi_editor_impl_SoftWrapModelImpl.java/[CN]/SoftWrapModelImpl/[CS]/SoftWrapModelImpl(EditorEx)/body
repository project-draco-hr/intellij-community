{
  myEditor=editor;
  myStorage=new SoftWrapsStorage();
  myPainter=new CompositeSoftWrapPainter(editor);
  DefaultEditorTextRepresentationHelper representationHelper=new DefaultEditorTextRepresentationHelper(editor);
  myDataMapper=new CachingSoftWrapDataMapper(editor,myStorage,representationHelper);
  myApplianceManager=new SoftWrapApplianceManager(myStorage,editor,myPainter,representationHelper,myDataMapper);
  myFoldBasedApplianceStrategy=new SoftWrapFoldBasedApplianceStrategy(editor);
  myVisualSizeManager=new SoftWrapAwareVisualSizeManager(myPainter);
  myDocumentListeners.add(myApplianceManager);
  myApplianceManager.addListener(myVisualSizeManager);
  myApplianceManager.addListener(new SoftWrapAwareDocumentParsingListenerAdapter(){
    @Override public void recalculationEnds(){
      for (      SoftWrapChangeListener listener : mySoftWrapListeners) {
        listener.recalculationEnds();
      }
    }
  }
);
  EditorSettings settings=myEditor.getSettings();
  myUseSoftWraps=settings.isUseSoftWraps();
  editor.addPropertyChangeListener(this);
  ApplicationManager.getApplication().getMessageBus().connect(this).subscribe(DocumentBulkUpdateListener.TOPIC,this);
  myApplianceManager.addListener(myDataMapper);
}
