{
  final Ref<PsiElement> newContext=Ref.create(context);
  final PsiFile file=context.getContainingFile();
  CompletionInitializationContext initializationContext=new CompletionInitializationContext(editor,file,CompletionType.BASIC);
  new JavaCompletionContributor().beforeCompletion(initializationContext);
  if (StringUtil.endsWithChar(initializationContext.getDummyIdentifier(),';')) {
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        CommandProcessor.getInstance().runUndoTransparentAction(new Runnable(){
          public void run(){
            document.insertString(offset,";");
            PsiDocumentManager.getInstance(context.getProject()).commitDocument(document);
            newContext.set(CustomTemplateCallback.getContext(file,offset - 1));
          }
        }
);
      }
    }
);
  }
  return newContext.get();
}
