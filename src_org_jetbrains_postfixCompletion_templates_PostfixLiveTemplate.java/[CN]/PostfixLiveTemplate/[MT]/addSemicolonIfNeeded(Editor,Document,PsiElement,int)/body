{
  ApplicationManager.getApplication().assertIsDispatchThread();
  final Ref<PsiElement> newContext=Ref.create(context);
  final PsiFile file=context.getContainingFile();
  if (isSemicolonNeeded(file,editor)) {
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        CommandProcessor.getInstance().runUndoTransparentAction(new Runnable(){
          public void run(){
            document.insertString(offset,";");
            PsiDocumentManager.getInstance(context.getProject()).commitDocument(document);
            newContext.set(CustomTemplateCallback.getContext(file,offset - 1));
          }
        }
);
      }
    }
);
  }
  return newContext.get();
}
