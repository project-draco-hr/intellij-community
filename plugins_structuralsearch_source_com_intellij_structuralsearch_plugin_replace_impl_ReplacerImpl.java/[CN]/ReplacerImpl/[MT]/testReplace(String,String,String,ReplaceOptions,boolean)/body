{
  this.options=options;
  this.options.getMatchOptions().setSearchPattern(what);
  this.options.setReplacement(by);
  replacementBuilder=null;
  context=null;
  this.options.getMatchOptions().clearVariableConstraints();
  MatcherImplUtil.transform(this.options.getMatchOptions());
  checkSupportedReplacementPattern(project,this.options.getMatchOptions().getSearchPattern(),by,this.options.getMatchOptions().getFileType());
  Matcher matcher=new Matcher(project);
  try {
    PsiElement firstElement, lastElement, parent;
    if (options.getMatchOptions().getScope() == null) {
      PsiElement[] elements=MatcherImplUtil.createTreeFromText(in,filePattern ? MatcherImplUtil.TreeContext.File : MatcherImplUtil.TreeContext.Block,this.options.getMatchOptions().getFileType(),project);
      firstElement=elements[0];
      lastElement=elements[elements.length - 1];
      parent=firstElement.getParent();
      this.options.getMatchOptions().setScope(new LocalSearchScope(parent));
    }
 else {
      parent=((LocalSearchScope)options.getMatchOptions().getScope()).getScope()[0];
      firstElement=parent.getFirstChild();
      lastElement=parent.getLastChild();
    }
    this.options.getMatchOptions().setResultIsContextMatch(true);
    CollectingMatchResultSink sink=new CollectingMatchResultSink();
    matcher.testFindMatches(sink,this.options.getMatchOptions());
    final List<ReplacementInfo> resultPtrList=new LinkedList<ReplacementInfo>();
    for (    final MatchResult result : sink.getMatches()) {
      resultPtrList.add(buildReplacement(result));
    }
    sink.getMatches().clear();
    int startOffset=firstElement.getTextRange().getStartOffset();
    int endOffset=filePattern ? 0 : parent.getTextLength() - (lastElement.getTextRange().getEndOffset());
    PsiElement prevSibling=firstElement.getPrevSibling();
    if (prevSibling instanceof PsiWhiteSpace) {
      startOffset-=prevSibling.getTextLength() - 1;
    }
    PsiElement nextSibling=lastElement.getNextSibling();
    if (nextSibling instanceof PsiWhiteSpace) {
      endOffset-=nextSibling.getTextLength() - 1;
    }
    replaceAll(resultPtrList);
    String result=parent.getText();
    result=result.substring(startOffset);
    result=result.substring(0,result.length() - endOffset);
    return result;
  }
 catch (  Exception ex) {
    throw new IncorrectOperationException("Unexpected failure:",ex);
  }
 finally {
    options.getMatchOptions().setScope(null);
  }
}
