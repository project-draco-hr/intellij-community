{
  PsiElement lastAffectedElement=null;
  PsiElement currentAffectedElement=null;
  for (  final ReplacementInfo aResultPtrList : resultPtrList) {
    currentAffectedElement=doReplace(aResultPtrList);
    if (currentAffectedElement != lastAffectedElement) {
      if (lastAffectedElement != null)       reformatAndShortenRefs(lastAffectedElement);
      lastAffectedElement=currentAffectedElement;
    }
  }
  reformatAndShortenRefs(lastAffectedElement);
}
