{
  PsiElement lastAffectedElement=null;
  PsiElement currentAffectedElement;
  for (  ReplacementInfo replacementInfo : resultPtrList) {
    ReplacementInfoImpl info=(ReplacementInfoImpl)replacementInfo;
    PsiElement element=info.getMatchResult().getMatch();
    StructuralSearchProfile profile=StructuralSearchUtil.getProfileByPsiElement(element);
    if (profile != null) {
      StructuralReplaceHandler handler=profile.getReplaceHandler(context);
      if (handler != null) {
        handler.prepare(info,project);
      }
    }
  }
  for (  final ReplacementInfo aResultPtrList : resultPtrList) {
    currentAffectedElement=doReplace(aResultPtrList);
    if (currentAffectedElement != lastAffectedElement) {
      if (lastAffectedElement != null)       reformatAndShortenRefs(lastAffectedElement);
      lastAffectedElement=currentAffectedElement;
    }
  }
  reformatAndShortenRefs(lastAffectedElement);
}
