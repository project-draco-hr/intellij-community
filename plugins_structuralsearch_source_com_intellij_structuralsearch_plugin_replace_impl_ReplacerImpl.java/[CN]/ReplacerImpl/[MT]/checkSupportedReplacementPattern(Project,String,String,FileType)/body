{
  try {
    Template template=TemplateManager.getInstance(project).createTemplate("","",search);
    Template template2=TemplateManager.getInstance(project).createTemplate("","",replacement);
    int segmentCount=template2.getSegmentsCount();
    for (int i=0; i < segmentCount; ++i) {
      final String replacementSegmentName=template2.getSegmentName(i);
      final int segmentCount2=template.getSegmentsCount();
      int j;
      for (j=0; j < segmentCount2; ++j) {
        final String searchSegmentName=template.getSegmentName(j);
        if (replacementSegmentName.equals(searchSegmentName))         break;
        if (replacementSegmentName.startsWith(searchSegmentName) && replacementSegmentName.charAt(searchSegmentName.length()) == '_') {
          try {
            Integer.parseInt(replacementSegmentName.substring(searchSegmentName.length() + 1));
            break;
          }
 catch (          NumberFormatException ex) {
          }
        }
      }
      if (j == segmentCount2) {
        throw new UnsupportedPatternException("Replacement variable " + replacementSegmentName + " is not defined in search segment.");
      }
    }
    PsiElement[] statements=MatcherImplUtil.createTreeFromText(search,false,fileType,project);
    boolean searchIsExpression=false;
    for (int i=0; i < statements.length; i++) {
      PsiElement statement=statements[i];
      if (statement.getLastChild() instanceof PsiErrorElement) {
        searchIsExpression=true;
        break;
      }
    }
    PsiElement[] statements2=MatcherImplUtil.createTreeFromText(replacement,false,fileType,project);
    boolean replaceIsExpression=false;
    for (int i=0; i < statements2.length; i++) {
      PsiElement statement=statements2[i];
      if (statement.getLastChild() instanceof PsiErrorElement) {
        replaceIsExpression=true;
        break;
      }
    }
    if (searchIsExpression != replaceIsExpression) {
      throw new UnsupportedPatternException((searchIsExpression) ? "Search query is expression,but replacement query isn't" : "Search query is not expression,but replacement query is");
    }
  }
 catch (  IncorrectOperationException ex) {
    throw new UnsupportedPatternException("Incorrect pattern");
  }
}
