{
  if (elementType != null && marker != null) {
    if ((frame.modifiers & _COLLAPSE_) != 0) {
      PsiBuilderImpl.ProductionMarker last=result || pinned ? (PsiBuilderImpl.ProductionMarker)builder.getLatestDoneMarker() : null;
      if (last != null && last.getStartIndex() == frame.position && state.typeExtends(last.getTokenType(),elementType)) {
        IElementType resultType=last.getTokenType();
        ((PsiBuilder.Marker)last).drop();
        marker.done(resultType);
        return;
      }
    }
    if (result || pinned) {
      if ((frame.modifiers & _UPPER_) != 0) {
        marker.drop();
        for (Frame f=frame.parentFrame; f != null; f=f.parentFrame) {
          if (f.elementType == null)           continue;
          f.elementType=elementType;
          break;
        }
      }
 else       if ((frame.modifiers & _LEFT_INNER_) != 0 && frame.leftMarker != null) {
        marker.done(elementType);
        frame.leftMarker.precede().done(((LighterASTNode)frame.leftMarker).getTokenType());
        frame.leftMarker.drop();
      }
 else       if ((frame.modifiers & _LEFT_) != 0 && frame.leftMarker != null) {
        marker.drop();
        frame.leftMarker.precede().done(elementType);
      }
 else {
        if (frame.level == 0)         builder.eof();
        marker.done(elementType);
      }
    }
 else {
      close_marker_impl_(frame,marker,null,false);
    }
  }
 else   if (result || pinned) {
    if (marker != null)     marker.drop();
    if ((frame.modifiers & _LEFT_INNER_) != 0 && frame.leftMarker != null) {
      frame.leftMarker.precede().done(((LighterASTNode)frame.leftMarker).getTokenType());
      frame.leftMarker.drop();
    }
  }
 else {
    close_marker_impl_(frame,marker,null,false);
  }
}
