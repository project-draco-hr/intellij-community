{
  JavaParameters javaParameters=super.createJavaParameters();
  javaParameters.setMainClass(JUnitConfiguration.JUNIT_START_CLASS);
  javaParameters.getProgramParametersList().add(JUnitStarter.IDE_VERSION + JUnitStarter.VERSION);
  final StringBuilder buf=new StringBuilder();
  collectListeners(javaParameters,buf,IDEAJUnitListener.EP_NAME,"\n");
  if (buf.length() > 0) {
    try {
      myListenersFile=FileUtil.createTempFile("junit_listeners_","",true);
      javaParameters.getProgramParametersList().add("@@" + myListenersFile.getPath());
      FileUtil.writeToFile(myListenersFile,buf.toString().getBytes(CharsetToolkit.UTF8_CHARSET));
    }
 catch (    IOException e) {
      LOG.error(e);
    }
  }
  final Project project=getConfiguration().getProject();
  final SourceScope sourceScope=getSourceScope();
  final GlobalSearchScope scope=sourceScope != null ? sourceScope.getLibrariesScope() : GlobalSearchScope.allScope(project);
  if (JUnitUtil.isJUnit5(scope,project)) {
    javaParameters.getProgramParametersList().add(JUnitStarter.JUNIT5_PARAMETER);
    javaParameters.getClassPath().add(PathUtil.getJarPathForClass(JUnit5IdeaTestRunner.class));
    final PathsList classPath=javaParameters.getClassPath();
    classPath.add(PathUtil.getJarPathForClass(TestExecutionListener.class));
    classPath.add(PathUtil.getJarPathForClass(JupiterTestEngine.class));
    classPath.add(PathUtil.getJarPathForClass(JUnitException.class));
    classPath.add(PathUtil.getJarPathForClass(TestEngine.class));
    classPath.add(PathUtil.getJarPathForClass(JUnitPlatform.class));
    try {
      JUnitUtil.getTestCaseClass(sourceScope);
      classPath.add(PathUtil.getJarPathForClass(VintageTestEngine.class));
    }
 catch (    JUnitUtil.NoJUnitException ignore) {
    }
  }
  return javaParameters;
}
