{
  String parameters=myConfiguration.getProgramParameters();
  myConfiguration.getPersistentData().setProgramParameters(null);
  try {
    JavaParametersUtil.configureConfiguration(myJavaParameters,myConfiguration);
  }
  finally {
    myConfiguration.getPersistentData().setProgramParameters(parameters);
  }
  myJavaParameters.setMainClass(JUnitConfiguration.JUNIT_START_CLASS);
  final Module module=myConfiguration.getConfigurationModule().getModule();
  if (myJavaParameters.getJdk() == null) {
    myJavaParameters.setJdk(module != null ? ModuleRootManager.getInstance(module).getSdk() : ProjectRootManager.getInstance(myProject).getProjectSdk());
  }
  myJavaParameters.getClassPath().add(JavaSdkUtil.getIdeaRtJarPath());
  myJavaParameters.getClassPath().add(PathUtil.getJarPathForClass(JUnitStarter.class));
  if (Registry.is("junit_sm_runner",false)) {
    myJavaParameters.getClassPath().add(PathUtil.getJarPathForClass(ServiceMessageTypes.class));
  }
  myJavaParameters.getProgramParametersList().add(JUnitStarter.IDE_VERSION + JUnitStarter.VERSION);
  if (!StringUtil.isEmptyOrSpaces(parameters)) {
    myJavaParameters.getProgramParametersList().add("@name" + parameters);
  }
  for (  RunConfigurationExtension ext : Extensions.getExtensions(RunConfigurationExtension.EP_NAME)) {
    ext.updateJavaParameters(myConfiguration,myJavaParameters,getRunnerSettings());
  }
  final Object[] listeners=Extensions.getExtensions(IDEAJUnitListener.EP_NAME);
  final StringBuilder buf=new StringBuilder();
  for (  final Object listener : listeners) {
    boolean enabled=true;
    for (    RunConfigurationExtension ext : Extensions.getExtensions(RunConfigurationExtension.EP_NAME)) {
      if (ext.isListenerDisabled(myConfiguration,listener,getRunnerSettings())) {
        enabled=false;
        break;
      }
    }
    if (enabled) {
      final Class classListener=listener.getClass();
      buf.append(classListener.getName()).append("\n");
      myJavaParameters.getClassPath().add(PathUtil.getJarPathForClass(classListener));
    }
  }
  if (buf.length() > 0) {
    try {
      myListenersFile=FileUtil.createTempFile("junit_listeners_","");
      myListenersFile.deleteOnExit();
      myJavaParameters.getProgramParametersList().add("@@" + myListenersFile.getPath());
      FileUtil.writeToFile(myListenersFile,buf.toString().getBytes(CharsetToolkit.UTF8_CHARSET));
    }
 catch (    IOException e) {
      LOG.error(e);
    }
  }
}
