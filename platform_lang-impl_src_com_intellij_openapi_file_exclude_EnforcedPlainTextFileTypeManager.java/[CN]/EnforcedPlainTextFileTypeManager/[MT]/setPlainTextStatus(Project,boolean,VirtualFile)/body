{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      ProjectRootManagerEx.getInstanceEx(project).makeRootsChange(new Runnable(){
        @Override public void run(){
          ProjectPlainTextFileTypeManager projectPlainTextFileTypeManager=ProjectPlainTextFileTypeManager.getInstance(project);
          for (          VirtualFile file : files) {
            if (projectPlainTextFileTypeManager.hasProjectContaining(file)) {
              ensureProjectFileSetAdded(project,projectPlainTextFileTypeManager);
              if (isAdded ? projectPlainTextFileTypeManager.addFile(file) : projectPlainTextFileTypeManager.removeFile(file)) {
                FileBasedIndex.getInstance().requestReindex(file);
              }
            }
          }
        }
      }
,false,true);
    }
  }
);
}
