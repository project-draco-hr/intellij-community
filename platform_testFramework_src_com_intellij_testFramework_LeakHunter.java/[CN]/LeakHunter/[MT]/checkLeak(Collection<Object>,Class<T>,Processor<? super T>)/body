{
  if (SwingUtilities.isEventDispatchThread()) {
    UIUtil.dispatchAllInvocationEvents();
  }
 else {
    UIUtil.pump();
  }
  PersistentEnumeratorBase.clearCacheForTests();
  walkObjects(suspectClass,roots,new Processor<BackLink>(){
    @SuppressWarnings("UseOfSystemOutOrSystemErr") @Override public boolean process(    BackLink backLink){
      T leaked=(T)backLink.value;
      if (markLeaked(leaked) && (isReallyLeak == null || isReallyLeak.process(leaked))) {
        String place=leaked instanceof Project ? PlatformTestCase.getCreationPlace((Project)leaked) : "";
        System.out.println("Leaked object found:" + leaked + "; hash: "+ System.identityHashCode(leaked)+ "; place: "+ place);
        System.out.println(backLink);
        System.out.println(";-----");
        throw new AssertionError();
      }
      return true;
    }
    private boolean markLeaked(    T leaked){
      return !(leaked instanceof UserDataHolderEx) || ((UserDataHolderEx)leaked).replace(REPORTED_LEAKED,null,Boolean.TRUE);
    }
  }
);
}
