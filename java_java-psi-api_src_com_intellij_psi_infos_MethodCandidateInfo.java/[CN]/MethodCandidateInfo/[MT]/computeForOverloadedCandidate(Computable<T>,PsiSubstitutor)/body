{
  Map<PsiElement,CurrentCandidateProperties> map=CURRENT_CANDIDATE.get();
  if (map == null) {
    map=ContainerUtil.createConcurrentWeakMap();
    CURRENT_CANDIDATE.set(map);
  }
  final CurrentCandidateProperties alreadyThere=map.put(getMarkerList(),new CurrentCandidateProperties(getElement(),substitutor,isVarargs(),true));
  try {
    return computable.compute();
  }
  finally {
    if (alreadyThere == null) {
      map.remove(getMarkerList());
    }
 else {
      map.put(getMarkerList(),alreadyThere);
    }
  }
}
