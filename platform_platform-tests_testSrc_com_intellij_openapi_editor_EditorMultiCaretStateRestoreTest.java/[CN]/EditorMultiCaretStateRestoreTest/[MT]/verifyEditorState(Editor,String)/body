{
  final Document document=new DocumentImpl(textWithMarkup);
  EditorTestUtil.CaretsState caretAndSelectionState=new WriteCommandAction<EditorTestUtil.CaretsState>(null){
    @Override protected void run(    @NotNull Result<EditorTestUtil.CaretsState> result) throws Throwable {
      result.setResult(EditorTestUtil.extractCaretAndSelectionMarkers(document));
    }
  }
.execute().getResultObject();
  assertEquals(document.getCharsSequence().toString(),editor.getDocument().getText());
  EditorTestUtil.verifyCaretAndSelectionState(editor,caretAndSelectionState);
}
