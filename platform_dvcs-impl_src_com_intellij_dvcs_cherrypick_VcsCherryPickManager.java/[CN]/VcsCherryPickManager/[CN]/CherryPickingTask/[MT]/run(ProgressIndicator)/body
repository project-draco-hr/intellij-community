{
  try {
    boolean isOk=true;
    MultiMap<VcsCherryPicker,VcsFullCommitDetails> groupedCommits=createArrayMultiMap();
    for (    VcsFullCommitDetails details : myAllCommits) {
      VcsCherryPicker cherryPicker=getCherryPickerOrReportError(details);
      if (cherryPicker == null) {
        isOk=false;
        break;
      }
      groupedCommits.putValue(cherryPicker,details);
    }
    if (isOk) {
      for (      Map.Entry<VcsCherryPicker,Collection<VcsFullCommitDetails>> entry : groupedCommits.entrySet()) {
        List<VcsFullCommitDetails> commits=Lists.reverse(Lists.newArrayList(entry.getValue()));
        entry.getKey().cherryPick(commits);
      }
    }
  }
  finally {
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      public void run(){
        myChangeListManager.unblockModalNotifications();
        for (        VcsFullCommitDetails details : myAllCommits) {
          myIdsInProgress.remove(new CommitId(details.getId(),details.getRoot()));
        }
      }
    }
);
  }
}
