{
  final Set<FileType> usedFileTypes=new HashSet<FileType>();
  final FileTypeManager fileTypeManager=FileTypeManager.getInstance();
  if (fileTypeManager == null) {
    throw new CollectUsagesException("Cannot get instance of FileTypeManager");
  }
  final FileType[] registeredFileTypes=fileTypeManager.getRegisteredFileTypes();
  for (  final FileType fileType : registeredFileTypes) {
    if (project.isDisposed()) {
      throw new CollectUsagesException("Project is disposed");
    }
    VirtualFile ideaDir=project.getBaseDir().findChild(Project.DIRECTORY_STORE_FOLDER);
    final String ideaDirPath=ideaDir == null ? null : ideaDir.getPath();
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      @Override public void run(){
        FileBasedIndex.getInstance().processValues(FileTypeIndex.NAME,fileType,null,new FileBasedIndex.ValueProcessor<Void>(){
          @Override public boolean process(          VirtualFile file,          Void value){
            if (ideaDirPath == null || !file.getPath().startsWith(ideaDirPath)) {
              usedFileTypes.add(fileType);
              return false;
            }
            return true;
          }
        }
,GlobalSearchScope.projectScope(project));
      }
    }
);
  }
  return ContainerUtil.map2Set(usedFileTypes,new NotNullFunction<FileType,UsageDescriptor>(){
    @NotNull @Override public UsageDescriptor fun(    FileType fileType){
      return new UsageDescriptor(fileType.getName(),1);
    }
  }
);
}
