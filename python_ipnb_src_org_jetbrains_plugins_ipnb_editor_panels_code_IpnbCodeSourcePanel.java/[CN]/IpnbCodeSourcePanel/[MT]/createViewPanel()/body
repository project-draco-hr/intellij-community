{
  final JPanel panel=new JPanel(new BorderLayout());
  panel.setBackground(UIUtil.isUnderDarcula() ? IpnbEditorUtil.getBackground() : Gray._247);
  if (mySource.startsWith("%")) {
    myEditor=IpnbEditorUtil.createPlainCodeEditor(myProject,mySource);
  }
 else {
    myEditor=IpnbEditorUtil.createPythonCodeEditor(myProject,this);
  }
  Disposer.register(myParent.getFileEditor(),new Disposable(){
    @Override public void dispose(){
      EditorFactory.getInstance().releaseEditor(myEditor);
    }
  }
);
  final JComponent component=myEditor.getComponent();
  final JComponent contentComponent=myEditor.getContentComponent();
  new IpnbRunCellAction().registerCustomShortcutSet(new CustomShortcutSet(KeyStroke.getKeyStroke("shift ENTER")),contentComponent);
  new IpnbRunCellInplaceAction().registerCustomShortcutSet(new CustomShortcutSet(KeyStroke.getKeyStroke("ctrl ENTER")),contentComponent);
  contentComponent.addKeyListener(new KeyAdapter(){
    @Override public void keyReleased(    KeyEvent e){
      final int keyCode=e.getKeyCode();
      final Container parent=myParent.getParent();
      final int height=myEditor.getLineHeight() * Math.max(myEditor.getDocument().getLineCount(),1) + 10;
      contentComponent.setPreferredSize(new Dimension(parent.getWidth() - 300,height));
      panel.setPreferredSize(new Dimension(parent.getWidth() - 300,height));
      myParent.revalidate();
      myParent.repaint();
      panel.revalidate();
      panel.repaint();
      if (parent instanceof IpnbFilePanel) {
        IpnbFilePanel ipnbFilePanel=(IpnbFilePanel)parent;
        ipnbFilePanel.revalidate();
        ipnbFilePanel.repaint();
        if (keyCode == KeyEvent.VK_ESCAPE) {
          getIpnbCodePanel().setEditing(false);
          UIUtil.requestFocus(getIpnbCodePanel().getFileEditor().getIpnbFilePanel());
        }
 else         if (keyCode == KeyEvent.VK_ENTER && InputEvent.CTRL_MASK == e.getModifiers()) {
          IpnbRunCellBaseAction.runCell(ipnbFilePanel,false);
        }
 else         if (keyCode == KeyEvent.VK_ENTER && InputEvent.SHIFT_DOWN_MASK == e.getModifiersEx()) {
          IpnbRunCellBaseAction.runCell(ipnbFilePanel,true);
        }
      }
    }
  }
);
  contentComponent.addMouseListener(new MouseAdapter(){
    @Override public void mouseClicked(    MouseEvent e){
      if (InputEvent.CTRL_DOWN_MASK == e.getModifiersEx())       return;
      final Container ipnbFilePanel=myParent.getParent();
      if (ipnbFilePanel instanceof IpnbFilePanel) {
        ((IpnbFilePanel)ipnbFilePanel).setSelectedCell(myParent);
        myParent.switchToEditing();
      }
      UIUtil.requestFocus(contentComponent);
    }
  }
);
  panel.add(component);
  contentComponent.addHierarchyListener(new HierarchyListener(){
    @Override public void hierarchyChanged(    HierarchyEvent e){
      final Container parent=myParent.getParent();
      if (parent != null) {
        final int height=myEditor.getLineHeight() * Math.max(myEditor.getDocument().getLineCount(),1) + 10;
        contentComponent.setPreferredSize(new Dimension(parent.getWidth() - 300,height));
        panel.setPreferredSize(new Dimension(parent.getWidth() - 300,height));
      }
    }
  }
);
  contentComponent.addHierarchyBoundsListener(new HierarchyBoundsAdapter(){
    @Override public void ancestorResized(    HierarchyEvent e){
      final Container parent=myParent.getParent();
      final Component component=e.getChanged();
      if (parent != null && component instanceof IpnbFilePanel) {
        final int height=myEditor.getLineHeight() * Math.max(myEditor.getDocument().getLineCount(),1) + 10;
        contentComponent.setPreferredSize(new Dimension(parent.getWidth() - 300,height));
        panel.setPreferredSize(new Dimension(parent.getWidth() - 300,height));
        panel.revalidate();
        panel.repaint();
        parent.repaint();
      }
    }
  }
);
  return panel;
}
