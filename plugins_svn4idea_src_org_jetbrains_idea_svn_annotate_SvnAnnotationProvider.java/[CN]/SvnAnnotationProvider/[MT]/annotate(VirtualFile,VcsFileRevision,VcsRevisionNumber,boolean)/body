{
  if (file.isDirectory()) {
    throw new VcsException(SvnBundle.message("exception.text.cannot.annotate.directory"));
  }
  final FileAnnotation[] annotation=new FileAnnotation[1];
  final VcsException[] exception=new VcsException[1];
  Runnable command=new Runnable(){
    public void run(){
      final ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
      final File ioFile=new File(file.getPath()).getAbsoluteFile();
      SVNInfo info=null;
      try {
        final String contents;
        if (loadExternally) {
          byte[] data=SvnUtil.getFileContents(myVcs,SvnTarget.fromFile(ioFile),SVNRevision.BASE,SVNRevision.UNDEFINED);
          contents=LoadTextUtil.getTextByBinaryPresentation(data,file,false,false).toString();
        }
 else {
          final byte[] bytes=VcsHistoryUtil.loadRevisionContent(revision);
          contents=LoadTextUtil.getTextByBinaryPresentation(bytes,file,false,false).toString();
        }
        final SvnFileAnnotation result=new SvnFileAnnotation(myVcs,file,contents,lastChangedRevision);
        info=myVcs.getInfo(ioFile);
        if (info == null) {
          exception[0]=new VcsException(new SVNException(SVNErrorMessage.create(SVNErrorCode.UNKNOWN,"File ''{0}'' is not under version control",ioFile)));
          return;
        }
        final String url=info.getURL() == null ? null : info.getURL().toString();
        SVNRevision endRevision=((SvnFileRevision)revision).getRevision();
        if (SVNRevision.WORKING.equals(endRevision)) {
          endRevision=info.getRevision();
        }
        if (progress != null) {
          progress.setText(SvnBundle.message("progress.text.computing.annotation",file.getName()));
        }
        final ISVNAnnotateHandler annotateHandler=createAnnotationHandler(progress,result);
        final boolean calculateMergeinfo=SvnConfiguration.getInstance(myVcs.getProject()).isShowMergeSourcesInAnnotate() && SvnUtil.checkRepositoryVersion15(myVcs,url);
        final MySteppedLogGetter logGetter=new MySteppedLogGetter(myVcs,ioFile,progress,myVcs.getFactory(ioFile).createHistoryClient(),endRevision,result,url,calculateMergeinfo,file.getCharset());
        logGetter.go();
        final LinkedList<SVNRevision> rp=logGetter.getRevisionPoints();
        AnnotateClient annotateClient=myVcs.getFactory(ioFile).createAnnotateClient();
        for (int i=0; i < rp.size() - 1; i++) {
          annotateClient.annotate(SvnTarget.fromFile(ioFile),rp.get(i + 1),rp.get(i),((SvnFileRevision)revision).getPegRevision(),calculateMergeinfo,getLogClientOptions(myVcs),annotateHandler);
        }
        if (rp.get(1).getNumber() > 0) {
          result.setFirstRevision(rp.get(1));
        }
        annotation[0]=result;
      }
 catch (      IOException e) {
        exception[0]=new VcsException(e);
      }
catch (      VcsException e) {
        if (e.getCause() instanceof SVNException) {
          handleSvnException(ioFile,info,(SVNException)e.getCause(),file,revision,annotation,exception);
        }
 else {
          exception[0]=e;
        }
      }
    }
  }
;
  if (ApplicationManager.getApplication().isDispatchThread()) {
    ProgressManager.getInstance().runProcessWithProgressSynchronously(command,SvnBundle.message("action.text.annotate"),false,myVcs.getProject());
  }
 else {
    command.run();
  }
  if (exception[0] != null) {
    throw new VcsException(exception[0]);
  }
  return annotation[0];
}
