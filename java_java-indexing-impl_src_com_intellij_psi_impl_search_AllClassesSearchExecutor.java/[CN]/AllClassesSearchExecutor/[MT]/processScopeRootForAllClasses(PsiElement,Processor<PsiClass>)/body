{
  final boolean[] stopped={false};
  final JavaElementVisitor visitor=scopeRoot instanceof PsiCompiledElement ? new JavaRecursiveElementVisitor(){
    @Override public void visitElement(    PsiElement element){
      if (!stopped[0]) {
        super.visitElement(element);
      }
    }
    @Override public void visitClass(    PsiClass aClass){
      stopped[0]=!processor.process(aClass);
      super.visitClass(aClass);
    }
  }
 : new JavaRecursiveElementWalkingVisitor(){
    @Override public void visitElement(    PsiElement element){
      if (!stopped[0]) {
        super.visitElement(element);
      }
    }
    @Override public void visitClass(    PsiClass aClass){
      stopped[0]=!processor.process(aClass);
      super.visitClass(aClass);
    }
  }
;
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    @Override public void run(){
      scopeRoot.accept(visitor);
    }
  }
);
  return !stopped[0];
}
