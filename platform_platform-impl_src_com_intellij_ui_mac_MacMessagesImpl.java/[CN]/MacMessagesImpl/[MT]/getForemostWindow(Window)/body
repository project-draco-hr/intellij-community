{
  Window _window=null;
  Component focusOwner=IdeFocusManager.findInstance().getFocusOwner();
  if (focusOwner != null) {
    _window=SwingUtilities.getWindowAncestor(focusOwner);
  }
  if (_window == null && window != null) {
    focusOwner=window.getMostRecentFocusOwner();
    if (focusOwner != null) {
      _window=SwingUtilities.getWindowAncestor(focusOwner);
    }
  }
  if (_window == null) {
    focusOwner=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusedWindow();
    if (focusOwner != null) {
      _window=SwingUtilities.getWindowAncestor(focusOwner);
    }
  }
  if (_window == null) {
    _window=WindowManager.getInstance().findVisibleFrame();
  }
  return _window;
}
