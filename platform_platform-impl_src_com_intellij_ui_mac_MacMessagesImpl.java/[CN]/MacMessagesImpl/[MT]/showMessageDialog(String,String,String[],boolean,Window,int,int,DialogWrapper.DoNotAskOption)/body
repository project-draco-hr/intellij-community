{
  Window foremostWindow=getForemostWindow(window);
  String foremostWindowTitle=getWindowTitle(foremostWindow);
  Window documentRoot=getDocumentRootFromWindow(foremostWindow);
  final ID nativeFocusedWindow=MacUtil.findWindowForTitle(foremostWindowTitle);
  if (foremostWindow != null) {
    final FocusTrackback[] focusTrackback={new FocusTrackback(new Object(),documentRoot,true)};
    final ID delegate=invoke(Foundation.getObjcClass("NSAlertDelegate_"),"new");
    invoke(delegate,"autorelease");
    cfRetain(delegate);
    final ID buttonsArray=invoke("NSMutableArray","array");
    for (    String s : buttons) {
      ID s1=nsString(UIUtil.removeMnemonic(s));
      invoke(buttonsArray,"addObject:",s1);
      cfRelease(s1);
    }
    final ID paramsArray=invoke("NSArray","arrayWithObjects:",nsString(title),nsString(StringUtil.stripHtml(message == null ? "" : message,true).replace("%","%%")),nativeFocusedWindow,nsString(""),nsString(errorStyle ? "error" : "-1"),nsString(doNotAskDialogOption == null || !doNotAskDialogOption.canBeHidden() ? "-1" : doNotAskDialogOption.getDoNotShowMessage()),nsString(Integer.toString(defaultOptionIndex)),nsString(Integer.toString(focusedOptionIndex)),buttonsArray,nsString(doNotAskDialogOption != null && !doNotAskDialogOption.isToBeShown() ? "checked" : "-1"),null);
    IdeFocusManager.getGlobalInstance().setTypeaheadEnabled(false);
    runOrPostponeForWindow(documentRoot,new Runnable(){
      @Override public void run(){
        invoke(delegate,"performSelectorOnMainThread:withObject:waitUntilDone:",createSelector("showVariableButtonsSheet:"),paramsArray,false);
      }
    }
);
    startModal(documentRoot,nativeFocusedWindow);
    IdeFocusManager.getGlobalInstance().setTypeaheadEnabled(true);
    if (focusTrackback[0] != null && !(focusTrackback[0].isSheduledForRestore() || focusTrackback[0].isWillBeSheduledForRestore())) {
      focusTrackback[0].setWillBeSheduledForRestore();
      IdeFocusManager mgr=IdeFocusManager.findInstanceByComponent(documentRoot);
      Runnable r=new Runnable(){
        public void run(){
          if (focusTrackback[0] != null)           focusTrackback[0].restoreFocus();
          focusTrackback[0]=null;
        }
      }
;
      mgr.doWhenFocusSettlesDown(r);
    }
    return convertReturnCodeFromNativeMessageDialog(documentRoot);
  }
  return -1;
}
