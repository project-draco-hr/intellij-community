{
  PsiExpressionCodeFragment fragment=JavaCodeFragmentFactory.getInstance(myProject).createExpressionCodeFragment("a",null,null,true);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      Document document=PsiDocumentManager.getInstance(myProject).getDocument(fragment);
      document.insertString(1,"b");
      PsiDocumentManager.getInstance(myProject).commitAllDocuments();
      assertEquals("ab",fragment.getText());
      assertEquals("ab",fragment.getExpression().getText());
      document=null;
    }
  }
);
  PlatformTestUtil.tryGcSoftlyReachableObjects();
  assertEquals("ab",PsiDocumentManager.getInstance(myProject).getDocument(fragment).getText());
}
