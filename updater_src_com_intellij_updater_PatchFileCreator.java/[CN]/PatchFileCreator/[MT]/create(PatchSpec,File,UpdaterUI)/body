{
  Patch patchInfo=new Patch(spec,ui);
  Runner.logger.info("Creating the patch file '" + patchFile + "'...");
  ui.startProcess("Creating the patch file '" + patchFile + "'...");
  ui.checkCancelled();
  ZipOutputStream out=new ZipOutputStream(new FileOutputStream(patchFile));
  try {
    out.setLevel(9);
    out.putNextEntry(new ZipEntry(PATCH_INFO_FILE_NAME));
    patchInfo.write(out);
    out.closeEntry();
    File olderDir=new File(spec.getOldFolder());
    File newerDir=new File(spec.getNewFolder());
    List<PatchAction> actions=patchInfo.getActions();
    for (    PatchAction each : actions) {
      Runner.logger.info("Packing " + each.getPath());
      ui.setStatus("Packing " + each.getPath());
      ui.checkCancelled();
      each.buildPatchFile(olderDir,newerDir,out);
    }
  }
  finally {
    out.close();
  }
  return patchInfo;
}
