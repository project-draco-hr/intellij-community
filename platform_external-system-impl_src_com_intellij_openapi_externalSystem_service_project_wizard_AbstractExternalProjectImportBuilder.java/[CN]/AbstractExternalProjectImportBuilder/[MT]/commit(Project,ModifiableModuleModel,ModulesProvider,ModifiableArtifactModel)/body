{
  project.putUserData(ExternalSystemDataKeys.NEWLY_IMPORTED_PROJECT,Boolean.TRUE);
  final DataNode<ProjectData> externalProjectNode=getExternalProjectNode();
  if (externalProjectNode != null) {
    beforeCommit(externalProjectNode,project);
  }
  final boolean isFromUI=model != null;
  final List<Module> modules=ContainerUtil.newSmartList();
  final IdeModifiableModelsProvider modelsProvider=isFromUI ? new IdeUIModifiableModelsProvider(project,model,(ModulesConfigurator)modulesProvider,artifactModel){
    @NotNull @Override public Module newModule(    @NotNull @NonNls String filePath,    String moduleTypeId){
      final Module module=super.newModule(filePath,moduleTypeId);
      modules.add(module);
      return module;
    }
  }
 : new IdeModifiableModelsProviderImpl(project);
  AbstractExternalSystemSettings systemSettings=ExternalSystemApiUtil.getSettings(project,myExternalSystemId);
  final ExternalProjectSettings projectSettings=getCurrentExternalProjectSettings();
  Set<ExternalProjectSettings> projects=ContainerUtilRt.newHashSet(systemSettings.getLinkedProjectsSettings());
  projects.remove(projectSettings);
  projects.add(projectSettings);
  systemSettings.copyFrom(myControl.getSystemSettings());
  systemSettings.setLinkedProjectsSettings(projects);
  if (externalProjectNode != null) {
    if (!ApplicationManager.getApplication().isHeadlessEnvironment()) {
      ExternalProjectDataSelectorDialog dialog=new ExternalProjectDataSelectorDialog(project,new InternalExternalProjectInfo(myExternalSystemId,projectSettings.getExternalProjectPath(),externalProjectNode));
      if (dialog.hasMultipleDataToSelect()) {
        dialog.showAndGet();
      }
 else {
        dialog.dispose();
      }
    }
    if (!project.isInitialized()) {
      StartupManager.getInstance(project).runWhenProjectIsInitialized(new Runnable(){
        @Override public void run(){
          finishImport(project,externalProjectNode,isFromUI,modules,modelsProvider,projectSettings);
        }
      }
);
    }
 else     finishImport(project,externalProjectNode,isFromUI,modules,modelsProvider,projectSettings);
  }
  return modules;
}
