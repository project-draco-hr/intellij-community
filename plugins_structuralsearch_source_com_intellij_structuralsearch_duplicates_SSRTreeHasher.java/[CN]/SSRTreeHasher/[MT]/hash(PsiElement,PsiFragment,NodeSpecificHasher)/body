{
  final PsiElement element=SkippingHandler.getOnlyChild(root,SSRNodeSpecificHasher.getNodeFilter());
  if (element != root) {
    final TreeHashResult result=hash(element,upper,hasher);
    final int cost=hasher.getNodeCost(root);
    return new TreeHashResult(result.getHash(),result.getCost() + cost,upper);
  }
  final EquivalenceDescriptorProvider descriptorProvider=EquivalenceDescriptorProvider.getInstance(root);
  if (descriptorProvider != null) {
    final EquivalenceDescriptor descriptor=descriptorProvider.buildDescriptor(root);
    if (descriptor != null) {
      return computeHash(root,upper,descriptor,hasher);
    }
  }
  if (root instanceof PsiFile) {
    return hashCodeBlock(hasher.getNodeChildren(root),upper,hasher,true);
  }
  return computeElementHash(element,upper,hasher);
}
