{
  final EquivalenceDescriptorProvider descriptorProvider=EquivalenceDescriptorProvider.getInstance(root);
  if (descriptorProvider != null) {
    final EquivalenceDescriptor descriptor=descriptorProvider.buildDescriptor(root);
    if (descriptor != null) {
      return computeHash(root,upper,descriptor,hasher);
    }
  }
  if (root instanceof PsiFile) {
    return hashCodeBlock(hasher.getNodeChildren(root),upper,hasher,true);
  }
  final SSRNodeSpecificHasher ssrNodeSpecificHasher=(SSRNodeSpecificHasher)hasher;
  if (shouldBeAnonymized(root,ssrNodeSpecificHasher)) {
    return computeElementHash(root,upper,hasher);
  }
  final PsiElement element=SkippingHandler.getOnlyChild(root,ssrNodeSpecificHasher.getNodeFilter());
  if (element != root) {
    final TreeHashResult result=hash(element,upper,hasher);
    final int cost=hasher.getNodeCost(root);
    return new TreeHashResult(result.getHash(),result.getCost() + cost,result.getFragment());
  }
  return computeElementHash(element,upper,hasher);
}
