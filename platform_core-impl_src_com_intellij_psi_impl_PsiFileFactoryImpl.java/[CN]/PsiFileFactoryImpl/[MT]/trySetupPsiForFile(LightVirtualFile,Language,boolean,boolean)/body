{
  final FileViewProviderFactory factory=LanguageFileViewProviders.INSTANCE.forLanguage(language);
  FileViewProvider viewProvider=factory != null ? factory.createFileViewProvider(virtualFile,language,myManager,physical) : null;
  if (viewProvider == null)   viewProvider=new SingleRootFileViewProvider(myManager,virtualFile,physical);
  language=viewProvider.getBaseLanguage();
  final ParserDefinition parserDefinition=LanguageParserDefinitions.INSTANCE.forLanguage(language);
  if (parserDefinition != null) {
    final PsiFile psiFile=viewProvider.getPsi(language);
    if (psiFile != null) {
      if (markAsCopy) {
        if (psiFile.getNode() == null) {
          throw new AssertionError("No node for file " + psiFile + "; language="+ language);
        }
        markGenerated(psiFile);
      }
      return psiFile;
    }
  }
  return null;
}
