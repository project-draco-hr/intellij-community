{
  String expectedTitle=ExecutionBundle.message("diff.content.expected.title");
  final DiffContent expectedContent;
  final VirtualFile vFile;
  if (filePath != null && (vFile=LocalFileSystem.getInstance().findFileByPath(filePath)) != null) {
    expectedContent=DiffContent.fromFile(project,vFile);
    expectedTitle+=" (" + vFile.getPresentableUrl() + ")";
  }
 else {
    expectedContent=new SimpleContent(expected);
  }
  final SimpleDiffRequest diffData=new SimpleDiffRequest(project,getTitle());
  if (chain != null) {
    diffData.setToolbarAddons(new DiffRequest.ToolbarAddons(){
      @Override public void customize(      DiffToolbar toolbar){
        toolbar.addAction(new NextPrevAction("Compare Previous Failure",AllIcons.Actions.Prevfile,chain){
{
            registerCustomShortcutSet(ActionManager.getInstance().getAction("PreviousTab").getShortcutSet(),null);
          }
          @Override protected DiffHyperlink getNextId(){
            return chain.getPrevious();
          }
        }
);
        toolbar.addAction(new NextPrevAction("Compare Next Failure",AllIcons.Actions.Nextfile,chain){
{
            registerCustomShortcutSet(ActionManager.getInstance().getAction("NextTab").getShortcutSet(),null);
          }
          @Override protected DiffHyperlink getNextId(){
            return chain.getNext();
          }
        }
);
      }
    }
);
  }
  diffData.setContents(expectedContent,new SimpleContent(actual));
  diffData.setContentTitles(expectedTitle,ExecutionBundle.message("diff.content.actual.title"));
  diffData.addHint(DiffTool.HINT_SHOW_FRAME);
  diffData.addHint(DiffTool.HINT_DO_NOT_IGNORE_WHITESPACES);
  diffData.setGroupKey("#com.intellij.execution.junit2.states.ComparisonFailureState$DiffDialog");
  return diffData;
}
