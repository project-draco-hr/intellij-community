{
  final PsiElement element=descriptor.getPsiElement();
  final PsiElement parent=element.getParent();
  if (!(parent instanceof PsiTryStatement)) {
    return;
  }
  final PsiTryStatement tryStatement=(PsiTryStatement)parent;
  final PsiCodeBlock tryBlock=tryStatement.getTryBlock();
  if (tryBlock == null) {
    return;
  }
  final PsiCodeBlock finallyBlock=tryStatement.getFinallyBlock();
  if (finallyBlock == null) {
    return;
  }
  final PsiElement[] tryBlockChildren=tryBlock.getChildren();
  final Set<PsiLocalVariable> variables=new LinkedHashSet<PsiLocalVariable>();
  for (  final PsiLocalVariable variable : collectVariables(tryStatement)) {
    if (!isVariableUsedOutsideContext(variable,tryBlock)) {
      variables.add(variable);
    }
  }
  final PsiElementFactory factory=JavaPsiFacade.getElementFactory(project);
  @NonNls final StringBuilder newTryStatementText=new StringBuilder("try (");
  final Set<Integer> unwantedChildren=new HashSet<Integer>(2);
  boolean separator=false;
  for (  final PsiLocalVariable variable : variables) {
    final boolean hasInitializer;
    final PsiExpression initializer=variable.getInitializer();
    if (initializer == null) {
      hasInitializer=false;
    }
 else {
      final PsiType type=initializer.getType();
      hasInitializer=!PsiType.NULL.equals(type);
    }
    if (separator) {
      newTryStatementText.append(';');
    }
    newTryStatementText.append(variable.getTypeElement().getText()).append(' ').append(variable.getName()).append('=');
    if (hasInitializer) {
      newTryStatementText.append(initializer.getText());
    }
 else {
      final int index=findInitialization(tryBlockChildren,variable,false);
      if (index < 0) {
        return;
      }
      unwantedChildren.add(index);
      final PsiExpressionStatement expressionStatement=(PsiExpressionStatement)tryBlockChildren[index];
      if (expressionStatement.getNextSibling() instanceof PsiWhiteSpace) {
        unwantedChildren.add(index + 1);
      }
      final PsiAssignmentExpression assignmentExpression=(PsiAssignmentExpression)expressionStatement.getExpression();
      final PsiExpression rhs=assignmentExpression.getRExpression();
      if (rhs == null) {
        return;
      }
      newTryStatementText.append(rhs.getText());
    }
    separator=true;
  }
  int j=1;
  while (!unwantedChildren.contains(Integer.valueOf(j)) && j < tryBlockChildren.length - 1) {
    tryStatement.getParent().addBefore(tryBlockChildren[j],tryStatement);
    unwantedChildren.add(j);
    j++;
  }
  newTryStatementText.append(") {");
  final int tryBlockStatementsLength=tryBlockChildren.length - 1;
  for (int i=1; i < tryBlockStatementsLength; i++) {
    final PsiElement child=tryBlockChildren[i];
    if (unwantedChildren.contains(Integer.valueOf(i))) {
      continue;
    }
    newTryStatementText.append(child.getText());
  }
  newTryStatementText.append('}');
  final PsiCatchSection[] catchSections=tryStatement.getCatchSections();
  for (  final PsiCatchSection catchSection : catchSections) {
    newTryStatementText.append(catchSection.getText());
  }
  final PsiElement[] finallyChildren=finallyBlock.getChildren();
  boolean appended=false;
  final int finallyChildrenLength=finallyChildren.length - 1;
  final List<PsiElement> savedComments=new ArrayList<PsiElement>();
  for (int i=1; i < finallyChildrenLength; i++) {
    final PsiElement child=finallyChildren[i];
    if (isCloseStatement(child,variables)) {
      continue;
    }
    if (!appended) {
      if (child instanceof PsiComment) {
        final PsiComment comment=(PsiComment)child;
        final PsiElement prevSibling=child.getPrevSibling();
        if (prevSibling instanceof PsiWhiteSpace && savedComments.isEmpty()) {
          savedComments.add(prevSibling);
        }
        savedComments.add(comment);
        final PsiElement nextSibling=child.getNextSibling();
        if (nextSibling instanceof PsiWhiteSpace) {
          savedComments.add(nextSibling);
        }
      }
 else       if (!(child instanceof PsiWhiteSpace)) {
        newTryStatementText.append(" finally {");
        for (        final PsiElement savedComment : savedComments) {
          newTryStatementText.append(savedComment.getText());
        }
        newTryStatementText.append(child.getText());
        appended=true;
      }
    }
 else {
      newTryStatementText.append(child.getText());
    }
  }
  if (appended) {
    newTryStatementText.append('}');
  }
  for (  final PsiLocalVariable variable : variables) {
    variable.delete();
  }
  if (!appended) {
    final int savedCommentsSize=savedComments.size();
    final PsiElement parent1=tryStatement.getParent();
    for (int i=savedCommentsSize - 1; i >= 0; i--) {
      final PsiElement savedComment=savedComments.get(i);
      parent1.addAfter(savedComment,tryStatement);
    }
  }
  final PsiStatement newTryStatement=factory.createStatementFromText(newTryStatementText.toString(),element);
  tryStatement.replace(newTryStatement);
}
