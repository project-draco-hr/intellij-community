{
  if (myScopeToAverageSeverityMap.isEmpty()) {
    return null;
  }
  final Map<String,HighlightSeverity> result=new HashMap<String,HighlightSeverity>();
  final Map.Entry<String,SeverityAndOccurrences> entry=ContainerUtil.getFirstItem(myScopeToAverageSeverityMap.entrySet());
  result.put(entry.getKey(),entry.getValue().getPrimarySeverity());
  if (myScopeToAverageSeverityMap.size() == 1) {
    return result;
  }
  String[] scopesOrder=inspectionProfile.getScopesOrder();
  if (scopesOrder == null || scopesOrder.length == 0) {
    final ArrayList<String> scopesList=new ArrayList<String>(myScopeToAverageSeverityMap.keySet());
    scopesList.remove(myDefaultScopeName);
    ContainerUtil.sort(scopesList);
    scopesOrder=ArrayUtil.toStringArray(scopesList);
  }
  final SeverityAndOccurrences defaultSeveritiesAndOccurrences=myScopeToAverageSeverityMap.get(myDefaultScopeName);
  final int allInspectionsCount=defaultSeveritiesAndOccurrences.getOccurrencesSize();
  final Map<String,HighlightSeverity> allScopes=defaultSeveritiesAndOccurrences.getOccurrences();
  String[] reversedScopesOrder=ArrayUtil.reverseArray(scopesOrder);
  for (  String currentScope : reversedScopesOrder) {
    final SeverityAndOccurrences currentSeverityAndOccurrences=myScopeToAverageSeverityMap.get(currentScope);
    if (currentSeverityAndOccurrences == null) {
      continue;
    }
    final HighlightSeverity currentSeverity=currentSeverityAndOccurrences.getPrimarySeverity();
    if (currentSeverity == ScopesAndSeveritiesTable.MIXED_FAKE_SEVERITY || currentSeverityAndOccurrences.getOccurrencesSize() == allInspectionsCount) {
      result.put(currentScope,currentSeverity);
    }
 else {
      Set<String> toolsToCheck=ContainerUtil.newHashSet(allScopes.keySet());
      toolsToCheck.removeAll(currentSeverityAndOccurrences.getOccurrences().keySet());
      boolean doContinue=false;
      final Map<String,HighlightSeverity> lowerScopeOccurrences=myScopeToAverageSeverityMap.get(myDefaultScopeName).getOccurrences();
      for (      String toolName : toolsToCheck) {
        final HighlightSeverity currentToolSeverity=lowerScopeOccurrences.get(toolName);
        if (currentToolSeverity != null) {
          if (!currentSeverity.equals(currentToolSeverity)) {
            result.put(currentScope,ScopesAndSeveritiesTable.MIXED_FAKE_SEVERITY);
            doContinue=true;
            break;
          }
        }
      }
      if (doContinue) {
        continue;
      }
      result.put(currentScope,currentSeverity);
    }
  }
  return result;
}
