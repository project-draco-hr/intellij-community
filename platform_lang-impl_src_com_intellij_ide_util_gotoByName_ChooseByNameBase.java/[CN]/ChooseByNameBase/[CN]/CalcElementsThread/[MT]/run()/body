{
  showCard(SEARCHING_CARD,200);
  ProgressManager.getInstance().runProcess(new Runnable(){
    @Override public void run(){
      final Set<Object> elements=new LinkedHashSet<Object>();
      Runnable calculation=new Runnable(){
        public void run(){
          ApplicationManager.getApplication().runReadAction(new Runnable(){
            @Override public void run(){
              try {
                boolean everywhere=myCheckboxState;
                if (!ourLoadNamesEachTime)                 ensureNamesLoaded(everywhere);
                addElementsByPattern(myPattern,elements,myCancelled,everywhere);
              }
 catch (              ProcessCanceledException e) {
              }
            }
          }
);
        }
      }
;
      calculation.run();
      if (myCancelled.isCanceled()) {
        myShowCardAlarm.cancelAllRequests();
        return;
      }
      if (elements.isEmpty() && !myCheckboxState) {
        myScopeExpanded=true;
        myCheckboxState=true;
        calculation.run();
      }
      final String cardToShow=elements.isEmpty() ? NOT_FOUND_CARD : myScopeExpanded ? NOT_FOUND_IN_PROJECT_CARD : CHECK_BOX_CARD;
      showCard(cardToShow,0);
      final Set<Object> filtered=filter(elements);
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          if (!myCancelled.isCanceled()) {
            myCallback.consume(filtered);
          }
        }
      }
,myModalityState);
    }
  }
,myCancelled);
}
