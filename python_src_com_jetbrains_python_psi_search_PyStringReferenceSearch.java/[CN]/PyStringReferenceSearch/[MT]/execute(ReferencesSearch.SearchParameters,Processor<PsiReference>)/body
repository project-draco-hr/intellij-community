{
  final PsiElement element=params.getElementToSearch();
  if (!(element instanceof PyElement) && !(element instanceof PsiDirectory)) {
    return true;
  }
  final String name=ApplicationManager.getApplication().runReadAction(new Computable<String>(){
    public String compute(){
      if (element instanceof PyFile) {
        return FileUtil.getNameWithoutExtension(((PyFile)element).getName());
      }
 else       if (element instanceof PsiDirectory) {
        return ((PsiDirectory)element).getName();
      }
 else {
        return ((PyElement)element).getName();
      }
    }
  }
);
  if (StringUtil.isEmpty(name)) {
    return true;
  }
  SearchScope searchScope=params.getEffectiveSearchScope();
  if (searchScope instanceof GlobalSearchScope) {
    searchScope=GlobalSearchScope.getScopeRestrictedByFileTypes((GlobalSearchScope)searchScope,PythonFileType.INSTANCE);
  }
  final TextOccurenceProcessor processor=new TextOccurenceProcessor(){
    public boolean execute(    PsiElement e,    int offsetInElement){
      final PsiReference[] refs=e.getReferences();
      for (      PsiReference ref : refs) {
        if (ref.isReferenceTo(element)) {
          return consumer.process(ref);
        }
      }
      return true;
    }
  }
;
  return PsiManager.getInstance(element.getProject()).getSearchHelper().processElementsWithWord(processor,searchScope,name,UsageSearchContext.IN_STRINGS,true);
}
