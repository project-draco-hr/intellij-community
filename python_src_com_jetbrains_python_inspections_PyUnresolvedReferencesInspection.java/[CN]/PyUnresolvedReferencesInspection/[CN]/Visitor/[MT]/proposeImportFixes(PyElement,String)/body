{
  PsiFile exisitng_import_file=null;
  ImportFromExistingFix fix=null;
  Collection<LocalQuickFix> fixes=new HashSet<LocalQuickFix>(2);
  Set<String> seen_file_names=new HashSet<String>();
  CollectProcessor import_prc=new CollectProcessor(IS_IMPORT_STATEMENT);
  PyResolveUtil.treeCrawlUp(import_prc,node);
  List<PsiElement> result=import_prc.getResult();
  if (result.size() > 0) {
    fix=new ImportFromExistingFix(node,ref_text,true);
    for (    PsiElement stmt : import_prc.getResult()) {
      for (      PyImportElement ielt : ((PyImportStatement)stmt).getImportElements()) {
        final PyReferenceExpression src=ielt.getImportReference();
        if (src != null) {
          PsiElement dst=src.getReference().resolve();
          if (dst instanceof PyFile) {
            PyFile dst_file=(PyFile)dst;
            String name=ielt.getImportReference().getReferencedName();
            seen_file_names.add(name);
            PsiElement res=(dst_file).findExportedName(ref_text);
            if (res != null) {
              exisitng_import_file=dst_file;
              fix.addImport(res,dst_file,ielt);
              fixes.add(fix);
            }
          }
        }
      }
    }
  }
  CollectProcessor from_import_prc=new CollectProcessor(IS_FROM_IMPORT_STATEMENT);
  PyResolveUtil.treeCrawlUp(from_import_prc,node);
  result=from_import_prc.getResult();
  if (result.size() > 0) {
    if (fix == null)     fix=new ImportFromExistingFix(node,ref_text,false);
    for (    PsiElement stmt : from_import_prc.getResult()) {
      PyFromImportStatement from_stmt=(PyFromImportStatement)stmt;
      PyImportElement[] ielts=from_stmt.getImportElements();
      if (ielts != null && ielts.length > 0) {
        final PyReferenceExpression src=from_stmt.getImportSource();
        if (src != null) {
          PsiElement dst=src.getReference().resolve();
          if (dst instanceof PyFile) {
            PyFile dst_file=(PyFile)dst;
            String name=from_stmt.getImportSource().getReferencedName();
            seen_file_names.add(name);
            PsiElement res=(dst_file).findExportedName(ref_text);
            if (res != null) {
              exisitng_import_file=dst_file;
              fix.addImport(res,dst_file,ielts[ielts.length - 1]);
              fixes.add(fix);
            }
          }
        }
      }
    }
  }
  ProgressManager.checkCanceled();
  Project project=node.getProject();
  GlobalSearchScope scope=ProjectScope.getAllScope(project);
  List<PsiElement> symbols=new ArrayList<PsiElement>();
  symbols.addAll(PyClassNameIndex.find(ref_text,project,scope));
  symbols.addAll(StubIndex.getInstance().get(PyFunctionNameIndex.KEY,ref_text,project,scope));
  if (symbols.size() > 0) {
    if (fix == null) {
      fix=new ImportFromExistingFix(node,ref_text,!PyCodeInsightSettings.getInstance().PREFER_FROM_IMPORT);
    }
    for (    PsiElement symbol : symbols) {
      if (symbol.getParent() instanceof PsiFile) {
        PsiFile srcfile=symbol.getContainingFile();
        if (srcfile != null && srcfile != exisitng_import_file) {
          VirtualFile vfile=srcfile.getVirtualFile();
          if (vfile != null) {
            String import_path=ResolveImportUtil.findShortestImportableName(node,vfile);
            if (import_path != null && !seen_file_names.contains(import_path)) {
              fix.addImport(symbol,srcfile,null,import_path,proposeAsName(node.getContainingFile(),ref_text,import_path));
              seen_file_names.add(import_path);
            }
          }
        }
      }
    }
    fix.sortCandidates();
    if (!fixes.contains(fix)) {
      fixes.add(fix);
    }
  }
  return fixes;
}
