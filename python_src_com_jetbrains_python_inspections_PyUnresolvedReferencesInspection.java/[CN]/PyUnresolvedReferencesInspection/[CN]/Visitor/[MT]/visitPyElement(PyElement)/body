{
  super.visitPyElement(node);
  for (  final PsiReference reference : node.getReferences()) {
    if (reference.isSoft())     continue;
    HighlightSeverity severity=HighlightSeverity.ERROR;
    if (reference instanceof PsiReferenceEx) {
      severity=((PsiReferenceEx)reference).getUnresolvedHighlightSeverity();
      if (severity == null)       continue;
    }
    boolean unresolved;
    if (reference instanceof PsiPolyVariantReference) {
      final PsiPolyVariantReference poly=(PsiPolyVariantReference)reference;
      unresolved=(poly.multiResolve(false).length == 0);
    }
 else {
      unresolved=(reference.resolve() == null);
    }
    if (unresolved) {
      final StringBuilder description_buf=new StringBuilder("");
      final String text=reference.getElement().getText();
      final String ref_text=reference.getRangeInElement().substring(text);
      final PsiElement ref_element=reference.getElement();
      final boolean ref_in_import=SyntaxMatchers.IN_IMPORT.search(ref_element) != null;
      List<LocalQuickFix> actions=new ArrayList<LocalQuickFix>(2);
      HintAction hint_action=null;
      if (ref_text.length() <= 0)       return;
      if (reference instanceof PyReferenceExpression) {
        PyReferenceExpression refex=(PyReferenceExpression)reference;
        String refname=refex.getReferencedName();
        if (refex.getQualifier() != null) {
          final PyClassType object_type=PyBuiltinCache.getInstance(node.getProject()).getObjectType();
          if ((object_type != null) && object_type.getPossibleInstanceMembers().contains(refname))           continue;
        }
        if (PyModuleType.getPossibleInstanceMembers().contains(refname))         continue;
        if ((PsiTreeUtil.getParentOfType(PsiTreeUtil.getParentOfType(node,PyImportElement.class),PyTryExceptStatement.class,PyIfStatement.class) != null)) {
          severity=HighlightSeverity.INFO;
          String errmsg=PyBundle.message("INSP.module.$0.not.found",ref_text);
          description_buf.append(errmsg);
        }
        if (!ref_in_import) {
          List<LocalQuickFix> import_fixes=proposeImportFixes(node,ref_text);
          if (import_fixes.size() > 0) {
            actions.addAll(import_fixes);
            Object first_action=import_fixes.get(0);
            if (first_action instanceof HintAction) {
              hint_action=((HintAction)first_action);
            }
          }
        }
      }
      if (reference instanceof PsiReferenceEx) {
        final String s=((PsiReferenceEx)reference).getUnresolvedDescription();
        if (s != null)         description_buf.append(s);
      }
      if (description_buf.length() == 0) {
        boolean marked_qualified=false;
        if (reference instanceof PyQualifiedExpression) {
          final PyExpression qexpr=((PyQualifiedExpression)reference).getQualifier();
          if (qexpr != null) {
            PyType qtype=qexpr.getType();
            if (qtype != null) {
              if (qtype instanceof PyNoneType) {
                continue;
              }
              if (qtype instanceof PyClassType) {
                PyClass cls=((PyClassType)qtype).getPyClass();
                if (cls != null) {
                  if (reference.getElement().getParent() instanceof PyCallExpression) {
                    actions.add(new AddMethodQuickFix(ref_text,cls));
                  }
 else                   actions.add(new AddFieldQuickFix(ref_text,cls));
                }
                description_buf.append(PyBundle.message("INSP.unresolved.ref.$0.for.class.$1",ref_text,qtype.getName()));
                marked_qualified=true;
              }
 else {
                description_buf.append(PyBundle.message("INSP.cannot.find.$0.in.$1",ref_text,qtype.getName()));
                marked_qualified=true;
              }
            }
          }
        }
        if (!marked_qualified) {
          description_buf.append(PyBundle.message("INSP.unresolved.ref.$0",ref_text));
          if (ref_element != null && !ref_in_import)           hint_action=new AddImportAction(reference);
        }
      }
      String description=description_buf.toString();
      ProblemHighlightType hl_type;
      if (severity == HighlightSeverity.WARNING) {
        hl_type=ProblemHighlightType.GENERIC_ERROR_OR_WARNING;
      }
 else {
        hl_type=ProblemHighlightType.LIKE_UNKNOWN_SYMBOL;
      }
      PsiElement point=node.getLastChild();
      if (point == null)       point=node;
      registerProblem(point,description,hl_type,hint_action,actions.toArray(LQF_EMPTY));
    }
  }
}
