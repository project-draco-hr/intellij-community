{
  final StringBuilder description_buf=new StringBuilder("");
  final String text=reference.getElement().getText();
  final String ref_text=reference.getRangeInElement().substring(text);
  final PsiElement ref_element=reference.getElement();
  final boolean ref_is_importable=SyntaxMatchers.IN_IMPORT.search(ref_element) == null && IN_GLOBAL.search(ref_element) == null;
  final List<LocalQuickFix> actions=new ArrayList<LocalQuickFix>(2);
  HintAction hint_action=null;
  if (ref_text.length() <= 0)   return;
  if (reference.getElement() instanceof PyReferenceExpression) {
    PyReferenceExpression refex=(PyReferenceExpression)reference.getElement();
    String refname=refex.getReferencedName();
    if (refex.getQualifier() != null) {
      final PyClassType object_type=PyBuiltinCache.getInstance(node).getObjectType();
      if ((object_type != null) && object_type.getPossibleInstanceMembers().contains(refname))       return;
    }
    if (PyModuleType.getPossibleInstanceMembers().contains(refname))     return;
    if ((PsiTreeUtil.getParentOfType(PsiTreeUtil.getParentOfType(node,PyImportElement.class),PyTryExceptStatement.class,PyIfStatement.class) != null)) {
      severity=HighlightSeverity.INFO;
      String errmsg=PyBundle.message("INSP.module.$0.not.found",ref_text);
      description_buf.append(errmsg);
    }
    if (ref_is_importable) {
      LocalQuickFix import_fix=PythonReferenceImporter.proposeImportFix(node,ref_text);
      if (import_fix != null) {
        actions.add(import_fix);
        if (import_fix instanceof HintAction) {
          hint_action=((HintAction)import_fix);
        }
      }
    }
  }
  if (reference instanceof PsiReferenceEx) {
    final String s=((PsiReferenceEx)reference).getUnresolvedDescription();
    if (s != null)     description_buf.append(s);
  }
  if (description_buf.length() == 0) {
    boolean marked_qualified=false;
    if (reference.getElement() instanceof PyQualifiedExpression) {
      final PyExpression qexpr=((PyQualifiedExpression)reference.getElement()).getQualifier();
      if (qexpr != null) {
        PyType qtype=qexpr.getType(myTypeEvalContext);
        if (qtype != null) {
          if (qtype instanceof PyNoneType || qtype instanceof PyTypeReference || (qtype instanceof PyUnionType && ((PyUnionType)qtype).isWeak())) {
            return;
          }
          if (qtype instanceof PyClassType) {
            PyClass cls=((PyClassType)qtype).getPyClass();
            if (cls != null) {
              if (overridesGetAttr(cls)) {
                return;
              }
              if (cls.findProperty(ref_text) != null) {
                return;
              }
              if (!PyBuiltinCache.getInstance(node).hasInBuiltins(cls)) {
                if (reference.getElement().getParent() instanceof PyCallExpression) {
                  actions.add(new AddMethodQuickFix(ref_text,(PyClassType)qtype));
                }
 else                 actions.add(new AddFieldQuickFix(ref_text,cls,"None"));
              }
            }
            description_buf.append(PyBundle.message("INSP.unresolved.ref.$0.for.class.$1",ref_text,qtype.getName()));
            marked_qualified=true;
          }
 else {
            description_buf.append(PyBundle.message("INSP.cannot.find.$0.in.$1",ref_text,qtype.getName()));
            marked_qualified=true;
          }
        }
      }
    }
    if (!marked_qualified) {
      description_buf.append(PyBundle.message("INSP.unresolved.ref.$0",ref_text));
      if (ref_element != null && ref_is_importable && hint_action == null) {
        final AddImportAction addImportAction=new AddImportAction(reference);
        if (addImportAction.hasSomethingToImport(ref_element.getContainingFile())) {
          actions.add(addImportAction);
        }
      }
      if (ref_text.length() > 2 && Character.isUpperCase(ref_text.charAt(0)) && !Character.isUpperCase(ref_text.charAt(1)) && PsiTreeUtil.getParentOfType(ref_element,PyImportStatement.class,PyFromImportStatement.class) == null) {
        actions.add(new CreateClassQuickFix(ref_text,reference.getElement()));
      }
    }
  }
  String description=description_buf.toString();
  ProblemHighlightType hl_type;
  if (severity == HighlightSeverity.WARNING) {
    hl_type=ProblemHighlightType.GENERIC_ERROR_OR_WARNING;
  }
 else {
    hl_type=ProblemHighlightType.LIKE_UNKNOWN_SYMBOL;
  }
  if (GenerateBinaryStubsFix.isApplicable(reference)) {
    actions.add(new GenerateBinaryStubsFix(reference));
  }
  addPluginQuickFixes(reference,actions);
  PsiElement point=node.getLastChild();
  if (point == null)   point=node;
  registerProblem(point,description,hl_type,null,actions.toArray(new LocalQuickFix[actions.size()]));
}
