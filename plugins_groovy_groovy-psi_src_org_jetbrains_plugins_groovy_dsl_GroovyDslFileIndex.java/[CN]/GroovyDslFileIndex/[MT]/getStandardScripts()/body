{
  List<Pair<File,GroovyDslExecutor>> result=derefStandardScripts();
  if (result != null) {
    return result;
  }
  final GroovyFrameworkConfigNotification[] extensions=GroovyFrameworkConfigNotification.EP_NAME.getExtensions();
  final Semaphore semaphore=new Semaphore();
  semaphore.down();
  final AtomicReference<List<Pair<File,GroovyDslExecutor>>> ref=new AtomicReference<List<Pair<File,GroovyDslExecutor>>>();
  if (ApplicationManager.getApplication().isWriteAccessAllowed()) {
    GroovyDslExecutor.getIdeaVersion();
  }
  ourPool.execute(new Runnable(){
    @SuppressWarnings("AssignmentToStaticFieldFromInstanceMethod") @Override public void run(){
      try {
        List<Pair<File,GroovyDslExecutor>> pairs=derefStandardScripts();
        if (pairs != null) {
          ref.set(pairs);
          return;
        }
        Set<Class> classes=new HashSet<Class>(ContainerUtil.map2Set(extensions,new Function<GroovyFrameworkConfigNotification,Class>(){
          @Override public Class fun(          GroovyFrameworkConfigNotification notification){
            return notification.getClass();
          }
        }
));
        classes.add(GroovyFrameworkConfigNotification.class);
        Set<File> scriptFolders=new LinkedHashSet<File>();
        for (        Class aClass : classes) {
          File jarPath=new File(PathUtil.getJarPathForClass(aClass));
          if (jarPath.isFile()) {
            jarPath=jarPath.getParentFile();
          }
          scriptFolders.add(new File(jarPath,"standardDsls"));
        }
        List<Pair<File,GroovyDslExecutor>> executors=new ArrayList<Pair<File,GroovyDslExecutor>>();
        for (        File file : scriptFolders) {
          if (file.exists()) {
            File[] children=file.listFiles();
            if (children != null) {
              for (              File child : children) {
                final String fileName=child.getName();
                if (fileName.endsWith(".gdsl")) {
                  try {
                    final String text=new String(FileUtil.loadFileText(child));
                    executors.add(Pair.create(child,new GroovyDslExecutor(text,fileName)));
                  }
 catch (                  IOException e) {
                    LOG.error("Error while parsing gdsl file " + fileName,e);
                  }
                }
              }
            }
          }
        }
        ourStandardScripts=new SoftReference<List<Pair<File,GroovyDslExecutor>>>(executors);
        ref.set(executors);
      }
 catch (      Throwable e) {
        ref.set(new ArrayList<Pair<File,GroovyDslExecutor>>());
        if (e instanceof Error) {
          GdslUtil.stopGdsl();
        }
        LOG.error(e);
      }
 finally {
        semaphore.up();
      }
    }
  }
);
  while (true) {
    ProgressManager.checkCanceled();
    if (GdslUtil.ourGdslStopped) {
      return Collections.emptyList();
    }
    if (ref.get() != null || semaphore.waitFor(20)) {
      return ref.get();
    }
  }
}
