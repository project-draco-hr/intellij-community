{
  PathFilter pathFilter=PathFilter.create(path);
  treeWalk.setFilter(pathFilter);
  DirCache dirCache=repository.lockDirCache();
  try {
    DirCacheBuilder builder=dirCache.builder();
    treeWalk.addTree(new DirCacheBuildIterator(builder));
    treeWalk.addTree(workingTreeIterator);
    while (treeWalk.next()) {
      if (pathFilter.isDone(treeWalk)) {
        break;
      }
 else       if (treeWalk.isSubtree()) {
        treeWalk.enterSubtree();
      }
    }
    return doAdd(treeWalk,path,repository,builder);
  }
  finally {
    dirCache.unlock();
    workingTreeIterator.reset();
  }
}
