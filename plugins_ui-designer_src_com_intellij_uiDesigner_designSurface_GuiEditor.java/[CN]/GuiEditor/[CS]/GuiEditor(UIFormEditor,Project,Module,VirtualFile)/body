{
  myEditor=editor;
  LOG.assertTrue(file.isValid());
  myProject=project;
  myModule=module;
  myFile=file;
  myCutCopyPasteSupport=new CutCopyPasteSupport(this);
  setLayout(new BorderLayout());
  myContentSplitter.setDividerWidth(0);
  myContentSplitter.setDividerMouseZoneSize(Registry.intValue("ide.splitter.mouseZone"));
  add(myContentSplitter,BorderLayout.CENTER);
  myValidCard=new JPanel(new BorderLayout());
  myInvalidCard=createInvalidCard();
  myCardPanel.add(myValidCard,CARD_VALID);
  myCardPanel.add(myInvalidCard,CARD_INVALID);
  JPanel contentPanel=new JPanel(new LightFillLayout());
  JLabel toolbar=new JLabel();
  toolbar.setVisible(false);
  contentPanel.add(toolbar);
  contentPanel.add(myCardPanel);
  myContentSplitter.setInnerComponent(contentPanel);
  myListenerList=new EventListenerList();
  myDecorationLayer=new PassiveDecorationLayer(this);
  myDragLayer=new DragLayer(this);
  myLayeredPane=new MyLayeredPane();
  myInplaceEditingLayer=new InplaceEditingLayer(this);
  myLayeredPane.add(myInplaceEditingLayer,LAYER_INPLACE_EDITING);
  myActiveDecorationLayer=new ActiveDecorationLayer(this);
  myLayeredPane.add(myActiveDecorationLayer,LAYER_ACTIVE_DECORATION);
  myGlassLayer=new GlassLayer(this);
  myLayeredPane.add(myGlassLayer,LAYER_GLASS);
  myLayeredPane.add(myDecorationLayer,LAYER_PASSIVE_DECORATION);
  myLayeredPane.add(myDragLayer,LAYER_DND);
  myGlassLayer.addFocusListener(new FocusListener(){
    public void focusGained(    FocusEvent e){
      myDecorationLayer.repaint();
    }
    public void focusLost(    FocusEvent e){
      myDecorationLayer.repaint();
    }
  }
);
  mySelectionState=new SelectionState(this);
  myDeleteProvider=new MyDeleteProvider();
  final Alarm alarm=new Alarm();
  myDocumentListener=new DocumentAdapter(){
    public void documentChanged(    final DocumentEvent e){
      if (!myInsideChange) {
        UndoManager undoManager=UndoManager.getInstance(getProject());
        alarm.cancelAllRequests();
        alarm.addRequest(new MySynchronizeRequest(undoManager.isUndoInProgress() || undoManager.isRedoInProgress()),100,ModalityState.stateForComponent(GuiEditor.this));
      }
    }
  }
;
  myDocument=FileDocumentManager.getInstance().getDocument(file);
  myDocument.addDocumentListener(myDocumentListener);
  readFromFile(false);
  JPanel panel=new JPanel(new GridBagLayout());
  panel.setBackground(GridCaptionPanel.getGutterColor());
  myHorzCaptionPanel=new GridCaptionPanel(this,false);
  myVertCaptionPanel=new GridCaptionPanel(this,true);
  GridBagConstraints gbc=new GridBagConstraints();
  gbc.gridx=0;
  gbc.gridy=1;
  gbc.weightx=0.0;
  gbc.weighty=0.0;
  gbc.fill=GridBagConstraints.BOTH;
  panel.add(myVertCaptionPanel,gbc);
  gbc.gridx=1;
  gbc.gridy=0;
  panel.add(myHorzCaptionPanel,gbc);
  gbc.gridx=1;
  gbc.gridy=1;
  gbc.weightx=1.0;
  gbc.weighty=1.0;
  myScrollPane=ScrollPaneFactory.createScrollPane(myLayeredPane);
  myScrollPane.setBackground(new JBColor(new NotNullProducer<Color>(){
    @NotNull @Override public Color produce(){
      return EditorColorsManager.getInstance().getGlobalScheme().getDefaultBackground();
    }
  }
));
  panel.add(myScrollPane,gbc);
  myHorzCaptionPanel.attachToScrollPane(myScrollPane);
  myVertCaptionPanel.attachToScrollPane(myScrollPane);
  myValidCard.add(panel,BorderLayout.CENTER);
  final CancelCurrentOperationAction cancelCurrentOperationAction=new CancelCurrentOperationAction();
  cancelCurrentOperationAction.registerCustomShortcutSet(CommonShortcuts.ESCAPE,this);
  myProcessor=new MainProcessor(this);
  myPsiTreeChangeListener=new MyPsiTreeChangeListener();
  PsiManager.getInstance(getProject()).addPsiTreeChangeListener(myPsiTreeChangeListener);
  myQuickFixManager=new QuickFixManagerImpl(this,myGlassLayer,myScrollPane.getViewport());
  myDropTargetListener=new DesignDropTargetListener(this);
  if (!ApplicationManager.getApplication().isHeadlessEnvironment()) {
    new DropTarget(getGlassLayer(),DnDConstants.ACTION_COPY_OR_MOVE,myDropTargetListener);
  }
  myActiveDecorationLayer.installSelectionWatcher();
  ActionManager.getInstance().getAction("GuiDesigner.IncreaseIndent").registerCustomShortcutSet(new CustomShortcutSet(KeyStroke.getKeyStroke(KeyEvent.VK_TAB,0)),myGlassLayer);
  ActionManager.getInstance().getAction("GuiDesigner.DecreaseIndent").registerCustomShortcutSet(new CustomShortcutSet(KeyStroke.getKeyStroke(KeyEvent.VK_TAB,KeyEvent.SHIFT_MASK)),myGlassLayer);
  UsageTrigger.trigger("swing-designer.open");
  UIUtil.invokeLaterIfNeeded(new Runnable(){
    @Override public void run(){
      DesignerToolWindowManager.getInstance(myProject).bind(GuiEditor.this);
      PaletteToolWindowManager.getInstance(myProject).bind(GuiEditor.this);
    }
  }
);
}
