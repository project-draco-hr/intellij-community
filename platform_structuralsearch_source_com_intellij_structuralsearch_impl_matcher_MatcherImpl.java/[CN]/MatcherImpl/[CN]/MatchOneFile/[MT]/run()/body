{
  final List<PsiElement> files=getPsiElementsToProcess();
  if (progress != null) {
    progress.setFraction((double)scannedFilesCount / totalFilesToScan);
  }
  ++scannedFilesCount;
  if (files.size() == 0)   return;
  final LanguageFileType fileType=(LanguageFileType)matchContext.getOptions().getFileType();
  final Language patternLanguage=fileType.getLanguage();
  for (  final PsiElement file : files) {
    if (file instanceof PsiFile) {
      matchContext.getSink().processFile((PsiFile)file);
    }
    documentManager.commitAndRunReadAction(new Runnable(){
      @Override public void run(){
        if (!file.isValid())         return;
        final StructuralSearchProfile profile=StructuralSearchUtil.getProfileByLanguage(file.getLanguage());
        if (profile == null) {
          return;
        }
        match(profile.extendMatchOnePsiFile(file),patternLanguage);
      }
    }
);
  }
}
