{
  ByteBuf buffer=response.getData();
  Channel channel=requestToChannel.remove(response.getId());
  if (channel == null || !channel.isActive()) {
    if (buffer != null) {
      buffer.release();
    }
    return;
  }
  if (buffer == null) {
    Responses.sendStatus(HttpResponseStatus.BAD_GATEWAY,channel);
    return;
  }
  HttpResponse httpResponse=new DefaultFullHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.OK,buffer);
  try {
    parseHeaders(httpResponse,buffer);
    Responses.addServer(httpResponse);
    if (!HttpHeaders.isContentLengthSet(httpResponse)) {
      HttpHeaders.setContentLength(httpResponse,buffer.readableBytes());
    }
  }
 catch (  Throwable e) {
    buffer.release();
    Responses.sendStatus(HttpResponseStatus.INTERNAL_SERVER_ERROR,channel);
    LOG.error(e);
  }
  channel.writeAndFlush(httpResponse);
}
