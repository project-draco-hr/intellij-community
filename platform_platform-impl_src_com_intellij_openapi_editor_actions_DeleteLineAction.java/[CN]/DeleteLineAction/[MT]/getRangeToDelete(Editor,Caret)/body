{
  int selectionStart=caret.getSelectionStart();
  int selectionEnd=caret.getSelectionEnd();
  int startOffset=EditorUtil.getNotFoldedLineStartOffset(editor,selectionStart);
  int endOffset=EditorUtil.getNotFoldedLineEndOffset(editor,selectionEnd > 0 && selectionEnd != selectionStart ? selectionEnd - 1 : selectionEnd);
  if (endOffset < editor.getDocument().getTextLength()) {
    endOffset++;
  }
 else   if (startOffset > 0) {
    startOffset--;
  }
  return new TextRange(startOffset,endOffset);
}
