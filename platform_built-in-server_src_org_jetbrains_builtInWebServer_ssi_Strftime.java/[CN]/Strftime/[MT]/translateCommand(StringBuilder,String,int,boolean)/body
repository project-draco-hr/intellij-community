{
  char firstChar=pattern.charAt(index);
  boolean newInside=oldInside;
  if (firstChar == 'O' || firstChar == 'E') {
    if (index + 1 < pattern.length()) {
      newInside=translateCommand(buf,pattern,index + 1,oldInside);
    }
 else {
      buf.append(quote("%" + firstChar,oldInside));
    }
  }
 else {
    String command=translate.get(String.valueOf(firstChar));
    if (command == null) {
      buf.append(quote("%" + firstChar,oldInside));
    }
 else {
      if (oldInside) {
        buf.append('\'');
      }
      buf.append(command);
      newInside=false;
    }
  }
  return newInside;
}
