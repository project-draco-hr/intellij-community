{
  LOG.assertTrue(context == null || context.isValid());
  if (context != null) {
    context=context.getNavigationElement();
  }
  int poundIndex=refText.indexOf('#');
  final JavaPsiFacade facade=JavaPsiFacade.getInstance(manager.getProject());
  if (poundIndex < 0) {
    PsiClass aClass=facade.getResolveHelper().resolveReferencedClass(refText,context);
    if (aClass == null)     aClass=facade.findClass(refText,context.getResolveScope());
    if (aClass != null) {
      return useNavigationElement ? aClass.getNavigationElement() : aClass;
    }
    PsiPackage aPackage=facade.findPackage(refText);
    if (aPackage != null)     return aPackage;
    return null;
  }
 else {
    String classRef=refText.substring(0,poundIndex).trim();
    if (!classRef.isEmpty()) {
      PsiClass aClass=facade.getResolveHelper().resolveReferencedClass(classRef,context);
      if (aClass == null)       aClass=facade.findClass(classRef,context.getResolveScope());
      if (aClass == null)       return null;
      PsiElement member=findReferencedMember(aClass,refText.substring(poundIndex + 1),context);
      return useNavigationElement && member != null ? member.getNavigationElement() : member;
    }
 else {
      String memberRefText=refText.substring(1);
      PsiElement scope=context;
      while (true) {
        if (scope instanceof PsiFile)         break;
        if (scope instanceof PsiClass) {
          PsiElement member=findReferencedMember((PsiClass)scope,memberRefText,context);
          if (member != null) {
            return useNavigationElement ? member.getNavigationElement() : member;
          }
        }
        scope=scope.getParent();
      }
      return null;
    }
  }
}
