{
  if (StringUtil.isEmptyOrSpaces(myMessage)) {
    throw new HgCommandException(HgVcsMessages.message("hg4idea.commit.error.messageEmpty"));
  }
  if (myFiles.isEmpty()) {
    commitChunkFiles(Collections.<String>emptyList(),myAmend);
  }
 else {
    List<String> relativePaths=ContainerUtil.map2List(myFiles,new Function<HgFile,String>(){
      @Override public String fun(      HgFile file){
        return file.getRelativePath();
      }
    }
);
    List<List<String>> chunkedCommits=VcsFileUtil.chunkRelativePaths(relativePaths);
    int size=chunkedCommits.size();
    commitChunkFiles(chunkedCommits.get(0),myAmend,!mySubrepos.isEmpty());
    HgVcs vcs=HgVcs.getInstance(myProject);
    boolean amendCommit=vcs != null && vcs.getVersion().isAmendSupported();
    for (int i=1; i < size; i++) {
      List<String> chunk=chunkedCommits.get(i);
      commitChunkFiles(chunk,amendCommit);
    }
  }
  if (!myProject.isDisposed()) {
    HgRepositoryManager manager=HgUtil.getRepositoryManager(myProject);
    manager.updateRepository(myRoot);
  }
  final MessageBus messageBus=myProject.getMessageBus();
  messageBus.syncPublisher(HgVcs.REMOTE_TOPIC).update(myProject,null);
  messageBus.syncPublisher(HgVcs.BRANCH_TOPIC).update(myProject,null);
}
