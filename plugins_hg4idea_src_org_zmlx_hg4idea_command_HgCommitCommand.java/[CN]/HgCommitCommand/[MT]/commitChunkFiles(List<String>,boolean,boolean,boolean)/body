{
  List<String> parameters=new LinkedList<String>();
  parameters.add("--logfile");
  parameters.add(saveCommitMessage().getAbsolutePath());
  if (withSubrepos) {
    parameters.add("-S");
    parameters.addAll(mySubrepos);
  }
 else   if (amendCommit) {
    parameters.add("--amend");
  }
  if (closeBranch) {
    if (chunk.isEmpty() && myRepository.getState() != Repository.State.MERGING) {
      parameters.add("-X");
      parameters.add("\"**\"");
    }
    parameters.add("--close-branch");
  }
  parameters.addAll(chunk);
  HgCommandExecutor executor=new HgCommandExecutor(myProject);
  executor.setCharset(myCharset);
  ensureSuccess(executor.executeInCurrentThread(myRepository.getRoot(),"commit",parameters));
}
