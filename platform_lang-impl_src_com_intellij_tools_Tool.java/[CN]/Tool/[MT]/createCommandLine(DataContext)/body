{
  if (StringUtil.isEmpty(getWorkingDirectory())) {
    setWorkingDirectory("$ProjectFileDir$");
  }
  GeneralCommandLine commandLine=new GeneralCommandLine();
  try {
    String paramString=MacroManager.getInstance().expandMacrosInString(getParameters(),true,dataContext);
    String workingDir=MacroManager.getInstance().expandMacrosInString(getWorkingDirectory(),true,dataContext);
    String exePath=MacroManager.getInstance().expandMacrosInString(getProgram(),true,dataContext);
    commandLine.getParametersList().addParametersString(MacroManager.getInstance().expandMacrosInString(paramString,false,dataContext));
    final String workDirExpanded=MacroManager.getInstance().expandMacrosInString(workingDir,false,dataContext);
    if (!StringUtil.isEmpty(workDirExpanded)) {
      commandLine.setWorkDirectory(workDirExpanded);
    }
    exePath=MacroManager.getInstance().expandMacrosInString(exePath,false,dataContext);
    if (exePath == null)     return null;
    File exeFile=new File(exePath);
    if (exeFile.isDirectory() && exeFile.getName().endsWith(".app")) {
      commandLine.setExePath("open");
      commandLine.getParametersList().prependAll("-a",exePath);
    }
 else {
      exePath=PathEnvironmentVariableUtil.toLocatableExePath(exePath);
      commandLine.setExePath(exePath);
    }
  }
 catch (  Macro.ExecutionCancelledException ignored) {
    return null;
  }
  return commandLine;
}
