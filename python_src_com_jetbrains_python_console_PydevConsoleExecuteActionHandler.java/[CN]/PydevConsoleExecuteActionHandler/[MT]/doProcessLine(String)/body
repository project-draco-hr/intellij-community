{
  final LanguageConsoleImpl console=myConsoleView.getConsole();
  final Editor currentEditor=console.getCurrentEditor();
  if (myInputBuffer == null) {
    myInputBuffer=new StringBuilder();
  }
  myInputBuffer.append(line).append("\n");
  if (myInMultilineStringState != null) {
    if (line.contains(myInMultilineStringState)) {
      myInMultilineStringState=null;
      console.setLanguage(PythonLanguage.getInstance());
      console.setPrompt(PyConsoleHighlightingUtil.ORDINARY_PROMPT);
    }
 else {
      return;
    }
  }
 else {
    if (line.contains(DOUBLE_QUOTE_MULTILINE)) {
      myInMultilineStringState=DOUBLE_QUOTE_MULTILINE;
    }
 else     if (line.contains(SINGLE_QUOTE_MULTILINE)) {
      myInMultilineStringState=SINGLE_QUOTE_MULTILINE;
    }
    if (myInMultilineStringState != null) {
      console.setLanguage(PlainTextLanguage.INSTANCE);
      console.setPrompt(PyConsoleHighlightingUtil.INDENT_PROMPT);
      return;
    }
  }
  if (line.endsWith("\\")) {
    console.setPrompt(PyConsoleHighlightingUtil.INDENT_PROMPT);
    return;
  }
  if (!StringUtil.isEmptyOrSpaces(line)) {
    int indent=myIndentHelper.getIndent(line,false);
    boolean flag=false;
    if (shouldIndent(line)) {
      indent+=getPythonIndent();
      flag=true;
    }
    if ((myCurrentIndentSize != -1 && indent >= myCurrentIndentSize) || flag) {
      myCurrentIndentSize=indent;
      indentEditor(currentEditor,indent);
      scrollDown(currentEditor);
      return;
    }
  }
  if (myConsoleCommunication != null) {
    final boolean waitedForInputBefore=myConsoleCommunication.isWaitingForInput();
    myConsoleCommunication.execInterpreter(myInputBuffer.toString(),new ICallback<Object,InterpreterResponse>(){
      public Object call(      final InterpreterResponse interpreterResponse){
        myInputBuffer=null;
        if (interpreterResponse.need_input) {
          if (!PyConsoleHighlightingUtil.INPUT_PROMPT.equals(console.getPrompt())) {
            console.setPrompt(PyConsoleHighlightingUtil.INPUT_PROMPT);
            scrollDown(currentEditor);
          }
          myCurrentIndentSize=-1;
        }
 else         if (interpreterResponse.more) {
          if (!PyConsoleHighlightingUtil.INDENT_PROMPT.equals(console.getPrompt())) {
            console.setPrompt(PyConsoleHighlightingUtil.INDENT_PROMPT);
            scrollDown(currentEditor);
          }
          if (myCurrentIndentSize == -1) {
            myCurrentIndentSize=myIndentHelper.getIndent(line,false) + getPythonIndent();
            indentEditor(currentEditor,myCurrentIndentSize);
          }
        }
 else {
          if (!PyConsoleHighlightingUtil.ORDINARY_PROMPT.equals(console.getPrompt())) {
            console.setPrompt(PyConsoleHighlightingUtil.ORDINARY_PROMPT);
            scrollDown(currentEditor);
          }
          myCurrentIndentSize=-1;
        }
        if (!StringUtil.isEmpty(interpreterResponse.err)) {
          PyConsoleHighlightingUtil.processOutput(console,interpreterResponse.err,ProcessOutputTypes.STDERR);
        }
 else         if (!StringUtil.isEmpty(interpreterResponse.out)) {
          PyConsoleHighlightingUtil.processOutput(console,interpreterResponse.out,ProcessOutputTypes.STDOUT);
        }
        scrollDown(currentEditor);
        return null;
      }
    }
);
    if (waitedForInputBefore && !myConsoleCommunication.isWaitingForInput()) {
      console.setPrompt(PyConsoleHighlightingUtil.ORDINARY_PROMPT);
      scrollDown(currentEditor);
    }
  }
}
