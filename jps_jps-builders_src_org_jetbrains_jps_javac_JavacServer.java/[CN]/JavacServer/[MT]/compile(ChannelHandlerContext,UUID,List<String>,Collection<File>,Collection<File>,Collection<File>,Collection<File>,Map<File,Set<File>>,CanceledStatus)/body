{
  final DiagnosticOutputConsumer diagnostic=new DiagnosticOutputConsumer(){
    @Override public void javaFileLoaded(    File file){
      context.channel().writeAndFlush(JavacProtoUtil.toMessage(sessionId,JavacProtoUtil.createSourceFileLoadedResponse(file)));
    }
    @Override public void outputLineAvailable(    String line){
      context.channel().writeAndFlush(JavacProtoUtil.toMessage(sessionId,JavacProtoUtil.createStdOutputResponse(line)));
    }
    @Override public void report(    Diagnostic<? extends JavaFileObject> diagnostic){
      final JavacRemoteProto.Message.Response response=JavacProtoUtil.createBuildMessageResponse(diagnostic);
      context.channel().writeAndFlush(JavacProtoUtil.toMessage(sessionId,response));
    }
    @Override public void registerImports(    String className,    Collection<String> imports,    Collection<String> staticImports){
      final JavacRemoteProto.Message.Response response=JavacProtoUtil.createClassDataResponse(className,imports,staticImports);
      context.channel().writeAndFlush(JavacProtoUtil.toMessage(sessionId,response));
    }
  }
;
  final OutputFileConsumer outputSink=new OutputFileConsumer(){
    @Override public void save(    @NotNull OutputFileObject fileObject){
      context.channel().writeAndFlush(JavacProtoUtil.toMessage(sessionId,JavacProtoUtil.createOutputObjectResponse(fileObject)));
    }
  }
;
  try {
    JavaCompilingTool tool=getCompilingTool();
    final boolean rc=JavacMain.compile(options,files,classpath,platformCp,sourcePath,outs,diagnostic,outputSink,canceledStatus,tool);
    return JavacProtoUtil.toMessage(sessionId,JavacProtoUtil.createBuildCompletedResponse(rc));
  }
 catch (  Throwable e) {
    e.printStackTrace(System.err);
    return JavacProtoUtil.toMessage(sessionId,JavacProtoUtil.createFailure(e.getMessage(),e));
  }
}
