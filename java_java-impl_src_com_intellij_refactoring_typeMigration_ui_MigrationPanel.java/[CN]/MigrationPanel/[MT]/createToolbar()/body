{
  final JPanel panel=new JPanel(new GridBagLayout());
  GridBagConstraints gc=new GridBagConstraints(GridBagConstraints.RELATIVE,0,1,1,0,1,GridBagConstraints.NORTHWEST,GridBagConstraints.NONE,new Insets(5,10,5,0),0,0);
  final JButton performButton=new JButton(RefactoringBundle.message("type.migration.migrate.button.text"));
  performButton.addActionListener(new ActionListener(){
    private void expandTree(    MigrationNode migrationNode){
      if (!migrationNode.getInfo().isExcluded() || migrationNode.areChildrenInitialized()) {
        final Collection<? extends AbstractTreeNode> nodes=migrationNode.getChildren();
        for (        final AbstractTreeNode node : nodes) {
          ApplicationManager.getApplication().runReadAction(new Runnable(){
            public void run(){
              expandTree((MigrationNode)node);
            }
          }
);
        }
      }
    }
    public void actionPerformed(    final ActionEvent e){
      final Object root=myRootsTree.getModel().getRoot();
      if (root instanceof DefaultMutableTreeNode) {
        final Object userObject=((DefaultMutableTreeNode)root).getUserObject();
        if (userObject instanceof MigrationRootNode) {
          ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
            public void run(){
              final HashSet<VirtualFile> files=new HashSet<VirtualFile>();
              final TypeMigrationUsageInfo[] usages=ApplicationManager.getApplication().runReadAction(new Computable<TypeMigrationUsageInfo[]>(){
                @Override public TypeMigrationUsageInfo[] compute(){
                  final Collection<? extends AbstractTreeNode> children=((MigrationRootNode)userObject).getChildren();
                  for (                  AbstractTreeNode child : children) {
                    expandTree((MigrationNode)child);
                  }
                  final TypeMigrationUsageInfo[] usages=myLabeler.getMigratedUsages();
                  for (                  TypeMigrationUsageInfo usage : usages) {
                    if (!usage.isExcluded()) {
                      final PsiElement element=usage.getElement();
                      if (element != null) {
                        files.add(element.getContainingFile().getVirtualFile());
                      }
                    }
                  }
                  return usages;
                }
              }
);
              ApplicationManager.getApplication().invokeLater(new Runnable(){
                @Override public void run(){
                  if (ReadonlyStatusHandler.getInstance(myProject).ensureFilesWritable(VfsUtilCore.toVirtualFileArray(files)).hasReadonlyFiles()) {
                    return;
                  }
                  new WriteCommandAction(myProject){
                    protected void run(                    @NotNull Result result) throws Throwable {
                      TypeMigrationProcessor.change(myLabeler,usages);
                    }
                  }
.execute();
                }
              }
,myProject.getDisposed());
            }
          }
,"Type Migration",false,myProject);
        }
      }
      UsageViewManager.getInstance(myProject).closeContent(myContent);
    }
  }
);
  panel.add(performButton,gc);
  final JButton closeButton=new JButton(CommonBundle.getCancelButtonText());
  closeButton.addActionListener(new ActionListener(){
    public void actionPerformed(    final ActionEvent e){
      UsageViewManager.getInstance(myProject).closeContent(myContent);
    }
  }
);
  panel.add(closeButton,gc);
  final JButton rerunButton=new JButton(RefactoringBundle.message("type.migration.rerun.button.text"));
  rerunButton.addActionListener(new ActionListener(){
    public void actionPerformed(    final ActionEvent e){
      UsageViewManager.getInstance(myProject).closeContent(myContent);
      SwingUtilities.invokeLater(new Runnable(){
        public void run(){
          final TypeMigrationDialog.MultipleElements dialog=new TypeMigrationDialog.MultipleElements(myProject,myInitialRoots,myLabeler.getMigrationRootTypeFunction(),myLabeler.getRules());
          dialog.show();
        }
      }
);
    }
  }
);
  panel.add(rerunButton,gc);
  final JButton helpButton=new JButton(CommonBundle.getHelpButtonText());
  helpButton.addActionListener(new ActionListener(){
    public void actionPerformed(    final ActionEvent e){
      HelpManager.getInstance().invokeHelp("reference.typeMigrationPreview");
    }
  }
);
  gc.weightx=1;
  panel.add(helpButton,gc);
  return panel;
}
