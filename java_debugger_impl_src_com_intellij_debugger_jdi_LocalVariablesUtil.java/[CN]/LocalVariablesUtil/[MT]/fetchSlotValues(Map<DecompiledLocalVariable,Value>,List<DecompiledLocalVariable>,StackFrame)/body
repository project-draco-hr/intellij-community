{
  final Long frameId=ReflectionUtil.getField(frame.getClass(),frame,long.class,"id");
  final VirtualMachine vm=frame.virtualMachine();
  final Method stateMethod=ReflectionUtil.getDeclaredMethod(vm.getClass(),"state");
  Object slotInfoArray=createSlotInfoArray(vars);
  Object ps;
  final Object vmState=stateMethod.invoke(vm);
synchronized (vmState) {
    ps=ourEnqueueMethod.invoke(null,vm,frame.thread(),frameId,slotInfoArray);
  }
  final Object reply=ourWaitForReplyMethod.invoke(null,vm,ps);
  final Value[] values=ReflectionUtil.getField(reply.getClass(),reply,Value[].class,"values");
  if (vars.size() != values.length) {
    throw new InternalException("Wrong number of values returned from target VM");
  }
  int idx=0;
  for (  DecompiledLocalVariable var : vars) {
    map.put(var,values[idx++]);
  }
  return map;
}
