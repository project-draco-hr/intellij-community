{
  long started=System.currentTimeMillis();
  PushedFilePropertiesUpdater.getInstance(myProject).pushAllPropertiesNow();
  LOG.info("Pushed properties in " + (System.currentTimeMillis() - started) + " ms");
  indicator.setIndeterminate(true);
  indicator.setText(IdeBundle.message("progress.indexing.scanning"));
  CollectingContentIterator finder=myIndex.createContentIterator(indicator);
  long l=System.currentTimeMillis();
  myIndex.iterateIndexableFilesConcurrently(finder,myProject,indicator);
  myIndex.filesUpdateEnumerationFinished();
  LOG.info("Indexable files iterated in " + (System.currentTimeMillis() - l) + " ms");
  List<VirtualFile> files=finder.getFiles();
  if (myOnStartup && !ApplicationManager.getApplication().isUnitTestMode()) {
    ((StartupManagerImpl)StartupManager.getInstance(myProject)).scheduleInitialVfsRefresh();
  }
  if (files.isEmpty()) {
    return;
  }
  started=System.currentTimeMillis();
  LOG.info("Unindexed files update started: " + files.size() + " files to update");
  indicator.setIndeterminate(false);
  indicator.setText(IdeBundle.message("progress.indexing.updating"));
  indexFiles(indicator,files);
  LOG.info("Unindexed files update done in " + (System.currentTimeMillis() - started) + " ms");
}
