{
  if (toFocus == null)   return ActionCallback.DONE;
  if (myTestMode) {
    toFocus.requestFocus();
    return ActionCallback.DONE;
  }
  if (isShowing()) {
    return myFocusManager.requestFocus(new FocusCommand.ByComponent(toFocus,new Exception()));
  }
 else {
    final ActionCallback result=new ActionCallback();
    final FocusRequestor requestor=myFocusManager.getFurtherRequestor();
    final Ref<Boolean> queued=new Ref<Boolean>(false);
    Disposer.register(requestor,new Disposable(){
      @Override public void dispose(){
        if (!queued.get()) {
          result.setRejected();
        }
      }
    }
);
    myDeferredFocusRequest=new Runnable(){
      @Override public void run(){
        queued.set(true);
        requestor.requestFocus(new FocusCommand.ByComponent(toFocus,new Exception())).notify(result);
      }
    }
;
    return result;
  }
}
