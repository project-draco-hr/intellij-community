{
  final SearchResult symbols=new SearchResult();
  if (!Registry.is("search.everywhere.symbols") || shouldSkipPattern(pattern)) {
    return symbols;
  }
  final GlobalSearchScope scope=GlobalSearchScope.projectScope(project);
  if (chooseByNamePopup == null)   return symbols;
  final ChooseByNameItemProvider provider=chooseByNamePopup.getProvider();
  provider.filterElements(chooseByNamePopup,pattern,includeLibs,myProgressIndicator,new Processor<Object>(){
    @Override public boolean process(    Object o){
      if (isSymbol(o)) {
        final PsiElement element=(PsiElement)o;
        final PsiFile file=element.getContainingFile();
        if (!myListModel.contains(o) && !symbols.contains(o) && (file == null || (file.getVirtualFile() != null && (includeLibs || scope.accept(file.getVirtualFile()))))) {
          symbols.add(o);
        }
      }
      symbols.needMore=symbols.size() == max;
      return !symbols.needMore;
    }
  }
);
  if (!includeLibs && symbols.isEmpty()) {
    return getSymbols(pattern,max,true,chooseByNamePopup);
  }
  return symbols;
}
