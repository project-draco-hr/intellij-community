{
  myProgressIndicator.checkCanceled();
  SwingUtilities.invokeLater(new Runnable(){
    @Override public void run(){
      myProgressIndicator.checkCanceled();
      myListModel.update();
      myList.revalidate();
      myList.repaint();
      myRenderer.recalculateWidth();
      if (myPopup == null || !myPopup.isVisible()) {
        final ActionCallback callback=ListDelegationUtil.installKeyboardDelegation(getField().getTextEditor(),myList);
        final ComponentPopupBuilder builder=JBPopupFactory.getInstance().createComponentPopupBuilder(new JBScrollPane(myList),null);
        myInitialWidth=myInitialHeight=0;
        myPopup=builder.setRequestFocus(false).setCancelKeyEnabled(false).createPopup();
        Disposer.register(myPopup,new Disposable(){
          @Override public void dispose(){
            callback.setDone();
            if (myBalloon != null) {
              myBalloon.hide();
              myBalloon=null;
            }
          }
        }
);
        if (getField() == field) {
          myPopup.showUnderneathOf(field);
        }
 else {
          myPopup.show(new RelativePoint(getField(),new Point(0,getField().getHeight() + 4)));
        }
        ActionManager.getInstance().addAnActionListener(new AnActionListener.Adapter(){
          @Override public void beforeActionPerformed(          AnAction action,          DataContext dataContext,          AnActionEvent event){
            myPopup.cancel();
          }
        }
,myPopup);
      }
 else {
        myList.revalidate();
        myList.repaint();
      }
      ListScrollingUtil.ensureSelectionExists(myList);
      if (myList.getModel().getSize() == 0) {
      }
 else {
        final Dimension size=myList.getPreferredSize();
        Dimension sz=new Dimension(Math.max(getField().getWidth(),size.width),size.height);
        if (sz.width > 800 || sz.height > 800) {
          final int extra=new JBScrollPane().getVerticalScrollBar().getWidth();
          sz=new Dimension(Math.min(800,Math.max(getField().getWidth(),size.width + extra)),Math.min(800,size.height + extra));
          sz.width+=16;
        }
 else {
          sz.height++;
          sz.height++;
          sz.width++;
          sz.width++;
        }
        myPopup.setSize(sz);
        final Point screen=getField().getLocationOnScreen();
        final int x;
        if (getField() == field) {
          x=screen.x + getField().getWidth() - myPopup.getSize().width;
        }
 else {
          x=screen.x - myLeftWidth - 5;
        }
        myPopup.setLocation(new Point(x,myPopup.getLocationOnScreen().y));
      }
    }
  }
);
}
