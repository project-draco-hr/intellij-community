{
  final IpnbEditablePanel cellPanel=getSelectedCell();
  if (cellPanel == null)   return;
  final IpnbEditableCell cell=cellPanel.getCell();
  final int position=cellPanel.getCaretPosition();
  final String oldCellText=cellPanel.getText(0,position);
  final String newCellText=cellPanel.getText(position);
  if (oldCellText != null) {
    final JTextArea editablePanel=cellPanel.myEditablePanel;
    if (editablePanel != null)     editablePanel.setText(oldCellText);
    cellPanel.getCell().setSource(createCellSourceFromText(oldCellText));
    actualizeCellData(cell);
    cellPanel.updateCellView();
  }
  final ArrayList<String> newCellSource=createCellSourceFromText(newCellText);
  if (cell instanceof IpnbCodeCell) {
    final IpnbCodeCell codeCell=(IpnbCodeCell)cell;
    final IpnbCodeCell ipnbCodeCell=new IpnbCodeCell(codeCell.getLanguage(),newCellSource,codeCell.getPromptNumber(),codeCell.getCellOutputs(),codeCell.getMetadata());
    addCell(new IpnbCodePanel(myProject,myParent,ipnbCodeCell),true);
  }
 else   if (cell instanceof IpnbMarkdownCell) {
    final IpnbMarkdownCell markdownCell=new IpnbMarkdownCell(newCellSource,cell.getMetadata());
    addCell(new IpnbMarkdownPanel(markdownCell,this),true);
  }
 else   if (cell instanceof IpnbHeadingCell) {
    final IpnbHeadingCell headingCell=new IpnbHeadingCell(newCellSource,((IpnbHeadingCell)cell).getLevel(),cell.getMetadata());
    addCell(new IpnbHeadingPanel(headingCell),true);
  }
  saveToFile();
}
