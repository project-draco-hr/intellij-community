{
  DnDSupport.createBuilder(myTree).setBeanProvider(new Function<DnDActionInfo,DnDDragStartBean>(){
    @Override public DnDDragStartBean fun(    DnDActionInfo info){
      final TreePath path=myTree.getPathForLocation(info.getPoint().x,info.getPoint().y);
      if (path != null && path.getPathCount() == 3) {
        Object o=path.getLastPathComponent();
        if (o instanceof DefaultMutableTreeNode) {
          o=((DefaultMutableTreeNode)o).getUserObject();
          if (o instanceof FavoritesTreeNodeDescriptor) {
            FavoritesTreeNodeDescriptor root=((FavoritesTreeNodeDescriptor)o).getFavoritesRoot();
            if (root != o) {
              o=root.getElement();
              if (o instanceof FavoritesListNode && ((FavoritesListNode)o).getProvider() == null) {
                return new DnDDragStartBean(path);
              }
            }
          }
        }
      }
      return new DnDDragStartBean(""){
        @Override public boolean isEmpty(){
          return true;
        }
      }
;
    }
  }
).setTargetChecker(new DnDTargetChecker(){
    @Override public boolean update(    DnDEvent event){
      final Object obj=event.getAttachedObject();
      if ("".equals(obj)) {
        event.setDropPossible(false);
        return false;
      }
      if (obj instanceof TreePath && ((TreePath)obj).getPathCount() <= 2) {
        event.setDropPossible(false);
        return true;
      }
      FavoritesListNode node=myViewPanel.findFavoritesListNode(event.getPoint());
      if ((obj instanceof TreePath && myViewPanel.myTree.getPath(node).isDescendant((TreePath)obj)) || (node != null && node.getProvider() != null)) {
        event.setDropPossible(false);
        return false;
      }
      highlight(node,event);
      if (node != null) {
        event.setDropPossible(true);
        return true;
      }
      event.setDropPossible(false);
      return false;
    }
  }
).setDropHandler(new DnDDropHandler(){
    @Override public void drop(    DnDEvent event){
      final FavoritesListNode node=myViewPanel.findFavoritesListNode(event.getPoint());
      final FavoritesManager mgr=FavoritesManager.getInstance(myProject);
      if (node == null)       return;
      final String listTo=node.getValue();
      final Object obj=event.getAttachedObject();
      if (obj instanceof TreePath) {
        final TreePath path=(TreePath)obj;
        final String listFrom=FavoritesTreeViewPanel.getListNodeFromPath(path).getValue();
        if (listTo.equals(listFrom))         return;
        if (path.getPathCount() == 3) {
          final AbstractTreeNode abstractTreeNode=((FavoritesTreeNodeDescriptor)((DefaultMutableTreeNode)path.getLastPathComponent()).getUserObject()).getElement();
          Object element=abstractTreeNode.getValue();
          mgr.removeRoot(listFrom,Collections.singletonList(abstractTreeNode));
          if (element instanceof SmartPsiElementPointer) {
            element=((SmartPsiElementPointer)element).getElement();
          }
          mgr.addRoots(listTo,null,element);
        }
      }
 else       if (obj instanceof TransferableWrapper) {
        myViewPanel.dropPsiElements(mgr,node,((TransferableWrapper)obj).getPsiElements());
      }
 else       if (obj instanceof DnDNativeTarget.EventInfo) {
        myViewPanel.dropPsiElements(mgr,node,getPsiFiles(FileCopyPasteUtil.getFileList(((DnDNativeTarget.EventInfo)obj).getTransferable())));
      }
    }
  }
).setImageProvider(new Function<DnDActionInfo,DnDImage>(){
    @Override public DnDImage fun(    DnDActionInfo info){
      return new DnDImage(myFavoritesImage,new Point(-myFavoritesImage.getWidth(null) / 2,-myFavoritesImage.getHeight(null) / 2));
    }
  }
).enableAsNativeTarget().setDisposableParent(myProject).install();
}
