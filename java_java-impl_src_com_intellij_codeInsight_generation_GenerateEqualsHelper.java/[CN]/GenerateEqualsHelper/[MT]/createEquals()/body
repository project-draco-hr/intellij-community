{
  @NonNls StringBuilder buffer=new StringBuilder();
  CodeStyleSettings styleSettings=CodeStyleSettingsManager.getSettings(myProject);
  ArrayList<PsiField> equalsFields=new ArrayList<PsiField>();
  ContainerUtil.addAll(equalsFields,myEqualsFields);
  Collections.sort(equalsFields,EqualsFieldsComparator.INSTANCE);
  final HashMap<String,Object> contextMap=new HashMap<String,Object>();
  final PsiType classType=JavaPsiFacade.getElementFactory(myClass.getProject()).createType(myClass);
  final JavaCodeStyleManager codeStyleManager=JavaCodeStyleManager.getInstance(myClass.getProject());
  String[] nameSuggestions=codeStyleManager.suggestVariableName(VariableKind.LOCAL_VARIABLE,null,null,classType).names;
  String instanceBaseName=nameSuggestions.length > 0 && nameSuggestions[0].length() < 10 ? nameSuggestions[0] : "that";
  contextMap.put(INSTANCE_NAME,instanceBaseName);
  final PsiType objectType=PsiType.getJavaLangObject(myClass.getManager(),myClass.getResolveScope());
  nameSuggestions=codeStyleManager.suggestVariableName(VariableKind.PARAMETER,null,null,objectType).names;
  final String objectBaseName=nameSuggestions.length > 0 ? nameSuggestions[0] : "object";
  contextMap.put(BASE_PARAM_NAME,objectBaseName);
  final MethodSignature equalsSignature=getEqualsSignature(myProject,myClass.getResolveScope());
  contextMap.put(SUPER_HAS_EQUALS,superMethodExists(equalsSignature));
  contextMap.put(CHECK_PARAMETER_WITH_INSTANCEOF,myCheckParameterWithInstanceof);
  final String methodText=GenerationUtil.velocityGenerateCode(myClass,equalsFields,myNonNullSet,new HashMap<String,String>(),contextMap,EqualsHashCodeTemplatesManager.getInstance().getDefaultEqualsTemplate().getTemplate(),0,false,myUseAccessors);
  buffer.append(methodText);
  PsiMethod result;
  try {
    result=myFactory.createMethodFromText(buffer.toString(),myClass);
  }
 catch (  IncorrectOperationException e) {
    return null;
  }
  final PsiParameter[] parameters=result.getParameterList().getParameters();
  if (parameters.length != 1)   return null;
  final PsiParameter parameter=parameters[0];
  PsiUtil.setModifierProperty(parameter,PsiModifier.FINAL,styleSettings.GENERATE_FINAL_PARAMETERS);
  PsiMethod method=(PsiMethod)myCodeStyleManager.reformat(result);
  final PsiMethod superEquals=MethodSignatureUtil.findMethodBySignature(myClass,equalsSignature,true);
  if (superEquals != null) {
    OverrideImplementUtil.annotateOnOverrideImplement(method,myClass,superEquals);
  }
  method=(PsiMethod)myJavaCodeStyleManager.shortenClassReferences(method);
  return method;
}
