{
  int i=0;
  String url=requestBuilder.url;
  while (i++ < 99) {
    URLConnection connection;
    if (ApplicationManager.getApplication() == null) {
      connection=new URL(url).openConnection();
    }
 else {
      connection=HttpConfigurable.getInstance().openConnection(url);
    }
    connection.setConnectTimeout(requestBuilder.connectTimeout);
    connection.setReadTimeout(requestBuilder.readTimeout);
    if (requestBuilder.supportGzip) {
      connection.setRequestProperty("Accept-Encoding","gzip");
    }
    connection.setUseCaches(false);
    if (connection instanceof HttpURLConnection) {
      int responseCode=((HttpURLConnection)connection).getResponseCode();
      if (responseCode != HttpURLConnection.HTTP_OK && responseCode != HttpURLConnection.HTTP_NOT_MODIFIED) {
        if (responseCode == HttpURLConnection.HTTP_MOVED_PERM || responseCode == HttpURLConnection.HTTP_MOVED_TEMP) {
          url=connection.getHeaderField("Location");
        }
 else {
          url=null;
        }
        if (url == null) {
          throw new IOException(IdeBundle.message("error.connection.failed.with.http.code.N",responseCode));
        }
 else {
          ((HttpURLConnection)connection).disconnect();
          continue;
        }
      }
    }
    return Pair.create(connection,url == requestBuilder.url ? null : url);
  }
  throw new IOException("Infinite redirection");
}
