{
  if (!PsiUtil.isLanguageLevel8OrHigher(file)) {
    return null;
  }
  final Project project=manager.getProject();
  final PsiClass fluentIterable=JavaPsiFacade.getInstance(project).findClass(GUAVA_FLUENT_ITERABLE,GlobalSearchScope.allScope(project));
  if (fluentIterable == null) {
    return null;
  }
  final SmartPointerManager mySmartPointerManager=SmartPointerManager.getInstance(project);
  final Set<PsiMethodCallExpression> myMethodCallsToIgnore=new THashSet<PsiMethodCallExpression>(new TObjectIdentityHashingStrategy<PsiMethodCallExpression>());
  final MultiMap<PsiLocalVariable,PsiExpression> localVariablesUsages=new MultiMap<PsiLocalVariable,PsiExpression>();
  final Set<PsiLocalVariable> unconvertibleVariables=new THashSet<PsiLocalVariable>(new TObjectIdentityHashingStrategy<PsiLocalVariable>());
  final List<ProblemDescriptor> descriptors=new ArrayList<ProblemDescriptor>();
  final JavaRecursiveElementVisitor visitor=new JavaRecursiveElementVisitor(){
    @Override public void visitLocalVariable(    final PsiLocalVariable localVariable){
      super.visitLocalVariable(localVariable);
      final PsiType type=localVariable.getType();
      if (!(type instanceof PsiClassType) || unconvertibleVariables.contains(localVariable)) {
        return;
      }
      final PsiClass variableClass=((PsiClassType)type).resolve();
      if (variableClass == null) {
        return;
      }
      final String qualifiedName=variableClass.getQualifiedName();
      if (!GUAVA_FLUENT_ITERABLE.equals(qualifiedName)) {
        return;
      }
      final PsiCodeBlock context=PsiTreeUtil.getParentOfType(localVariable,PsiCodeBlock.class);
      if (context == null || !checkDeclaration(localVariable.getInitializer())) {
        unconvertibleVariables.add(localVariable);
      }
    }
    private boolean checkDeclaration(    PsiExpression declaration){
      if (declaration == null) {
        return true;
      }
      if (!(declaration instanceof PsiMethodCallExpression)) {
        return false;
      }
      PsiMethodCallExpression currentCallExpression=(PsiMethodCallExpression)declaration;
      while (true) {
        final PsiExpression qualifier=currentCallExpression.getMethodExpression().getQualifierExpression();
        if (qualifier instanceof PsiMethodCallExpression) {
          final PsiMethod method=currentCallExpression.resolveMethod();
          if (method == null || GuavaFluentIterableMethodConverters.isStopMethod(method.getName())) {
            return false;
          }
          final PsiClass aClass=method.getContainingClass();
          if (aClass == null || !aClass.isEquivalentTo(fluentIterable)) {
            return false;
          }
          currentCallExpression=(PsiMethodCallExpression)qualifier;
        }
 else {
          if (qualifier instanceof PsiReferenceExpression) {
            final PsiMethod method=currentCallExpression.resolveMethod();
            if (method == null || !FLUENT_ITERABLE_FROM.equals(method.getName())) {
              return false;
            }
            final PsiClass aClass=method.getContainingClass();
            if (aClass == null || !GUAVA_FLUENT_ITERABLE.equals(aClass.getQualifiedName())) {
              return false;
            }
            break;
          }
 else {
            return false;
          }
        }
      }
      return true;
    }
    @Override public void visitReferenceExpression(    PsiReferenceExpression expression){
      super.visitReferenceExpression(expression);
      final PsiElement resolvedElement=expression.resolve();
      if (resolvedElement instanceof PsiLocalVariable) {
        PsiLocalVariable fluentIterableVariable=(PsiLocalVariable)resolvedElement;
        if (!fluentIterable.isEquivalentTo(PsiTypesUtil.getPsiClass(fluentIterableVariable.getType())) || unconvertibleVariables.contains(fluentIterableVariable)) {
          return;
        }
        analyzeExpression(expression,fluentIterableVariable);
      }
    }
    private void addToUnconvertible(    PsiLocalVariable variable){
      unconvertibleVariables.add(variable);
      localVariablesUsages.remove(variable);
    }
    @Override public void visitMethodCallExpression(    PsiMethodCallExpression expression){
      super.visitMethodCallExpression(expression);
      if (!myMethodCallsToIgnore.add(expression)) {
        return;
      }
      final PsiReferenceExpression methodExpression=expression.getMethodExpression();
      final String methodName=methodExpression.getReferenceName();
      if (FLUENT_ITERABLE_FROM.equals(methodName)) {
        final PsiMethod method=expression.resolveMethod();
        if (method == null || !method.hasModifierProperty(PsiModifier.STATIC) || !fluentIterable.isEquivalentTo(method.getContainingClass())) {
          return;
        }
        PsiMethodCallExpression currentExpression=expression;
        while (true) {
          myMethodCallsToIgnore.add(currentExpression);
          PsiMethodCallExpression parentMethodCall=PsiTreeUtil.getParentOfType(currentExpression,PsiMethodCallExpression.class);
          if (parentMethodCall != null) {
            if (parentMethodCall.getMethodExpression().getQualifierExpression() == currentExpression) {
              final PsiMethod parentCallMethod=parentMethodCall.resolveMethod();
              if (parentCallMethod != null && fluentIterable.isEquivalentTo(parentCallMethod.getContainingClass())) {
                if (GuavaFluentIterableMethodConverters.isStopMethod(parentCallMethod.getName())) {
                  return;
                }
                currentExpression=parentMethodCall;
                continue;
              }
            }
          }
          final PsiElement expressionParent=currentExpression.getParent();
          if (expressionParent instanceof PsiReturnStatement) {
            final PsiType containingMethodReturnType=findContainingMethodReturnType((PsiReturnStatement)expressionParent);
            if (containingMethodReturnType instanceof PsiClassType) {
              final PsiClass resolvedClass=((PsiClassType)containingMethodReturnType).resolve();
              if (resolvedClass == null || !(resolvedClass.getResolveScope() instanceof JdkScope)) {
                return;
              }
            }
          }
 else           if (expressionParent instanceof PsiLocalVariable) {
            final PsiType type=((PsiLocalVariable)expressionParent).getType();
            if (type instanceof PsiClassType) {
              final PsiClass resolvedClass=((PsiClassType)type).resolve();
              if (resolvedClass == null || !(resolvedClass.getResolveScope() instanceof JdkScope)) {
                return;
              }
            }
          }
 else           if (expressionParent instanceof PsiExpressionList) {
            if (expressionParent.getParent() instanceof PsiMethodCallExpression && !isMethodWithParamAcceptsConversion((PsiMethodCallExpression)expressionParent.getParent(),currentExpression,fluentIterable)) {
              return;
            }
          }
          final List<SmartPsiElementPointer<PsiExpression>> exprAsList=ContainerUtil.list(mySmartPointerManager.createSmartPsiElementPointer((PsiExpression)currentExpression));
          descriptors.add(manager.createProblemDescriptor(currentExpression,PROBLEM_DESCRIPTION,new ConvertGuavaFluentIterableQuickFix(null,exprAsList),ProblemHighlightType.GENERIC_ERROR_OR_WARNING,isOnTheFly));
          return;
        }
      }
 else {
        final PsiExpression qualifierExpression=methodExpression.getQualifierExpression();
        if (GuavaFluentIterableMethodConverters.isFluentIterableMethod(methodName) && qualifierExpression instanceof PsiReferenceExpression) {
          final PsiElement resolvedElement=((PsiReferenceExpression)qualifierExpression).resolve();
          if (resolvedElement instanceof PsiLocalVariable) {
            PsiLocalVariable fluentIterableLocalVariable=(PsiLocalVariable)resolvedElement;
            if (!fluentIterable.isEquivalentTo(PsiTypesUtil.getPsiClass(fluentIterableLocalVariable.getType())) || unconvertibleVariables.contains(fluentIterableLocalVariable)) {
              return;
            }
            analyzeExpression(expression,fluentIterableLocalVariable);
          }
        }
      }
    }
    private void analyzeExpression(    PsiExpression expression,    PsiLocalVariable fluentIterableLocalVariable){
      PsiExpression baseExpression=expression;
      while (true) {
        final PsiMethodCallExpression methodCallExpression=PsiTreeUtil.getParentOfType(baseExpression,PsiMethodCallExpression.class);
        if (methodCallExpression != null && methodCallExpression.getMethodExpression().getQualifierExpression() == baseExpression) {
          final String currentMethodName=methodCallExpression.getMethodExpression().getReferenceName();
          if (GuavaFluentIterableMethodConverters.isFluentIterableMethod(currentMethodName)) {
            if (GuavaFluentIterableMethodConverters.isStopMethod((currentMethodName))) {
              addToUnconvertible(fluentIterableLocalVariable);
              return;
            }
 else {
              final PsiMethod method=methodCallExpression.resolveMethod();
              if (method != null && method.getContainingClass() != null && method.getContainingClass().isEquivalentTo(fluentIterable)) {
                baseExpression=methodCallExpression;
                myMethodCallsToIgnore.add(methodCallExpression);
                continue;
              }
            }
          }
        }
        break;
      }
      final PsiElement parent=baseExpression.getParent();
      if (parent instanceof PsiExpressionList) {
        localVariablesUsages.putValue(fluentIterableLocalVariable,baseExpression);
        final boolean suitable=parent.getParent() instanceof PsiMethodCallExpression && isMethodWithParamAcceptsConversion((PsiMethodCallExpression)parent.getParent(),baseExpression,fluentIterable);
        if (!suitable) {
          addToUnconvertible(fluentIterableLocalVariable);
        }
      }
 else       if (parent instanceof PsiReferenceExpression) {
        final PsiMethodCallExpression parentMethodCall=PsiTreeUtil.getParentOfType(baseExpression,PsiMethodCallExpression.class);
        if (parentMethodCall != null && parentMethodCall.getMethodExpression().getQualifier() == baseExpression) {
          if (GuavaOptionalConverter.isConvertibleIfOption(parentMethodCall)) {
            localVariablesUsages.putValue(fluentIterableLocalVariable,baseExpression);
          }
 else {
            addToUnconvertible(fluentIterableLocalVariable);
          }
        }
      }
 else       if (parent instanceof PsiLocalVariable) {
        localVariablesUsages.putValue(fluentIterableLocalVariable,baseExpression);
      }
 else       if (parent instanceof PsiAssignmentExpression) {
        final PsiAssignmentExpression assignment=(PsiAssignmentExpression)parent;
        final PsiExpression lExpression=assignment.getLExpression();
        if (lExpression instanceof PsiReferenceExpression) {
          if (((PsiReferenceExpression)lExpression).isReferenceTo(fluentIterableLocalVariable)) {
            if (isSelfAssignment(assignment,fluentIterableLocalVariable)) {
              localVariablesUsages.putValue(fluentIterableLocalVariable,baseExpression);
              return;
            }
            if (checkDeclaration(assignment.getRExpression())) {
              localVariablesUsages.putValue(fluentIterableLocalVariable,assignment.getRExpression());
              return;
            }
            addToUnconvertible(fluentIterableLocalVariable);
          }
 else {
            localVariablesUsages.putValue(fluentIterableLocalVariable,baseExpression);
          }
        }
 else {
          localVariablesUsages.putValue(fluentIterableLocalVariable,baseExpression);
        }
      }
 else       if (parent instanceof PsiReturnStatement) {
        final PsiType containingMethodReturnType=findContainingMethodReturnType((PsiReturnStatement)parent);
        if (!(containingMethodReturnType instanceof PsiClassType)) {
          addToUnconvertible(fluentIterableLocalVariable);
          return;
        }
        final PsiClass resolvedClass=((PsiClassType)containingMethodReturnType).resolve();
        if (resolvedClass == null || (!CommonClassNames.JAVA_LANG_ITERABLE.equals(resolvedClass.getQualifiedName()) && !CommonClassNames.JAVA_LANG_OBJECT.equals(resolvedClass.getQualifiedName()))) {
          addToUnconvertible(fluentIterableLocalVariable);
        }
 else {
          localVariablesUsages.putValue(fluentIterableLocalVariable,baseExpression);
        }
      }
 else       if (parent instanceof PsiExpressionStatement) {
        localVariablesUsages.putValue(fluentIterableLocalVariable,baseExpression);
      }
    }
  }
;
  file.accept(visitor);
  for (  Map.Entry<PsiLocalVariable,Collection<PsiExpression>> e : localVariablesUsages.entrySet()) {
    final PsiLocalVariable localVariable=e.getKey();
    final Collection<PsiExpression> foundUsages=e.getValue();
    final SmartPsiElementPointer<PsiLocalVariable> variablePointer=mySmartPointerManager.createSmartPsiElementPointer(localVariable);
    final ConvertGuavaFluentIterableQuickFix quickFix=new ConvertGuavaFluentIterableQuickFix(variablePointer,ContainerUtil.map(new THashSet<PsiExpression>(foundUsages),new Function<PsiExpression,SmartPsiElementPointer<PsiExpression>>(){
      @Override public SmartPsiElementPointer<PsiExpression> fun(      PsiExpression expression){
        return mySmartPointerManager.createSmartPsiElementPointer(expression);
      }
    }
));
    descriptors.add(manager.createProblemDescriptor(localVariable,PROBLEM_DESCRIPTION,quickFix,ProblemHighlightType.GENERIC_ERROR_OR_WARNING,isOnTheFly));
    for (    PsiExpression usage : foundUsages) {
      descriptors.add(manager.createProblemDescriptor(usage,PROBLEM_DESCRIPTION,quickFix,ProblemHighlightType.GENERIC_ERROR_OR_WARNING,isOnTheFly));
    }
  }
  return descriptors.isEmpty() ? null : descriptors.toArray(new ProblemDescriptor[descriptors.size()]);
}
