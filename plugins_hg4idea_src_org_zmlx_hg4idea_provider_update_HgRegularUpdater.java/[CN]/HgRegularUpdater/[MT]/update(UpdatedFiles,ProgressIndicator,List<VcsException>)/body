{
  indicator.setText(HgVcsMessages.message("hg4idea.progress.updating",repoRoot.getPath()));
  String defaultPath=HgUtil.getRepositoryDefaultPath(project,repoRoot);
  if (StringUtil.isEmptyOrSpaces(defaultPath)) {
    throw new VcsException(HgVcsMessages.message("hg4idea.warning.no-default-update-path",repoRoot.getPath()));
  }
  List<HgRevisionNumber> branchHeadsBeforePull=new HgHeadsCommand(project,repoRoot).executeInCurrentThread();
  if (branchHeadsBeforePull.size() > 1) {
    reportWarning(warnings,HgVcsMessages.message("hg4idea.update.warning.multipleHeadsBeforeUpdate",repoRoot.getPath()));
  }
  if (updateConfiguration.shouldPull()) {
    HgCommandExitCode pullResult=pull(repoRoot,indicator);
    if (pullResult == HgCommandExitCode.ERROR) {
      return false;
    }
  }
  List<HgRevisionNumber> parentsBeforeUpdate=new HgWorkingCopyRevisionsCommand(project).parents(repoRoot);
  if (parentsBeforeUpdate.size() > 1) {
    throw new VcsException(HgVcsMessages.message("hg4idea.update.error.uncommittedMerge",repoRoot.getPath()));
  }
  indicator.setText2(HgVcsMessages.message("hg4idea.progress.countingHeads"));
  List<HgRevisionNumber> branchHeadsAfterPull=new HgHeadsCommand(project,repoRoot).executeInCurrentThread();
  List<HgRevisionNumber> pulledBranchHeads=determinePulledBranchHeads(branchHeadsBeforePull,branchHeadsAfterPull);
  List<HgRevisionNumber> remainingOriginalBranchHeads=determingRemainingOriginalBranchHeads(branchHeadsBeforePull,branchHeadsAfterPull);
  HgUpdateType updateType=updateConfiguration.getUpdateType();
  if (branchHeadsAfterPull.size() > 1 && updateType != ONLY_UPDATE) {
    if (updateType == MERGE) {
      abortOnLocalChanges();
      abortOnMultiplePulledHeads(pulledBranchHeads);
      abortOnMultipleLocalHeads(remainingOriginalBranchHeads);
      HgCommandResult mergeResult=doMerge(indicator);
      if (updateConfiguration.shouldCommitAfterMerge()) {
        commitOrWarnAboutConflicts(warnings,mergeResult);
      }
    }
 else {
      processRebase(indicator,updatedFiles);
      return true;
    }
  }
 else {
    update(repoRoot,indicator,updatedFiles,warnings);
  }
  resolvePossibleConflicts(updatedFiles);
  return true;
}
