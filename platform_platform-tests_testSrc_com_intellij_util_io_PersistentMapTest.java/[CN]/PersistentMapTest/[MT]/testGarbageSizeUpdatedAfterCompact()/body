{
  final int stringsCount=5;
  Set<String> strings=new HashSet<>(stringsCount);
  for (int i=0; i < stringsCount; ++i) {
    final String key=createRandomString();
    strings.add(key);
    myMap.put(key,key + "_value");
  }
  for (  String string : strings) {
    myMap.remove(string);
  }
  strings.clear();
  for (int i=0; i < stringsCount; ++i) {
    final String key=createRandomString();
    strings.add(key);
    myMap.put(key,key + "_value");
  }
  myMap.close();
  final int garbageSizeOnClose=myMap.getGarbageSize();
  myMap=new PersistentHashMap<>(myFile,EnumeratorStringDescriptor.INSTANCE,EnumeratorStringDescriptor.INSTANCE);
  final int garbageSizeOnOpen=myMap.getGarbageSize();
  assertEquals(garbageSizeOnClose,garbageSizeOnOpen);
{
    final Collection<String> allKeys=new HashSet<>(myMap.getAllKeysWithExistingMapping());
    assertEquals(strings,allKeys);
    for (    String key : allKeys) {
      final String val=myMap.get(key);
      assertEquals(key + "_value",val);
    }
  }
  myMap.compact();
  assertEquals(0,myMap.getGarbageSize());
  myMap.close();
  myMap=new PersistentHashMap<>(myFile,EnumeratorStringDescriptor.INSTANCE,EnumeratorStringDescriptor.INSTANCE);
  final int garbageSizeAfterCompact=myMap.getGarbageSize();
  assertEquals(0,garbageSizeAfterCompact);
{
    final Collection<String> allKeys=new HashSet<>(myMap.getAllKeysWithExistingMapping());
    assertEquals(strings,allKeys);
    for (    String key : allKeys) {
      final String val=myMap.get(key);
      assertEquals(key + "_value",val);
    }
  }
}
