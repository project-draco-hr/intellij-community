{
  if (elt == null)   return null;
  PsiElement seeker=elt;
  PsiElement cap=getConcealingParent(elt);
  final boolean is_outside_param_list=PsiTreeUtil.getParentOfType(elt,PyParameterList.class) == null;
  do {
    ProgressManager.checkCanceled();
    if (!seeker.isValid())     return null;
    if (fromunder) {
      fromunder=false;
      seeker=getPrevNodeOf(PsiTreeUtil.getDeepestLast(seeker),processor);
    }
 else {
      seeker=getPrevNodeOf(seeker,processor);
    }
    if ((seeker instanceof NameDefiner) && ((NameDefiner)seeker).mustResolveOutside() && PsiTreeUtil.isAncestor(seeker,elt,true)) {
      seeker=getPrevNodeOf(seeker,processor);
    }
    while (true) {
      PsiElement local_cap=getConcealingParent(seeker);
      if (local_cap == null)       break;
      if (local_cap == cap)       break;
      if ((cap != null) && PsiTreeUtil.isAncestor(local_cap,cap,true))       break;
      if ((local_cap != elt) && ((cap == null) || !PsiTreeUtil.isAncestor(local_cap,cap,true))) {
        if (local_cap instanceof NameDefiner)         seeker=local_cap;
 else         seeker=getPrevNodeOf(local_cap,processor);
      }
 else       break;
    }
    if ((roof != null) && (seeker != null) && !PsiTreeUtil.isAncestor(roof,seeker,false))     return null;
    if (is_outside_param_list && refersFromMethodToClass(cap,seeker))     continue;
    if (seeker != null) {
      if (!processor.execute(seeker,ResolveState.initial())) {
        if (processor instanceof ResolveProcessor) {
          return ((ResolveProcessor)processor).getResult();
        }
 else         return seeker;
      }
    }
  }
 while (seeker != null);
  return null;
}
