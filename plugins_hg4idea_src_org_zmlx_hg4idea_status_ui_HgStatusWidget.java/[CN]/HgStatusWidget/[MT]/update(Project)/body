{
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    @Override public void run(){
      if ((project == null) || project.isDisposed()) {
        emptyTextAndTooltip();
        return;
      }
      final HgRepository repo=HgUtil.getCurrentRepository(project);
      if (repo == null) {
        emptyTextAndTooltip();
        return;
      }
      ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
        @Override public void run(){
          String bookmark=repo.getCurrentBookmark();
          final String branchOrBookMarkName=StringUtil.isEmptyOrSpaces(bookmark) ? repo.getCurrentBranch() : bookmark;
          final List<HgRevisionNumber> parents=new HgWorkingCopyRevisionsCommand(project).parents(repo.getRoot());
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            @Override public void run(){
              myCurrentBranchStatus.updateFor(branchOrBookMarkName,parents);
              myText=myCurrentBranchStatus.getStatusText();
              myTooltip=myCurrentBranchStatus.getToolTipText();
              int maxLength=MAX_STRING.length();
              myText=StringUtil.shortenTextWithEllipsis(myText,maxLength,5);
              if (!isDisposed() && myStatusBar != null) {
                myStatusBar.updateWidget(ID());
              }
            }
          }
);
        }
      }
);
    }
  }
);
}
