{
  FoldRegion[] allRegions=editor.getFoldingModel().getAllFoldRegions();
  if (caret == null) {
    caret=editor.getCaretModel().getPrimaryCaret();
  }
  if (caret.hasSelection()) {
    List<FoldRegion> result=new ArrayList<FoldRegion>(allRegions.length);
    for (    FoldRegion region : allRegions) {
      if (region.getStartOffset() >= caret.getSelectionStart() && region.getEndOffset() <= caret.getSelectionEnd()) {
        result.add(region);
      }
    }
    if (!result.isEmpty()) {
      return result;
    }
  }
  return Arrays.asList(allRegions);
}
