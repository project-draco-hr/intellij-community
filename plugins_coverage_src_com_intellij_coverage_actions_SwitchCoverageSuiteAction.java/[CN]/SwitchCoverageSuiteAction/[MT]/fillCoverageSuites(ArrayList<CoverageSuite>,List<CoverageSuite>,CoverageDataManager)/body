{
  final CoverageSuite[] suites=coverageManager.getSuites();
  final Map<String,List<BaseCoverageSuite>> grouped=new TreeMap<String,List<BaseCoverageSuite>>();
  for (  CoverageSuite suite : suites) {
    final CoverageFileProvider coverageFileProvider=((CoverageSuiteImpl)suite).getCoverageDataFileProvider();
    if (suite.isValid()) {
      final String sourceProvider=coverageFileProvider instanceof DefaultCoverageFileProvider ? ((DefaultCoverageFileProvider)coverageFileProvider).getSourceProvider() : coverageFileProvider.getClass().getName();
      List<BaseCoverageSuite> coverageSuiteList=grouped.get(sourceProvider);
      if (coverageSuiteList == null) {
        coverageSuiteList=new ArrayList<BaseCoverageSuite>();
        grouped.put(sourceProvider,coverageSuiteList);
      }
      coverageSuiteList.add(suite);
    }
  }
  final List<CoverageSuite> firstInGroup=new ArrayList<CoverageSuite>();
  for (  String provider : grouped.keySet()) {
    final List<BaseCoverageSuite> toSort=grouped.get(provider);
    if (toSort.isEmpty())     continue;
    Collections.sort(toSort,new Comparator<BaseCoverageSuite>(){
      public int compare(      final BaseCoverageSuite s1,      final BaseCoverageSuite s2){
        return s1.getPresentableName().compareToIgnoreCase(s2.getPresentableName());
      }
    }
);
    for (    BaseCoverageSuite suite : toSort) {
      model.add(suite);
    }
    firstInGroup.add(toSort.get(0));
  }
  model.add(null);
  final JList list=new JList(model);
  list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
  list.setCellRenderer(new MyCellRenderer(coverageManager){
    protected boolean hasSeparatorAbove(    final BaseCoverageSuite suite){
      return suite == null || (suite != model.getElementAt(0) && firstInGroup.contains(suite));
    }
  }
);
  final Runnable chosen=new Runnable(){
    public void run(){
      final BaseCoverageSuite suite=(BaseCoverageSuite)list.getSelectedValue();
      coverageManager.chooseSuite(suite);
    }
  }
;
  final JBPopup popup=new PopupChooserBuilder(list).setTitle(CodeInsightBundle.message("title.popup.show.coverage")).setMovable(true).setItemChoosenCallback(chosen).createPopup();
  list.registerKeyboardAction(new RemoveSuiteAction(list,coverageManager,model,popup,chosen),KeyStroke.getKeyStroke(KeyEvent.VK_DELETE,0),JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  popup.showCenteredInCurrentWindow(project);
}
