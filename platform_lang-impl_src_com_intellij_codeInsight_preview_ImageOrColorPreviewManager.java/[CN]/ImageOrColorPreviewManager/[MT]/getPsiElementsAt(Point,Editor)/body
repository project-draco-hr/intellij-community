{
  if (editor.isDisposed()) {
    return Collections.emptySet();
  }
  Project project=editor.getProject();
  if (project == null || project.isDisposed()) {
    return Collections.emptySet();
  }
  PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
  if (psiFile == null || psiFile instanceof PsiCompiledElement || !psiFile.isValid()) {
    return Collections.emptySet();
  }
  final Set<PsiElement> elements=new HashSet<PsiElement>();
  final int offset=editor.logicalPositionToOffset(editor.xyToLogicalPosition(point));
  ContainerUtil.addIfNotNull(elements,InjectedLanguageUtil.findElementAtNoCommit(psiFile,offset));
  for (  PsiFile file : psiFile.getViewProvider().getAllFiles()) {
    ContainerUtil.addIfNotNull(elements,file.findElementAt(offset));
  }
  return elements;
}
