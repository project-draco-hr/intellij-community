{
  int[] starts=editor.getSelectionModel().getBlockSelectionStarts();
  int[] ends=editor.getSelectionModel().getBlockSelectionEnds();
  final Document document=editor.getDocument();
  for (int i=starts.length - 1; i >= 0; i--) {
    final int start=starts[i];
    final int end=ends[i];
    String oldText=document.getText(new TextRange(start,end));
    final String newText=escape((XmlFile)file,oldText,start);
    if (!oldText.equals(newText)) {
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          document.replaceString(start,end,newText);
        }
      }
);
    }
  }
}
