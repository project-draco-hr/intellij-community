{
  boolean physical=!(myStorage instanceof MemoryIndexStorage) || !((MemoryIndexStorage)myStorage).isBufferingEnabled();
  Set<Key> newKeys=newData.keySet();
  if (DebugAssertions.DEBUG) {
    DebugAssertions.assertTrue(!physical == myIsBufferingMode.get());
  }
  if (myIsBufferingMode.get()) {
synchronized (myInMemoryKeys) {
      myInMemoryKeys.put(inputId,newKeys);
    }
  }
  if (myHasSnapshotMapping && physical) {
    myInputsSnapshotMapping.put(inputId,savedInputId);
  }
 else   if (myInputsIndex != null) {
    if (newKeys.size() > 0) {
      myInputsIndex.put(inputId,newKeys);
    }
 else {
      myInputsIndex.remove(inputId);
    }
  }
}
