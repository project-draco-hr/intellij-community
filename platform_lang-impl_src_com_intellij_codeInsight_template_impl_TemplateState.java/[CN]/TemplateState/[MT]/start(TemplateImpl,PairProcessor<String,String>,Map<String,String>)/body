{
  LOG.assertTrue(!myStarted,"Already started");
  myStarted=true;
  myTemplate=template;
  myProcessor=processor;
  DocumentReference[] refs=myDocument != null ? new DocumentReference[]{DocumentReferenceManager.getInstance().create(myDocument)} : null;
  UndoManager.getInstance(myProject).undoableActionPerformed(new BasicUndoableAction(refs){
    @Override public void undo(){
      if (myDocument != null) {
        fireTemplateCancelled();
        LookupManager.getInstance(myProject).hideActiveLookup();
        int oldVar=myCurrentVariableNumber;
        setCurrentVariableNumber(-1);
        currentVariableChanged(oldVar);
      }
    }
    @Override public void redo(){
    }
  }
);
  myTemplateIndented=false;
  myCurrentVariableNumber=-1;
  mySegments=new TemplateSegments(myEditor);
  myPredefinedVariableValues=predefinedVarValues;
  if (template.isInline()) {
    myPrevTemplate=myTemplate;
    int caretOffset=myEditor.getCaretModel().getOffset();
    myTemplateRange=myDocument.createRangeMarker(caretOffset,caretOffset + template.getTemplateText().length());
  }
 else {
    PsiFile file=getPsiFile();
    preprocessTemplate(file,myEditor.getCaretModel().getOffset());
    myPrevTemplate=myTemplate;
    LOG.assertTrue(!myTemplate.isInline(),"current template: " + presentTemplate(myTemplate) + ", previous template: "+ presentTemplate(myPrevTemplate));
    int caretOffset=myEditor.getCaretModel().getOffset();
    myTemplateRange=myDocument.createRangeMarker(caretOffset,caretOffset);
  }
  myTemplateRange.setGreedyToLeft(true);
  myTemplateRange.setGreedyToRight(true);
  processAllExpressions(myTemplate);
}
