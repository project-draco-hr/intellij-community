{
  myEditorDocumentListener=new DocumentAdapter(){
    @Override public void beforeDocumentChange(    DocumentEvent e){
      myDocumentChanged=true;
    }
  }
;
  myLookupListener=new LookupAdapter(){
    @Override public void itemSelected(    LookupEvent event){
      if (isCaretOutsideCurrentSegment()) {
        gotoEnd(true);
      }
    }
  }
;
  LookupManager.getInstance(myProject).addPropertyChangeListener(new PropertyChangeListener(){
    @Override public void propertyChange(    PropertyChangeEvent evt){
      if (LookupManager.PROP_ACTIVE_LOOKUP.equals(evt.getPropertyName())) {
        Lookup lookup=(Lookup)evt.getNewValue();
        if (lookup != null) {
          lookup.addLookupListener(myLookupListener);
        }
      }
    }
  }
,this);
  myCommandListener=new CommandAdapter(){
    boolean started=false;
    @Override public void commandStarted(    CommandEvent event){
      myDocumentChangesTerminateTemplate=isCaretOutsideCurrentSegment();
      started=true;
    }
    @Override public void beforeCommandFinished(    CommandEvent event){
      if (started && !isDisposed()) {
        Runnable runnable=new Runnable(){
          @Override public void run(){
            afterChangedUpdate();
          }
        }
;
        final LookupImpl lookup=myEditor != null ? (LookupImpl)LookupManager.getActiveLookup(myEditor) : null;
        if (lookup != null) {
          lookup.performGuardedChange(runnable);
        }
 else {
          runnable.run();
        }
      }
    }
  }
;
  myCaretListener=new CaretAdapter(){
    @Override public void caretAdded(    CaretEvent e){
      if (isMultiCaretMode()) {
        finishTemplateEditing();
      }
    }
    @Override public void caretRemoved(    CaretEvent e){
      if (isMultiCaretMode()) {
        finishTemplateEditing();
      }
    }
  }
;
  if (myEditor != null) {
    myEditor.getCaretModel().addCaretListener(myCaretListener);
  }
  myDocument.addDocumentListener(myEditorDocumentListener,this);
  CommandProcessor.getInstance().addCommandListener(myCommandListener,this);
}
