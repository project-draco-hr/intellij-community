{
  Project project=myEditor.getProject();
  if (project != null) {
    final FoldRegion[] regions=myEditor.getFoldingModel().getAllFoldRegions();
    final List<FoldRegionInfo> foldRegionsInfo=new ArrayList<FoldRegionInfo>();
    for (    FoldRegion region : regions) {
      final FoldRegionInfo info=new FoldRegionInfo(region.getStartOffset(),region.getEndOffset(),region.isExpanded());
      foldRegionsInfo.add(info);
    }
    final CodeFoldingManager foldingManager=CodeFoldingManager.getInstance(project);
    foldingManager.updateFoldRegions(myEditor);
    myEditor.getFoldingModel().runBatchFoldingOperation(new Runnable(){
      @Override public void run(){
        for (        FoldRegionInfo info : foldRegionsInfo) {
          final FoldRegion foldRegion=foldingManager.findFoldRegion(myEditor,info.myStart,info.myEnd);
          if (foldRegion != null) {
            foldRegion.setExpanded(info.myIsExpanded);
          }
        }
      }
    }
);
  }
}
