{
  final TextRange range=descriptor.getTextRangeInElement();
  PsiElement element=descriptor.getPsiElement();
  final PsiFile file=PsiTreeUtil.getParentOfType(element,PsiFile.class);
  if (file == null) {
    return;
  }
  final Document document=PsiDocumentManager.getInstance(project).getDocument(file);
  if (document == null) {
    return;
  }
  final int startOffset=range.getStartOffset();
  final int replaceStartOffset=element.getTextOffset() + startOffset;
  int startTag=range.getEndOffset();
  @NonNls String text=element.getText();
  if (!"<code>".equalsIgnoreCase(text.substring(startOffset,startTag))) {
    return;
  }
  @NonNls final StringBuilder newCommentText=new StringBuilder("{@code");
  int endTag=StringUtil.indexOfIgnoreCase(text,"</code>",startTag);
  while (endTag < 0) {
    appendElementText(text,startTag,text.length(),newCommentText);
    element=element.getNextSibling();
    if (element == null)     return;
    startTag=0;
    text=element.getText();
    endTag=StringUtil.indexOfIgnoreCase(text,"</code>",0);
  }
  appendElementText(text,startTag,endTag,newCommentText);
  newCommentText.append('}');
  final int replaceEndOffset=element.getTextOffset() + endTag + 7;
  final String oldText=document.getText(new TextRange(replaceStartOffset,replaceEndOffset));
  if (!StringUtil.startsWithIgnoreCase(oldText,"<code>") || !StringUtil.endsWithIgnoreCase(oldText,"</code>")) {
    return;
  }
  document.replaceString(replaceStartOffset,replaceEndOffset,newCommentText);
}
