{
  myProject=project;
  mySemService=semService;
  myConverterManager=converterManager;
  myApplicationComponent=appComponent;
  final PomModel pomModel=PomManager.getModel(project);
  pomModel.addModelListener(new PomModelListener(){
    public void modelChanged(    PomModelEvent event){
      if (myChanging)       return;
      final XmlChangeSet changeSet=(XmlChangeSet)event.getChangeSet(pomModel.getModelAspect(XmlAspect.class));
      if (changeSet != null) {
        for (        XmlFile file : changeSet.getChangedFiles()) {
          DomFileElementImpl<DomElement> element=getCachedFileElement(file);
          if (element != null) {
            fireEvent(new DomEvent(element,false));
          }
        }
      }
    }
    public boolean isAspectChangeInteresting(    PomModelAspect aspect){
      return aspect instanceof XmlAspect;
    }
  }
,project);
  Runnable setupVfsListeners=new Runnable(){
    public void run(){
      final VirtualFileAdapter listener=new VirtualFileAdapter(){
        private final List<DomEvent> myDeletionEvents=new SmartList<DomEvent>();
        public void contentsChanged(        @NotNull VirtualFileEvent event){
          if (event.isFromSave())           return;
          processVfsChange(event.getFile());
        }
        public void fileCreated(        @NotNull VirtualFileEvent event){
          processVfsChange(event.getFile());
        }
        public void beforeFileDeletion(        @NotNull final VirtualFileEvent event){
          if (!myProject.isDisposed()) {
            beforeFileDeletion(event.getFile());
          }
        }
        private void beforeFileDeletion(        final VirtualFile file){
          if (file.isDirectory() && file instanceof NewVirtualFile) {
            for (            final VirtualFile child : ((NewVirtualFile)file).getCachedChildren()) {
              beforeFileDeletion(child);
            }
            return;
          }
          if (file.isValid() && StdFileTypes.XML.equals(file.getFileType())) {
            final PsiFile psiFile=getCachedPsiFile(file);
            if (psiFile instanceof XmlFile) {
              Collections.addAll(myDeletionEvents,recomputeFileElement((XmlFile)psiFile));
            }
          }
        }
        public void fileDeleted(        @NotNull VirtualFileEvent event){
          if (!myDeletionEvents.isEmpty()) {
            if (!myProject.isDisposed()) {
              for (              DomEvent domEvent : myDeletionEvents) {
                fireEvent(domEvent);
              }
            }
            myDeletionEvents.clear();
          }
        }
        public void propertyChanged(        @NotNull VirtualFilePropertyEvent event){
          final VirtualFile file=event.getFile();
          if (!file.isDirectory() && VirtualFile.PROP_NAME.equals(event.getPropertyName())) {
            processVfsChange(file);
          }
        }
      }
;
      VirtualFileManager.getInstance().addVirtualFileListener(listener,myProject);
    }
  }
;
  StartupManager startupManager=StartupManager.getInstance(project);
  if (!((StartupManagerEx)startupManager).startupActivityPassed()) {
    startupManager.registerStartupActivity(setupVfsListeners);
  }
 else {
    setupVfsListeners.run();
  }
}
