{
  final PatchBaseDirectoryDetector directoryDetector=PatchBaseDirectoryDetector.getInstance(myProject);
  myUseProjectRootAsPredefinedBase=useProjectRootAsPredefinedBase;
  final List<PatchAndVariants> candidates=new ArrayList<PatchAndVariants>(list.size());
  final List<FilePatch> newOrWithoutMatches=new ArrayList<FilePatch>();
  findCandidates(list,directoryDetector,candidates,newOrWithoutMatches);
  final MultiMap<VirtualFile,AbstractFilePatchInProgress> result=new MultiMap<VirtualFile,AbstractFilePatchInProgress>();
  filterExactMatches(candidates,result);
  selectByContextOrByStrip(candidates,result);
  workWithNotExisting(directoryDetector,newOrWithoutMatches,result);
  return new ArrayList<AbstractFilePatchInProgress>(result.values());
}
