{
  final DiffViewerBase viewer=annotator.getViewer();
  final Project project=viewer.getProject();
  if (project == null)   return;
  AnnotationData data=annotator.getDataFromCache();
  if (data != null) {
    annotator.showAnnotation(data);
    return;
  }
  final FileAnnotationLoader loader=annotator.createAnnotationsLoader();
  if (loader == null)   return;
  final DiffContextEx diffContext=ObjectUtils.tryCast(viewer.getContext(),DiffContextEx.class);
  annotator.getBackgroundableLock().lock();
  if (diffContext != null)   diffContext.showProgressBar(true);
  BackgroundTaskUtil.executeOnPooledThread(new Consumer<ProgressIndicator>(){
    @Override public void consume(    ProgressIndicator indicator){
      try {
        loader.run();
      }
  finally {
        ApplicationManager.getApplication().invokeLater(new Runnable(){
          @Override public void run(){
            if (diffContext != null)             diffContext.showProgressBar(false);
            annotator.getBackgroundableLock().unlock();
            VcsException exception=loader.getException();
            if (exception != null) {
              Notification notification=VcsNotifier.IMPORTANT_ERROR_NOTIFICATION.createNotification("Can't Load Annotations",exception.getMessage(),NotificationType.ERROR,null);
              showNotification(viewer,notification);
              LOG.warn(exception);
              return;
            }
            if (loader.getResult() == null)             return;
            if (loader.shouldCache()) {
              annotator.putDataToCache(loader.getResult());
            }
            if (viewer.isDisposed())             return;
            annotator.showAnnotation(loader.getResult());
          }
        }
,indicator.getModalityState());
      }
    }
  }
,viewer);
}
