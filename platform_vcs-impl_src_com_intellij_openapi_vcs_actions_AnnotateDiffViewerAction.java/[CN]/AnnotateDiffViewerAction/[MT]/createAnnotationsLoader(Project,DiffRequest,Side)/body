{
  Change change=request.getUserData(ChangeDiffRequestProducer.CHANGE_KEY);
  if (change != null) {
    ContentRevision revision=side.select(change.getBeforeRevision(),change.getAfterRevision());
    if (revision != null) {
      AbstractVcs vcs=ChangesUtil.getVcsForChange(change,project);
      if (revision instanceof CurrentContentRevision) {
        VirtualFile file=((CurrentContentRevision)revision).getVirtualFile();
        FileAnnotationLoader loader=doCreateAnnotationsLoader(project,vcs,file);
        if (loader != null)         return loader;
      }
 else {
        FileAnnotationLoader loader=doCreateAnnotationsLoader(vcs,revision.getFile(),revision.getRevisionNumber());
        if (loader != null)         return loader;
      }
    }
  }
  if (request instanceof ContentDiffRequest) {
    ContentDiffRequest requestEx=(ContentDiffRequest)request;
    if (requestEx.getContents().size() == 2) {
      DiffContent content=side.select(requestEx.getContents());
      if (content instanceof FileContent) {
        VirtualFile file=((FileContent)content).getFile();
        AbstractVcs vcs=VcsUtil.getVcsFor(project,file);
        FileAnnotationLoader loader=doCreateAnnotationsLoader(project,vcs,file);
        if (loader != null)         return loader;
      }
      Pair<FilePath,VcsRevisionNumber> info=content.getUserData(VcsHistoryUtil.REVISION_INFO_KEY);
      if (info != null) {
        FilePath filePath=info.first;
        AbstractVcs vcs=VcsUtil.getVcsFor(project,filePath);
        FileAnnotationLoader loader=doCreateAnnotationsLoader(vcs,filePath,info.second);
        if (loader != null)         return loader;
      }
    }
  }
  return null;
}
