{
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    @Override public void run(){
      final Module[] modules=myModuleManager.getModules();
      if (ProjectUtil.isDirectoryBased(myProject)) {
        FilePath fp=VcsUtil.getFilePath(myBaseDir,Project.DIRECTORY_STORE_FOLDER,true);
        final AbstractVcs vcs=vcsGuess.getVcsForDirty(fp);
        if (vcs != null) {
          builder.addDirtyDirRecursively(new FilePathUnderVcs(fp,vcs));
        }
      }
      for (      Module module : modules) {
        final VirtualFile[] files=ModuleRootManager.getInstance(module).getContentRoots();
        for (        VirtualFile file : files) {
          final AbstractVcs vcs=vcsGuess.getVcsForDirty(file);
          if (vcs != null) {
            builder.addDirtyDirRecursively(new FilePathUnderVcs(VcsUtil.getFilePath(file),vcs));
          }
        }
      }
      final ProjectLevelVcsManager plVcsManager=ProjectLevelVcsManager.getInstance(myProject);
      final String defaultMapping=((ProjectLevelVcsManagerEx)plVcsManager).haveDefaultMapping();
      final boolean haveDefaultMapping=(defaultMapping != null) && (!defaultMapping.isEmpty());
      if (haveDefaultMapping && (myBaseDir != null)) {
        final AbstractVcs vcs=vcsGuess.getVcsForDirty(myBaseDir);
        if (vcs != null) {
          builder.addDirtyFile(new FilePathUnderVcs(VcsUtil.getFilePath(myBaseDir),vcs));
        }
      }
    }
  }
);
}
