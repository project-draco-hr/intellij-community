{
  return PostprocessReformattingAspect.getInstance(project).postponeFormattingInside(new Computable<PsiElement>(){
    public PsiElement compute(){
      return ApplicationManager.getApplication().runWriteAction(new Computable<PsiElement>(){
        public PsiElement compute(){
          try {
            IdeDocumentHistory.getInstance(project).includeCurrentPlaceAsChangePlace();
            PsiClass targetClass=createTestClass(d);
            if (targetClass == null) {
              return null;
            }
            addSuperClass(targetClass,project,d.getSuperClassName());
            Editor editor=CodeInsightUtil.positionCursor(project,targetClass.getContainingFile(),targetClass.getLBrace());
            addTestMethods(editor,targetClass,d.getSelectedTestFrameworkDescriptor(),d.getSelectedMethods(),d.shouldGeneratedBefore(),d.shouldGeneratedAfter());
            return targetClass;
          }
 catch (          IncorrectOperationException e) {
            showErrorLater(project,d.getClassName());
            return null;
          }
        }
      }
);
    }
  }
);
}
