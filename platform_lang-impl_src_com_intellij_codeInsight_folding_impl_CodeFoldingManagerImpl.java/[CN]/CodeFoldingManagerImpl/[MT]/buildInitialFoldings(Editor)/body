{
  ApplicationManagerEx.getApplicationEx().assertIsDispatchThread();
  final Project project=editor.getProject();
  if (project == null || !project.equals(myProject))   return;
  final Document document=editor.getDocument();
  final PsiFile file=PsiDocumentManager.getInstance(myProject).getPsiFile(document);
  if (file == null || !file.getViewProvider().isPhysical() && !ApplicationManager.getApplication().isUnitTestMode())   return;
  final FoldingModelEx foldingModel=(FoldingModelEx)editor.getFoldingModel();
  if (!foldingModel.isFoldingEnabled())   return;
  if (project.isDisposed() || editor.isDisposed() || !file.isValid())   return;
  if (EditorUtil.supportsDumbModeFolding(editor)) {
    PsiDocumentManager.getInstance(myProject).commitDocument(document);
    createInitFoldingAction(updateFoldRegions(editor,true,true),editor).run();
  }
}
