{
  final Project project=e.getProject();
  if (project == null)   return;
  List<Language> languages=getLanguages();
  if (languages.isEmpty())   return;
  BaseListPopupStep<Language> step=new BaseListPopupStep<Language>("Specify the language",languages){
    @NotNull @Override public String getTextFor(    Language value){
      return value.getDisplayName();
    }
    @Override public String getIndexedString(    Language value){
      return value.getDisplayName();
    }
    @Override public boolean isSpeedSearchEnabled(){
      return true;
    }
    @Override public PopupStep onChosen(    Language selectedValue,    boolean finalChoice){
      doAction(project,selectedValue);
      return null;
    }
    @Override public Icon getIconFor(    Language language){
      LanguageFileType associatedLanguage=language.getAssociatedFileType();
      return associatedLanguage != null ? associatedLanguage.getIcon() : null;
    }
  }
;
  Language previous=ScratchpadManager.getInstance(project).getLatestLanguage();
  final String previousName=previous != null ? previous.getDisplayName() : "Plain text";
  if (previousName != null) {
    int defaultOption=ContainerUtil.indexOf(languages,new Condition<Language>(){
      @Override public boolean value(      Language module){
        return module.getDisplayName().equals(previousName);
      }
    }
);
    if (defaultOption >= 0) {
      step.setDefaultOptionIndex(defaultOption);
    }
  }
  ListPopup popup=JBPopupFactory.getInstance().createListPopup(step);
  int nameLen=0;
  for (  Language language : languages) {
    nameLen=Math.max(nameLen,language.getDisplayName().length());
  }
  if (languages.size() > MAX_VISIBLE_SIZE) {
    Dimension size=new JLabel(StringUtil.repeatSymbol('a',nameLen),EmptyIcon.ICON_16,SwingConstants.LEFT).getMinimumSize();
    size.height*=MAX_VISIBLE_SIZE;
    popup.setSize(size);
  }
  popup.showCenteredInCurrentWindow(project);
}
