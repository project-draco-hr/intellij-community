{
  super(project);
  myProject=project;
  myFile=file;
  myDocument=document;
  myActiveVcs=vcs;
  mySelectionStart=selectionStart;
  mySelectionEnd=selectionEnd;
  myHelpId=notNull(vcsHistoryProvider.getHelpId(),"reference.dialogs.vcs.selection.history");
  myComments=new JEditorPane(UIUtil.HTML_MIME,"");
  myComments.setPreferredSize(new Dimension(150,100));
  myComments.setEditable(false);
  myComments.addHyperlinkListener(BrowserHyperlinkListener.INSTANCE);
  JRootPane rootPane=((RootPaneContainer)getFrame()).getRootPane();
  final VcsDependentHistoryComponents components=vcsHistoryProvider.getUICustomization(session,rootPane);
  ColumnInfo[] defaultColumns=new ColumnInfo[]{new FileHistoryPanelImpl.RevisionColumnInfo(null),new FileHistoryPanelImpl.DateColumnInfo(),new FileHistoryPanelImpl.AuthorColumnInfo(),new FileHistoryPanelImpl.MessageColumnInfo(project)};
  ColumnInfo[] additionalColumns=notNull(components.getColumns(),ColumnInfo.EMPTY_ARRAY);
  myListModel=new ListTableModel<VcsFileRevision>(ArrayUtil.mergeArrays(defaultColumns,additionalColumns));
  myListModel.setSortable(false);
  myList=new TableView<VcsFileRevision>(myListModel);
  new TableLinkMouseListener().installOn(myList);
  myList.getEmptyText().setText(VcsBundle.message("history.empty"));
  myDiffPanel=DiffManager.getInstance().createRequestPanel(myProject,this,getFrame());
  myCurrentRevision=new CurrentRevision(file,LOCAL_REVISION_NUMBER);
  myRevisions.add(myCurrentRevision);
  myRevisions.addAll(session.getRevisionList());
  myBlocks.addAll(Collections.<Block>nCopies(myRevisions.size(),null));
  mySplitter=new JBSplitter(true,DIFF_SPLITTER_PROPORTION_KEY,DIFF_SPLITTER_PROPORTION);
  mySplitter.setFirstComponent(myDiffPanel.getComponent());
  mySplitter.setSecondComponent(createBottomPanel(components.getDetailsComponent()));
  final ListSelectionListener selectionListener=new ListSelectionListener(){
    @Override public void valueChanged(    ListSelectionEvent e){
      final VcsFileRevision revision;
      if (myList.getSelectedRowCount() == 1 && !myList.isEmpty()) {
        revision=myList.getItems().get(myList.getSelectedRow());
        String message=IssueLinkHtmlRenderer.formatTextIntoHtml(myProject,revision.getCommitMessage());
        myComments.setText(message);
        myComments.setCaretPosition(0);
      }
 else {
        revision=null;
        myComments.setText("");
      }
      if (components.getRevisionListener() != null) {
        components.getRevisionListener().consume(revision);
      }
      updateDiff();
    }
  }
;
  myList.getSelectionModel().addListSelectionListener(selectionListener);
  final VcsConfiguration configuration=VcsConfiguration.getInstance(myProject);
  myChangesOnlyCheckBox.setSelected(configuration.SHOW_ONLY_CHANGED_IN_SELECTION_DIFF);
  myChangesOnlyCheckBox.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      configuration.SHOW_ONLY_CHANGED_IN_SELECTION_DIFF=myChangesOnlyCheckBox.isSelected();
      updateRevisionsList();
    }
  }
);
  updateRevisionsList();
  myList.getSelectionModel().setSelectionInterval(0,0);
  final DefaultActionGroup popupActions=new DefaultActionGroup();
  popupActions.add(new MyDiffAction());
  popupActions.add(new MyDiffLocalAction());
  popupActions.add(ShowAllAffectedGenericAction.getInstance());
  popupActions.add(ActionManager.getInstance().getAction(VcsActions.ACTION_COPY_REVISION_NUMBER));
  PopupHandler.installPopupHandler(myList,popupActions,ActionPlaces.UPDATE_POPUP,ActionManager.getInstance());
  for (  AnAction action : popupActions.getChildren(null)) {
    action.registerCustomShortcutSet(action.getShortcutSet(),mySplitter);
  }
  setTitle(title);
  setComponent(mySplitter);
  setPreferredFocusedComponent(myList);
  setDimensionKey("VCS.FileHistoryDialog");
  closeOnEsc();
}
