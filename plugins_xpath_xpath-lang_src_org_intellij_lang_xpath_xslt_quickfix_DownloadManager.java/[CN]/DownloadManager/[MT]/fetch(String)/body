{
  if (resourceManager.getResourceLocation(location,myProject) != location) {
    return;
  }
  myProgress.setText("Downloading " + location);
  File file=null;
  try {
    file=HttpRequests.request(location).connect(new HttpRequests.RequestProcessor<File>(){
      @Override public File process(      @NotNull HttpRequests.Request request) throws IOException {
        String name=Integer.toHexString(System.identityHashCode(this)) + "_" + Integer.toHexString(location.hashCode())+ "_"+ location.substring(location.lastIndexOf('/') + 1);
        return request.saveToFile(new File(myResourcePath,name.lastIndexOf('.') == -1 ? name + ".xml" : name),myProgress);
      }
    }
);
    try {
      final File _file=file;
      final Set<String>[] resourceDependencies=new Set[1];
      new WriteAction(){
        @Override protected void run(        @NotNull Result result) throws Throwable {
          final VirtualFile vf=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(_file);
          if (vf != null) {
            final PsiFile psiFile=PsiManager.getInstance(myProject).findFile(vf);
            if (psiFile != null && isAccepted(psiFile)) {
              resourceDependencies[0]=getResourceDependencies(psiFile);
              resourceManager.addResource(location,_file.getAbsolutePath());
            }
 else {
              ApplicationManager.getApplication().invokeLater(new Runnable(){
                @Override public void run(){
                  Messages.showErrorDialog(myProject,"Not a valid file: " + vf.getPresentableUrl(),"Download Problem");
                }
              }
,myProject.getDisposed());
            }
          }
        }
      }
.execute();
      if (resourceDependencies[0] != null) {
        for (        String s : resourceDependencies[0]) {
          myProgress.checkCanceled();
          myProgress.setFraction(0);
          fetch(s);
        }
      }
    }
 catch (    Error err) {
      Throwable e=err.getCause();
      if (e instanceof InvocationTargetException) {
        Throwable targetException=((InvocationTargetException)e).getTargetException();
        if (targetException instanceof RuntimeException) {
          throw (RuntimeException)targetException;
        }
 else         if (targetException instanceof IOException) {
          throw (IOException)targetException;
        }
 else         if (!(targetException instanceof InterruptedException)) {
          Logger.getInstance(getClass().getName()).error(e);
        }
      }
 else       if (!(e instanceof InterruptedException)) {
        throw err;
      }
    }
  }
 catch (  IOException e) {
    throw new DownloadException(location,e);
  }
 finally {
    if (file != null && resourceManager.getResourceLocation(location,myProject) == location) {
      FileUtil.delete(file);
    }
  }
}
