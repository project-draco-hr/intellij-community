{
  Map<VirtualFile,Collection<VirtualFile>> sorted=new HashMap<VirtualFile,Collection<VirtualFile>>();
  HgRepositoryManager repositoryManager=getRepositoryManager(project);
  for (  VirtualFile file : files) {
    HgRepository repo=repositoryManager.getRepositoryForFile(file);
    if (repo == null) {
      continue;
    }
    Collection<VirtualFile> filesForRoot=sorted.get(repo.getRoot());
    if (filesForRoot == null) {
      filesForRoot=new HashSet<VirtualFile>();
      sorted.put(repo.getRoot(),filesForRoot);
    }
    filesForRoot.add(file);
  }
  return sorted;
}
