{
  Map<VirtualFile,Collection<FilePath>> sorted=new HashMap<VirtualFile,Collection<FilePath>>();
  if (project.isDisposed())   return sorted;
  HgRepositoryManager repositoryManager=getRepositoryManager(project);
  for (  FilePath file : files) {
    HgRepository repo=repositoryManager.getRepositoryForFile(file);
    if (repo == null) {
      continue;
    }
    Collection<FilePath> filesForRoot=sorted.get(repo.getRoot());
    if (filesForRoot == null) {
      filesForRoot=new HashSet<FilePath>();
      sorted.put(repo.getRoot(),filesForRoot);
    }
    filesForRoot.add(file);
  }
  return sorted;
}
