{
  final SelectionModel selectionModel=editor.getSelectionModel();
  if (!selectionModel.hasSelection()) {
    final int offset=editor.getCaretModel().getOffset();
    final PsiElement[] statementsInRange=findStatementsAtOffset(editor,file,offset);
    if (statementsInRange.length == 1 && selectLineAtCaret(offset,statementsInRange)) {
      selectionModel.selectLineAtCaret();
      final PsiExpression expressionInRange=findExpressionInRange(project,file,selectionModel.getSelectionStart(),selectionModel.getSelectionEnd());
      if (expressionInRange == null || getErrorMessage(expressionInRange) != null) {
        selectionModel.removeSelection();
      }
    }
    if (!selectionModel.hasSelection()) {
      final List<PsiExpression> expressions=collectExpressions(file,editor,offset);
      if (expressions.isEmpty()) {
        selectionModel.selectLineAtCaret();
      }
 else       if (!isChooserNeeded(expressions)) {
        final TextRange textRange=expressions.get(0).getTextRange();
        selectionModel.setSelection(textRange.getStartOffset(),textRange.getEndOffset());
      }
 else {
        IntroduceTargetChooser.showChooser(editor,expressions,new Pass<PsiExpression>(){
          public void pass(          final PsiExpression selectedValue){
            invoke(project,editor,file,selectedValue.getTextRange().getStartOffset(),selectedValue.getTextRange().getEndOffset());
          }
        }
,new PsiExpressionTrimRenderer.RenderFunction(),"Expressions",preferredSelection(statementsInRange,expressions),ScopeHighlighter.NATURAL_RANGER);
        return;
      }
    }
  }
  if (invoke(project,editor,file,selectionModel.getSelectionStart(),selectionModel.getSelectionEnd()) && LookupManager.getActiveLookup(editor) == null) {
    selectionModel.removeSelection();
  }
}
