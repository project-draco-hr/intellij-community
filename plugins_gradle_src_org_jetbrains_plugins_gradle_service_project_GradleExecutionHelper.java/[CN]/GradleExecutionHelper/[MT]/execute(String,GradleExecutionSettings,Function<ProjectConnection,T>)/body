{
  final String projectDir;
  final File projectPathFile=new File(projectPath);
  if (projectPathFile.isFile() && projectPath.endsWith(GradleConstants.EXTENSION) && projectPathFile.getParent() != null) {
    projectDir=projectPathFile.getParent();
  }
 else {
    projectDir=projectPath;
  }
  String userDir=null;
  if (!GradleEnvironment.ADJUST_USER_DIR) {
    try {
      userDir=System.getProperty("user.dir");
      if (userDir != null)       System.setProperty("user.dir",projectDir);
    }
 catch (    Exception ignore) {
    }
  }
  ProjectConnection connection=getConnection(projectDir,settings);
  try {
    return f.fun(connection);
  }
 catch (  ExternalSystemException e) {
    throw e;
  }
catch (  Throwable e) {
    LOG.debug("Gradle execution error",e);
    Throwable rootCause=ExceptionUtil.getRootCause(e);
    throw new ExternalSystemException(ExceptionUtil.getMessage(rootCause));
  }
 finally {
    try {
      connection.close();
      if (userDir != null) {
        System.setProperty("user.dir",userDir);
      }
    }
 catch (    Throwable e) {
      LOG.debug("Gradle connection close error",e);
    }
  }
}
