{
  if (showFlatten) {
    return rootNode;
  }
  if (policy != null) {
    ChangesBrowserNode nodeFromPolicy=policy.getParentNodeFor(nodePath,rootNode);
    if (nodeFromPolicy != null) {
      return nodeFromPolicy;
    }
  }
  final StaticFilePath parentPath=nodePath.getParent();
  if (parentPath == null) {
    return rootNode;
  }
  ChangesBrowserNode parentNode=myFoldersCache.get(parentPath.getKey());
  if (parentNode == null) {
    FilePath filePath=parentPath.getVf() == null ? VcsUtil.getFilePath(parentPath.getPath(),true) : VcsUtil.getFilePath(parentPath.getVf());
    parentNode=ChangesBrowserNode.create(myProject,filePath);
    ChangesBrowserNode grandPa=getParentNodeFor(parentPath,policy,rootNode);
    model.insertNodeInto(parentNode,grandPa,grandPa.getChildCount());
    myFoldersCache.put(parentPath.getKey(),parentNode);
  }
  return parentNode;
}
