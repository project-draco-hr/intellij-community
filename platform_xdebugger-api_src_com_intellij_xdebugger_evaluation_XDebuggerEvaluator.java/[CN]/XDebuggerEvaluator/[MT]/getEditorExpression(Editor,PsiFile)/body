{
  String text=editor.getSelectionModel().getSelectedText();
  if (text != null) {
    text=formatTextForEvaluation(text);
  }
 else   if (editor.getProject() != null) {
    Document document=editor.getDocument();
    ExpressionInfo info=getExpressionInfoAtOffset(editor.getProject(),document,editor.getCaretModel().getOffset(),true);
    if (info != null) {
      text=info.getExpressionText();
      if (text == null) {
        text=document.getText(info.getTextRange());
      }
    }
  }
  if (!StringUtil.isEmpty(text)) {
    return XDebuggerUtil.getInstance().createExpression(text,null,null,text.contains("\n") ? EvaluationMode.CODE_FRAGMENT : EvaluationMode.EXPRESSION);
  }
  return null;
}
