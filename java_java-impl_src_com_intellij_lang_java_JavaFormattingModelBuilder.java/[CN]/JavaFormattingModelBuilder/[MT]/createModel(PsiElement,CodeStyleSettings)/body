{
  final FileElement fileElement=TreeUtil.getFileElement((TreeElement)SourceTreeToPsiMap.psiElementToTree(element));
  LOG.assertTrue(fileElement != null,"File element should not be null for " + element);
  CommonCodeStyleSettings commonSettings=settings.getCommonSettings(JavaLanguage.INSTANCE);
  JavaCodeStyleSettings customJavaSettings=settings.getCustomSettings(JavaCodeStyleSettings.class);
  Block block=AbstractJavaBlock.createJavaBlock(fileElement,commonSettings,customJavaSettings);
  FormattingDocumentModelImpl model=FormattingDocumentModelImpl.createOn(element.getContainingFile());
  return new PsiBasedFormatterModelWithShiftIndentInside(element.getContainingFile(),block,model);
}
