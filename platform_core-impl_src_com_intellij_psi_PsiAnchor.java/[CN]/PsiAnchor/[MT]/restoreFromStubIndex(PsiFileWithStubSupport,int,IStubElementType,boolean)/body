{
  if (fileImpl == null) {
    if (throwIfNull)     throw new AssertionError("Null file");
    return null;
  }
  StubTree tree=fileImpl.getStubTree();
  if (tree == null) {
    if (fileImpl instanceof PsiFileImpl) {
      tree=((PsiFileImpl)fileImpl).calcStubTree();
    }
 else {
      if (throwIfNull)       throw new AssertionError("Not PsiFileImpl: " + fileImpl.getClass());
      return null;
    }
  }
  List<StubElement<?>> list=tree.getPlainList();
  if (index >= list.size()) {
    if (throwIfNull)     throw new AssertionError("Too large index: " + index + ">="+ list.size());
    return null;
  }
  StubElement stub=list.get(index);
  if (stub.getStubType() != elementType) {
    if (throwIfNull)     throw new AssertionError("Element type mismatch: " + stub.getStubType() + "!="+ elementType);
    return null;
  }
  return stub.getPsi();
}
