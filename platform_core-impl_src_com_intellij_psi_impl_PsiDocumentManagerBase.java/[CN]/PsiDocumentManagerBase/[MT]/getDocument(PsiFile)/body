{
  if (file instanceof PsiBinaryFile)   return null;
  Document document=getCachedDocument(file);
  if (document != null) {
    if (!file.getViewProvider().isPhysical() && document.getUserData(HARD_REF_TO_PSI) == null) {
      cachePsi(document,file);
    }
    return document;
  }
  FileViewProvider viewProvider=file.getViewProvider();
  if (!viewProvider.isEventSystemEnabled())   return null;
  document=FileDocumentManager.getInstance().getDocument(viewProvider.getVirtualFile());
  if (document != null) {
    if (document.getTextLength() != file.getTextLength()) {
      throw new AssertionError("Modified PSI with no document: " + file + "; physical="+ viewProvider.isPhysical()+ "; BFD="+ BinaryFileTypeDecompilers.INSTANCE.forFileType(file.getFileType()));
    }
    if (!viewProvider.isPhysical()) {
      cachePsi(document,file);
    }
  }
  return document;
}
