{
  final CharSequence prevText=myLastCommittedTexts.remove(document);
  if (prevText == null) {
    return;
  }
  if (!myProject.isInitialized() || myProject.isDisposed()) {
    return;
  }
  VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(document);
  if (virtualFile == null || !FileIndexFacade.getInstance(myProject).isInContent(virtualFile)) {
    return;
  }
  final PsiFile psiFile=getPsiFile(document);
  if (psiFile == null) {
    return;
  }
  ApplicationManager.getApplication().runWriteAction(new ExternalChangeAction(){
    @Override public void run(){
      psiFile.getViewProvider().beforeContentsSynchronized();
synchronized (PsiLock.LOCK) {
        final int oldLength=prevText.length();
        PsiManagerImpl manager=(PsiManagerImpl)psiFile.getManager();
        BlockSupportImpl.sendBeforeChildrenChangeEvent(manager,psiFile,true);
        BlockSupportImpl.sendBeforeChildrenChangeEvent(manager,psiFile,false);
        if (psiFile instanceof PsiFileImpl) {
          ((PsiFileImpl)psiFile).onContentReload();
        }
        BlockSupportImpl.sendAfterChildrenChangedEvent(manager,psiFile,oldLength,false);
        BlockSupportImpl.sendAfterChildrenChangedEvent(manager,psiFile,oldLength,true);
      }
      psiFile.getViewProvider().contentsSynchronized();
    }
  }
);
}
