{
  return new FutureTask<Boolean>(new Callable<Boolean>(){
    private Document myDocument;
    @Override public Boolean call() throws Exception {
      FormattingProgressTask.FORMATTING_CANCELLED_FLAG.set(false);
      try {
        Collection<TextRange> ranges=getRangesToFormat(processChangedTextOnly,file);
        CharSequence before=null;
        if (isSingleFileProcessed()) {
          myDocument=PsiDocumentManager.getInstance(myProject).getDocument(file);
          LOG.assertTrue(myDocument != null);
          before=myDocument.getImmutableCharSequence();
        }
        CodeStyleManager.getInstance(myProject).reformatText(file,ranges);
        if (before != null) {
          prepareUserNotificationMessage(myDocument,before);
        }
        return !FormattingProgressTask.FORMATTING_CANCELLED_FLAG.get();
      }
 catch (      FilesTooBigForDiffException e) {
        handleFileTooBigException(LOG,e,file);
        return false;
      }
catch (      IncorrectOperationException e) {
        LOG.error(e);
        return false;
      }
 finally {
        myRanges.clear();
      }
    }
  }
);
}
