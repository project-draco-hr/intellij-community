{
  PsiElement elementAtSelectionStart=file.findElementAt(selectionStart);
  if (elementAtSelectionStart == null) {
    return null;
  }
  IElementType elementType=elementAtSelectionStart.getNode().getElementType();
  if ((elementType == GroovyTokenTypes.mREGEX_END || elementType == GroovyTokenTypes.mDOLLAR_SLASH_REGEX_END || elementType == GroovyTokenTypes.mGSTRING_END) && elementAtSelectionStart.getTextOffset() == selectionStart) {
    elementAtSelectionStart=elementAtSelectionStart.getPrevSibling();
    if (elementAtSelectionStart == null)     return null;
    elementType=elementAtSelectionStart.getNode().getElementType();
  }
  if (elementType == GroovyTokenTypes.mDOLLAR) {
    elementAtSelectionStart=elementAtSelectionStart.getParent();
    elementType=elementAtSelectionStart.getNode().getElementType();
  }
  if (!isStringLiteral(elementAtSelectionStart)) {
    return null;
  }
  if (elementAtSelectionStart.getTextRange().getEndOffset() < selectionEnd) {
    final PsiElement elementAtSelectionEnd=file.findElementAt(selectionEnd);
    if (elementAtSelectionEnd == null) {
      return null;
    }
    if (elementAtSelectionEnd.getNode().getElementType() == elementType && elementAtSelectionEnd.getTextRange().getStartOffset() < selectionEnd) {
      return elementAtSelectionStart;
    }
  }
  final TextRange textRange=elementAtSelectionStart.getTextRange();
  if (elementType == GroovyTokenTypes.mREGEX_CONTENT || elementType == GroovyTokenTypes.mGSTRING_CONTENT || elementType == GroovyTokenTypes.mDOLLAR_SLASH_REGEX_CONTENT || elementType == GroovyElementTypes.GSTRING_INJECTION) {
    selectionStart++;
    selectionEnd--;
  }
  if (textRange.getLength() > 0 && (selectionStart <= textRange.getStartOffset() || selectionEnd >= textRange.getEndOffset())) {
    return null;
  }
  if (elementType == GroovyElementTypes.GSTRING_CONTENT) {
    elementAtSelectionStart=elementAtSelectionStart.getFirstChild();
  }
  return elementAtSelectionStart;
}
