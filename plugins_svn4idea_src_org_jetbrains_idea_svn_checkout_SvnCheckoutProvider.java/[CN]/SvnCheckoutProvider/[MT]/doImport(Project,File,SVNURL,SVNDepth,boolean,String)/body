{
  final Ref<String> errorMessage=new Ref<String>();
  final SVNCommitClient client=SvnVcs.getInstance(project).createCommitClient();
  final String targetPath=FileUtil.toSystemIndependentName(target.getAbsolutePath());
  ExclusiveBackgroundVcsAction.run(project,new Runnable(){
    public void run(){
      ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
        public void run(){
          final FileIndexFacade facade=PeriodicalTasksCloser.getInstance().safeGetService(project,FileIndexFacade.class);
          ProgressIndicator progressIndicator=ProgressManager.getInstance().getProgressIndicator();
          client.setEventHandler(new IdeaCommitHandler(progressIndicator));
          try {
            progressIndicator.setText(SvnBundle.message("progress.text.import",target.getAbsolutePath()));
            final VirtualFile targetVf=SvnUtil.getVirtualFile(targetPath);
            if (targetVf == null) {
              errorMessage.set("Can not find file: " + targetPath);
            }
 else {
              final boolean isInContent=ApplicationManager.getApplication().runReadAction(new Computable<Boolean>(){
                @Override public Boolean compute(){
                  return facade.isInContent(targetVf);
                }
              }
);
              SVNCommitInfo info;
              if (project.isDefault() || !isInContent) {
                info=client.doImport(target,url,message,null,!includeIgnored,false,depth);
              }
 else {
                client.setCommitHandler(new MyFilter(LocalFileSystem.getInstance(),new SvnExcludingIgnoredOperation.Filter(project)));
                info=client.doImport(target,url,message,null,!includeIgnored,false,depth);
              }
              if (info.getNewRevision() > 0) {
                StatusBar.Info.set(SvnBundle.message("status.text.comitted.revision",info.getNewRevision()),project);
              }
            }
          }
 catch (          SVNException e) {
            errorMessage.set(e.getMessage());
          }
 finally {
            client.setIgnoreExternals(false);
            client.setEventHandler(null);
          }
        }
      }
,SvnBundle.message("message.title.import"),true,project);
    }
  }
);
  if (!errorMessage.isNull()) {
    Messages.showErrorDialog(SvnBundle.message("message.text.cannot.import",errorMessage.get()),SvnBundle.message("message.title.import"));
  }
}
