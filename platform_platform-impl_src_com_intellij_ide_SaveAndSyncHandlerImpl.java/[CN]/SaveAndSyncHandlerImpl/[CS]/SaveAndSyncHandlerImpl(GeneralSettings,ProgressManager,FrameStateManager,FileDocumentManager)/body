{
  mySettings=generalSettings;
  myProgressManager=progressManager;
  myIdleListener=new Runnable(){
    @Override public void run(){
      if (mySettings.isAutoSaveIfInactive() && canSyncOrSave()) {
        ((FileDocumentManagerImpl)fileDocumentManager).saveAllDocuments(false);
      }
    }
  }
;
  IdeEventQueue.getInstance().addIdleListener(myIdleListener,mySettings.getInactiveTimeout() * 1000);
  myGeneralSettingsListener=new PropertyChangeListener(){
    @Override public void propertyChange(    @NotNull PropertyChangeEvent e){
      if (GeneralSettings.PROP_INACTIVE_TIMEOUT.equals(e.getPropertyName())) {
        IdeEventQueue eventQueue=IdeEventQueue.getInstance();
        eventQueue.removeIdleListener(myIdleListener);
        Integer timeout=(Integer)e.getNewValue();
        eventQueue.addIdleListener(myIdleListener,timeout.intValue() * 1000);
      }
    }
  }
;
  mySettings.addPropertyChangeListener(myGeneralSettingsListener);
  myRefreshDelayAlarm=new SingleAlarm(new Runnable(){
    @Override public void run(){
      if (canSyncOrSave()) {
        refreshOpenFiles();
      }
      maybeRefresh(ModalityState.NON_MODAL);
    }
  }
,300);
  frameStateManager.addListener(new FrameStateListener(){
    @Override public void onFrameDeactivated(){
      LOG.debug("save(): enter");
      if (canSyncOrSave()) {
        saveProjectsAndDocuments();
      }
      LOG.debug("save(): exit");
    }
    @Override public void onFrameActivated(){
      if (!ApplicationManager.getApplication().isDisposed() && mySettings.isSyncOnFrameActivation()) {
        scheduleRefresh();
      }
    }
  }
);
}
