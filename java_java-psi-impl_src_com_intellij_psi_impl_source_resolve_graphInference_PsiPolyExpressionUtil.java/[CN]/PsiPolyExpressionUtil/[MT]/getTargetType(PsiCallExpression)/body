{
  final PsiElement parent=expression.getParent();
  if (parent instanceof PsiVariable) {
    return ((PsiVariable)parent).getType();
  }
  if (parent instanceof PsiAssignmentExpression) {
    return ((PsiAssignmentExpression)parent).getLExpression().getType();
  }
  if (parent instanceof PsiReturnStatement) {
    final PsiMethod method=PsiTreeUtil.getParentOfType(parent,PsiMethod.class);
    return method != null ? method.getReturnType() : null;
  }
  if (parent instanceof PsiExpressionList) {
    final PsiElement gParent=parent.getParent();
    if (gParent instanceof PsiCallExpression) {
      final PsiExpressionList argumentList=((PsiCallExpression)gParent).getArgumentList();
      if (argumentList != null) {
        final PsiExpression[] expressions=argumentList.getExpressions();
        final int idx=ArrayUtilRt.find(expressions,expression);
        final PsiMethod method=((PsiCallExpression)gParent).resolveMethod();
        if (method != null) {
          final PsiParameter[] parameters=method.getParameterList().getParameters();
          if (idx > -1 && idx < parameters.length) {
            return parameters[idx].getType();
          }
        }
      }
    }
  }
  return null;
}
