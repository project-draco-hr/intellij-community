{
  try {
    myBackupStream.close();
  }
 catch (  IOException e) {
    LOG.warn(e);
    FileUtil.delete(myBackupFile);
    throw e;
  }
  if (myFailed) {
    throw new IOException(CommonBundle.message("safe.write.failed",myTargetFile,myBackupFile.getName()));
  }
  File oldFile=new File(myTargetFile.getParent(),myTargetFile.getName() + EXTENSION_OLD);
  try {
    FileUtil.rename(myTargetFile,oldFile);
  }
 catch (  IOException e) {
    LOG.warn(e);
    throw new IOException(CommonBundle.message("safe.write.rename.original",myTargetFile,myBackupFile.getName()));
  }
  try {
    FileUtil.rename(myBackupFile,myTargetFile);
  }
 catch (  IOException e) {
    LOG.warn(e);
    throw new IOException(CommonBundle.message("safe.write.rename.backup",myTargetFile,oldFile.getName(),myBackupFile.getName()));
  }
  if (myPreserveAttributes) {
    FileSystemUtil.clonePermissions(oldFile.getPath(),myTargetFile.getPath());
  }
  if (!FileUtil.delete(oldFile)) {
    throw new IOException(CommonBundle.message("safe.write.drop.temp",oldFile));
  }
}
