{
  if (!myFailed && DO_SYNC) {
    try {
      myOutputStream.getFD().sync();
    }
 catch (    IOException e) {
      LOG.warn(e);
      myFailed=true;
    }
  }
  try {
    myOutputStream.close();
  }
 catch (  IOException e) {
    LOG.warn(e);
    myFailed=true;
  }
  if (myFailed) {
    FileUtil.delete(myTempFile);
    throw new IOException(message("safe.write.failed",myTargetFile,myTempFile.getName()));
  }
  File oldFile=new File(myTargetFile.getParent(),myTargetFile.getName() + EXTENSION_OLD);
  try {
    FileUtil.rename(myTargetFile,oldFile);
  }
 catch (  IOException e) {
    LOG.warn(e);
    throw new IOException(message("safe.write.rename.original",myTargetFile,myTempFile.getName()));
  }
  try {
    FileUtil.rename(myTempFile,myTargetFile);
  }
 catch (  IOException e) {
    LOG.warn(e);
    throw new IOException(message("safe.write.rename.backup",myTargetFile,oldFile.getName(),myTempFile.getName()));
  }
  if (myPreserveAttributes) {
    FileSystemUtil.clonePermissions(oldFile.getPath(),myTargetFile.getPath());
  }
  if (!FileUtil.delete(oldFile)) {
    throw new IOException(message("safe.write.drop.temp",oldFile));
  }
}
