{
  myIndicesDir=getIndexDir(buildDir);
  if (!myIndicesDir.exists() && !myIndicesDir.mkdirs()) {
    throw new RuntimeException("Can't create dir: " + buildDir.getAbsolutePath());
  }
  try {
    if (versionDiffers(buildDir)) {
      FileUtil.writeToFile(new File(myIndicesDir,VERSION_FILE),String.valueOf(VERSION));
    }
    myFilePathEnumerator=new PersistentStringEnumerator(new File(myIndicesDir,FILE_ENUM_TAB)){
      @Override public int enumerate(      @Nullable String value) throws IOException {
        return super.enumerate(SystemInfo.isFileSystemCaseSensitive ? value : value.toLowerCase(Locale.ROOT));
      }
    }
;
    final KeyDescriptor<LightRef> lightUsageDescriptor=new LightRefDescriptor();
    final KeyDescriptor<LightDefinition> defDescriptor=LightDefinition.createDescriptor(lightUsageDescriptor);
    myBackwardReferenceMap=new ObjectObjectPersistentMultiMaplet<LightRef,Integer>(new File(myIndicesDir,BACK_USAGES_TAB),lightUsageDescriptor,EnumeratorIntegerDescriptor.INSTANCE,new CollectionFactory<Integer>(){
      @Override public Collection<Integer> create(){
        return new THashSet<Integer>();
      }
    }
);
    myBackwardHierarchyMap=new ObjectObjectPersistentMultiMaplet<LightRef,LightDefinition>(new File(myIndicesDir,BACK_HIERARCHY_TAB),lightUsageDescriptor,defDescriptor,new CollectionFactory<LightDefinition>(){
      @Override public Collection<LightDefinition> create(){
        return new THashSet<LightDefinition>();
      }
    }
);
    myReferenceMap=new IntObjectPersistentMultiMaplet<LightRef>(new File(myIndicesDir,USAGES_TAB),EnumeratorIntegerDescriptor.INSTANCE,lightUsageDescriptor,new CollectionFactory<LightRef>(){
      @Override public Collection<LightRef> create(){
        return new THashSet<LightRef>();
      }
    }
);
    myHierarchyMap=new ObjectObjectPersistentMultiMaplet<LightDefinition,LightRef>(new File(myIndicesDir,HIERARCHY_TAB),defDescriptor,lightUsageDescriptor,new CollectionFactory<LightRef>(){
      @Override public Collection<LightRef> create(){
        return new THashSet<LightRef>();
      }
    }
);
    myClassDefinitionMap=new IntObjectPersistentMultiMaplet<LightRef>(new File(myIndicesDir,CLASS_DEF_TAB),EnumeratorIntegerDescriptor.INSTANCE,lightUsageDescriptor,new CollectionFactory<LightRef>(){
      @Override public Collection<LightRef> create(){
        return new THashSet<LightRef>();
      }
    }
);
    myBackwardClassDefinitionMap=new ObjectObjectPersistentMultiMaplet<LightRef,Integer>(new File(myIndicesDir,BACK_CLASS_DEF_TAB),lightUsageDescriptor,EnumeratorIntegerDescriptor.INSTANCE,new CollectionFactory<Integer>(){
      @Override public Collection<Integer> create(){
        return new THashSet<Integer>();
      }
    }
);
    myNameEnumerator=new ByteArrayEnumerator(new File(myIndicesDir,INCOMPLETE_FILES_TAB));
  }
 catch (  IOException e) {
    removeIndexFiles(myIndicesDir);
    throw new BuildDataCorruptedException(e);
  }
}
