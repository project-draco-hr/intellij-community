{
  final Ref<DumbModeTask> nextTask=Ref.create();
  UIUtil.invokeAndWaitIfNeeded(new Runnable(){
    @Override public void run(){
      if (myProject.isDisposed())       return;
      if (prevTask != null) {
        Disposer.dispose(prevTask);
      }
      while (true) {
        if (myUpdatesQueue.isEmpty()) {
          updateFinished();
          return;
        }
        DumbModeTask queuedTask=myUpdatesQueue.pullFirst();
        if (myProgresses.get(queuedTask).isCanceled()) {
          Disposer.dispose(queuedTask);
          continue;
        }
        nextTask.set(queuedTask);
        return;
      }
    }
  }
);
  return nextTask.get();
}
