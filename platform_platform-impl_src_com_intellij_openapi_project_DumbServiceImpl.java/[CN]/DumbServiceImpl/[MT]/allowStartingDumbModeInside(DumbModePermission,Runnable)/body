{
  ApplicationManager.getApplication().assertIsDispatchThread();
  LOG.assertTrue(!myProject.isDefault(),"Don't call allowStartingDumbModeInside for default project");
  ModalityState modality=ModalityState.current();
  DumbModePermission prev=myPermissions.put(modality,permission);
  try {
    runnable.run();
  }
  finally {
    if (prev == null) {
      myPermissions.remove(modality);
    }
 else {
      myPermissions.put(modality,prev);
    }
  }
}
