{
  myBlocksToModify=collectBlocksToModify();
  reset();
  myInfos=null;
  myRootBlockWrapper=null;
  myTextRangeToWrapper=null;
  myPreviousDependencies=null;
  myLastWhiteSpace=null;
  myFirstTokenBlock=null;
  myLastTokenBlock=null;
  myDisposed=true;
  if (myBlocksToModify.isEmpty()) {
    setDone(true);
    return;
  }
  if (myJavaIndentOptions == null) {
    myJavaIndentOptions=mySettings.getIndentOptions(StdFileTypes.JAVA);
  }
  myProgressCallback.beforeApplyingFormatChanges(myBlocksToModify);
  final int blocksToModifyCount=myBlocksToModify.size();
  if (blocksToModifyCount > BULK_REPLACE_OPTIMIZATION_CRITERIA) {
    applyChangesAtRewriteMode(myBlocksToModify,myModel,myDefaultIndentOption);
    setDone(true);
  }
 else   if (blocksToModifyCount > 50) {
    DocumentEx updatedDocument=getAffectedDocument(myModel);
    if (updatedDocument != null) {
      updatedDocument.setInBulkUpdate(true);
      myResetBulkUpdateState=true;
    }
  }
}
