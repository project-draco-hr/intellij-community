{
  myProgressCallback=callback;
  CommonCodeStyleSettings.IndentOptions defaultIndentOption=options.myIndentOptions;
  CodeStyleSettings settings=options.mySettings;
  BlockIndentOptions blockIndentOptions=new BlockIndentOptions(settings,defaultIndentOption,block);
  myDocument=model.getDocument();
  myReformatContext=options.myReformatContext;
  final InitialInfoBuilder builder=prepareToBuildBlocksSequentially(block,model,options,settings,defaultIndentOption,myProgressCallback);
  myWrapState=new WrapBlocksState(builder,blockIndentOptions);
  FormatTextRanges ranges=options.myAffectedRanges;
  if (ranges != null && Registry.is("smart.reformat.vcs.changes")) {
    AdjustFormatRangesState adjustRangesState=new AdjustFormatRangesState(block,ranges);
    myStateProcessor=new StateProcessor(adjustRangesState);
    myStateProcessor.setNextState(myWrapState);
  }
 else {
    myStateProcessor=new StateProcessor(myWrapState);
  }
}
