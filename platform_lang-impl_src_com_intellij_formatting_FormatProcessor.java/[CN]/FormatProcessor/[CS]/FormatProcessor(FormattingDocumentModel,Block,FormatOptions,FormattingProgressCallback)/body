{
  myProgressCallback=callback;
  myDefaultIndentOption=options.myIndentOptions;
  mySettings=options.mySettings;
  myBlockIndentOptions=new BlockIndentOptions(mySettings,myDefaultIndentOption);
  myDocument=model.getDocument();
  myReformatContext=options.myReformatContext;
  myRightMargin=getRightMargin(block);
  final InitialInfoBuilder builder=prepareToBuildBlocksSequentially(block,model,options,mySettings,myDefaultIndentOption,myProgressCallback);
  final WrapBlocksState wrapState=new WrapBlocksState(builder);
  wrapState.setOnDone(new Runnable(){
    @Override public void run(){
      myInfos=builder.getBlockToInfoMap();
      myRootBlockWrapper=builder.getRootBlockWrapper();
      myFirstTokenBlock=builder.getFirstTokenBlock();
      myFirstTokenBlockRef.set(myFirstTokenBlock);
      myLastTokenBlock=builder.getLastTokenBlock();
      int lastBlockOffset=myLastTokenBlock.getEndOffset();
      myLastWhiteSpace=new WhiteSpace(lastBlockOffset,false);
      myLastWhiteSpace.append(Math.max(lastBlockOffset,builder.getEndOffset()),model,myDefaultIndentOption);
      myBlockMapperHelper=new BlockMapperHelper(myFirstTokenBlock,myLastTokenBlock);
      myBlockMapperHelperRef.set(myBlockMapperHelper);
      myDependentSpacingEngine=new DependentSpacingEngine(myBlockMapperHelper);
      myDependentSpacingRef.set(myDependentSpacingEngine);
      myAlignmentsInsideRangesToModify=builder.getAlignmentsInsideRangeToModify();
      myAlignmentsInsideRangesToModifyRef.set(myAlignmentsInsideRangesToModify);
      myAlignmentHelper=new AlignmentHelper(myDocument,builder.getBlocksToAlign(),myBlockIndentOptions);
      myIndentAdjuster=new IndentAdjuster(myBlockIndentOptions,myAlignmentHelper);
      myIndentAdjusterRef.set(myIndentAdjuster);
      myExpandableIndentsRef.set(builder.getExpandableIndentsBlocks());
      myWrapProcessor=new WrapProcessor(myBlockMapperHelper,myIndentAdjuster,myRightMargin);
      myWrapProcessorRef.set(myWrapProcessor);
    }
  }
);
  myStateProcessor=new StateProcessor(wrapState);
}
