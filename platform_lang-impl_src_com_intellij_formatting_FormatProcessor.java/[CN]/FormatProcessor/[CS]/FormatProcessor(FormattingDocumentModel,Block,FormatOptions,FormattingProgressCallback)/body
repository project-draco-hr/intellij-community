{
  myProgressCallback=callback;
  myDefaultIndentOption=options.myIndentOptions;
  mySettings=options.mySettings;
  myBlockIndentOptions=new BlockIndentOptions(mySettings,myDefaultIndentOption);
  myDocument=model.getDocument();
  myReformatContext=options.myReformatContext;
  myRightMargin=getRightMargin(block);
  final InitialInfoBuilder builder=prepareToBuildBlocksSequentially(block,model,options,mySettings,myDefaultIndentOption,myProgressCallback);
  final WrapBlocksState wrapState=new WrapBlocksState(builder);
  wrapState.setOnDone(new Runnable(){
    @Override public void run(){
      myInfos=builder.getBlockToInfoMap();
      myRootBlockWrapper=builder.getRootBlockWrapper();
      myFirstTokenBlock=builder.getFirstTokenBlock();
      myFirstTokenBlockRef.set(myFirstTokenBlock);
      myLastTokenBlock=builder.getLastTokenBlock();
      myCurrentBlock=myFirstTokenBlock;
      int lastBlockOffset=myLastTokenBlock.getEndOffset();
      myLastWhiteSpace=new WhiteSpace(lastBlockOffset,false);
      myLastWhiteSpace.append(Math.max(lastBlockOffset,builder.getEndOffset()),model,myDefaultIndentOption);
      myBlocksHelper=new BlocksHelper(myFirstTokenBlock,myLastTokenBlock);
      myAlignmentsInsideRangesToModify=builder.getAlignmentsInsideRangeToModify();
      myTotalBlocksWithAlignments=builder.getBlocksToAlign().values().size();
      myExpandableIndents=builder.getExpandableIndentsBlocks();
    }
  }
);
  myStateProcessor=new StateProcessor(wrapState);
}
