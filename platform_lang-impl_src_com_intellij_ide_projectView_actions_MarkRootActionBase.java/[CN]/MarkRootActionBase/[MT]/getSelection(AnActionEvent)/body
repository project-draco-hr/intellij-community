{
  Module module=e.getData(LangDataKeys.MODULE);
  VirtualFile[] files=e.getData(CommonDataKeys.VIRTUAL_FILE_ARRAY);
  if (module == null || files == null) {
    return RootsSelection.EMPTY;
  }
  RootsSelection selection=new RootsSelection();
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(module.getProject()).getFileIndex();
  for (  VirtualFile file : files) {
    if (!file.isDirectory()) {
      return RootsSelection.EMPTY;
    }
    if (!fileIndex.isInContent(file)) {
      return RootsSelection.EMPTY;
    }
    SourceFolder folder;
    if (Comparing.equal(fileIndex.getSourceRootForFile(file),file) && ((folder=ProjectRootsUtil.findSourceFolder(module,file)) != null)) {
      selection.mySelectedRoots.add(folder);
    }
 else {
      selection.mySelectedDirectories.add(file);
      if (fileIndex.isInSourceContent(file)) {
        selection.myHaveSelectedFilesUnderSourceRoots=true;
      }
    }
  }
  return selection;
}
