{
  PsiElement element=PsiTreeUtil.getParentOfType(file.findElementAt(editor.getCaretModel().getOffset()),PyBinaryExpression.class,false);
  while (element.getParent() instanceof PyBinaryExpression) {
    element=element.getParent();
  }
  StringBuilder stringLiteral=new StringBuilder();
  StringBuilder parameters=new StringBuilder();
  NotNullFunction<String,String> escaper=StringUtil.escaper(false,null);
  int addParens=0;
  Pair<String,String> quotes=new Pair<String,String>("\"","\"");
  boolean quotesDetected=false;
  for (  PyExpression expression : getSimpleExpressions((PyBinaryExpression)element)) {
    if (expression instanceof PyStringLiteralExpression) {
      if (!quotesDetected) {
        quotes=PythonStringUtil.getQuotes(expression.getText());
        quotesDetected=true;
      }
      stringLiteral.append(escaper.fun(((PyStringLiteralExpression)expression).getStringValue()));
    }
 else {
      ++addParens;
      stringLiteral.append("%s");
      parameters.append(expression.getText()).append(", ");
    }
  }
  if (quotes == null)   quotes=new Pair<String,String>("\"","\"");
  PyElementGenerator elementGenerator=PyElementGenerator.getInstance(project);
  PyStringLiteralExpression stringLiteralExpression=elementGenerator.createStringLiteralAlreadyEscaped(quotes.getFirst() + stringLiteral.toString() + quotes.getSecond());
  if (addParens > 0) {
    final String paramString=addParens > 1 ? "(" + parameters.substring(0,parameters.length() - 2) + ")" : parameters.substring(0,parameters.length() - 2);
    final PyExpression expression=elementGenerator.createFromText(LanguageLevel.getDefault(),PyExpressionStatement.class,paramString).getExpression();
    element.replace(elementGenerator.createBinaryExpression("%",stringLiteralExpression,expression));
  }
 else {
    element.replace(stringLiteralExpression);
  }
}
