{
  File dir=createTempDirectory();
  File file=FileUtil.createTempFile(dir,"x","xxx_xx_xx",true);
  VirtualFile virtualFile=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(file);
  assertNotNull(virtualFile);
  assertEquals(FileTypes.UNKNOWN,virtualFile.getFileType());
  PsiFile psi=getPsiManager().findFile(virtualFile);
  assertTrue(psi instanceof PsiBinaryFile);
  assertEquals(FileTypes.UNKNOWN,virtualFile.getFileType());
  setBinaryContent(virtualFile,"xxxxxxx".getBytes(CharsetToolkit.UTF8_CHARSET));
  assertEquals(FileTypes.PLAIN_TEXT,virtualFile.getFileType());
  PsiFile after=getPsiManager().findFile(virtualFile);
  assertNotSame(psi,after);
  assertFalse(psi.isValid());
  assertTrue(after.isValid());
  assertTrue(after instanceof PsiPlainTextFile);
}
