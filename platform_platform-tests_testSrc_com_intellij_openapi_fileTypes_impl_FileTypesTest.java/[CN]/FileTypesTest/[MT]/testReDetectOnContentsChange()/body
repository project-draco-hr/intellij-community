{
  FileType fileType=FileTypeRegistry.getInstance().getFileTypeByFileName("x" + ModuleFileType.DOT_DEFAULT_EXTENSION);
  assertTrue(fileType.toString(),fileType instanceof ModuleFileType);
  fileType=FileTypeRegistry.getInstance().getFileTypeByFileName("x" + ProjectFileType.DOT_DEFAULT_EXTENSION);
  assertTrue(fileType.toString(),fileType instanceof ProjectFileType);
  FileTypeRegistry.FileTypeDetector detector=new FileTypeRegistry.FileTypeDetector(){
    @Nullable @Override public FileType detect(    @NotNull VirtualFile file,    @NotNull ByteSequence firstBytes,    @Nullable CharSequence firstCharsIfText){
      String text=firstCharsIfText.toString();
      if (text.startsWith("TYPE:"))       return FileTypeRegistry.getInstance().findFileTypeByName(StringUtil.trimStart(text,"TYPE:"));
      return null;
    }
    @Override public int getVersion(){
      return 0;
    }
  }
;
  Extensions.getRootArea().getExtensionPoint(FileTypeRegistry.FileTypeDetector.EP_NAME).registerExtension(detector);
  try {
    File d=createTempDirectory();
    File f=new File(d,"xx.asfdasdfas");
    FileUtil.writeToFile(f,"akjdhfksdjgf");
    VirtualFile vFile=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(f);
    assertTrue(vFile.getFileType().toString(),vFile.getFileType() instanceof PlainTextFileType);
    VfsUtil.saveText(vFile,"TYPE:IDEA_MODULE");
    myFileTypeManager.drainReDetectQueue();
    UIUtil.dispatchAllInvocationEvents();
    assertTrue(vFile.getFileType().toString(),vFile.getFileType() instanceof ModuleFileType);
    VfsUtil.saveText(vFile,"TYPE:IDEA_PROJECT");
    myFileTypeManager.drainReDetectQueue();
    UIUtil.dispatchAllInvocationEvents();
    assertTrue(vFile.getFileType().toString(),vFile.getFileType() instanceof ProjectFileType);
  }
  finally {
    Extensions.getRootArea().getExtensionPoint(FileTypeRegistry.FileTypeDetector.EP_NAME).unregisterExtension(detector);
  }
}
