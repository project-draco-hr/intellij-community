{
  File jarFile=FileUtil.createTempFile(TEMP_PREFIX,JAR_EXTENSION);
  jarFile.deleteOnExit();
  ZipOutputStream jarPlugin=null;
  try {
    BufferedOutputStream out=new BufferedOutputStream(new FileOutputStream(jarFile));
    jarPlugin=manifest != null ? new JarOutputStream(out,manifest) : new JarOutputStream(out);
    final ProgressIndicator progressIndicator=ProgressManager.getInstance().getProgressIndicator();
    final Set<String> writtenItemRelativePaths=new HashSet<String>();
    for (    Module module : modules) {
      final VirtualFile compilerOutputPath=CompilerModuleExtension.getInstance(module).getCompilerOutputPath();
      if (compilerOutputPath == null)       continue;
      ZipUtil.addDirToZipRecursively(jarPlugin,jarFile,new File(compilerOutputPath.getPath()),"",createFilter(progressIndicator,FileTypeManager.getInstance()),writtenItemRelativePaths);
    }
    if (pluginXmlPath != null) {
      ZipUtil.addFileToZip(jarPlugin,new File(pluginXmlPath),"/META-INF/plugin.xml",writtenItemRelativePaths,createFilter(progressIndicator,null));
    }
  }
  finally {
    if (jarPlugin != null)     jarPlugin.close();
  }
  return jarFile;
}
