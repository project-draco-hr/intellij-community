{
  setStacktraceIfNotSet(stackTrace);
  TestFailedState failedState=new TestFailedState(localizedMessage,stackTrace);
  if (myState instanceof TestComparisionFailedState) {
    CompoundTestFailedState states=new CompoundTestFailedState(localizedMessage,stackTrace);
    states.addFailure((TestFailedState)myState);
    states.addFailure(failedState);
    fireOnNewPrintable(failedState);
    myState=states;
  }
 else   if (myState instanceof CompoundTestFailedState) {
    ((CompoundTestFailedState)myState).addFailure(failedState);
    fireOnNewPrintable(failedState);
  }
 else   if (myState instanceof TestFailedState) {
    ((TestFailedState)myState).addError(localizedMessage,stackTrace,myPrinter);
  }
 else {
    myState=testError ? new TestErrorState(localizedMessage,stackTrace) : failedState;
    fireOnNewPrintable(myState);
  }
}
