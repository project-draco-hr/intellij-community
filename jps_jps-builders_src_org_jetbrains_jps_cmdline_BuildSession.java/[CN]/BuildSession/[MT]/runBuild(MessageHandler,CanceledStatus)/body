{
  final File dataStorageRoot=Utils.getDataStorageRoot(myProjectPath);
  if (dataStorageRoot == null) {
    msgHandler.processMessage(new CompilerMessage("build",BuildMessage.Kind.ERROR,"Cannot determine build data storage root for project " + myProjectPath));
    return;
  }
  if (!dataStorageRoot.exists()) {
    myBuildRunner.setForceCleanCaches(true);
  }
  final ProjectDescriptor preloadedProject=myPreloadedData != null ? myPreloadedData.getProjectDescriptor() : null;
  final DataInputStream fsStateStream=preloadedProject != null || myInitialFSDelta == null ? null : createFSDataStream(dataStorageRoot,myInitialFSDelta.getOrdinal());
  if (fsStateStream != null || myPreloadedData != null) {
    final boolean hasWorkFlag=fsStateStream != null ? fsStateStream.readBoolean() : myPreloadedData.hasWorkToDo();
    final boolean hasWorkToDoWithModules=hasWorkFlag || myInitialFSDelta == null;
    if (!myForceModelLoading && (myBuildType == BuildType.BUILD || myBuildType == BuildType.UP_TO_DATE_CHECK) && !hasWorkToDoWithModules&& scopeContainsModulesOnlyForIncrementalMake(myScopes)&& !containsChanges(myInitialFSDelta)) {
      final DataInputStream storedFsData;
      if (myPreloadedData != null) {
        storedFsData=createFSDataStream(dataStorageRoot,myInitialFSDelta.getOrdinal());
        if (storedFsData != null) {
          storedFsData.readBoolean();
        }
      }
 else {
        storedFsData=fsStateStream;
      }
      if (storedFsData != null) {
        updateFsStateOnDisk(dataStorageRoot,storedFsData,myInitialFSDelta.getOrdinal());
        LOG.info("No changes found since last build. Exiting.");
        if (preloadedProject != null) {
          preloadedProject.release();
        }
        return;
      }
    }
  }
  final BuildFSState fsState=preloadedProject != null ? preloadedProject.fsState : new BuildFSState(false);
  try {
    final ProjectDescriptor pd;
    if (preloadedProject != null) {
      pd=preloadedProject;
      final List<BuildMessage> preloadMessages=myPreloadedData.getLoadMessages();
      if (!preloadMessages.isEmpty()) {
        for (        BuildMessage message : preloadMessages) {
          msgHandler.processMessage(message);
        }
      }
      if (myInitialFSDelta == null || myPreloadedData.getFsEventOrdinal() + 1L != myInitialFSDelta.getOrdinal()) {
        fsState.clearAll();
      }
 else {
        try {
          applyFSEvent(pd,myInitialFSDelta,false);
        }
 catch (        Throwable e) {
          LOG.error(e);
          fsState.clearAll();
        }
      }
    }
 else {
      pd=myBuildRunner.load(msgHandler,dataStorageRoot,fsState);
      TimingLog.LOG.debug("Project descriptor loaded");
      if (fsStateStream != null) {
        try {
          try {
            fsState.load(fsStateStream,pd.getModel(),pd.getBuildRootIndex());
            applyFSEvent(pd,myInitialFSDelta,false);
            TimingLog.LOG.debug("FS Delta loaded");
          }
  finally {
            fsStateStream.close();
          }
        }
 catch (        Throwable e) {
          LOG.error(e);
          fsState.clearAll();
        }
      }
    }
    myProjectDescriptor=pd;
    myLastEventOrdinal=myInitialFSDelta != null ? myInitialFSDelta.getOrdinal() : 0L;
    myInitialFSDelta=null;
    myEventsProcessor.startProcessing();
    myBuildRunner.runBuild(pd,cs,myConstantSearch,msgHandler,myBuildType,myScopes,false);
    TimingLog.LOG.debug("Build finished");
  }
  finally {
    saveData(fsState,dataStorageRoot);
  }
}
