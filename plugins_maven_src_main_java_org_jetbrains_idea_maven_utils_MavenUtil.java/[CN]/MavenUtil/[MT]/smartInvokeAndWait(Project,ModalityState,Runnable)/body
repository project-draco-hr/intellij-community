{
  if (isNoBackgroundMode() || ApplicationManager.getApplication().isDispatchThread()) {
    r.run();
  }
 else {
    final Semaphore semaphore=new Semaphore();
    semaphore.down();
    DumbService.getInstance(p).smartInvokeLater(new Runnable(){
      @Override public void run(){
        try {
          r.run();
        }
  finally {
          semaphore.up();
        }
      }
    }
,state);
    semaphore.waitFor();
  }
}
