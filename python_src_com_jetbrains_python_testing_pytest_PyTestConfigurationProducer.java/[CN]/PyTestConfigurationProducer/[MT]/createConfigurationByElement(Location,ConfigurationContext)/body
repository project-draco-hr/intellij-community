{
  PsiElement element=location.getPsiElement();
  PsiFileSystemItem file=element instanceof PsiDirectory ? (PsiDirectory)element : element.getContainingFile();
  if (file == null)   return null;
  myPsiElement=file;
  String path=file.getVirtualFile().getPath();
  final RunnerAndConfigurationSettings result=RunManager.getInstance(location.getProject()).createRunConfiguration(file.getName(),getConfigurationFactory());
  PyTestRunConfiguration configuration=(PyTestRunConfiguration)result.getConfiguration();
  configuration.setUseModuleSdk(true);
  configuration.setModule(ModuleUtil.findModuleForPsiElement(myPsiElement));
  final String scriptPath=configuration.getRunnerScriptPath();
  if (scriptPath == null || !new File(scriptPath).exists()) {
    return null;
  }
  configuration.setTestToRun(path);
  PyFunction pyFunction=findTestFunction(location);
  if (pyFunction != null) {
    String name=pyFunction.getName();
    configuration.setKeywords(name);
    configuration.setName(name + " in " + configuration.getName());
    myPsiElement=pyFunction;
  }
  return result;
}
