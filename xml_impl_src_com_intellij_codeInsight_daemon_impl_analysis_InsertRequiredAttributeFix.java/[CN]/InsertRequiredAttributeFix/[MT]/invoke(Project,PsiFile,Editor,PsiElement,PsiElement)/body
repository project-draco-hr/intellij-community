{
  if (!FileModificationService.getInstance().prepareFileForWrite(file))   return;
  XmlTag myTag=(XmlTag)startElement;
  ASTNode treeElement=SourceTreeToPsiMap.psiElementToTree(myTag);
  final XmlElementDescriptor descriptor=myTag.getDescriptor();
  if (descriptor == null) {
    return;
  }
  final XmlAttributeDescriptor attrDescriptor=descriptor.getAttributeDescriptor(myAttrName,myTag);
  final boolean indirectSyntax=XmlExtension.getExtension(myTag.getContainingFile()).isIndirectSyntax(attrDescriptor);
  boolean insertShorthand=myTag instanceof HtmlTag && attrDescriptor != null && HtmlUtil.isBooleanAttribute(attrDescriptor,myTag);
  PsiElement anchor=SourceTreeToPsiMap.treeElementToPsi(XmlChildRole.EMPTY_TAG_END_FINDER.findChild(treeElement));
  final boolean anchorIsEmptyTag=anchor != null;
  if (anchor == null) {
    anchor=SourceTreeToPsiMap.treeElementToPsi(XmlChildRole.START_TAG_END_FINDER.findChild(treeElement));
  }
  if (anchor == null)   return;
  final Template template=TemplateManager.getInstance(project).createTemplate("","");
  if (indirectSyntax) {
    if (anchorIsEmptyTag)     template.addTextSegment(">");
    template.addTextSegment("<jsp:attribute name=\"" + myAttrName + "\">");
  }
 else {
    template.addTextSegment(" " + myAttrName + (!insertShorthand ? "=\"" : ""));
  }
  Expression expression=new Expression(){
    final TextResult result=new TextResult("");
    @Override public Result calculateResult(    ExpressionContext context){
      return result;
    }
    @Override public Result calculateQuickResult(    ExpressionContext context){
      return null;
    }
    @Override public LookupElement[] calculateLookupItems(    ExpressionContext context){
      final LookupElement[] items=new LookupElement[myValues.length];
      for (int i=0; i < items.length; i++) {
        items[i]=LookupElementBuilder.create(myValues[i]);
      }
      return items;
    }
  }
;
  if (!insertShorthand)   template.addVariable(NAME_TEMPLATE_VARIABLE,expression,expression,true);
  if (indirectSyntax) {
    template.addTextSegment("</jsp:attribute>");
    template.addEndVariable();
    if (anchorIsEmptyTag)     template.addTextSegment("</" + myTag.getName() + ">");
  }
 else   if (!insertShorthand) {
    template.addTextSegment("\"");
  }
  final PsiElement anchor1=anchor;
  final Runnable runnable=new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          int textOffset=anchor1.getTextOffset();
          if (!anchorIsEmptyTag && indirectSyntax)           ++textOffset;
          editor.getCaretModel().moveToOffset(textOffset);
          if (anchorIsEmptyTag && indirectSyntax) {
            editor.getDocument().deleteString(textOffset,textOffset + 2);
          }
          TemplateManager.getInstance(project).startTemplate(editor,template);
        }
      }
);
    }
  }
;
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    Runnable commandRunnable=new Runnable(){
      @Override public void run(){
        CommandProcessor.getInstance().executeCommand(project,runnable,getText(),getFamilyName());
      }
    }
;
    ApplicationManager.getApplication().invokeLater(commandRunnable);
  }
 else {
    runnable.run();
  }
}
