{
  if (singles.isEmpty()) {
    return true;
  }
  if (singles.size() == 1) {
    final Collection<? extends RequestWithProcessor> requests=singles.values();
    if (requests.size() == 1) {
      final RequestWithProcessor theOnly=requests.iterator().next();
      return processSingleRequest(theOnly.request,theOnly.refProcessor);
    }
  }
  if (progress != null) {
    progress.pushState();
    progress.setText(PsiBundle.message("psi.scanning.files.progress"));
  }
  boolean result;
  try {
    final MultiMap<VirtualFile,RequestWithProcessor> intersectionCandidateFiles=createMultiMap();
    final MultiMap<VirtualFile,RequestWithProcessor> restCandidateFiles=createMultiMap();
    collectFiles(singles,progress,intersectionCandidateFiles,restCandidateFiles);
    if (intersectionCandidateFiles.isEmpty() && restCandidateFiles.isEmpty()) {
      return true;
    }
    if (progress != null) {
      final Set<String> allWords=new TreeSet<String>();
      for (      RequestWithProcessor singleRequest : localProcessors.keySet()) {
        allWords.add(singleRequest.request.word);
      }
      progress.setText(PsiBundle.message("psi.search.for.word.progress",getPresentableWordsDescription(allWords)));
    }
    if (intersectionCandidateFiles.isEmpty()) {
      result=processCandidates(progress,localProcessors,restCandidateFiles,restCandidateFiles.size(),0);
    }
 else {
      int totalSize=restCandidateFiles.size() + intersectionCandidateFiles.size();
      result=processCandidates(progress,localProcessors,intersectionCandidateFiles,totalSize,0);
      if (result) {
        result=processCandidates(progress,localProcessors,restCandidateFiles,totalSize,intersectionCandidateFiles.size());
      }
    }
  }
  finally {
    if (progress != null) {
      progress.popState();
    }
  }
  return result;
}
