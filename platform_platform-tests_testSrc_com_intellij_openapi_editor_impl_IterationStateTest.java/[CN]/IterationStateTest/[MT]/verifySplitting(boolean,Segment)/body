{
  EditorEx editor=(EditorEx)myFixture.getEditor();
  IterationState iterationState=new IterationState(editor,0,editor.getDocument().getTextLength(),true);
  List<Segment> actualSegments=new ArrayList<Segment>();
  do {
    Segment segment=new Segment(iterationState.getStartOffset(),iterationState.getEndOffset(),checkForegroundColor ? iterationState.getMergedAttributes().getForegroundColor() : iterationState.getMergedAttributes().getBackgroundColor());
    readPastLineState(iterationState,segment);
    actualSegments.add(segment);
    iterationState.advance();
  }
 while (!iterationState.atEnd());
  if (iterationState.hasPastFileEndBackgroundSegments()) {
    Segment segment=new Segment(iterationState.getEndOffset(),iterationState.getEndOffset(),null);
    readPastLineState(iterationState,segment);
    actualSegments.add(segment);
  }
  Assert.assertArrayEquals(expectedSegments,actualSegments.toArray());
}
