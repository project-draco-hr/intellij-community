{
  AsyncResult<T> asyncResult=ref.get();
  if (asyncResult == null) {
    if (!ref.compareAndSet(null,asyncResult=new AsyncResult<T>())) {
      return ref.get();
    }
  }
 else   if (!asyncResult.isProcessed()) {
    return asyncResult;
  }
 else   if (asyncResult.isDone()) {
    if (!checkFreshness || isUpToDate(asyncResult.getResult())) {
      return asyncResult;
    }
    if (!ref.compareAndSet(asyncResult,asyncResult=new AsyncResult<T>())) {
      AsyncResult<T> valueFromAnotherThread=ref.get();
      while (valueFromAnotherThread == null) {
        if (ref.compareAndSet(null,asyncResult)) {
          callLoad(asyncResult);
          return asyncResult;
        }
 else {
          valueFromAnotherThread=ref.get();
        }
      }
      return valueFromAnotherThread;
    }
  }
  callLoad(asyncResult);
  return asyncResult;
}
