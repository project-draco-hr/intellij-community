{
  File temp=Utils.createTempFile();
  try (ZipOutputWrapper out=new ZipOutputWrapper(new FileOutputStream(temp))){
    out.setCompressionLevel(0);
    processZipFile(getSource(backupDir),new Processor(){
      @Override public void process(      ZipEntry entry,      InputStream in) throws IOException {
        String path=entry.getName();
        if (myFilesToDelete.contains(path))         return;
        if (myFilesToUpdate.contains(path)) {
          OutputStream entryOut=out.zipStream(path);
          try {
            applyDiff(Utils.findEntryInputStream(patchFile,myPath + "/" + path),in,entryOut);
          }
  finally {
            entryOut.close();
          }
        }
 else {
          out.zipEntry(entry,in);
        }
      }
    }
);
    for (    String each : myFilesToCreate) {
      try (InputStream in=Utils.getEntryInputStream(patchFile,myPath + "/" + each)){
        out.zipEntry(each,in);
      }
     }
    out.finish();
  }
   replaceUpdated(temp,toFile);
}
