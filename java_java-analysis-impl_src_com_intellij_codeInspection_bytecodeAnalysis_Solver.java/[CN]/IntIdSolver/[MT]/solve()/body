{
  while (!moving.empty()) {
    int id=moving.pop();
    Value value=solved.get(id);
    boolean stable=id > 0;
    int[] pIds=stable ? new int[]{id,-id} : new int[]{-id,id};
    Value[] pVals=stable ? new Value[]{value,value} : new Value[]{value,lattice.top};
    for (int i=0; i < pIds.length; i++) {
      int pId=pIds[i];
      Value pVal=pVals[i];
      int[] dIds=dependencies.get(pId);
      for (      int dId : dIds) {
        IntIdPending pend=pending.remove(dId);
        if (pend != null) {
          IntIdResult pend1=substitute(pend,pId,pVal);
          if (pend1 instanceof IntIdFinal) {
            IntIdFinal fi=(IntIdFinal)pend1;
            solved.put(dId,fi.value);
            moving.push(dId);
          }
 else {
            pending.put(dId,(IntIdPending)pend1);
          }
        }
      }
    }
  }
  pending.clear();
  return solved;
}
