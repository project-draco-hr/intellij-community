{
  Project project=e.getData(CommonDataKeys.PROJECT);
  String fileText=assertNotNull(e.getData(PlatformDataKeys.FILE_TEXT));
  VirtualFile file=assertNotNull(e.getData(CommonDataKeys.VIRTUAL_FILE));
  String extension=assertNotNull(file.getExtension());
  String nameWithoutExtension=file.getNameWithoutExtension();
  AllFileTemplatesConfigurable fileTemplateOptions=new AllFileTemplatesConfigurable();
  ConfigureTemplatesDialog dialog=new ConfigureTemplatesDialog(project,fileTemplateOptions);
  fileTemplateOptions.selectTemplatesTab();
  PsiFile psiFile=e.getData(CommonDataKeys.PSI_FILE);
  for (  SaveFileAsTemplateHandler handler : Extensions.getExtensions(SaveFileAsTemplateHandler.EP_NAME)) {
    String textFromHandler=handler.getTemplateText(psiFile,fileText,nameWithoutExtension);
    if (textFromHandler != null) {
      fileText=textFromHandler;
      break;
    }
  }
  fileTemplateOptions.createNewTemplate(nameWithoutExtension,extension,fileText);
  dialog.show();
}
