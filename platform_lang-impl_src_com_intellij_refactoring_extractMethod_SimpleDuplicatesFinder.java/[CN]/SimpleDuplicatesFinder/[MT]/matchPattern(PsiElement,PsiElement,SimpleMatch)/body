{
  ProgressManager.checkCanceled();
  if (pattern == null || candidate == null)   return pattern == candidate;
  final PsiElement[] children1=PsiEquivalenceUtil.getFilteredChildren(pattern,null,true);
  final PsiElement[] children2=PsiEquivalenceUtil.getFilteredChildren(candidate,null,true);
  if (children1.length != children2.length)   return false;
  for (int i=0; i < children1.length; i++) {
    final PsiElement child1=children1[i];
    final PsiElement child2=children2[i];
    if (!matchPattern(child1,child2,match))     return false;
  }
  if (children1.length == 0) {
    if (pattern.getUserData(PARAMETER) != null && pattern.getParent().getClass() == candidate.getParent().getClass()) {
      match.changeParameter(pattern.getText(),candidate.getText());
      return true;
    }
    if (!pattern.textMatches(candidate))     return false;
  }
  return true;
}
