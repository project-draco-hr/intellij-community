{
  final Runnable updateLanguageLevel=new Runnable(){
    @Override public void run(){
      final Set<Sdk> updatedSdks=new HashSet<Sdk>();
      final Module[] modules=ModuleManager.getInstance(project).getModules();
      boolean needReparseOpenFiles=false;
      for (      Module module : modules) {
        Sdk newSdk=PythonSdkType.findPythonSdk(module);
        if (myModuleSdks.containsKey(module)) {
          Sdk oldSdk=myModuleSdks.get(module);
          if ((newSdk != null || oldSdk != null) && newSdk != oldSdk) {
            needReparseOpenFiles=true;
          }
        }
        myModuleSdks.put(module,newSdk);
        if (newSdk != null && !updatedSdks.contains(newSdk)) {
          updatedSdks.add(newSdk);
          updateSdkLanguageLevel(project,newSdk);
        }
      }
      final boolean finalNeedReparseOpenFiles=needReparseOpenFiles;
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          if (finalNeedReparseOpenFiles) {
            FileContentUtil.reparseFiles(project,Collections.<VirtualFile>emptyList(),true);
          }
        }
      }
);
    }
  }
;
  final DumbModeTask task=new DumbModeTask(){
    @Override public void performInDumbMode(    @NotNull ProgressIndicator indicator){
      ApplicationManager.getApplication().runReadAction(updateLanguageLevel);
    }
  }
;
  DumbService.getInstance(project).queueTask(task);
}
