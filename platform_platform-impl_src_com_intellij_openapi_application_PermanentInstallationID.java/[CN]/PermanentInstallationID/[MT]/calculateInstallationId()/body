{
  final Preferences oldPrefs=Preferences.userRoot();
  final String oldValue=oldPrefs.get(OLD_USER_ON_MACHINE_ID_KEY,null);
  final Preferences prefs=Preferences.userRoot().node("jetbrains");
  String installationId=prefs.get(INSTALLATION_ID_KEY,null);
  if (installationId == null || installationId.isEmpty()) {
    installationId=oldValue != null && !oldValue.isEmpty() ? oldValue : UUID.randomUUID().toString();
    prefs.put(INSTALLATION_ID_KEY,installationId);
  }
  if (SystemInfo.isWindows) {
    final String appdata=System.getenv("APPDATA");
    if (appdata != null) {
      final File dir=new File(appdata,"JetBrains");
      if (dir.exists() || dir.mkdirs()) {
        final File permanentIdFile=new File(dir,"PermanentUserId");
        try {
          String fromFile="";
          if (permanentIdFile.exists()) {
            fromFile=loadFromFile(permanentIdFile).trim();
          }
          if (!fromFile.isEmpty()) {
            if (!fromFile.equals(installationId)) {
              installationId=fromFile;
              prefs.put(INSTALLATION_ID_KEY,installationId);
            }
          }
 else {
            writeToFile(permanentIdFile,installationId);
          }
        }
 catch (        IOException ignored) {
        }
      }
    }
  }
  if (!installationId.equals(oldValue)) {
    oldPrefs.put(OLD_USER_ON_MACHINE_ID_KEY,installationId);
  }
  return installationId;
}
