{
  int offset=context.getTailOffset() - 1;
  final PsiFile file=context.getFile();
  if (PsiTreeUtil.findElementOfClassAtOffset(file,offset,PsiImportStatementBase.class,false) != null) {
    final PsiJavaCodeReferenceElement ref=PsiTreeUtil.findElementOfClassAtOffset(file,offset,PsiJavaCodeReferenceElement.class,false);
    final String qname=item.getQualifiedName();
    if (qname != null && (ref == null || !qname.equals(ref.getCanonicalText()))) {
      AllClassesGetter.INSERT_FQN.handleInsert(context,item);
    }
    return;
  }
  PsiElement position=file.findElementAt(offset);
  PsiJavaCodeReferenceElement ref=position != null && position.getParent() instanceof PsiJavaCodeReferenceElement ? (PsiJavaCodeReferenceElement)position.getParent() : null;
  PsiClass psiClass=item.getObject();
  final Project project=context.getProject();
  final Editor editor=context.getEditor();
  final char c=context.getCompletionChar();
  if (c == '#') {
    context.setLaterRunnable(new Runnable(){
      @Override public void run(){
        new CodeCompletionHandlerBase(CompletionType.BASIC).invokeCompletion(project,editor);
      }
    }
);
  }
 else   if (c == '.' && PsiTreeUtil.getParentOfType(position,PsiParameterList.class) == null) {
    AutoPopupController.getInstance(context.getProject()).autoPopupMemberLookup(context.getEditor(),null);
  }
  if (PsiTreeUtil.getParentOfType(position,PsiDocComment.class,false) != null && shouldInsertFqnInJavadoc(item,file,project)) {
    AllClassesGetter.INSERT_FQN.handleInsert(context,item);
    return;
  }
  if (ref != null && PsiTreeUtil.getParentOfType(position,PsiDocTag.class) != null && ref.isReferenceTo(psiClass)) {
    return;
  }
  OffsetKey refEnd=context.trackOffset(context.getTailOffset(),false);
  boolean fillTypeArgs=context.getCompletionChar() == '<';
  if (fillTypeArgs) {
    context.setAddCompletionChar(false);
  }
  if (ref == null || !ref.isQualified()) {
    PsiTypeLookupItem.addImportForItem(context,psiClass);
  }
  if (context.getOffset(refEnd) < 0) {
    return;
  }
  context.setTailOffset(context.getOffset(refEnd));
  context.commitDocument();
  if (item.getUserData(JavaChainLookupElement.CHAIN_QUALIFIER) == null && shouldInsertParentheses(file.findElementAt(context.getTailOffset() - 1))) {
    if (ConstructorInsertHandler.insertParentheses(context,item,psiClass,false)) {
      fillTypeArgs|=psiClass.hasTypeParameters() && PsiUtil.getLanguageLevel(file).isAtLeast(LanguageLevel.JDK_1_5);
    }
  }
 else   if (insertingAnnotation(context,item)) {
    if (shouldHaveAnnotationParameters(psiClass)) {
      JavaCompletionUtil.insertParentheses(context,item,false,true);
    }
    if (context.getCompletionChar() == Lookup.NORMAL_SELECT_CHAR || context.getCompletionChar() == Lookup.COMPLETE_STATEMENT_SELECT_CHAR) {
      CharSequence text=context.getDocument().getCharsSequence();
      int tail=context.getTailOffset();
      if (text.length() > tail && Character.isLetter(text.charAt(tail))) {
        context.getDocument().insertString(tail," ");
      }
    }
  }
  if (fillTypeArgs && context.getCompletionChar() != '(') {
    JavaCompletionUtil.promptTypeArgs(context,context.getOffset(refEnd));
  }
}
