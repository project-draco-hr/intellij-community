{
  final PackageManagementService selPackageManagementService=myPackageManagementService;
  myPackageManagementService.fetchPackageVersions(pkg.getName(),new CatchingConsumer<List<String>,Exception>(){
    @Override public void consume(    List<String> releases){
      if (!releases.isEmpty() && !isUpdateAvailable(pkg.getVersion(),releases.get(0))) {
        return;
      }
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          final PackageManagementService.Listener listener=new PackageManagementService.Listener(){
            @Override public void operationStarted(            final String packageName){
              UIUtil.invokeLaterIfNeeded(new Runnable(){
                @Override public void run(){
                  myPackagesTable.setPaintBusy(true);
                  myCurrentlyInstalling.add(packageName);
                }
              }
);
            }
            @Override public void operationFinished(            final String packageName,            @Nullable final PackageManagementService.ErrorDescription errorDescription){
              UIUtil.invokeLaterIfNeeded(new Runnable(){
                @Override public void run(){
                  myPackagesTable.clearSelection();
                  updatePackages(selPackageManagementService);
                  myPackagesTable.setPaintBusy(false);
                  myCurrentlyInstalling.remove(packageName);
                  if (errorDescription == null) {
                    myNotificationArea.showSuccess("Package " + packageName + " successfully upgraded");
                  }
 else {
                    myNotificationArea.showError("Upgrade packages failed. <a href=\"xxx\">Details...</a>","Upgrade Packages Failed",errorDescription);
                  }
                  if (myCurrentlyInstalling.isEmpty() && !myWaitingToUpgrade.isEmpty()) {
                    upgradePostponedPackages();
                  }
                }
              }
);
            }
          }
;
          PackageManagementServiceEx serviceEx=getServiceEx();
          if (serviceEx != null) {
            serviceEx.updatePackage(pkg,toVersion,listener);
          }
 else {
            myPackageManagementService.installPackage(new RepoPackage(pkg.getName(),null),null,true,null,listener,false);
          }
          myUpgradeButton.setEnabled(false);
        }
      }
,ModalityState.any());
    }
    @Override public void consume(    Exception e){
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          Messages.showErrorDialog("Error occurred. Please, check your internet connection.","Upgrade Package Failed.");
        }
      }
,ModalityState.any());
    }
  }
);
}
