{
  UIUtil.invokeAndWaitIfNeeded(new Runnable(){
    @Override public void run(){
      try {
        final IdeaTestFixtureFactory fixtureFactory=IdeaTestFixtureFactory.getFixtureFactory();
        myTempDirTestFixture=fixtureFactory.createTempDirTestFixture();
        myTempDirTestFixture.setUp();
        myClientRoot=new File(myTempDirTestFixture.getTempDirPath(),"clientroot");
        myClientRoot.mkdir();
        initProject(myClientRoot,ExternalChangesDetectionVcsTest.this.getTestName());
        ((StartupManagerImpl)StartupManager.getInstance(myProject)).runPostStartupActivities();
        myVcs=new MockAbstractVcs(myProject);
        myVcs.setChangeProvider(new MyMockChangeProvider());
        myVcsManager=(ProjectLevelVcsManagerImpl)ProjectLevelVcsManager.getInstance(myProject);
        myVcsManager.registerVcs(myVcs);
        myVcsManager.setDirectoryMapping("",myVcs.getName());
        myLFS=LocalFileSystem.getInstance();
        myChangeListManager=ChangeListManager.getInstance(myProject);
        ((ProjectComponent)myChangeListManager).projectOpened();
        myVcsDirtyScopeManager=VcsDirtyScopeManager.getInstance(myProject);
        ((ProjectComponent)myVcsDirtyScopeManager).projectOpened();
      }
 catch (      Exception e) {
        throw new RuntimeException(e);
      }
    }
  }
);
}
