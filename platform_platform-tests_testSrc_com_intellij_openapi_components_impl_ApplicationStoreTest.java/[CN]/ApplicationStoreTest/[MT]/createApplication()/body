{
  ApplicationManagerEx.createApplication(true,true,true,true,ApplicationManagerEx.IDEA_APPLICATION,null);
  final String testAppConfigPath=System.getProperty("test.app.config.path");
  if (testAppConfigPath == null) {
    testAppConfig=FileUtil.createTempDirectory("testAppSettings",null);
  }
 else {
    testAppConfig=new File(FileUtil.expandUserHome(testAppConfigPath));
  }
  FileUtil.delete(testAppConfig);
  UIUtil.invokeAndWaitIfNeeded(new Runnable(){
    @Override public void run(){
      PluginManagerCore.getPlugins();
      final ApplicationImpl app=(ApplicationImpl)ApplicationManagerEx.getApplicationEx();
      new WriteAction(){
        @Override protected void run(        @NotNull Result result) throws Throwable {
          app.load(testAppConfig.getAbsolutePath(),testAppConfig.getAbsolutePath() + "/options");
        }
      }
.execute();
    }
  }
);
}
