{
  myView=view;
  myDocument=view.getEditor().getDocument();
  FoldingModelEx foldingModel=view.getEditor().getFoldingModel();
  FoldRegion[] regions=foldingModel.fetchTopLevel();
  myRegions=regions == null ? FoldRegion.EMPTY_ARRAY : regions;
  mySegmentStartOffset=EditorUtil.getNotFoldedLineStartOffset(view.getEditor(),offset);
  myCurrentFoldRegionIndex=foldingModel.getLastCollapsedRegionBefore(mySegmentStartOffset) + 1;
  myCurrentEndLogicalLine=myDocument.getLineNumber(mySegmentStartOffset);
  myCurrentX=myCurrentEndLogicalLine == 0 ? myView.getPrefixTextWidthInPixels() : 0;
  setFragmentIterator();
}
