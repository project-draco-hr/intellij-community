{
  return new WriteAction<PsiFile>(){
    @Override protected void run(    @NotNull Result<PsiFile> result) throws Throwable {
      if (!ModuleRootManager.getInstance(module).getFileIndex().isInSourceContent(vDir)) {
        PsiTestUtil.addSourceContentToRoots(module,vDir);
      }
      final VirtualFile vFile=vDir.createChildData(vDir,fileName);
      VfsUtil.saveText(vFile,text);
      PsiDocumentManager.getInstance(myProject).commitAllDocuments();
      final PsiFile file=PsiManager.getInstance(myProject).findFile(vFile);
      assert(file != null);
      result.setResult(file);
    }
  }
.execute().getResultObject();
}
