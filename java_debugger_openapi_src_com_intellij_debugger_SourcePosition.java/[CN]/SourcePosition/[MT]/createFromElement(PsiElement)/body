{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  PsiElement navigationElement=element.getNavigationElement();
  final SmartPsiElementPointer<PsiElement> pointer=SmartPointerManager.getInstance(navigationElement.getProject()).createSmartPsiElementPointer(navigationElement);
  final PsiFile psiFile;
  if (JspPsiUtil.isInJspFile(navigationElement)) {
    psiFile=JspPsiUtil.getJspFile(navigationElement);
  }
 else {
    psiFile=navigationElement.getContainingFile();
  }
  return new SourcePositionCache(psiFile){
    @Override protected PsiElement calcPsiElement(){
      ApplicationManager.getApplication().assertReadAccessAllowed();
      return pointer.getElement();
    }
    @Override protected int calcOffset(){
      return ApplicationManager.getApplication().runReadAction(new Computable<Integer>(){
        @Override public Integer compute(){
          PsiElement elem=pointer.getElement();
          return elem != null ? elem.getTextOffset() : -1;
        }
      }
);
    }
  }
;
}
