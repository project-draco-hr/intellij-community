{
  final PsiType eqBound=getEqualsBound(var,substitutor);
  if (eqBound != PsiType.NULL && eqBound instanceof PsiPrimitiveType)   return PsiType.NULL;
  final PsiType lowerBound=getLowerBound(var,substitutor);
  final PsiType upperBound=getUpperBound(var,substitutor);
  PsiType type;
  if (eqBound != PsiType.NULL && (myErased || eqBound != null)) {
    if (lowerBound != PsiType.NULL && !TypeConversionUtil.isAssignable(eqBound,lowerBound)) {
      final String incompatibleBoundsMessage=incompatibleBoundsMessage(var,substitutor,InferenceBound.EQ,EQUALITY_CONSTRAINTS_PRESENTATION,InferenceBound.LOWER,LOWER_BOUNDS_PRESENTATION);
      return registerIncompatibleErrorMessage(var,incompatibleBoundsMessage);
    }
 else {
      type=eqBound;
      if (!TypeConversionUtil.isAssignable(eqBound,lowerBound,false)) {
        setErased();
      }
    }
  }
 else {
    type=lowerBound;
  }
  if (type == PsiType.NULL) {
    if (var.isThrownBound() && isThrowable(var.getBounds(InferenceBound.UPPER))) {
      type=PsiType.getJavaLangRuntimeException(myManager,GlobalSearchScope.allScope(myManager.getProject()));
    }
 else {
      type=myErased ? null : upperBound;
    }
    if (type instanceof PsiIntersectionType) {
      final String conflictingConjunctsMessage=((PsiIntersectionType)type).getConflictingConjunctsMessage();
      if (conflictingConjunctsMessage != null) {
        return registerIncompatibleErrorMessage(var,"Type parameter " + var.getParameter().getName() + " has incompatible upper bounds: "+ conflictingConjunctsMessage);
      }
    }
  }
 else {
    for (    PsiType upperType : var.getBounds(InferenceBound.UPPER)) {
      if (isProperType(upperType)) {
        String incompatibleBoundsMessage=null;
        if (type != lowerBound && !TypeConversionUtil.isAssignable(upperType,type)) {
          incompatibleBoundsMessage=incompatibleBoundsMessage(var,substitutor,InferenceBound.EQ,EQUALITY_CONSTRAINTS_PRESENTATION,InferenceBound.UPPER,UPPER_BOUNDS_PRESENTATION);
        }
 else         if (type == lowerBound && !TypeConversionUtil.isAssignable(upperType,lowerBound)) {
          incompatibleBoundsMessage=incompatibleBoundsMessage(var,substitutor,InferenceBound.LOWER,LOWER_BOUNDS_PRESENTATION,InferenceBound.UPPER,UPPER_BOUNDS_PRESENTATION);
        }
        if (incompatibleBoundsMessage != null) {
          return registerIncompatibleErrorMessage(var,incompatibleBoundsMessage);
        }
      }
    }
  }
  return type;
}
