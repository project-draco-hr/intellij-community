{
  returnType=substituteWithInferenceVariables(returnType);
  final InferenceVariable inferenceVariable=shouldResolveAndInstantiate(returnType,targetType);
  if (inferenceVariable != null) {
    final PsiSubstitutor substitutor=resolveSubset(Collections.singletonList(inferenceVariable),mySiteSubstitutor);
    final PsiType substitutedReturnType=substitutor.substitute(inferenceVariable.getParameter());
    if (substitutedReturnType != null) {
      addConstraint(new TypeCompatibilityConstraint(targetType,PsiImplUtil.normalizeWildcardTypeByPosition(substitutedReturnType,(PsiExpression)myContext)));
    }
  }
 else {
    if (FunctionalInterfaceParameterizationUtil.isWildcardParameterized(returnType)) {
      final PsiClassType.ClassResolveResult resolveResult=PsiUtil.resolveGenericsClassInType(returnType);
      final PsiClass psiClass=resolveResult.getElement();
      if (psiClass != null) {
        LOG.assertTrue(returnType instanceof PsiClassType);
        final PsiTypeParameter[] typeParameters=psiClass.getTypeParameters();
        InferenceVariable[] copy=initBounds(null,typeParameters);
        final PsiType substitutedCapture=PsiImplUtil.normalizeWildcardTypeByPosition(returnType,(PsiExpression)myContext);
        myIncorporationPhase.addCapture(copy,(PsiClassType)substituteWithInferenceVariables(returnType));
        addConstraint(new TypeCompatibilityConstraint(targetType,substitutedCapture));
      }
    }
 else {
      addConstraint(new TypeCompatibilityConstraint(targetType,myErased ? TypeConversionUtil.erasure(returnType) : returnType));
    }
  }
}
