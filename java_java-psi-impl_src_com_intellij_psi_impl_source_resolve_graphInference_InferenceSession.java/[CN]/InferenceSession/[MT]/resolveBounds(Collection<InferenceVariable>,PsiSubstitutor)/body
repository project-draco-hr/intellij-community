{
  final Collection<InferenceVariable> allVars=new ArrayList<InferenceVariable>(inferenceVariables);
  while (!allVars.isEmpty()) {
    final List<InferenceVariable> vars=InferenceVariablesOrder.resolveOrder(allVars,this);
    if (!myIncorporationPhase.hasCaptureConstraints(vars)) {
      PsiSubstitutor firstSubstitutor=resolveSubset(vars,substitutor);
      if (hasBoundProblems(vars,firstSubstitutor)) {
        firstSubstitutor=null;
      }
      if (firstSubstitutor != null) {
        substitutor=firstSubstitutor;
        allVars.removeAll(vars);
        continue;
      }
    }
    if (!initFreshVariables(substitutor,vars)) {
      return null;
    }
    myIncorporationPhase.forgetCaptures(vars);
    if (!repeatInferencePhases()) {
      return null;
    }
  }
  return substitutor;
}
