{
  final Collection<InferenceVariable> allVars=new ArrayList<InferenceVariable>(inferenceVariables);
  while (!allVars.isEmpty()) {
    final List<InferenceVariable> vars=InferenceVariablesOrder.resolveOrder(allVars,this);
    List<InferenceVariable> unresolved=new ArrayList<InferenceVariable>();
    for (    InferenceVariable var : vars) {
      final PsiType eqBound=getEqualsBound(var,substitutor);
      if (eqBound == PsiType.NULL) {
        unresolved.add(var);
      }
    }
    if (!myIncorporationPhase.hasCaptureConstraints(unresolved)) {
      PsiSubstitutor firstSubstitutor=resolveSubset(vars,substitutor);
      if (hasBoundProblems(vars,firstSubstitutor)) {
        firstSubstitutor=null;
        unresolved=vars;
      }
      if (firstSubstitutor != null) {
        substitutor=firstSubstitutor;
        allVars.removeAll(vars);
        continue;
      }
    }
    if (!initFreshVariables(substitutor,unresolved)) {
      return null;
    }
    myIncorporationPhase.forgetCaptures(vars);
    if (!repeatInferencePhases()) {
      return null;
    }
  }
  return substitutor;
}
