{
  final PsiSubstitutor siteSubstitutor=mySiteSubstitutor;
  while (!additionalConstraints.isEmpty()) {
    final Set<ConstraintFormula> subset=buildSubset(additionalConstraints);
    final Set<InferenceVariable> varsToResolve=new LinkedHashSet<InferenceVariable>();
    for (    ConstraintFormula formula : subset) {
      if (formula instanceof InputOutputConstraintFormula) {
        final Set<InferenceVariable> inputVariables=((InputOutputConstraintFormula)formula).getInputVariables(this);
        if (inputVariables != null) {
          for (          InferenceVariable inputVariable : inputVariables) {
            varsToResolve.addAll(inputVariable.getDependencies(this));
          }
          varsToResolve.addAll(inputVariables);
        }
      }
    }
    PsiSubstitutor substitutor=resolveSubset(varsToResolve,retrieveNonPrimitiveEqualsBounds(getInferenceVariables()).putAll(siteSubstitutor));
    if (substitutor == null) {
      return false;
    }
    if (myContext instanceof PsiCallExpression) {
      PsiExpressionList argumentList=((PsiCallExpression)myContext).getArgumentList();
      LOG.assertTrue(argumentList != null);
      MethodCandidateInfo.updateSubstitutor(argumentList,substitutor);
    }
    try {
      for (      ConstraintFormula additionalConstraint : subset) {
        additionalConstraint.apply(substitutor,true);
      }
      myConstraints.addAll(subset);
      if (!repeatInferencePhases(true)) {
        return false;
      }
    }
  finally {
      LambdaUtil.ourFunctionTypes.set(null);
    }
  }
  return true;
}
