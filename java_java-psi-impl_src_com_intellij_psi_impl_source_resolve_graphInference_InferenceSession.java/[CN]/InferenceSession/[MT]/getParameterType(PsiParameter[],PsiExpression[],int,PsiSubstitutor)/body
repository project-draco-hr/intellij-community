{
  if (substitutor == null)   return null;
  PsiType parameterType=substitutor.substitute(parameters[i < parameters.length ? i : parameters.length - 1].getType());
  if (parameterType instanceof PsiEllipsisType) {
    final PsiExpression arg=args[i];
    if (arg instanceof PsiNewExpression) {
      if (((PsiNewExpression)arg).getArrayDimensions().length == parameterType.getArrayDimensions() || ((PsiNewExpression)arg).getArrayInitializer() != null) {
        return parameterType;
      }
    }
    if (arg instanceof PsiCallExpression) {
      final PsiMethod method=((PsiCallExpression)arg).resolveMethod();
      if (method != null) {
        final PsiType returnType=method.getReturnType();
        if (returnType != null && returnType.getArrayDimensions() == parameterType.getArrayDimensions()) {
          return parameterType;
        }
      }
    }
    if (args.length != parameters.length || PsiPolyExpressionUtil.isPolyExpression(arg) || arg != null && !(arg.getType() instanceof PsiArrayType)) {
      parameterType=((PsiEllipsisType)parameterType).getComponentType();
    }
  }
  return parameterType;
}
