{
  final Set<ConstraintFormula> subset=new HashSet<ConstraintFormula>();
  final Set<InferenceVariable> outputVariables=new HashSet<InferenceVariable>();
  for (  ConstraintFormula constraint : additionalConstraints) {
    if (constraint instanceof InputOutputConstraintFormula) {
      final Set<InferenceVariable> inputVariables=((InputOutputConstraintFormula)constraint).getInputVariables(this);
      final Set<InferenceVariable> outputVars=((InputOutputConstraintFormula)constraint).getOutputVariables(inputVariables,this);
      if (outputVars != null) {
        outputVariables.addAll(outputVars);
      }
    }
  }
  for (  ConstraintFormula constraint : additionalConstraints) {
    if (constraint instanceof InputOutputConstraintFormula) {
      final Set<InferenceVariable> inputVariables=((InputOutputConstraintFormula)constraint).getInputVariables(this);
      if (inputVariables != null) {
        boolean dependsOnOutput=false;
        for (        InferenceVariable inputVariable : inputVariables) {
          final Set<InferenceVariable> dependencies=inputVariable.getDependencies(this);
          dependencies.add(inputVariable);
          dependencies.retainAll(outputVariables);
          if (!dependencies.isEmpty()) {
            dependsOnOutput=true;
            break;
          }
        }
        if (!dependsOnOutput) {
          subset.add(constraint);
          varsToResolve.addAll(inputVariables);
        }
      }
 else {
        subset.add(constraint);
      }
    }
 else {
      subset.add(constraint);
    }
  }
  if (subset.isEmpty()) {
    subset.add(additionalConstraints.iterator().next());
  }
  additionalConstraints.removeAll(subset);
  return subset;
}
