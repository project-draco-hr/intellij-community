{
  final List<List<InferenceVariable>> independentVars=InferenceVariablesOrder.resolveOrder(inferenceVariables,this);
  for (  List<InferenceVariable> variables : independentVars) {
    for (    InferenceVariable inferenceVariable : variables) {
      if (inferenceVariable.getInstantiation() != PsiType.NULL)       continue;
      final PsiTypeParameter typeParameter=inferenceVariable.getParameter();
      try {
        final List<PsiType> eqBounds=inferenceVariable.getBounds(InferenceBound.EQ);
        final List<PsiType> lowerBounds=inferenceVariable.getBounds(InferenceBound.LOWER);
        final List<PsiType> upperBounds=inferenceVariable.getBounds(InferenceBound.UPPER);
        if (upperBounds.contains(null)) {
          inferenceVariable.setInstantiation(null);
          continue;
        }
        if (eqBounds.size() > 1) {
          for (Iterator<PsiType> iterator=eqBounds.iterator(); iterator.hasNext(); ) {
            PsiType eqBound=iterator.next();
            if (PsiUtil.resolveClassInType(eqBound) == typeParameter) {
              iterator.remove();
            }
          }
          if (eqBounds.size() > 1)           continue;
        }
        PsiType bound=eqBounds.isEmpty() ? null : acceptBoundsWithRecursiveDependencies(typeParameter,eqBounds.get(0),substitutor);
        if (bound != null) {
          inferenceVariable.setInstantiation(bound);
        }
 else {
          PsiType lub=null;
          for (          PsiType lowerBound : lowerBounds) {
            lowerBound=acceptBoundsWithRecursiveDependencies(typeParameter,lowerBound,substitutor);
            if (isProperType(lowerBound)) {
              if (lub == null) {
                lub=lowerBound;
              }
 else {
                lub=GenericsUtil.getLeastUpperBound(lub,lowerBound,myManager);
              }
            }
          }
          if (lub != null) {
            inferenceVariable.setInstantiation(lub instanceof PsiCapturedWildcardType ? ((PsiCapturedWildcardType)lub).getWildcard() : lub);
          }
 else {
            PsiType glb=null;
            if (isThrowable(upperBounds)) {
              glb=PsiType.getJavaLangRuntimeException(myManager,GlobalSearchScope.allScope(myManager.getProject()));
            }
 else {
              for (              PsiType upperBound : upperBounds) {
                upperBound=acceptBoundsWithRecursiveDependencies(typeParameter,upperBound,substitutor);
                if (isProperType(upperBound)) {
                  if (glb == null) {
                    glb=upperBound;
                  }
 else {
                    glb=GenericsUtil.getGreatestLowerBound(glb,upperBound);
                  }
                }
              }
            }
            if (glb != null && (acceptObject || !glb.equalsToText(CommonClassNames.JAVA_LANG_OBJECT))) {
              inferenceVariable.setInstantiation(glb);
            }
          }
        }
      }
  finally {
        final PsiType instantiation=inferenceVariable.getInstantiation();
        if (instantiation != PsiType.NULL) {
          substitutor=substitutor.put(typeParameter,instantiation);
        }
      }
    }
  }
  return substitutor;
}
