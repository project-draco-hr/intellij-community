{
  if (formula instanceof ExpressionCompatibilityConstraint) {
    final PsiExpression expression=((ExpressionCompatibilityConstraint)formula).getExpression();
    final PsiCall callExpression=PsiTreeUtil.getParentOfType(expression,PsiCall.class,false);
    if (callExpression != null) {
      final InferenceSession session=myInferenceSessionContainer.findNestedCallSession(callExpression,null);
      if (session != null) {
        formula.apply(session.myInferenceSubstitution,true);
        collectVarsToResolve(varsToResolve,(InputOutputConstraintFormula)formula);
      }
    }
  }
  PsiSubstitutor substitutor=resolveSubsetOrdered(varsToResolve,siteSubstitutor);
  if (myContext instanceof PsiCall) {
    PsiExpressionList argumentList=((PsiCall)myContext).getArgumentList();
    LOG.assertTrue(argumentList != null);
    MethodCandidateInfo.updateSubstitutor(argumentList,substitutor);
  }
  try {
    formula.apply(substitutor,true);
    myConstraints.add(formula);
    if (!repeatInferencePhases(true)) {
      return false;
    }
    if (formula instanceof ExpressionCompatibilityConstraint) {
      PsiExpression expression=((ExpressionCompatibilityConstraint)formula).getExpression();
      if (expression instanceof PsiLambdaExpression) {
        PsiType parameterType=((ExpressionCompatibilityConstraint)formula).getT();
        collectLambdaReturnExpression(additionalConstraints,(PsiLambdaExpression)expression,parameterType,!isProperType(parameterType));
      }
    }
  }
  finally {
    if (formula instanceof InputOutputConstraintFormula) {
      LambdaUtil.getFunctionalTypeMap().remove(((InputOutputConstraintFormula)formula).getExpression());
    }
  }
  return true;
}
