{
  PsiSubstitutor substitutor=resolveSubsetOrdered(varsToResolve,siteSubstitutor);
  if (myContext instanceof PsiCall) {
    PsiExpressionList argumentList=((PsiCall)myContext).getArgumentList();
    LOG.assertTrue(argumentList != null);
    MethodCandidateInfo.updateSubstitutor(argumentList,substitutor);
  }
  formula.apply(substitutor,true);
  addConstraint(formula);
  if (!repeatInferencePhases(true)) {
    return false;
  }
  if (formula instanceof ExpressionCompatibilityConstraint) {
    PsiExpression expression=((ExpressionCompatibilityConstraint)formula).getExpression();
    if (expression instanceof PsiLambdaExpression) {
      PsiType parameterType=FunctionalInterfaceParameterizationUtil.getGroundTargetType(((ExpressionCompatibilityConstraint)formula).getT(),(PsiLambdaExpression)expression);
      collectLambdaReturnExpression(additionalConstraints,(PsiLambdaExpression)expression,parameterType,!isProperType(parameterType),substitutor);
    }
  }
  return true;
}
