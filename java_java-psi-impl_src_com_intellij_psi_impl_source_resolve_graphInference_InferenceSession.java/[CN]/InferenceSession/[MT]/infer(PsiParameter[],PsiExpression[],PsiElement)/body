{
  final MethodCandidateInfo.CurrentCandidateProperties properties=getCurrentProperties(parent);
  if (!repeatInferencePhases(true)) {
    return resolveSubset(myInferenceVariables,mySiteSubstitutor);
  }
  if (properties != null && !properties.isApplicabilityCheck()) {
    initReturnTypeConstraint(properties.getMethod(),(PsiCallExpression)parent);
    if (!repeatInferencePhases(true)) {
      return prepareSubstitution();
    }
    if (parameters != null && args != null && !MethodCandidateInfo.ourOverloadGuard.currentStack().contains(PsiUtil.skipParenthesizedExprUp(parent.getParent()))) {
      final Set<ConstraintFormula> additionalConstraints=new LinkedHashSet<ConstraintFormula>();
      if (parameters.length > 0) {
        collectAdditionalConstraints(parameters,args,properties.getMethod(),PsiSubstitutor.EMPTY,additionalConstraints,properties.isVarargs());
      }
      if (!additionalConstraints.isEmpty() && !proceedWithAdditionalConstraints(additionalConstraints)) {
        return prepareSubstitution().putAll(retrieveNonPrimitiveEqualsBounds(myInferenceVariables));
      }
    }
  }
  final PsiSubstitutor substitutor=resolveBounds(myInferenceVariables,PsiSubstitutor.EMPTY);
  if (substitutor != null) {
    if (myContext != null) {
      myContext.putUserData(ERASED,myErased);
    }
    mySiteSubstitutor=mySiteSubstitutor.putAll(substitutor);
    for (    InferenceVariable variable : myInferenceVariables) {
      variable.setInstantiation(substitutor.substitute(variable.getParameter()));
    }
  }
 else {
    return prepareSubstitution();
  }
  return prepareSubstitution();
}
