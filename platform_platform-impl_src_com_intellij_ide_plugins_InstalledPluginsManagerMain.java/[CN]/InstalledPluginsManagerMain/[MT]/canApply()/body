{
  final Map<PluginId,Set<PluginId>> dependentToRequiredListMap=new HashMap<PluginId,Set<PluginId>>(((InstalledPluginsTableModel)pluginsModel).getDependentToRequiredListMap());
  for (Iterator<PluginId> iterator=dependentToRequiredListMap.keySet().iterator(); iterator.hasNext(); ) {
    final PluginId id=iterator.next();
    boolean hasNonModuleDeps=false;
    for (    PluginId pluginId : dependentToRequiredListMap.get(id)) {
      if (!PluginManager.isModuleDependency(pluginId)) {
        hasNonModuleDeps=true;
        break;
      }
    }
    if (!hasNonModuleDeps) {
      iterator.remove();
    }
  }
  if (!dependentToRequiredListMap.isEmpty()) {
    final StringBuffer sb=new StringBuffer("<html><body style=\"padding: 5px;\">Unable to apply changes: plugin").append(dependentToRequiredListMap.size() == 1 ? " " : "s ");
    sb.append(StringUtil.join(dependentToRequiredListMap.keySet(),new Function<PluginId,String>(){
      public String fun(      final PluginId pluginId){
        final IdeaPluginDescriptor ideaPluginDescriptor=PluginManager.getPlugin(pluginId);
        return "\"" + (ideaPluginDescriptor != null ? ideaPluginDescriptor.getName() : pluginId.getIdString()) + "\"";
      }
    }
,", "));
    sb.append(" won't be able to load.</body></html>");
    return sb.toString();
  }
  return super.canApply();
}
