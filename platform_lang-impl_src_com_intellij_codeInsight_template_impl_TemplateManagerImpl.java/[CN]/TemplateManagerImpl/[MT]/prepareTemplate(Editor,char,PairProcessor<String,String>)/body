{
  if (editor.getSelectionModel().hasSelection()) {
    return null;
  }
  PsiFile file=PsiUtilBase.getPsiFileInEditor(editor,myProject);
  if (file == null)   return null;
  TemplateSettings templateSettings=TemplateSettings.getInstance();
  Map<TemplateImpl,String> template2argument=findMatchingTemplates(file,editor,shortcutChar,templateSettings);
  for (  final CustomLiveTemplate customLiveTemplate : CustomLiveTemplate.EP_NAME.getExtensions()) {
    if (shortcutChar == customLiveTemplate.getShortcut()) {
      if (editor.getCaretModel().getCaretCount() > 1 && !supportsMultiCaretMode(customLiveTemplate)) {
        continue;
      }
      final Document document=editor.getDocument();
      PsiDocumentManager.getInstance(myProject).commitDocument(document);
      if (isApplicable(customLiveTemplate,editor,file)) {
        final CustomTemplateCallback callback=new CustomTemplateCallback(editor,file);
        final String key=customLiveTemplate.computeTemplateKey(callback);
        if (key != null) {
          int caretOffset=editor.getCaretModel().getOffset();
          int offsetBeforeKey=caretOffset - key.length();
          CharSequence text=document.getImmutableCharSequence();
          if (template2argument == null || !containsTemplateStartingBefore(template2argument,offsetBeforeKey,caretOffset,text)) {
            return new Runnable(){
              @Override public void run(){
                customLiveTemplate.expand(key,callback);
              }
            }
;
          }
        }
      }
    }
  }
  return startNonCustomTemplates(template2argument,editor,processor);
}
