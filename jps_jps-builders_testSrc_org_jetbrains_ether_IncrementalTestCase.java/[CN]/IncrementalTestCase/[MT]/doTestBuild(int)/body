{
  StringBuilder log=new StringBuilder();
  String rootPath=FileUtil.toSystemIndependentName(workDir.getAbsolutePath()) + "/";
  final ProjectDescriptor pd=createProjectDescriptor(new BuildLoggingManager(new StringProjectBuilderLogger(rootPath,log)));
  BuildResult result=null;
  try {
    doBuild(pd,CompileScopeTestBuilder.rebuild().allModules()).assertSuccessful();
    for (int idx=0; idx < makesCount; idx++) {
      modify(idx);
      result=doBuild(pd,CompileScopeTestBuilder.make().allModules());
    }
    File logFile=new File(baseDir.getAbsolutePath() + ".log");
    if (!logFile.exists()) {
      logFile=new File(baseDir,"build.log");
    }
    assertSameLinesWithFile(logFile.getAbsolutePath(),log.toString());
  }
  finally {
    pd.release();
  }
  assertNotNull(result);
  if (result.isSuccessful()) {
    checkMappingsAreSameAfterRebuild(result);
  }
  return result;
}
