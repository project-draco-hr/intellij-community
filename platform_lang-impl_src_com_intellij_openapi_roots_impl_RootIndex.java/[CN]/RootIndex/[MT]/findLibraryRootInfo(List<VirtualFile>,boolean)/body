{
  Set<Library> excludedFromLibraries=ContainerUtil.newHashSet();
  for (  VirtualFile root : hierarchy) {
    excludedFromLibraries.addAll(myRoots.excludedFromLibraries.get(root));
    if (source && myRoots.libSourceRootEntries.containsKey(root) && (!myRoots.sourceOfLibraries.containsKey(root) || !excludedFromLibraries.containsAll(myRoots.sourceOfLibraries.get(root)))) {
      return root;
    }
 else     if (!source && myRoots.libClassRootEntries.containsKey(root) && (!myRoots.classOfLibraries.containsKey(root) || !excludedFromLibraries.containsAll(myRoots.classOfLibraries.get(root)))) {
      return root;
    }
  }
  return null;
}
