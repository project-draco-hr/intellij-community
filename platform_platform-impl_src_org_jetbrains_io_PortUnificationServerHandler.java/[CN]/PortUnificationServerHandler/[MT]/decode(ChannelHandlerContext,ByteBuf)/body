{
  ChannelPipeline pipeline=context.pipeline();
  if (detectSsl && SslHandler.isEncrypted(buffer)) {
    SSLEngine engine=SSL_SERVER_CONTEXT.getValue().createSSLEngine();
    engine.setUseClientMode(false);
    pipeline.addLast("ssl",new SslHandler(engine));
    pipeline.addLast("streamer",new ChunkedWriteHandler());
    pipeline.addLast("unificationWOSsl",new PortUnificationServerHandler(delegatingHttpRequestHandler,false,detectGzip));
  }
 else {
    int magic1=buffer.getUnsignedByte(buffer.readerIndex());
    int magic2=buffer.getUnsignedByte(buffer.readerIndex() + 1);
    if (detectGzip && magic1 == 31 && magic2 == 139) {
      pipeline.addLast("gzipDeflater",new JZlibEncoder(ZlibWrapper.GZIP));
      pipeline.addLast("gzipInflater",new JdkZlibDecoder(ZlibWrapper.GZIP));
      pipeline.addLast("unificationWOGzip",new PortUnificationServerHandler(delegatingHttpRequestHandler,detectSsl,false));
    }
 else {
      NettyUtil.initHttpHandlers(pipeline);
      pipeline.addLast("handler",delegatingHttpRequestHandler);
    }
  }
  pipeline.remove(this);
  context.fireChannelRead(buffer);
}
