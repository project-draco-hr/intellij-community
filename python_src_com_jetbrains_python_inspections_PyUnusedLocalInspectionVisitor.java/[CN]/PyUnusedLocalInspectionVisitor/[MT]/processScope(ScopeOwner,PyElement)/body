{
  if (owner.getContainingFile() instanceof PyExpressionCodeFragment || PydevConsoleRunner.isInPydevConsole(owner)) {
    return;
  }
  if (callsLocals(owner))   return;
  boolean parametersCanBeUnused=true;
  if (owner instanceof PyFunction) {
    parametersCanBeUnused=PySuperMethodsSearch.search(((PyFunction)owner)).findFirst() == null && PyOverridingMethodsSearch.search((PyFunction)owner,true).findFirst() == null;
  }
  final Scope scope=owner.getScope();
  final ControlFlow flow=owner.getControlFlow();
  final Instruction[] instructions=flow.getInstructions();
  for (int i=0; i < instructions.length; i++) {
    final Instruction instruction=instructions[i];
    final PsiElement element=instruction.getElement();
    if (element instanceof PyFunction && owner instanceof PyFunction) {
      if (!myUsedElements.contains(element)) {
        myUnusedElements.add(element);
      }
    }
 else     if (instruction instanceof ReadWriteInstruction) {
      final String name=((ReadWriteInstruction)instruction).getName();
      if (name == null || "_".equals(name) || scope.isGlobal(name)) {
        continue;
      }
      if (element == null || !PsiTreeUtil.isAncestor(node,element,false)) {
        continue;
      }
      if (PyImportStatementNavigator.getImportStatementByElement(element) != null) {
        continue;
      }
      if (element instanceof PyQualifiedExpression && ((PyQualifiedExpression)element).getQualifier() != null) {
        continue;
      }
      final ReadWriteInstruction.ACCESS access=((ReadWriteInstruction)instruction).getAccess();
      if (access.isWriteAccess() && (parametersCanBeUnused || !isParameter(element))) {
        if (!myUsedElements.contains(element)) {
          myUnusedElements.add(element);
        }
      }
    }
  }
  for (int i=0; i < instructions.length; i++) {
    final Instruction instruction=instructions[i];
    if (instruction instanceof ReadWriteInstruction) {
      final String name=((ReadWriteInstruction)instruction).getName();
      if (name == null) {
        continue;
      }
      final PsiElement element=instruction.getElement();
      if (element == null || !PsiTreeUtil.isAncestor(node,element,false)) {
        continue;
      }
      final ReadWriteInstruction.ACCESS access=((ReadWriteInstruction)instruction).getAccess();
      if (access.isReadAccess()) {
        int number=i;
        if (access == ReadWriteInstruction.ACCESS.READWRITE) {
          final PyAugAssignmentStatement augAssignmentStatement=PyAugAssignmentStatementNavigator.getStatementByTarget(element);
          number=ControlFlowUtil.findInstructionNumberByElement(instructions,augAssignmentStatement);
        }
        if (element instanceof PyReferenceExpression) {
          boolean outOfScope=false;
          for (          ResolveResult result : ((PyReferenceExpression)element).getReference().multiResolve(false)) {
            final PsiElement resolveElement=result.getElement();
            if (resolveElement != null && !PsiTreeUtil.isAncestor(owner,resolveElement,false)) {
              outOfScope=true;
              myUsedElements.add(element);
              myUsedElements.add(resolveElement);
              myUnusedElements.remove(element);
              myUnusedElements.remove(resolveElement);
            }
          }
          if (outOfScope) {
            continue;
          }
        }
        PyControlFlowUtil.iteratePrev(number,instructions,new Function<Instruction,PyControlFlowUtil.Operation>(){
          public PyControlFlowUtil.Operation fun(          final Instruction inst){
            final PsiElement element=inst.getElement();
            if (element instanceof PyFunction) {
              if (name.equals(((PyFunction)element).getName())) {
                myUsedElements.add(element);
                myUnusedElements.remove(element);
                return PyControlFlowUtil.Operation.CONTINUE;
              }
            }
 else             if (inst instanceof ReadWriteInstruction) {
              final ReadWriteInstruction rwInstruction=(ReadWriteInstruction)inst;
              if (!name.equals(rwInstruction.getName()) || !rwInstruction.getAccess().isWriteAccess()) {
                return PyControlFlowUtil.Operation.NEXT;
              }
              if (element == null || !PsiTreeUtil.isAncestor(node,element,false)) {
                return PyControlFlowUtil.Operation.CONTINUE;
              }
              myUsedElements.add(element);
              myUnusedElements.remove(element);
              if (PsiTreeUtil.getParentOfType(element,PyTryPart.class) != null) {
                return PyControlFlowUtil.Operation.NEXT;
              }
              return PyControlFlowUtil.Operation.CONTINUE;
            }
            return PyControlFlowUtil.Operation.NEXT;
          }
        }
);
      }
    }
  }
}
