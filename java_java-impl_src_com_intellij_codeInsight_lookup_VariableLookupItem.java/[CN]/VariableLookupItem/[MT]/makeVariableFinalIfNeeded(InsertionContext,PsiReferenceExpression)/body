{
  if (!Registry.is("java.completion.make.outer.variables.final") || ref == null || PsiUtil.isLanguageLevel8OrHigher(ref) || JspPsiUtil.isInJspFile(ref)) {
    return;
  }
  PsiElement target=ref.resolve();
  if (target instanceof PsiLocalVariable || target instanceof PsiParameter) {
    PsiClass placeClass=PsiTreeUtil.findElementOfClassAtOffset(context.getFile(),context.getTailOffset() - 1,PsiClass.class,false);
    if (placeClass != null && !PsiTreeUtil.isAncestor(placeClass,target,true) && !HighlightControlFlowUtil.isReassigned((PsiVariable)target,new HashMap<PsiElement,Collection<ControlFlowUtil.VariableInfo>>())) {
      PsiModifierList modifierList=((PsiVariable)target).getModifierList();
      if (modifierList != null) {
        modifierList.setModifierProperty(PsiModifier.FINAL,true);
      }
    }
  }
}
