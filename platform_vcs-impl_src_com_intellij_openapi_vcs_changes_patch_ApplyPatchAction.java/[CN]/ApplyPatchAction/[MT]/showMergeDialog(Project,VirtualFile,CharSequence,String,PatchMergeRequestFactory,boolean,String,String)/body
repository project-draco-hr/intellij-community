{
  final FileDocumentManager fileDocumentManager=FileDocumentManager.getInstance();
  Document document=fileDocumentManager.getDocument(file);
  if (document != null) {
    fileDocumentManager.saveDocument(document);
  }
  CharSequence fileContent=LoadTextUtil.loadText(file);
  if (fileContent == null || content == null) {
    return ApplyPatchStatus.FAILURE;
  }
  if (MergeTool.LOG.isDebugEnabled()) {
    MergeTool.LOG.debug("ApplyPatch: project: " + project + ", document: "+ document+ ", file.valid: "+ file.isValid()+ ", fileType: "+ file.getFileType()+ (document != null ? ", writable: " + document.isWritable() : ""));
  }
  final MergeRequest request=mergeRequestFactory.createMergeRequest(fileContent.toString(),patchedContent,content.toString(),file,project,reverse,leftPanelTitle,rightPanelTitle);
  if (MergeTool.LOG.isDebugEnabled()) {
    DiffContent baseContent=request.getContents()[1];
    MergeTool.LOG.debug("ApplyPatch: base content: " + baseContent.getClass() + ", writable: "+ baseContent.getDocument().isWritable());
    MergeTool.LOG.debug("Custom DiffTools: " + DiffManagerImpl.getInstanceEx().getAdditionTools());
  }
  DiffManager.getInstance().getDiffTool().show(request);
  if (request.getResult() == DialogWrapper.OK_EXIT_CODE) {
    return ApplyPatchStatus.SUCCESS;
  }
  request.restoreOriginalContent();
  return ApplyPatchStatus.FAILURE;
}
