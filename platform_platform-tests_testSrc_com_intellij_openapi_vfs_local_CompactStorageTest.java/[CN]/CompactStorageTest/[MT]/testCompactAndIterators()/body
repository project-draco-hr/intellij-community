{
  TIntArrayList recordsList=new TIntArrayList();
  final int recordCount=2000;
  for (int i=0; i < recordCount; ++i)   recordsList.add(createTestRecord());
  final int physicalRecordCount=myStorage.getLiveRecordsCount();
  for (int i=0; i < recordCount / 2; ++i)   myStorage.deleteRecord(recordsList.getQuick(i));
  int logicalRecordCount=countLiveLogicalRecords();
  assertEquals(recordCount / 2,logicalRecordCount);
  Disposer.dispose(myStorage);
  myStorage=createStorage(getFileName());
  assertEquals(myStorage.getLiveRecordsCount(),physicalRecordCount / 2);
  logicalRecordCount=0;
  RecordIdIterator recordIdIterator=myStorage.createRecordIdIterator();
  while (recordIdIterator.hasNextId()) {
    boolean validId=recordIdIterator.validId();
    int nextId=recordIdIterator.nextId();
    if (!validId)     continue;
    ++logicalRecordCount;
    checkTestRecord(nextId);
  }
  assertEquals(recordCount / 2,logicalRecordCount);
}
