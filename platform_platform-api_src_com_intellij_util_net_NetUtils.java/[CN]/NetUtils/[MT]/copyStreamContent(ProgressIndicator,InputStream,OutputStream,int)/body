{
  if (indicator != null) {
    indicator.checkCanceled();
    if (expectedContentLength < 0) {
      indicator.setIndeterminate(true);
    }
  }
  CompressedBytesReadAwareGZIPInputStream gzipStream=ObjectUtils.tryCast(inputStream,CompressedBytesReadAwareGZIPInputStream.class);
  final byte[] buffer=new byte[8 * 1024];
  int count;
  int bytesWritten=0;
  long bytesRead=0;
  while ((count=inputStream.read(buffer)) > 0) {
    outputStream.write(buffer,0,count);
    bytesWritten+=count;
    bytesRead=gzipStream != null ? gzipStream.getCompressedBytesRead() : bytesWritten;
    if (indicator != null) {
      indicator.checkCanceled();
      if (expectedContentLength > 0) {
        indicator.setFraction((double)bytesRead / expectedContentLength);
      }
    }
  }
  if (indicator != null) {
    indicator.checkCanceled();
  }
  if (bytesRead < expectedContentLength) {
    throw new IOException(String.format("Connection closed at byte %d. Expected %d bytes.",bytesRead,expectedContentLength));
  }
  return bytesWritten;
}
