{
  this.project=project;
  final DefaultMutableTreeNode root=new DefaultMutableTreeNode(null);
  patternTreeModel=new DefaultTreeModel(root);
  patternTree=createTree(patternTreeModel);
  DefaultMutableTreeNode parent=null;
  String lastCategory=null;
  final List<DefaultMutableTreeNode> nodesToExpand=new ArrayList<DefaultMutableTreeNode>();
  final List<Configuration> predefined=StructuralSearchUtil.getPredefinedTemplates();
  for (  final Configuration info : predefined) {
    final DefaultMutableTreeNode node=new DefaultMutableTreeNode(info);
    if (lastCategory == null || !lastCategory.equals(info.getCategory())) {
      if (info.getCategory().length() > 0) {
        root.add(parent=new DefaultMutableTreeNode(info.getCategory()));
        nodesToExpand.add(parent);
        lastCategory=info.getCategory();
      }
 else {
        root.add(node);
        continue;
      }
    }
    parent.add(node);
  }
  final ConfigurationManager configurationManager=ConfigurationManager.getInstance(project);
  userTemplatesNode=new DefaultMutableTreeNode(SSRBundle.message("user.defined.category"));
  root.add(userTemplatesNode);
  setUserTemplates(configurationManager);
  for (  final DefaultMutableTreeNode nodeToExpand : nodesToExpand) {
    patternTree.expandPath(new TreePath(new Object[]{root,nodeToExpand}));
  }
  final TreeExpander treeExpander=new DefaultTreeExpander(patternTree);
  final CommonActionsManager actionManager=CommonActionsManager.getInstance();
  panel=ToolbarDecorator.createDecorator(patternTree).setRemoveAction(new AnActionButtonRunnable(){
    @Override public void run(    AnActionButton button){
      final Object selection=patternTree.getLastSelectedPathComponent();
      if (!(selection instanceof DefaultMutableTreeNode)) {
        return;
      }
      final DefaultMutableTreeNode node=(DefaultMutableTreeNode)selection;
      if (!(node.getUserObject() instanceof Configuration)) {
        return;
      }
      final Configuration configuration=(Configuration)node.getUserObject();
      if (configuration.isPredefined()) {
        return;
      }
      final int[] rows=patternTree.getSelectionRows();
      if (rows != null && rows.length > 0) {
        patternTree.addSelectionRow(rows[0] - 1);
      }
      patternTreeModel.removeNodeFromParent(node);
      configurationManager.removeConfiguration(configuration);
    }
  }
).setRemoveActionUpdater(new AnActionButtonUpdater(){
    @Override public boolean isEnabled(    AnActionEvent e){
      final Object selection=patternTree.getLastSelectedPathComponent();
      if (selection instanceof DefaultMutableTreeNode) {
        final DefaultMutableTreeNode node=(DefaultMutableTreeNode)selection;
        final Object userObject=node.getUserObject();
        if (userObject instanceof Configuration) {
          final Configuration configuration=(Configuration)userObject;
          return !configuration.isPredefined();
        }
      }
      return false;
    }
  }
).addExtraAction(AnActionButton.fromAction(actionManager.createExpandAllAction(treeExpander,patternTree))).addExtraAction(AnActionButton.fromAction(actionManager.createCollapseAllAction(treeExpander,patternTree))).createPanel();
  new JPanel(new BorderLayout());
  configureSelectTemplateAction(patternTree);
  historyModel=new CollectionListModel<Configuration>(configurationManager.getHistoryConfigurations());
  historyPanel=new JPanel(new BorderLayout());
  historyPanel.add(BorderLayout.NORTH,new JLabel(SSRBundle.message("used.templates")));
  historyList=new JBList(historyModel);
  historyPanel.add(BorderLayout.CENTER,ScrollPaneFactory.createScrollPane(historyList));
  historyList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
  historyList.setSelectedIndex(0);
  final ListSpeedSearch speedSearch=new ListSpeedSearch(historyList,new Convertor<Object,String>(){
    @Override public String convert(    Object o){
      return o instanceof Configuration ? ((Configuration)o).getName() : o.toString();
    }
  }
);
  historyList.setCellRenderer(new ExistingTemplatesListCellRenderer(speedSearch));
  configureSelectTemplateAction(historyList);
}
