{
  long typeAndId=myStubElementTypeAndId;
  int stubId=(int)typeAndId;
  if (stubId != -1) {
    PsiFile file=restoreFile();
    if (!(file instanceof PsiFileWithStubSupport))     return null;
    short index=(short)(typeAndId >> 32);
    IStubElementType stubElementType=(IStubElementType)IElementType.find(index);
    return PsiAnchor.restoreFromStubIndex((PsiFileWithStubSupport)file,stubId,stubElementType,false);
  }
  if (!mySyncMarkerIsValid)   return null;
  PsiFile file=restoreFile();
  if (file == null)   return null;
  PsiElement anchor=file.findElementAt(getSyncStartOffset());
  if (anchor == null)   return null;
  TextRange range=anchor.getTextRange();
  if (range.getStartOffset() != getSyncStartOffset() || range.getEndOffset() != getSyncEndOffset())   return null;
  for (  SmartPointerAnchorProvider provider : SmartPointerAnchorProvider.EP_NAME.getExtensions()) {
    final PsiElement element=provider.restoreElement(anchor);
    if (element != null)     return element;
  }
  return null;
}
