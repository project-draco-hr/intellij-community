{
  Charset specified=extractCharsetFromFileContent(project,virtualFile,text);
  Pair.NonNull<Charset,byte[]> chosen=chooseMostlyHarmlessCharset(existing,specified,text);
  Charset charset=chosen.first;
  byte[] bom=virtualFile.getBOM();
  Charset fromBom=bom == null ? null : CharsetToolkit.guessFromBOM(bom);
  if (fromBom != null && !fromBom.equals(charset)) {
    chosen=Pair.createNonNull(fromBom,toBytes(text,fromBom));
  }
  return chosen;
}
