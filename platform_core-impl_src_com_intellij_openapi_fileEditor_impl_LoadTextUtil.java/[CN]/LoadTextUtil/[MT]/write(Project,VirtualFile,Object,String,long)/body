{
  Charset existing=virtualFile.getCharset();
  Pair.NonNull<Charset,byte[]> chosen=charsetForWriting(project,virtualFile,text,existing);
  Charset charset=chosen.first;
  byte[] buffer=chosen.second;
  if (!charset.equals(existing)) {
    virtualFile.setCharset(charset);
  }
  setDetectedFromBytesFlagBack(virtualFile,buffer);
  virtualFile.setBinaryContent(buffer,newModificationStamp,-1,requestor);
}
