{
  Charset defaultCharset=ObjectUtils.notNull(EncodingManager.getInstance().getEncoding(virtualFile,true),CharsetToolkit.getDefaultSystemCharset());
  CharsetToolkit toolkit=GUESS_UTF ? new CharsetToolkit(content,defaultCharset) : null;
  String detectedFromBytes=null;
  try {
    if (GUESS_UTF) {
      toolkit.setEnforce8Bit(true);
      Charset charset=toolkit.guessFromBOM();
      if (charset != null) {
        detectedFromBytes=AUTO_DETECTED_FROM_BOM;
        byte[] bom=ObjectUtils.notNull(CharsetToolkit.getMandatoryBom(charset),CharsetToolkit.UTF8_BOM);
        return Trinity.create(charset,null,bom);
      }
      CharsetToolkit.GuessedEncoding guessed=toolkit.guessFromContent(length);
      if (guessed == CharsetToolkit.GuessedEncoding.VALID_UTF8) {
        detectedFromBytes="auto-detected from bytes";
        return Trinity.create(CharsetToolkit.UTF8_CHARSET,guessed,null);
      }
      if (guessed == CharsetToolkit.GuessedEncoding.SEVEN_BIT) {
        return Trinity.create(null,guessed,null);
      }
    }
    return null;
  }
  finally {
    setCharsetWasDetectedFromBytes(virtualFile,detectedFromBytes);
  }
}
