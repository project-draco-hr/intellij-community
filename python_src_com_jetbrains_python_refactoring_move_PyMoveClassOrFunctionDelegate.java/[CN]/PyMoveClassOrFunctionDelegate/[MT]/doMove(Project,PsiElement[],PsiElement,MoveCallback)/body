{
  PsiNamedElement[] elementsToMove=new PsiNamedElement[elements.length];
  for (int i=0; i < elements.length; i++) {
    final PsiNamedElement e=getElementToMove(elements[i]);
    if (e == null) {
      return;
    }
    elementsToMove[i]=e;
  }
  String initialDestination=null;
  if (targetContainer instanceof PsiFile) {
    final VirtualFile virtualFile=((PsiFile)targetContainer).getVirtualFile();
    if (virtualFile != null) {
      initialDestination=FileUtil.toSystemDependentName(virtualFile.getPath());
    }
  }
  final PyMoveClassOrFunctionDialog dialog=new PyMoveClassOrFunctionDialog(project,elementsToMove,initialDestination);
  dialog.show();
  if (!dialog.isOK()) {
    return;
  }
  final String destination=dialog.getTargetPath();
  final boolean previewUsages=dialog.isPreviewUsages();
  try {
    final BaseRefactoringProcessor processor=new PyMoveClassOrFunctionProcessor(project,elementsToMove,destination,previewUsages);
    processor.run();
  }
 catch (  IncorrectOperationException e) {
    CommonRefactoringUtil.showErrorMessage(RefactoringBundle.message("error.title"),e.getMessage(),null,project);
  }
}
