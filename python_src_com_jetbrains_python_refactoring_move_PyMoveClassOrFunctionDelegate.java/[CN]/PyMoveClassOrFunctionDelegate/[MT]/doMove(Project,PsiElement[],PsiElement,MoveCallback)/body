{
  final List<PsiNamedElement> initialElements=Lists.newArrayList();
  for (  PsiElement element : elements) {
    final PsiNamedElement e=getElementToMove(element);
    if (e == null) {
      return;
    }
    initialElements.add(e);
  }
  String initialDestination=null;
  if (targetContainer instanceof PsiFile) {
    final VirtualFile virtualFile=((PsiFile)targetContainer).getVirtualFile();
    if (virtualFile != null) {
      initialDestination=FileUtil.toSystemDependentName(virtualFile.getPath());
    }
  }
  final PyMoveTopLevelSymbolDialog dialog=PyMoveTopLevelSymbolDialog.getInstance(project,initialElements,initialDestination);
  if (!dialog.showAndGet()) {
    return;
  }
  final String destination=dialog.getTargetPath();
  final boolean previewUsages=dialog.isPreviewUsages();
  try {
    final PsiNamedElement[] selectedElements=ContainerUtil.findAllAsArray(dialog.getSelectedTopLevelSymbols(),PsiNamedElement.class);
    final BaseRefactoringProcessor processor=new PyMoveClassOrFunctionProcessor(project,selectedElements,destination,previewUsages);
    processor.run();
  }
 catch (  IncorrectOperationException e) {
    CommonRefactoringUtil.showErrorMessage(RefactoringBundle.message("error.title"),e.getMessage(),null,project);
  }
}
