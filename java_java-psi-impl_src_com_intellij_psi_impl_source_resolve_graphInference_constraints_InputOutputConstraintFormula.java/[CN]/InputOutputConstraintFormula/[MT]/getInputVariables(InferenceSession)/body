{
  final PsiExpression psiExpression=getExpression();
  final PsiType type=getT();
  if (psiExpression instanceof PsiFunctionalExpression) {
    final InferenceVariable inferenceVariable=session.getInferenceVariable(type);
    if (inferenceVariable != null) {
      return Collections.singleton(inferenceVariable);
    }
    if (LambdaUtil.isFunctionalType(type)) {
      final PsiType functionType=psiExpression instanceof PsiLambdaExpression ? FunctionalInterfaceParameterizationUtil.getGroundTargetType(type,(PsiLambdaExpression)psiExpression,false) : type;
      final PsiClassType.ClassResolveResult resolveResult=PsiUtil.resolveGenericsClassInType(functionType);
      final PsiMethod interfaceMethod=LambdaUtil.getFunctionalInterfaceMethod(resolveResult);
      if (interfaceMethod != null) {
        final Set<InferenceVariable> result=new HashSet<InferenceVariable>();
        final PsiSubstitutor substitutor=LambdaUtil.getSubstitutor(interfaceMethod,resolveResult);
        if (psiExpression instanceof PsiLambdaExpression && !((PsiLambdaExpression)psiExpression).hasFormalParameterTypes() || psiExpression instanceof PsiMethodReferenceExpression && !((PsiMethodReferenceExpression)psiExpression).isExact()) {
          for (          PsiParameter parameter : interfaceMethod.getParameterList().getParameters()) {
            session.collectDependencies(substitutor.substitute(parameter.getType()),result);
          }
        }
        final PsiType returnType=interfaceMethod.getReturnType();
        if (returnType != null) {
          collectReturnTypeVariables(session,psiExpression,substitutor.substitute(returnType),result);
        }
        return result;
      }
    }
  }
  if (psiExpression instanceof PsiParenthesizedExpression) {
    final PsiExpression expression=((PsiParenthesizedExpression)psiExpression).getExpression();
    return expression != null ? createSelfConstraint(type,expression).getInputVariables(session) : null;
  }
  if (psiExpression instanceof PsiConditionalExpression) {
    final PsiExpression thenExpression=((PsiConditionalExpression)psiExpression).getThenExpression();
    final PsiExpression elseExpression=((PsiConditionalExpression)psiExpression).getElseExpression();
    final Set<InferenceVariable> thenResult=thenExpression != null ? createSelfConstraint(type,thenExpression).getInputVariables(session) : null;
    final Set<InferenceVariable> elseResult=elseExpression != null ? createSelfConstraint(type,elseExpression).getInputVariables(session) : null;
    if (thenResult == null) {
      return elseResult;
    }
 else     if (elseResult == null) {
      return thenResult;
    }
 else {
      thenResult.addAll(elseResult);
      return thenResult;
    }
  }
  return null;
}
