{
  if (!PsiPolyExpressionUtil.isPolyExpression(myExpression)) {
    PsiType exprType=myExpression.getType();
    if (session.isProperType(myT)) {
      final boolean assignmentCompatible=TypeConversionUtil.isAssignable(myT,exprType);
      if (!assignmentCompatible) {
        final PsiType type=myExpression.getType();
        session.registerIncompatibleErrorMessage((type != null ? type.getPresentableText() : myExpression.getText()) + " is not compatible with " + session.getPresentableText(myT));
      }
      return assignmentCompatible;
    }
    if (exprType instanceof PsiLambdaParameterType) {
      return false;
    }
    if (exprType instanceof PsiClassType) {
      if (((PsiClassType)exprType).resolve() == null) {
        return true;
      }
    }
    if (exprType != null && exprType != PsiType.NULL) {
      if (exprType instanceof PsiDisjunctionType) {
        exprType=((PsiDisjunctionType)exprType).getLeastUpperBound();
      }
      constraints.add(new TypeCompatibilityConstraint(myT,exprType));
    }
    return true;
  }
  if (myExpression instanceof PsiParenthesizedExpression) {
    final PsiExpression expression=((PsiParenthesizedExpression)myExpression).getExpression();
    if (expression != null) {
      constraints.add(new ExpressionCompatibilityConstraint(expression,myT));
      return true;
    }
  }
  if (myExpression instanceof PsiConditionalExpression) {
    final PsiExpression thenExpression=((PsiConditionalExpression)myExpression).getThenExpression();
    if (thenExpression != null) {
      constraints.add(new ExpressionCompatibilityConstraint(thenExpression,myT));
    }
    final PsiExpression elseExpression=((PsiConditionalExpression)myExpression).getElseExpression();
    if (elseExpression != null) {
      constraints.add(new ExpressionCompatibilityConstraint(elseExpression,myT));
    }
    return true;
  }
  if (myExpression instanceof PsiCall) {
    final InferenceSession callSession=reduceExpressionCompatibilityConstraint(session,myExpression,myT);
    if (callSession == null) {
      return false;
    }
    if (callSession != session) {
      session.getInferenceSessionContainer().registerNestedSession(callSession);
      session.propagateVariables(callSession.getInferenceVariables(),callSession.getRestoreNameSubstitution());
      if (callSession.isErased()) {
        session.setErased();
      }
    }
    return true;
  }
  if (myExpression instanceof PsiMethodReferenceExpression) {
    constraints.add(new PsiMethodReferenceCompatibilityConstraint(((PsiMethodReferenceExpression)myExpression),myT));
    return true;
  }
  if (myExpression instanceof PsiLambdaExpression) {
    constraints.add(new LambdaExpressionCompatibilityConstraint((PsiLambdaExpression)myExpression,myT));
    return true;
  }
  return true;
}
