{
  while (true) {
switch (state) {
case HEADER:
{
        ByteBuf buffer=getBufferIfSufficient(message,2,context);
        if (buffer == null) {
          message.release();
          return;
        }
        contentLength=buffer.readUnsignedShort();
        state=State.CONTENT;
      }
case CONTENT:
{
      ByteBuf buffer=getBufferIfSufficient(message,contentLength,context);
      if (buffer == null) {
        message.release();
        return;
      }
      String messageText=buffer.toString(buffer.readerIndex(),contentLength,CharsetUtil.UTF_8);
      buffer.skipBytes(contentLength);
      state=State.HEADER;
      context.writeAndFlush(Unpooled.copiedBuffer("got-" + messageText,CharsetUtil.UTF_8));
    }
}
}
}
