{
  final VirtualFile sourceRoot=ProjectRootManager.getInstance(project).getFileIndex().getSourceRootForFile(directory.getVirtualFile());
  if (sourceRoot == null) {
    Messages.showErrorDialog(project,RefactoringBundle.message("destination.directory.does.not.correspond.to.any.package"),RefactoringBundle.message("cannot.move"));
    return null;
  }
  final JavaRefactoringFactory factory=JavaRefactoringFactory.getInstance(project);
  final MoveDestination destination=myPreserveSourceRoot.isSelected() && myPreserveSourceRoot.isVisible() ? factory.createSourceFolderPreservingMoveDestination(aPackage.getQualifiedName()) : factory.createSourceRootMoveDestination(aPackage.getQualifiedName(),sourceRoot);
  MoveClassesOrPackagesProcessor processor=createMoveClassesOrPackagesProcessor(myDirectory.getProject(),myElementsToMove,destination,searchInComments,searchForTextOccurences,myMoveCallback);
  processor.setOpenInEditor(isOpenInEditor());
  if (processor.verifyValidPackageName()) {
    return processor;
  }
  return null;
}
