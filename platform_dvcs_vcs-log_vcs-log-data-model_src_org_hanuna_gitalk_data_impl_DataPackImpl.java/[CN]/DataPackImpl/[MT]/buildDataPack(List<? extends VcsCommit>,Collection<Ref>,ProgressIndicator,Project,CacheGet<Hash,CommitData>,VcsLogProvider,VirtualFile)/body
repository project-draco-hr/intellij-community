{
  for (  VcsCommit commit : commits) {
    commitDataCache.put(commit.getHash(),new CommitData(commit));
  }
  indicator.setText("Build graph");
  MyTimer timer=new MyTimer("graph build");
  MutableGraph graph=GraphBuilder.build(commits,allRefs);
  timer.print();
  timer.clear("graphModel build");
  GraphModel graphModel=new GraphModelImpl(graph,allRefs);
  timer.print();
  indicator.setText("Build print model");
  timer.clear("build printModel");
  final GraphPrintCellModel printCellModel=new GraphPrintCellModelImpl(graphModel.getGraph());
  timer.print();
  graphModel.addUpdateListener(new Consumer<UpdateRequest>(){
    @Override public void consume(    UpdateRequest key){
      printCellModel.recalculate(key);
    }
  }
);
  final RefsModel refsModel=new RefsModel(allRefs);
  graphModel.getFragmentManager().setUnconcealedNodeFunction(new Function<Node,Boolean>(){
    @NotNull @Override public Boolean fun(    @NotNull Node key){
      if (key.getDownEdges().isEmpty() || key.getUpEdges().isEmpty() || refsModel.isBranchRef(key.getCommitHash())) {
        return true;
      }
 else {
        return false;
      }
    }
  }
);
  return new DataPackImpl(graphModel,refsModel,printCellModel,project,commitDataCache,logProvider,root);
}
