{
  final boolean wrapInBulkUpdate=myActions.size() > 50;
  final Ref<DocumentEx> bulkDocument=new Ref<>();
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      try {
        for (        final UndoableAction action : isUndo ? ContainerUtil.iterateBackward(myActions) : myActions) {
          if (wrapInBulkUpdate) {
            DocumentEx newDocument=getDocumentToSetBulkMode(action);
            DocumentEx oldDocument=bulkDocument.get();
            if (oldDocument != null && !oldDocument.equals(newDocument))             oldDocument.setInBulkUpdate(false);
            if (newDocument != null && !newDocument.equals(oldDocument))             newDocument.setInBulkUpdate(true);
            bulkDocument.set(newDocument);
          }
          if (isUndo) {
            action.undo();
          }
 else {
            action.redo();
          }
        }
      }
 catch (      UnexpectedUndoException e) {
        reportUndoProblem(e,isUndo);
      }
 finally {
        DocumentEx document=bulkDocument.get();
        if (document != null) {
          document.setInBulkUpdate(false);
        }
      }
    }
  }
);
  commitAllDocuments();
}
