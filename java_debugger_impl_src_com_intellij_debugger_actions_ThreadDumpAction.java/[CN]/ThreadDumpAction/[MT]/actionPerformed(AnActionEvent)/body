{
  final Project project=CommonDataKeys.PROJECT.getData(e.getDataContext());
  if (project == null) {
    return;
  }
  DebuggerContextImpl context=(DebuggerManagerEx.getInstanceEx(project)).getContext();
  final DebuggerSession session=context.getDebuggerSession();
  if (session != null && session.isAttached()) {
    final DebugProcessImpl process=context.getDebugProcess();
    process.getManagerThread().invoke(new DebuggerCommandImpl(){
      protected void action() throws Exception {
        final VirtualMachineProxyImpl vm=process.getVirtualMachineProxy();
        vm.suspend();
        try {
          final List<ThreadState> threads=buildThreadStates(vm);
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            public void run(){
              XDebugSession xSession=session.getXDebugSession();
              if (xSession != null) {
                DebuggerSessionTab.addThreadDump(project,threads,xSession.getUI(),session);
              }
            }
          }
,ModalityState.NON_MODAL);
        }
  finally {
          vm.resume();
        }
      }
    }
);
  }
}
