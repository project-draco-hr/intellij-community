{
  Module module=e.getData(LangDataKeys.MODULE);
  VirtualFile[] vFiles=e.getData(PlatformDataKeys.VIRTUAL_FILE_ARRAY);
  if (module == null || vFiles == null) {
    return;
  }
  final ModifiableRootModel model=ModuleRootManager.getInstance(module).getModifiableModel();
  for (  VirtualFile vFile : vFiles) {
    ContentEntry entry=findContentEntry(model,vFile);
    if (entry != null) {
      final SourceFolder[] sourceFolders=entry.getSourceFolders();
      for (      SourceFolder sourceFolder : sourceFolders) {
        if (Comparing.equal(sourceFolder.getFile(),vFile)) {
          entry.removeSourceFolder(sourceFolder);
          break;
        }
      }
      if (!myUnmark) {
        if (myMarkAsExcluded) {
          entry.addExcludeFolder(vFile);
        }
 else {
          entry.addSourceFolder(vFile,myMarkAsTestSources);
        }
      }
    }
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      model.commit();
    }
  }
);
}
