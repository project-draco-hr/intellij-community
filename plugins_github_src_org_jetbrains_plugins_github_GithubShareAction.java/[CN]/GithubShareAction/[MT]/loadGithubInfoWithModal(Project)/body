{
  final Ref<GithubInfo> githubInfoRef=new Ref<GithubInfo>();
  final Ref<IOException> exceptionRef=new Ref<IOException>();
  ProgressManager.getInstance().run(new Task.Modal(project,"Access to GitHub",true){
    public void run(    @NotNull ProgressIndicator indicator){
      try {
        final Ref<List<GithubRepo>> availableReposRef=new Ref<List<GithubRepo>>();
        final GithubAuthData auth=GithubUtil.runAndGetValidAuth(project,indicator,new ThrowableConsumer<GithubAuthData,IOException>(){
          @Override public void consume(          GithubAuthData authData) throws IOException {
            availableReposRef.set(GithubApiUtil.getAvailableRepos(authData));
          }
        }
);
        final HashSet<String> names=new HashSet<String>();
        for (        GithubRepo info : availableReposRef.get()) {
          names.add(info.getName());
        }
        final GithubUserDetailed userInfo=GithubApiUtil.getCurrentUserInfo(auth);
        githubInfoRef.set(new GithubInfo(auth,userInfo,names));
      }
 catch (      IOException e) {
        exceptionRef.set(e);
      }
    }
  }
);
  if (!exceptionRef.isNull()) {
    if (exceptionRef.get() instanceof GithubAuthenticationCanceledException) {
      return null;
    }
    GithubNotifications.showErrorDialog(project,"Failed to connect to GitHub",exceptionRef.get().getMessage());
    return null;
  }
  return githubInfoRef.get();
}
