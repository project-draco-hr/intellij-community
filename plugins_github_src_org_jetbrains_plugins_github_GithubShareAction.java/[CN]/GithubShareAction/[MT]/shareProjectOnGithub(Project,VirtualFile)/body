{
  BasicAction.saveAll();
  final GitRepository gitRepository=GithubUtil.getGitRepository(project,file);
  final boolean gitDetected=gitRepository != null;
  final VirtualFile root=gitDetected ? gitRepository.getRoot() : project.getBaseDir();
  final GithubAuthDataHolder authHolder=GithubAuthDataHolder.createFromSettings();
  Set<String> existingRemotes=Collections.emptySet();
  if (gitDetected) {
    final String githubRemote=GithubUtil.findGithubRemoteUrl(gitRepository);
    if (githubRemote != null) {
      if (!checkExistingRemote(project,authHolder,githubRemote))       return;
    }
    existingRemotes=ContainerUtil.map2Set(gitRepository.getRemotes(),new Function<GitRemote,String>(){
      @Override public String fun(      GitRemote remote){
        return remote.getName();
      }
    }
);
  }
  final GithubInfo githubInfo=loadGithubInfoWithModal(authHolder,project);
  if (githubInfo == null) {
    return;
  }
  final GithubShareDialog shareDialog=new GithubShareDialog(project,githubInfo.getRepositoryNames(),existingRemotes,githubInfo.getUser().canCreatePrivateRepo());
  DialogManager.show(shareDialog);
  if (!shareDialog.isOK()) {
    return;
  }
  final boolean isPrivate=shareDialog.isPrivate();
  final String name=shareDialog.getRepositoryName();
  final String description=shareDialog.getDescription();
  final String remoteName=shareDialog.getRemoteName();
  new Task.Backgroundable(project,"Sharing project on GitHub..."){
    @Override public void run(    @NotNull ProgressIndicator indicator){
      LOG.info("Creating GitHub repository");
      indicator.setText("Creating GitHub repository...");
      final String url=createGithubRepository(project,authHolder,indicator,name,description,isPrivate);
      if (url == null) {
        return;
      }
      LOG.info("Successfully created GitHub repository");
      LOG.info("Binding local project with GitHub");
      if (!gitDetected) {
        LOG.info("No git detected, creating empty git repo");
        indicator.setText("Creating empty git repo...");
        if (!createEmptyGitRepository(project,root,indicator)) {
          return;
        }
      }
      GitRepositoryManager repositoryManager=GitUtil.getRepositoryManager(project);
      final GitRepository repository=repositoryManager.getRepositoryForRoot(root);
      LOG.assertTrue(repository != null,"GitRepository is null for root " + root);
      if (repository == null) {
        GithubNotifications.showError(project,"Failed to create GitHub Repository","Can't find Git repository");
        return;
      }
      final String remoteUrl=GithubUrlUtil.getCloneUrl(githubInfo.getUser().getLogin(),name);
      LOG.info("Adding GitHub as a remote host");
      indicator.setText("Adding GitHub as a remote host...");
      if (!GithubUtil.addGithubRemote(project,repository,remoteName,remoteUrl)) {
        return;
      }
      if (!performFirstCommitIfRequired(project,root,repository,indicator,name,url)) {
        return;
      }
      LOG.info("Pushing to github master");
      indicator.setText("Pushing to github master...");
      if (!pushCurrentBranch(project,repository,remoteName,remoteUrl,name,url)) {
        return;
      }
      GithubNotifications.showInfoURL(project,"Successfully shared project on GitHub",name,url);
    }
  }
.queue();
}
