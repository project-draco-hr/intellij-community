{
  final ScopeHighlighter highlighter=new ScopeHighlighter(editor,ranger);
  final DefaultListModel model=new DefaultListModel();
  for (  T expr : expressions) {
    model.addElement(SmartPointerManager.getInstance(expr.getProject()).createSmartPsiElementPointer(expr));
  }
  final JList list=new JBList(model);
  list.getSelectionModel().setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
  if (selection > -1)   list.setSelectedIndex(selection);
  list.setCellRenderer(new DefaultListCellRenderer(){
    @Override public Component getListCellRendererComponent(    final JList list,    final Object value,    final int index,    final boolean isSelected,    final boolean cellHasFocus){
      final Component rendererComponent=super.getListCellRendererComponent(list,value,index,isSelected,cellHasFocus);
      SmartPsiElementPointer<T> pointer=(SmartPsiElementPointer<T>)value;
      final T expr=pointer.getElement();
      if (expr != null) {
        String text=renderer.fun(expr);
        int firstNewLinePos=text.indexOf('\n');
        String trimmedText=text.substring(0,firstNewLinePos != -1 ? firstNewLinePos : Math.min(100,text.length()));
        if (trimmedText.length() != text.length())         trimmedText+=" ...";
        setText(trimmedText);
      }
 else {
        setForeground(JBColor.RED);
        setText("Invalid");
      }
      return rendererComponent;
    }
  }
);
  list.addListSelectionListener(new ListSelectionListener(){
    @Override public void valueChanged(    final ListSelectionEvent e){
      highlighter.dropHighlight();
      final int index=list.getSelectedIndex();
      if (index < 0)       return;
      SmartPsiElementPointer<T> pointer=((SmartPsiElementPointer<T>)model.get(index));
      final T expr=pointer.getElement();
      if (expr != null) {
        highlighter.highlight(expr,Collections.<PsiElement>singletonList(expr));
      }
    }
  }
);
  JBPopupFactory.getInstance().createListPopupBuilder(list).setTitle(title).setMovable(false).setResizable(false).setRequestFocus(true).setItemChoosenCallback(new Runnable(){
    @Override public void run(){
      SmartPsiElementPointer<T> value=(SmartPsiElementPointer<T>)list.getSelectedValue();
      T expr=value != null ? value.getElement() : null;
      if (expr != null) {
        callback.pass(expr);
      }
    }
  }
).addListener(new JBPopupAdapter(){
    @Override public void onClosed(    LightweightWindowEvent event){
      highlighter.dropHighlight();
    }
  }
).createPopup().showInBestPositionFor(editor);
}
