{
  PsiType type=expr.getType();
  if (type == null) {
    if (expr instanceof PsiArrayInitializerExpression) {
      PsiExpression[] initializers=((PsiArrayInitializerExpression)expr).getInitializers();
      if (initializers.length > 0) {
        PsiType initType=getTypeByExpression(initializers[0]);
        if (initType == null)         return null;
        return initType.createArrayType();
      }
    }
    if (expr instanceof PsiReferenceExpression && PsiUtil.isOnAssignmentLeftHand(expr)) {
      return getTypeByExpression(((PsiAssignmentExpression)expr.getParent()).getRExpression());
    }
    return null;
  }
  PsiClass refClass=PsiUtil.resolveClassInType(type);
  if (refClass instanceof PsiAnonymousClass) {
    type=((PsiAnonymousClass)refClass).getBaseClassType();
  }
  return GenericsUtil.getVariableTypeByExpressionType(type);
}
