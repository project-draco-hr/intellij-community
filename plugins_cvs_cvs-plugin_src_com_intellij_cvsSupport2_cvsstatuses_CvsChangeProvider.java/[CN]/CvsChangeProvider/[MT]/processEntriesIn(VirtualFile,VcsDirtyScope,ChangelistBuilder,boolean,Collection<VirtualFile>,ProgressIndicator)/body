{
  final FilePath path=VcsContextFactory.SERVICE.getInstance().createFilePathOn(dir);
  if (!scope.belongsTo(path)) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Skipping out of scope path " + path);
    }
    return;
  }
  final DirectoryContent dirContent=getDirectoryContent(dir,progress);
  for (  VirtualFile file : dirContent.getUnknownFiles()) {
    builder.processUnversionedFile(file);
  }
  for (  VirtualFile file : dirContent.getIgnoredFiles()) {
    builder.processIgnoredFile(file);
  }
  for (  Entry entry : dirContent.getDeletedDirectories()) {
    builder.processLocallyDeletedFile(VcsUtil.getFilePath(CvsVfsUtil.getFileFor(dir,entry.getFileName()),true));
  }
  for (  Entry entry : dirContent.getDeletedFiles()) {
    builder.processLocallyDeletedFile(VcsUtil.getFilePath(CvsVfsUtil.getFileFor(dir,entry.getFileName()),false));
  }
  progress.checkCanceled();
  checkSwitchedDir(dir,builder,scope,cvsRoots);
  if (CvsUtil.fileIsUnderCvs(dir) && dir.getChildren().length == 1 && dirContent.getDeletedFiles().isEmpty() && hasRemovedFiles(dirContent.getFiles())) {
    builder.processChange(new Change(CurrentContentRevision.create(path),CurrentContentRevision.create(path),FileStatus.DELETED),CvsVcs2.getKey());
  }
  for (  VirtualFileEntry fileEntry : dirContent.getFiles()) {
    processFile(dir,fileEntry.getVirtualFile(),fileEntry.getEntry(),builder,progress);
  }
  if (recursively) {
    for (    VirtualFile file : CvsVfsUtil.getChildrenOf(dir)) {
      progress.checkCanceled();
      if (file.isDirectory()) {
        if (!myVcsManager.isIgnored(file)) {
          processEntriesIn(file,scope,builder,true,cvsRoots,progress);
        }
 else {
          if (LOG.isDebugEnabled()) {
            LOG.debug("Skipping ignored path " + file.getPath());
          }
        }
      }
    }
  }
}
