{
synchronized (threadsUnderIndicator) {
    Set<Thread> threads=threadsUnderIndicator.get(indicator);
    if (threads != null) {
      for (      Thread thread : threads) {
        ProgressIndicator currentIndicator=getCurrentIndicator(thread);
        boolean underCancelledIndicator=currentIndicator == indicator;
        if (!underCancelledIndicator && currentIndicator instanceof WrappedProgressIndicator) {
          while (currentIndicator instanceof WrappedProgressIndicator) {
            ProgressIndicator originalProgressIndicator=((WrappedProgressIndicator)currentIndicator).getOriginalProgressIndicator();
            if (originalProgressIndicator == indicator) {
              underCancelledIndicator=true;
              break;
            }
            currentIndicator=originalProgressIndicator;
          }
        }
        if (underCancelledIndicator) {
          threadsUnderCanceledIndicator.add(thread);
        }
      }
    }
  }
}
