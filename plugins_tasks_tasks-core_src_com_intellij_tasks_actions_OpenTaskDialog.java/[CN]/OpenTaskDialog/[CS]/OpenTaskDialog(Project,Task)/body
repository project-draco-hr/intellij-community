{
  super(project,false);
  myProject=project;
  myTask=task;
  TaskManagerImpl taskManager=(TaskManagerImpl)TaskManager.getManager(myProject);
  setTitle("Open Task");
  myTaskNameLabel.setText(TaskUtil.getTrimmedSummary(task));
  myTaskNameLabel.setIcon(task.getIcon());
  TaskManagerImpl manager=(TaskManagerImpl)TaskManager.getManager(project);
  ControlBinder binder=new ControlBinder(manager.getState());
  binder.bindAnnotations(this);
  binder.reset();
  if (!TaskStateCombo.stateUpdatesSupportedFor(task)) {
    myUpdateState.setVisible(false);
    myTaskStateCombo.setVisible(false);
  }
  final boolean stateUpdatesEnabled=PropertiesComponent.getInstance(project).getBoolean(UPDATE_STATE_ENABLED,true);
  myUpdateState.setSelected(stateUpdatesEnabled);
  myUpdateState.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      final boolean selected=myUpdateState.isSelected();
      PropertiesComponent.getInstance(project).setValue(UPDATE_STATE_ENABLED,String.valueOf(selected));
      updateFields(false);
      if (selected) {
        myTaskStateCombo.scheduleUpdateOnce();
      }
    }
  }
);
  TaskManagerImpl.Config state=taskManager.getState();
  myClearContext.setSelected(state.clearContext);
  AbstractVcs vcs=manager.getActiveVcs();
  if (vcs == null) {
    myVcsPanel.setVisible(false);
  }
 else {
    ActionListener listener=new ActionListener(){
      @Override public void actionPerformed(      ActionEvent e){
        updateFields(false);
      }
    }
;
    myCreateChangelist.addActionListener(listener);
    myCreateBranch.addActionListener(listener);
    myCreateChangelist.setSelected(manager.getState().createChangelist);
    VcsTaskHandler[] handlers=VcsTaskHandler.getAllHandlers(project);
    if (handlers.length == 0) {
      myCreateBranch.setSelected(false);
      myCreateBranch.setVisible(false);
      myBranchName.setVisible(false);
      myFromLabel.setVisible(false);
      myBranchFrom.setVisible(false);
    }
 else {
      for (      VcsTaskHandler handler : handlers) {
        VcsTaskHandler.TaskInfo[] tasks=handler.getCurrentTasks();
        if (tasks.length > 0) {
          myVcsTaskHandler=handler;
          myBranchFrom.setModel(new DefaultComboBoxModel(tasks));
          myBranchFrom.setEnabled(true);
          final String startFrom=PropertiesComponent.getInstance(project).getValue(START_FROM_BRANCH);
          VcsTaskHandler.TaskInfo info=null;
          if (startFrom != null) {
            info=ContainerUtil.find(tasks,new Condition<VcsTaskHandler.TaskInfo>(){
              @Override public boolean value(              VcsTaskHandler.TaskInfo taskInfo){
                return startFrom.equals(taskInfo.getName());
              }
            }
);
          }
          if (info == null) {
            info=tasks[0];
          }
          myBranchFrom.setSelectedItem(info);
          myBranchFrom.addActionListener(new ActionListener(){
            @Override public void actionPerformed(            ActionEvent e){
              VcsTaskHandler.TaskInfo item=(VcsTaskHandler.TaskInfo)myBranchFrom.getSelectedItem();
              if (item != null) {
                PropertiesComponent.getInstance(project).setValue(START_FROM_BRANCH,item.getName());
              }
            }
          }
);
          break;
        }
      }
      myCreateBranch.setSelected(manager.getState().createBranch && myBranchFrom.getItemCount() > 0);
      myBranchFrom.setRenderer(new ColoredListCellRenderer<VcsTaskHandler.TaskInfo>(){
        @Override protected void customizeCellRenderer(        JList list,        VcsTaskHandler.TaskInfo value,        int index,        boolean selected,        boolean hasFocus){
          if (value != null) {
            append(value.getName());
          }
        }
      }
);
    }
    myBranchName.setText(taskManager.suggestBranchName(task));
    myChangelistName.setText(taskManager.getChangelistName(task));
  }
  updateFields(true);
  myTaskStateCombo.registerUpDownAction(myBranchName);
  myTaskStateCombo.registerUpDownAction(myChangelistName);
  if (myUpdateState.isSelected()) {
    myTaskStateCombo.scheduleUpdateOnce();
  }
  init();
}
