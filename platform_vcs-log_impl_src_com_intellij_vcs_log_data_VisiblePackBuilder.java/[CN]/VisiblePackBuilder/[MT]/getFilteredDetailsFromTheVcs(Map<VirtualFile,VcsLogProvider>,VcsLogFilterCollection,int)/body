{
  VcsLogRootFilter rootFilter=filterCollection.getRootFilter();
  VcsLogStructureFilter structureFilter=filterCollection.getStructureFilter();
  Pair<Set<VirtualFile>,MultiMap<VirtualFile,VirtualFile>> selectedRootsAndFiles=VcsLogFileFilter.collectRootsAndFiles(providers.keySet(),rootFilter,structureFilter);
  Collection<List<TimedVcsCommit>> logs=ContainerUtil.newArrayList();
  for (  Map.Entry<VirtualFile,VcsLogProvider> entry : providers.entrySet()) {
    VirtualFile root=entry.getKey();
    if (!selectedRootsAndFiles.first.contains(root) || filterCollection.getUserFilter() != null && filterCollection.getUserFilter().getUserNames(root).isEmpty()) {
      continue;
    }
    VcsLogFilterCollection rootSpecificCollection=filterCollection;
    if (rootSpecificCollection.getStructureFilter() != null) {
      rootSpecificCollection=replaceStructureFilter(filterCollection,new HashSet<VirtualFile>(selectedRootsAndFiles.second.get(root)));
    }
    List<TimedVcsCommit> matchingCommits=entry.getValue().getCommitsMatchingFilter(root,rootSpecificCollection,maxCount);
    logs.add(matchingCommits);
  }
  List<TimedVcsCommit> compoundLog=new VcsLogMultiRepoJoiner<Hash,TimedVcsCommit>().join(logs);
  return ContainerUtil.map(compoundLog,new Function<TimedVcsCommit,Hash>(){
    @Override public Hash fun(    TimedVcsCommit commit){
      return commit.getId();
    }
  }
);
}
