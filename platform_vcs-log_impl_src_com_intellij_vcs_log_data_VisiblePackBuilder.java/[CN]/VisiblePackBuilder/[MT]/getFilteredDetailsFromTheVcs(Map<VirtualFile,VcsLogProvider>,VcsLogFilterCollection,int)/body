{
  Set<VirtualFile> visibleRoots=VcsLogUtil.getAllVisibleRoots(providers.keySet(),filterCollection.getRootFilter(),filterCollection.getStructureFilter());
  Collection<CommitId> logs=ContainerUtil.newArrayList();
  for (  Map.Entry<VirtualFile,VcsLogProvider> entry : providers.entrySet()) {
    final VirtualFile root=entry.getKey();
    if (!visibleRoots.contains(root) || (filterCollection.getUserFilter() != null && filterCollection.getUserFilter().getUserNames(root).isEmpty())) {
      continue;
    }
    VcsLogFilterCollection rootSpecificCollection=filterCollection;
    if (rootSpecificCollection.getStructureFilter() != null) {
      rootSpecificCollection=replaceStructureFilter(filterCollection,ContainerUtil.newHashSet(VcsLogUtil.getFilteredFilesForRoot(root,filterCollection)));
    }
    List<TimedVcsCommit> matchingCommits=entry.getValue().getCommitsMatchingFilter(root,rootSpecificCollection,maxCount);
    logs.addAll(ContainerUtil.map(matchingCommits,new Function<TimedVcsCommit,CommitId>(){
      @Override public CommitId fun(      TimedVcsCommit commit){
        return new CommitId(commit.getId(),root);
      }
    }
));
  }
  return logs;
}
