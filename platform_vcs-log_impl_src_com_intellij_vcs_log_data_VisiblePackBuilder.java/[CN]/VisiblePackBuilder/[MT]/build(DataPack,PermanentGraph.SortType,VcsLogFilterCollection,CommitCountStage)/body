{
  long start=System.currentTimeMillis();
  VcsLogHashFilter hashFilter=filters.getHashFilter();
  if (hashFilter != null && !hashFilter.getHashes().isEmpty()) {
    return Pair.create(applyHashFilter(dataPack,hashFilter.getHashes(),sortType),commitCount);
  }
  Collection<VirtualFile> visibleRoots=VcsLogUtil.getAllVisibleRoots(dataPack.getLogProviders().keySet(),filters.getRootFilter(),filters.getStructureFilter());
  Set<Integer> matchingHeads=getMatchingHeads(dataPack.getRefsModel(),visibleRoots,filters);
  FilterResult filterResult=filterByDetails(dataPack,filters,commitCount,visibleRoots,matchingHeads);
  VisibleGraph<Integer> visibleGraph;
  if (matchesNothing(matchingHeads) || matchesNothing(filterResult.matchingCommits)) {
    visibleGraph=EmptyVisibleGraph.getInstance();
  }
 else {
    visibleGraph=dataPack.getPermanentGraph().createVisibleGraph(sortType,matchingHeads,filterResult.matchingCommits);
  }
  LOG.debug(StopWatch.formatTime(System.currentTimeMillis() - start) + " for filtering by " + filters);
  return Pair.create(new VisiblePack(dataPack,visibleGraph,filterResult.canRequestMore,filters),filterResult.commitCount);
}
