{
  int offset=editor.logicalPositionToOffset(editor.xyToLogicalPosition(p));
  if (editor.visualPositionToXY(editor.offsetToVisualPosition(offset)).x > p.x) {
    offset--;
  }
  return offset;
}
