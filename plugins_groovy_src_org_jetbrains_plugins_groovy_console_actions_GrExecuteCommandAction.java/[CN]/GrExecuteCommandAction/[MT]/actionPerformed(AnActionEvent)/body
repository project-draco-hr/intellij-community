{
  final Project project=e.getProject();
  final Editor editor=CommonDataKeys.EDITOR.getData(e.getDataContext());
  final VirtualFile virtualFile=CommonDataKeys.VIRTUAL_FILE.getData(e.getDataContext());
  if (project == null || editor == null || virtualFile == null)   return;
  final Document document=editor.getDocument();
  final TextRange selectedRange=EditorUtil.getSelectionInAnyMode(editor);
  final String command=(selectedRange.isEmpty() ? document.getText() : document.getText(selectedRange));
  final GroovyConsole existingConsole=virtualFile.getUserData(GroovyConsole.GROOVY_CONSOLE);
  if (existingConsole == null) {
    GroovyConsole.getOrCreateConsole(project,virtualFile,new Consumer<GroovyConsole>(){
      @Override public void consume(      GroovyConsole console){
        console.execute(command);
      }
    }
);
  }
 else {
    existingConsole.execute(command);
  }
}
