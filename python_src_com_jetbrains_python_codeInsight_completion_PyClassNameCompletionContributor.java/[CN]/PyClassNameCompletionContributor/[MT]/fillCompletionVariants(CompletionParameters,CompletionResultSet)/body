{
  if (parameters.isExtendedCompletion()) {
    final PsiElement element=parameters.getPosition();
    final PsiElement parent=element.getParent();
    if (parent instanceof PyReferenceExpression && ((PyReferenceExpression)parent).getQualifier() != null) {
      return;
    }
    if (parent instanceof PyStringLiteralExpression) {
      String prefix=parent.getText().substring(0,parameters.getOffset() - parent.getTextRange().getStartOffset());
      if (prefix.contains(".")) {
        return;
      }
    }
    final FileViewProvider provider=element.getContainingFile().getViewProvider();
    if (provider instanceof MultiplePsiFilesPerDocumentFileViewProvider)     return;
    if (PsiTreeUtil.getParentOfType(element,PyImportStatementBase.class) != null) {
      return;
    }
    final PsiFile originalFile=parameters.getOriginalFile();
    addVariantsFromIndex(result,originalFile,PyClassNameIndex.KEY,parent instanceof PyStringLiteralExpression ? STRING_LITERAL_INSERT_HANDLER : IMPORTING_INSERT_HANDLER,Conditions.<PyClass>alwaysTrue());
    addVariantsFromIndex(result,originalFile,PyFunctionNameIndex.KEY,getFunctionInsertHandler(parent),IS_TOPLEVEL);
    addVariantsFromIndex(result,originalFile,PyVariableNameIndex.KEY,parent instanceof PyStringLiteralExpression ? STRING_LITERAL_INSERT_HANDLER : IMPORTING_INSERT_HANDLER,IS_TOPLEVEL);
    addVariantsFromModules(result,originalFile,parent instanceof PyStringLiteralExpression);
  }
}
