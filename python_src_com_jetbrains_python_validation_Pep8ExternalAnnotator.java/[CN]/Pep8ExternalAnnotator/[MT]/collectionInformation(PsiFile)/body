{
  final Sdk sdk=PythonSdkType.findPythonSdk(ModuleUtilCore.findModuleForPsiElement(file));
  if (sdk == null)   return null;
  final String homePath=sdk.getHomePath();
  if (homePath == null)   return null;
  final InspectionProfile profile=InspectionProjectProfileManager.getInstance(file.getProject()).getInspectionProfile();
  final HighlightDisplayKey key=HighlightDisplayKey.find(PyPep8Inspection.INSPECTION_SHORT_NAME);
  if (!profile.isToolEnabled(key)) {
    return null;
  }
  final LocalInspectionToolWrapper profileEntry=(LocalInspectionToolWrapper)profile.getInspectionTool(PyPep8Inspection.INSPECTION_SHORT_NAME,file);
  final List<String> ignoredErrors=((PyPep8Inspection)profileEntry.getTool()).ignoredErrors;
  final int margin=CodeStyleSettingsManager.getInstance(file.getProject()).getCurrentSettings().RIGHT_MARGIN;
  return new State(homePath,file.getText(),profile.getErrorLevel(key,file),ignoredErrors,margin);
}
