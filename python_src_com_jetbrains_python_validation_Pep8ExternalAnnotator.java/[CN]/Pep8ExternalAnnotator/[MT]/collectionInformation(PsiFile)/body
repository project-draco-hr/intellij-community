{
  VirtualFile vFile=file.getVirtualFile();
  if (vFile == null || vFile.getFileType() != PythonFileType.INSTANCE) {
    return null;
  }
  Sdk sdk=PythonSdkType.findLocalCPython(ModuleUtilCore.findModuleForPsiElement(file));
  if (sdk == null)   return null;
  final String homePath=sdk.getHomePath();
  if (homePath == null)   return null;
  final InspectionProfile profile=InspectionProjectProfileManager.getInstance(file.getProject()).getInspectionProfile();
  final HighlightDisplayKey key=HighlightDisplayKey.find(PyPep8Inspection.INSPECTION_SHORT_NAME);
  if (!profile.isToolEnabled(key)) {
    return null;
  }
  final PyPep8Inspection inspection=(PyPep8Inspection)profile.getUnwrappedTool(PyPep8Inspection.KEY.toString(),file);
  final List<String> ignoredErrors=inspection.ignoredErrors;
  final int margin=CodeStyleSettingsManager.getInstance(file.getProject()).getCurrentSettings().RIGHT_MARGIN;
  return new State(homePath,file.getText(),profile.getErrorLevel(key,file),ignoredErrors,margin);
}
