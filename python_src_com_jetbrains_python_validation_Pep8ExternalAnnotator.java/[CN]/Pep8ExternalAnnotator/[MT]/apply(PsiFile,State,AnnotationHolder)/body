{
  if (annotationResult == null || !file.isValid())   return;
  final String text=file.getText();
  Project project=file.getProject();
  final Document document=PsiDocumentManager.getInstance(project).getDocument(file);
  for (  Problem problem : annotationResult.problems) {
    if (ignoreDueToSettings(project,problem))     continue;
    final int line=problem.myLine - 1;
    final int column=problem.myColumn - 1;
    int offset;
    if (document != null) {
      offset=line >= document.getLineCount() ? document.getTextLength() - 1 : document.getLineStartOffset(line) + column;
    }
 else {
      offset=StringUtil.lineColToOffset(text,line,column);
    }
    PsiElement problemElement=file.findElementAt(offset);
    if (!(problemElement instanceof PsiWhiteSpace) && !(problem.myCode.startsWith("E3"))) {
      final PsiElement elementAfter=file.findElementAt(offset + 1);
      if (elementAfter instanceof PsiWhiteSpace) {
        problemElement=elementAfter;
      }
    }
    if (problemElement != null) {
      TextRange problemRange=problemElement.getTextRange();
      if (crossesLineBoundary(document,text,problemRange)) {
        int lineEndOffset=document != null ? document.getLineEndOffset(line) : StringUtil.lineColToOffset(text,line + 1,0) - 1;
        problemRange=new TextRange(offset,lineEndOffset);
      }
      final Annotation annotation;
      final String message="PEP 8: " + problem.myDescription;
      if (annotationResult.level == HighlightDisplayLevel.ERROR) {
        annotation=holder.createErrorAnnotation(problemRange,message);
      }
 else       if (annotationResult.level == HighlightDisplayLevel.WARNING) {
        annotation=holder.createWarningAnnotation(problemRange,message);
      }
 else {
        annotation=holder.createWeakWarningAnnotation(problemRange,message);
      }
      annotation.registerUniversalFix(new ReformatFix(),null,null);
      annotation.registerFix(new IgnoreErrorFix(problem.myCode));
      annotation.registerFix(new CustomEditInspectionToolsSettingsAction(HighlightDisplayKey.find(PyPep8Inspection.INSPECTION_SHORT_NAME),new Computable<String>(){
        @Override public String compute(){
          return "Edit inspection profile setting";
        }
      }
));
    }
  }
}
