{
  if (annotationResult == null || !file.isValid())   return;
  final String text=file.getText();
  for (  Problem problem : annotationResult.problems) {
    String stripTrailingSpaces=EditorSettingsExternalizable.getInstance().getStripTrailingSpaces();
    if (!stripTrailingSpaces.equals(EditorSettingsExternalizable.STRIP_TRAILING_SPACES_NONE)) {
      if (problem.myCode.equals("W291") || problem.myCode.equals("W293")) {
        continue;
      }
    }
    int offset=StringUtil.lineColToOffset(text,problem.myLine - 1,problem.myColumn - 1);
    PsiElement problemElement=file.findElementAt(offset);
    if (!(problemElement instanceof PsiWhiteSpace) && !(problem.myCode.startsWith("E3"))) {
      final PsiElement elementAfter=file.findElementAt(offset + 1);
      if (elementAfter instanceof PsiWhiteSpace) {
        problemElement=elementAfter;
      }
    }
    if (problemElement != null) {
      final Annotation annotation;
      final String message="PEP 8: " + problem.myDescription;
      if (annotationResult.level == HighlightDisplayLevel.ERROR) {
        annotation=holder.createErrorAnnotation(problemElement,message);
      }
 else       if (annotationResult.level == HighlightDisplayLevel.WARNING) {
        annotation=holder.createWarningAnnotation(problemElement,message);
      }
 else {
        annotation=holder.createWeakWarningAnnotation(problemElement,message);
      }
      annotation.registerUniversalFix(new ReformatFix(),null,null);
      annotation.registerFix(new IgnoreErrorFix(problem.myCode,annotationResult.ignoredErrors));
      annotation.registerFix(new CustomEditInspectionToolsSettingsAction(HighlightDisplayKey.find(PyPep8Inspection.INSPECTION_SHORT_NAME),new Computable<String>(){
        @Override public String compute(){
          return "Edit inspection profile setting";
        }
      }
));
    }
  }
}
