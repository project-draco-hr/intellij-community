{
  AccessToken accessToken=WriteAction.start();
  try {
    VirtualFile srcFile=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(sourceJar);
    if (srcFile == null)     return;
    VirtualFile jarRoot=JarFileSystem.getInstance().getJarRootForLocalFile(srcFile);
    if (jarRoot == null)     return;
    VirtualFile[] roots=LibrarySourceRootDetectorUtil.scanAndSelectDetectedJavaSourceRoots(null,new VirtualFile[]{jarRoot});
    if (roots.length == 0) {
      roots=new VirtualFile[]{jarRoot};
    }
    for (    Library library : libraries) {
      Library.ModifiableModel model=library.getModifiableModel();
      List<VirtualFile> alreadyExistingFiles=Arrays.asList(model.getFiles(OrderRootType.SOURCES));
      for (      VirtualFile root : roots) {
        if (!alreadyExistingFiles.contains(root)) {
          model.addRoot(root,OrderRootType.SOURCES);
        }
      }
      model.commit();
    }
  }
  finally {
    accessToken.finish();
  }
}
