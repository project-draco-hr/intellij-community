{
  int widthWithoutCaret=getPreferredWidth();
  int width=widthWithoutCaret;
  if (!myDocument.isInBulkUpdate()) {
    for (    Caret caret : myEditor.getCaretModel().getAllCarets()) {
      if (caret.isUpToDate()) {
        int caretX=myView.visualPositionToXY(caret.getVisualPosition()).x;
        width=Math.max(caretX,width);
      }
    }
  }
  if (shouldRespectAdditionalColumns(widthWithoutCaret)) {
    width+=myEditor.getSettings().getAdditionalColumnsCount() * myView.getPlainSpaceWidth();
  }
  return new Dimension(width,myEditor.getPreferredHeight());
}
