{
  if (myType == VIRTUAL_FILES) {
    if (myFilesSet == null)     initFilesSet();
    final FileIndex index=ProjectRootManager.getInstance(myProject).getFileIndex();
    for (    final VirtualFile file : myFilesSet) {
      if (isFiltered(file,index))       continue;
      if (!processor.process(file))       return false;
    }
    return true;
  }
  final FileIndex projectFileIndex=ProjectRootManager.getInstance(myProject).getFileIndex();
  if (myScope instanceof GlobalSearchScope) {
    final ContentIterator contentIterator=createScopeIterator(processor,projectFileIndex,myScope);
    if (!projectFileIndex.iterateContent(contentIterator))     return false;
    if (mySearchInLibraries) {
      final VirtualFile[] libraryRoots=LibraryUtil.getLibraryRoots(myProject,false,false);
      for (      VirtualFile libraryRoot : libraryRoots) {
        if (!VfsUtilCore.iterateChildrenRecursively(libraryRoot,VirtualFileFilter.ALL,contentIterator))         return false;
      }
    }
    return true;
  }
  if (myScope instanceof LocalSearchScope) {
    final PsiElement[] psiElements=((LocalSearchScope)myScope).getScope();
    final Set<VirtualFile> files=new THashSet<VirtualFile>();
    for (    final PsiElement element : psiElements) {
      VirtualFile file=ApplicationManager.getApplication().runReadAction(new Computable<VirtualFile>(){
        @Override public VirtualFile compute(){
          return PsiUtilCore.getVirtualFile(element);
        }
      }
);
      if (file != null && files.add(file)) {
        if (!processor.process(file))         return false;
      }
    }
    return true;
  }
  List<Module> modules=myModule != null ? Collections.singletonList(myModule) : myModules;
  if (modules != null) {
    for (    final Module module : modules) {
      final FileIndex moduleFileIndex=ModuleRootManager.getInstance(module).getFileIndex();
      if (!moduleFileIndex.iterateContent(createScopeIterator(processor,moduleFileIndex,GlobalSearchScope.moduleScope(module)))) {
        return false;
      }
    }
    return true;
  }
  if (myElement instanceof PsiDirectory) {
    return accept((PsiDirectory)myElement,processor);
  }
  if (myElement != null) {
    VirtualFile file=ApplicationManager.getApplication().runReadAction(new Computable<VirtualFile>(){
      @Override public VirtualFile compute(){
        return PsiUtilCore.getVirtualFile(myElement);
      }
    }
);
    return file == null || processor.process(file);
  }
  return projectFileIndex.iterateContent(createScopeIterator(processor,projectFileIndex,GlobalSearchScope.projectScope(myProject)));
}
