{
  final FileIndex fileIndex=getFileIndex();
  final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  return new PsiElementVisitor(){
    @Override public void visitFile(    @NotNull PsiFile file){
      if (mySearchInLibraries || !(file instanceof PsiCompiledElement)) {
        final VirtualFile virtualFile=file.getVirtualFile();
        if (virtualFile == null)         return;
        if (!myIncludeTestSource) {
          if (fileIndex.isInTestSourceContent(virtualFile)) {
            return;
          }
        }
        if (!shouldHighlightFile(file))         return;
        myFilesSet.add(virtualFile);
        if (indicator != null) {
          indicator.setText(AnalysisScopeBundle.message("scanning.scope.progress.title"));
          Project project=file.getProject();
          String text=displayProjectRelativePath(virtualFile,project);
          indicator.setText2(text);
        }
      }
    }
  }
;
}
