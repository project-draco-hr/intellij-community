{
  final FileIndex fileIndex=getFileIndex();
  final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  if (indicator != null) {
    indicator.setText(AnalysisScopeBundle.message("scanning.scope.progress.title"));
  }
  return new PsiElementVisitor(){
    @Override public void visitFile(    @NotNull PsiFile file){
      if (mySearchInLibraries || !(file instanceof PsiCompiledElement)) {
        final VirtualFile virtualFile=file.getVirtualFile();
        if (virtualFile == null)         return;
        if (isFiltered(virtualFile,fileIndex)) {
          return;
        }
        if (!shouldHighlightFile(file))         return;
        myFilesSet.add(virtualFile);
      }
    }
  }
;
}
