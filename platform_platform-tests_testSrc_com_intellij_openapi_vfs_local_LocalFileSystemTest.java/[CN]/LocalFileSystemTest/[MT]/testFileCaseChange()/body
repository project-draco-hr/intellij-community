{
  if (SystemInfo.isFileSystemCaseSensitive) {
    System.err.println("Ignored: case-insensitive FS required");
    return;
  }
  File top=createTempDirectory(false);
  File file=IoTestUtil.createTestFile(top,"file.txt","test");
  LocalFileSystem lfs=LocalFileSystem.getInstance();
  VirtualFile topDir=lfs.refreshAndFindFileByIoFile(top);
  assertNotNull(topDir);
  VirtualFile sourceFile=lfs.refreshAndFindFileByIoFile(file);
  assertNotNull(sourceFile);
  String newName=StringUtil.capitalize(file.getName());
  FileUtil.rename(file,new File(top,newName));
  topDir.refresh(false,true);
  assertFalse(((VirtualDirectoryImpl)topDir).allChildrenLoaded());
  assertTrue(sourceFile.isValid());
  assertEquals(newName,sourceFile.getName());
  topDir.getChildren();
  newName=newName.toLowerCase();
  FileUtil.rename(file,new File(top,newName));
  topDir.refresh(false,true);
  assertTrue(((VirtualDirectoryImpl)topDir).allChildrenLoaded());
  assertTrue(sourceFile.isValid());
  assertEquals(newName,sourceFile.getName());
}
