{
  try {
    PsiElement problem_elt=descriptor.getPsiElement().getParent();
    String item_name=myIdentifier;
    sure(myPyFile);
    sure(item_name);
    sure(CodeInsightUtilBase.preparePsiElementForWrite(myPyFile));
    PyFunctionBuilder builder=new PyFunctionBuilder(item_name);
    PsiElement problem_parent=problem_elt.getParent();
    if (problem_parent instanceof PyCallExpression) {
      PyArgumentList arglist=((PyCallExpression)problem_parent).getArgumentList();
      sure(arglist);
      final PyExpression[] args=arglist.getArguments();
      for (      PyExpression arg : args) {
        if (arg instanceof PyKeywordArgument) {
          builder.parameter(((PyKeywordArgument)arg).getKeyword());
        }
 else         if (arg instanceof PyReferenceExpression) {
          PyReferenceExpression refex=(PyReferenceExpression)arg;
          builder.parameter(refex.getReferencedName());
        }
 else {
          builder.parameter("param");
        }
      }
    }
 else     if (problem_parent != null) {
      PsiFile source_file=problem_parent.getContainingFile();
      if (source_file != null && "urls.py".equals(source_file.getName()) && DjangoFacet.isPresent(source_file)) {
        builder.parameter("request");
      }
    }
    PyFunction function=builder.buildFunction(project,LanguageLevel.forFile(myPyFile.getVirtualFile()));
    function=(PyFunction)myPyFile.add(function);
    showTemplateBuilder(function);
  }
 catch (  IncorrectOperationException ignored) {
    PyUtil.showBalloon(project,PyBundle.message("QFIX.failed.to.add.function"),MessageType.ERROR);
  }
}
