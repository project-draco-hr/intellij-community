{
  if (offset > 0) {
    final PsiElement beforeCaret=file.findElementAt(offset - 1);
    if (beforeCaret instanceof PsiWhiteSpace && beforeCaret.getText().indexOf('\\') >= 0) {
      return Result.Continue;
    }
  }
  PsiElement statementBefore=findStatementBeforeCaret(file,offset);
  PsiElement statementAfter=findStatementAfterCaret(file,offset);
  if (statementBefore != statementAfter) {
    return Result.Continue;
  }
  if (statementBefore == null) {
    return Result.Continue;
  }
  if (PsiTreeUtil.hasErrorElements(statementBefore)) {
    final Boolean autoWrapping=DataManager.getInstance().loadFromDataContext(dataContext,AutoHardWrapHandler.AUTO_WRAP_LINE_IN_PROGRESS_KEY);
    if (autoWrapping == null) {
      return Result.Continue;
    }
  }
  if (inFromImportParentheses(statementBefore,offset)) {
    return Result.Continue;
  }
  PsiElement wrappableBefore=findWrappable(file,offset,true);
  PsiElement wrappableAfter=findWrappable(file,offset,false);
  if (!(wrappableBefore instanceof PsiComment)) {
    while (wrappableBefore != null) {
      PsiElement next=PsiTreeUtil.getParentOfType(wrappableBefore,WRAPPABLE_CLASSES);
      if (next == null) {
        break;
      }
      wrappableBefore=next;
    }
  }
  if (!(wrappableAfter instanceof PsiComment)) {
    while (wrappableAfter != null) {
      PsiElement next=PsiTreeUtil.getParentOfType(wrappableAfter,WRAPPABLE_CLASSES);
      if (next == null) {
        break;
      }
      wrappableAfter=next;
    }
  }
  if (wrappableBefore instanceof PsiComment || wrappableAfter instanceof PsiComment) {
    return Result.Continue;
  }
  if (wrappableAfter == null || wrappableBefore != wrappableAfter) {
    doc.insertString(offset,"\\");
    caretOffset.set(caretOffset.get() + 1);
  }
  return Result.Continue;
}
