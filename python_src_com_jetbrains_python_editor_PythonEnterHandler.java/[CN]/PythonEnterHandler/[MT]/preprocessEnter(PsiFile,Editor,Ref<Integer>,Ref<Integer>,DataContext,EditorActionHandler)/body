{
  if (!(file instanceof PyFile)) {
    return Result.Continue;
  }
  Document doc=editor.getDocument();
  PsiDocumentManager.getInstance(file.getProject()).commitDocument(doc);
  final int offset=caretOffset.get();
  final PsiElement element=file.findElementAt(offset);
  if (element == null) {
    return Result.Continue;
  }
  if (offset > 0) {
    final PsiElement beforeCaret=file.findElementAt(offset - 1);
    if (beforeCaret instanceof PsiWhiteSpace && beforeCaret.getText().indexOf('\\') > 0) {
      return Result.Continue;
    }
  }
  PsiElement statementBefore=findStatementBeforeCaret(file,offset);
  PsiElement statementAfter=findStatementAfterCaret(file,offset);
  if (statementBefore != statementAfter) {
    return Result.Continue;
  }
  if (statementBefore == null) {
    return Result.Continue;
  }
  if (PsiTreeUtil.hasErrorElements(statementBefore)) {
    final Boolean autoWrapping=DataManager.getInstance().loadFromDataContext(dataContext,AutoHardWrapHandler.AUTO_WRAP_LINE_IN_PROGRESS_KEY);
    if (autoWrapping == null) {
      return Result.Continue;
    }
  }
  PsiElement wrappableBefore=findBeforeCaret(file,offset,IMPLICIT_WRAP_CLASSES);
  PsiElement wrappableAfter=findAfterCaret(file,offset,IMPLICIT_WRAP_CLASSES);
  if (!(wrappableBefore instanceof PsiComment)) {
    while (wrappableBefore != null) {
      PsiElement next=PsiTreeUtil.getParentOfType(wrappableBefore,IMPLICIT_WRAP_CLASSES);
      if (next == null) {
        break;
      }
      wrappableBefore=next;
    }
  }
  if (!(wrappableAfter instanceof PsiComment)) {
    while (wrappableAfter != null) {
      PsiElement next=PsiTreeUtil.getParentOfType(wrappableAfter,IMPLICIT_WRAP_CLASSES);
      if (next == null) {
        break;
      }
      wrappableAfter=next;
    }
  }
  if (wrappableBefore instanceof PsiComment || wrappableAfter instanceof PsiComment) {
    return Result.Continue;
  }
  if (wrappableAfter == null || wrappableBefore != wrappableAfter) {
    doc.insertString(offset,"\\");
    caretOffset.set(offset + 1);
  }
  return Result.Continue;
}
