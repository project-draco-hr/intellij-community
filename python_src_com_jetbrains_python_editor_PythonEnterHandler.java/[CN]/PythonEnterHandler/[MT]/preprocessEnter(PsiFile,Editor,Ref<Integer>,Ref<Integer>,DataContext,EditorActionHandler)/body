{
  if (!(file instanceof PyFile)) {
    return Result.Continue;
  }
  final Boolean isSplitLine=DataManager.getInstance().loadFromDataContext(dataContext,SplitLineAction.SPLIT_LINE_KEY);
  if (isSplitLine != null) {
    return Result.Continue;
  }
  Document doc=editor.getDocument();
  PsiDocumentManager.getInstance(file.getProject()).commitDocument(doc);
  final int offset=caretOffset.get();
  final PsiElement element=file.findElementAt(offset);
  CodeInsightSettings codeInsightSettings=CodeInsightSettings.getInstance();
  if (codeInsightSettings.JAVADOC_STUB_ON_ENTER) {
    PsiElement comment=element;
    if (comment == null && offset != 0)     comment=file.findElementAt(offset - 1);
    int expectedStringStart=editor.getCaretModel().getOffset() - 3;
    if (PythonDocCommentUtil.atDocCommentStart(comment,expectedStringStart)) {
      insertDocStringStub(editor,comment);
      return Result.Continue;
    }
  }
  if (element == null) {
    return Result.Continue;
  }
  if (!PyCodeInsightSettings.getInstance().INSERT_BACKSLASH_ON_WRAP) {
    return Result.Continue;
  }
  if (offset > 0) {
    final PsiElement beforeCaret=file.findElementAt(offset - 1);
    if (beforeCaret instanceof PsiWhiteSpace && beforeCaret.getText().indexOf('\\') > 0) {
      return Result.Continue;
    }
  }
  PsiElement statementBefore=findStatementBeforeCaret(file,offset);
  PsiElement statementAfter=findStatementAfterCaret(file,offset);
  if (statementBefore != statementAfter) {
    return Result.Continue;
  }
  if (statementBefore == null) {
    return Result.Continue;
  }
  if (PsiTreeUtil.hasErrorElements(statementBefore)) {
    final Boolean autoWrapping=DataManager.getInstance().loadFromDataContext(dataContext,AutoHardWrapHandler.AUTO_WRAP_LINE_IN_PROGRESS_KEY);
    if (autoWrapping == null) {
      return Result.Continue;
    }
  }
  if (inFromImportParentheses(statementBefore,offset)) {
    return Result.Continue;
  }
  PsiElement wrappableBefore=findWrappable(file,offset,true);
  PsiElement wrappableAfter=findWrappable(file,offset,false);
  if (!(wrappableBefore instanceof PsiComment)) {
    while (wrappableBefore != null) {
      PsiElement next=PsiTreeUtil.getParentOfType(wrappableBefore,IMPLICIT_WRAP_CLASSES);
      if (next == null) {
        break;
      }
      wrappableBefore=next;
    }
  }
  if (!(wrappableAfter instanceof PsiComment)) {
    while (wrappableAfter != null) {
      PsiElement next=PsiTreeUtil.getParentOfType(wrappableAfter,IMPLICIT_WRAP_CLASSES);
      if (next == null) {
        break;
      }
      wrappableAfter=next;
    }
  }
  if (wrappableBefore instanceof PsiComment || wrappableAfter instanceof PsiComment) {
    return Result.Continue;
  }
  if (wrappableAfter == null || wrappableBefore != wrappableAfter) {
    doc.insertString(offset,"\\");
    caretOffset.set(offset + 1);
  }
  return Result.Continue;
}
