{
  if (myProject != null) {
    VfsUtil.markDirtyAndRefresh(false,false,false,virtualFile);
    myMessageOutput.info("Formatting " + virtualFile.getCanonicalPath() + "...");
    Document document=FileDocumentManager.getInstance().getDocument(virtualFile);
    if (document != null) {
      PsiFile psiFile=PsiDocumentManager.getInstance(myProject).getPsiFile(document);
      NonProjectFileWritingAccessProvider.allowWriting(virtualFile);
      if (psiFile != null) {
        reformatFile(myProject,psiFile,document);
      }
      FileDocumentManager.getInstance().saveDocument(document);
    }
    FileEditorManager editorManager=FileEditorManager.getInstance(myProject);
    VirtualFile[] openFiles=editorManager.getOpenFiles();
    for (    VirtualFile openFile : openFiles) {
      editorManager.closeFile(openFile);
    }
    myMessageOutput.info("OK\n");
  }
}
