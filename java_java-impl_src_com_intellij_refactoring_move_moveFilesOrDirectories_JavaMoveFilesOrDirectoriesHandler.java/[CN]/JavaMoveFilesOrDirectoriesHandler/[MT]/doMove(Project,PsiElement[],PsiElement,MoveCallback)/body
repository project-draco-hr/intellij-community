{
  elements=super.adjustForMove(project,elements,targetContainer);
  if (elements == null) {
    return;
  }
  MoveFilesOrDirectoriesUtil.doMove(project,elements,new PsiElement[]{targetContainer},callback,new Function<PsiElement[],PsiElement[]>(){
    @Override public PsiElement[] fun(    final PsiElement[] elements){
      return new WriteCommandAction<PsiElement[]>(project,"Regrouping ..."){
        @Override protected void run(        @NotNull Result<PsiElement[]> result) throws Throwable {
          final List<PsiElement> adjustedElements=new ArrayList<PsiElement>();
          for (int i=0, length=elements.length; i < length; i++) {
            PsiElement element=elements[i];
            if (element instanceof PsiClass) {
              final PsiClass topLevelClass=PsiUtil.getTopLevelClass(element);
              if (topLevelClass != null) {
                elements[i]=topLevelClass;
                final PsiFile containingFile=obtainContainingFile(topLevelClass,elements);
                if (containingFile != null && !adjustedElements.contains(containingFile)) {
                  adjustedElements.add(containingFile);
                  continue;
                }
              }
            }
            adjustedElements.add(element);
          }
          result.setResult(PsiUtilCore.toPsiElementArray(adjustedElements));
        }
      }
.execute().getResultObject();
    }
  }
);
}
