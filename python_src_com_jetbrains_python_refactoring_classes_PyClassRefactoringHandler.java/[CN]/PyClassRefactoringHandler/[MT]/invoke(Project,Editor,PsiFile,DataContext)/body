{
  PsiElement element1=null;
  PsiElement element2=null;
  final SelectionModel selectionModel=editor.getSelectionModel();
  if (selectionModel.hasSelection()) {
    element1=file.findElementAt(selectionModel.getSelectionStart());
    element2=file.findElementAt(selectionModel.getSelectionEnd() - 1);
  }
 else {
    final CaretModel caretModel=editor.getCaretModel();
    final Document document=editor.getDocument();
    int lineNumber=document.getLineNumber(caretModel.getOffset());
    if ((lineNumber >= 0) && (lineNumber < document.getLineCount())) {
      element1=file.findElementAt(document.getLineStartOffset(lineNumber));
      element2=file.findElementAt(document.getLineEndOffset(lineNumber) - 1);
    }
  }
  if (element1 == null || element2 == null) {
    CommonRefactoringUtil.showErrorHint(project,editor,PyBundle.message("refactoring.introduce.selection.error"),getTitle(),"members.pull.up");
    return;
  }
  doRefactor(project,element1,element2,editor,file,dataContext);
}
