{
  VirtualFile dir=getVirtualFile(createTempDirectory());
  PsiTestUtil.addSourceContentToRoots(myModule,dir);
  final VirtualFile vFile=createChildData(dir,"Foo.java");
  VfsUtil.saveText(vFile,"class Foo {}");
  final GlobalSearchScope scope=GlobalSearchScope.allScope(getProject());
  final JavaPsiFacade facade=JavaPsiFacade.getInstance(getProject());
  assertNotNull(facade.findClass("Foo",scope));
  WriteCommandAction.runWriteCommandAction(null,new Runnable(){
    @Override public void run(){
      PsiFile psiFile=PsiManager.getInstance(getProject()).findFile(vFile);
      assertNotNull(psiFile);
      Document document=FileDocumentManager.getInstance().getDocument(vFile);
      document.deleteString(0,document.getTextLength());
      assertNotNull(facade.findClass("Foo",scope));
      psiFile=null;
      PlatformTestUtil.tryGcSoftlyReachableObjects();
      assertNull(((PsiManagerEx)PsiManager.getInstance(getProject())).getFileManager().getCachedPsiFile(vFile));
      PsiClass foo=facade.findClass("Foo",scope);
      assertNotNull(foo);
      assertTrue(foo.isValid());
      assertEquals("class Foo {}",foo.getText());
      assertTrue(foo.isValid());
      PsiDocumentManager.getInstance(myProject).commitAllDocuments();
      assertNull(facade.findClass("Foo",scope));
    }
  }
);
}
