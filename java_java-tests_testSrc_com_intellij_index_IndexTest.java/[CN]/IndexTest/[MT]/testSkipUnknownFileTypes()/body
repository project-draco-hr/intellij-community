{
  VirtualFile dir=getVirtualFile(createTempDirectory());
  PsiTestUtil.addSourceContentToRoots(myModule,dir);
  final VirtualFile vFile=createChildData(dir,"Foo.test");
  VfsUtil.saveText(vFile,"Foo");
  assertEquals(PlainTextFileType.INSTANCE,vFile.getFileType());
  assertOneElement(PsiSearchHelper.SERVICE.getInstance(myProject).findFilesWithPlainTextWords("Foo"));
  final Document document=FileDocumentManager.getInstance().getDocument(vFile);
  final PsiFile file=getPsiFile(document);
  assertInstanceOf(file,PsiPlainTextFile.class);
  assertEquals("Foo",file.getText());
  assertOneElement(PsiSearchHelper.SERVICE.getInstance(myProject).findFilesWithPlainTextWords("Foo"));
  WriteCommandAction.runWriteCommandAction(myProject,new Runnable(){
    @Override public void run(){
      document.insertString(0," ");
      assertEquals("Foo",file.getText());
      assertOneElement(PsiSearchHelper.SERVICE.getInstance(myProject).findFilesWithPlainTextWords("Foo"));
      FileDocumentManager.getInstance().saveDocument(document);
      assertEquals("Foo",file.getText());
      assertOneElement(PsiSearchHelper.SERVICE.getInstance(myProject).findFilesWithPlainTextWords("Foo"));
      PsiDocumentManager.getInstance(myProject).commitAllDocuments();
      assertEquals(" Foo",file.getText());
      assertOneElement(PsiSearchHelper.SERVICE.getInstance(myProject).findFilesWithPlainTextWords("Foo"));
    }
  }
);
}
