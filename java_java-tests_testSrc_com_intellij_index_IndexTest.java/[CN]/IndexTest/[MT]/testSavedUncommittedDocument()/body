{
  VirtualFile dir=getVirtualFile(createTempDirectory());
  PsiTestUtil.addSourceContentToRoots(myModule,dir);
  final VirtualFile vFile=createChildData(dir,"Foo.java");
  VfsUtil.saveText(vFile,"");
  final GlobalSearchScope scope=GlobalSearchScope.allScope(getProject());
  final JavaPsiFacade facade=JavaPsiFacade.getInstance(getProject());
  assertNull(facade.findClass("Foo",scope));
  WriteCommandAction.runWriteCommandAction(null,new Runnable(){
    @Override public void run(){
      PsiFile psiFile=PsiManager.getInstance(getProject()).findFile(vFile);
      assertNotNull(psiFile);
      long count=PsiManager.getInstance(myProject).getModificationTracker().getModificationCount();
      Document document=FileDocumentManager.getInstance().getDocument(vFile);
      document.insertString(0,"class Foo {}");
      FileDocumentManager.getInstance().saveDocument(document);
      assertTrue(count == PsiManager.getInstance(myProject).getModificationTracker().getModificationCount());
      assertNull(facade.findClass("Foo",scope));
      PsiDocumentManager.getInstance(myProject).commitAllDocuments();
      assertNotNull(facade.findClass("Foo",scope));
      assertNotNull(facade.findClass("Foo",scope).getText());
      assertTrue(count != PsiManager.getInstance(myProject).getModificationTracker().getModificationCount());
    }
  }
);
}
