{
  VirtualFile dir=getVirtualFile(createTempDirectory());
  PsiTestUtil.addSourceContentToRoots(myModule,dir);
  final VirtualFile vFile=createChildData(dir,"Foo.java");
  VfsUtil.saveText(vFile,"class Foo {}");
  final GlobalSearchScope scope=GlobalSearchScope.allScope(getProject());
  assertNotNull(myJavaFacade.findClass("Foo",scope));
  WriteCommandAction.runWriteCommandAction(null,new Runnable(){
    @Override public void run(){
      PsiFile psiFile=PsiManager.getInstance(getProject()).findFile(vFile);
      assertNotNull(psiFile);
      Document document=FileDocumentManager.getInstance().getDocument(vFile);
      document.deleteString(0,document.getTextLength());
      PsiDocumentManager.getInstance(myProject).commitAllDocuments();
      document.insertString(0," ");
      psiFile=null;
      PlatformTestUtil.tryGcSoftlyReachableObjects();
      assertNull(((PsiManagerEx)PsiManager.getInstance(getProject())).getFileManager().getCachedPsiFile(vFile));
      PsiClass foo=myJavaFacade.findClass("Foo",scope);
      assertNull(foo);
    }
  }
);
}
