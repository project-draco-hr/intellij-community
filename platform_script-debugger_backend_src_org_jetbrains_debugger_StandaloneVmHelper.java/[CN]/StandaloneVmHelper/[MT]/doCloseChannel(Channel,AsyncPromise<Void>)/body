{
  final EventLoop eventLoop=channel.eventLoop();
  channel.close().addListener(new ChannelFutureListener(){
    @Override public void operationComplete(    ChannelFuture future) throws Exception {
      try {
        if (eventLoop instanceof OioEventLoopGroup) {
          eventLoop.shutdownGracefully(1,2,TimeUnit.NANOSECONDS);
        }
      }
  finally {
        Throwable error=future.cause();
        if (error == null) {
          promise.setResult(null);
        }
 else {
          promise.setError(error);
        }
      }
    }
  }
);
}
