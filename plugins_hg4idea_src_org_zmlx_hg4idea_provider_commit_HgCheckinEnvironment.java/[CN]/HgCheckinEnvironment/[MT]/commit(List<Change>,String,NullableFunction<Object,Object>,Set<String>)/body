{
  List<VcsException> exceptions=new LinkedList<VcsException>();
  Map<HgRepository,Set<HgFile>> repositoriesMap=getFilesByRepository(changes);
  addRepositoriesWithoutChanges(repositoriesMap);
  for (  Map.Entry<HgRepository,Set<HgFile>> entry : repositoriesMap.entrySet()) {
    HgRepository repo=entry.getKey();
    Set<HgFile> selectedFiles=entry.getValue();
    HgCommitTypeCommand command=myMqNewPatch ? new HgQNewCommand(myProject,repo,preparedComment,myNextCommitAmend) : new HgCommitCommand(myProject,repo,preparedComment,myNextCommitAmend,myCloseBranch,myShouldCommitSubrepos && !selectedFiles.isEmpty());
    if (isMergeCommit(repo.getRoot())) {
      Set<HgFile> changedFilesNotInCommit=getChangedFilesNotInCommit(repo.getRoot(),selectedFiles);
      boolean partial=!changedFilesNotInCommit.isEmpty();
      if (partial) {
        final StringBuilder filesNotIncludedString=new StringBuilder();
        for (        HgFile hgFile : changedFilesNotInCommit) {
          filesNotIncludedString.append("<li>");
          filesNotIncludedString.append(hgFile.getRelativePath());
          filesNotIncludedString.append("</li>");
        }
        if (!mayCommitEverything(filesNotIncludedString.toString())) {
          return exceptions;
        }
        VcsDirtyScopeManager dirtyManager=VcsDirtyScopeManager.getInstance(myProject);
        for (        HgFile hgFile : changedFilesNotInCommit) {
          dirtyManager.fileDirty(hgFile.toFilePath());
        }
      }
    }
 else {
      command.setFiles(selectedFiles);
    }
    try {
      command.execute();
    }
 catch (    HgCommandException e) {
      exceptions.add(new VcsException(e));
    }
catch (    VcsException e) {
      exceptions.add(e);
    }
  }
  if (myNextCommitIsPushed && exceptions.isEmpty()) {
    final List<HgRepository> preselectedRepositories=ContainerUtil.newArrayList(repositoriesMap.keySet());
    UIUtil.invokeLaterIfNeeded(new Runnable(){
      public void run(){
        new VcsPushDialog(myProject,preselectedRepositories,HgUtil.getCurrentRepository(myProject)).show();
      }
    }
);
  }
  return exceptions;
}
