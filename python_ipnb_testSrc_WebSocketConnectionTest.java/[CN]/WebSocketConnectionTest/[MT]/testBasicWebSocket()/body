{
  final Ref<Boolean> evaluated=Ref.create(false);
  final IpnbConnection connection=new IpnbConnection(getTestServerURI(),new IpnbConnectionListenerBase(){
    private String myMessageId;
    @Override public void onOpen(    @NotNull IpnbConnection connection){
      myMessageId=connection.execute("2 + 2");
    }
    @Override public void onOutput(    @NotNull IpnbConnection connection,    @NotNull String parentMessageId){
      if (myMessageId.equals(parentMessageId)) {
        final ArrayList<IpnbOutputCell> outputs=connection.getOutput();
        assertEquals(1,outputs.size());
        assertEquals(outputs.get(0).getClass(),IpnbOutOutputCell.class);
        final List<String> text=outputs.get(0).getText();
        assertNotNull(text);
        assertEquals("4",text.get(0));
        evaluated.set(true);
        connection.shutdown();
      }
    }
  }
);
  connection.close();
  assertTrue(evaluated.get());
}
