{
  super(project,directoryIndex);
  myConnection=project.getMessageBus().connect(project);
  myConnection.subscribe(FileTypeManager.TOPIC,new FileTypeListener(){
    @Override public void beforeFileTypesChanged(    FileTypeEvent event){
      beforeRootsChange(true);
    }
    @Override public void fileTypesChanged(    FileTypeEvent event){
      rootsChanged(true);
    }
  }
);
  myConnection.subscribe(VirtualFileManager.VFS_CHANGES,new BulkFileListener.Adapter(){
    @Override public void before(    @NotNull List<? extends VFileEvent> events){
      myLargeVfsUpdateDetected|=DirectoryIndexImpl.isLargeVfsChange(events);
    }
  }
);
  VirtualFileManager.getInstance().addVirtualFileManagerListener(new VirtualFileManagerAdapter(){
    @Override public void beforeRefreshStart(    boolean asynchronous){
      myLargeVfsUpdateDetected=false;
    }
    @Override public void afterRefreshFinish(    boolean asynchronous){
      doUpdateOnRefresh(myLargeVfsUpdateDetected);
    }
  }
,project);
  startupManager.registerStartupActivity(new Runnable(){
    @Override public void run(){
      myStartupActivityPerformed=true;
    }
  }
);
  myHandler=new BatchUpdateListener(){
    @Override public void onBatchUpdateStarted(){
      myRootsChanged.levelUp();
      myFileTypesChanged.levelUp();
    }
    @Override public void onBatchUpdateFinished(){
      myRootsChanged.levelDown();
      myFileTypesChanged.levelDown();
    }
  }
;
  myConnection.subscribe(VirtualFilePointerListener.TOPIC,new MyVirtualFilePointerListener());
}
