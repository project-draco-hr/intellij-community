{
  if (myProject.isDisposed())   return;
  if (!synchronously && ApplicationManager.getApplication().isWriteAccessAllowed())   return;
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(myProject);
  final PsiFile hostPsiFile=documentManager.getCachedPsiFile(hostDocument);
  if (hostPsiFile == null)   return;
  final ConcurrentList<DocumentWindow> injected=InjectedLanguageUtil.getCachedInjectedDocuments(hostPsiFile);
  if (injected.isEmpty())   return;
  if (myProgress.isCanceled()) {
    myProgress=new DaemonProgressIndicator();
  }
  final Set<DocumentWindow> newDocuments=Collections.synchronizedSet(new THashSet());
  final Processor<DocumentWindow> commitProcessor=new Processor<DocumentWindow>(){
    @Override public boolean process(    DocumentWindow documentWindow){
      if (myProject.isDisposed())       return false;
      ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
      if (indicator != null && indicator.isCanceled())       return false;
      if (documentManager.isUncommited(hostDocument) || !hostPsiFile.isValid())       return false;
      InjectedLanguageUtil.enumerate(documentWindow,hostPsiFile,new PsiLanguageInjectionHost.InjectedPsiVisitor(){
        @Override public void visit(        @NotNull PsiFile injectedPsi,        @NotNull List<PsiLanguageInjectionHost.Shred> places){
          DocumentWindow newDocument=(DocumentWindow)injectedPsi.getViewProvider().getDocument();
          if (newDocument != null) {
            PsiDocumentManagerBase.checkConsistency(injectedPsi,newDocument);
            newDocuments.add(newDocument);
          }
        }
      }
);
      return true;
    }
  }
;
  final Runnable commitInjectionsRunnable=new Runnable(){
    @Override public void run(){
      if (myProgress.isCanceled())       return;
      JobLauncher.getInstance().invokeConcurrentlyUnderProgress(new ArrayList<DocumentWindow>(injected),myProgress,true,commitProcessor);
synchronized (PsiLock.LOCK) {
        injected.clear();
        injected.addAll(newDocuments);
      }
    }
  }
;
  if (synchronously) {
    if (Thread.holdsLock(PsiLock.LOCK)) {
      ContainerUtil.process(new ArrayList<DocumentWindow>(injected),commitProcessor);
    }
 else {
      commitInjectionsRunnable.run();
    }
  }
 else {
    JobLauncher.getInstance().submitToJobThread(Job.DEFAULT_PRIORITY,new Runnable(){
      @Override public void run(){
        ApplicationManagerEx.getApplicationEx().tryRunReadAction(commitInjectionsRunnable);
      }
    }
);
  }
}
