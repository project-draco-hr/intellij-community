{
  MultiMap<PsiElement,String> conflictDescriptions=new MultiMap<PsiElement,String>();
  collectConflictsFromExtensions(refUsages,conflictDescriptions,myChangeInfo);
  final UsageInfo[] usagesIn=refUsages.get();
  RenameUtil.addConflictDescriptions(usagesIn,conflictDescriptions);
  Set<UsageInfo> usagesSet=new HashSet<UsageInfo>(Arrays.asList(usagesIn));
  RenameUtil.removeConflictUsages(usagesSet);
  if (!conflictDescriptions.isEmpty()) {
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      throw new ConflictsInTestsException(conflictDescriptions.values());
    }
    ConflictsDialog dialog=prepareConflictsDialog(conflictDescriptions,usagesIn);
    if (!dialog.showAndGet()) {
      if (dialog.isShowConflicts())       prepareSuccessful();
      return false;
    }
  }
  refUsages.set(usagesSet.toArray(new UsageInfo[usagesSet.size()]));
  prepareSuccessful();
  return true;
}
