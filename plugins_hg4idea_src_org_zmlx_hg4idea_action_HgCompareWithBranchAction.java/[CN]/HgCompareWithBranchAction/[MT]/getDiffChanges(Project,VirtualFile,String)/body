{
  HgRepository repository=getRepositoryManager(project).getRepositoryForFile(file);
  if (repository == null) {
    throw new VcsException("Couldn't find repository for " + file.getName());
  }
  final FilePath filePath=VcsUtil.getFilePath(file);
  final VirtualFile repositoryRoot=repository.getRoot();
  final HgFile hgFile=new HgFile(repositoryRoot,filePath);
  Hash refHashToCompare=detectActiveHashByName(repository,branchToCompare);
  if (refHashToCompare == null) {
    throw new VcsException(String.format("Couldn't detect commit related to %s name for %s.",branchToCompare,file));
  }
  final HgRevisionNumber compareWithRevisionNumber=HgRevisionNumber.getInstance(branchToCompare,refHashToCompare.toString());
  List<Change> changes=HgUtil.getDiff(project,repositoryRoot,filePath,compareWithRevisionNumber,null);
  if (changes.isEmpty() && !existInBranch(repository,filePath,compareWithRevisionNumber)) {
    throw new VcsException(fileDoesntExistInBranchError(file,branchToCompare));
  }
  return changes.isEmpty() && !filePath.isDirectory() ? createChangesWithCurrentContentForFile(filePath,HgContentRevision.create(project,hgFile,compareWithRevisionNumber)) : changes;
}
