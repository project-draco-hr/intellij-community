{
  Stub data=inputData.getUserData(stubElementKey);
  if (data != null)   return data;
synchronized (inputData) {
    data=inputData.getUserData(stubElementKey);
    if (data != null)     return data;
    final FileType fileType=inputData.getFileType();
    final BinaryFileStubBuilder builder=BinaryFileStubBuilders.INSTANCE.forFileType(fileType);
    if (builder != null) {
      data=builder.buildStubTree(inputData);
    }
 else {
      final LanguageFileType languageFileType=(LanguageFileType)fileType;
      Language l=languageFileType.getLanguage();
      final IFileElementType type=LanguageParserDefinitions.INSTANCE.forLanguage(l).getFileNodeType();
      CharSequence contentAsText=inputData.getContentAsText();
      FileContentImpl fileContent=(FileContentImpl)inputData;
      PsiFile psi=fileContent.getPsiFileAccountingForUnsavedDocument();
      psi=psi.getViewProvider().getStubBindingRoot();
      psi.putUserData(IndexingDataKeys.FILE_TEXT_CONTENT_KEY,contentAsText);
      psi.getManager().startBatchFilesProcessingMode();
      try {
        IStubFileElementType stubFileElementType;
        if (type instanceof IStubFileElementType) {
          stubFileElementType=(IStubFileElementType)type;
        }
 else         if (languageFileType instanceof SubstitutedFileType) {
          SubstitutedFileType substituted=(SubstitutedFileType)languageFileType;
          LanguageFileType original=(LanguageFileType)substituted.getOriginalFileType();
          final IFileElementType originalType=LanguageParserDefinitions.INSTANCE.forLanguage(original.getLanguage()).getFileNodeType();
          stubFileElementType=originalType instanceof IStubFileElementType ? (IStubFileElementType)originalType : null;
        }
 else {
          stubFileElementType=null;
        }
        if (stubFileElementType != null) {
          StubBuilder stubBuilder=stubFileElementType.getBuilder();
          if (stubBuilder instanceof LightStubBuilder) {
            LightStubBuilder.FORCED_AST.set(fileContent.getLighterAST());
          }
          data=stubBuilder.buildStubTree(psi);
        }
      }
  finally {
        psi.putUserData(IndexingDataKeys.FILE_TEXT_CONTENT_KEY,null);
        psi.getManager().finishBatchFilesProcessingMode();
      }
    }
    inputData.putUserData(stubElementKey,data);
    return data;
  }
}
