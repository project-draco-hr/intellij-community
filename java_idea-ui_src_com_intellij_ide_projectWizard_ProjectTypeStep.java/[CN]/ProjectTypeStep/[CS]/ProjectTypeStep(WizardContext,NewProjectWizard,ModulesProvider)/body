{
  myContext=context;
  myWizard=wizard;
  myTemplatesMap=new ConcurrentMultiMap<TemplatesGroup,ProjectTemplate>();
  List<TemplatesGroup> groups=fillTemplatesMap(context);
  myProjectTypeList.setModel(new CollectionListModel<TemplatesGroup>(groups));
  myProjectTypeList.setSelectionModel(new SingleSelectionModel());
  myProjectTypeList.addListSelectionListener(new ListSelectionListener(){
    @Override public void valueChanged(    ListSelectionEvent e){
      updateSelection();
    }
  }
);
  myProjectTypeList.setCellRenderer(new ColoredListCellRenderer<TemplatesGroup>(){
    @Override protected void customizeCellRenderer(    JList list,    TemplatesGroup value,    int index,    boolean selected,    boolean hasFocus){
      Font font=list.getFont();
      if (value.getParentGroup() != null) {
        setFont(font);
        append("         ");
      }
 else {
        setBorder(IdeBorderFactory.createEmptyBorder(2,10,2,5));
        setIcon(value.getIcon());
        setFont(font.deriveFont(Font.BOLD));
      }
      append(value.getName());
    }
  }
);
  new ListSpeedSearch(myProjectTypeList){
    @Override protected String getElementText(    Object element){
      return ((TemplatesGroup)element).getName();
    }
  }
;
  myModulesProvider=modulesProvider;
  Project project=context.getProject();
  final LibrariesContainer container=LibrariesContainerFactory.createContainer(project);
  FrameworkSupportModelBase model=new FrameworkSupportModelBase(project,null,container){
    @NotNull @Override public String getBaseDirectoryForLibrariesPath(){
      ModuleBuilder builder=getSelectedBuilder();
      return StringUtil.notNullize(builder.getContentEntryPath());
    }
  }
;
  myFrameworksPanel=new AddSupportForFrameworksPanel(Collections.<FrameworkSupportInModuleProvider>emptyList(),model,true);
  Disposer.register(wizard.getDisposable(),myFrameworksPanel);
  myFrameworksPanelPlaceholder.add(myFrameworksPanel.getMainPanel());
  myConfigurationUpdater=new ModuleBuilder.ModuleConfigurationUpdater(){
    @Override public void update(    @NotNull Module module,    @NotNull ModifiableRootModel rootModel){
      if (isFrameworksMode()) {
        myFrameworksPanel.addSupport(module,rootModel);
      }
    }
  }
;
  myProjectTypeList.getSelectionModel().addListSelectionListener(new ListSelectionListener(){
    @Override public void valueChanged(    ListSelectionEvent e){
      projectTypeChanged();
    }
  }
);
  myTemplatesList.addListSelectionListener(new ListSelectionListener(){
    @Override public void valueChanged(    ListSelectionEvent e){
      updateSelection();
    }
  }
);
  for (  TemplatesGroup templatesGroup : myTemplatesMap.keySet()) {
    ModuleBuilder builder=templatesGroup.getModuleBuilder();
    if (builder != null) {
      myWizard.getSequence().addStepsForBuilder(builder,context,modulesProvider);
    }
    for (    ProjectTemplate template : myTemplatesMap.get(templatesGroup)) {
      myWizard.getSequence().addStepsForBuilder(myBuilders.get(template),context,modulesProvider);
    }
  }
  final String groupId=PropertiesComponent.getInstance().getValue(PROJECT_WIZARD_GROUP);
  if (groupId != null) {
    TemplatesGroup group=ContainerUtil.find(groups,new Condition<TemplatesGroup>(){
      @Override public boolean value(      TemplatesGroup group){
        return groupId.equals(group.getId());
      }
    }
);
    if (group != null) {
      myProjectTypeList.setSelectedValue(group,true);
    }
  }
  if (myProjectTypeList.getSelectedValue() == null) {
    myProjectTypeList.setSelectedIndex(0);
  }
  myTemplatesList.restoreSelection();
}
