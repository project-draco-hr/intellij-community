{
  if (!PsiUtil.isLanguageLevel8OrHigher(parameters.getOriginalFile()))   return;
  final ExpectedTypeInfo[] expectedTypes=JavaSmartCompletionContributor.getExpectedTypes(parameters);
  for (  ExpectedTypeInfo expectedType : expectedTypes) {
    final PsiType defaultType=expectedType.getDefaultType();
    if (LambdaUtil.isFunctionalType(defaultType)) {
      final PsiType functionalType=FunctionalInterfaceParameterizationUtil.getGroundTargetType(defaultType);
      final PsiType returnType=LambdaUtil.getFunctionalInterfaceReturnType(functionalType);
      if (returnType != null) {
        final PsiElement position=parameters.getPosition();
        final PsiElement refPlace=position.getParent();
        final ExpectedTypeInfoImpl typeInfo=new ExpectedTypeInfoImpl(returnType,ExpectedTypeInfo.TYPE_OR_SUBTYPE,returnType,TailType.UNKNOWN,null,ExpectedTypeInfoImpl.NULL);
        final Map<PsiElement,PsiType> map=LambdaUtil.getFunctionalTypeMap();
        Consumer<LookupElement> noTypeCheck=new Consumer<LookupElement>(){
          @Override public void consume(          final LookupElement lookupElement){
            final PsiElement element=lookupElement.getPsiElement();
            if (element instanceof PsiMethod) {
              final PsiMethodReferenceExpression referenceExpression=createMethodReferenceExpression((PsiMethod)element);
              if (referenceExpression == null) {
                return;
              }
              final PsiType added=map.put(referenceExpression,functionalType);
              try {
                final PsiElement resolve=referenceExpression.resolve();
                if (resolve != null && PsiEquivalenceUtil.areElementsEquivalent(element,resolve) && PsiMethodReferenceUtil.checkMethodReferenceContext(referenceExpression,resolve,functionalType) == null) {
                  result.addElement(new JavaMethodReferenceElement((PsiMethod)element,refPlace));
                }
              }
  finally {
                if (added == null) {
                  map.remove(referenceExpression);
                }
              }
            }
          }
          private PsiMethodReferenceExpression createMethodReferenceExpression(          PsiMethod method){
            PsiElementFactory elementFactory=JavaPsiFacade.getElementFactory(method.getProject());
            if (refPlace instanceof PsiMethodReferenceExpression) {
              final PsiMethodReferenceExpression referenceExpression=(PsiMethodReferenceExpression)refPlace.copy();
              final PsiElement referenceNameElement=referenceExpression.getReferenceNameElement();
              LOG.assertTrue(referenceNameElement != null,referenceExpression);
              referenceNameElement.replace(method.isConstructor() ? elementFactory.createKeyword("new") : elementFactory.createIdentifier(method.getName()));
              return referenceExpression;
            }
 else             if (method.hasModifierProperty(PsiModifier.STATIC)) {
              final PsiClass aClass=method.getContainingClass();
              LOG.assertTrue(aClass != null);
              final String qualifiedName=aClass.getQualifiedName();
              return (PsiMethodReferenceExpression)elementFactory.createExpressionFromText(qualifiedName + "::" + (method.isConstructor() ? "new" : method.getName()),refPlace);
            }
 else {
              return null;
            }
          }
        }
;
        final Runnable runnable=ReferenceExpressionCompletionContributor.fillCompletionVariants(new JavaSmartCompletionParameters(parameters,typeInfo),noTypeCheck);
        if (runnable != null) {
          runnable.run();
        }
      }
    }
  }
}
