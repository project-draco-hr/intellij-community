{
  String platform=System.getProperty(PLATFORM_PREFIX_PROPERTY,"idea");
  String patchFileName=("jetbrains.patch.jar." + platform).toLowerCase();
  String tempDir=System.getProperty("java.io.tmpdir");
  File patchCopy=new File(tempDir,patchFileName + "_copy");
  File log4jCopy=new File(tempDir,"log4j.jar." + platform + "_copy");
  if (!FileUtilRt.delete(patchCopy) || !FileUtilRt.delete(log4jCopy)) {
    throw new IOException("Cannot delete temporary files in " + tempDir);
  }
  File patch=new File(tempDir,patchFileName);
  if (!patch.exists())   return;
  File log4j=new File(PathManager.getLibPath(),"log4j.jar");
  if (!log4j.exists())   throw new IOException("Log4J missing: " + log4j);
  copyFile(patch,patchCopy,true);
  copyFile(log4j,log4jCopy,false);
  int status=0;
  if (Restarter.isSupported()) {
    List<String> args=new ArrayList<String>();
    if (SystemInfoRt.isWindows) {
      File launcher=new File(PathManager.getBinPath(),"VistaLauncher.exe");
      args.add(Restarter.createTempExecutable(launcher).getPath());
    }
    Collections.addAll(args,System.getProperty("java.home") + "/bin/java","-Xmx500m","-classpath",patchCopy.getPath() + File.pathSeparator + log4jCopy.getPath(),"-Djava.io.tmpdir=" + tempDir,"-Didea.updater.log=" + PathManager.getLogPath(),"-Dswing.defaultlaf=" + UIManager.getSystemLookAndFeelClassName(),"com.intellij.updater.Runner","install",PathManager.getHomePath());
    status=Restarter.scheduleRestart(ArrayUtilRt.toStringArray(args));
  }
 else {
    String message="Patch update is not supported - please do it manually";
    showMessage("Update Error",message,true);
  }
  System.exit(status);
}
