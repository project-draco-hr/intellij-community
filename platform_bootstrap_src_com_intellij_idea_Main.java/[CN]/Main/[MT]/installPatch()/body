{
  String platform=System.getProperty(PLATFORM_PREFIX_PROPERTY,"idea");
  String patchFileName=("jetbrains.patch.jar." + platform).toLowerCase();
  String tempDir=System.getProperty("java.io.tmpdir");
  File originalPatchFile=new File(tempDir,patchFileName);
  File copyPatchFile=new File(tempDir,patchFileName + "_copy");
  if (!FileUtilRt.delete(copyPatchFile)) {
    throw new IOException("Cannot create temporary patch file");
  }
  if (!originalPatchFile.exists()) {
    return;
  }
  if (!originalPatchFile.renameTo(copyPatchFile) || !FileUtilRt.delete(originalPatchFile)) {
    throw new IOException("Cannot create temporary patch file");
  }
  int status=0;
  if (Restarter.isSupported()) {
    List<String> args=new ArrayList<String>();
    if (SystemInfoRt.isWindows) {
      File launcher=new File(PathManager.getBinPath(),"VistaLauncher.exe");
      args.add(Restarter.createTempExecutable(launcher).getPath());
    }
    Collections.addAll(args,System.getProperty("java.home") + "/bin/java","-Xmx500m","-classpath",copyPatchFile.getPath() + File.pathSeparator + PathManager.getLibPath()+ "/log4j.jar","-Djava.io.tmpdir=" + tempDir,"com.intellij.updater.Runner","install",PathManager.getHomePath());
    status=Restarter.scheduleRestart(ArrayUtilRt.toStringArray(args));
  }
 else {
    String message="Patch update is not supported - please do it manually";
    showMessage("Update Error",message,true);
  }
  System.exit(status);
}
