{
  if (progress != null) {
    progress.setText("Extracting...");
  }
  File unzipToDir=targetDir;
  if (unwrapSingleTopLevelFolder) {
    unzipToDir=FileUtil.createTempDirectory("unzip-dir-",null);
  }
  ZipEntry entry;
  while ((entry=stream.getNextEntry()) != null) {
    unzipEntryToDir(progress,entry,unzipToDir,stream,pathConvertor,contentProcessor);
  }
  if (unwrapSingleTopLevelFolder) {
    File[] topLevelFiles=unzipToDir.listFiles();
    File dirToMove;
    if (topLevelFiles != null && topLevelFiles.length == 1 && topLevelFiles[0].isDirectory()) {
      dirToMove=topLevelFiles[0];
    }
 else {
      dirToMove=unzipToDir;
    }
    if (!FileUtil.moveDirWithContent(dirToMove,targetDir)) {
      FileUtil.copyDirContent(dirToMove,targetDir);
    }
    FileUtil.delete(unzipToDir);
  }
}
