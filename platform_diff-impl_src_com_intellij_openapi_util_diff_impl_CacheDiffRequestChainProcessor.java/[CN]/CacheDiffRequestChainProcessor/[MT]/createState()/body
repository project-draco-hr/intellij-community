{
  FrameDiffTool frameTool=null;
  for (  DiffTool tool : myToolOrder) {
    if (tool instanceof FrameDiffTool && tool.canShow(myContext,myActiveRequest)) {
      frameTool=(FrameDiffTool)tool;
      break;
    }
  }
  if (frameTool == null)   frameTool=ErrorDiffTool.INSTANCE;
  DiffViewer viewer=frameTool.createComponent(myContext,myActiveRequest);
  DiffViewerWrapper wrapper=myActiveRequest.getUserData(DiffViewerWrapper.KEY);
  if (wrapper == null) {
    return new DefaultState(viewer,frameTool);
  }
 else {
    return new WrapperState(viewer,frameTool,wrapper);
  }
}
