{
  return new DifferBase(project,psiFile,settings){
    @Override public String reformattedText(){
      final JavaCodeFragment file=JavaCodeFragmentFactory.getInstance(project).createCodeBlockCodeFragment(myOrigText,myFile,false);
      WriteCommandAction.runWriteCommandAction(myProject,"CodeStyleSettings extractor","CodeStyleSettings extractor",new Runnable(){
        @Override public void run(){
          final ASTNode treeElement=SourceTreeToPsiMap.psiElementToTree(file);
          assert(treeElement != null);
          SourceTreeToPsiMap.treeElementToPsi(new CodeFormatterFacade(mySettings,file.getLanguage()).processElement(treeElement));
        }
      }
,file);
      return file.getText();
    }
  }
;
}
