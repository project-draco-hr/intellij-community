{
  createTempDirectory();
  return ApplicationManager.getApplication().runWriteAction(new Computable<VirtualFile>(){
    @Override public VirtualFile compute(){
      try {
        VirtualFile tempDir=LocalFileSystem.getInstance().refreshAndFindFileByPath(myTempDir.getCanonicalPath().replace(File.separatorChar,'/'));
        Assert.assertNotNull(tempDir);
        if (targetDir.length() > 0) {
          Assert.assertFalse("nested directories not implemented",targetDir.contains("/"));
          VirtualFile child=tempDir.findChild(targetDir);
          if (child == null) {
            child=tempDir.createChildDirectory(this,targetDir);
          }
          tempDir=child;
        }
        final VirtualFile from=LocalFileSystem.getInstance().refreshAndFindFileByPath(dataDir);
        Assert.assertNotNull(dataDir + " not found",from);
        VfsUtil.copyDirectory(null,from,tempDir,filter);
        return tempDir;
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
    }
  }
);
}
