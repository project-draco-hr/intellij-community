{
  Object value=getValue();
  if (value == null)   return null;
  if (value instanceof CommonProblemDescriptor) {
    return (CommonProblemDescriptor)value;
  }
  final InspectionManager inspectionManager=InspectionManager.getInstance(myPresentation.getContext().getProject());
  final OfflineProblemDescriptor offlineProblemDescriptor=(OfflineProblemDescriptor)value;
  final RefEntity element=getRefElement();
  if (myToolWrapper instanceof LocalInspectionToolWrapper) {
    if (element instanceof RefElement) {
      final PsiElement psiElement=((RefElement)element).getElement();
      if (psiElement != null) {
        ProblemDescriptor descriptor=ProgressManager.getInstance().runProcess(new Computable<ProblemDescriptor>(){
          @Override public ProblemDescriptor compute(){
            return runLocalTool(psiElement,inspectionManager,offlineProblemDescriptor);
          }
        }
,new DaemonProgressIndicator());
        if (descriptor != null)         return descriptor;
      }
    }
    setValue(null);
    return null;
  }
  final List<String> hints=offlineProblemDescriptor.getHints();
  if (element instanceof RefElement) {
    final PsiElement psiElement=((RefElement)element).getElement();
    if (psiElement == null)     return null;
    ProblemDescriptor descriptor=inspectionManager.createProblemDescriptor(psiElement,offlineProblemDescriptor.getDescription(),(LocalQuickFix)null,ProblemHighlightType.GENERIC_ERROR_OR_WARNING,false);
    final LocalQuickFix[] quickFixes=getFixes(descriptor,hints);
    if (quickFixes != null) {
      descriptor=inspectionManager.createProblemDescriptor(psiElement,offlineProblemDescriptor.getDescription(),false,quickFixes,ProblemHighlightType.GENERIC_ERROR_OR_WARNING);
    }
    setValue(descriptor);
    return descriptor;
  }
  CommonProblemDescriptor descriptor=inspectionManager.createProblemDescriptor(offlineProblemDescriptor.getDescription(),(QuickFix)null);
  final QuickFix[] quickFixes=getFixes(descriptor,hints);
  if (quickFixes != null) {
    descriptor=inspectionManager.createProblemDescriptor(offlineProblemDescriptor.getDescription(),quickFixes);
  }
  setValue(descriptor);
  return descriptor;
}
