{
  PsiClass candidate=null;
  boolean foundClassBeingProcessed=false;
  while (position != null) {
    ProgressManager.checkCanceled();
    PsiAnchor anchor=position.peek();
    candidate=(PsiClass)anchor.retrieve();
    if (candidate instanceof PsiAnonymousClass || candidate != null && candidate.hasModifierProperty(PsiModifier.FINAL)) {
      candidate=null;
    }
    if (candidate != null) {
      ClassProcessingStatus status=candidate.getUserData(PROCESSING_SUBCLASSES_STATUS);
      if (status == null) {
        candidate.putUserData(PROCESSING_SUBCLASSES_STATUS,ClassProcessingStatus.PROCESSING_SUBCLASSES);
        break;
      }
      foundClassBeingProcessed|=status == ClassProcessingStatus.PROCESSING_SUBCLASSES;
    }
    if (!foundClassBeingProcessed) {
      candidatesToFindSubclassesIterator.next();
      if (candidate != null) {
        candidate.putUserData(PROCESSING_SUBCLASSES_STATUS,null);
      }
    }
    candidate=null;
    position=position.next();
  }
  return candidate;
}
