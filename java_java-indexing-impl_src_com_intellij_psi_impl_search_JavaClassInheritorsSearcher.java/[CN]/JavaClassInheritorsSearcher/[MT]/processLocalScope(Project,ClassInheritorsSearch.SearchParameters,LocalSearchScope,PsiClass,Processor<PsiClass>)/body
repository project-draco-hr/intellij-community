{
  VirtualFile[] virtualFiles=searchScope.getVirtualFiles();
  final boolean[] success={true};
  for (  VirtualFile virtualFile : virtualFiles) {
    ProgressManager.checkCanceled();
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      @Override public void run(){
        PsiFile psiFile=PsiManager.getInstance(project).findFile(virtualFile);
        if (psiFile != null) {
          psiFile.accept(new JavaRecursiveElementVisitor(){
            @Override public void visitClass(            PsiClass candidate){
              ProgressManager.checkCanceled();
              if (!success[0])               return;
              if (candidate.isInheritor(baseClass,true) && checkCandidate(candidate,parameters) && !consumer.process(candidate)) {
                success[0]=false;
                return;
              }
              super.visitClass(candidate);
            }
            @Override public void visitCodeBlock(            PsiCodeBlock block){
              ProgressManager.checkCanceled();
              if (!parameters.isIncludeAnonymous())               return;
              super.visitCodeBlock(block);
            }
          }
);
        }
      }
    }
);
  }
  return success[0];
}
