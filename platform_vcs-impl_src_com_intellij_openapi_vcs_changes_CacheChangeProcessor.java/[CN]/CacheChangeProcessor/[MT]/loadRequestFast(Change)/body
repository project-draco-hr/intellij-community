{
  if (change == null)   return new NoDiffRequest();
  Pair<Change,DiffRequest> pair=myRequestCache.get(change);
  if (pair != null) {
    Change oldChange=pair.first;
    if (ChangeDiffRequestProducer.isEquals(oldChange,change)) {
      return pair.second;
    }
  }
  if (change.getBeforeRevision() instanceof FakeRevision || change.getAfterRevision() instanceof FakeRevision) {
    ChangeListManager.getInstance(myProject).invokeAfterUpdate(new Runnable(){
      @Override public void run(){
        refresh();
      }
    }
,InvokeAfterUpdateMode.BACKGROUND_CANCELLABLE,"",ModalityState.current());
    return new LoadingDiffRequest(ChangeDiffRequestProducer.getRequestTitle(change));
  }
  return null;
}
