{
  try {
    final CompileScope scope=context.getScope();
    final ProjectDescriptor pd=context.getProjectDescriptor();
    final BuildTargetIndex targetIndex=pd.getBuildTargetIndex();
    int totalAffected=0;
    for (    BuildTargetChunk chunk : targetIndex.getSortedTargetChunks(context)) {
      if (isAffected(context.getScope(),chunk)) {
        totalAffected+=chunk.getTargets().size();
      }
    }
    myTotalTargetsWork=totalAffected;
    boolean compileInParallel=BuildRunner.PARALLEL_BUILD_ENABLED;
    if (compileInParallel && MAX_BUILDER_THREADS <= 1) {
      LOG.info("Switched off parallel compilation because maximum number of builder threads is less than 2. Set '" + GlobalOptions.COMPILE_PARALLEL_MAX_THREADS_OPTION + "' system property to a value greater than 1 to really enable parallel compilation.");
      compileInParallel=false;
    }
    if (compileInParallel) {
      new BuildParallelizer(context).buildInParallel();
    }
 else {
      for (      BuildTargetChunk chunk : targetIndex.getSortedTargetChunks(context)) {
        try {
          buildChunkIfAffected(context,scope,chunk);
        }
  finally {
          pd.dataManager.closeSourceToOutputStorages(Collections.singleton(chunk));
          pd.dataManager.flush(true);
        }
      }
    }
  }
 catch (  IOException e) {
    throw new ProjectBuildException(e);
  }
}
