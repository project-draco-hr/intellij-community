{
  try {
    final CompileScope scope=context.getScope();
    final ProjectDescriptor pd=context.getProjectDescriptor();
    final BuildTargetIndex targetIndex=pd.getBuildTargetIndex();
    int totalAffected=0;
    for (    BuildTargetChunk chunk : targetIndex.getSortedTargetChunks(context)) {
      if (isAffected(context.getScope(),chunk)) {
        totalAffected+=chunk.getTargets().size();
      }
    }
    myTotalTargetsWork=totalAffected;
    if (BuildRunner.PARALLEL_BUILD_ENABLED && MAX_BUILDER_THREADS > 1) {
      new BuildParallelizer(context).buildInParallel();
    }
 else {
      for (      BuildTargetChunk chunk : targetIndex.getSortedTargetChunks(context)) {
        try {
          buildChunkIfAffected(context,scope,chunk);
        }
  finally {
          pd.dataManager.closeSourceToOutputStorages(Collections.singleton(chunk));
          pd.dataManager.flush(true);
        }
      }
    }
  }
 catch (  IOException e) {
    throw new ProjectBuildException(e);
  }
}
