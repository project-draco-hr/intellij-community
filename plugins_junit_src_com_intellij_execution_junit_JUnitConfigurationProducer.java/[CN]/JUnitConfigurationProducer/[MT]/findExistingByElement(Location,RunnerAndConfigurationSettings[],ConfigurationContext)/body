{
  if (PatternConfigurationProducer.isMultipleElementsSelected(context)) {
    return null;
  }
  final RunConfiguration predefinedConfiguration=context.getOriginalConfiguration(JUnitConfigurationType.getInstance());
  location=JavaExecutionUtil.stepIntoSingleClass(location);
  final PsiElement element=location.getPsiElement();
  final PsiClass testClass=JUnitUtil.getTestClass(element);
  final PsiMethod testMethod=JUnitUtil.getTestMethod(element,false);
  final PsiPackage testPackage;
  if (element instanceof PsiPackage) {
    testPackage=(PsiPackage)element;
  }
 else   if (element instanceof PsiDirectory) {
    testPackage=JavaDirectoryService.getInstance().getPackage(((PsiDirectory)element));
  }
 else {
    testPackage=null;
  }
  RunnerAndConfigurationSettings template=RunManager.getInstance(location.getProject()).getConfigurationTemplate(getConfigurationFactory());
  final Module predefinedModule=((JUnitConfiguration)template.getConfiguration()).getConfigurationModule().getModule();
  final String vmParameters=predefinedConfiguration instanceof JUnitConfiguration ? ((JUnitConfiguration)predefinedConfiguration).getVMParameters() : null;
  for (  RunnerAndConfigurationSettings existingConfiguration : existingConfigurations) {
    final JUnitConfiguration unitConfiguration=(JUnitConfiguration)existingConfiguration.getConfiguration();
    if (vmParameters != null && !Comparing.strEqual(vmParameters,unitConfiguration.getVMParameters()))     continue;
    final TestObject testobject=unitConfiguration.getTestObject();
    if (testobject != null) {
      if (testobject.isConfiguredByElement(unitConfiguration,testClass,testMethod,testPackage)) {
        final Module configurationModule=unitConfiguration.getConfigurationModule().getModule();
        if (Comparing.equal(location.getModule(),configurationModule))         return existingConfiguration;
        if (Comparing.equal(predefinedModule,configurationModule)) {
          return existingConfiguration;
        }
      }
    }
  }
  return null;
}
