{
  Project project=e.getProject();
  if (project == null) {
    return;
  }
  StudyToolWindow window=StudyUtils.getStudyToolWindow(project);
  if (window == null) {
    return;
  }
  final StudyEditor selectedEditor=StudyUtils.getSelectedStudyEditor(project);
  if (selectedEditor == null) {
    StudyTaskManager.getInstance(project).setTurnEditingMode(true);
    return;
  }
  final StudyState studyState=new StudyState(selectedEditor);
  VirtualFile taskTextFile=studyState.getTaskDir().findChild(EduNames.TASK_HTML);
  if (taskTextFile == null) {
    LOG.info("Failed to find task.html");
    return;
  }
  Document document=FileDocumentManager.getInstance().getDocument(taskTextFile);
  if (!state) {
    if (document != null) {
      FileDocumentManager.getInstance().saveDocument(document);
    }
    window.leaveEditingMode(project);
    return;
  }
  window.enterEditingMode(taskTextFile,project);
}
