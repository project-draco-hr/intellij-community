{
  String root=JavaTestUtil.getJavaTestDataPath() + "/refactoring/copyClass/multifile/" + getTestName(true);
  String rootBefore=root + "/before";
  PsiTestUtil.removeAllRoots(myModule,IdeaTestUtil.getMockJdk17());
  VirtualFile rootDir=PsiTestUtil.createTestProjectStructure(myProject,myModule,rootBefore,myFilesToDelete);
  final HashMap<PsiFile,PsiClass[]> map=new HashMap<>();
  final VirtualFile sourceDir=rootDir.findChild("p1");
  for (  VirtualFile file : sourceDir.getChildren()) {
    final PsiFile psiFile=myPsiManager.findFile(file);
    if (psiFile instanceof PsiJavaFile) {
      map.put(psiFile,((PsiJavaFile)psiFile).getClasses());
    }
  }
  final VirtualFile targetVDir=rootDir.findChild("p2");
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      CopyClassesHandler.doCopyClasses(map,null,myPsiManager.findDirectory(targetVDir),myProject);
    }
  }
);
  String rootAfter=root + "/after";
  VirtualFile rootDir2=LocalFileSystem.getInstance().findFileByPath(rootAfter.replace(File.separatorChar,'/'));
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      myProject.getComponent(PostprocessReformattingAspect.class).doPostponedFormatting();
    }
  }
);
  PlatformTestUtil.assertDirectoriesEqual(rootDir2,rootDir);
}
