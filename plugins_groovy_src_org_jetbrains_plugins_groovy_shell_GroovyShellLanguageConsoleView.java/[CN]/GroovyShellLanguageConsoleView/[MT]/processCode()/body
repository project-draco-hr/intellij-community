{
  GroovyShellCodeFragment groovyFile=getGroovyFile();
  for (  GrTopStatement statement : groovyFile.getTopStatements()) {
    if (statement instanceof GrImportStatement) {
      groovyFile.addImportsFromString(importToString((GrImportStatement)statement));
    }
 else     if (statement instanceof GrMethod) {
      groovyFile.addVariable(((GrMethod)statement).getName(),generateClosure((GrMethod)statement));
    }
 else     if (statement instanceof GrAssignmentExpression) {
      GrAssignmentExpression assignment=(GrAssignmentExpression)statement;
      GrExpression left=assignment.getLValue();
      if (left instanceof GrReferenceExpression && !((GrReferenceExpression)left).isQualified()) {
        groovyFile.addVariable(((GrReferenceExpression)left).getReferenceName(),assignment.getRValue());
      }
    }
 else     if (statement instanceof GrTypeDefinition) {
      groovyFile.addTypeDefinition(prepareTypeDefinition((GrTypeDefinition)statement));
    }
  }
  PsiType scriptType=groovyFile.getInferredScriptReturnType();
  if (scriptType != null) {
    groovyFile.addVariable("_",scriptType);
  }
}
