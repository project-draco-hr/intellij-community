{
  Indent externalIndent=Indent.getNoneIndent();
  Indent internalIndent=Indent.getContinuationWithoutFirstIndent(myIndentSettings.USE_RELATIVE_INDENTS);
  if (isInsideMethodCallParenthesis(child)) {
    internalIndent=Indent.getSmartIndent(Indent.Type.CONTINUATION);
  }
  AlignmentStrategy alignmentStrategy=AlignmentStrategy.wrap(createAlignment(doAlign,null),JavaTokenType.COMMA);
  setChildIndent(internalIndent);
  setChildAlignment(alignmentStrategy.getAlignment(null));
  boolean methodParametersBlock=true;
  ASTNode lBracketParent=child.getTreeParent();
  if (lBracketParent != null) {
    ASTNode methodCandidate=lBracketParent.getTreeParent();
    methodParametersBlock=methodCandidate != null && (methodCandidate.getElementType() == JavaElementType.METHOD || methodCandidate.getElementType() == JavaElementType.METHOD_CALL_EXPRESSION);
  }
  Alignment bracketAlignment=methodParametersBlock && mySettings.ALIGN_MULTILINE_METHOD_BRACKETS ? Alignment.createAlignment() : null;
  AlignmentStrategy anonymousClassStrategy=doAlign ? alignmentStrategy : AlignmentStrategy.wrap(Alignment.createAlignment(),false,JavaTokenType.NEW_KEYWORD,JavaElementType.NEW_EXPRESSION,JavaTokenType.RBRACE);
  setChildIndent(internalIndent);
  setChildAlignment(alignmentStrategy.getAlignment(null));
  boolean isAfterIncomplete=false;
  ASTNode prev=child;
  boolean afterAnonymousClass=false;
  while (child != null) {
    isAfterIncomplete=isAfterIncomplete || child.getElementType() == TokenType.ERROR_ELEMENT || child.getElementType() == JavaElementType.EMPTY_EXPRESSION;
    if (!FormatterUtil.containsWhiteSpacesOnly(child) && child.getTextLength() > 0) {
      if (child.getElementType() == from) {
        result.add(createJavaBlock(child,mySettings,myJavaSettings,externalIndent,null,bracketAlignment));
      }
 else       if (child.getElementType() == to) {
        Block block=createJavaBlock(child,mySettings,myJavaSettings,isAfterIncomplete && !afterAnonymousClass ? internalIndent : externalIndent,null,isAfterIncomplete ? alignmentStrategy.getAlignment(null) : bracketAlignment);
        result.add(block);
        if (internalIndent instanceof ExpandableIndent && to == JavaTokenType.RPARENTH) {
          ((ExpandableIndent)internalIndent).setStrictMinOffsetBlock(block);
        }
        return child;
      }
 else {
        final IElementType elementType=child.getElementType();
        AlignmentStrategy alignmentStrategyToUse=canUseAnonymousClassAlignment(child) ? anonymousClassStrategy : alignmentStrategy;
        processChild(result,child,alignmentStrategyToUse.getAlignment(elementType),wrappingStrategy.getWrap(elementType),internalIndent);
        if (to == null) {
          return child;
        }
      }
      isAfterIncomplete=false;
      if (child.getElementType() != JavaTokenType.COMMA) {
        afterAnonymousClass=isAnonymousClass(child);
      }
    }
    prev=child;
    child=child.getTreeNext();
  }
  return prev;
}
