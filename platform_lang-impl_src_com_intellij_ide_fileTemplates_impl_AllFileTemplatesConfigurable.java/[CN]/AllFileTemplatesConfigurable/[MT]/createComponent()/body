{
  myUIDisposable=Disposer.newDisposable();
  myTemplatesList=new FileTemplateTabAsList(TEMPLATES_TITLE){
    @Override public void onTemplateSelected(){
      onListSelectionChanged();
    }
  }
;
  myIncludesList=new FileTemplateTabAsList(INCLUDES_TITLE){
    @Override public void onTemplateSelected(){
      onListSelectionChanged();
    }
  }
;
  myCurrentTab=myTemplatesList;
  final List<FileTemplateTab> allTabs=new ArrayList<FileTemplateTab>(Arrays.asList(myTemplatesList,myIncludesList));
  if (myManager.getAllCodeTemplates().length > 0) {
    myCodeTemplatesList=new FileTemplateTabAsList(CODE_TITLE){
      @Override public void onTemplateSelected(){
        onListSelectionChanged();
      }
    }
;
    allTabs.add(myCodeTemplatesList);
  }
  final Set<FileTemplateGroupDescriptorFactory> factories=new THashSet<FileTemplateGroupDescriptorFactory>();
  ContainerUtil.addAll(factories,ApplicationManager.getApplication().getComponents(FileTemplateGroupDescriptorFactory.class));
  ContainerUtil.addAll(factories,Extensions.getExtensions(FileTemplateGroupDescriptorFactory.EXTENSION_POINT_NAME));
  if (!factories.isEmpty()) {
    myOtherTemplatesList=new FileTemplateTabAsTree(OTHER_TITLE){
      @Override public void onTemplateSelected(){
        onListSelectionChanged();
      }
      @Override protected FileTemplateNode initModel(){
        SortedSet<FileTemplateGroupDescriptor> categories=new TreeSet<FileTemplateGroupDescriptor>(new Comparator<FileTemplateGroupDescriptor>(){
          @Override public int compare(          FileTemplateGroupDescriptor o1,          FileTemplateGroupDescriptor o2){
            return o1.getTitle().compareTo(o2.getTitle());
          }
        }
);
        for (        FileTemplateGroupDescriptorFactory templateGroupFactory : factories) {
          ContainerUtil.addIfNotNull(templateGroupFactory.getFileTemplatesDescriptor(),categories);
        }
        return new FileTemplateNode("ROOT",null,ContainerUtil.map2List(categories,new Function<FileTemplateGroupDescriptor,FileTemplateNode>(){
          @Override public FileTemplateNode fun(          FileTemplateGroupDescriptor s){
            return new FileTemplateNode(s);
          }
        }
));
      }
    }
;
    allTabs.add(myOtherTemplatesList);
  }
  myEditor=new FileTemplateConfigurable();
  myEditor.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent e){
      onEditorChanged();
    }
  }
);
  myEditorComponent=myEditor.createComponent();
  myEditorComponent.setBorder(BorderFactory.createEmptyBorder(0,10,10,10));
  myTabs=allTabs.toArray(new FileTemplateTab[allTabs.size()]);
  myTabbedPane=new TabbedPaneWrapper(myUIDisposable);
  myTabbedPane.setTabLayoutPolicy(JTabbedPane.SCROLL_TAB_LAYOUT);
  myLeftPanel=new JPanel(new CardLayout());
  for (  FileTemplateTab tab : myTabs) {
    myLeftPanel.add(ScrollPaneFactory.createScrollPane(tab.getComponent(),SideBorder.TOP),tab.getTitle());
    JPanel fakePanel=new JPanel();
    fakePanel.setPreferredSize(new Dimension(0,0));
    myTabbedPane.addTab(tab.getTitle(),fakePanel);
  }
  myTabbedPane.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent e){
      onTabChanged();
    }
  }
);
  DefaultActionGroup group=new DefaultActionGroup();
  AnAction removeAction=new AnAction(IdeBundle.message("action.remove.template"),null,AllIcons.General.Remove){
    @Override public void actionPerformed(    AnActionEvent e){
      onRemove();
    }
    @Override public void update(    AnActionEvent e){
      super.update(e);
      FileTemplate selectedItem=myCurrentTab.getSelectedTemplate();
      e.getPresentation().setEnabled(selectedItem != null && !isInternalTemplate(selectedItem.getName(),myCurrentTab.getTitle()));
    }
  }
;
  AnAction addAction=new AnAction(IdeBundle.message("action.create.template"),null,AllIcons.General.Add){
    @Override public void actionPerformed(    AnActionEvent e){
      onAdd();
    }
    @Override public void update(    AnActionEvent e){
      super.update(e);
      e.getPresentation().setEnabled(!(myCurrentTab == myCodeTemplatesList || myCurrentTab == myOtherTemplatesList));
    }
  }
;
  AnAction cloneAction=new AnAction(IdeBundle.message("action.copy.template"),null,PlatformIcons.COPY_ICON){
    @Override public void actionPerformed(    AnActionEvent e){
      onClone();
    }
    @Override public void update(    AnActionEvent e){
      super.update(e);
      e.getPresentation().setEnabled(myCurrentTab != myCodeTemplatesList && myCurrentTab != myOtherTemplatesList && myCurrentTab.getSelectedTemplate() != null);
    }
  }
;
  AnAction resetAction=new AnAction(IdeBundle.message("action.reset.to.default"),null,AllIcons.Actions.Reset){
    @Override public void actionPerformed(    AnActionEvent e){
      onReset();
    }
    @Override public void update(    AnActionEvent e){
      super.update(e);
      final FileTemplate selectedItem=myCurrentTab.getSelectedTemplate();
      e.getPresentation().setEnabled(selectedItem instanceof BundledFileTemplate && !selectedItem.isDefault());
    }
  }
;
  group.add(addAction);
  group.add(removeAction);
  group.add(cloneAction);
  group.add(resetAction);
  addAction.registerCustomShortcutSet(CommonShortcuts.INSERT,myCurrentTab.getComponent());
  removeAction.registerCustomShortcutSet(CommonShortcuts.getDelete(),myCurrentTab.getComponent());
  myToolBar=ActionManager.getInstance().createActionToolbar(ActionPlaces.UNKNOWN,group,true).getComponent();
  myToolBar.setBorder(IdeBorderFactory.createEmptyBorder());
  JPanel toolbarPanel=new JPanel(new BorderLayout());
  toolbarPanel.add(myToolBar,BorderLayout.WEST);
  JPanel centerPanel=new JPanel(new BorderLayout());
  centerPanel.add(myTabbedPane.getComponent(),BorderLayout.NORTH);
  OnePixelSplitter splitter=new OnePixelSplitter(false,0.3f);
  splitter.setFirstComponent(myLeftPanel);
  splitter.setSecondComponent(myEditorComponent);
  centerPanel.add(splitter,BorderLayout.CENTER);
  myMainPanel=new JPanel(new BorderLayout());
  myMainPanel.add(toolbarPanel,BorderLayout.NORTH);
  myMainPanel.add(centerPanel,BorderLayout.CENTER);
  return myMainPanel;
}
