{
  int startOffset=editor.getSelectionModel().getSelectionStart();
  int endOffset=editor.getSelectionModel().getSelectionEnd();
  PsiElement[] elements;
  PsiExpression expr=CodeInsightUtil.findExpressionInRange(file,startOffset,endOffset);
  if (expr != null) {
    elements=new PsiElement[]{expr};
  }
 else {
    elements=CodeInsightUtil.findStatementsInRange(file,startOffset,endOffset);
  }
  if (elements.length == 0) {
    final PsiExpression expression=IntroduceVariableBase.getSelectedExpression(project,file,startOffset,endOffset);
    if (expression != null) {
      elements=new PsiElement[]{expression};
    }
  }
  assertTrue(elements.length > 0);
  final ExtractMethodProcessor processor=new ExtractMethodProcessor(project,editor,elements,null,"Extract Method","newMethod",null);
  processor.setShowErrorDialogs(false);
  processor.setChainedConstructor(extractChainedConstructor);
  if (!processor.prepare()) {
    return false;
  }
  if (doRefactor) {
    processor.testPrepare(returnType,makeStatic);
    processor.testNullness();
    if (disabledParams != null) {
      for (      int param : disabledParams) {
        processor.doNotPassParameter(param);
      }
    }
    if (newNameOfFirstParam != null) {
      processor.changeParamName(0,newNameOfFirstParam);
    }
    ExtractMethodHandler.run(project,editor,processor);
  }
  if (replaceAllDuplicates) {
    final Boolean hasDuplicates=processor.hasDuplicates();
    if (hasDuplicates == null || hasDuplicates.booleanValue()) {
      final List<Match> duplicates=processor.getDuplicates();
      for (      final Match match : duplicates) {
        if (!match.getMatchStart().isValid() || !match.getMatchEnd().isValid())         continue;
        PsiDocumentManager.getInstance(project).commitAllDocuments();
        processor.processMatch(match);
      }
    }
  }
  return true;
}
