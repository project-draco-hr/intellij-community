{
  myIgnoreInjectedPsi=ignoreInjectedPsi;
  myDisplayName=displayName;
  Set<PsiElement> localScope=new LinkedHashSet<PsiElement>(scope.length);
  Set<VirtualFile> virtualFiles=new THashSet<VirtualFile>(scope.length);
  for (  final PsiElement element : scope) {
    LOG.assertTrue(element != null,"null element");
    PsiFile containingFile=element.getContainingFile();
    LOG.assertTrue(containingFile != null,element.getClass().getName());
    if (element instanceof PsiFile) {
      for (      PsiFile file : ((PsiFile)element).getViewProvider().getAllFiles()) {
        if (file == null)         throw new IllegalArgumentException("file " + element + " returned null in its getAllFiles()");
        localScope.add(file);
      }
    }
 else     if (element instanceof StubBasedPsiElement || element.getTextRange() != null) {
      localScope.add(element);
    }
    VirtualFile virtualFile=PsiUtilCore.getVirtualFile(containingFile);
    if (virtualFile != null) {
      virtualFiles.add(virtualFile);
    }
  }
  myScope=PsiUtilCore.toPsiElementArray(localScope);
  myVirtualFiles=virtualFiles.isEmpty() ? VirtualFile.EMPTY_ARRAY : virtualFiles.toArray(VirtualFile.EMPTY_ARRAY);
}
