{
  if (role) {
    final String pattern=expression instanceof PsiMethodCallExpression || expression instanceof PsiReferenceExpression ? "%s::isInstance" : "(%s)::isInstance";
    return String.format(pattern,expression.getText());
  }
  if (expression instanceof PsiNewExpression) {
    final PsiAnonymousClass anonymousClass=((PsiNewExpression)expression).getAnonymousClass();
    if (anonymousClass != null && AnonymousCanBeLambdaInspection.canBeConvertedToLambda(anonymousClass,true)) {
      final PsiLambdaExpression lambdaExpression=AnonymousCanBeLambdaInspection.replacePsiElementWithLambda(expression,true);
      LOG.assertTrue(lambdaExpression != null);
      return lambdaExpression.getText();
    }
  }
  String qualifierText=expression.getText();
  if (!(expression instanceof PsiMethodCallExpression) && !(expression instanceof PsiReferenceExpression)) {
    qualifierText="(" + qualifierText + ")";
  }
  return qualifierText + "::apply";
}
