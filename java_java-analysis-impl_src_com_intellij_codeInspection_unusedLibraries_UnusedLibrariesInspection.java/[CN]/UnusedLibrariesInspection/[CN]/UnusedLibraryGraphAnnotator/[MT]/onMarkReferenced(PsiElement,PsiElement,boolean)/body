{
  if (what != null && from != null) {
    final VirtualFile virtualFile=PsiUtilCore.getVirtualFile(what);
    final VirtualFile containingDir=virtualFile != null ? virtualFile.getParent() : null;
    if (containingDir != null) {
      final DirectoryInfo infoForDirectory=myDirectoryIndex.getInfoForDirectory(containingDir);
      final VirtualFile libraryClassRoot=infoForDirectory != null ? infoForDirectory.getLibraryClassRoot() : null;
      if (libraryClassRoot != null) {
        final Module fromModule=ModuleUtilCore.findModuleForPsiElement(from);
        if (fromModule != null) {
          final RefModule refModule=myManager.getRefModule(fromModule);
          if (refModule != null) {
            Set<VirtualFile> modules=refModule.getUserData(USED_LIBRARY_ROOTS);
            if (modules == null) {
              modules=new HashSet<VirtualFile>();
              refModule.putUserData(USED_LIBRARY_ROOTS,modules);
            }
            modules.add(libraryClassRoot);
          }
        }
      }
    }
  }
}
