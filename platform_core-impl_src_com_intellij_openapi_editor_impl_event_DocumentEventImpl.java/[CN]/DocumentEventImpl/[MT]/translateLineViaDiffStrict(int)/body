{
  Diff.Change change=reBuildDiffIfNeeded();
  if (change == null)   return line;
  int startLine=getDocument().getLineNumber(getOffset());
  if (line < startLine)   return line;
  int translatedRelative=Diff.translateLine(change,line - startLine);
  return translatedRelative < 0 ? -1 : translatedRelative + startLine;
}
