{
  List<TextAttributesKey> list=new ArrayList<>(myAttributesMap.keySet());
  list.sort(null);
  for (  TextAttributesKey key : list) {
    TextAttributesKey baseKey=key.getFallbackAttributeKey();
    TextAttributes defaultFallbackAttr=baseKey != null && myParentScheme instanceof AbstractColorsScheme ? ((AbstractColorsScheme)myParentScheme).getFallbackAttributes(baseKey) : null;
    TextAttributes value=myAttributesMap.get(key);
    if (baseKey != null && value.isFallbackEnabled()) {
      if (isParentOverwritingInheritance(key)) {
        attrElements.addContent(new Element(OPTION_ELEMENT).setAttribute(NAME_ATTR,key.getExternalName()).setAttribute(BASE_ATTRIBUTES_ATTR,baseKey.getExternalName()));
      }
    }
 else {
      TextAttributes defaultAttr=myParentScheme == null ? new TextAttributes() : myParentScheme.getAttributes(key);
      if (value.containsValue() && !value.equals(defaultAttr) || defaultAttr == defaultFallbackAttr) {
        Element valueElement=new Element(VALUE_ELEMENT);
        value.writeExternal(valueElement);
        attrElements.addContent(new Element(OPTION_ELEMENT).setAttribute(NAME_ATTR,key.getExternalName()).addContent(valueElement));
      }
    }
  }
}
