{
  final PsiVariable variable=ApplicationManager.getApplication().runWriteAction(IntroduceVariableBase.introduce(myProject,myExpr,myEditor,myChosenAnchor.getElement(),getOccurrences(),mySettings));
  PsiDocumentManager.getInstance(myProject).doPostponedOperationsAndUnblockDocument(myEditor.getDocument());
  final PsiDeclarationStatement declarationStatement=PsiTreeUtil.getParentOfType(variable,PsiDeclarationStatement.class);
  myPointer=declarationStatement != null ? SmartPointerManager.getInstance(myProject).createSmartPsiElementPointer(declarationStatement) : null;
  myEditor.putUserData(ReassignVariableUtil.DECLARATION_KEY,myPointer);
  setAdvertisementText(getAdvertisementText(declarationStatement,variable.getType(),myHasTypeSuggestion));
  final PsiIdentifier identifier=variable.getNameIdentifier();
  if (identifier != null) {
    myEditor.getCaretModel().moveToOffset(identifier.getTextOffset());
  }
  try {
    myDeleteSelf=false;
    restoreState(variable);
  }
  finally {
    myDeleteSelf=true;
  }
  initOccurrencesMarkers();
  return variable;
}
