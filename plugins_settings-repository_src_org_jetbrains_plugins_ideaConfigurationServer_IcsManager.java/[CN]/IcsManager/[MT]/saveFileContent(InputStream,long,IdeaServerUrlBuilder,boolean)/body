{
  File tmpFile=null;
  try {
    if (canUseLocalCopy(builder)) {
      File localFile=new File(myLocalCopyDir,builder.buildPath());
      localFile.getParentFile().mkdirs();
      FileOutputStream out=new FileOutputStream(localFile);
      try {
        FileUtil.copy(content,(int)size,out);
      }
  finally {
        out.close();
      }
      tmpFile=FileUtil.createTempFile("configr","temp");
      FileUtil.copy(localFile,tmpFile);
    }
 else {
      tmpFile=copyStreamToTempFile(content,size);
    }
  }
  finally {
    if (tmpFile != null) {
      if (async) {
        saveUserPreferencesAsync(tmpFile,builder);
      }
 else {
        try {
          saveUserPreferences(tmpFile,builder);
        }
  finally {
          FileUtil.delete(tmpFile);
        }
      }
    }
  }
}
