{
  ProjectId projectId=ProjectId.getInstance(project);
  if (projectId.uid == null) {
    return;
  }
  StateStorageManager storageManager=((ProjectEx)project).getStateStore().getStateStorageManager();
  storageManager.setStreamProvider(new IcsStreamProvider(projectId.uid){
    @Override public boolean isApplicable(    @NotNull String fileSpec,    @NotNull RoamingType roamingType){
      if (roamingType != RoamingType.PER_USER) {
        return true;
      }
      if (StorageUtil.isProjectOrModuleFile(fileSpec)) {
        return false;
      }
      return settings.shareProjectWorkspace || (!fileSpec.equals(StoragePathMacros.WORKSPACE_FILE));
    }
  }
);
  updateStoragesFromStreamProvider(storageManager,storageManager.getStorageFileNames());
}
