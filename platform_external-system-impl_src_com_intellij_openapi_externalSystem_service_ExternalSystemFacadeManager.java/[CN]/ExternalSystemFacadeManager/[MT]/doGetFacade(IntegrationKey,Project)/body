{
  boolean currentInProcess=Registry.is(ExternalSystemConstants.USE_IN_PROCESS_COMMUNICATION_REGISTRY_KEY,false);
  if (myInProcessCommunication.getAndSet(currentInProcess) != currentInProcess) {
    myCommunicationManager.get().clear();
    myCommunicationManager.set(currentInProcess ? myInProcessCommunicationManager : myRemoteCommunicationManager);
  }
  ExternalSystemManager manager=ExternalSystemApiUtil.getManager(key.getExternalSystemId());
  if (project.isDisposed() || manager == null) {
    return RemoteExternalSystemFacade.NULL_OBJECT;
  }
  Pair<RemoteExternalSystemFacade,ExternalSystemExecutionSettings> pair=myRemoteFacades.get(key);
  if (pair != null && prepare(project,key,pair)) {
    return pair.first;
  }
  myLock.lock();
  try {
    pair=myRemoteFacades.get(key);
    if (pair != null && prepare(project,key,pair)) {
      return pair.first;
    }
    if (pair != null) {
      myCommunicationManager.get().clear();
      myFacadeWrappers.clear();
      myRemoteFacades.clear();
    }
    return doCreateFacade(key,project);
  }
  finally {
    myLock.unlock();
  }
}
