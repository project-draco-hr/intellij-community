{
  CompiledPattern pattern=myGlobalVisitor.getContext().getPattern();
  PsiElement newElement=SkippingHandler.skipNodeIfNeccessary(element);
  if (element != newElement && newElement != null) {
    newElement.accept(this);
    pattern.setHandler(element,new LightTopLevelMatchingHandler(pattern.getHandler(element)));
  }
 else {
    myGlobalVisitor.setCodeBlockLevel(myGlobalVisitor.getCodeBlockLevel() + 1);
    for (PsiElement el=element.getFirstChild(); el != null; el=el.getNextSibling()) {
      if (GlobalCompilingVisitor.getFilter().accepts(el)) {
        if (el instanceof PsiWhiteSpace) {
          myGlobalVisitor.addLexicalNode(el);
        }
      }
 else {
        el.accept(this);
        MatchingHandler matchingHandler=pattern.getHandler(el);
        pattern.setHandler(el,element == myTopElement ? new TopLevelMatchingHandler(matchingHandler) : new LightTopLevelMatchingHandler(matchingHandler));
      }
    }
    myGlobalVisitor.setCodeBlockLevel(myGlobalVisitor.getCodeBlockLevel() - 1);
    pattern.setHandler(element,new TopLevelMatchingHandler(pattern.getHandler(element)));
  }
}
