{
  SmartPointerManager pointerManager=SmartPointerManager.getInstance(context.getProject());
  SmartPsiElementPointer<PsiTypeCastExpression> pointer=pointerManager.createSmartPsiElementPointer(expression);
  final PsiTypeCastExpression cast=pointer.getElement();
  if (cast == null)   return;
  final Template template=createTemplate(cast);
  final Runnable runnable=new Runnable(){
    @Override public void run(){
      Editor editor=context.getEditor();
      editor.getCaretModel().moveToOffset(cast.getTextRange().getStartOffset());
      TemplateManager.getInstance(context.getProject()).startTemplate(editor,template);
    }
  }
;
  context.setLaterRunnable(new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          CommandProcessor.getInstance().runUndoTransparentAction(runnable);
        }
      }
);
    }
  }
);
}
