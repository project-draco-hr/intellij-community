{
  Project project=e.getData(CommonDataKeys.PROJECT);
  final Change[] changes=e.getData(VcsDataKeys.CHANGES);
  if ((changes == null) || (changes.length == 0))   return;
  String commitMessage=null;
  List<ShelvedChangeList> shelvedChangeLists=ShelvedChangesViewManager.getShelvedLists(e.getDataContext());
  if (!shelvedChangeLists.isEmpty()) {
    commitMessage=shelvedChangeLists.get(0).DESCRIPTION;
  }
 else {
    ChangeList[] changeLists=e.getData(VcsDataKeys.CHANGE_LISTS);
    if (changeLists != null && changeLists.length > 0) {
      commitMessage=changeLists[0].getComment();
    }
  }
  if (commitMessage == null) {
    commitMessage=e.getData(VcsDataKeys.PRESET_COMMIT_MESSAGE);
  }
  if (commitMessage == null) {
    commitMessage="";
  }
  List<Change> changeCollection=new ArrayList<>();
  Collections.addAll(changeCollection,changes);
  createPatch(project,commitMessage,changeCollection);
}
