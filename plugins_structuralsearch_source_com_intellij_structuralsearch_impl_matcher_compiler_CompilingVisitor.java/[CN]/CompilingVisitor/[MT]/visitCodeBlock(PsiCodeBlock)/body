{
  ++codeBlockLevel;
  MatchingStrategy strategy=null;
  for (PsiElement el=block.getFirstChild(); el != null; el=el.getNextSibling()) {
    if (filter.accepts(el)) {
      if (el instanceof PsiWhiteSpace) {
        lexicalNodes.add(el);
      }
    }
 else {
      el.accept(this);
      if (codeBlockLevel == 1) {
        MatchingStrategy newstrategy=findStrategy(el);
        if (strategy == null || (strategy instanceof JavaDocMatchingStrategy)) {
          strategy=newstrategy;
        }
 else {
          if (strategy.getClass() != newstrategy.getClass()) {
            if (!(strategy instanceof CommentMatchingStrategy)) {
              throw new UnsupportedPatternException(SSRBundle.message("different.strategies.for.top.level.nodes.error.message"));
            }
            strategy=newstrategy;
          }
        }
      }
    }
  }
  if (codeBlockLevel == 1) {
    if (strategy == null) {
      strategy=ExprMatchingStrategy.getInstance();
    }
    context.pattern.setStrategy(strategy);
  }
  --codeBlockLevel;
}
