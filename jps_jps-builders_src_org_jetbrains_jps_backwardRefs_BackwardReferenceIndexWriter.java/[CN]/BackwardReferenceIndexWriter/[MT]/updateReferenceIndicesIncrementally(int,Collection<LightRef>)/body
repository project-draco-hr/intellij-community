{
  final Collection<LightRef> rawOldUsages=myIndex.getReferenceMap().get(fileId);
  Collection<LightRef> oldUsages=rawOldUsages == null ? null : new ArrayList<LightRef>(rawOldUsages);
  for (  LightRef usage : usages) {
    if (oldUsages == null || !oldUsages.remove(usage)) {
      myIndex.getBackwardReferenceMap().put(usage,fileId);
      myIndex.getReferenceMap().put(fileId,usage);
    }
  }
  if (oldUsages != null && !oldUsages.isEmpty()) {
    myIndex.getReferenceMap().removeAll(fileId,oldUsages);
    for (    LightRef usage : oldUsages) {
      myIndex.getBackwardReferenceMap().removeFrom(usage,fileId);
    }
  }
}
