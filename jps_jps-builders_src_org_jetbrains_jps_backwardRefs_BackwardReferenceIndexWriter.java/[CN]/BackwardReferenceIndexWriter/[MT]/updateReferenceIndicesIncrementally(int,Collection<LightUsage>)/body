{
  final Collection<LightUsage> rawOldUsages=myIndex.getReferenceMap().get(fileId);
  Collection<LightUsage> oldUsages=rawOldUsages == null ? null : new ArrayList<LightUsage>(rawOldUsages);
  for (  LightUsage usage : usages) {
    if (oldUsages == null || !oldUsages.remove(usage)) {
      myIndex.getBackwardReferenceMap().put(usage,fileId);
      myIndex.getReferenceMap().put(fileId,usage);
    }
  }
  if (oldUsages != null && !oldUsages.isEmpty()) {
    myIndex.getReferenceMap().removeAll(fileId,oldUsages);
    for (    LightUsage usage : oldUsages) {
      myIndex.getBackwardReferenceMap().removeFrom(usage,fileId);
    }
  }
}
