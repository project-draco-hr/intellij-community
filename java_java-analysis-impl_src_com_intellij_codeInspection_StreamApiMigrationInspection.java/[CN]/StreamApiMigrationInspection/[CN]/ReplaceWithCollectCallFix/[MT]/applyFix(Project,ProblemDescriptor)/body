{
  final PsiForeachStatement foreachStatement=PsiTreeUtil.getParentOfType(descriptor.getPsiElement(),PsiForeachStatement.class);
  if (foreachStatement != null) {
    if (!FileModificationService.getInstance().preparePsiElementForWrite(foreachStatement))     return;
    PsiStatement body=foreachStatement.getBody();
    final PsiExpression iteratedValue=foreachStatement.getIteratedValue();
    if (body != null && iteratedValue != null) {
      final PsiParameter parameter=foreachStatement.getIterationParameter();
      final StringBuilder builder=new StringBuilder(getIteratedValueText(iteratedValue) + ".stream()");
      final PsiIfStatement ifStatement=extractIfStatement(body);
      final PsiMethodCallExpression methodCallExpression=extractAddCall(body,ifStatement);
      builder.append(createFiltersChainText(body,parameter,ifStatement));
      builder.append(createMapperFunctionalExpressionText(project,parameter,methodCallExpression.getArgumentList().getExpressions()[0]));
      builder.append(".collect(java.util.stream.Collectors.");
      PsiElement result=null;
      try {
        final PsiExpression qualifierExpression=methodCallExpression.getMethodExpression().getQualifierExpression();
        final PsiElementFactory elementFactory=JavaPsiFacade.getElementFactory(project);
        if (qualifierExpression instanceof PsiReferenceExpression) {
          final PsiElement resolve=((PsiReferenceExpression)qualifierExpression).resolve();
          if (resolve instanceof PsiVariable) {
            if (resolve instanceof PsiLocalVariable && foreachStatement.equals(PsiTreeUtil.skipSiblingsForward(resolve.getParent(),PsiWhiteSpace.class))) {
              final PsiExpression initializer=((PsiVariable)resolve).getInitializer();
              if (initializer instanceof PsiNewExpression) {
                final PsiExpressionList argumentList=((PsiNewExpression)initializer).getArgumentList();
                if (argumentList != null && argumentList.getExpressions().length == 0) {
                  restoreComments(foreachStatement,body);
                  final String callText=builder.toString() + createInitializerReplacementText(initializer) + ")";
                  result=initializer.replace(elementFactory.createExpressionFromText(callText,null));
                  simplifyRedundantCast(result);
                  foreachStatement.delete();
                  return;
                }
              }
            }
          }
        }
        restoreComments(foreachStatement,body);
        final String qualifierText=qualifierExpression != null ? qualifierExpression.getText() : "";
        final String callText=StringUtil.getQualifiedName(qualifierText,"addAll(" + builder.toString() + "toList()));");
        result=foreachStatement.replace(elementFactory.createStatementFromText(callText,foreachStatement));
        simplifyRedundantCast(result);
      }
  finally {
        if (result != null) {
          CodeStyleManager.getInstance(project).reformat(JavaCodeStyleManager.getInstance(project).shortenClassReferences(result));
        }
      }
    }
  }
}
