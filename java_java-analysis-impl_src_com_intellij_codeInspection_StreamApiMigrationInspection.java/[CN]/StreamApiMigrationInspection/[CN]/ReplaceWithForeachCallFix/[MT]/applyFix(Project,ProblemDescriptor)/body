{
  final PsiForeachStatement foreachStatement=PsiTreeUtil.getParentOfType(descriptor.getPsiElement(),PsiForeachStatement.class);
  if (foreachStatement != null) {
    if (!FileModificationService.getInstance().preparePsiElementForWrite(foreachStatement))     return;
    PsiStatement body=foreachStatement.getBody();
    final PsiExpression iteratedValue=foreachStatement.getIteratedValue();
    if (body != null && iteratedValue != null) {
      restoreComments(foreachStatement,body);
      final PsiParameter parameter=foreachStatement.getIterationParameter();
      final PsiElementFactory elementFactory=JavaPsiFacade.getElementFactory(project);
      TerminalBlock tb=TerminalBlock.from(parameter,body);
      List<String> intermediateOps=tb.extractOperationReplacements(elementFactory);
      StringBuilder buffer=generateStream(iteratedValue,intermediateOps);
      PsiElement block=tb.convertToElement(elementFactory);
      buffer.append(".").append(myForEachMethodName).append("(");
      final String functionalExpressionText=createForEachFunctionalExpressionText(project,block,tb.getVariable());
      PsiExpressionStatement callStatement=(PsiExpressionStatement)elementFactory.createStatementFromText(buffer.toString() + functionalExpressionText + ");",foreachStatement);
      callStatement=(PsiExpressionStatement)foreachStatement.replace(callStatement);
      final PsiExpressionList argumentList=((PsiCallExpression)callStatement.getExpression()).getArgumentList();
      LOG.assertTrue(argumentList != null,callStatement.getText());
      final PsiExpression[] expressions=argumentList.getExpressions();
      LOG.assertTrue(expressions.length == 1);
      if (expressions[0] instanceof PsiFunctionalExpression && ((PsiFunctionalExpression)expressions[0]).getFunctionalInterfaceType() == null) {
        callStatement=(PsiExpressionStatement)callStatement.replace(elementFactory.createStatementFromText(buffer.toString() + "(" + tb.getVariable().getText()+ ") -> "+ wrapInBlock(block)+ ");",callStatement));
      }
      simplifyRedundantCast(callStatement);
      CodeStyleManager.getInstance(project).reformat(JavaCodeStyleManager.getInstance(project).shortenClassReferences(callStatement));
    }
  }
}
