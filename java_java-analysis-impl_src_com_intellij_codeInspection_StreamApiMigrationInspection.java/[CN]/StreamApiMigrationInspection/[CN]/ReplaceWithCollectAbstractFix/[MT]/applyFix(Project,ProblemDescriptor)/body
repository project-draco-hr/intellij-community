{
  final PsiForeachStatement foreachStatement=PsiTreeUtil.getParentOfType(descriptor.getPsiElement(),PsiForeachStatement.class);
  if (foreachStatement != null) {
    if (!FileModificationService.getInstance().preparePsiElementForWrite(foreachStatement))     return;
    final PsiElementFactory elementFactory=JavaPsiFacade.getElementFactory(project);
    PsiStatement body=foreachStatement.getBody();
    final PsiExpression iteratedValue=foreachStatement.getIteratedValue();
    if (body != null && iteratedValue != null) {
      final PsiParameter parameter=foreachStatement.getIterationParameter();
      final PsiIfStatement ifStatement=extractIfStatement(body);
      final PsiMethodCallExpression methodCallExpression=extractAddCall(body,ifStatement);
      if (methodCallExpression == null)       return;
      if (isAddAllCall(foreachStatement,body)) {
        restoreComments(foreachStatement,body);
        final PsiExpression qualifierExpression=methodCallExpression.getMethodExpression().getQualifierExpression();
        final String qualifierText=qualifierExpression != null ? qualifierExpression.getText() : "";
        final String callText=StringUtil.getQualifiedName(qualifierText,"addAll(" + getIteratedValueText(iteratedValue) + ");");
        PsiElement result=foreachStatement.replace(elementFactory.createStatementFromText(callText,foreachStatement));
        reformatWhenNeeded(project,result);
        return;
      }
      final StringBuilder builder=new StringBuilder(getIteratedValueText(iteratedValue) + ".stream()");
      builder.append(createFiltersChainText(body,parameter,ifStatement));
      builder.append(createMapperFunctionalExpressionText(parameter,methodCallExpression.getArgumentList().getExpressions()[0]));
      builder.append(".collect(java.util.stream.Collectors.");
      PsiElement result=null;
      try {
        final PsiExpression qualifierExpression=methodCallExpression.getMethodExpression().getQualifierExpression();
        if (qualifierExpression instanceof PsiReferenceExpression) {
          final PsiElement resolve=((PsiReferenceExpression)qualifierExpression).resolve();
          if (resolve instanceof PsiVariable) {
            if (resolve instanceof PsiLocalVariable && foreachStatement.equals(PsiTreeUtil.skipSiblingsForward(resolve.getParent(),PsiWhiteSpace.class))) {
              final PsiExpression initializer=((PsiVariable)resolve).getInitializer();
              if (initializer instanceof PsiNewExpression) {
                final PsiExpressionList argumentList=((PsiNewExpression)initializer).getArgumentList();
                if (argumentList != null && argumentList.getExpressions().length == 0) {
                  restoreComments(foreachStatement,body);
                  final String callText=builder.toString() + createInitializerReplacementText(((PsiVariable)resolve).getType(),initializer) + ")";
                  result=initializer.replace(elementFactory.createExpressionFromText(callText,null));
                  simplifyRedundantCast(result);
                  foreachStatement.delete();
                  return;
                }
              }
            }
          }
        }
        restoreComments(foreachStatement,body);
        final String qualifierText=qualifierExpression != null ? qualifierExpression.getText() : "";
        final String callText=StringUtil.getQualifiedName(qualifierText,"addAll(" + builder.toString() + "toList()));");
        result=foreachStatement.replace(elementFactory.createStatementFromText(callText,foreachStatement));
        simplifyRedundantCast(result);
      }
  finally {
        reformatWhenNeeded(project,result);
      }
    }
  }
}
