{
  final Project project=CommonDataKeys.PROJECT.getData(dataContext);
  if (project == null)   return null;
  final Editor editor=CommonDataKeys.EDITOR.getData(dataContext);
  if (LOG.isDebugEnabled()) {
    LOG.debug("editor " + editor);
  }
  if (editor != null) {
    final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (file == null)     return null;
    final PsiElement targetElement=TargetElementUtilBase.findTargetElement(editor,TargetElementUtilBase.ELEMENT_NAME_ACCEPTED | TargetElementUtilBase.REFERENCED_ELEMENT_ACCEPTED | TargetElementUtilBase.LOOKUP_ITEM_ACCEPTED);
    if (LOG.isDebugEnabled()) {
      LOG.debug("target element " + targetElement);
    }
    if (targetElement instanceof PsiClass) {
      return targetElement;
    }
    final int offset=editor.getCaretModel().getOffset();
    PsiElement element=file.findElementAt(offset);
    while (element != null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("context element " + element);
      }
      if (element instanceof PsiFile) {
        if (!(element instanceof PsiClassOwner))         return null;
        final PsiClass[] classes=((PsiClassOwner)element).getClasses();
        return classes.length == 1 ? classes[0] : null;
      }
      if (element instanceof PsiClass && !(element instanceof PsiAnonymousClass) && !(element instanceof PsiSyntheticClass)) {
        return element;
      }
      element=element.getParent();
    }
    return null;
  }
 else {
    final PsiElement element=CommonDataKeys.PSI_ELEMENT.getData(dataContext);
    return element instanceof PsiClass ? (PsiClass)element : null;
  }
}
