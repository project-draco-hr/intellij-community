{
  TargetElementUtilBase util=TargetElementUtilBase.getInstance();
  PsiElement element=assertSameProject(getElementFromLookup(editor,file));
  if (element == null && file != null) {
    final DocumentationProvider documentationProvider=getProviderFromElement(file);
    if (documentationProvider instanceof DocumentationProviderEx) {
      element=assertSameProject(((DocumentationProviderEx)documentationProvider).getCustomDocumentationElement(editor,file,contextElement));
    }
  }
  if (element == null) {
    element=assertSameProject(util.findTargetElement(editor,myTargetElementUtilBase.getAllAccepted(),offset));
    if (element != null || contextElement != null) {
      final PsiElement adjusted=assertSameProject(util.adjustElement(editor,myTargetElementUtilBase.getAllAccepted(),element,contextElement));
      if (adjusted != null) {
        element=adjusted;
      }
    }
  }
  if (element == null) {
    final PsiReference ref=TargetElementUtilBase.findReference(editor,offset);
    if (ref != null) {
      element=assertSameProject(util.adjustReference(ref));
      if (ref instanceof PsiPolyVariantReference) {
        element=assertSameProject(ref.getElement());
      }
    }
  }
  storeOriginalElement(myProject,contextElement,element);
  return element;
}
