{
  final String failureMessage=failure.getMessage();
  final String trace=failure.getTrace();
  final Map attrs=new HashMap();
  attrs.put("name",JUnit4ReflectionUtil.getMethodName(failure.getDescription()));
  attrs.put("message",failureMessage != null ? failureMessage : "");
  final ComparisonFailureData notification=createExceptionNotification(failure.getException());
  if (notification != null) {
    attrs.put("expected",notification.getExpected());
    attrs.put("actual",notification.getActual());
    final int failureIdx=trace.indexOf(failureMessage);
    attrs.put("details",failureIdx > -1 ? trace.substring(failureIdx + failureMessage.length()) : trace);
    final String filePath=notification.getFilePath();
    if (filePath != null) {
      attrs.put("expectedFile",filePath);
    }
  }
 else {
    attrs.put("details",trace);
    attrs.put("error","true");
  }
  System.out.println(ServiceMessage.asString(ServiceMessageTypes.TEST_FAILED,attrs));
}
