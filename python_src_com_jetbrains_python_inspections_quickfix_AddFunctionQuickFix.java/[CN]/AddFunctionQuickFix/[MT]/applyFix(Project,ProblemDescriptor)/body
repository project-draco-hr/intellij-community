{
  try {
    final PsiElement problemElement=descriptor.getPsiElement();
    if (!(problemElement instanceof PyQualifiedExpression))     return;
    final PyExpression qualifier=((PyQualifiedExpression)problemElement).getQualifier();
    if (qualifier == null)     return;
    final PyType type=TypeEvalContext.userInitiated(problemElement.getContainingFile()).getType(qualifier);
    if (!(type instanceof PyModuleType))     return;
    final PyFile file=((PyModuleType)type).getModule();
    sure(file);
    sure(FileModificationService.getInstance().preparePsiElementForWrite(file));
    PyFunctionBuilder builder=new PyFunctionBuilder(myIdentifier);
    PsiElement problemParent=problemElement.getParent();
    if (problemParent instanceof PyCallExpression) {
      PyArgumentList arglist=((PyCallExpression)problemParent).getArgumentList();
      if (arglist == null)       return;
      final PyExpression[] args=arglist.getArguments();
      for (      PyExpression arg : args) {
        if (arg instanceof PyKeywordArgument) {
          builder.parameter(((PyKeywordArgument)arg).getKeyword());
        }
 else         if (arg instanceof PyReferenceExpression) {
          PyReferenceExpression refex=(PyReferenceExpression)arg;
          builder.parameter(refex.getReferencedName());
        }
 else {
          builder.parameter("param");
        }
      }
    }
 else     if (problemParent != null) {
      for (      PyInspectionExtension extension : Extensions.getExtensions(PyInspectionExtension.EP_NAME)) {
        List<String> params=extension.getFunctionParametersFromUsage(problemElement);
        if (params != null) {
          for (          String param : params) {
            builder.parameter(param);
          }
          break;
        }
      }
    }
    PyFunction function=builder.buildFunction(project,LanguageLevel.forElement(file));
    function=(PyFunction)file.add(function);
    showTemplateBuilder(function,file);
  }
 catch (  IncorrectOperationException ignored) {
    PyUtil.showBalloon(project,PyBundle.message("QFIX.failed.to.add.function"),MessageType.ERROR);
  }
}
