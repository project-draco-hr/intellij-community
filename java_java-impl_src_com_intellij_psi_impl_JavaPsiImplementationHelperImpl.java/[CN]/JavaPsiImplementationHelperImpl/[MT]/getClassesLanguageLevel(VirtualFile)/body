{
  final ProjectFileIndex index=ProjectRootManager.getInstance(myProject).getFileIndex();
  final VirtualFile sourceRoot=index.getSourceRootForFile(virtualFile);
  final VirtualFile folder=virtualFile.getParent();
  if (sourceRoot != null && sourceRoot.isDirectory() && folder != null) {
    String relativePath=VfsUtilCore.getRelativePath(folder,sourceRoot,'/');
    if (relativePath == null) {
      LOG.error("Null relative path: folder=" + folder + "; root="+ sourceRoot);
      return null;
    }
    String className=virtualFile.getNameWithoutExtension();
    for (    OrderEntry entry : index.getOrderEntriesForFile(virtualFile)) {
      for (      VirtualFile rootFile : entry.getFiles(OrderRootType.CLASSES)) {
        VirtualFile classFile=rootFile.findFileByRelativePath(relativePath);
        PsiJavaFile javaFile=classFile == null ? null : getPsiFileInRoot(classFile,className);
        if (javaFile != null) {
          return javaFile.getLanguageLevel();
        }
      }
    }
    return LanguageLevelProjectExtension.getInstance(myProject).getLanguageLevel();
  }
  return null;
}
