{
  if (virtualFile == null)   return PsiUtil.getLanguageLevel(myProject);
  final LanguageLevel fileLevel=virtualFile.getUserData(LanguageLevel.KEY);
  if (fileLevel != null)   return fileLevel;
  final VirtualFile folder=virtualFile.getParent();
  if (folder != null) {
    final LanguageLevel level=folder.getUserData(LanguageLevel.KEY);
    if (level != null)     return level;
  }
  final ProjectFileIndex index=ProjectRootManager.getInstance(myProject).getFileIndex();
  Module module=index.getModuleForFile(virtualFile);
  if (module != null && index.isInSourceContent(virtualFile)) {
    return EffectiveLanguageLevelUtil.getEffectiveLanguageLevel(module);
  }
  LanguageLevel classesLanguageLevel=getClassesLanguageLevel(virtualFile);
  return classesLanguageLevel != null ? classesLanguageLevel : PsiUtil.getLanguageLevel(myProject);
}
