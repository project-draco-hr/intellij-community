{
  if (selectedSdk == null) {
    myNotificationArea.hide();
    return;
  }
  final Application application=ApplicationManager.getApplication();
  application.executeOnPooledThread(new Runnable(){
    @Override public void run(){
      PyExternalProcessException exc=null;
      try {
        PyPackageManagerImpl packageManager=(PyPackageManagerImpl)PyPackageManager.getInstance(selectedSdk);
        myHasSetuptools=packageManager.findInstalledPackage(PyPackageManagerImpl.PACKAGE_SETUPTOOLS) != null;
        if (!myHasSetuptools) {
          myHasSetuptools=packageManager.findInstalledPackage(PyPackageManagerImpl.PACKAGE_DISTRIBUTE) != null;
        }
        myHasPip=packageManager.findInstalledPackage(PyPackageManagerImpl.PACKAGE_PIP) != null;
      }
 catch (      PyExternalProcessException e) {
        exc=e;
      }
      final PyExternalProcessException externalProcessException=exc;
      application.invokeLater(new Runnable(){
        @Override public void run(){
          if (selectedSdk == getSelectedSdk()) {
            final PythonSdkFlavor flavor=PythonSdkFlavor.getFlavor(selectedSdk);
            final boolean invalid=PythonSdkType.isInvalid(selectedSdk);
            boolean allowCreateVirtualEnv=!(PythonSdkType.isRemote(selectedSdk) || flavor instanceof IronPythonSdkFlavor) && !PythonSdkType.isVirtualEnv(selectedSdk) && myNotificationArea.hasLinkHandler(CREATE_VENV);
            final String createVirtualEnvLink="<a href=\"" + CREATE_VENV + "\">create new VirtualEnv</a>";
            myNotificationArea.hide();
            if (!invalid) {
              String text=null;
              if (externalProcessException != null) {
                final int retCode=externalProcessException.getRetcode();
                if (retCode == PyPackageManagerImpl.ERROR_NO_PIP) {
                  myHasPip=false;
                }
 else                 if (retCode == PyPackageManagerImpl.ERROR_NO_SETUPTOOLS) {
                  myHasSetuptools=false;
                }
 else {
                  text=externalProcessException.getMessage();
                }
                final boolean hasPackagingTools=myHasPip && myHasSetuptools;
                allowCreateVirtualEnv&=!hasPackagingTools;
                if (externalProcessException.hasHandler()) {
                  final String key=externalProcessException.getHandler().first;
                  myNotificationArea.addLinkHandler(key,new Runnable(){
                    @Override public void run(){
                      externalProcessException.getHandler().second.run();
                      myNotificationArea.removeLinkHandler(key);
                      updateNotifications(selectedSdk);
                    }
                  }
);
                }
              }
              if (text == null) {
                if (!myHasSetuptools) {
                  text="Python package management tools not found. <a href=\"" + INSTALL_SETUPTOOLS + "\">Install 'setuptools'</a>";
                }
 else                 if (!myHasPip) {
                  text="Python packaging tool 'pip' not found. <a href=\"" + INSTALL_PIP + "\">Install 'pip'</a>";
                }
              }
              if (text != null) {
                if (allowCreateVirtualEnv) {
                  text+=" or " + createVirtualEnvLink;
                }
                myNotificationArea.showWarning(text);
              }
            }
            myInstallButton.setEnabled(!invalid && externalProcessException == null && myHasPip);
          }
        }
      }
,ModalityState.any());
    }
  }
);
}
