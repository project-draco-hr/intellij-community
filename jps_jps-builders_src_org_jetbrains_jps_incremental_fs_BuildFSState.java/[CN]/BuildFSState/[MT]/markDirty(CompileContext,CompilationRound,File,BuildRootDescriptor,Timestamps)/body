{
  final FilesDelta roundDelta=getRoundDelta(round == CompilationRound.NEXT ? NEXT_ROUND_DELTA_KEY : CURRENT_ROUND_DELTA_KEY,context);
  if (roundDelta != null && isInCurrentContextTargets(context,rd)) {
    roundDelta.markRecompile(rd,file);
  }
  final FilesDelta filesDelta=getDelta(rd.getTarget());
  filesDelta.lockData();
  try {
    final boolean marked=filesDelta.markRecompile(rd,file);
    if (marked) {
      if (LOG.isDebugEnabled()) {
        LOG.debug(rd.getTarget() + ": MARKED DIRTY: " + file.getPath());
      }
      if (tsStorage != null) {
        tsStorage.removeStamp(file,rd.getTarget());
      }
    }
 else {
      if (LOG.isDebugEnabled()) {
        LOG.debug(rd.getTarget() + ": NOT MARKED DIRTY: " + file.getPath());
      }
    }
    return marked;
  }
  finally {
    filesDelta.unlockData();
  }
}
