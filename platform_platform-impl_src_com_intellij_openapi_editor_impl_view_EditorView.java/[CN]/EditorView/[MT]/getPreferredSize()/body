{
  int width=getPreferredWidth();
  if (!myDocument.isInBulkUpdate()) {
    for (    Caret caret : myEditor.getCaretModel().getAllCarets()) {
      if (caret.isUpToDate()) {
        int caretX=visualPositionToXY(caret.getVisualPosition()).x;
        width=Math.max(caretX,width);
      }
    }
  }
  width+=myEditor.getSettings().getAdditionalColumnsCount() * myPlainSpaceWidth;
  return new Dimension(width,myEditor.getPreferredHeight());
}
