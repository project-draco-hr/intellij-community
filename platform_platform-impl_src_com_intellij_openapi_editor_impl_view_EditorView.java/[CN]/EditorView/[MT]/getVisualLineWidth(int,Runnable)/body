{
  FoldRegion[] topLevelRegions=myEditor.getFoldingModel().fetchTopLevel();
  if (quickEvaluationListener != null && (topLevelRegions == null || topLevelRegions.length == 0) && myEditor.getSoftWrapModel().getRegisteredSoftWraps().isEmpty() && !myTextLayoutCache.hasCachedLayoutFor(visualLine)) {
    quickEvaluationListener.run();
    return myMapper.offsetToLogicalPosition(myDocument.getLineEndOffset(visualLine)).column * getMaxCharWidth();
  }
  int startOffset=myMapper.visualLineToOffset(visualLine);
  float x=0;
  int maxOffset=0;
  for (  VisualLineFragmentsIterator.Fragment fragment : VisualLineFragmentsIterator.create(this,startOffset,false,quickEvaluationListener)) {
    x=fragment.getEndX();
    maxOffset=Math.max(maxOffset,fragment.getMaxOffset());
  }
  if (myEditor.getSoftWrapModel().getSoftWrap(maxOffset) != null) {
    x+=myEditor.getSoftWrapModel().getMinDrawingWidthInPixels(SoftWrapDrawingType.BEFORE_SOFT_WRAP_LINE_FEED);
  }
  return (int)x;
}
