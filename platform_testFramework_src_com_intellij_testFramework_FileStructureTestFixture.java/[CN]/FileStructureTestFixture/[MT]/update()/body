{
  final Ref<FilteringTreeStructure.FilteringNode> nodeRef=new Ref<FilteringTreeStructure.FilteringNode>();
  myPopup.getTreeBuilder().refilter().doWhenProcessed(new Runnable(){
    @Override public void run(){
      getStructure().rebuild();
      updateTree();
      getBuilder().updateFromRoot();
      TreeUtil.expandAll(getTree());
      nodeRef.set(myPopup.selectPsiElement(myPopup.getCurrentElement(myFile)));
      getBuilder().getUi().select(nodeRef.get(),null);
    }
  }
);
  return nodeRef.get();
}
