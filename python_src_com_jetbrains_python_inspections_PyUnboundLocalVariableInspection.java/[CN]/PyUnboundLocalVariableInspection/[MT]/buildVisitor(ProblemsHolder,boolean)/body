{
  return new PyInspectionVisitor(holder){
    @Override public void visitPyReferenceExpression(    final PyReferenceExpression node){
      if (node.getContainingFile() instanceof PyExpressionCodeFragment || PydevConsoleRunner.isInPydevConsole(node)) {
        return;
      }
      if (PyGlobalStatementNavigator.getByArgument(node) != null) {
        return;
      }
      final PyExpression qualifier=node.getQualifier();
      if (qualifier != null) {
        qualifier.accept(this);
        return;
      }
      if (PsiTreeUtil.getParentOfType(node,PyImportStatementBase.class) != null) {
        return;
      }
      final String name=node.getReferencedName();
      if (name == null) {
        return;
      }
      final ScopeOwner owner=ScopeUtil.getDeclarationScopeOwner(node,name);
      if (owner == null) {
        return;
      }
      if (owner != PsiTreeUtil.getParentOfType(node,ScopeOwner.class)) {
        return;
      }
      final Scope scope=ControlFlowCache.getScope(owner);
      if (scope.isGlobal(name) || (!scope.containsDeclaration(name))) {
        return;
      }
      final ScopeVariable variable=scope.getDeclaredVariable(node,name);
      if (variable == null) {
        boolean resolves2LocalVariable=false;
        boolean resolve2Scope=true;
        for (        ResolveResult result : node.getReference().multiResolve(true)) {
          final PsiElement element=result.getElement();
          if (element == null) {
            continue;
          }
          final PsiFile containingFile=element.getContainingFile();
          if (containingFile != null) {
            final String fileName=containingFile.getName();
            if (PyBuiltinCache.BUILTIN_FILE.equals(fileName) || PyBuiltinCache.BUILTIN_FILE_3K.equals(fileName)) {
              continue;
            }
          }
          if (PyAssignmentStatementNavigator.getStatementByTarget(element) != null || PyForStatementNavigator.getPyForStatementByIterable(element) != null || PyExceptPartNavigator.getPyExceptPartByTarget(element) != null || PyListCompExpressionNavigator.getPyListCompExpressionByVariable(element) != null || PyImportStatementNavigator.getImportStatementByElement(element) != null) {
            resolves2LocalVariable=true;
            resolve2Scope=PsiTreeUtil.isAncestor(owner,element,false);
            break;
          }
        }
        if (!resolves2LocalVariable) {
          if (PyControlFlowBuilder.isSelf(node)) {
            return;
          }
          if (owner instanceof PyClass) {
            if (ScopeUtil.getDeclarationScopeOwner(owner,name) != null) {
              return;
            }
          }
          if (owner instanceof PyFile) {
            registerProblem(node,PyBundle.message("INSP.unbound.name.not.defined",name));
          }
 else {
            registerUnboundLocal(node);
          }
          return;
        }
        final Ref<Boolean> readAccessSeen=new Ref<Boolean>(false);
        final Instruction[] instructions=ControlFlowCache.getControlFlow(owner).getInstructions();
        final int number=ControlFlowUtil.findInstructionNumberByElement(instructions,node);
        if (number != -1) {
          ControlFlowUtil.iteratePrev(number,instructions,new Function<Instruction,ControlFlowUtil.Operation>(){
            public ControlFlowUtil.Operation fun(            final Instruction inst){
              if (inst.num() == number) {
                return ControlFlowUtil.Operation.NEXT;
              }
              if (inst instanceof ReadWriteInstruction) {
                final ReadWriteInstruction rwInst=(ReadWriteInstruction)inst;
                if (name.equals(rwInst.getName())) {
                  final PsiElement e=inst.getElement();
                  if (e != null && scope.getDeclaredVariable(e,name) != null) {
                    return ControlFlowUtil.Operation.BREAK;
                  }
                  if (rwInst.getAccess().isWriteAccess()) {
                    return ControlFlowUtil.Operation.CONTINUE;
                  }
 else {
                    readAccessSeen.set(true);
                    return ControlFlowUtil.Operation.BREAK;
                  }
                }
              }
              return ControlFlowUtil.Operation.NEXT;
            }
          }
);
        }
        if (readAccessSeen.get()) {
          return;
        }
        if (resolve2Scope) {
          if (owner instanceof PyFile) {
            registerProblem(node,PyBundle.message("INSP.unbound.name.not.defined",name));
          }
 else {
            registerUnboundLocal(node);
          }
        }
 else         if (owner instanceof PyFunction && PsiTreeUtil.getParentOfType(owner,PyClass.class,PyFile.class) instanceof PyFile) {
          registerUnboundLocal(node);
        }
      }
    }
    @Override public void visitPyNonlocalStatement(    final PyNonlocalStatement node){
      for (      PyTargetExpression var : node.getVariables()) {
        final String name=var.getName();
        final ScopeOwner owner=ScopeUtil.getDeclarationScopeOwner(var,name);
        if (owner == null || owner instanceof PyFile) {
          registerProblem(var,PyBundle.message("INSP.unbound.nonlocal.variable",name),ProblemHighlightType.GENERIC_ERROR_OR_WARNING,null);
        }
      }
    }
    private void registerUnboundLocal(    PyReferenceExpression node){
      registerProblem(node,PyBundle.message("INSP.unbound.local.variable",node.getName()),ProblemHighlightType.GENERIC_ERROR_OR_WARNING,null,new AddGlobalQuickFix());
    }
  }
;
}
