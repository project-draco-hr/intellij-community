{
  return new PyInspectionVisitor(holder){
    @Override public void visitPyReferenceExpression(    final PyReferenceExpression node){
      if (node.getContainingFile() instanceof PyExpressionCodeFragment || PydevConsoleRunner.isInPydevConsole(node)) {
        return;
      }
      if (PyCallExpressionNavigator.getPyCallExpressionByCallee(node) != null) {
        return;
      }
      if (PyGlobalStatementNavigator.getByArgument(node) != null) {
        return;
      }
      final PyExpression qualifier=node.getQualifier();
      if (qualifier != null) {
        qualifier.accept(this);
        return;
      }
      if (PyImportStatementNavigator.getImportStatementByElement(node) != null) {
        return;
      }
      final ScopeOwner owner=PsiTreeUtil.getParentOfType(node,ScopeOwner.class);
      if (owner == null) {
        return;
      }
      final String name=node.getReferencedName();
      final Scope scope=owner.getScope();
      if (scope.isGlobal(name) || (!scope.containsDeclaration(name))) {
        return;
      }
      final ScopeVariable variable=scope.getDeclaredVariable(node,name);
      if (variable == null) {
        boolean resolves2LocalVariable=false;
        boolean resolve2Scope=true;
        for (        ResolveResult result : node.getReference().multiResolve(true)) {
          final PsiElement element=result.getElement();
          if (element == null) {
            continue;
          }
          final PsiFile containingFile=element.getContainingFile();
          if (containingFile != null) {
            final String fileName=containingFile.getName();
            if (PyBuiltinCache.BUILTIN_FILE.equals(fileName) || PyBuiltinCache.BUILTIN_FILE_3K.equals(fileName)) {
              continue;
            }
          }
          if (PyAssignmentStatementNavigator.getStatementByTarget(element) != null || PyForStatementNavigator.getPyForStatementByIterable(element) != null || PyExceptPartNavigator.getPyExceptPartByTarget(element) != null) {
            resolves2LocalVariable=true;
            resolve2Scope=PsiTreeUtil.isAncestor(owner,element,false);
            break;
          }
        }
        if (!resolves2LocalVariable) {
          return;
        }
        final Ref<Boolean> readAccessSeen=new Ref<Boolean>(false);
        final Instruction[] instructions=owner.getControlFlow().getInstructions();
        final int number=ControlFlowUtil.findInstructionNumberByElement(instructions,node);
        PyControlFlowUtil.iteratePrev(number,instructions,new Function<Instruction,PyControlFlowUtil.Operation>(){
          public PyControlFlowUtil.Operation fun(          final Instruction inst){
            if (inst.num() == number) {
              return PyControlFlowUtil.Operation.NEXT;
            }
            if (inst instanceof ReadWriteInstruction) {
              final ReadWriteInstruction rwInst=(ReadWriteInstruction)inst;
              if (name.equals(rwInst.getName())) {
                if (scope.getDeclaredVariable(inst.getElement(),name) != null) {
                  return PyControlFlowUtil.Operation.BREAK;
                }
                if (rwInst.getAccess().isWriteAccess()) {
                  return PyControlFlowUtil.Operation.CONTINUE;
                }
 else {
                  readAccessSeen.set(true);
                  return PyControlFlowUtil.Operation.BREAK;
                }
              }
            }
            return PyControlFlowUtil.Operation.NEXT;
          }
        }
);
        if (readAccessSeen.get()) {
          return;
        }
        if (owner instanceof PyClass || owner instanceof PyFunction) {
          registerProblem(node,PyBundle.message("INSP.unbound.local.variable",node.getName()),ProblemHighlightType.GENERIC_ERROR_OR_WARNING,null,new AddGlobalQuickFix());
        }
 else {
          if (resolve2Scope) {
            registerProblem(node,PyBundle.message("INSP.unbound.name.not.defined",node.getName()));
          }
        }
      }
    }
  }
;
}
