{
  Project project=e.getData(CommonDataKeys.PROJECT);
  final VcsLogUi ui=e.getData(VcsLogDataKeys.VCS_LOG_UI);
  final VcsLogDataProvider dataProvider=e.getData(VcsLogDataKeys.VCS_LOG_DATA_PROVIDER);
  if (project == null || ui == null || dataProvider == null) {
    return;
  }
  final DeepComparator dc=DeepComparator.getInstance(project,ui);
  if (selected) {
    VcsLogBranchFilter branchFilter=ui.getFilterUi().getFilters().getBranchFilter();
    if (branchFilter == null || branchFilter.getBranchNames().size() != 1) {
      selectBranchAndPerformAction(ui.getDataPack(),e,new Consumer<String>(){
        @Override public void consume(        String selectedBranch){
          ui.getFilterUi().setFilter(new VcsLogBranchFilterImpl(Collections.singleton(selectedBranch)));
          dc.highlightInBackground(selectedBranch,dataProvider);
        }
      }
,getAllVisibleRoots(ui));
      return;
    }
    String branchToCompare=branchFilter.getBranchNames().iterator().next();
    dc.highlightInBackground(branchToCompare,dataProvider);
  }
 else {
    dc.stopAndUnhighlight();
  }
}
