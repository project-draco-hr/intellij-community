{
  Project project=e.getData(CommonDataKeys.PROJECT);
  final VcsLogUi ui=e.getData(VcsLogDataKeys.VCS_LOG_UI);
  final VcsLogDataProvider dataProvider=e.getData(VcsLogDataKeys.VCS_LOG_DATA_PROVIDER);
  if (project == null || ui == null || dataProvider == null) {
    return;
  }
  final DeepComparator dc=DeepComparator.getInstance(project,ui);
  if (selected) {
    VcsLogBranchFilter branchFilter=ui.getFilterUi().getFilters().getBranchFilter();
    String singleBranchName=branchFilter != null ? VcsLogUtil.getSingleFilteredBranch(branchFilter,ui.getDataPack().getRefs()) : null;
    if (singleBranchName == null) {
      selectBranchAndPerformAction(ui.getDataPack(),e,new Consumer<String>(){
        @Override public void consume(        String selectedBranch){
          ui.getFilterUi().setFilter(VcsLogBranchFilterImpl.fromBranch(selectedBranch));
          dc.highlightInBackground(selectedBranch,dataProvider);
        }
      }
,getAllVisibleRoots(ui));
      return;
    }
    dc.highlightInBackground(singleBranchName,dataProvider);
  }
 else {
    dc.stopAndUnhighlight();
  }
}
