{
  PsiFile hostFile=PsiDocumentManager.getInstance(project).getPsiFile(hostEditor.getDocument());
  hostEditor.getCaretModel().runForEachCaret(new CaretAction(){
    @Override public void perform(    Caret caret){
      Editor editor=hostEditor;
      if (hostFile != null) {
        Caret injectedCaret=InjectedLanguageUtil.getCaretForInjectedLanguageNoCommit(caret,hostFile);
        if (injectedCaret != null) {
          caret=injectedCaret;
          editor=caret.getEditor();
        }
      }
      final PsiFile file=PsiUtilBase.getPsiFileInEditor(caret,project);
      if (file != null) {
        handler.invoke(project,editor,caret,file);
      }
    }
  }
);
}
