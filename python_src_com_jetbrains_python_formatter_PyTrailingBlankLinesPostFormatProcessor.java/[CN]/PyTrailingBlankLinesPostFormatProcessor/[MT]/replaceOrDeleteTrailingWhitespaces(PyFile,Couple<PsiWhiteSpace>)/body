{
  final Project project=pyFile.getProject();
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  final Document document=documentManager.getDocument(pyFile);
  if (document != null) {
    final CodeStyleManager codeStyleManager=CodeStyleManager.getInstance(project);
    int numLineFeedsAtEnd=CodeStyleSettingsManager.getSettings(project).getCustomSettings(PyCodeStyleSettings.class).NEW_LINE_AT_FILE_END;
    if (numLineFeedsAtEnd <= 0 && EditorSettingsExternalizable.getInstance().isEnsureNewLineAtEOF()) {
      numLineFeedsAtEnd=1;
    }
    if (numLineFeedsAtEnd > 0) {
      documentManager.doPostponedOperationsAndUnblockDocument(document);
      final PyElementGenerator generator=PyElementGenerator.getInstance(project);
      final String text=StringUtil.repeat("\n",numLineFeedsAtEnd);
      final LanguageLevel language=LanguageLevel.forElement(pyFile);
      final PsiWhiteSpace lineFeeds=generator.createFromText(language,PsiWhiteSpace.class,"(" + text + ")",new int[]{0,0,1});
      return codeStyleManager.performActionWithFormatterDisabled(new Computable<TextRange>(){
        @Override public TextRange compute(){
          if (whitespaces != null) {
            return replaceOrDeletePsiRange(whitespaces,lineFeeds).getTextRange();
          }
 else {
            return pyFile.add(lineFeeds).getTextRange();
          }
        }
      }
);
    }
 else     if (whitespaces != null) {
      return codeStyleManager.performActionWithFormatterDisabled(new Computable<TextRange>(){
        @Override public TextRange compute(){
          replaceOrDeletePsiRange(whitespaces,null);
          return TextRange.from(pyFile.getTextLength(),0);
        }
      }
);
    }
  }
  return whitespaces == null ? TextRange.from(pyFile.getTextLength(),0) : unionRange(whitespaces);
}
