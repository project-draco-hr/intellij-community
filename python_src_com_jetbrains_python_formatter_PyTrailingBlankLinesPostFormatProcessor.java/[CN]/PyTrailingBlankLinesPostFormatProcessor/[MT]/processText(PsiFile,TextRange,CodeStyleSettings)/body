{
  if (!(source instanceof PyFile)) {
    return rangeToReformat;
  }
  final PsiWhiteSpace lastWhitespace=as(source.getLastChild(),PsiWhiteSpace.class);
  if (lastWhitespace != null && rangeToReformat.intersects(lastWhitespace.getTextRange())) {
    final TextRange oldWhitespaceRange=lastWhitespace.getTextRange();
    final TextRange newWhitespaceRange=replaceTrailingWhitespaceBySingleLineFeed(lastWhitespace).getTextRange();
    final int delta=newWhitespaceRange.getLength() - oldWhitespaceRange.getLength();
    if (newWhitespaceRange.contains(oldWhitespaceRange)) {
      return newWhitespaceRange;
    }
 else     if (rangeToReformat.contains(oldWhitespaceRange)) {
      return rangeToReformat.grown(delta);
    }
 else     if (oldWhitespaceRange.getEndOffset() > rangeToReformat.getEndOffset()) {
      return new TextRange(rangeToReformat.getStartOffset(),Math.min(rangeToReformat.getEndOffset(),newWhitespaceRange.getEndOffset()));
    }
 else     if (oldWhitespaceRange.getStartOffset() < rangeToReformat.getStartOffset()) {
      final int unionLength=rangeToReformat.getEndOffset() - oldWhitespaceRange.getStartOffset();
      return TextRange.from(Math.max(oldWhitespaceRange.getStartOffset(),rangeToReformat.getStartOffset() + delta),Math.min(rangeToReformat.getLength(),unionLength + delta));
    }
  }
  return rangeToReformat;
}
