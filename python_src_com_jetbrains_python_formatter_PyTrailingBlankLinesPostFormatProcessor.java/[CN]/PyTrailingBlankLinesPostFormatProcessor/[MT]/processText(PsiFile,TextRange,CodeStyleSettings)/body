{
  if (!(source instanceof PyFile)) {
    return rangeToReformat;
  }
  final PsiWhiteSpace lastWhitespace=findLastWhitespace(source);
  final TextRange oldWhitespaceRange=lastWhitespace != null ? lastWhitespace.getTextRange() : TextRange.from(source.getTextLength(),0);
  if (lastWhitespace != null && rangeToReformat.intersects(oldWhitespaceRange)) {
    final PsiWhiteSpace newWhitespace=replaceOrDeleteTrailingWhitespace((PyFile)source,lastWhitespace);
    final TextRange newWhitespaceRange;
    if (newWhitespace != null) {
      newWhitespaceRange=newWhitespace.getTextRange();
    }
 else {
      newWhitespaceRange=TextRange.from(oldWhitespaceRange.getStartOffset(),0);
    }
    final int delta=newWhitespaceRange.getLength() - oldWhitespaceRange.getLength();
    if (newWhitespaceRange.contains(oldWhitespaceRange)) {
      return newWhitespaceRange;
    }
 else     if (rangeToReformat.contains(oldWhitespaceRange)) {
      return rangeToReformat.grown(delta);
    }
 else     if (oldWhitespaceRange.getEndOffset() > rangeToReformat.getEndOffset()) {
      return new TextRange(rangeToReformat.getStartOffset(),Math.min(rangeToReformat.getEndOffset(),newWhitespaceRange.getEndOffset()));
    }
 else     if (oldWhitespaceRange.getStartOffset() < rangeToReformat.getStartOffset()) {
      final int unionLength=rangeToReformat.getEndOffset() - oldWhitespaceRange.getStartOffset();
      return TextRange.from(Math.max(oldWhitespaceRange.getStartOffset(),rangeToReformat.getStartOffset() + delta),Math.min(rangeToReformat.getLength(),unionLength + delta));
    }
  }
  return rangeToReformat;
}
