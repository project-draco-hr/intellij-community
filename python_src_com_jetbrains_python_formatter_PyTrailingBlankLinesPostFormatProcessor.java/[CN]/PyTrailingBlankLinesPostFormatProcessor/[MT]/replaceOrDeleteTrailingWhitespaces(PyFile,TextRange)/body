{
  final Project project=pyFile.getProject();
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  final Document document=documentManager.getDocument(pyFile);
  if (document != null) {
    int numLineFeedsAtEnd=CodeStyleSettingsManager.getSettings(project).getCustomSettings(PyCodeStyleSettings.class).NEW_LINE_AT_FILE_END;
    if (numLineFeedsAtEnd <= 0 && EditorSettingsExternalizable.getInstance().isEnsureNewLineAtEOF()) {
      numLineFeedsAtEnd=1;
    }
    documentManager.doPostponedOperationsAndUnblockDocument(document);
    final String text=StringUtil.repeat("\n",numLineFeedsAtEnd);
    if (numLineFeedsAtEnd > 0) {
      if (!whitespaceRange.isEmpty()) {
        document.replaceString(whitespaceRange.getStartOffset(),whitespaceRange.getEndOffset(),text);
      }
 else {
        document.insertString(document.getTextLength(),text);
      }
    }
 else     if (!whitespaceRange.isEmpty()) {
      document.deleteString(whitespaceRange.getStartOffset(),whitespaceRange.getEndOffset());
    }
    return TextRange.from(whitespaceRange.getStartOffset(),text.length());
  }
  return whitespaceRange;
}
