{
  final Project project=pyFile.getProject();
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  final Document document=documentManager.getDocument(pyFile);
  if (document != null) {
    int numLineFeeds=CodeStyleSettingsManager.getSettings(project).getCustomSettings(PyCodeStyleSettings.class).BLANKS_LINES_AT_FILE_END;
    if (numLineFeeds <= 0 && EditorSettingsExternalizable.getInstance().isEnsureNewLineAtEOF()) {
      numLineFeeds=1;
    }
    documentManager.doPostponedOperationsAndUnblockDocument(document);
    try {
      final String text=StringUtil.repeat("\n",numLineFeeds);
      if (numLineFeeds > 0 && whitespaceRange.getStartOffset() != 0) {
        if (!whitespaceRange.isEmpty()) {
          document.replaceString(whitespaceRange.getStartOffset(),whitespaceRange.getEndOffset(),text);
        }
 else {
          document.insertString(document.getTextLength(),text);
        }
      }
 else       if (!whitespaceRange.isEmpty()) {
        document.deleteString(whitespaceRange.getStartOffset(),whitespaceRange.getEndOffset());
      }
      return TextRange.from(whitespaceRange.getStartOffset(),text.length());
    }
  finally {
      documentManager.commitDocument(document);
    }
  }
  return whitespaceRange;
}
