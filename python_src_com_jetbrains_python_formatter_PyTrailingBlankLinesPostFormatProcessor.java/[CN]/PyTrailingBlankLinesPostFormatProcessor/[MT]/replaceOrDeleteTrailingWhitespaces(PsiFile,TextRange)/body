{
  final Project project=pyFile.getProject();
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  final Document document=documentManager.getDocument(pyFile);
  if (document != null) {
    final PyCodeStyleSettings customSettings=CodeStyleSettingsManager.getSettings(project).getCustomSettings(PyCodeStyleSettings.class);
    final boolean addLineFeed=customSettings.BLANK_LINE_AT_FILE_END || EditorSettingsExternalizable.getInstance().isEnsureNewLineAtEOF();
    documentManager.doPostponedOperationsAndUnblockDocument(document);
    try {
      final String text=addLineFeed ? "\n" : "";
      if (!text.isEmpty() && whitespaceRange.getStartOffset() != 0) {
        if (!whitespaceRange.isEmpty()) {
          document.replaceString(whitespaceRange.getStartOffset(),whitespaceRange.getEndOffset(),text);
        }
 else {
          document.insertString(document.getTextLength(),text);
        }
      }
 else       if (!whitespaceRange.isEmpty()) {
        document.deleteString(whitespaceRange.getStartOffset(),whitespaceRange.getEndOffset());
      }
      return TextRange.from(whitespaceRange.getStartOffset(),text.length());
    }
  finally {
      documentManager.commitDocument(document);
    }
  }
  return whitespaceRange;
}
