{
  final Project project=event.getData(CommonDataKeys.PROJECT);
  if (project == null) {
    return null;
  }
  PsiElement method=null;
  Document document=null;
  if (ActionPlaces.PROJECT_VIEW_POPUP.equals(event.getPlace()) || ActionPlaces.STRUCTURE_VIEW_POPUP.equals(event.getPlace()) || ActionPlaces.FAVORITES_VIEW_POPUP.equals(event.getPlace())|| ActionPlaces.NAVIGATION_BAR.equals(event.getPlace())) {
    final PsiElement psiElement=event.getData(CommonDataKeys.PSI_ELEMENT);
    if (psiElement instanceof PsiMethod) {
      final PsiFile containingFile=psiElement.getContainingFile();
      if (containingFile != null) {
        method=psiElement;
        document=PsiDocumentManager.getInstance(project).getDocument(containingFile);
      }
    }
  }
 else {
    Editor editor=event.getData(CommonDataKeys.EDITOR);
    if (editor == null) {
      editor=FileEditorManager.getInstance(project).getSelectedTextEditor();
    }
    if (editor != null) {
      document=editor.getDocument();
      PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
      if (file != null) {
        final VirtualFile virtualFile=file.getVirtualFile();
        FileType fileType=virtualFile != null ? virtualFile.getFileType() : null;
        if (StdFileTypes.JAVA == fileType || StdFileTypes.CLASS == fileType) {
          method=findMethod(project,editor);
        }
      }
    }
  }
  return method != null ? new PlaceInDocument(document,method.getTextOffset()) : null;
}
