{
  if (psiFile == null)   return null;
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  Object elementAtCursor=myTreeModel.getCurrentEditorElement();
  if (elementAtCursor instanceof PsiElement) {
    return (PsiElement)elementAtCursor;
  }
  if (myEditor != null) {
    return psiFile.getViewProvider().findElementAt(myEditor.getCaretModel().getOffset());
  }
  return null;
}
