{
  myProject=project;
  myFileEditor=fileEditor;
  myStructureViewDelegate=structureView;
  DaemonCodeAnalyzer.getInstance(myProject).disableUpdateByTimer(this);
  IdeFocusManager.getInstance(myProject).typeAheadUntil(myTreeHasBuilt);
  Disposer.register(this,myStructureViewDelegate);
  if (myFileEditor instanceof TextEditor) {
    Editor e=((TextEditor)myFileEditor).getEditor();
    myPsiFile=PsiDocumentManager.getInstance(myProject).getPsiFile(e.getDocument());
  }
  if (myStructureViewDelegate instanceof StructureViewComposite) {
    StructureViewComposite.StructureViewDescriptor[] views=((StructureViewComposite)myStructureViewDelegate).getStructureViews();
    myBaseTreeModel=new StructureViewCompositeModel(myPsiFile,views);
    Disposer.register(this,(Disposable)myBaseTreeModel);
  }
 else {
    myBaseTreeModel=myStructureViewDelegate.getTreeModel();
  }
  if (applySortAndFilter) {
    myTreeActionsOwner=new TreeStructureActionsOwner(myBaseTreeModel);
    myTreeModel=new TreeModelWrapper(myBaseTreeModel,myTreeActionsOwner);
  }
 else {
    myTreeActionsOwner=null;
    myTreeModel=myStructureViewDelegate.getTreeModel();
  }
  myTreeStructure=new SmartTreeStructure(project,myTreeModel){
    @Override public void rebuildTree(){
      if (ApplicationManager.getApplication().isUnitTestMode() || !myPopup.isDisposed()) {
        super.rebuildTree();
      }
    }
    @Override public boolean isToBuildChildrenInBackground(    final Object element){
      return getRootElement() == element;
    }
    @Override protected TreeElementWrapper createTree(){
      return new StructureViewComponent.StructureViewTreeElementWrapper(myProject,myModel.getRoot(),myModel);
    }
    @NonNls @Override public String toString(){
      return "structure view tree structure(model=" + myTreeModel + ")";
    }
  }
;
  myTree=new FileStructureTree(myTreeStructure.getRootElement(),false);
  myTree.setCellRenderer(new NodeRenderer());
  myTree.setTransferHandler(new TransferHandler(){
    @Override public boolean importData(    @NotNull TransferSupport support){
      String s=CopyPasteManager.getInstance().getContents(DataFlavor.stringFlavor);
      if (s != null && !mySpeedSearch.isPopupActive()) {
        mySpeedSearch.showPopup(s);
        return true;
      }
      return false;
    }
    @Nullable @Override protected Transferable createTransferable(    JComponent component){
      Set<Object> nodes=myAbstractTreeBuilder.getSelectedElements();
      if (nodes.isEmpty())       return null;
      List<Pair<FilteringTreeStructure.FilteringNode,PsiElement>> result=ContainerUtil.newArrayListWithCapacity(nodes.size());
      for (      Object o : nodes) {
        if (!(o instanceof FilteringTreeStructure.FilteringNode))         continue;
        FilteringTreeStructure.FilteringNode node=(FilteringTreeStructure.FilteringNode)o;
        PsiElement psi=getPsi(node);
        ContainerUtil.addIfNotNull(result,Pair.create(node,psi));
      }
      final Set<PsiElement> psiSelection=ContainerUtil.map2LinkedSet(result,Functions.<PsiElement>pairSecond());
      String text=StringUtil.join(result,new Function<Pair<FilteringTreeStructure.FilteringNode,PsiElement>,String>(){
        @Override public String fun(        Pair<FilteringTreeStructure.FilteringNode,PsiElement> pair){
          PsiElement psi=pair.second;
          String defaultPresentation=pair.first.getPresentation().getPresentableText();
          if (psi == null)           return defaultPresentation;
          for (PsiElement p=psi.getParent(); p != null; p=p.getParent()) {
            if (psiSelection.contains(p))             return null;
          }
          return ObjectUtils.chooseNotNull(psi.getText(),defaultPresentation);
        }
      }
,"\n");
      String htmlText="<body>\n" + text + "\n</body>";
      return new TextTransferable(XmlStringUtil.wrapInHtml(htmlText),text);
    }
    @Override public int getSourceActions(    JComponent component){
      return COPY;
    }
  }
);
  mySpeedSearch=new MyTreeSpeedSearch();
  mySpeedSearch.setComparator(new SpeedSearchComparator(false,true){
    @NotNull @Override protected MinusculeMatcher createMatcher(    @NotNull String pattern){
      return new MinusculeMatcher(pattern,NameUtil.MatchingCaseSensitivity.NONE," ()");
    }
  }
);
  final FileStructurePopupFilter filter=new FileStructurePopupFilter();
  myFilteringStructure=new FilteringTreeStructure(filter,myTreeStructure,ApplicationManager.getApplication().isUnitTestMode());
  myAbstractTreeBuilder=new FilteringTreeBuilder(myTree,filter,myFilteringStructure,null){
    @Override public void initRootNode(){
    }
    @Override protected boolean validateNode(    Object child){
      return StructureViewComponent.isValid(child);
    }
    @Override public void revalidateTree(){
    }
    @Override public boolean isToEnsureSelectionOnFocusGained(){
      return false;
    }
  }
;
  myTreeExpander=new DefaultTreeExpander(myTree);
  final ModelListener modelListener=new ModelListener(){
    @Override public void onModelChanged(){
      myAbstractTreeBuilder.queueUpdate();
    }
  }
;
  myTreeModel.addModelListener(modelListener);
  Disposer.register(this,new Disposable(){
    @Override public void dispose(){
      myTreeModel.removeModelListener(modelListener);
    }
  }
);
  myAbstractTreeBuilder.getUi().getUpdater().setDelay(1);
  myInitialPsiElement=getCurrentElement(myPsiFile);
  Disposer.register(this,myAbstractTreeBuilder);
  TreeUtil.installActions(myTree);
}
