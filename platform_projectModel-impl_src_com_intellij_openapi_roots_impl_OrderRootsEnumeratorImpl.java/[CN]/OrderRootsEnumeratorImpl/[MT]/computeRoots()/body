{
  final Collection<VirtualFile> result=new LinkedHashSet<VirtualFile>();
  myOrderEnumerator.forEach(new PairProcessor<OrderEntry,List<OrderEnumerationHandler>>(){
    @Override public boolean process(    OrderEntry orderEntry,    List<OrderEnumerationHandler> customHandlers){
      OrderRootType type=getRootType(orderEntry);
      if (orderEntry instanceof ModuleSourceOrderEntry) {
        collectModuleRoots(type,((ModuleSourceOrderEntry)orderEntry).getRootModel(),result,true,!myOrderEnumerator.isProductionOnly(),customHandlers);
      }
 else       if (orderEntry instanceof ModuleOrderEntry) {
        ModuleOrderEntry moduleOrderEntry=(ModuleOrderEntry)orderEntry;
        final Module module=moduleOrderEntry.getModule();
        if (module != null) {
          ModuleRootModel rootModel=myOrderEnumerator.getRootModel(module);
          boolean productionOnTests=orderEntry instanceof ModuleOrderEntryImpl && ((ModuleOrderEntryImpl)orderEntry).isProductionOnTestDependency();
          boolean includeTests=!myOrderEnumerator.isProductionOnly() && myOrderEnumerator.shouldIncludeTestsFromDependentModulesToTestClasspath(customHandlers) || productionOnTests;
          collectModuleRoots(type,rootModel,result,!productionOnTests,includeTests,customHandlers);
        }
      }
 else {
        if (myCustomRootProvider != null) {
          Collections.addAll(result,myCustomRootProvider.fun(orderEntry));
          return true;
        }
        if (myOrderEnumerator.addCustomRootsForLibrary(orderEntry,type,result,customHandlers)) {
          return true;
        }
        Collections.addAll(result,orderEntry.getFiles(type));
      }
      return true;
    }
  }
);
  return result;
}
