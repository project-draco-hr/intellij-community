{
  super(settings);
  File mavenHome=settings.getMavenHome();
  if (mavenHome != null) {
    System.setProperty("maven.home",mavenHome.getPath());
  }
  myConsoleWrapper=new Maven3ServerConsoleLogger();
  myConsoleWrapper.setThreshold(settings.getLoggingLevel());
  ClassWorld classWorld=new ClassWorld("plexus.core",Thread.currentThread().getContextClassLoader());
  MavenCli cli=new MavenCli(classWorld){
    @Override protected void customizeContainer(    PlexusContainer container){
      ((DefaultPlexusContainer)container).setLoggerManager(new BaseLoggerManager(){
        @Override protected Logger createLogger(        String s){
          return myConsoleWrapper;
        }
      }
);
    }
  }
;
  SettingsBuilder settingsBuilder=null;
  Class cliRequestClass;
  try {
    cliRequestClass=MavenCli.class.getClassLoader().loadClass("org.apache.maven.cli.MavenCli$CliRequest");
  }
 catch (  ClassNotFoundException e) {
    try {
      cliRequestClass=MavenCli.class.getClassLoader().loadClass("org.apache.maven.cli.CliRequest");
      System.setProperty("maven.multiModuleProjectDirectory",new File("").getPath());
      settingsBuilder=new DefaultSettingsBuilderFactory().newInstance();
    }
 catch (    ClassNotFoundException e1) {
      throw new RuntimeException("unable to find maven CliRequest class");
    }
  }
  Object cliRequest;
  try {
    List<String> commandLineOptions=new ArrayList<String>(settings.getUserProperties().size());
    for (    Map.Entry<Object,Object> each : settings.getUserProperties().entrySet()) {
      commandLineOptions.add("-D" + each.getKey() + "="+ each.getValue());
    }
    if (settings.getLoggingLevel() == MavenServerConsole.LEVEL_DEBUG) {
      commandLineOptions.add("-X");
      commandLineOptions.add("-e");
    }
 else     if (settings.getLoggingLevel() == MavenServerConsole.LEVEL_DISABLED) {
      commandLineOptions.add("-q");
    }
    Constructor constructor=cliRequestClass.getDeclaredConstructor(String[].class,ClassWorld.class);
    constructor.setAccessible(true);
    cliRequest=constructor.newInstance(commandLineOptions.toArray(new String[commandLineOptions.size()]),classWorld);
    for (    String each : new String[]{"initialize","cli","logging","properties","container"}) {
      Method m=MavenCli.class.getDeclaredMethod(each,cliRequestClass);
      m.setAccessible(true);
      m.invoke(cli,cliRequest);
    }
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  try {
    Method m=MavenCli.class.getDeclaredMethod("container",cliRequestClass);
    m.setAccessible(true);
    myContainer=(DefaultPlexusContainer)m.invoke(cli,cliRequest);
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  myContainer.getLoggerManager().setThreshold(settings.getLoggingLevel());
  mySystemProperties=FieldAccessor.get(cliRequestClass,cliRequest,"systemProperties");
  if (settings.getProjectJdk() != null) {
    mySystemProperties.setProperty("java.home",settings.getProjectJdk());
  }
  if (settingsBuilder == null) {
    settingsBuilder=FieldAccessor.get(MavenCli.class,cli,"settingsBuilder");
  }
  myMavenSettings=buildSettings(settingsBuilder,settings,mySystemProperties,FieldAccessor.<Properties>get(cliRequestClass,cliRequest,"userProperties"));
  myLocalRepository=createLocalRepository();
}
