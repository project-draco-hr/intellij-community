{
  if (!superClass.hasTypeParameters() && superClass.getContainingClass() == null)   return PsiSubstitutor.EMPTY;
  final PsiManager manager=superClass.getManager();
  if (PsiUtil.isRawSubstitutor(derivedClass,derivedSubstitutor)) {
    return JavaPsiFacade.getInstance(manager.getProject()).getElementFactory().createRawSubstitutor(superClass);
  }
  final PsiClass objectClass=JavaPsiFacade.getInstance(manager.getProject()).findClass(CommonClassNames.JAVA_LANG_OBJECT,superClass.getResolveScope());
  if (manager.areElementsEquivalent(superClass,objectClass)) {
    return PsiSubstitutor.EMPTY;
  }
  PsiSubstitutor substitutor;
  final Set<PsiClass> visited=new THashSet<PsiClass>();
  if (derivedClass instanceof PsiAnonymousClass) {
    final PsiClassType baseType=((PsiAnonymousClass)derivedClass).getBaseClassType();
    final JavaResolveResult result=baseType.resolveGenerics();
    if (result.getElement() == null)     return PsiSubstitutor.UNKNOWN;
    substitutor=getSuperClassSubstitutorInner(superClass,(PsiClass)result.getElement(),derivedSubstitutor.putAll(result.getSubstitutor()),visited,manager);
  }
 else {
    substitutor=getSuperClassSubstitutorInner(superClass,derivedClass,derivedSubstitutor,visited,manager);
  }
  if (substitutor == null) {
    if (ourReportedSuperClassSubstitutorExceptions.add(derivedClass.getQualifiedName() + "/" + superClass.getQualifiedName())) {
      reportHierarchyInconsistency(superClass,derivedClass,visited);
    }
    return PsiSubstitutor.EMPTY;
  }
  return substitutor;
}
