{
  String stringToFind=myFindModel.getStringToFind();
  if (stringToFind.isEmpty() || DumbService.getInstance(myProject).isDumb()) {
    return Collections.emptySet();
  }
  GlobalSearchScope scope=toGlobal(FindInProjectUtil.getScopeFromModel(myProject,myFindModel));
  final Set<VirtualFile> resultFiles=new LinkedHashSet<VirtualFile>();
  if (TrigramIndex.ENABLED) {
    final Set<Integer> keys=ContainerUtil.newTroveSet();
    TrigramBuilder.processTrigrams(stringToFind,new TrigramBuilder.TrigramProcessor(){
      @Override public boolean execute(      int value){
        keys.add(value);
        return true;
      }
    }
);
    if (!keys.isEmpty()) {
      final List<VirtualFile> hits=new ArrayList<VirtualFile>();
      final GlobalSearchScope finalScope=scope;
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        @Override public void run(){
          FileBasedIndex.getInstance().getFilesWithKey(TrigramIndex.INDEX_ID,keys,new CommonProcessors.CollectProcessor<VirtualFile>(hits),finalScope);
        }
      }
);
      for (      VirtualFile hit : hits) {
        if (myFileMask.value(hit)) {
          resultFiles.add(hit);
        }
      }
      return resultFiles;
    }
  }
  PsiSearchHelperImpl helper=(PsiSearchHelperImpl)PsiSearchHelper.SERVICE.getInstance(myProject);
  helper.processFilesWithText(scope,UsageSearchContext.ANY,myFindModel.isCaseSensitive(),stringToFind,new Processor<VirtualFile>(){
    @Override public boolean process(    VirtualFile file){
      if (myFileMask.value(file)) {
        ContainerUtil.addIfNotNull(resultFiles,file);
      }
      return true;
    }
  }
);
  CacheManager cacheManager=CacheManager.SERVICE.getInstance(myProject);
  VirtualFile[] filesWithWord=cacheManager.getVirtualFilesWithWord(stringToFind,UsageSearchContext.ANY,scope,myFindModel.isCaseSensitive());
  for (  VirtualFile file : filesWithWord) {
    if (myFileMask.value(file)) {
      resultFiles.add(file);
    }
  }
  return resultFiles;
}
