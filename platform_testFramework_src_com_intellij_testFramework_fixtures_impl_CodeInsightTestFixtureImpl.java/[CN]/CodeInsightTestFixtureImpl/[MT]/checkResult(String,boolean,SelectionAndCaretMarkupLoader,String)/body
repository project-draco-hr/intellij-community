{
  assertInitialized();
  Project project=getProject();
  Editor editor=getEditor();
  if (editor instanceof EditorWindow) {
    editor=((EditorWindow)editor).getDelegate();
  }
  UsefulTestCase.doPostponedFormatting(getProject());
  if (stripTrailingSpaces) {
    actualText=stripTrailingSpaces(actualText);
  }
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  String newFileText1=loader.newFileText;
  if (stripTrailingSpaces) {
    newFileText1=stripTrailingSpaces(newFileText1);
  }
  actualText=StringUtil.convertLineSeparators(actualText);
  if (!Comparing.equal(newFileText1,actualText)) {
    if (loader.filePath != null) {
      throw new FileComparisonFailure(expectedFile,newFileText1,actualText,loader.filePath);
    }
 else {
      throw new ComparisonFailure(expectedFile,newFileText1,actualText);
    }
  }
  EditorTestUtil.verifyCaretAndSelectionState(editor,loader.caretState,expectedFile);
}
