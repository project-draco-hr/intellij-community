{
  assertInitialized();
  ApplicationManager.getApplication().invokeAndWait(new Runnable(){
    @Override public void run(){
      if (!copy.getFileType().isBinary()) {
        AccessToken token=WriteAction.start();
        try {
          copy.setBinaryContent(loader.newFileText.getBytes(copy.getCharset()));
        }
 catch (        IOException e) {
          throw new RuntimeException(e);
        }
 finally {
          token.finish();
        }
      }
      myFile=copy;
      myEditor=createEditor(copy);
      if (myEditor == null) {
        Assert.fail("editor couldn't be created for: " + copy.getPath() + ", use copyFileToProject() instead of configureByFile()");
      }
      EditorTestUtil.setCaretsAndSelection(myEditor,loader.caretState);
      Module module=getModule();
      if (module != null) {
        for (        Facet facet : FacetManager.getInstance(module).getAllFacets()) {
          module.getMessageBus().syncPublisher(FacetManager.FACETS_TOPIC).facetConfigurationChanged(facet);
        }
      }
      PsiDocumentManager.getInstance(getProject()).commitAllDocuments();
      if (myCaresAboutInjection) {
        setupEditorForInjectedLanguage();
      }
    }
  }
,ModalityState.any());
  return getFile();
}
