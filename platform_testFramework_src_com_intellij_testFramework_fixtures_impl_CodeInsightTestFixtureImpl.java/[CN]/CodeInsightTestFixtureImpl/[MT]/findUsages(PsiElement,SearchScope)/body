{
  final Project project=getProject();
  final FindUsagesHandler handler=((FindManagerImpl)FindManager.getInstance(project)).getFindUsagesManager().getFindUsagesHandler(targetElement,false);
  final CommonProcessors.CollectProcessor<UsageInfo> processor=new CommonProcessors.CollectProcessor<UsageInfo>();
  Assert.assertNotNull("Cannot find handler for: " + targetElement,handler);
  final PsiElement[] psiElements=ArrayUtil.mergeArrays(handler.getPrimaryElements(),handler.getSecondaryElements());
  final FindUsagesOptions options=handler.getFindUsagesOptions(null);
  if (scope != null)   options.searchScope=scope;
  for (  PsiElement psiElement : psiElements) {
    handler.processElementUsages(psiElement,processor,options);
  }
  return processor.getResults();
}
