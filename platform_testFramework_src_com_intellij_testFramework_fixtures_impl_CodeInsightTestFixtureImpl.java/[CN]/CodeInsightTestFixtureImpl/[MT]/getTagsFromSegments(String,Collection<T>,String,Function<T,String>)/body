{
  final List<Border> borders=new LinkedList<>();
  for (  T region : segments) {
    String attr=attrCalculator == null ? null : attrCalculator.fun(region);
    borders.add(new CodeInsightTestFixtureImpl.Border(true,region.getStartOffset(),attr));
    borders.add(new CodeInsightTestFixtureImpl.Border(false,region.getEndOffset(),""));
  }
  Collections.sort(borders);
  StringBuilder result=new StringBuilder(text);
  for (  CodeInsightTestFixtureImpl.Border border : borders) {
    StringBuilder info=new StringBuilder();
    info.append('<');
    if (border.isLeftBorder()) {
      info.append(tagName);
      if (border.myText != null) {
        info.append(' ').append(border.myText);
      }
    }
 else {
      info.append('/').append(tagName);
    }
    info.append('>');
    result.insert(border.getOffset(),info);
  }
  return result.toString();
}
