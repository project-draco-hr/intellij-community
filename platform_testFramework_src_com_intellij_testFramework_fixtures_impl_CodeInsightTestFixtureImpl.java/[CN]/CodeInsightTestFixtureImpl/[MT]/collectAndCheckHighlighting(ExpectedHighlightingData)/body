{
  final Project project=getProject();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  PsiFileImpl file=(PsiFileImpl)getHostFile();
  FileElement hardRefToFileElement=file.calcTreeElement();
  if (!DumbService.isDumb(project)) {
    CacheManager.SERVICE.getInstance(project).getFilesWithWord("XXX",UsageSearchContext.IN_COMMENTS,GlobalSearchScope.allScope(project),true);
  }
  final long start=System.currentTimeMillis();
  final VirtualFileFilter fileTreeAccessFilter=myFileTreeAccessFilter;
  if (fileTreeAccessFilter != null) {
    ((PsiManagerImpl)PsiManager.getInstance(project)).setAssertOnFileLoadingFilter(fileTreeAccessFilter,myTestRootDisposable);
  }
  List<HighlightInfo> infos;
  try {
    infos=doHighlighting();
    removeDuplicatedRangesForInjected(infos);
  }
  finally {
    if (fileTreeAccessFilter != null) {
      ((PsiManagerImpl)PsiManager.getInstance(project)).setAssertOnFileLoadingFilter(VirtualFileFilter.NONE,myTestRootDisposable);
    }
  }
  final long elapsed=System.currentTimeMillis() - start;
  data.checkResult(infos,file.getText());
  hardRefToFileElement.hashCode();
  return elapsed;
}
