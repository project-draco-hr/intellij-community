{
  VirtualFile sourceDir=copyDirectoryToProject(new File(testDir,"src").getPath(),"src");
  PsiDirectory psiDirectory=getPsiManager().findDirectory(sourceDir);
  Assert.assertNotNull(psiDirectory);
  AnalysisScope scope=new AnalysisScope(psiDirectory);
  scope.invalidate();
  GlobalInspectionContextForTests globalContext=InspectionsKt.createGlobalContextForTool(scope,getProject(),Collections.<InspectionToolWrapper<?,?>>singletonList(toolWrapper));
  InspectionTestUtil.runTool(toolWrapper,scope,globalContext);
  InspectionTestUtil.compareToolResults(globalContext,toolWrapper,false,new File(getTestDataPath(),testDir).getPath());
}
