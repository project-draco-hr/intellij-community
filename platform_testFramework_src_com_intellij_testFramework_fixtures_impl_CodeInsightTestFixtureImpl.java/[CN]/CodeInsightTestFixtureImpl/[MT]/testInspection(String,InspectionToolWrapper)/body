{
  VirtualFile sourceDir=copyDirectoryToProject(new File(testDir,"src").getPath(),"src");
  PsiDirectory psiDirectory=getPsiManager().findDirectory(sourceDir);
  Assert.assertNotNull(psiDirectory);
  AnalysisScope scope=new AnalysisScope(psiDirectory);
  scope.invalidate();
  InspectionManagerEx inspectionManager=(InspectionManagerEx)InspectionManager.getInstance(getProject());
  GlobalInspectionContextForTests globalContext=createGlobalContextForTool(scope,getProject(),inspectionManager,toolWrapper);
  InspectionTestUtil.runTool(toolWrapper,scope,globalContext);
  InspectionTestUtil.compareToolResults(globalContext,toolWrapper,false,new File(getTestDataPath(),testDir).getPath());
}
