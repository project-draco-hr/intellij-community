{
  int offset=0;
  int index=0;
  while (!iterator.atEnd() && index < ranges.size()) {
    TextRange range=ranges.get(index);
    if (range.getStartOffset() >= iterator.getEnd()) {
      iterator.advance();
      continue;
    }
    if (range.getEndOffset() >= iterator.getStart()) {
      int relativeStart=Math.max(iterator.getStart() - range.getStartOffset(),0);
      int relativeEnd=Math.min(iterator.getEnd() - range.getStartOffset(),range.getLength() + 1);
      boolean merged=false;
      if (myMergeByTextAttributes && !myPieces.isEmpty()) {
        Element element=myPieces.get(myPieces.size() - 1);
        if (element.getEnd() >= offset + relativeStart && Comparing.equal(element.getAttributes(),iterator.getTextAttributes()) && Comparing.equal(element.getElementType(),iterator.getTokenType())) {
          merged=true;
          myPieces.add(new Element(element.getStart(),offset + relativeEnd,iterator.getTokenType(),iterator.getTextAttributes()));
        }
      }
      if (!merged) {
        myPieces.add(new Element(offset + relativeStart,offset + relativeEnd,iterator.getTokenType(),iterator.getTextAttributes()));
      }
    }
    if (range.getEndOffset() < iterator.getEnd()) {
      offset+=range.getLength() + 1 + myAdditionalOffset;
      int lastEnd=myPieces.isEmpty() ? -1 : myPieces.get(myPieces.size() - 1).getEnd();
      myPieces.add(new Element(Math.max(offset - 1 - myAdditionalOffset,lastEnd),offset,null,TextAttributes.ERASE_MARKER));
      index++;
      continue;
    }
    iterator.advance();
  }
}
