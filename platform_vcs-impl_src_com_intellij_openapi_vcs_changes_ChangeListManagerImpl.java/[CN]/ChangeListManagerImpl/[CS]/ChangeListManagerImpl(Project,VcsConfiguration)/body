{
  myProject=project;
  myConfig=config;
  myFreezeName=new AtomicReference<String>(null);
  myAdditionalInfo=null;
  myChangesViewManager=myProject.isDefault() ? new DummyChangesView(myProject) : ChangesViewManager.getInstance(myProject);
  myVfsListener=ApplicationManager.getApplication().getComponent(VcsDirtyScopeVfsListener.class);
  project.getMessageBus().connect().subscribe(ProjectManager.TOPIC,new ProjectManagerAdapter(){
    @Override public void projectClosing(    Project project){
      myVfsListener.flushDirt();
    }
  }
);
  myFileStatusManager=FileStatusManager.getInstance(myProject);
  myComposite=new FileHolderComposite(project);
  myIgnoredIdeaLevel=new IgnoredFilesComponent(myProject,true);
  myUpdater=new UpdateRequestsQueue(myProject,ourUpdateAlarm,new ActualUpdater());
  myWorker=new ChangeListWorker(myProject,new MyChangesDeltaForwarder(myProject,ourUpdateAlarm));
  myDelayedNotificator=new DelayedNotificator(myListeners,ourUpdateAlarm);
  myModifier=new Modifier(myWorker,myDelayedNotificator);
  myConflictTracker=new ChangelistConflictTracker(project,this,myFileStatusManager,EditorNotifications.getInstance(project));
  myListeners.addListener(new ChangeListAdapter(){
    @Override public void defaultListChanged(    final ChangeList oldDefaultList,    ChangeList newDefaultList){
      final LocalChangeList oldList=(LocalChangeList)oldDefaultList;
      if (oldDefaultList == null || oldList.hasDefaultName() || oldDefaultList.equals(newDefaultList))       return;
      if (!ApplicationManager.getApplication().isUnitTestMode() && oldDefaultList.getChanges().isEmpty() && !oldList.isReadOnly()) {
        invokeAfterUpdate(new Runnable(){
          @Override public void run(){
            if (getChangeList(oldList.getId()) == null) {
              return;
            }
            if (myModalNotificationsBlocked && config.REMOVE_EMPTY_INACTIVE_CHANGELISTS != VcsShowConfirmationOption.Value.DO_ACTION_SILENTLY) {
              myListsToBeDeleted.add(oldList);
            }
 else {
              deleteEmptyChangeLists(Collections.singletonList(oldList));
            }
          }
        }
,InvokeAfterUpdateMode.SILENT,null,null);
      }
    }
  }
);
}
