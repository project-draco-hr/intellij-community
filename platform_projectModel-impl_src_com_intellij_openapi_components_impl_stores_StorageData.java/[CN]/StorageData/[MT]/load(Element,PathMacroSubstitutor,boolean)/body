{
  if (pathMacroSubstitutor != null) {
    pathMacroSubstitutor.expandPaths(rootElement);
  }
  for (Iterator<Element> iterator=rootElement.getChildren(COMPONENT).iterator(); iterator.hasNext(); ) {
    Element element=iterator.next();
    String name=getComponentNameIfValid(element);
    if (name == null) {
      continue;
    }
    iterator.remove();
    if (intern) {
      IdeaPluginDescriptorImpl.internJDOMElement(element);
    }
    Object serverElement=myComponentStates.get(name);
    if (serverElement != null) {
      element=mergeElements(name,element,(Element)serverElement);
    }
    myComponentStates.put(name,element);
    if (pathMacroSubstitutor instanceof TrackingPathMacroSubstitutor) {
      ((TrackingPathMacroSubstitutor)pathMacroSubstitutor).addUnknownMacros(name,PathMacrosCollector.getMacroNames(element));
    }
    element.removeAttribute(NAME);
  }
}
