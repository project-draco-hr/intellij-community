{
  Set<String> bothStates=new SmartHashSet<String>(myComponentStates.keySet());
  bothStates.retainAll(newStorageData.myComponentStates.keySet());
  Set<String> diffs=new SmartHashSet<String>();
  diffs.addAll(newStorageData.myComponentStates.keySet());
  diffs.addAll(myComponentStates.keySet());
  diffs.removeAll(bothStates);
  for (  String componentName : bothStates) {
    Object oldState=myComponentStates.get(componentName);
    Object newState=newStorageData.myComponentStates.get(componentName);
    if (oldState instanceof Element) {
      if (!JDOMUtil.areElementsEqual((Element)oldState,(Element)newState)) {
        diffs.add(componentName);
      }
    }
 else     if (getNewByteIfDiffers(componentName,newState,(byte[])oldState) != null) {
      diffs.add(componentName);
    }
  }
  return diffs;
}
