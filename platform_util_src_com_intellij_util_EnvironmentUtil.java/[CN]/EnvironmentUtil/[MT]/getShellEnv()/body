{
  File envFile=null;
  try {
    String shell=System.getenv("SHELL");
    if (shell == null || !new File(shell).canExecute()) {
      throw new Exception("shell:" + shell);
    }
    envFile=FileUtil.createTempFile("intellij-shell-env",null,false);
    String[] command={shell,"-l","-c","/usr/bin/printenv > '" + envFile.getAbsolutePath() + "'"};
    LOG.info("loading shell env: " + StringUtil.join(command," "));
    Process process=Runtime.getRuntime().exec(command);
    ProcessKiller processKiller=new ProcessKiller(process);
    processKiller.killAfter(SHELL_ENV_READING_TIMEOUT);
    int rv=process.waitFor();
    processKiller.stopWaiting();
    List<String> lines=Files.readLines(envFile,Charsets.UTF_8);
    if (rv != 0 || lines.isEmpty()) {
      throw new Exception("rv:" + rv + " lines:"+ lines.size());
    }
    return parseEnv(lines);
  }
 catch (  Throwable t) {
    LOG.warn("can't get shell environment",t);
    return System.getenv();
  }
 finally {
    if (envFile != null) {
      FileUtil.delete(envFile);
    }
  }
}
