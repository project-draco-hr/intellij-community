{
  FileDocumentManager.getInstance().saveAllDocuments();
  final PythonCommandLineState pyState=(PythonCommandLineState)state;
  Sdk sdk=pyState.getSdk();
  if (sdk != null && sdk.getSdkAdditionalData() instanceof RemoteSdkAdditionalData) {
    RemoteSdkAdditionalData remoteSdkAdditionalData=(RemoteSdkAdditionalData)sdk.getSdkAdditionalData();
    PyDebugSessionFactory sessionCreator=PyDebugSessionFactory.findExtension(remoteSdkAdditionalData);
    if (sessionCreator != null) {
      return sessionCreator.createSession(this,pyState,environment);
    }
  }
  final ServerSocket serverSocket=PythonCommandLineState.createServerSocket();
  final int serverLocalPort=serverSocket.getLocalPort();
  RunProfile profile=environment.getRunProfile();
  final ExecutionResult result=pyState.execute(environment.getExecutor(),createCommandLinePatchers(environment.getProject(),pyState,profile,serverLocalPort));
  return XDebuggerManager.getInstance(environment.getProject()).startSession(environment,new XDebugProcessStarter(){
    @Override @NotNull public XDebugProcess start(    @NotNull final XDebugSession session){
      PyDebugProcess pyDebugProcess=createDebugProcess(session,serverSocket,result,pyState);
      createConsoleCommunicationAndSetupActions(environment.getProject(),result,pyDebugProcess,session);
      return pyDebugProcess;
    }
  }
);
}
