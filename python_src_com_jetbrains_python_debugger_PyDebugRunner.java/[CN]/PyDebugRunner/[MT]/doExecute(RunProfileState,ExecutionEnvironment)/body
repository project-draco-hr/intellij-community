{
  FileDocumentManager.getInstance().saveAllDocuments();
  final PythonCommandLineState pyState=(PythonCommandLineState)state;
  final ServerSocket serverSocket=PythonCommandLineState.createServerSocket();
  final int serverLocalPort=serverSocket.getLocalPort();
  RunProfile profile=environment.getRunProfile();
  final ExecutionResult result=pyState.execute(environment.getExecutor(),createCommandLinePatchers(environment.getProject(),pyState,profile,serverLocalPort));
  final XDebugSession session=XDebuggerManager.getInstance(environment.getProject()).startSession(environment,new XDebugProcessStarter(){
    @Override @NotNull public XDebugProcess start(    @NotNull final XDebugSession session){
      PyDebugProcess pyDebugProcess=new PyDebugProcess(session,serverSocket,result.getExecutionConsole(),result.getProcessHandler(),pyState.isMultiprocessDebug());
      createConsoleCommunicationAndSetupActions(environment.getProject(),result,pyDebugProcess,session);
      return pyDebugProcess;
    }
  }
);
  return session.getRunContentDescriptor();
}
