{
  FileDocumentManager.getInstance().saveAllDocuments();
  final ServerSocket serverSocket;
  try {
    serverSocket=new ServerSocket(0);
  }
 catch (  IOException e) {
    throw new ExecutionException("Failed to find free socket port",e);
  }
  final PythonCommandLineState pyState=(PythonCommandLineState)state;
  final CommandLinePatcher debug_server_patcher=new CommandLinePatcher(){
    public void patchCommandLine(    GeneralCommandLine commandLine){
      final String[] args=new String[]{PythonHelpersLocator.getHelperPath("pydev/pydevd.py"),"--client","127.0.0.1","--port",String.valueOf(serverSocket.getLocalPort()),"--file"};
      final ParametersList parameters_list=commandLine.getParametersList();
      int parameter_offset=pyState.getInterpreterOptionsCount();
      for (int i=0; i < args.length; i++) {
        parameters_list.addAt(i + parameter_offset,args[i]);
      }
    }
  }
;
  RunProfile profile=env.getRunProfile();
  CommandLinePatcher run_config_patcher=null;
  if (state instanceof PythonCommandLineState && profile instanceof PythonRunConfiguration) {
    run_config_patcher=(PythonRunConfiguration)profile;
  }
  final ExecutionResult result=pyState.execute(debug_server_patcher,run_config_patcher);
  final XDebugSession session=XDebuggerManager.getInstance(project).startSession(this,env,contentToReuse,new XDebugProcessStarter(){
    @NotNull public XDebugProcess start(    @NotNull final XDebugSession session){
      return new PyDebugProcess(session,serverSocket,result.getExecutionConsole(),result.getProcessHandler());
    }
  }
);
  return session.getRunContentDescriptor();
}
