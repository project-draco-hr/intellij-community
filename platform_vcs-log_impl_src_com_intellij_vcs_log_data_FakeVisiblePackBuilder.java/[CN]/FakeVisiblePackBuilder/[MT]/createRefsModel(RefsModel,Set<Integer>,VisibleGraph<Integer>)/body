{
  Map<VirtualFile,Set<VcsRef>> refs=ContainerUtil.newHashMap();
  Collection<VcsRef> allRefs=refsModel.getAllRefs();
  for (  VcsRef ref : allRefs) {
    int commitIndex=myHashMap.getCommitIndex(ref.getCommitHash(),ref.getRoot());
    if (ref.getType().isBranch() || heads.contains(commitIndex)) {
      Integer row=visibleGraph.getVisibleRowIndex(commitIndex);
      if (row != null && row >= 0) {
        Set<VcsRef> refsByRoot=refs.get(ref.getRoot());
        if (refsByRoot == null) {
          refsByRoot=ContainerUtil.newHashSet();
          refs.put(ref.getRoot(),refsByRoot);
        }
        refsByRoot.add(ref);
      }
    }
  }
  return new RefsModel(refs,heads,myHashMap);
}
