{
  Project project=e.getProject();
  JBIterable<VirtualFile> files=JBIterable.of(e.getData(CommonDataKeys.VIRTUAL_FILE_ARRAY));
  if (project == null || files.isEmpty()) {
    e.getPresentation().setEnabledAndVisible(false);
    return;
  }
  ScratchFileService fileService=ScratchFileService.getInstance();
  Condition<VirtualFile> isScratch=compose(ROOT_TYPE(fileService),instanceOf(ScratchRootType.class));
  if (!files.filter(not(isScratch)).isEmpty()) {
    e.getPresentation().setEnabledAndVisible(false);
    return;
  }
  Set<Language> langs=files.filter(isScratch).transform(SCRATCH_LANG(fileService,project)).filter(notNull()).addAllTo(ContainerUtil.<Language>newLinkedHashSet());
  String langName=langs.size() == 1 ? langs.iterator().next().getDisplayName() : langs.size() + " different";
  e.getPresentation().setText("Change Language (" + langName + ")...");
  e.getPresentation().setEnabledAndVisible(true);
}
