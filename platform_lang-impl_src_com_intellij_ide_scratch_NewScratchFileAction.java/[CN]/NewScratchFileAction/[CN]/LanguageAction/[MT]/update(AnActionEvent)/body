{
  Project project=e.getProject();
  VirtualFile file=CommonDataKeys.VIRTUAL_FILE.getData(e.getDataContext());
  if (project == null || file == null) {
    e.getPresentation().setEnabledAndVisible(false);
    return;
  }
  ScratchFileService fileService=ScratchFileService.getInstance();
  if (!(fileService.getRootType(file) instanceof ScratchRootType)) {
    e.getPresentation().setEnabledAndVisible(false);
    return;
  }
  Language lang=fileService.getScratchesMapping().getMapping(file);
  if (lang == null) {
    lang=LanguageSubstitutors.INSTANCE.substituteLanguage(((LanguageFileType)file.getFileType()).getLanguage(),file,project);
  }
  e.getPresentation().setText("Change Language (" + lang.getDisplayName() + ")...");
  e.getPresentation().setEnabledAndVisible(true);
}
