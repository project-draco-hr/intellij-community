{
  if (editor == null)   return null;
  if (psiFile == null)   return null;
  Caret caret=editor.getCaretModel().getPrimaryCaret();
  int offset=caret.getOffset();
  PsiElement element=InjectedLanguageManager.getInstance(project).findInjectedElementAt(psiFile,offset);
  element=element == null ? psiFile.findElementAt(offset) : element;
  Language language=element != null ? element.getLanguage() : psiFile.getLanguage();
  return substitute(project,language);
}
