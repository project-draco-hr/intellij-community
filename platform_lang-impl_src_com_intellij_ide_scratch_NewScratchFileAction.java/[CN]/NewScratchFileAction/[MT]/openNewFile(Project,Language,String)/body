{
  FeatureUsageTracker.getInstance().triggerFeatureUsed("scratch");
  Language initialLanguage=language == Language.ANY ? StdLanguages.TEXT : language;
  final VirtualFile file=ScratchRootType.getInstance().createScratchFile(project,"scratch",initialLanguage,text);
  if (file != null) {
    FileEditor[] editors=FileEditorManager.getInstance(project).openFile(file,true);
    if (language == Language.ANY && editors.length != 0 && editors[0] instanceof TextEditor) {
      final TextEditor textEditor=(TextEditor)editors[0];
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          if (!textEditor.isValid())           return;
          PerFileMappings<Language> mappings=ScratchFileService.getInstance().getScratchesMapping();
          LRUPopupBuilder.forFileLanguages(project,JBIterable.of(file),mappings).showInBestPositionFor(textEditor.getEditor());
        }
      }
);
    }
  }
  return file;
}
