{
  if (text.length() < path.length() || path.isEmpty()) {
    return text;
  }
  int shift=0;
  while (true) {
    final int indexInText=caseSensitive ? text.indexOf(path,shift) : StringUtil.indexOfIgnoreCase(text,path,shift);
    if (indexInText < 0)     break;
    int endOfOccurrence=path.length() + indexInText;
    final boolean isWindowsRoot=path.endsWith(":/");
    if (!isWindowsRoot && endOfOccurrence < text.length() && text.charAt(endOfOccurrence) != '/' && !text.substring(endOfOccurrence).startsWith("!/")) {
      shift=endOfOccurrence;
      continue;
    }
    text=StringUtil.replaceSubstring(text,new TextRange(indexInText,endOfOccurrence),myMacroMap.get(path));
    shift=indexInText + myMacroMap.get(path).length();
  }
  return text;
}
