{
  Notification oldNotification=notification.get();
  if (oldNotification != null) {
    if (!oldNotification.isExpired() && (oldNotification.getBalloon() != null || (project != null && group.getDisplayType() == NotificationDisplayType.TOOL_WINDOW && ToolWindowManager.getInstance(project).getToolWindowBalloon(group.getToolWindowId()) != null))) {
      return false;
    }
    oldNotification.whenExpired(null);
    oldNotification.expire();
  }
  if (expiredListener == null) {
    expiredListener=new Runnable(){
      @Override public void run(){
        Notification currentNotification=notification.get();
        if (currentNotification != null && currentNotification.isExpired()) {
          notification.compareAndSet(currentNotification,null);
        }
      }
    }
;
  }
  Notification newNotification=group.createNotification(title,content,type,listener);
  newNotification.whenExpired(expiredListener);
  notification.set(newNotification);
  newNotification.notify(project);
  return true;
}
