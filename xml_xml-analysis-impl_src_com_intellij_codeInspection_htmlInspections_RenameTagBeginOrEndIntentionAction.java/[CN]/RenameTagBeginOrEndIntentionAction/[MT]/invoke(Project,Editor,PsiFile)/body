{
  final int offset=editor.getCaretModel().getOffset();
  PsiElement psiElement=file.findElementAt(offset);
  if (psiElement == null || !psiElement.isValid())   return;
  if (!FileModificationService.getInstance().prepareFileForWrite(psiElement.getContainingFile()))   return;
  if (psiElement instanceof PsiWhiteSpace)   psiElement=PsiTreeUtil.prevLeaf(psiElement);
  if (psiElement instanceof XmlToken) {
    final IElementType tokenType=((XmlToken)psiElement).getTokenType();
    if (tokenType != XmlTokenType.XML_NAME) {
      if (tokenType == XmlTokenType.XML_TAG_END) {
        psiElement=psiElement.getPrevSibling();
        if (psiElement == null)         return;
      }
    }
    PsiElement target=null;
    final String text=psiElement.getText();
    if (!myTargetName.equals(text)) {
      target=psiElement;
    }
 else {
      target=findOtherSide(psiElement,myStart);
    }
    if (target != null) {
      final Document document=PsiDocumentManager.getInstance(project).getDocument(file);
      if (document != null) {
        final TextRange textRange=target.getTextRange();
        document.replaceString(textRange.getStartOffset(),textRange.getEndOffset(),myTargetName);
      }
    }
  }
}
