{
  final List<IdeaDependency> dependencies=new ArrayList<IdeaDependency>();
  final Map<DependencyVersionId,Scopes> scopesMap=new HashMap<DependencyVersionId,Scopes>();
  final IdeDependenciesExtractor dependenciesExtractor=new IdeDependenciesExtractor();
  boolean offline=false;
  boolean downloadJavadoc=false;
  boolean downloadSources=true;
  final IdeaPlugin ideaPlugin=project.getPlugins().getPlugin(IdeaPlugin.class);
  if (ideaPlugin != null) {
    IdeaModel ideaModel=ideaPlugin.getModel();
    if (ideaModel != null && ideaModel.getModule() == null) {
      offline=ideaModel.getModule().isOffline();
      downloadJavadoc=ideaModel.getModule().isDownloadJavadoc();
      downloadSources=ideaModel.getModule().isDownloadSources();
    }
  }
  for (  final Configuration configuration : project.getConfigurations()) {
    Collection<Configuration> plusConfigurations=new ArrayList<Configuration>();
    plusConfigurations.add(configuration);
    final List<IdeDependenciesExtractor.IdeProjectDependency> ideProjectDependencies=dependenciesExtractor.extractProjectDependencies(plusConfigurations,new ArrayList<Configuration>());
    for (    IdeDependenciesExtractor.IdeProjectDependency ideProjectDependency : ideProjectDependencies) {
      merge(scopesMap,ideProjectDependency);
    }
    if (!offline) {
      final Collection<IdeDependenciesExtractor.IdeRepoFileDependency> ideRepoFileDependencies=dependenciesExtractor.extractRepoFileDependencies(project.getConfigurations(),plusConfigurations,new ArrayList<Configuration>(),downloadSources,downloadJavadoc);
      for (      IdeDependenciesExtractor.IdeRepoFileDependency repoFileDependency : ideRepoFileDependencies) {
        merge(scopesMap,repoFileDependency);
      }
    }
    final List<IdeDependenciesExtractor.IdeLocalFileDependency> ideLocalFileDependencies=dependenciesExtractor.extractLocalFileDependencies(plusConfigurations,new ArrayList<Configuration>());
    for (    IdeDependenciesExtractor.IdeLocalFileDependency fileDependency : ideLocalFileDependencies) {
      merge(scopesMap,fileDependency);
    }
  }
  for (  Map.Entry<DependencyVersionId,Scopes> entry : scopesMap.entrySet()) {
    DependencyVersionId versionId=entry.getKey();
    for (    GradleDependencyScope scope : entry.getValue().getScopes()) {
      if (versionId.getIdeDependency() instanceof IdeDependenciesExtractor.IdeRepoFileDependency) {
        IdeDependenciesExtractor.IdeRepoFileDependency repoFileDependency=(IdeDependenciesExtractor.IdeRepoFileDependency)versionId.getIdeDependency();
        IdeaSingleEntryLibraryDependencyImpl libraryDependency=new IdeaSingleEntryLibraryDependencyImpl(new IdeaDependencyScopeImpl(scope),versionId.getName(),versionId.getGroup(),versionId.getVersion());
        libraryDependency.setFile(repoFileDependency.getFile());
        libraryDependency.setSource(repoFileDependency.getSourceFile());
        libraryDependency.setJavadoc(repoFileDependency.getJavadocFile());
        dependencies.add(libraryDependency);
      }
 else       if (versionId.getIdeDependency() instanceof IdeDependenciesExtractor.IdeProjectDependency) {
        IdeaModuleDependencyImpl moduleDependency=new IdeaModuleDependencyImpl(new IdeaDependencyScopeImpl(scope),versionId.getName(),versionId.getGroup(),versionId.getVersion());
        moduleDependency.setIdeaModule(new StubIdeaModule(versionId.getName()));
        dependencies.add(moduleDependency);
      }
 else       if (versionId.getIdeDependency() instanceof IdeDependenciesExtractor.IdeLocalFileDependency) {
        IdeDependenciesExtractor.IdeLocalFileDependency fileDependency=(IdeDependenciesExtractor.IdeLocalFileDependency)versionId.getIdeDependency();
        IdeaSingleEntryLibraryDependencyImpl libraryDependency=new IdeaSingleEntryLibraryDependencyImpl(new IdeaDependencyScopeImpl(scope),versionId.getName(),versionId.getGroup(),versionId.getVersion());
        libraryDependency.setFile(fileDependency.getFile());
        dependencies.add(libraryDependency);
      }
    }
  }
  return new ProjectDependenciesModelImpl(project.getPath(),dependencies);
}
