{
  final GlobalSearchScope searchScope=GlobalSearchScope.projectScope(rootPackage.getProject());
  final PsiPackage[] subPackages=rootPackage.getSubPackages();
  for (  PsiPackage aPackage : subPackages) {
    final PsiDirectory[] directories=aPackage.getDirectories(searchScope);
    if (directories.length == 0)     continue;
    if (isInCoverageScope(aPackage,data)) {
      final CoverageListNode node=new CoverageListNode(aPackage,data,stateBean);
      children.add(node);
    }
 else     if (!stateBean.myFlattenPackages) {
      collectSubPackages(children,aPackage,data,stateBean);
    }
    if (stateBean.myFlattenPackages) {
      collectSubPackages(children,aPackage,data,stateBean);
    }
  }
}
