{
  final AbstractProjectViewPane viewPane=getCurrentProjectViewPane();
  if (viewPane == null)   return null;
  final Object[] elements=viewPane.getSelectedElements();
  ArrayList<Module> result=new ArrayList<>();
  for (  Object element : elements) {
    if (element instanceof Module) {
      final Module module=(Module)element;
      if (!module.isDisposed()) {
        result.add(module);
      }
    }
 else     if (element instanceof ModuleGroup) {
      Collection<Module> modules=((ModuleGroup)element).modulesInGroup(myProject,true);
      result.addAll(modules);
    }
 else     if (element instanceof PsiDirectory) {
      Module module=moduleBySingleContentRoot(((PsiDirectory)element).getVirtualFile());
      if (module != null)       result.add(module);
    }
 else     if (element instanceof VirtualFile) {
      Module module=moduleBySingleContentRoot((VirtualFile)element);
      if (module != null)       result.add(module);
    }
  }
  if (result.isEmpty()) {
    return null;
  }
 else {
    return result.toArray(new Module[result.size()]);
  }
}
