{
  resolveLocalConflicts(myContext.getScope(),mySettings.getName());
  preprocessOccurrences();
  boolean isExpressionFirstOccurrence=myOccurrences[0] == myExpression;
  final PsiElement[] replaced=processOccurrences();
  GrStatement anchor=getAnchor(replaced);
  if (isControlStatementBranch(anchor)) {
    anchor=insertBraces(replaced,anchor);
  }
  GrVariable variable=insertVariableDefinition(declaration,anchor);
  if (isExpressionFirstOccurrence) {
    final PsiElement expressionSkipped=PsiUtil.skipParentheses(replaced[0],true);
    if (PsiUtil.isExpressionStatement(expressionSkipped) && expressionSkipped.getParent() == variable.getParent().getParent()) {
      expressionSkipped.delete();
      refreshPositionMarker(variable);
    }
  }
  RefactoringUtil.highlightAllOccurrences(myContext.getProject(),replaced,myContext.getEditor());
  return variable;
}
