{
  if (checkIndexAndRecreateIfNeed(project,indexVersion,canonicalIndexName)) {
    ClassFilesIndexStorage<K,V> index=null;
    IOException exception=null;
    final File projectBuildSystemDirectory=BuildManager.getInstance().getProjectSystemDirectory(project);
    final File indexDir=ClassFilesIndexStorage.getIndexDir(canonicalIndexName,projectBuildSystemDirectory);
    try {
      index=new ClassFilesIndexStorage<K,V>(indexDir,keyDescriptor,valueExternalizer);
    }
 catch (    final IOException e) {
      exception=e;
      PersistentHashMap.deleteFilesStartingWith(ClassFilesIndexStorage.getIndexFile(indexDir));
    }
    if (exception != null) {
      recreateIndex(canonicalIndexName,indexVersion,projectBuildSystemDirectory,indexDir);
      myIndex=null;
    }
 else {
      myIndex=index;
    }
  }
 else {
    myIndex=null;
  }
}
