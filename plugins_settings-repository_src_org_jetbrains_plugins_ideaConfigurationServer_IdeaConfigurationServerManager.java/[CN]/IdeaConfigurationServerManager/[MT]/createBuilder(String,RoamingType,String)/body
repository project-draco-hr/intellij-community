{
  try {
    return new IdeaServerUrlBuilder(fileSpec,type,projectKey,mySettings.getSessionId(),mySettings.getUserName(),mySettings.getPassword()){
      @Override protected void onSessionIdUpdated(      final String id){
        mySettings.updateSession(id);
      }
      @Override public void setDisconnectedStatus(){
        mySettings.setStatus(IdeaServerStatus.CONNECTION_FAILED);
      }
      @Override public void setUnauthorizedStatus(){
        mySettings.setStatus(IdeaServerStatus.UNAUTHORIZED);
      }
    }
.setReloginAutomatically(true);
  }
  finally {
    if (projectKey != null) {
      checkIfProjectKeyMappingIsStored(projectKey);
    }
  }
}
