{
  try {
    return new IdeaServerUrlBuilder(fileSpec,type,projectKey,settings.getSessionId(),settings.getUserName(),settings.getPassword()){
      @Override protected void onSessionIdUpdated(      final String id){
        settings.updateSession(id);
      }
      @Override public void setDisconnectedStatus(){
        settings.setStatus(IdeaServerStatus.CONNECTION_FAILED);
      }
      @Override public void setUnauthorizedStatus(){
        settings.setStatus(IdeaServerStatus.UNAUTHORIZED);
      }
    }
.setReloginAutomatically(true);
  }
  finally {
    if (projectKey != null) {
      checkIfProjectKeyMappingIsStored(projectKey);
    }
  }
}
