{
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  DumbService.getInstance(project).setAlternativeResolveEnabled(true);
  try {
    int offset=editor.getCaretModel().getOffset();
    PsiElement[] elements=findAllTargetElements(project,editor,offset);
    FeatureUsageTracker.getInstance().triggerFeatureUsed("navigation.goto.declaration");
    if (elements.length != 1) {
      if (elements.length == 0 && suggestCandidates(TargetElementUtil.findReference(editor,offset)).isEmpty()) {
        PsiElement element=findElementToShowUsagesOf(editor,editor.getCaretModel().getOffset());
        if (element != null) {
          ShowUsagesAction showUsages=(ShowUsagesAction)ActionManager.getInstance().getAction(ShowUsagesAction.ID);
          RelativePoint popupPosition=JBPopupFactory.getInstance().guessBestPopupLocation(editor);
          showUsages.startFindUsages(element,popupPosition,editor,ShowUsagesAction.USAGES_PAGE_SIZE);
          return;
        }
      }
      chooseAmbiguousTarget(editor,offset,elements,file);
      return;
    }
    PsiElement element=elements[0];
    PsiElement navElement=element.getNavigationElement();
    navElement=TargetElementUtil.getInstance().getGotoDeclarationTarget(element,navElement);
    if (navElement != null) {
      gotoTargetElement(navElement,editor,file);
    }
  }
 catch (  IndexNotReadyException e) {
    DumbService.getInstance(project).showDumbModeNotification("Navigation is not available here during index update");
  }
 finally {
    DumbService.getInstance(project).setAlternativeResolveEnabled(false);
  }
}
