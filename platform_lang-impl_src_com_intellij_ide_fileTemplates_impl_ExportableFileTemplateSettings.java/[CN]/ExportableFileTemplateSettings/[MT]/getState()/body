{
  Element element=null;
  for (  FTManager manager : getAllManagers()) {
    Element templatesGroup=null;
    for (    FileTemplateBase template : manager.getAllTemplates(true)) {
      boolean shouldSave=template.isReformatCode() != FileTemplateBase.DEFAULT_REFORMAT_CODE_VALUE || template.isLiveTemplateEnabled() != template.isLiveTemplateEnabledByDefault();
      if (template instanceof BundledFileTemplate) {
        shouldSave|=((BundledFileTemplate)template).isEnabled() != FileTemplateBase.DEFAULT_ENABLED_VALUE;
      }
      if (!shouldSave) {
        continue;
      }
      final Element templateElement=new Element(ELEMENT_TEMPLATE);
      templateElement.setAttribute(ATTRIBUTE_NAME,template.getQualifiedName());
      templateElement.setAttribute(ATTRIBUTE_REFORMAT,Boolean.toString(template.isReformatCode()));
      templateElement.setAttribute(ATTRIBUTE_LIVE_TEMPLATE,Boolean.toString(template.isLiveTemplateEnabled()));
      if (template instanceof BundledFileTemplate) {
        templateElement.setAttribute(ATTRIBUTE_ENABLED,Boolean.toString(((BundledFileTemplate)template).isEnabled()));
      }
      if (templatesGroup == null) {
        templatesGroup=new Element(getXmlElementGroupName(manager));
        if (element == null) {
          element=new Element("fileTemplateSettings");
        }
        element.addContent(templatesGroup);
      }
      templatesGroup.addContent(templateElement);
    }
  }
  return element;
}
