{
  if (req.leftElem instanceof PsiComment && req.rightElem instanceof PsiComment) {
    final CharSequence text=req.document.getCharsSequence();
    final TextRange rightRange=req.rightElem.getTextRange();
    final int initialPos=rightRange.getStartOffset() + 1;
    int pos=initialPos;
    final int last=rightRange.getEndOffset();
    while (pos < last && " \t".indexOf(text.charAt(pos)) >= 0)     pos+=1;
    int right=pos - initialPos + 1;
    String substring=req.rightElem.getText().substring(right);
    String replacement=" " + findReplacement(substring,getStringToJoinMaxLength(req,0));
    right+=replacement.length() - 1;
    if (!replacement.trim().isEmpty()) {
      replacement+="\n";
      req.document.insertString(req.secondLineStartOffset + right,"# ");
    }
    return new Result(replacement,0,0,right);
  }
  return null;
}
