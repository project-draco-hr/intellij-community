{
  command.first.getEnvironment().putAll(testEnv);
  command.first.setPassParentEnvironment(passParentEnv);
  String output=execHelper(command);
  Set<String> lines=ContainerUtil.newHashSet(StringUtil.convertLineSeparators(output).split("\n"));
  for (  Map.Entry<String,String> entry : expectedOutputEnv.entrySet()) {
    String str=CommandTestHelper.format(entry);
    assertTrue("\"" + str + "\" should be in "+ lines,lines.contains(str));
  }
  Map<String,String> parentEnv=System.getenv();
  List<String> missed=new ArrayList<String>();
  for (  Map.Entry<String,String> entry : parentEnv.entrySet()) {
    String str=CommandTestHelper.format(entry);
    if (!lines.contains(str)) {
      missed.add(str);
    }
  }
  long pctMissed=Math.round((100.0 * missed.size()) / parentEnv.size());
  if (passParentEnv && pctMissed > 25 || !passParentEnv && pctMissed < 75) {
    fail("% missed: " + pctMissed + ", missed: "+ missed+ ", passed: "+ lines);
  }
}
