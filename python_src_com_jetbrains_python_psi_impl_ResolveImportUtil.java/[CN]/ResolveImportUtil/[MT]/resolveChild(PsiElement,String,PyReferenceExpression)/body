{
  PsiDirectory dir=null;
  PsiElement ret=null;
  PyResolveUtil.ResolveProcessor processor=null;
  if (parent instanceof PyFile) {
    boolean is_dir=(parent.getCopyableUserData(PyFile.KEY_IS_DIRECTORY) == Boolean.TRUE);
    PyFile pfparent=(PyFile)parent;
    if (!is_dir) {
      processor=new PyResolveUtil.ResolveProcessor(referencedName);
      ret=PyResolveUtil.treeWalkUp(processor,parent,null,importRef);
      if (ret != null)       return ret;
    }
 else {
      dir=pfparent.getContainingDirectory();
    }
  }
 else   if (parent instanceof PsiDirectory) {
    dir=(PsiDirectory)parent;
  }
  if (dir != null) {
    final PsiFile file=dir.findFile(referencedName + PY_SUFFIX);
    if (file != null)     return file;
    final PsiDirectory subdir=dir.findSubdirectory(referencedName);
    if (subdir != null)     return subdir;
 else {
      final PsiFile initPy=dir.findFile(INIT_PY);
      if (initPy != null) {
        if (processor == null)         processor=new PyResolveUtil.ResolveProcessor(referencedName);
        return PyResolveUtil.treeWalkUp(processor,initPy,null,importRef);
      }
    }
  }
  return ret;
}
