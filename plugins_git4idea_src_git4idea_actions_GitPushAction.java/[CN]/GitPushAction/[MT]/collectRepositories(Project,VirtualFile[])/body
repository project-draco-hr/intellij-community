{
  GitRepositoryManager manager=GitUtil.getRepositoryManager(project);
  Collection<GitRepository> repositories;
  if (GitVcsSettings.getInstance(project).getSyncSetting() == DvcsBranchSync.SYNC && !diverged(manager.getRepositories())) {
    repositories=manager.getRepositories();
  }
 else   if (files == null) {
    repositories=Collections.singletonList(GitBranchUtil.getCurrentRepository(project));
  }
 else {
    repositories=ContainerUtil.newHashSet();
    for (    VirtualFile file : files) {
      GitRepository repo=manager.getRepositoryForFile(file);
      if (repo != null) {
        repositories.add(repo);
      }
    }
  }
  return repositories;
}
