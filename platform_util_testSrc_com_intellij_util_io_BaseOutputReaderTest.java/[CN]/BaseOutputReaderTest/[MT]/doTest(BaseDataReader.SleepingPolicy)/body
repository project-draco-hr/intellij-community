{
  String java=System.getProperty("java.home") + (SystemInfo.isWindows ? "\\bin\\java.exe" : "/bin/java");
  String className=BaseOutputReaderTest.class.getName();
  URL url=getClass().getClassLoader().getResource(className.replace(".","/") + ".class");
  assertNotNull(url);
  File dir=new File(url.toURI());
  for (int i=0; i < StringUtil.countChars(className,'.') + 1; i++)   dir=dir.getParentFile();
  String[] cmd={java,"-cp",dir.getPath(),className};
  Process process=new ProcessBuilder(cmd).redirectErrorStream(true).start();
  TestOutputReader reader=new TestOutputReader(process.getInputStream(),policy,StringUtil.join(cmd," "));
  process.waitFor();
  reader.stop();
  reader.waitFor();
  assertEquals(0,process.exitValue());
  assertEquals(Arrays.asList(TEST_DATA),reader.myLines);
}
