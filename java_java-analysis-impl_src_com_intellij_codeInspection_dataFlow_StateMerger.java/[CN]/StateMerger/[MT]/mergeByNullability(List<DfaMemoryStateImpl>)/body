{
  MultiMap<Integer,DfaMemoryStateImpl> byHash=new MultiMap<Integer,DfaMemoryStateImpl>();
  for (  DfaMemoryStateImpl state : states) {
    ProgressManager.checkCanceled();
    byHash.putValue(state.getPartialHashCode(false,false),state);
  }
  Replacements replacements=new Replacements(states);
  for (  Integer key : byHash.keySet()) {
    Collection<DfaMemoryStateImpl> similarStates=byHash.get(key);
    if (similarStates.size() < 2)     continue;
    groupLoop:     for (    final DfaMemoryStateImpl state1 : similarStates) {
      ProgressManager.checkCanceled();
      for (      final DfaVariableValue var : state1.getChangedVariables()) {
        if (state1.getVariableState(var).getNullability() != Nullness.NULLABLE) {
          continue;
        }
        List<DfaMemoryStateImpl> complementary=ContainerUtil.filter(similarStates,new Condition<DfaMemoryStateImpl>(){
          @Override public boolean value(          DfaMemoryStateImpl state2){
            return state1.equalsByRelations(state2) && areEquivalentModuloVar(state1,state2,var) && areVarStatesEqualModuloNullability(state1,state2,var);
          }
        }
);
        if (mergeUnknowns(replacements,complementary))         break groupLoop;
      }
    }
  }
  return replacements.getMergeResult();
}
