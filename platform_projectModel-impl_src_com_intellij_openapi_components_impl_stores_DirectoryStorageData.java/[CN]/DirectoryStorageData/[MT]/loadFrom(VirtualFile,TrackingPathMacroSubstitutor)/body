{
  if (dir == null || !dir.exists()) {
    return;
  }
  for (  VirtualFile file : dir.getChildren()) {
    if (!isStorageFile(file)) {
      continue;
    }
    try {
      final Element element=JDOMUtil.loadDocument(file.contentsToByteArray()).detachRootElement();
      if (!element.getName().equals(StorageData.COMPONENT)) {
        LOG.error("Incorrect root tag name (" + element.getName() + ") in "+ file.getPresentableUrl());
        continue;
      }
      String componentName=element.getAttributeValue(StorageData.NAME);
      if (componentName == null) {
        LOG.error("Component name isn't specified in " + file.getPresentableUrl());
        continue;
      }
      if (pathMacroSubstitutor != null) {
        pathMacroSubstitutor.expandPaths(element);
        pathMacroSubstitutor.addUnknownMacros(componentName,PathMacrosCollector.getMacroNames(element));
      }
      put(componentName,new File(file.getPath()),element,true);
    }
 catch (    IOException e) {
      LOG.info("Unable to load state",e);
    }
catch (    JDOMException e) {
      LOG.info("Unable to load state",e);
    }
  }
}
