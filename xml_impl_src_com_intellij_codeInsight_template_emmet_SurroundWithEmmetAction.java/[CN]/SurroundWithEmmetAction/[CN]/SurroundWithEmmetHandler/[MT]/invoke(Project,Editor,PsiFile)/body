{
  SelectionModel selectionModel=editor.getSelectionModel();
  if (!selectionModel.hasSelection() && !selectionModel.hasBlockSelection()) {
    selectionModel.selectLineAtCaret();
  }
  final Document document=editor.getDocument();
  final VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(document);
  if (virtualFile != null) {
    ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(virtualFile);
  }
  String selection=editor.getSelectionModel().getSelectedText();
  final ZenCodingTemplate template=new ZenCodingTemplate();
  if (selection != null && template.isApplicable(file,editor.getCaretModel().getOffset(),true)) {
    selection=selection.trim();
    PsiDocumentManager.getInstance(project).commitAllDocuments();
    template.wrap(selection,new CustomTemplateCallback(editor,file,true));
  }
 else   if (!ApplicationManager.getApplication().isUnitTestMode()) {
    HintManager.getInstance().showErrorHint(editor,"Cannot invoke Surround with Emmet in the current context");
  }
}
