{
  final Editor editor=context.getEditor();
  final Document document=editor.getDocument();
  final int caretOffset=editor.getCaretModel().getOffset();
  PsiFile file=context.getFile();
  if (file.getLanguage() == HTMLLanguage.INSTANCE && HtmlUtil.isSingleHtmlAttribute((String)item.getObject())) {
    return;
  }
  final CharSequence chars=document.getCharsSequence();
  if (!CharArrayUtil.regionMatches(chars,caretOffset,"=\"") && !CharArrayUtil.regionMatches(chars,caretOffset,"='")) {
    PsiElement fileContext=file.getContext();
    String toInsert="=\"\"";
    if (fileContext != null) {
      if (fileContext.getText().startsWith("\""))       toInsert="=''";
    }
    if (caretOffset >= document.getTextLength() || "/> \n\t\r".indexOf(document.getCharsSequence().charAt(caretOffset)) < 0) {
      document.insertString(caretOffset,toInsert + " ");
    }
 else {
      document.insertString(caretOffset,toInsert);
    }
    if ('=' == context.getCompletionChar()) {
      context.setAddCompletionChar(false);
    }
  }
  editor.getCaretModel().moveToOffset(caretOffset + 2);
  editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  editor.getSelectionModel().removeSelection();
  AutoPopupController.getInstance(editor.getProject()).scheduleAutoPopup(editor);
  if (myNamespaceToInsert != null && file instanceof XmlFile) {
    final XmlNamespaceHelper helper=XmlNamespaceHelper.getHelper(context.getFile());
    if (helper != null) {
      PsiDocumentManager.getInstance(context.getProject()).commitDocument(document);
      helper.insertNamespaceDeclaration((XmlFile)file,editor,Collections.singleton(myNamespaceToInsert),myNamespacePrefixToInsert,null);
    }
  }
}
