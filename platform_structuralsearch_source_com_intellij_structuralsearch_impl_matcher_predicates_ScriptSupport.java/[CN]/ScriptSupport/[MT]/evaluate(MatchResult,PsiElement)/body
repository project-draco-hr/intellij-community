{
  try {
    final Binding binding=new Binding();
    if (result != null) {
      for (      MatchResult r : result.getAllSons()) {
        if (r.isMultipleMatch()) {
          final ArrayList<PsiElement> elements=new ArrayList<PsiElement>();
          for (          MatchResult r2 : r.getAllSons()) {
            elements.add(StructuralSearchUtil.getParentIfIdentifier(r2.getMatch()));
          }
          binding.setVariable(r.getName(),elements);
        }
 else {
          binding.setVariable(r.getName(),StructuralSearchUtil.getParentIfIdentifier(r.getMatch()));
        }
      }
    }
    if (context == null) {
      context=result.getMatch();
    }
    context=StructuralSearchUtil.getParentIfIdentifier(context);
    binding.setVariable("__context__",context);
    script.setBinding(binding);
    Object o=script.run();
    return String.valueOf(o);
  }
 catch (  GroovyRuntimeException ex) {
    throw new StructuralSearchException(SSRBundle.message("groovy.script.error",ex.getMessage()));
  }
 finally {
    script.setBinding(null);
  }
}
