{
  if (myTabs.getPresentation().getTabsPosition() != JBTabsPosition.top && myTabs.getPresentation().getTabsPosition() != JBTabsPosition.bottom) {
    super.layoutLabelsAndGhosts(data);
    return;
  }
  int tabWidth=0;
  boolean layoutStopped=false;
  int lengthEstimation=0;
  for (  TabInfo eachInfo : data.toLayout) {
    final TabLabel label=myTabs.myInfo2Label.get(eachInfo);
    if (tabWidth == 0) {
      tabWidth=GraphicsUtil.stringWidth("m",label.getLabelComponent().getFont()) * 20;
    }
    lengthEstimation+=tabWidth;
  }
  double compressionFactor=(double)lengthEstimation / data.toFitLength;
  int spentLength=0;
  for (Iterator<TabInfo> iterator=data.toLayout.iterator(); iterator.hasNext(); ) {
    TabInfo eachInfo=iterator.next();
    final TabLabel label=myTabs.myInfo2Label.get(eachInfo);
    if (layoutStopped) {
      label.setActionPanelVisible(false);
      final Rectangle rec=getStrategy().getLayoutRect(data,0,0);
      myTabs.layout(label,rec);
      continue;
    }
    label.setActionPanelVisible(true);
    int length;
    if (compressionFactor > 1) {
      length=iterator.hasNext() ? (int)(tabWidth * (float)data.toFitLength / lengthEstimation) : data.toFitLength - spentLength - data.toLayout.size() / 2;
      spentLength+=length;
    }
 else {
      length=tabWidth;
    }
    boolean continueLayout=applyTabLayout(data,label,length,0);
    data.position=getStrategy().getMaxPosition(label.getBounds());
    data.position+=myTabs.getInterTabSpaceLength();
    if (!continueLayout) {
      layoutStopped=true;
    }
  }
  for (  TabInfo eachInfo : data.toDrop) {
    JBTabsImpl.resetLayout(myTabs.myInfo2Label.get(eachInfo));
  }
}
