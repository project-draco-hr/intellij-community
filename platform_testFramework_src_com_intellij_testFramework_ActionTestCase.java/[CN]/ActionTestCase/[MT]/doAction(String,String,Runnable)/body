{
  int[] caretAndSelectionPositionInSourceFile=EditorTestUtil.getCaretAndSelectionPosition(before);
  int[] caretAndSelectionPositionInExpectedFile=EditorTestUtil.getCaretAndSelectionPosition(expected);
  final String sourceFinal=before.replaceAll(CARET_TAG_REPLACE_REGEX,"").replace(EditorTestUtil.SELECTION_START_TAG,"").replace(EditorTestUtil.SELECTION_END_TAG,"");
  final String expectedFinal=expected.replaceAll(CARET_TAG_REPLACE_REGEX,"").replace(EditorTestUtil.SELECTION_START_TAG,"").replace(EditorTestUtil.SELECTION_END_TAG,"");
  final PsiFile file=myFixture.configureByText(getFileType(),sourceFinal);
  myFixture.getEditor().getSettings().setVirtualSpace(true);
  if (caretAndSelectionPositionInSourceFile[0] >= 0) {
    CaretModel caretModel=myFixture.getEditor().getCaretModel();
    caretModel.moveToOffset(caretAndSelectionPositionInSourceFile[0]);
    if (caretAndSelectionPositionInSourceFile[1] != 0) {
      int line=caretModel.getVisualPosition().getLine();
      int column=caretModel.getVisualPosition().getColumn();
      caretModel.moveToVisualPosition(new VisualPosition(line,column + caretAndSelectionPositionInSourceFile[1]));
    }
  }
  if (caretAndSelectionPositionInSourceFile[2] >= 0) {
    myFixture.getEditor().getSelectionModel().setSelection(caretAndSelectionPositionInSourceFile[2],caretAndSelectionPositionInSourceFile[3]);
  }
  ApplicationManager.getApplication().runWriteAction(action);
  if (caretAndSelectionPositionInExpectedFile[0] >= 0) {
    assertEquals(caretAndSelectionPositionInExpectedFile[0],myFixture.getCaretOffset());
    if (caretAndSelectionPositionInExpectedFile[1] != 0) {
      assertEquals(caretAndSelectionPositionInExpectedFile[1],myFixture.getEditor().getCaretModel().getVisualPosition().getColumn());
    }
  }
  if (caretAndSelectionPositionInExpectedFile[2] >= 0) {
    assertEquals(caretAndSelectionPositionInExpectedFile[2],myFixture.getEditor().getSelectionModel().getSelectionStart());
    assertEquals(caretAndSelectionPositionInExpectedFile[3],myFixture.getEditor().getSelectionModel().getSelectionEnd());
  }
  assertEquals(expectedFinal,myFixture.getDocument(file).getText());
}
