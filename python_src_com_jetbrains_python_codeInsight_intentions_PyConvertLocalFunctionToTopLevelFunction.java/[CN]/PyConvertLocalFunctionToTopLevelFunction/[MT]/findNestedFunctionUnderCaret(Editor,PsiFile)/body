{
  if (!(file instanceof PyFile))   return null;
  final PsiElement element=PyUtil.findNonWhitespaceAtOffset(file,editor.getCaretModel().getOffset());
  if (element == null) {
    return null;
  }
  PyFunction result=null;
  if (isLocalFunction(element.getParent()) && ((PyFunction)element.getParent()).getNameIdentifier() == element) {
    result=(PyFunction)element.getParent();
  }
 else {
    final PyReferenceExpression refExpr=PsiTreeUtil.getParentOfType(element,PyReferenceExpression.class);
    if (refExpr == null) {
      return null;
    }
    final PsiElement resolved=refExpr.getReference().resolve();
    if (isLocalFunction(resolved)) {
      result=(PyFunction)resolved;
    }
  }
  if (result != null) {
    final VirtualFile virtualFile=result.getContainingFile().getVirtualFile();
    if (virtualFile != null && ProjectRootManager.getInstance(file.getProject()).getFileIndex().isInLibraryClasses(virtualFile)) {
      return null;
    }
  }
  return result;
}
