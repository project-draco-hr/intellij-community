{
  final HintManagerImpl hintManager=HintManagerImpl.getInstanceImpl();
  final JPanel editorFragmentPreviewPanel=new JPanel(){
    private static final int R=6;
    private BufferedImage myImage=null;
    @Override public Dimension getPreferredSize(){
      int width=myEditor.getGutterComponentEx().getWidth();
      width+=Math.min(myEditor.getScrollingModel().getVisibleArea().width,myEditor.getContentComponent().getWidth());
      return new Dimension(width - 6,myEditor.getLineHeight() * (myPreviewLines * 2 + 1));
    }
    @Override protected void paintComponent(    Graphics g){
      if (myImage == null) {
        Dimension size=getPreferredSize();
        myImage=UIUtil.createImage(size.width,size.height,BufferedImage.TYPE_INT_RGB);
        Graphics graphics=myImage.getGraphics();
        Graphics2D g2d=(Graphics2D)graphics;
        UISettings.setupAntialiasing(graphics);
        int lineShift=-myEditor.getLineHeight() * (myLine - myPreviewLines);
        int popupStartOffset=myEditor.getDocument().getLineStartOffset(Math.max(0,myLine - myPreviewLines));
        int popupEndOffset=myEditor.getDocument().getLineEndOffset(Math.min(myEditor.getDocument().getLineCount() - 1,myLine + myPreviewLines));
        List<RangeHighlighterEx> exs=new ArrayList<RangeHighlighterEx>();
        for (        RangeHighlighterEx rangeHighlighter : myHighlighters) {
          if (rangeHighlighter.getEndOffset() > popupStartOffset && rangeHighlighter.getStartOffset() < popupEndOffset) {
            exs.add(rangeHighlighter);
          }
        }
        g2d.setTransform(AffineTransform.getTranslateInstance(5 - myMouseX,lineShift));
        EditorGutterComponentEx gutterComponentEx=myEditor.getGutterComponentEx();
        int width=gutterComponentEx.getWidth();
        graphics.setClip(0,0,width,gutterComponentEx.getHeight());
        gutterComponentEx.paint(graphics);
        JComponent contentComponent=myEditor.getContentComponent();
        graphics.setClip(width,0,contentComponent.getWidth(),contentComponent.getHeight());
        g2d.setTransform(AffineTransform.getTranslateInstance(width + 5 - myMouseX,lineShift));
        contentComponent.paint(graphics);
        Collections.sort(exs,new Comparator<RangeHighlighterEx>(){
          @Override public int compare(          RangeHighlighterEx ex1,          RangeHighlighterEx ex2){
            LogicalPosition startPos1=myEditor.offsetToLogicalPosition(ex1.getAffectedAreaStartOffset());
            LogicalPosition startPos2=myEditor.offsetToLogicalPosition(ex2.getAffectedAreaStartOffset());
            if (startPos1.line != startPos2.line)             return 0;
            return startPos1.column - startPos2.column;
          }
        }
);
        TIntIntHashMap rightEdges=new TIntIntHashMap();
        for (        RangeHighlighterEx ex : exs) {
          int hStartOffset=ex.getAffectedAreaStartOffset();
          Object tooltip=ex.getErrorStripeTooltip();
          if (tooltip == null)           continue;
          String s=String.valueOf(tooltip);
          if (s.isEmpty())           continue;
          LogicalPosition logicalPosition=myEditor.offsetToLogicalPosition(hStartOffset);
          Point placeToShow=myEditor.logicalPositionToXY(logicalPosition);
          placeToShow.y+=myEditor.getLineHeight() * 3 / 2;
          int w=graphics.getFontMetrics().stringWidth(s);
          int a=graphics.getFontMetrics().getAscent();
          int h=myEditor.getLineHeight();
          int rightEdge=rightEdges.get(logicalPosition.line);
          placeToShow.x=Math.max(placeToShow.x,rightEdge);
          rightEdge=Math.max(rightEdge,placeToShow.x + w + 3 * R);
          rightEdges.put(logicalPosition.line,rightEdge);
          GraphicsUtil.setupAAPainting(graphics);
          graphics.setColor(MessageType.WARNING.getPopupBackground());
          graphics.fillRoundRect(placeToShow.x - R,placeToShow.y - a,w + 2 * R,h,R,R);
          graphics.setColor(new JBColor(JBColor.GRAY,Gray._200));
          graphics.drawRoundRect(placeToShow.x - R,placeToShow.y - a,w + 2 * R,h,R,R);
          graphics.setColor(JBColor.foreground());
          graphics.drawString(s,placeToShow.x,placeToShow.y + 2);
        }
      }
      UIUtil.drawImage(g,myImage,0,0,this);
    }
  }
;
  editorFragmentPreviewPanel.setBackground(myEditor.getBackgroundColor());
  editorFragmentPreviewPanel.setOpaque(true);
  LightweightHint hint=new LightweightHint(editorFragmentPreviewPanel);
  hintInfo.setShowImmediately(true);
  hintManager.showEditorHint(hint,editor,hintInfo.getOriginalPoint(),HintManager.HIDE_BY_ANY_KEY | HintManager.HIDE_BY_TEXT_CHANGE | HintManager.HIDE_BY_MOUSEOVER| HintManager.HIDE_BY_ESCAPE| HintManager.HIDE_BY_LOOKUP_ITEM_CHANGE| HintManager.HIDE_BY_OTHER_HINT| HintManager.HIDE_BY_SCROLLING,0,false,hintInfo);
  myEditorPreviewHint=hint;
  return hint;
}
