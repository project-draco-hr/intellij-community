{
  final IElementType parentType=myNode.getElementType();
  final ASTNode grandParentNode=myNode.getTreeParent();
  final IElementType grandparentType=grandParentNode == null ? null : grandParentNode.getElementType();
  final IElementType childType=child.getElementType();
  Wrap wrap=null;
  Indent childIndent=Indent.getNoneIndent();
  Alignment childAlignment=null;
  if (parentType == PyElementTypes.BINARY_EXPRESSION && !isInControlStatement()) {
    childAlignment=getAlignmentForChildren();
    PyBlock p=myParent;
    while (p != null) {
      final ASTNode pNode=p.getNode();
      if (ourListElementTypes.contains(pNode.getElementType())) {
        if (needListAlignment(child) && !myEmptySequence) {
          childAlignment=p.getChildAlignment();
          break;
        }
      }
 else       if (pNode == PyElementTypes.BINARY_EXPRESSION) {
        childAlignment=p.getChildAlignment();
      }
      if (!breaksAlignment(pNode.getElementType())) {
        p=p.myParent;
      }
 else {
        break;
      }
    }
  }
  if (childType == PyElementTypes.STATEMENT_LIST) {
    if (hasLineBreaksBeforeInSameParent(child,1) || needLineBreakInStatement()) {
      childIndent=Indent.getNormalIndent();
    }
  }
 else   if (childType == PyElementTypes.IMPORT_ELEMENT) {
    wrap=Wrap.createWrap(WrapType.NORMAL,true);
    childIndent=Indent.getNormalIndent();
  }
  if (childType == PyTokenTypes.END_OF_LINE_COMMENT && parentType == PyElementTypes.FROM_IMPORT_STATEMENT) {
    childIndent=Indent.getNormalIndent();
  }
  if (ourListElementTypes.contains(parentType)) {
    if ((parentType != PyElementTypes.TUPLE_EXPRESSION || grandparentType == PyElementTypes.PARENTHESIZED_EXPRESSION) && !ourBrackets.contains(childType) && childType != PyTokenTypes.COMMA && !isSliceOperand(child)) {
      wrap=Wrap.createWrap(WrapType.NORMAL,true);
    }
    if (needListAlignment(child) && !myEmptySequence) {
      childAlignment=getAlignmentForChildren();
    }
    if (childType == PyTokenTypes.END_OF_LINE_COMMENT) {
      childIndent=Indent.getNormalIndent();
    }
  }
 else   if (parentType == PyElementTypes.BINARY_EXPRESSION && (PythonDialectsTokenSetProvider.INSTANCE.getExpressionTokens().contains(childType) || PyTokenTypes.OPERATIONS.contains(childType))) {
    if (isInControlStatement()) {
      final PyParenthesizedExpression parens=PsiTreeUtil.getParentOfType(myNode.getPsi(),PyParenthesizedExpression.class,true,PyStatementPart.class);
      childIndent=parens != null ? Indent.getNormalIndent() : Indent.getContinuationIndent();
    }
  }
  PyCodeStyleSettings settings=CodeStyleSettingsManager.getSettings(child.getPsi().getProject()).getCustomSettings(PyCodeStyleSettings.class);
  if (parentType == PyElementTypes.LIST_LITERAL_EXPRESSION || parentType == PyElementTypes.LIST_COMP_EXPRESSION) {
    if (childType == PyTokenTypes.RBRACKET || childType == PyTokenTypes.LBRACKET) {
      childIndent=Indent.getNoneIndent();
    }
 else {
      childIndent=Indent.getNormalIndent();
    }
  }
 else   if (parentType == PyElementTypes.DICT_LITERAL_EXPRESSION || parentType == PyElementTypes.SET_LITERAL_EXPRESSION || parentType == PyElementTypes.SET_COMP_EXPRESSION || parentType == PyElementTypes.DICT_COMP_EXPRESSION) {
    if (childType == PyTokenTypes.RBRACE || !hasLineBreaksBeforeInSameParent(child,1)) {
      childIndent=Indent.getNoneIndent();
    }
 else {
      childIndent=Indent.getNormalIndent();
    }
  }
 else   if (parentType == PyElementTypes.STRING_LITERAL_EXPRESSION) {
    if (PyTokenTypes.STRING_NODES.contains(childType)) {
      childAlignment=getAlignmentForChildren();
    }
  }
 else   if (parentType == PyElementTypes.FROM_IMPORT_STATEMENT) {
    if (myNode.findChildByType(PyTokenTypes.LPAR) != null) {
      if (childType == PyElementTypes.IMPORT_ELEMENT) {
        if (settings.ALIGN_MULTILINE_IMPORTS) {
          childAlignment=getAlignmentForChildren();
        }
 else {
          childIndent=Indent.getNormalIndent();
        }
      }
      if (childType == PyTokenTypes.RPAR) {
        childIndent=Indent.getNoneIndent();
        if (!hasHangingIndent(myNode.getPsi())) {
          childAlignment=getAlignmentForChildren();
        }
      }
    }
  }
 else   if (isValueOfKeyValuePair(child)) {
    childIndent=Indent.getNormalIndent();
  }
 else   if (!hasHangingIndent(myNode.getPsi()) && ((parentType == PyElementTypes.PARENTHESIZED_EXPRESSION && myContext.getSettings().ALIGN_MULTILINE_PARENTHESIZED_EXPRESSION) || (parentType == PyElementTypes.ARGUMENT_LIST && myContext.getSettings().ALIGN_MULTILINE_PARAMETERS_IN_CALLS) || (parentType == PyElementTypes.PARAMETER_LIST && myContext.getSettings().ALIGN_MULTILINE_PARAMETERS)) && !isIndentNext(child)&& !hasLineBreaksBeforeInSameParent(myNode.getFirstChildNode(),1)&& !ourListElementTypes.contains(childType)) {
    if (!ourBrackets.contains(childType)) {
      childAlignment=getAlignmentForChildren();
      if (parentType != PyElementTypes.CALL_EXPRESSION) {
        childIndent=Indent.getNormalIndent();
      }
    }
 else     if (childType == PyTokenTypes.RPAR) {
      childIndent=Indent.getNoneIndent();
    }
  }
 else   if (parentType == PyElementTypes.GENERATOR_EXPRESSION || parentType == PyElementTypes.PARENTHESIZED_EXPRESSION) {
    if (childType == PyTokenTypes.RPAR || !hasLineBreaksBeforeInSameParent(child,1)) {
      childIndent=Indent.getNoneIndent();
    }
 else {
      childIndent=isIndentNext(child) ? Indent.getContinuationIndent() : Indent.getNormalIndent();
    }
  }
 else   if (parentType == PyElementTypes.ARGUMENT_LIST || parentType == PyElementTypes.PARAMETER_LIST) {
    if (childType == PyTokenTypes.RPAR) {
      childIndent=Indent.getNoneIndent();
    }
 else {
      if (parentType == PyElementTypes.PARAMETER_LIST || argumentMayHaveSameIndentAsFollowingStatementList()) {
        childIndent=Indent.getContinuationIndent();
      }
 else {
        childIndent=Indent.getNormalIndent();
      }
    }
  }
 else   if (parentType == PyElementTypes.SUBSCRIPTION_EXPRESSION) {
    final PyExpression indexExpression=((PySubscriptionExpression)myNode.getPsi()).getIndexExpression();
    if (indexExpression != null && child == indexExpression.getNode()) {
      childIndent=Indent.getNormalIndent();
    }
  }
 else   if (parentType == PyElementTypes.REFERENCE_EXPRESSION) {
    if (child != myNode.getFirstChildNode()) {
      childIndent=Indent.getNormalIndent();
      if (hasLineBreaksBeforeInSameParent(child,1)) {
        if (isInControlStatement()) {
          childIndent=Indent.getContinuationIndent();
        }
 else {
          PyBlock b=myParent;
          while (b != null) {
            if (b.getNode().getPsi() instanceof PyParenthesizedExpression || b.getNode().getPsi() instanceof PyArgumentList || b.getNode().getPsi() instanceof PyParameterList) {
              childAlignment=getAlignmentOfChild(b,1);
              break;
            }
            b=b.myParent;
          }
        }
      }
    }
  }
  if (childType == PyElementTypes.KEY_VALUE_EXPRESSION && isChildOfDictLiteral(child)) {
    wrap=myDictWrapping;
    childIndent=Indent.getNormalIndent();
  }
  if (isAfterStatementList(child) && !hasLineBreaksBeforeInSameParent(child,2) && child.getElementType() != PyTokenTypes.END_OF_LINE_COMMENT) {
    childIndent=Indent.getNormalIndent();
  }
  if (settings.DICT_ALIGNMENT == DICT_ALIGNMENT_ON_VALUE) {
    if (isValueOfKeyValuePairOfDictLiteral(child) && !ourListElementTypes.contains(childType)) {
      childAlignment=myParent.myDictAlignment;
    }
 else     if (isValueOfKeyValuePairOfDictLiteral(myNode) && ourListElementTypes.contains(parentType) && PyTokenTypes.OPEN_BRACES.contains(childType)) {
      childAlignment=myParent.myParent.myDictAlignment;
    }
  }
 else   if (myContext.getPySettings().DICT_ALIGNMENT == DICT_ALIGNMENT_ON_COLON) {
    if (isChildOfKeyValuePairOfDictLiteral(child) && childType == PyTokenTypes.COLON) {
      childAlignment=myParent.myDictAlignment;
    }
  }
  ASTNode prev=child.getTreePrev();
  while (prev != null && prev.getElementType() == TokenType.WHITE_SPACE) {
    if (prev.textContains('\\') && !childIndent.equals(Indent.getContinuationIndent(false)) && !childIndent.equals(Indent.getContinuationIndent(true))) {
      childIndent=isIndentNext(child) ? Indent.getContinuationIndent() : Indent.getNormalIndent();
      break;
    }
    prev=prev.getTreePrev();
  }
  return new PyBlock(this,child,childAlignment,childIndent,wrap,myContext);
}
