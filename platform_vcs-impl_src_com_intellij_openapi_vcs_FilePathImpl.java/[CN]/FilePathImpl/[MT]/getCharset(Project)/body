{
  VirtualFile existing=myVirtualFile != null && myVirtualFile.isValid() ? myVirtualFile : null;
  if (existing == null) {
    LocalFileSystem lfs=LocalFileSystem.getInstance();
    for (File f=myFile; f != null; f=f.getParentFile()) {
      existing=lfs.findFileByIoFile(f);
      if (existing != null && existing.isValid()) {
        break;
      }
    }
  }
  if (existing != null) {
    return existing.getCharset();
  }
  EncodingManager e=project == null ? EncodingManager.getInstance() : EncodingProjectManager.getInstance(project);
  return e.getDefaultCharset();
}
