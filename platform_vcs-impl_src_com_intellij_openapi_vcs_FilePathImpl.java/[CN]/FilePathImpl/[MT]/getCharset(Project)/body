{
  VirtualFile virtualFile=getVirtualFile();
  VirtualFile existing=virtualFile != null && virtualFile.isValid() ? virtualFile : null;
  if (existing == null) {
    LocalFileSystem lfs=LocalFileSystem.getInstance();
    for (File f=myFile; f != null; f=f.getParentFile()) {
      existing=lfs.findFileByIoFile(f);
      if (existing != null && existing.isValid()) {
        break;
      }
    }
  }
  if (existing != null) {
    Charset rc=existing.getCharset();
    if (rc != null) {
      return rc;
    }
  }
  EncodingManager e=project != null ? EncodingProjectManager.getInstance(project) : null;
  if (e == null) {
    e=EncodingManager.getInstance();
  }
  return e.getDefaultCharset();
}
