{
  PsiElementFactory factory=JavaPsiFacade.getInstance(expr.getProject()).getElementFactory();
  PsiType type=getTypeByExpression(expr,factory);
  final boolean isFunctionalType=type instanceof PsiLambdaExpressionType || type instanceof PsiMethodReferenceType || type instanceof PsiLambdaParameterType;
  final boolean isDenotable=PsiTypesUtil.isDenotableType(expr.getType());
  if (type != null && !isFunctionalType && isDenotable) {
    return type;
  }
  ExpectedTypeInfo[] expectedTypes=ExpectedTypesProvider.getInstance(expr.getProject()).getExpectedTypes(expr,false);
  if (expectedTypes.length == 1 || (isFunctionalType || !isDenotable) && expectedTypes.length > 0) {
    type=expectedTypes[0].getType();
    if (!type.equalsToText(CommonClassNames.JAVA_LANG_OBJECT))     return type;
  }
  if (!isDenotable) {
    return type;
  }
  return null;
}
