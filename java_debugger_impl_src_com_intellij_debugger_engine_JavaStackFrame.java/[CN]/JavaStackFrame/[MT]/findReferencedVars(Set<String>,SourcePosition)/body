{
  final int line=position.getLine();
  if (line < 0) {
    return Pair.create(Collections.<String>emptySet(),Collections.<TextWithImports>emptySet());
  }
  final PsiFile positionFile=position.getFile();
  if (!positionFile.getLanguage().isKindOf(JavaLanguage.INSTANCE)) {
    return Pair.create(visibleVars,Collections.<TextWithImports>emptySet());
  }
  final VirtualFile vFile=positionFile.getVirtualFile();
  final Document doc=vFile != null ? FileDocumentManager.getInstance().getDocument(vFile) : null;
  if (doc == null || doc.getLineCount() == 0 || line > (doc.getLineCount() - 1)) {
    return Pair.create(Collections.<String>emptySet(),Collections.<TextWithImports>emptySet());
  }
  final TextRange limit=calculateLimitRange(positionFile,doc,line);
  int startLine=Math.max(limit.getStartOffset(),line - 1);
  startLine=Math.min(startLine,limit.getEndOffset());
  while (startLine > limit.getStartOffset() && shouldSkipLine(positionFile,doc,startLine)) {
    startLine--;
  }
  final int startOffset=doc.getLineStartOffset(startLine);
  int endLine=Math.min(line + 2,limit.getEndOffset());
  while (endLine < limit.getEndOffset() && shouldSkipLine(positionFile,doc,endLine)) {
    endLine++;
  }
  final int endOffset=doc.getLineEndOffset(endLine);
  final TextRange lineRange=new TextRange(startOffset,endOffset);
  if (!lineRange.isEmpty()) {
    final int offset=CharArrayUtil.shiftForward(doc.getCharsSequence(),doc.getLineStartOffset(line)," \t");
    PsiElement element=positionFile.findElementAt(offset);
    if (element != null && element.isValid()) {
      PsiMethod method=PsiTreeUtil.getNonStrictParentOfType(element,PsiMethod.class);
      if (method != null) {
        element=method;
      }
 else {
        PsiField field=PsiTreeUtil.getNonStrictParentOfType(element,PsiField.class);
        if (field != null) {
          element=field;
        }
 else {
          final PsiClassInitializer initializer=PsiTreeUtil.getNonStrictParentOfType(element,PsiClassInitializer.class);
          if (initializer != null) {
            element=initializer;
          }
        }
      }
      if (element instanceof PsiCompiledElement || !element.isValid()) {
        return Pair.create(visibleVars,Collections.<TextWithImports>emptySet());
      }
 else {
        VariablesCollector collector=new VariablesCollector(visibleVars,adjustRange(element,lineRange));
        element.accept(collector);
        return Pair.create(collector.getVars(),collector.getExpressions());
      }
    }
  }
  return Pair.create(Collections.<String>emptySet(),Collections.<TextWithImports>emptySet());
}
