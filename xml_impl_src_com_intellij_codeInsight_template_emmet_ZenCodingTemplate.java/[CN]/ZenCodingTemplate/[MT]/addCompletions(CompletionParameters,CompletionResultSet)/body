{
  if (!parameters.isAutoPopup()) {
    return;
  }
  PsiFile file=parameters.getPosition().getContainingFile();
  int offset=parameters.getOffset();
  Editor editor=parameters.getEditor();
  ZenCodingGenerator generator=findApplicableDefaultGenerator(CustomTemplateCallback.getContext(file,offset),false);
  if (generator != null && generator.hasCompletionItem()) {
    final Ref<TemplateImpl> generatedTemplate=new Ref<TemplateImpl>();
    final CustomTemplateCallback callback=new CustomTemplateCallback(editor,file,false){
      @Override public void deleteTemplateKey(      @NotNull String key){
      }
      @Override public void startTemplate(      @NotNull Template template,      Map<String,String> predefinedValues,      TemplateEditingListener listener){
        if (template instanceof TemplateImpl && !((TemplateImpl)template).isDeactivated()) {
          generatedTemplate.set((TemplateImpl)template);
        }
      }
    }
;
    final String templatePrefix=computeTemplateKeyWithoutContextChecking(callback);
    if (templatePrefix != null) {
      List<TemplateImpl> regularTemplates=TemplateManagerImpl.listApplicableTemplates(file,offset,false);
      boolean regularTemplateWithSamePrefixExists=!ContainerUtil.filter(regularTemplates,new Condition<TemplateImpl>(){
        @Override public boolean value(        TemplateImpl template){
          return templatePrefix.equals(template.getKey());
        }
      }
).isEmpty();
      if (!regularTemplateWithSamePrefixExists) {
        final Collection<SingleLineEmmetFilter> extraFilters=ContainerUtil.newLinkedList(new SingleLineEmmetFilter());
        expand(templatePrefix,callback,null,generator,extraFilters,false,0);
        if (!generatedTemplate.isNull()) {
          final TemplateImpl template=generatedTemplate.get();
          template.setKey(templatePrefix);
          template.setDescription(template.getTemplateText());
          CompletionResultSet resultSet=result.withPrefixMatcher(result.getPrefixMatcher().cloneWithPrefix(templatePrefix));
          resultSet.restartCompletionOnPrefixChange(StandardPatterns.string().startsWith(templatePrefix));
          resultSet.addElement(generator.createLookupElement(this,template));
        }
      }
    }
  }
}
