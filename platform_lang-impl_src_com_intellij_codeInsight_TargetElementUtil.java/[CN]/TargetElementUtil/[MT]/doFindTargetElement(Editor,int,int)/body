{
  Project project=editor.getProject();
  if (project == null)   return null;
  if (BitUtil.isSet(flags,LOOKUP_ITEM_ACCEPTED)) {
    PsiElement element=getTargetElementFromLookup(project);
    if (element != null) {
      return element;
    }
  }
  Document document=editor.getDocument();
  PsiFile file=getFile(project,document);
  if (file == null)   return null;
  offset=adjustOffset(file,document,offset);
  PsiElement element=file.findElementAt(offset);
  if (BitUtil.isSet(flags,REFERENCED_ELEMENT_ACCEPTED)) {
    final PsiElement referenceOrReferencedElement=getReferenceOrReferencedElement(file,editor,flags,offset);
    if (isAcceptableReferencedElement(element,referenceOrReferencedElement)) {
      return referenceOrReferencedElement;
    }
  }
  if (element == null)   return null;
  if (BitUtil.isSet(flags,ELEMENT_NAME_ACCEPTED)) {
    if (element instanceof PsiNamedElement)     return element;
    return getNamedElement(element,offset - element.getTextRange().getStartOffset());
  }
  return null;
}
