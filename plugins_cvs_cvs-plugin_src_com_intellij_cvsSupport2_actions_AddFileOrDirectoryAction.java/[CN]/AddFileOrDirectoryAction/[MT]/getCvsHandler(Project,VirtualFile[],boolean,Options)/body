{
  final ArrayList<VirtualFile> filesToAdd=collectFilesToAdd(files);
  if (filesToAdd.isEmpty())   return CvsHandler.NULL;
  LOG.assertTrue(!filesToAdd.isEmpty());
  final Collection<AddedFileInfo> roots=new CreateTreeOnFileList(filesToAdd,project).getRoots();
  if (roots.isEmpty()) {
    LOG.error(filesToAdd);
  }
  if (!showDialog) {
    return CommandCvsHandler.createAddFilesHandler(project,roots);
  }
  final Ref<CvsHandler> handler=new Ref<CvsHandler>();
  final Runnable runnable=new Runnable(){
    @Override public void run(){
      final AbstractAddOptionsDialog dialog=AbstractAddOptionsDialog.createDialog(project,roots,dialogOptions);
      handler.set(!dialog.showAndGet() ? CvsHandler.NULL : CommandCvsHandler.createAddFilesHandler(project,roots));
    }
  }
;
  ApplicationManager.getApplication().invokeAndWait(runnable,ModalityState.any());
  return handler.get();
}
