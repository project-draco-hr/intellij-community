{
  final IpnbFile ipnbFile=ipnbPanel.getIpnbFile();
  if (ipnbFile == null)   return null;
  for (  IpnbEditablePanel panel : ipnbPanel.getIpnbPanels()) {
    if (panel.isModified()) {
      panel.updateCellSource();
    }
  }
  final IpnbFileRaw fileRaw=ipnbFile.getRawFile();
  if (fileRaw.nbformat == 4) {
    fileRaw.cells.clear();
    for (    IpnbCell cell : ipnbFile.getCells()) {
      fileRaw.cells.add(IpnbCellRaw.fromCell(cell,fileRaw.nbformat));
    }
  }
 else {
    final IpnbWorksheet worksheet=new IpnbWorksheet();
    worksheet.cells.clear();
    for (    IpnbCell cell : ipnbFile.getCells()) {
      worksheet.cells.add(IpnbCellRaw.fromCell(cell,fileRaw.nbformat));
    }
    fileRaw.worksheets=new IpnbWorksheet[]{worksheet};
  }
  final StringWriter stringWriter=new StringWriter();
  final JsonWriter writer=new JsonWriter(stringWriter);
  writer.setIndent(" ");
  gson.toJson(fileRaw,fileRaw.getClass(),writer);
  return stringWriter.toString();
}
