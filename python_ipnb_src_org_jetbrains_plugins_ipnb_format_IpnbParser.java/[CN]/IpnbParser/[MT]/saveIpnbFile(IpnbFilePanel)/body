{
  final IpnbFile ipnbFile=ipnbPanel.getIpnbFile();
  if (ipnbFile == null)   return;
  for (  IpnbEditablePanel panel : ipnbPanel.getIpnbPanels()) {
    if (panel.isModified()) {
      panel.updateCellSource();
    }
  }
  final IpnbFileRaw fileRaw=ipnbFile.getRawFile();
  final IpnbWorksheet worksheet=new IpnbWorksheet();
  final ArrayList<IpnbCellRaw> cellRaws=new ArrayList<IpnbCellRaw>();
  for (  IpnbCell cell : ipnbFile.getCells()) {
    cellRaws.add(IpnbCellRaw.fromCell(cell));
  }
  worksheet.cells=cellRaws.toArray(new IpnbCellRaw[cellRaws.size()]);
  fileRaw.worksheets=new IpnbWorksheet[]{worksheet};
  final String json=gson.toJson(fileRaw);
  final String path=ipnbFile.getPath();
  final File file=new File(path);
  FileWriter writer=null;
  try {
    writer=new FileWriter(file);
    writer.write(json);
  }
 catch (  IOException e) {
    LOG.error(e);
  }
 finally {
    try {
      if (writer != null)       writer.close();
    }
 catch (    IOException e) {
      LOG.error(e);
    }
  }
}
