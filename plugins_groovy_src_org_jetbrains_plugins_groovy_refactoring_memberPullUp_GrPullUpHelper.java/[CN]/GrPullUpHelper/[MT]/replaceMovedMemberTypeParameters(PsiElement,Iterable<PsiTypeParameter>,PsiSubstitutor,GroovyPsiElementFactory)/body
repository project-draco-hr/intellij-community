{
  final Map<PsiElement,PsiElement> replacement=new LinkedHashMap<PsiElement,PsiElement>();
  for (  PsiTypeParameter parameter : parametersIterable) {
    PsiType substitutedType=substitutor.substitute(parameter);
    if (substitutedType == null) {
      substitutedType=TypeConversionUtil.erasure(factory.createType(parameter));
    }
    PsiElement scopeElement=member instanceof GrField ? member.getParent() : member;
    for (    PsiReference reference : ReferencesSearch.search(parameter,new LocalSearchScope(scopeElement))) {
      final PsiElement element=reference.getElement();
      final PsiElement parent=element.getParent();
      if (parent instanceof PsiTypeElement) {
        replacement.put(parent,factory.createTypeElement(substitutedType));
      }
 else       if (element instanceof GrCodeReferenceElement && substitutedType instanceof PsiClassType) {
        replacement.put(element,factory.createReferenceElementByType((PsiClassType)substitutedType));
      }
    }
  }
  for (  PsiElement element : replacement.keySet()) {
    if (element.isValid()) {
      element.replace(replacement.get(element));
    }
  }
}
