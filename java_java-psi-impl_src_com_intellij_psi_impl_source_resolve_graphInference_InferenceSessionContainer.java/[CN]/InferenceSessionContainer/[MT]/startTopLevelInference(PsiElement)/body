{
  final PsiCall topLevelCall=treeWalkUp(parent);
  if (topLevelCall != null) {
    final JavaResolveResult result=topLevelCall.resolveMethodGenerics();
    if (result instanceof MethodCandidateInfo) {
      final PsiMethod method=((MethodCandidateInfo)result).getElement();
      final PsiParameter[] topLevelParameters=method.getParameterList().getParameters();
      final PsiExpressionList topLevelCallArgumentList=topLevelCall.getArgumentList();
      LOG.assertTrue(topLevelCallArgumentList != null,topLevelCall);
      final PsiExpression[] topLevelArguments=topLevelCallArgumentList.getExpressions();
      final InferenceSession topLevelSession=new InferenceSession(method.getTypeParameters(),((MethodCandidateInfo)result).getSiteSubstitutor(),topLevelCall.getManager(),topLevelCall);
      topLevelSession.initExpressionConstraints(topLevelParameters,topLevelArguments,topLevelCall,method,((MethodCandidateInfo)result).isVarargs());
      topLevelSession.infer(topLevelParameters,topLevelArguments,topLevelCall,((MethodCandidateInfo)result).createProperties());
      final Map<PsiElement,InitialInferenceState> nestedStates=new LinkedHashMap<PsiElement,InitialInferenceState>();
      final InferenceSessionContainer copy=new InferenceSessionContainer(){
        @Override public PsiSubstitutor findNestedSubstitutor(        PsiElement arg,        @Nullable PsiSubstitutor defaultSession){
          final InitialInferenceState state=nestedStates.get(PsiTreeUtil.getParentOfType(arg,PsiCall.class));
          if (state != null) {
            return state.getInferenceSubstitutor();
          }
          return super.findNestedSubstitutor(arg,defaultSession);
        }
      }
;
      final Map<PsiElement,InferenceSession> nestedSessions=topLevelSession.getInferenceSessionContainer().myNestedSessions;
      for (      Map.Entry<PsiElement,InferenceSession> entry : nestedSessions.entrySet()) {
        nestedStates.put(entry.getKey(),entry.getValue().createInitialState(copy));
      }
      PsiSubstitutor substitutor=PsiSubstitutor.EMPTY;
      for (      InferenceVariable variable : topLevelSession.getInferenceVariables()) {
        final PsiType instantiation=variable.getInstantiation();
        if (instantiation != PsiType.NULL) {
          substitutor=substitutor.put(variable,instantiation);
        }
      }
      return new CompoundInitialState(substitutor,nestedStates);
    }
  }
  return null;
}
