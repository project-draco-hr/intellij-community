{
  ensureTempDirCreated();
  String methodName=name.getMethodName();
  Matcher m=TEST_METHOD_NAME_PATTERN.matcher(methodName);
  if (m.matches()) {
    methodName=m.group(1);
  }
  testDir=new File(ourTempDir,methodName);
  FileUtil.ensureExists(testDir);
  FileUtil.writeToFile(new File(testDir,GradleConstants.DEFAULT_SCRIPT_NAME),FileUtil.loadTextAndClose(getClass().getResourceAsStream("/" + methodName + "/"+ GradleConstants.DEFAULT_SCRIPT_NAME)));
  FileUtil.writeToFile(new File(testDir,GradleConstants.SETTINGS_FILE_NAME),FileUtil.loadTextAndClose(getClass().getResourceAsStream("/" + methodName + "/"+ GradleConstants.SETTINGS_FILE_NAME)));
  GradleConnector connector=GradleConnector.newConnector();
  String releaseRepoUrl=DistributionLocator.getRepoUrl(false);
  String snapshotRepoUrl=DistributionLocator.getRepoUrl(true);
  if (releaseRepoUrl == null || snapshotRepoUrl == null) {
    connector.useGradleVersion(gradleVersion);
  }
 else {
    final URI distributionUri=new DistributionLocator(releaseRepoUrl,snapshotRepoUrl).getDistributionFor(GradleVersion.version(gradleVersion));
    connector.useDistribution(distributionUri);
  }
  connector.forProjectDirectory(testDir);
  int daemonMaxIdleTime=1;
  try {
    daemonMaxIdleTime=Integer.parseInt(System.getProperty("gradleDaemonMaxIdleTime","1"));
  }
 catch (  NumberFormatException ignore) {
  }
  ((DefaultGradleConnector)connector).daemonMaxIdleTime(daemonMaxIdleTime,TimeUnit.SECONDS);
  ProjectConnection connection=connector.connect();
  final ProjectImportAction projectImportAction=new ProjectImportAction(false);
  projectImportAction.addExtraProjectModelClasses(getModels());
  BuildActionExecuter<ProjectImportAction.AllModels> buildActionExecutor=connection.action(projectImportAction);
  File initScript=GradleExecutionHelper.generateInitScript(false);
  assertNotNull(initScript);
  buildActionExecutor.withArguments(GradleConstants.INIT_SCRIPT_CMD_OPTION,initScript.getAbsolutePath());
  allModels=buildActionExecutor.run();
  assertNotNull(allModels);
}
