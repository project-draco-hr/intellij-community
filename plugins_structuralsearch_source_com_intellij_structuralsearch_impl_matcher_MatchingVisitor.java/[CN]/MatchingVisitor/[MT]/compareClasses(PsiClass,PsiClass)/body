{
  PsiClass saveClazz=this.clazz;
  MatchContext.UnmatchedElementsListener listener=matchContext.getUnmatchedElementsListener();
  this.clazz=clazz2;
  final PsiElement allRemainingClassContentElement=clazz.getUserData(CompiledPattern.ALL_CLASS_CONTENT_VAR_KEY);
  MatchContext.UnmatchedElementsListener mylistener=null;
  boolean result=false;
  if (allRemainingClassContentElement != null) {
    matchContext.setUnmatchedElementsListener(mylistener=new MatchContext.UnmatchedElementsListener(){
      private List<PsiElement> myUnmatchedList;
      public void matchedElements(      List<PsiElement> elementList){
        if (elementList != null) {
          if (myUnmatchedList == null)           myUnmatchedList=new LinkedList<PsiElement>(elementList);
 else           myUnmatchedList.addAll(elementList);
        }
      }
      public void commitUnmatched(){
        final SubstitutionHandler handler=(SubstitutionHandler)matchContext.getPattern().getHandler(allRemainingClassContentElement);
        for (PsiElement el=clazz2.getFirstChild(); el != null; el=el.getNextSibling()) {
          if (el instanceof PsiMember && (myUnmatchedList == null || myUnmatchedList.indexOf(el) == -1)) {
            handler.handle(el,matchContext);
          }
        }
      }
    }
);
  }
  try {
    final boolean templateIsInterface=clazz.isInterface();
    if (templateIsInterface != clazz2.isInterface())     return false;
    if (templateIsInterface && clazz.isAnnotationType() && !clazz2.isAnnotationType())     return false;
    final boolean templateIsEnum=clazz.isEnum();
    if (templateIsEnum && !clazz2.isEnum())     return false;
    if (!matchInAnyOrder(clazz.getExtendsList(),clazz2.getExtendsList())) {
      return false;
    }
    final PsiReferenceList implementsList=clazz.getImplementsList();
    if (implementsList != null) {
      if (!matchInAnyOrder(implementsList,clazz2.getImplementsList())) {
        final PsiReferenceList anotherExtendsList=clazz2.getExtendsList();
        final PsiJavaCodeReferenceElement[] referenceElements=implementsList.getReferenceElements();
        boolean accepted=false;
        if (referenceElements.length > 0 && anotherExtendsList != null) {
          final HierarchyNodeIterator iterator=new HierarchyNodeIterator(clazz2,true,true,false);
          accepted=matchInAnyOrder(new ArrayBackedNodeIterator(referenceElements),iterator);
        }
        if (!accepted)         return false;
      }
    }
    final PsiField[] fields=clazz.getFields();
    if (fields.length > 0) {
      final PsiField[] fields2;
      fields2=(matchContext.getPattern()).isRequestsSuperFields() ? clazz2.getAllFields() : clazz2.getFields();
      if (!matchInAnyOrder(fields,fields2)) {
        return false;
      }
    }
    final PsiMethod[] methods=clazz.getMethods();
    if (methods.length > 0) {
      final PsiMethod[] methods2;
      methods2=(matchContext.getPattern()).isRequestsSuperMethods() ? clazz2.getAllMethods() : clazz2.getMethods();
      if (!matchInAnyOrder(methods,methods2)) {
        return false;
      }
    }
    final PsiClass[] nestedClasses=clazz.getInnerClasses();
    if (nestedClasses.length > 0) {
      final PsiClass[] nestedClasses2=(matchContext.getPattern()).isRequestsSuperInners() ? clazz2.getAllInnerClasses() : clazz2.getInnerClasses();
      if (!matchInAnyOrder(nestedClasses,nestedClasses2)) {
        return false;
      }
    }
    final PsiClassInitializer[] initializers=clazz.getInitializers();
    if (initializers.length > 0) {
      final PsiClassInitializer[] initializers2=clazz2.getInitializers();
      if (!matchInAnyOrder(initializers,initializers2)) {
        return false;
      }
    }
    result=true;
    return result;
  }
  finally {
    if (result && mylistener != null)     mylistener.commitUnmatched();
    this.clazz=saveClazz;
    matchContext.setUnmatchedElementsListener(listener);
  }
}
