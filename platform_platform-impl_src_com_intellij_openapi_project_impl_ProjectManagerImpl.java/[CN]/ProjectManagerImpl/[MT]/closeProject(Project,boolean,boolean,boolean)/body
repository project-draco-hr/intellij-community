{
  if (isLight(project)) {
    if (!((ProjectImpl)project).isTemporarilyDisposed()) {
      ((ProjectImpl)project).setTemporarilyDisposed(true);
      removeFromOpened(project);
      return true;
    }
    ((ProjectImpl)project).setTemporarilyDisposed(false);
  }
 else {
    if (!isProjectOpened(project))     return true;
  }
  if (checkCanClose && !canClose(project))   return false;
  final ShutDownTracker shutDownTracker=ShutDownTracker.getInstance();
  shutDownTracker.registerStopperThread(Thread.currentThread());
  try {
    if (save) {
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          FileDocumentManager.getInstance().saveAllDocuments();
          project.save();
        }
      }
);
    }
    if (checkCanClose && !ensureCouldCloseIfUnableToSave(project)) {
      return false;
    }
    fireProjectClosing(project);
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        removeFromOpened(project);
synchronized (myChangedProjectFiles) {
          myChangedProjectFiles.remove(project);
        }
        fireProjectClosed(project);
        if (dispose) {
          Disposer.dispose(project);
        }
      }
    }
);
  }
  finally {
    shutDownTracker.unregisterStopperThread(Thread.currentThread());
  }
  return true;
}
