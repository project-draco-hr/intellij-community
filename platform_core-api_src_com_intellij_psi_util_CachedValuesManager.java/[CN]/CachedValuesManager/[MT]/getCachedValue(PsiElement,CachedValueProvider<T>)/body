{
  Key<CachedValue<T>> key=getKeyForClass(provider.getClass(),globalKeyForProvider);
  CachedValue<T> value=psi.getUserData(key);
  if (value != null) {
    return value.getValue();
  }
  return getManager(psi.getProject()).getCachedValue(psi,key,new CachedValueProvider<T>(){
    @Nullable @Override public Result<T> compute(){
      Result<T> result=provider.compute();
      if (result != null && !psi.isPhysical()) {
        PsiFile file=psi.getContainingFile();
        if (file != null) {
          return Result.create(result.getValue(),ArrayUtil.append(result.getDependencyItems(),file));
        }
      }
      return result;
    }
  }
,false);
}
