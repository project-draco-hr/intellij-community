{
  super(fileSpec,roamingType,pathMacroManager,rootElementName,streamProvider);
  if (ApplicationManager.getApplication().isUnitTestMode() && StringUtil.startsWithChar(file.getPath(),'$')) {
    throw new AssertionError("It seems like some macros were not expanded for path: " + file);
  }
  myFile=file;
  if (listener != null) {
    VirtualFileTracker virtualFileTracker=ServiceManager.getService(VirtualFileTracker.class);
    if (virtualFileTracker != null) {
      virtualFileTracker.addTracker(VfsUtilCore.pathToUrl(getFilePath()),new VirtualFileAdapter(){
        @Override public void fileMoved(        @NotNull VirtualFileMoveEvent event){
          myCachedVirtualFile=null;
        }
        @Override public void fileDeleted(        @NotNull VirtualFileEvent event){
          myCachedVirtualFile=null;
          listener.storageFileChanged(event,FileBasedStorage.this);
        }
        @Override public void fileCreated(        @NotNull VirtualFileEvent event){
          myCachedVirtualFile=event.getFile();
          listener.storageFileChanged(event,FileBasedStorage.this);
        }
        @Override public void contentsChanged(        @NotNull final VirtualFileEvent event){
          listener.storageFileChanged(event,FileBasedStorage.this);
        }
      }
,false,parentDisposable);
    }
  }
}
