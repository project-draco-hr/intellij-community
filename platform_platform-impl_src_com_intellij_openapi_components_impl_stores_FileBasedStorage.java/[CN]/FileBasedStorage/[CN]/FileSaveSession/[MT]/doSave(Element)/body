{
  if (ApplicationManager.getApplication().isUnitTestMode() && StringUtil.startsWithChar(myFile.getPath(),'$')) {
    throw new IOException("It seems like some macros were not expanded for path: " + myFile);
  }
  if (LOG.isDebugEnabled() && myFileSpec.equals(StoragePathMacros.MODULE_FILE)) {
    LOG.debug("doSave " + getFilePath());
  }
  if (myStreamProvider != null && myStreamProvider.getEnabled()) {
    saveForProvider(element == null ? null : StorageUtil.writeToBytes(element,LineSeparator.LF.getSeparatorString()),element);
  }
 else {
    if (myLineSeparator == null) {
      myLineSeparator=isUseXmlProlog() ? LineSeparator.LF : LineSeparator.getSystemLineSeparator();
    }
    VirtualFile virtualFile=getVirtualFile();
    if (element == null) {
      StorageUtil.deleteFile(myFile,this,virtualFile);
      myCachedVirtualFile=null;
    }
 else {
      myCachedVirtualFile=StorageUtil.writeFile(myFile,this,virtualFile,element,isUseXmlProlog() ? myLineSeparator : null);
    }
  }
}
