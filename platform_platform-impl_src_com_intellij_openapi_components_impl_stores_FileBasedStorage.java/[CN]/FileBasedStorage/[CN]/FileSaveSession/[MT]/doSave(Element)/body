{
  if (myLineSeparator == null) {
    myLineSeparator=isUseLfLineSeparatorByDefault() ? LineSeparator.LF : LineSeparator.getSystemLineSeparator();
  }
  BufferExposingByteArrayOutputStream content=element == null ? null : StorageUtil.writeToBytes(element,myLineSeparator.getSeparatorString());
  if (ApplicationManager.getApplication().isUnitTestMode() && StringUtil.startsWithChar(myFile.getPath(),'$')) {
    throw new IOException("It seems like some macros were not expanded for path: " + myFile);
  }
  try {
    if (myStreamProvider != null && myStreamProvider.getEnabled()) {
      saveForProvider(myLineSeparator == LineSeparator.LF ? content : null,element);
    }
  }
 catch (  Throwable e) {
    LOG.error(e);
  }
  if (LOG.isDebugEnabled() && myFileSpec.equals(StoragePathMacros.MODULE_FILE)) {
    LOG.debug("doSave " + getFilePath());
  }
  VirtualFile virtualFile=getVirtualFile();
  if (content == null) {
    StorageUtil.deleteFile(myFile,this,virtualFile);
    myCachedVirtualFile=null;
  }
 else {
    myCachedVirtualFile=StorageUtil.writeFile(myFile,this,virtualFile,content,isUseXmlProlog() ? myLineSeparator : null);
  }
}
