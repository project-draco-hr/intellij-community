{
  Set<VirtualFile> roots=dataPack.getLogProviders().keySet();
  Set<VirtualFile> selectedRoots=new HashSet<VirtualFile>();
  MultiMap<VirtualFile,VirtualFile> selectedFiles=new MultiMap<VirtualFile,VirtualFile>();
  for (  VirtualFile file : files) {
    if (roots.contains(file)) {
      selectedRoots.add(file);
    }
 else {
      VirtualFile candidateAncestorRoot=null;
      for (      VirtualFile root : roots) {
        if (VfsUtilCore.isAncestor(root,file,false)) {
          if (candidateAncestorRoot == null || VfsUtilCore.isAncestor(candidateAncestorRoot,root,false)) {
            candidateAncestorRoot=root;
          }
        }
 else         if (VfsUtilCore.isAncestor(file,root,false)) {
          selectedRoots.add(root);
        }
      }
      if (candidateAncestorRoot != null) {
        selectedFiles.putValue(candidateAncestorRoot,file);
      }
    }
  }
  return new VcsLogStructureFilterImpl(selectedRoots,selectedFiles);
}
