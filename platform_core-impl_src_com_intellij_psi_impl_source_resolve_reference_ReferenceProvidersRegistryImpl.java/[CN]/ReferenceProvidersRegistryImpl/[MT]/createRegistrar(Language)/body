{
  PsiReferenceRegistrarImpl registrar=new PsiReferenceRegistrarImpl(language);
  for (  PsiReferenceContributor contributor : CONTRIBUTOR_EXTENSION.allForLanguage(language)) {
    contributor.registerReferenceProviders(registrar);
  }
  List<PsiReferenceProviderBean> referenceProviderBeans=REFERENCE_PROVIDER_EXTENSION.allForLanguage(language);
  for (  final PsiReferenceProviderBean providerBean : referenceProviderBeans) {
    final ElementPattern<PsiElement> pattern=providerBean.createElementPattern();
    if (pattern != null) {
      registrar.registerReferenceProvider(pattern,new PsiReferenceProvider(){
        PsiReferenceProvider myProvider;
        @NotNull @Override public PsiReference[] getReferencesByElement(        @NotNull PsiElement element,        @NotNull ProcessingContext context){
          if (myProvider == null) {
            myProvider=providerBean.instantiate();
            if (myProvider == null) {
              myProvider=NULL_REFERENCE_PROVIDER;
            }
          }
          return myProvider.getReferencesByElement(element,context);
        }
      }
);
    }
  }
  registrar.markInitialized();
  return registrar;
}
