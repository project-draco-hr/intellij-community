{
  if (element instanceof PyLambdaExpression) {
    String message=RefactoringBundle.getCannotRefactorMessage("Caret is positioned on lambda call.");
    CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,REFACTORING_NAME);
    return;
  }
  if (!(element instanceof PyFunction))   return;
  final PsiFile psiFile=element.getContainingFile();
  if (psiFile == null)   return;
  final VirtualFile virtualFile=psiFile.getVirtualFile();
  if (virtualFile != null) {
    if (ProjectRootManager.getInstance(project).getFileIndex().isInLibraryClasses(virtualFile)) {
      String message=RefactoringBundle.getCannotRefactorMessage("Function is not under the source root");
      CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,REFACTORING_NAME);
      return;
    }
  }
  final PyFunction newFunction=getSuperMethod((PyFunction)element);
  if (newFunction == null)   return;
  if (!newFunction.equals(element)) {
    invokeOnElement(project,newFunction,editor);
  }
 else {
    final PyFunction function=(PyFunction)element;
    final PyParameter[] parameters=function.getParameterList().getParameters();
    for (    PyParameter p : parameters) {
      if (p instanceof PyTupleParameter) {
        String message=RefactoringBundle.getCannotRefactorMessage("Function contains tuple parameters");
        CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,REFACTORING_NAME);
        return;
      }
    }
    final PyMethodDescriptor method=new PyMethodDescriptor((PyFunction)element);
    PyChangeSignatureDialog dialog=new PyChangeSignatureDialog(project,method);
    dialog.show();
  }
}
