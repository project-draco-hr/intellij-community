{
  if (!CodeInsightUtilBase.prepareEditorForWrite(editor))   return;
  if (!FileDocumentManager.getInstance().requestWriting(editor.getDocument(),project)) {
    return;
  }
  EditorUtil.fillVirtualSpaceUntilCaret(editor);
  PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
  int offset=editor.getCaretModel().getOffset();
  String prefix=getPrefix(editor.getDocument(),offset,false);
  String prefixWithoutDots=getPrefix(editor.getDocument(),offset,true);
  List<TemplateImpl> matchingTemplates=new ArrayList<TemplateImpl>();
  ArrayList<TemplateImpl> applicableTemplates=SurroundWithTemplateHandler.getApplicableTemplates(editor,file,false);
  final Pattern prefixSearchPattern=Pattern.compile(".*\\b" + prefixWithoutDots + ".*");
  for (  TemplateImpl template : applicableTemplates) {
    final String templateDescription=template.getDescription();
    if (template.getKey().startsWith(prefix) || !prefixWithoutDots.isEmpty() && templateDescription != null && prefixSearchPattern.matcher(templateDescription).matches()) {
      matchingTemplates.add(template);
    }
  }
  if (matchingTemplates.isEmpty()) {
    matchingTemplates.addAll(applicableTemplates);
    prefixWithoutDots="";
  }
  if (matchingTemplates.size() == 0) {
    String text=prefixWithoutDots.length() == 0 ? CodeInsightBundle.message("templates.no.defined") : CodeInsightBundle.message("templates.no.defined.with.prefix",prefix);
    HintManager.getInstance().showErrorHint(editor,text);
    return;
  }
  Collections.sort(matchingTemplates,TemplateListPanel.TEMPLATE_COMPARATOR);
  showTemplatesLookup(project,editor,prefixWithoutDots,matchingTemplates);
}
