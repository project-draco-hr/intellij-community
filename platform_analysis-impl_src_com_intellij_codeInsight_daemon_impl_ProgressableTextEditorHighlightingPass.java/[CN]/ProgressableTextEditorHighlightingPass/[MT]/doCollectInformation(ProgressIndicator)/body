{
  if (!(progress instanceof DaemonProgressIndicator)) {
    throw new IncorrectOperationException("Highlighting must be run under DaemonProgressIndicator, but got: " + progress);
  }
  myFinished=false;
  if (myFile != null) {
    myHighlightingSession=new HighlightingSessionImpl(myFile,myEditor,progress,getColorsScheme(),getId(),myRestrictRange);
    if (!progress.isCanceled()) {
      Disposer.register((Disposable)progress,myHighlightingSession);
      if (progress.isCanceled()) {
        Disposer.dispose(myHighlightingSession);
        Disposer.dispose((Disposable)progress);
      }
    }
    progress.checkCanceled();
    ((DaemonProgressIndicator)progress).putUserData(HIGHLIGHTING_SESSION,myHighlightingSession);
  }
  try {
    collectInformationWithProgress(progress);
  }
  finally {
    if (myFile != null) {
      sessionFinished();
    }
  }
}
