{
  try {
    PsiElement problem_elt=descriptor.getPsiElement().getParent();
    PyClass cls=myQualifierType.getPyClass();
    boolean call_by_class=myQualifierType.isDefinition();
    String item_name=myIdentifier;
    sure(item_name);
    PyStatementList cls_stmt_list=cls.getStatementList();
    sure(CodeInsightUtilBase.preparePsiElementForWrite(cls_stmt_list));
    PyFunctionBuilder builder=new PyFunctionBuilder(item_name);
    PsiElement pe=problem_elt.getParent();
    String deco_name=null;
    sure(pe instanceof PyCallExpression);
    PyArgumentList arglist=((PyCallExpression)pe).getArgumentList();
    sure(arglist);
    final PyExpression[] args=arglist.getArguments();
    boolean made_instance=false;
    if (call_by_class) {
      if (args.length > 0) {
        PyType first_arg_type=args[0].getType(TypeEvalContext.fast());
        if (first_arg_type instanceof PyClassType && ((PyClassType)first_arg_type).getPyClass().isSubclass(cls)) {
          builder.parameter("self");
          made_instance=true;
        }
      }
      if (!made_instance) {
        builder.parameter("cls");
        deco_name=PyNames.CLASSMETHOD;
      }
    }
 else {
      builder.parameter("self");
    }
    boolean skip_first=call_by_class && made_instance;
    for (    PyExpression arg : args) {
      if (skip_first) {
        skip_first=false;
        continue;
      }
      if (arg instanceof PyKeywordArgument) {
        builder.parameter(((PyKeywordArgument)arg).getKeyword());
      }
 else       if (arg instanceof PyReferenceExpression) {
        PyReferenceExpression refex=(PyReferenceExpression)arg;
        builder.parameter(refex.getReferencedName());
      }
 else {
        builder.parameter("param");
      }
    }
    PyFunction meth=builder.buildFunction(project,LanguageLevel.getDefault());
    if (deco_name != null) {
      PyElementGenerator generator=PyElementGenerator.getInstance(project);
      PyDecoratorList deco_list=generator.createFromText(LanguageLevel.getDefault(),PyDecoratorList.class,"@" + deco_name + "\ndef foo(): pass",new int[]{0,0});
      meth.addBefore(deco_list,meth.getFirstChild());
    }
    final PsiElement first_stmt=cls_stmt_list.getFirstChild();
    if (first_stmt == cls_stmt_list.getLastChild() && first_stmt instanceof PyPassStatement) {
      meth=(PyFunction)first_stmt.replace(meth);
    }
 else {
      meth=(PyFunction)cls_stmt_list.add(meth);
    }
    showTemplateBuilder(meth);
  }
 catch (  IncorrectOperationException ignored) {
    PyUtil.showBalloon(project,PyBundle.message("QFIX.failed.to.add.method"),MessageType.ERROR);
  }
}
