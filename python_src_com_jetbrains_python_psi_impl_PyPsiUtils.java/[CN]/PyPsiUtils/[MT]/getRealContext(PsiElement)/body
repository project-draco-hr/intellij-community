{
  if (!element.isValid()) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("PyPsiUtil.getRealContext(" + element + ") called. Returned null. Element in invalid");
    }
    return element;
  }
  final PsiFile file=element.getContainingFile();
  if (file != null) {
    final PsiElement context=file.getCopyableUserData(PyExpressionCodeFragmentImpl.CONTEXT_KEY);
    if (context != null) {
      return context;
    }
  }
  if (file instanceof PyExpressionCodeFragment) {
    final PsiElement context=file.getContext();
    if (LOG.isDebugEnabled()) {
      LOG.debug("PyPsiUtil.getRealContext(" + element + ") is called. Returned "+ context+ ". Element inside code fragment");
    }
    return context != null ? context : element;
  }
 else {
    if (LOG.isDebugEnabled()) {
      LOG.debug("PyPsiUtil.getRealContext(" + element + ") is called. Returned "+ element+ ".");
    }
    return element;
  }
}
