{
  final Pair<PsiElement,TextRange> data=oldExpression.getUserData(SELECTION_BREAKS_AST_NODE);
  if (data != null) {
    final PsiElement parent=data.first;
    final TextRange textRange=data.second;
    final String parentText=parent.getText();
    final String prefix=parentText.substring(0,textRange.getStartOffset());
    final String suffix=parentText.substring(textRange.getEndOffset(),parent.getTextLength());
    final PyElementGenerator generator=PyElementGenerator.getInstance(oldExpression.getProject());
    final LanguageLevel languageLevel=LanguageLevel.forElement(oldExpression);
    final PsiElement expression=generator.createFromText(languageLevel,parent.getClass(),prefix + newExpression.getText() + suffix);
    return parent.replace(expression);
  }
 else {
    return oldExpression.replace(newExpression);
  }
}
