{
  VirtualFile jarRoot;
  File libDir=new File(jar.getParent(),"lib");
  assertTrue(libDir.mkdir());
  VirtualFile vLibDir=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(libDir);
  assertNotNull(vLibDir);
  jarRoot=JarFileSystem.getInstance().getRootByLocal(vFile);
  assertNotNull(jarRoot);
  assertTrue(jarRoot.isValid());
  PsiDirectory directory=getPsiManager().findDirectory(vLibDir);
  DataContext psiDataContext=SimpleDataContext.getSimpleContext(LangDataKeys.TARGET_PSI_ELEMENT.getName(),directory);
  new WriteCommandAction.Simple(myProject){
    @Override protected void run() throws Throwable {
      new MoveHandler().invoke(myProject,new PsiElement[]{file},psiDataContext);
    }
  }
.execute();
  assertFalse(jarRoot.isValid());
  jarRoot=JarFileSystem.getInstance().getRootByLocal(vFile);
  assertNotNull(jarRoot);
  assertTrue(jarRoot.isValid());
  rename(directory,"lib2");
  assertFalse(jarRoot.isValid());
}
