{
  final Set<String> profileKeys=new HashSet<String>();
  profileKeys.addAll(myProfiles.keySet());
  myProfiles.clear();
  XmlSerializer.deserializeInto(this,state);
  for (  Element o : state.getChildren(PROFILE)) {
    Profile profile=myApplicationProfileManager.createProfile();
    profile.setProfileManager(this);
    profile.readExternal(o);
    profile.setProjectLevel(true);
    if (profileKeys.contains(profile.getName())) {
      updateProfile(profile);
    }
 else {
      myProfiles.put(profile.getName(),profile);
    }
  }
  if (state.getChild("version") == null || !Comparing.strEqual(state.getChild("version").getAttributeValue("value"),VERSION)) {
    boolean toConvert=true;
    for (    Element o : state.getChildren("option")) {
      if (Comparing.strEqual(o.getAttributeValue("name"),"USE_PROJECT_LEVEL_SETTINGS")) {
        toConvert=Boolean.parseBoolean(o.getAttributeValue("value"));
        break;
      }
    }
    if (toConvert) {
      convert(state);
    }
  }
}
