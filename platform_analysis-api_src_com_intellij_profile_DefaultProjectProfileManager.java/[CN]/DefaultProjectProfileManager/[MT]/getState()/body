{
  Element state=new Element("settings");
  String[] sortedProfiles=myProfiles.keySet().toArray(new String[myProfiles.size()]);
  Arrays.sort(sortedProfiles);
  for (  String profile : sortedProfiles) {
    final Profile projectProfile=myProfiles.get(profile);
    if (projectProfile != null) {
      Element profileElement=new Element(PROFILE);
      try {
        projectProfile.writeExternal(profileElement);
      }
 catch (      WriteExternalException e) {
        LOG.error(e);
      }
      boolean hasSmthToSave=sortedProfiles.length > 1 || isCustomProfileUsed();
      if (!hasSmthToSave) {
        for (        Element child : profileElement.getChildren()) {
          if (!child.getName().equals("option")) {
            hasSmthToSave=true;
            break;
          }
        }
      }
      if (hasSmthToSave) {
        state.addContent(profileElement);
      }
    }
  }
  if (!state.getChildren().isEmpty() || isCustomProfileUsed()) {
    XmlSerializer.serializeInto(this,state);
    state.addContent(new Element("version").setAttribute("value",VERSION));
  }
  return state;
}
