{
  PsiFile psiFile=fileContent.getPsiFile();
  if (!(psiFile instanceof XmlFile))   return null;
  Document document=FileDocumentManager.getInstance().getCachedDocument(fileContent.getFile());
  Project project=fileContent.getProject();
  if (document != null) {
    PsiFile existingPsi=PsiDocumentManager.getInstance(project).getPsiFile(document);
    if (existingPsi instanceof XmlFile) {
      psiFile=existingPsi;
    }
  }
  XmlFile xmlFile=(XmlFile)psiFile;
  try {
    XmlUtil.BUILDING_DOM_STUBS.set(Boolean.TRUE);
    DomFileElement<? extends DomElement> fileElement=DomManager.getDomManager(project).getFileElement(xmlFile);
    if (fileElement == null || !fileElement.getFileDescription().hasStubs())     return null;
    XmlFileHeader header=DomService.getInstance().getXmlFileHeader(xmlFile);
    if (header.getRootTagLocalName() == null) {
      LOG.error("null root tag for " + fileElement + " for "+ fileContent.getFile());
    }
    FileStub fileStub=new FileStub(header);
    XmlTag rootTag=xmlFile.getRootTag();
    if (rootTag != null) {
      new DomStubBuilderVisitor(DomManagerImpl.getDomManager(project)).visitXmlElement(rootTag,fileStub,0);
    }
    return fileStub;
  }
  finally {
    XmlUtil.BUILDING_DOM_STUBS.set(Boolean.FALSE);
    SemService.getSemService(project).clearCache();
  }
}
