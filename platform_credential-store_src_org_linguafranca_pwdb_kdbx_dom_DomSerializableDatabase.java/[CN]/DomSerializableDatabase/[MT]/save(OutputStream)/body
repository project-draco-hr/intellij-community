{
  Document copyDoc=(Document)doc.cloneNode(true);
  try {
    prepareProtection(copyDoc,"Title");
    prepareProtection(copyDoc,"UserName");
    prepareProtection(copyDoc,"Password");
    prepareProtection(copyDoc,"Notes");
    prepareProtection(copyDoc,"URL");
    NodeList protectedContent=(NodeList)xpath.evaluate("//*[@Protected='True']",copyDoc,XPathConstants.NODESET);
    for (int i=0; i < protectedContent.getLength(); i++) {
      Element element=((Element)protectedContent.item(i));
      String decrypted=getElementContent(".",element);
      if (decrypted == null) {
        decrypted="";
      }
      byte[] encrypted=encryption.encrypt(decrypted.getBytes(StandardCharsets.UTF_8));
      setElementContent(".",element,Base64.getEncoder().encodeToString(encrypted));
    }
  }
 catch (  XPathExpressionException e) {
    throw new IllegalStateException(e);
  }
  Source xmlSource=new DOMSource(copyDoc);
  Result outputTarget=new StreamResult(outputStream);
  try {
    Transformer transformer=TransformerFactory.newInstance().newTransformer();
    transformer.setOutputProperty(OutputKeys.INDENT,"yes");
    transformer.setOutputProperty("{http://xml.apache.org/xslt}indent-amount","2");
    transformer.transform(xmlSource,outputTarget);
  }
 catch (  TransformerException e) {
    throw new IllegalStateException(e);
  }
}
