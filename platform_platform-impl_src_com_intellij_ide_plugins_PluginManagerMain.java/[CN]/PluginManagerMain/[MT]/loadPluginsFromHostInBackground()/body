{
  setDownloadStatus(true);
  ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
    @Override public void run(){
      final List<IdeaPluginDescriptor> list=ContainerUtil.newArrayList();
      final Map<String,String> errors=ContainerUtil.newLinkedHashMap();
      ProgressIndicator indicator=new EmptyProgressIndicator();
      List<String> hosts=RepositoryHelper.getPluginHosts();
      Set<PluginId> unique=ContainerUtil.newHashSet();
      for (      String host : hosts) {
        try {
          if (host == null || acceptHost(host)) {
            List<IdeaPluginDescriptor> plugins=RepositoryHelper.loadPlugins(host,null,indicator);
            for (            IdeaPluginDescriptor plugin : plugins) {
              if (unique.add(plugin.getPluginId())) {
                list.add(plugin);
              }
            }
          }
        }
 catch (        FileNotFoundException e) {
          LOG.info(host,e);
        }
catch (        IOException e) {
          LOG.info(host,e);
          if (host != ApplicationInfoEx.getInstanceEx().getBuiltinPluginsUrl()) {
            errors.put(host,String.format("'%s' for '%s'",e.getMessage(),host));
          }
        }
      }
      UIUtil.invokeLaterIfNeeded(new Runnable(){
        @Override public void run(){
          setDownloadStatus(false);
          if (!list.isEmpty()) {
            InstalledPluginsState state=InstalledPluginsState.getInstance();
            for (            IdeaPluginDescriptor descriptor : list) {
              state.onDescriptorDownload(descriptor);
            }
            modifyPluginsList(list);
            propagateUpdates(list);
          }
          if (!errors.isEmpty()) {
            String message=IdeBundle.message("error.list.of.plugins.was.not.loaded",StringUtil.join(errors.keySet(),", "),StringUtil.join(errors.values(),",\n"));
            String title=IdeBundle.message("title.plugins");
            String ok=CommonBundle.message("button.retry"), cancel=CommonBundle.getCancelButtonText();
            if (Messages.showOkCancelDialog(message,title,ok,cancel,Messages.getErrorIcon()) == Messages.OK) {
              loadPluginsFromHostInBackground();
            }
          }
        }
      }
);
    }
  }
);
}
