{
  setDownloadStatus(true);
  new SwingWorker(){
    List<IdeaPluginDescriptor> list=null;
    List<String> errorMessages=new ArrayList<String>();
    @Override public Object construct(){
      try {
        list=RepositoryHelper.loadPluginsFromRepository(null);
      }
 catch (      Exception e) {
        LOG.info(e);
        errorMessages.add(e.getMessage());
      }
      String builtinPluginsUrl=ApplicationInfoEx.getInstanceEx().getBuiltinPluginsUrl();
      if (builtinPluginsUrl != null) {
        processPluginHost(builtinPluginsUrl,true);
      }
      for (      String host : UpdateSettings.getInstance().getPluginHosts()) {
        processPluginHost(host,false);
      }
      return list;
    }
    void processPluginHost(    @NotNull String host,    boolean builtIn){
      if (!acceptHost(host)) {
        return;
      }
      Map<PluginId,PluginDownloader> downloaded=new THashMap<PluginId,PluginDownloader>();
      try {
        UpdateChecker.checkPluginsHost(host,downloaded,false,null);
        for (        PluginDownloader downloader : downloaded.values()) {
          final PluginNode pluginNode=PluginDownloader.createPluginNode(host,downloader);
          if (pluginNode != null) {
            if (list == null)             list=new ArrayList<IdeaPluginDescriptor>();
            list.add(pluginNode);
          }
        }
      }
 catch (      ProcessCanceledException ignore) {
      }
catch (      FileNotFoundException e) {
        LOG.info(e);
      }
catch (      Exception e) {
        if (builtIn) {
          LOG.info("built-in repo failed: " + e.toString());
        }
 else {
          LOG.info(e);
          errorMessages.add(e.getMessage());
        }
      }
    }
    @Override public void finished(){
      UIUtil.invokeLaterIfNeeded(new Runnable(){
        @Override public void run(){
          setDownloadStatus(false);
          if (list != null) {
            modifyPluginsList(list);
            propagateUpdates(list);
          }
          if (!errorMessages.isEmpty()) {
            if (Messages.OK == Messages.showOkCancelDialog(IdeBundle.message("error.list.of.plugins.was.not.loaded",StringUtil.join(errorMessages,", ")),IdeBundle.message("title.plugins"),CommonBundle.message("button.retry"),CommonBundle.getCancelButtonText(),Messages.getErrorIcon())) {
              loadPluginsFromHostInBackground();
            }
          }
        }
      }
);
    }
  }
.start();
}
