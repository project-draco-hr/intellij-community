{
  final VirtualFile vcsRoot=VcsUtil.getVcsRootFor(myProject,VcsUtil.getFilePath(file.getPath()));
  if (vcsRoot == null) {
    throw new VcsException("vcs root is null for " + file);
  }
  HgRevisionNumber revisionNumber=revision != null ? (HgRevisionNumber)revision.getRevisionNumber() : null;
  final HgFile hgFile=new HgFile(vcsRoot,VfsUtilCore.virtualToIoFile(file));
  HgFile fileToAnnotate=revision instanceof HgFileRevision ? HgUtil.getFileNameInTargetRevision(myProject,revisionNumber,hgFile) : new HgFile(vcsRoot,HgUtil.getOriginalFileName(hgFile.toFilePath(),ChangeListManager.getInstance(myProject)));
  final List<HgAnnotationLine> annotationResult=(new HgAnnotateCommand(myProject)).execute(fileToAnnotate,revisionNumber);
  final List<HgFileRevision> logResult=HgHistoryProvider.getHistory(revision == null ? hgFile.toFilePath() : fileToAnnotate.toFilePath(),vcsRoot,myProject,null,-1);
  return new HgAnnotation(myProject,hgFile,annotationResult,logResult,revisionNumber != null ? revisionNumber : new HgWorkingCopyRevisionsCommand(myProject).tip(vcsRoot));
}
