{
  if (myProgress.isCanceled()) {
    return NO_SUCH_PAGE;
  }
  final Graphics2D g2d=(Graphics2D)g;
  if (myNumberOfPages < 0) {
    myProgress.setText(CodeEditorBundle.message("print.file.calculating.number.of.pages.progress"));
    myPerformActualDrawing=false;
    if (!calculateNumberOfPages(g2d,pageFormat)) {
      return NO_SUCH_PAGE;
    }
  }
  myPerformActualDrawing=true;
  return ApplicationManager.getApplication().runReadAction(new Computable<Integer>(){
    @Override public Integer compute(){
      if (!isValidRange(myRangeToPrint)) {
        return NO_SUCH_PAGE;
      }
      isPrintingPass=!isPrintingPass;
      if (!isPrintingPass) {
        return PAGE_EXISTS;
      }
      myProgress.setText(CodeEditorBundle.message("print.file.page.progress",myShortFileName,(pageIndex + 1),myNumberOfPages));
      myPageIndex=pageIndex;
      RangeMarker newRange=printPage(g2d,pageFormat,myRangeToPrint);
      setSegment(newRange);
      return PAGE_EXISTS;
    }
  }
);
}
