{
  if (!TypeEvalStack.mayEvaluate(this)) {
    return null;
  }
  try {
    final boolean qualified=isQualified();
    if (!qualified) {
      String name=getReferencedName();
      if (PyNames.NONE.equals(name)) {
        return PyNoneType.INSTANCE;
      }
    }
    PyType type=getTypeFromProviders(context);
    if (type != null) {
      return type;
    }
    if (qualified) {
      PyType maybe_type=PyUtil.getSpecialAttributeType(this,context);
      if (maybe_type != null)       return maybe_type;
      Ref<PyType> typeOfProperty=getTypeOfProperty(context);
      if (typeOfProperty != null) {
        return typeOfProperty.get();
      }
    }
    ResolveResult[] targets=getReference(PyResolveContext.noImplicits().withTypeEvalContext(context)).multiResolve(false);
    if (targets.length == 0) {
      return getQualifiedReferenceTypeByControlFlow(context);
    }
    final List<PyType> members=new ArrayList<PyType>();
    final int maxRate=getMaxRate(targets);
    for (    ResolveResult resolveResult : targets) {
      final int rate=resolveResult instanceof RatedResolveResult ? ((RatedResolveResult)resolveResult).getRate() : 0;
      if (rate < maxRate) {
        continue;
      }
      PsiElement target=resolveResult.getElement();
      if (target == this || target == null) {
        continue;
      }
      if (!target.isValid()) {
        LOG.error("Reference " + this + " resolved to invalid element "+ target+ " (text="+ target.getText()+ ")");
        continue;
      }
      members.add(getTypeFromTarget(target,context,this));
    }
    return PyUnionType.union(members);
  }
  finally {
    TypeEvalStack.evaluated(this);
  }
}
