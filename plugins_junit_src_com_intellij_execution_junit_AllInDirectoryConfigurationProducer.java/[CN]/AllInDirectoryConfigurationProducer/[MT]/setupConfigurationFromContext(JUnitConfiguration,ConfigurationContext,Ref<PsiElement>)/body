{
  final Project project=configuration.getProject();
  final PsiElement element=context.getPsiLocation();
  if (!(element instanceof PsiDirectory))   return false;
  final PsiPackage aPackage=JavaRuntimeConfigurationProducerBase.checkPackage(element);
  if (aPackage == null)   return false;
  final VirtualFile virtualFile=((PsiDirectory)element).getVirtualFile();
  final Module module=ModuleUtilCore.findModuleForFile(virtualFile,project);
  if (module == null)   return false;
  final ContentEntry[] entries=ModuleRootManager.getInstance(module).getContentEntries();
  int testRootCount=0;
  for (  ContentEntry entry : entries) {
    for (    SourceFolder sourceFolder : entry.getSourceFolders()) {
      if (sourceFolder.isTestSource()) {
        testRootCount++;
        if (testRootCount > 1) {
          break;
        }
      }
    }
  }
  if (testRootCount < 2)   return false;
  if (!LocationUtil.isJarAttached(context.getLocation(),aPackage,JUnitUtil.TESTCASE_CLASS))   return false;
  setupConfigurationModule(context,configuration);
  final JUnitConfiguration.Data data=configuration.getPersistentData();
  data.setDirName(virtualFile.getPath());
  data.TEST_OBJECT=JUnitConfiguration.TEST_DIRECTORY;
  configuration.setGeneratedName();
  JavaRunConfigurationExtensionManager.getInstance().extendCreatedConfiguration(configuration,context.getLocation());
  return true;
}
