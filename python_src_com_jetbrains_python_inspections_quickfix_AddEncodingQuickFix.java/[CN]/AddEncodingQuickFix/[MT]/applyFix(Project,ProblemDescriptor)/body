{
  final PsiElement element=descriptor.getPsiElement();
  final PsiFile file=element.getContainingFile();
  if (file == null)   return;
  PsiElement firstLine=file.getFirstChild();
  if (firstLine instanceof PsiComment && firstLine.getText().startsWith("#!")) {
    firstLine=firstLine.getNextSibling();
  }
  final String commentText=String.format(PyEncodingUtil.ENCODING_FORMAT_PATTERN[myEncodingFormatIndex],myDefaultEncoding);
  final PyElementGenerator elementGenerator=PyElementGenerator.getInstance(project);
  PsiComment encodingComment=elementGenerator.createFromText(LanguageLevel.forElement(file),PsiComment.class,commentText);
  encodingComment=(PsiComment)file.addBefore(encodingComment,firstLine);
  final FileEditor fileEditor=FileEditorManager.getInstance(project).getSelectedEditor(element.getContainingFile().getVirtualFile());
  if (fileEditor instanceof TextEditor) {
    final Editor editor=((TextEditor)fileEditor).getEditor();
    final Document document=editor.getDocument();
    final int insertedLineNumber=document.getLineNumber(encodingComment.getTextOffset());
    if (insertedLineNumber == document.getLineCount() - 1) {
      PsiDocumentManager.getInstance(project).doPostponedOperationsAndUnblockDocument(document);
      document.insertString(document.getLineEndOffset(insertedLineNumber),"\n");
    }
    editor.getCaretModel().moveToLogicalPosition(new LogicalPosition(insertedLineNumber + 1,0));
  }
}
