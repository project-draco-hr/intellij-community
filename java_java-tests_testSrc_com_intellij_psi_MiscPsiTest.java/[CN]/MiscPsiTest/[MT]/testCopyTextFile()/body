{
  String text="1234567890";
  PsiFile file=myFixture.addFileToProject("Test.txt",text);
  VirtualFile vDir=myFixture.getTempDirFixture().findOrCreateDir("dir");
  PsiDocumentManager.getInstance(getProject()).commitAllDocuments();
  assertTrue(file instanceof PsiPlainTextFile);
  PsiDirectory dir=getPsiManager().findDirectory(vDir);
  PsiFile fileCopy=(PsiFile)file.copy();
  fileCopy=(PsiFile)fileCopy.setName("NewTest.txt");
  PsiFile newFile=(PsiFile)dir.add(fileCopy);
  assertTrue(newFile instanceof PsiPlainTextFile);
  assertEquals(text,new String(newFile.getVirtualFile().contentsToByteArray()));
  assertEquals(newFile.getVirtualFile().getModificationStamp(),newFile.getViewProvider().getModificationStamp());
  Document document=PsiDocumentManager.getInstance(getProject()).getDocument(newFile);
  assertEquals(newFile.getVirtualFile().getModificationStamp(),document.getModificationStamp());
}
