{
  VirtualFile vFile=myRoot.createChildData(null,"Test.txt");
  final String text="1234567890";
  vFile.setBinaryContent(text.getBytes());
  VirtualFile vDir=myRoot.createChildDirectory(null,"dir");
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  PsiFile file=myPsiManager.findFile(vFile);
  assertTrue(file instanceof PsiPlainTextFile);
  PsiDirectory dir=myPsiManager.findDirectory(vDir);
  PsiFile fileCopy=(PsiFile)file.copy();
  fileCopy=(PsiFile)fileCopy.setName("NewTest.txt");
  PsiFile newFile=(PsiFile)dir.add(fileCopy);
  assertTrue(newFile instanceof PsiPlainTextFile);
  assertEquals(text,new String(newFile.getVirtualFile().contentsToByteArray()));
  assertEquals(newFile.getVirtualFile().getModificationStamp(),newFile.getViewProvider().getModificationStamp());
  Document document=PsiDocumentManager.getInstance(myProject).getDocument(newFile);
  assertEquals(newFile.getVirtualFile().getModificationStamp(),document.getModificationStamp());
}
