{
  VirtualFile vFile=myRoot.createChildData(null,"A.java");
  String text="package aaa; class A{}";
  VfsUtil.saveText(vFile,text);
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  PsiFile file=myPsiManager.findFile(vFile);
  PsiJavaFile fileACopy=(PsiJavaFile)file.copy();
  PsiClass aClass=fileACopy.getClasses()[0];
  aClass.setName("ANew");
  PsiFile newFile=(PsiFile)file.getContainingDirectory().add(fileACopy);
  Document document=PsiDocumentManager.getInstance(myProject).getDocument(newFile);
  FileDocumentManager.getInstance().saveDocument(document);
  assertEquals(newFile.getVirtualFile().getModificationStamp(),newFile.getViewProvider().getModificationStamp());
  assertFalse(FileDocumentManager.getInstance().isFileModified(newFile.getVirtualFile()));
}
