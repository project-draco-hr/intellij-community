{
  VirtualFile vFile=myRoot.createChildData(null,"Test.xxx");
  String text="1234567890";
  vFile.setBinaryContent(text.getBytes());
  VirtualFile vDir=myRoot.createChildDirectory(null,"dir");
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  PsiFile file=myPsiManager.findFile(vFile);
  PsiDirectory dir=myPsiManager.findDirectory(vDir);
  PsiFile fileCopy=(PsiFile)file.copy();
  fileCopy=(PsiFile)fileCopy.setName("NewTest.txt");
  PsiFile newFile=(PsiFile)dir.add(fileCopy);
  assertTrue(newFile instanceof PsiPlainTextFile);
  assertEquals(text,VfsUtil.loadText(newFile.getVirtualFile()));
  assertEquals(newFile.getVirtualFile().getModificationStamp(),newFile.getViewProvider().getModificationStamp());
  assertFalse(FileDocumentManager.getInstance().isFileModified(newFile.getVirtualFile()));
}
