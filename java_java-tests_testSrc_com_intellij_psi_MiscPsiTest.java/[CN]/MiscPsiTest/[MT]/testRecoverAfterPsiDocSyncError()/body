{
  VirtualFile vFile=myFixture.addFileToProject("a.java","class A{}").getVirtualFile();
  try {
    myFixture.findClass("A").replace(JavaPsiFacade.getElementFactory(getProject()).createClassFromText("class B {\r\n}",null));
    fail("Should fail");
  }
 catch (  Throwable e) {
    assertTrue(e.getMessage(),e.getMessage().contains("Wrong line separators"));
  }
  assertEquals("class A{}",getPsiManager().findFile(vFile).getText());
  VfsUtil.saveText(vFile,"class C {}");
  PsiDocumentManager.getInstance(getProject()).commitAllDocuments();
  PsiClass c=myFixture.findClass("C");
  assertNotNull(c);
  assertEquals(vFile,c.getContainingFile().getVirtualFile());
}
