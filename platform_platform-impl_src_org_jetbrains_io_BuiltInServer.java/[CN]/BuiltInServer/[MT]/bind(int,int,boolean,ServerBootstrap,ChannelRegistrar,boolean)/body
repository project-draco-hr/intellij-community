{
  InetAddress address=InetAddress.getLoopbackAddress();
  for (int i=0; i < portsCount; i++) {
    int port=firstPort + i;
    if (ArrayUtil.indexOf(FORBIDDEN_PORTS,i) >= 0) {
      continue;
    }
    ChannelFuture future=bootstrap.bind(address,port).awaitUninterruptibly();
    if (future.isSuccess()) {
      channelRegistrar.add(future.channel(),isEventLoopGroupOwner);
      return port;
    }
 else     if (!tryAnyPort && i == portsCount - 1) {
      ExceptionUtil.rethrowAll(future.cause());
    }
  }
  Logger.getInstance(BuiltInServer.class).info("We cannot bind to our default range, so, try to bind to any free port");
  ChannelFuture future=bootstrap.bind(address,0).awaitUninterruptibly();
  if (future.isSuccess()) {
    channelRegistrar.add(future.channel(),isEventLoopGroupOwner);
    return ((InetSocketAddress)future.channel().localAddress()).getPort();
  }
  ExceptionUtil.rethrowAll(future.cause());
  return -1;
}
