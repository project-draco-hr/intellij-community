{
  PsiElement element=searchContext.getFile();
  if (element != null && !useLastConfiguration) {
    final Editor selectedEditor=FileEditorManager.getInstance(searchContext.getProject()).getSelectedTextEditor();
    if (selectedEditor != null) {
      int caretPosition=selectedEditor.getCaretModel().getOffset();
      PsiElement positionedElement=searchContext.getFile().findElementAt(caretPosition);
      if (positionedElement == null) {
        positionedElement=searchContext.getFile().findElementAt(caretPosition + 1);
      }
      if (positionedElement != null) {
        element=PsiTreeUtil.getParentOfType(positionedElement,PsiClass.class,PsiCodeBlock.class);
      }
    }
  }
  final PsiManager psimanager=PsiManager.getInstance(searchContext.getProject());
  PsiCodeFragment file=psimanager.getElementFactory().createCodeBlockCodeFragment("",element,true);
  Document doc=PsiDocumentManager.getInstance(searchContext.getProject()).getDocument(file);
  DaemonCodeAnalyzer.getInstance(searchContext.getProject()).setHighlightingEnabled(file,false);
  Editor editor=UIUtil.createEditor(doc,searchContext.getProject(),true,true);
  editor.getDocument().addDocumentListener(new DocumentListener(){
    public void beforeDocumentChange(    final DocumentEvent event){
    }
    public void documentChanged(    final DocumentEvent event){
      initiateValidation();
    }
  }
);
  return editor;
}
