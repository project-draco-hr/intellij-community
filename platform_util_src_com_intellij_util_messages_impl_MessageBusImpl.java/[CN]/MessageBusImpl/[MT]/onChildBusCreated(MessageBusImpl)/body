{
  LOG.assertTrue(childBus.myParentBus == this);
  List<Integer> childOrder=new ArrayList<Integer>(myOrderRef.get().size() + 1);
  childOrder.addAll(myOrderRef.get());
  childOrder.add(1);
  while (true) {
    final MessageBusImpl lastChild=myChildBuses.peekLast();
    final int lastChildIndex;
    if (lastChild == null) {
      lastChildIndex=0;
    }
 else {
      final List<Integer> lastChildOrder=lastChild.myOrderRef.get();
      lastChildIndex=lastChildOrder.get(lastChildOrder.size() - 1);
    }
    if (lastChildIndex == Integer.MAX_VALUE) {
      LOG.error("Too many child buses");
    }
    childOrder.set(childOrder.size() - 1,lastChildIndex + 1);
    if (myChildOrders.putIfAbsent(childOrder,Boolean.TRUE) == null) {
      break;
    }
  }
  childBus.myOrderRef.set(childOrder);
  myChildBuses.add(childBus);
  getRootBus().clearSubscriberCache();
}
