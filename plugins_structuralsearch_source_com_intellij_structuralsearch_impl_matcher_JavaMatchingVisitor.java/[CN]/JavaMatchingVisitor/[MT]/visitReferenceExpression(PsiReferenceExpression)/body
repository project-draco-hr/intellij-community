{
  final PsiExpression qualifier=reference.getQualifierExpression();
  final PsiElement nameElement=reference.getReferenceNameElement();
  MatchingHandler _handler=nameElement != null ? myMatchingVisitor.getMatchContext().getPattern().getHandlerSimple(nameElement) : null;
  if (!(_handler instanceof SubstitutionHandler))   _handler=myMatchingVisitor.getMatchContext().getPattern().getHandlerSimple(reference);
  if (_handler instanceof SubstitutionHandler && !(myMatchingVisitor.getMatchContext().getPattern().getHandlerSimple(qualifier) instanceof SubstitutionHandler) && !(qualifier instanceof PsiThisExpression)) {
    if (myMatchingVisitor.getElement() instanceof PsiReferenceExpression) {
      final PsiReferenceExpression psiReferenceExpression=(PsiReferenceExpression)myMatchingVisitor.getElement();
      if (psiReferenceExpression.getQualifierExpression() == null) {
        myMatchingVisitor.setElement(psiReferenceExpression.getReferenceNameElement());
      }
    }
    final SubstitutionHandler handler=(SubstitutionHandler)_handler;
    if (handler.isSubtype() || handler.isStrictSubtype()) {
      myMatchingVisitor.setResult(checkMatchWithingHierarchy(myMatchingVisitor.getElement(),handler,reference));
    }
 else {
      myMatchingVisitor.setResult(handler.handle(myMatchingVisitor.getElement(),myMatchingVisitor.getMatchContext()));
    }
    return;
  }
  if (!(myMatchingVisitor.getElement() instanceof PsiReferenceExpression)) {
    myMatchingVisitor.setResult(false);
    return;
  }
  final PsiReferenceExpression reference2=(PsiReferenceExpression)myMatchingVisitor.getElement();
  final PsiExpression reference2Qualifier=reference2.getQualifierExpression();
  if (qualifier == null && reference2Qualifier == null) {
    myMatchingVisitor.setResult(reference.getReferenceNameElement().textMatches(reference2.getReferenceNameElement()));
    return;
  }
  if (!(myMatchingVisitor.getElement().getParent() instanceof PsiMethodCallExpression) && qualifier != null) {
    final PsiElement referenceElement=reference.getReferenceNameElement();
    final PsiElement referenceElement2=reference2.getReferenceNameElement();
    if (myMatchingVisitor.getMatchContext().getPattern().isTypedVar(referenceElement)) {
      myMatchingVisitor.setResult(myMatchingVisitor.handleTypedElement(referenceElement,referenceElement2));
    }
 else {
      myMatchingVisitor.setResult((referenceElement2 != null && referenceElement != null && referenceElement.textMatches(referenceElement2)) || referenceElement == referenceElement2);
    }
    if (!myMatchingVisitor.getResult()) {
      return;
    }
    if (reference2Qualifier != null) {
      myMatchingVisitor.setResult(myMatchingVisitor.match(qualifier,reference2Qualifier));
    }
 else {
      if (qualifier instanceof PsiThisExpression && MatchUtils.getReferencedElement(myMatchingVisitor.getElement()) instanceof PsiField) {
        myMatchingVisitor.setResult(true);
        return;
      }
      final MatchingHandler handler=myMatchingVisitor.getMatchContext().getPattern().getHandler(qualifier);
      if (!(handler instanceof SubstitutionHandler) || ((SubstitutionHandler)handler).getMinOccurs() != 0) {
        myMatchingVisitor.setResult(false);
        return;
      }
 else {
        final SubstitutionHandler substitutionHandler=(SubstitutionHandler)handler;
        MatchPredicate predicate=substitutionHandler.getPredicate();
        if (predicate != null) {
          boolean isNot=false;
          if (predicate instanceof NotPredicate) {
            isNot=true;
            predicate=((NotPredicate)predicate).getHandler();
          }
          boolean isStatic=false;
          if (predicate instanceof RegExpPredicate) {
            isStatic=true;
          }
 else           if (!(predicate instanceof ExprTypePredicate)) {
            predicate=null;
          }
          if (predicate != null) {
            final PsiField method=(PsiField)reference2.resolve();
            if (method != null) {
              final PsiClass aClass=method.getContainingClass();
              if (isStatic) {
                myMatchingVisitor.setResult(predicate.match(null,aClass,myMatchingVisitor.getMatchContext()));
              }
 else {
                myMatchingVisitor.setResult(((ExprTypePredicate)predicate).checkClass(aClass,myMatchingVisitor.getMatchContext()));
              }
            }
 else {
              myMatchingVisitor.setResult(false);
            }
            if (isNot)             myMatchingVisitor.setResult(!myMatchingVisitor.getResult());
          }
        }
      }
    }
    return;
  }
  myMatchingVisitor.setResult(false);
}
