{
  final PsiElement element=descriptor.getPsiElement();
  final PsiElement parent=element.getParent();
  if (!(parent instanceof PsiVariable)) {
    if (parent instanceof PsiNewExpression) {
      final PsiExpression stringBuilderExpression=getCompleteExpression(parent);
      final StringBuilder stringExpression=buildStringExpression(stringBuilderExpression,new StringBuilder());
      if (stringExpression != null && stringBuilderExpression != null) {
        PsiReplacementUtil.replaceExpression(stringBuilderExpression,stringExpression.toString());
      }
    }
    return;
  }
  final PsiVariable variable=(PsiVariable)parent;
  final PsiTypeElement originalTypeElement=variable.getTypeElement();
  if (originalTypeElement == null) {
    return;
  }
  final PsiExpression initializer=variable.getInitializer();
  if (initializer == null) {
    return;
  }
  final StringBuilder builder;
  if (isAppendCall(initializer)) {
    builder=buildStringExpression(initializer,new StringBuilder());
    if (builder == null) {
      return;
    }
  }
 else   if (initializer instanceof PsiNewExpression) {
    final PsiNewExpression newExpression=(PsiNewExpression)initializer;
    final PsiExpressionList argumentList=newExpression.getArgumentList();
    if (argumentList == null) {
      return;
    }
    final PsiExpression[] arguments=argumentList.getExpressions();
    if (arguments.length == 0 || PsiType.INT.equals(arguments[0].getType())) {
      builder=new StringBuilder();
    }
 else {
      builder=new StringBuilder(arguments[0].getText());
    }
  }
 else {
    return;
  }
  final PsiCodeBlock codeBlock=PsiTreeUtil.getParentOfType(variable,PsiCodeBlock.class);
  if (codeBlock == null) {
    return;
  }
  final StringBuildingVisitor visitor=new StringBuildingVisitor(variable,builder);
  codeBlock.accept(visitor);
  if (visitor.hadProblem()) {
    return;
  }
  final List<PsiMethodCallExpression> expressions=visitor.getExpressions();
  final String expression=builder.toString().trim();
  final PsiMethodCallExpression lastExpression=expressions.get(expressions.size() - 1);
  final boolean useVariable=expression.contains("\n") && !isVariableInitializer(lastExpression);
  if (useVariable) {
    final PsiStatement statement=PsiTreeUtil.getParentOfType(variable,PsiStatement.class);
    if (statement == null) {
      return;
    }
    final String modifier=CodeStyleSettingsManager.getSettings(project).GENERATE_FINAL_LOCALS ? "final " : "";
    final PsiElementFactory factory=JavaPsiFacade.getElementFactory(project);
    final PsiStatement newStatement=factory.createStatementFromText(modifier + CommonClassNames.JAVA_LANG_STRING + ' '+ variable.getName()+ '='+ expression+ ';',variable);
    codeBlock.addBefore(newStatement,statement);
  }
  variable.delete();
  for (int i=0, size=expressions.size() - 1; i < size; i++) {
    expressions.get(i).getParent().delete();
  }
  if (useVariable) {
    PsiReplacementUtil.replaceExpression(lastExpression,variable.getName());
  }
 else {
    PsiReplacementUtil.replaceExpression(lastExpression,expression);
  }
}
