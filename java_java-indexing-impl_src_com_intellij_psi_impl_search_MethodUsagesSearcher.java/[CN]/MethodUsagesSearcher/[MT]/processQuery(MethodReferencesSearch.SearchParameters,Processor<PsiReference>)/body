{
  final PsiMethod method=p.getMethod();
  final boolean[] isConstructor=new boolean[1];
  final PsiManager[] psiManager=new PsiManager[1];
  final String[] methodName=new String[1];
  final boolean[] isValueAnnotation=new boolean[1];
  final boolean[] needStrictSignatureSearch=new boolean[1];
  final boolean strictSignatureSearch=p.isStrictSignatureSearch();
  final PsiClass aClass=ApplicationManager.getApplication().runReadAction(new Computable<PsiClass>(){
    public PsiClass compute(){
      PsiClass aClass=method.getContainingClass();
      if (aClass == null)       return null;
      isConstructor[0]=method.isConstructor();
      psiManager[0]=aClass.getManager();
      methodName[0]=method.getName();
      isValueAnnotation[0]=PsiUtil.isAnnotationMethod(method) && PsiAnnotation.DEFAULT_REFERENCED_METHOD_NAME.equals(methodName[0]) && method.getParameterList().getParametersCount() == 0;
      needStrictSignatureSearch[0]=strictSignatureSearch && (aClass instanceof PsiAnonymousClass || aClass.hasModifierProperty(PsiModifier.FINAL) || method.hasModifierProperty(PsiModifier.STATIC)|| method.hasModifierProperty(PsiModifier.FINAL)|| method.hasModifierProperty(PsiModifier.PRIVATE));
      return aClass;
    }
  }
);
  if (aClass == null)   return;
  final SearchRequestCollector collector=p.getOptimizer();
  final SearchScope searchScope=ApplicationManager.getApplication().runReadAction(new Computable<SearchScope>(){
    @Override public SearchScope compute(){
      return p.getEffectiveSearchScope();
    }
  }
);
  if (isConstructor[0]) {
    new ConstructorReferencesSearchHelper(psiManager[0]).processConstructorReferences(consumer,method,aClass,searchScope,false,strictSignatureSearch,collector);
  }
  if (isValueAnnotation[0]) {
    Processor<PsiReference> refProcessor=PsiAnnotationMethodReferencesSearcher.createImplicitDefaultAnnotationMethodConsumer(consumer);
    ReferencesSearch.search(aClass,searchScope).forEach(refProcessor);
  }
  if (needStrictSignatureSearch[0]) {
    ReferencesSearch.searchOptimized(method,searchScope,false,collector,consumer);
    return;
  }
  if (StringUtil.isEmpty(methodName[0])) {
    return;
  }
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      final PsiMethod[] methods=strictSignatureSearch ? new PsiMethod[]{method} : aClass.findMethodsByName(methodName[0],false);
      SearchScope accessScope=methods[0].getUseScope();
      for (int i=1; i < methods.length; i++) {
        PsiMethod method1=methods[i];
        accessScope=accessScope.union(method1.getUseScope());
      }
      SearchScope restrictedByAccessScope=searchScope.intersectWith(accessScope);
      short searchContext=UsageSearchContext.IN_CODE | UsageSearchContext.IN_COMMENTS | UsageSearchContext.IN_FOREIGN_LANGUAGES;
      collector.searchWord(methodName[0],restrictedByAccessScope,searchContext,true,method,getTextOccurrenceProcessor(methods,aClass,strictSignatureSearch));
      SimpleAccessorReferenceSearcher.addPropertyAccessUsages(method,restrictedByAccessScope,collector);
    }
  }
);
}
