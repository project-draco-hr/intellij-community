{
  VirtualFile vFile=myFixture.getTempDirFixture().createFile("foo.py");
  final Project project=myFixture.getProject();
  PsiFileImpl fooPyFile=(PsiFileImpl)PsiManager.getInstance(project).findFile(vFile);
  final Document fooDocument=fooPyFile.getViewProvider().getDocument();
  Collection<PyClass> classes=PyClassNameIndex.find("Foo",project,GlobalSearchScope.allScope(project));
  assertEquals(classes.size(),0);
  new WriteCommandAction.Simple(project,fooPyFile){
    public void run(){
      fooDocument.setText("class Foo: pass");
    }
  }
.execute();
  PsiDocumentManager.getInstance(project).commitDocument(fooDocument);
  fooPyFile.setTreeElementPointer(null);
  DumbServiceImpl.getInstance(project).setDumb(true);
  try {
    assertEquals(1,((PyFile)fooPyFile).getTopLevelClasses().size());
    assertFalse(fooPyFile.isContentsLoaded());
  }
  finally {
    DumbServiceImpl.getInstance(project).setDumb(false);
  }
  classes=PyClassNameIndex.find("Foo",project,GlobalSearchScope.allScope(project));
  assertEquals(classes.size(),1);
}
