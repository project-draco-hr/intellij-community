{
  if (!initialState.equals(ModalityState.current())) {
    return;
  }
  final ThreadInfo[] infos=ThreadDumper.getThreadInfos();
  final String edtTrace=ThreadDumper.dumpEdtStackTrace(infos);
  if (edtTrace.contains("java.lang.ClassLoader.loadClass")) {
    return;
  }
  final boolean isInDumbMode=project != null && !project.isDisposed() && DumbService.isDumb(project);
  final String dumps=ThreadDumper.dumpThreadsToString();
  final String msg="Typing freeze report, (DumbMode=" + isInDumbMode + ") thread dumps attached. EDT stacktrace:\n"+ edtTrace+ "\n\n\n";
  if (Registry.is("typing.freeze.report.dumps")) {
    ThreadDumpInfo info=new ThreadDumpInfo(infos,isInDumbMode);
    String report=ReporterKt.createReportLine("typing-freeze-dumps",info);
    if (!StatsSender.INSTANCE.send(report,true)) {
      LOG.debug("Error while reporting thread dump");
    }
  }
 else {
    LOG.error(msg,dumps);
  }
}
