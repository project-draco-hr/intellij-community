{
  if (pathMacroSubstitutor != null) {
    pathMacroSubstitutor.expandPaths(rootElement);
  }
  StringInterner interner=intern ? new StringInterner() : null;
  List<Element> children=rootElement.getChildren(COMPONENT);
  if (children.isEmpty() && rootElement.getName().equals(COMPONENT) && rootElement.getAttributeValue(NAME) != null) {
    children=Collections.singletonList(rootElement);
  }
  TreeMap<String,Element> map=new TreeMap<>();
  for (  Element element : children) {
    String name=getComponentNameIfValid(element);
    if (name == null || !(element.getAttributes().size() > 1 || !element.getChildren().isEmpty())) {
      continue;
    }
    if (interner != null) {
      JDOMUtil.internElement(element,interner);
    }
    map.put(name,element);
    if (pathMacroSubstitutor instanceof TrackingPathMacroSubstitutor) {
      ((TrackingPathMacroSubstitutor)pathMacroSubstitutor).addUnknownMacros(name,PathMacrosCollector.getMacroNames(element));
    }
    element.removeAttribute(NAME);
  }
  return map;
}
