{
  Language language=getLanguageFromCaret(project,editor,file);
  FileType fileType=LanguageUtil.getLanguageFileType(language);
  if (fileType == null)   return null;
  CharSequence fileSnippet=text.subSequence(0,Math.min(text.length(),10 * 1024));
  PsiFileFactory fileFactory=PsiFileFactory.getInstance(file.getProject());
  PsiFile psiFile=fileFactory.createFileFromText("a." + fileType.getDefaultExtension(),language,fileSnippet);
  PsiErrorElement firstError=SyntaxTraverser.psiTraverser(psiFile).traverse().filter(PsiErrorElement.class).first();
  return firstError == null || firstError.getParent() != psiFile ? language : null;
}
