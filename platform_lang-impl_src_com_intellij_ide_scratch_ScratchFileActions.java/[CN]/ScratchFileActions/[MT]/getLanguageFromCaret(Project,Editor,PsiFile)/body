{
  if (editor == null || psiFile == null)   return null;
  Caret caret=editor.getCaretModel().getPrimaryCaret();
  int offset=caret.getOffset();
  PsiElement element=InjectedLanguageManager.getInstance(project).findInjectedElementAt(psiFile,offset);
  PsiFile file=element != null ? element.getContainingFile() : psiFile;
  return file.getLanguage();
}
