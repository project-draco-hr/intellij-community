{
  final Project project=CommonDataKeys.PROJECT.getData(e.getDataContext());
  if (project == null) {
    return;
  }
  DebuggerContextImpl context=(DebuggerManagerEx.getInstanceEx(project)).getContext();
  final DebuggerSession session=context.getDebuggerSession();
  if (session != null && session.isAttached()) {
    final DebugProcessImpl process=context.getDebugProcess();
    if (process != null) {
      process.getManagerThread().invoke(new DebuggerCommandImpl(){
        protected void action() throws Exception {
          final List<ThreadState> threads=ThreadDumpAction.buildThreadStates(process.getVirtualMachineProxy());
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            public void run(){
              ExportToTextFileAction.export(project,ThreadDumpPanel.createToFileExporter(project,threads));
            }
          }
,ModalityState.NON_MODAL);
        }
      }
);
    }
  }
}
