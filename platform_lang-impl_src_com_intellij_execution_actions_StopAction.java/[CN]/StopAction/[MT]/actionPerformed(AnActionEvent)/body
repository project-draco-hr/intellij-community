{
  final DataContext dataContext=e.getDataContext();
  Project project=e.getProject();
  List<Pair<TaskInfo,ProgressIndicator>> cancellableProcesses=getCancellableProcesses(project);
  List<RunContentDescriptor> stoppableDescriptors=getActiveStoppableDescriptors(dataContext);
  if (isPlaceGlobal(e)) {
    int todoSize=cancellableProcesses.size() + stoppableDescriptors.size();
    if (todoSize == 1) {
      if (!stoppableDescriptors.isEmpty()) {
        stopProcess(stoppableDescriptors.get(0));
      }
 else {
        cancellableProcesses.get(0).second.cancel();
      }
      return;
    }
    Pair<List<HandlerItem>,HandlerItem> handlerItems=getItemsList(cancellableProcesses,stoppableDescriptors,getRecentlyStartedContentDescriptor(dataContext));
    if (handlerItems == null || handlerItems.first.isEmpty()) {
      return;
    }
    final JBList list=new JBList(handlerItems.first);
    if (handlerItems.second != null)     list.setSelectedValue(handlerItems.second,true);
    list.setCellRenderer(new GroupedItemsListRenderer(new ListItemDescriptorAdapter(){
      @Nullable @Override public String getTextFor(      Object value){
        return value instanceof HandlerItem ? ((HandlerItem)value).displayName : null;
      }
      @Nullable @Override public Icon getIconFor(      Object value){
        return value instanceof HandlerItem ? ((HandlerItem)value).icon : null;
      }
      @Override public boolean hasSeparatorAboveOf(      Object value){
        return value instanceof HandlerItem && ((HandlerItem)value).hasSeparator;
      }
    }
));
    JBPopup popup=JBPopupFactory.getInstance().createListPopupBuilder(list).setMovable(true).setTitle(handlerItems.first.size() == 1 ? "Confirm process stop" : "Stop process").setFilteringEnabled(new Function<Object,String>(){
      @Override public String fun(      Object o){
        return ((HandlerItem)o).displayName;
      }
    }
).setItemChoosenCallback(new Runnable(){
      @Override public void run(){
        HandlerItem item=(HandlerItem)list.getSelectedValue();
        if (item != null)         item.stop();
      }
    }
).setRequestFocus(true).createPopup();
    InputEvent inputEvent=e.getInputEvent();
    Component component=inputEvent != null ? inputEvent.getComponent() : null;
    if (component != null && ActionPlaces.MAIN_TOOLBAR.equals(e.getPlace())) {
      popup.showUnderneathOf(component);
    }
 else     if (project == null) {
      popup.showInBestPositionFor(dataContext);
    }
 else {
      popup.showCenteredInCurrentWindow(project);
    }
  }
 else {
    stopProcess(getRecentlyStartedContentDescriptor(dataContext));
  }
}
