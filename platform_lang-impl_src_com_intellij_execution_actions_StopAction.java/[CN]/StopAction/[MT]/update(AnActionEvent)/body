{
  boolean enable=false;
  Icon icon=getTemplatePresentation().getIcon();
  String description=getTemplatePresentation().getDescription();
  Presentation presentation=e.getPresentation();
  if (ActionPlaces.isMainMenuOrActionSearch(e.getPlace()) || ActionPlaces.MAIN_TOOLBAR.equals(e.getPlace())) {
    List<RunContentDescriptor> stoppableDescriptors=getActiveStoppableDescriptors(e.getDataContext());
    List<Pair<TaskInfo,ProgressIndicator>> cancellableProcesses=getCancellableProcesses(e.getProject());
    int todoSize=stoppableDescriptors.size() + cancellableProcesses.size();
    if (todoSize > 1) {
      presentation.setText(getTemplatePresentation().getText() + "...");
    }
 else     if (todoSize == 1) {
      if (stoppableDescriptors.size() == 1) {
        presentation.setText(ExecutionBundle.message("stop.configuration.action.name",stoppableDescriptors.get(0).getDisplayName()));
      }
 else {
        TaskInfo taskInfo=cancellableProcesses.get(0).first;
        presentation.setText(taskInfo.getCancelText() + " " + taskInfo.getTitle());
      }
    }
 else {
      presentation.setText(getTemplatePresentation().getText());
    }
    enable=todoSize > 0;
    if (todoSize > 1) {
      icon=IconUtil.addText(icon,String.valueOf(todoSize));
    }
  }
 else {
    RunContentDescriptor contentDescriptor=e.getData(LangDataKeys.RUN_CONTENT_DESCRIPTOR);
    ProcessHandler processHandler=contentDescriptor == null ? null : contentDescriptor.getProcessHandler();
    if (processHandler != null && !processHandler.isProcessTerminated()) {
      if (!processHandler.isProcessTerminating()) {
        enable=true;
      }
 else       if (processHandler instanceof KillableProcess && ((KillableProcess)processHandler).canKillProcess()) {
        enable=true;
        icon=AllIcons.Debugger.KillProcess;
        description="Kill process";
      }
    }
    RunProfile runProfile=e.getData(LangDataKeys.RUN_PROFILE);
    if (runProfile == null && contentDescriptor == null) {
      presentation.setText(getTemplatePresentation().getText());
    }
 else {
      presentation.setText(ExecutionBundle.message("stop.configuration.action.name",runProfile == null ? contentDescriptor.getDisplayName() : runProfile.getName()));
    }
  }
  presentation.setEnabled(enable);
  presentation.setIcon(icon);
  presentation.setDescription(description);
}
