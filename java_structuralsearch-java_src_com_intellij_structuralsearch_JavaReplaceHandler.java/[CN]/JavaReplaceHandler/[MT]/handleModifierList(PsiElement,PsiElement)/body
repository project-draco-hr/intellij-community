{
  Map<String,String> newNameToSearchPatternNameMap=myContext.getNewName2PatternNameMap();
  Map<String,PsiNamedElement> originalNamedElements=Collector.collectNamedElements(el);
  Map<String,PsiNamedElement> replacedNamedElements=Collector.collectNamedElements(replacement);
  if (originalNamedElements.size() == 0 && replacedNamedElements.size() == 0) {
    Replacer.handleComments(el,replacement,myContext);
    return;
  }
  Map<String,PsiNamedElement> searchedNamedElements=Collector.collectNamedElements(getCodeBlock());
  for (  String name : originalNamedElements.keySet()) {
    PsiNamedElement originalNamedElement=originalNamedElements.get(name);
    PsiNamedElement replacementNamedElement=replacedNamedElements.get(name);
    String key=newNameToSearchPatternNameMap.get(name);
    if (key == null)     key=name;
    PsiNamedElement searchNamedElement=searchedNamedElements.get(key);
    if (replacementNamedElement == null && originalNamedElements.size() == 1 && replacedNamedElements.size() == 1) {
      replacementNamedElement=replacedNamedElements.entrySet().iterator().next().getValue();
    }
    PsiElement comment=null;
    if (originalNamedElement instanceof PsiDocCommentOwner) {
      comment=((PsiDocCommentOwner)originalNamedElement).getDocComment();
      if (comment == null) {
        PsiElement prevElement=originalNamedElement.getPrevSibling();
        if (prevElement instanceof PsiWhiteSpace) {
          prevElement=prevElement.getPrevSibling();
        }
        if (prevElement instanceof PsiComment) {
          comment=prevElement;
        }
      }
    }
    if (replacementNamedElement != null && searchNamedElement != null) {
      Replacer.handleComments(originalNamedElement,replacementNamedElement,myContext);
    }
    if (comment != null && replacementNamedElement instanceof PsiDocCommentOwner && !(replacementNamedElement.getFirstChild() instanceof PsiDocComment)) {
      final PsiElement nextSibling=comment.getNextSibling();
      PsiElement prevSibling=comment.getPrevSibling();
      replacementNamedElement.addRangeBefore(prevSibling instanceof PsiWhiteSpace ? prevSibling : comment,nextSibling instanceof PsiWhiteSpace ? nextSibling : comment,replacementNamedElement.getFirstChild());
    }
    if (originalNamedElement instanceof PsiModifierListOwner && replacementNamedElement instanceof PsiModifierListOwner) {
      PsiModifierList modifierList=((PsiModifierListOwner)originalNamedElements.get(name)).getModifierList();
      if (searchNamedElement instanceof PsiModifierListOwner) {
        PsiModifierList modifierListOfSearchedElement=((PsiModifierListOwner)searchNamedElement).getModifierList();
        final PsiModifierListOwner modifierListOwner=((PsiModifierListOwner)replacementNamedElement);
        PsiModifierList modifierListOfReplacement=modifierListOwner.getModifierList();
        if (modifierListOfSearchedElement.getTextLength() == 0 && modifierListOfReplacement.getTextLength() == 0 && modifierList.getTextLength() > 0) {
          modifierListOfReplacement.replace(modifierList);
        }
 else         if (modifierListOfSearchedElement.getTextLength() == 0 && modifierList.getTextLength() > 0) {
          final PsiModifierList copy=(PsiModifierList)modifierList.copy();
          for (          String modifier : PsiModifier.MODIFIERS) {
            if (modifierListOfReplacement.hasExplicitModifier(modifier)) {
              copy.setModifierProperty(modifier,true);
            }
          }
          final PsiElement anchor=copy.getFirstChild();
          for (          PsiAnnotation annotation : modifierListOfReplacement.getAnnotations()) {
            copy.addBefore(annotation,anchor);
          }
          modifierListOfReplacement.replace(copy);
        }
      }
    }
  }
}
