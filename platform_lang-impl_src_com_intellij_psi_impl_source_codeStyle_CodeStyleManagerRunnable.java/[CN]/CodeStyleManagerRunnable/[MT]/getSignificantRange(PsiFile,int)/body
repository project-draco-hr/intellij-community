{
  final ASTNode elementAtOffset=SourceTreeToPsiMap.psiElementToTree(CodeStyleManagerImpl.findElementInTreeWithFormatterEnabled(file,offset));
  if (elementAtOffset == null) {
    int significantRangeStart=CharArrayUtil.shiftBackward(file.getText(),offset - 1,"\r\t ");
    return new TextRange(Math.max(significantRangeStart,0),offset);
  }
  final FormattingModelBuilder builder=LanguageFormatting.INSTANCE.forContext(file);
  final TextRange textRange=builder.getRangeAffectingIndent(file,offset,elementAtOffset);
  if (textRange != null) {
    return textRange;
  }
  return elementAtOffset.getTextRange();
}
