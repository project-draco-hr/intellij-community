{
  ApplicationManager.getApplication().assertIsDispatchThread();
  final boolean wasWritingAllowed=myWritingAllowed;
  setWritingAllowed(true);
  myCurrentTransaction=new TransactionIdImpl(myCurrentTransaction);
  return new AccessToken(){
    @Override public void finish(){
      Queue<Transaction> queue=getQueue(myCurrentTransaction.myParent);
      queue.addAll(myCurrentTransaction.myQueue);
      if (!queue.isEmpty()) {
        pollQueueLater();
      }
      setWritingAllowed(wasWritingAllowed);
      myCurrentTransaction.myFinished=true;
      myCurrentTransaction=myCurrentTransaction.myParent;
    }
  }
;
}
