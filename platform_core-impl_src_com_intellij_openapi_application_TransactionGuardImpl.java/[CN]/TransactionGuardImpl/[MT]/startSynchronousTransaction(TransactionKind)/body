{
  ApplicationManager.getApplication().assertIsDispatchThread();
  if (myTransactionStartTrace != null) {
    if (myMergeableKinds.contains(kind)) {
      return AccessToken.EMPTY_ACCESS_TOKEN;
    }
    LOG.error("Nested transactions are not allowed, see FAQ in TransactionGuard class javadoc. Transaction start trace is in attachment. Kind is " + kind,new Attachment("trace.txt",myTransactionStartTrace));
  }
  myTransactionStartTrace=DebugUtil.currentStackTrace();
  return new AccessToken(){
    @Override public void finish(){
      myTransactionStartTrace=null;
      if (!myQueue.isEmpty()) {
        pollQueueLater();
      }
    }
  }
;
}
