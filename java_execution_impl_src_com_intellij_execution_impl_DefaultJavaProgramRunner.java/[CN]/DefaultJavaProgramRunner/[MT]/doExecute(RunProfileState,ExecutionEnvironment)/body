{
  FileDocumentManager.getInstance().saveAllDocuments();
  ExecutionResult executionResult;
  boolean shouldAddDefaultActions=true;
  if (state instanceof JavaCommandLine) {
    final JavaParameters parameters=((JavaCommandLine)state).getJavaParameters();
    patch(parameters,env.getRunnerSettings(),env.getRunProfile(),true);
    ProcessProxy proxy=ProcessProxyFactory.getInstance().createCommandLineProxy((JavaCommandLine)state);
    executionResult=state.execute(env.getExecutor(),this);
    if (proxy != null) {
      ProcessHandler handler=executionResult != null ? executionResult.getProcessHandler() : null;
      if (handler != null) {
        proxy.attach(handler);
        handler.addProcessListener(new ProcessAdapter(){
          @Override public void processTerminated(          ProcessEvent event){
            proxy.destroy();
          }
        }
);
      }
 else {
        proxy.destroy();
      }
    }
    if (state instanceof JavaCommandLineState && !((JavaCommandLineState)state).shouldAddJavaProgramRunnerActions()) {
      shouldAddDefaultActions=false;
    }
  }
 else {
    executionResult=state.execute(env.getExecutor(),this);
  }
  if (executionResult == null) {
    return null;
  }
  onProcessStarted(env.getRunnerSettings(),executionResult);
  final RunContentBuilder contentBuilder=new RunContentBuilder(executionResult,env);
  if (shouldAddDefaultActions) {
    addDefaultActions(contentBuilder,executionResult);
  }
  return contentBuilder.showRunContent(env.getContentToReuse());
}
