{
  StringBuffer buf=new StringBuffer();
  for (int i=0; i < 1000; i++) {
    buf.append(DebugUtil.currentStackTrace());
  }
  final StringBuffer output=new StringBuffer();
  final JUnit4TestListener sender=createListener(output);
  final Description description=Description.createTestDescription("A","a");
  sender.testFailure(new Failure(description,new ComparisonFailure(buf.toString(),buf.toString(),"diff" + buf.toString())));
  final String startMessage="##teamcity[enteredTheMatrix]\n\n" + "##teamcity[testFailed name='A.a' ";
  assertEquals(startMessage,StringUtil.convertLineSeparators(output.substring(0,startMessage.length() + 1)));
}
