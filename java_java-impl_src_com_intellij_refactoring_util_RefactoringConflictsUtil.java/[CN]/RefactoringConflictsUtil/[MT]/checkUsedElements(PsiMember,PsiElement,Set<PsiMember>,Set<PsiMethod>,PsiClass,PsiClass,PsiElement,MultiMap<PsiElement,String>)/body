{
  final Set<PsiMember> moving=new HashSet<>(membersToMove);
  if (abstractMethods != null) {
    moving.addAll(abstractMethods);
  }
  if (scope instanceof PsiReferenceExpression) {
    PsiReferenceExpression refExpr=(PsiReferenceExpression)scope;
    PsiElement refElement=refExpr.resolve();
    if (refElement instanceof PsiMember) {
      PsiExpression qualifier=refExpr.getQualifierExpression();
      PsiClass qualifierAccessClass=(PsiClass)(qualifier != null && !(qualifier instanceof PsiSuperExpression) ? PsiUtil.getAccessObjectClass(qualifier).getElement() : accessClass);
      if (!RefactoringHierarchyUtil.willBeInTargetClass(refElement,moving,targetClass,false) && (qualifierAccessClass == null || !RefactoringHierarchyUtil.willBeInTargetClass(qualifierAccessClass,moving,targetClass,false))) {
        checkAccessibility((PsiMember)refElement,context,qualifierAccessClass,member,conflicts);
      }
    }
  }
 else   if (scope instanceof PsiNewExpression) {
    final PsiNewExpression newExpression=(PsiNewExpression)scope;
    final PsiAnonymousClass anonymousClass=newExpression.getAnonymousClass();
    if (anonymousClass != null) {
      if (!RefactoringHierarchyUtil.willBeInTargetClass(anonymousClass,moving,targetClass,false)) {
        checkAccessibility(anonymousClass,context,anonymousClass,member,conflicts);
      }
    }
 else {
      final PsiMethod refElement=newExpression.resolveConstructor();
      if (refElement != null) {
        if (!RefactoringHierarchyUtil.willBeInTargetClass(refElement,moving,targetClass,false)) {
          checkAccessibility(refElement,context,accessClass,member,conflicts);
        }
      }
    }
  }
 else   if (scope instanceof PsiJavaCodeReferenceElement) {
    PsiJavaCodeReferenceElement refExpr=(PsiJavaCodeReferenceElement)scope;
    PsiElement refElement=refExpr.resolve();
    if (refElement instanceof PsiMember) {
      if (!RefactoringHierarchyUtil.willBeInTargetClass(refElement,moving,targetClass,false)) {
        checkAccessibility((PsiMember)refElement,context,accessClass,member,conflicts);
      }
    }
  }
  for (  PsiElement child : scope.getChildren()) {
    if (child instanceof PsiWhiteSpace || child instanceof PsiComment)     continue;
    checkUsedElements(member,child,membersToMove,abstractMethods,targetClass,child instanceof PsiClass ? (PsiClass)child : accessClass,context,conflicts);
  }
}
