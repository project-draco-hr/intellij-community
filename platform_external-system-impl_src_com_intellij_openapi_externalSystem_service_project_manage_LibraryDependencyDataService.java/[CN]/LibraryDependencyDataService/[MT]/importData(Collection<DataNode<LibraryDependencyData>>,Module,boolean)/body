{
  ExternalSystemApiUtil.executeProjectChangeAction(synchronous,new Runnable(){
    @Override public void run(){
      importMissingProjectLibraries(module,nodesToImport,synchronous);
      Map<Set<String>,LibraryDependencyData> moduleLibrariesToImport=ContainerUtilRt.newHashMap();
      Map<String,LibraryDependencyData> projectLibrariesToImport=ContainerUtilRt.newHashMap();
      Set<LibraryDependencyData> toImport=ContainerUtilRt.newLinkedHashSet();
      for (      DataNode<LibraryDependencyData> dependencyNode : nodesToImport) {
        LibraryDependencyData dependencyData=dependencyNode.getData();
        LibraryData libraryData=dependencyData.getTarget();
switch (dependencyData.getLevel()) {
case MODULE:
          Set<String> paths=ContainerUtilRt.newHashSet();
        for (        String path : libraryData.getPaths(LibraryPathType.BINARY)) {
          paths.add(ExternalSystemApiUtil.toCanonicalPath(path));
        }
      moduleLibrariesToImport.put(paths,dependencyData);
    toImport.add(dependencyData);
  break;
case PROJECT:
projectLibrariesToImport.put(libraryData.getName(),dependencyData);
toImport.add(dependencyData);
}
}
ModuleRootManager moduleRootManager=ModuleRootManager.getInstance(module);
final ModifiableRootModel moduleRootModel=moduleRootManager.getModifiableModel();
LibraryTable moduleLibraryTable=moduleRootModel.getModuleLibraryTable();
Set<String> moduleLibraryKey=ContainerUtilRt.newHashSet();
LibraryTable libraryTable=myPlatformFacade.getProjectLibraryTable(module.getProject());
try {
removeObsolete(moduleLibrariesToImport,projectLibrariesToImport,toImport,moduleRootModel,moduleLibraryKey);
if (!toImport.isEmpty()) {
importMissing(toImport,moduleRootModel,moduleLibraryTable,libraryTable,module);
}
}
  finally {
moduleRootModel.commit();
}
}
}
);
}
