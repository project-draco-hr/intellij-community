{
  String threeNotoriousRussianLetters="\u0416\u041e\u041f";
  configureByText(FileTypes.PLAIN_TEXT,threeNotoriousRussianLetters);
  VirtualFile virtualFile=getFile().getVirtualFile();
  final Document document=FileDocumentManager.getInstance().getDocument(virtualFile);
  WriteCommandAction.runWriteCommandAction(getProject(),new Runnable(){
    @Override public void run(){
      document.insertString(0," ");
      document.deleteString(0,1);
    }
  }
);
  assertTrue(FileDocumentManager.getInstance().isDocumentUnsaved(document));
  assertEquals(CharsetToolkit.UTF8_CHARSET,virtualFile.getCharset());
  Charset WINDOWS_1251=Charset.forName("windows-1251");
  virtualFile.setCharset(WINDOWS_1251);
  FileDocumentManager.getInstance().saveAllDocuments();
  assertEquals(WINDOWS_1251,virtualFile.getCharset());
  assertEquals(threeNotoriousRussianLetters,new String(virtualFile.contentsToByteArray(),WINDOWS_1251));
  virtualFile.setCharset(CharsetToolkit.UTF8_CHARSET);
  doHighlighting();
  List<HighlightInfo> infos=DaemonCodeAnalyzerEx.getInstanceEx(getProject()).getFileLevelHighlights(getProject(),getFile());
  HighlightInfo info=assertOneElement(infos);
  assertEquals("File was loaded in the wrong encoding: 'UTF-8'",info.getDescription());
}
