{
  final StatisticsService statisticsService=StatisticsUploadAssistant.getStatisticsService();
  if (StatisticsUploadAssistant.isShouldShowNotification()) {
    myFrameStateManager.addListener(new FrameStateListener.Adapter(){
      @Override public void onFrameActivated(){
        if (((WindowManagerEx)WindowManager.getInstance()).getMostRecentFocusedWindow() instanceof IdeFrameImpl) {
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            @Override public void run(){
              StatisticsNotificationManager.showNotification(statisticsService);
            }
          }
);
          myFrameStateManager.removeListener(this);
        }
      }
    }
);
  }
 else   if (StatisticsUploadAssistant.isSendAllowed() && StatisticsUploadAssistant.isTimeToSend()) {
    StatisticsService serviceToUse=null;
    StatisticsServiceEP[] extensions=StatisticsService.EP_NAME.getExtensions();
    if (extensions.length > 1) {
      LOG.warn(String.format("More than one stats service detected (%s). Falling back to the built-in one",Arrays.toString(extensions)));
    }
 else     if (extensions.length == 1) {
      serviceToUse=extensions[0].getInstance();
    }
    if (serviceToUse == null) {
      serviceToUse=statisticsService;
    }
    runWithDelay(serviceToUse);
  }
}
