{
  List<String> filterParameters=ContainerUtil.newArrayList();
  List<VcsLogBranchFilter> branchFilters=ContainerUtil.findAll(filters,VcsLogBranchFilter.class);
  if (!branchFilters.isEmpty()) {
    String branchFilter=joinFilters(branchFilters,new Function<VcsLogBranchFilter,String>(){
      @Override public String fun(      VcsLogBranchFilter filter){
        return filter.getBranchName();
      }
    }
);
    filterParameters.add(prepareParameter("branch",branchFilter));
  }
  List<VcsLogUserFilter> userFilters=ContainerUtil.findAll(filters,VcsLogUserFilter.class);
  if (!userFilters.isEmpty()) {
    String authorFilter=joinFilters(userFilters,new Function<VcsLogUserFilter,String>(){
      @Override public String fun(      VcsLogUserFilter filter){
        return filter.getUserName(root);
      }
    }
);
    filterParameters.add(prepareParameter("user",authorFilter));
  }
  List<VcsLogDateFilter> dateFilters=ContainerUtil.findAll(filters,VcsLogDateFilter.class);
  if (!dateFilters.isEmpty()) {
    StringBuilder args=new StringBuilder();
    final SimpleDateFormat dateFormatter=new SimpleDateFormat("yyyy-MM-dd HH:mm");
    filterParameters.add("-r");
    VcsLogDateFilter filter=dateFilters.iterator().next();
    if (filter.getAfter() != null) {
      args.append("date('>").append(dateFormatter.format(filter.getAfter())).append("')");
    }
    if (filter.getBefore() != null) {
      if (args.length() > 0) {
        args.append(" and ");
      }
      args.append("date('<").append(dateFormatter.format(filter.getBefore())).append("')");
    }
    filterParameters.add(args.toString());
  }
  List<VcsLogTextFilter> textFilters=ContainerUtil.findAll(filters,VcsLogTextFilter.class);
  if (textFilters.size() > 1) {
    LOG.warn("Expected only one text filter: " + textFilters);
  }
 else   if (!textFilters.isEmpty()) {
    String textFilter=textFilters.iterator().next().getText();
    filterParameters.add(prepareParameter("keyword",textFilter));
  }
  List<VcsLogStructureFilter> structureFilters=ContainerUtil.findAll(filters,VcsLogStructureFilter.class);
  if (!structureFilters.isEmpty()) {
    for (    VcsLogStructureFilter filter : structureFilters) {
      for (      VirtualFile file : filter.getFiles(root)) {
        filterParameters.add(file.getPath());
      }
    }
  }
  return HgHistoryUtil.history(myProject,root,-1,ArrayUtil.toStringArray(filterParameters));
}
