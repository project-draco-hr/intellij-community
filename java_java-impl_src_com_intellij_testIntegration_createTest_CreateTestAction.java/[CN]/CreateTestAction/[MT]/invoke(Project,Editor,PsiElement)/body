{
  final Module srcModule=ModuleUtilCore.findModuleForPsiElement(element);
  if (srcModule == null)   return;
  final PsiClass srcClass=getContainingClass(element);
  if (srcClass == null)   return;
  PsiDirectory srcDir=element.getContainingFile().getContainingDirectory();
  PsiPackage srcPackage=JavaDirectoryService.getInstance().getPackage(srcDir);
  final PropertiesComponent propertiesComponent=PropertiesComponent.getInstance();
  Module testModule=suggestModuleForTests(project,srcModule);
  final List<VirtualFile> testRootUrls=computeTestRoots(testModule);
  if (testRootUrls.isEmpty() && computeSuitableTestRootUrls(testModule).isEmpty()) {
    testModule=srcModule;
    if (!propertiesComponent.getBoolean(CREATE_TEST_IN_THE_SAME_ROOT)) {
      if (Messages.showOkCancelDialog(project,"Create test in the same source root?","No Test Roots Found",Messages.getQuestionIcon()) != Messages.OK) {
        return;
      }
      propertiesComponent.setValue(CREATE_TEST_IN_THE_SAME_ROOT,true);
    }
  }
  final CreateTestDialog d=createTestDialog(project,testModule,srcClass,srcPackage);
  if (!d.showAndGet()) {
    return;
  }
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    @Override public void run(){
      TestFramework framework=d.getSelectedTestFrameworkDescriptor();
      final TestGenerator generator=TestGenerators.INSTANCE.forLanguage(framework.getLanguage());
      DumbService.getInstance(project).withAlternativeResolveEnabled(new Runnable(){
        @Override public void run(){
          generator.generateTest(project,d);
        }
      }
);
    }
  }
,CodeInsightBundle.message("intention.create.test"),this);
}
