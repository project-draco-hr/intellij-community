{
  if (ranges.isEmpty()) {
    return;
  }
  ApplicationManager.getApplication().assertWriteAccessAllowed();
  PsiDocumentManager.getInstance(getProject()).commitAllDocuments();
  CheckUtil.checkWritable(file);
  if (!SourceTreeToPsiMap.hasTreeElement(file)) {
    return;
  }
  ASTNode treeElement=SourceTreeToPsiMap.psiElementToTree(file);
  transformAllChildren(treeElement);
  final CodeFormatterFacade codeFormatter=new CodeFormatterFacade(getSettings());
  LOG.assertTrue(file.isValid());
  if (editor == null) {
    editor=PsiUtilBase.findEditor(file);
  }
  CaretPositionKeeper caretKeeper=null;
  if (editor != null) {
    caretKeeper=new CaretPositionKeeper(editor);
  }
  final SmartPointerManager smartPointerManager=SmartPointerManager.getInstance(getProject());
  List<RangeFormatInfo> infos=new ArrayList<RangeFormatInfo>();
  for (  TextRange range : ranges) {
    final PsiElement start=findElementInTreeWithFormatterEnabled(file,range.getStartOffset());
    final PsiElement end=findElementInTreeWithFormatterEnabled(file,range.getEndOffset());
    if (start != null && !start.isValid()) {
      LOG.error("start=" + start + "; file="+ file);
    }
    if (end != null && !end.isValid()) {
      LOG.error("end=" + start + "; end="+ file);
    }
    boolean formatFromStart=range.getStartOffset() == 0;
    boolean formatToEnd=range.getEndOffset() == file.getTextLength();
    infos.add(new RangeFormatInfo(start == null ? null : smartPointerManager.createSmartPsiElementPointer(start),end == null ? null : smartPointerManager.createSmartPsiElementPointer(end),formatFromStart,formatToEnd));
  }
  FormatTextRanges formatRanges=new FormatTextRanges();
  for (  TextRange range : ranges) {
    formatRanges.add(range,true);
  }
  codeFormatter.processText(file,formatRanges,true);
  for (  RangeFormatInfo info : infos) {
    final PsiElement startElement=info.startPointer == null ? null : info.startPointer.getElement();
    final PsiElement endElement=info.endPointer == null ? null : info.endPointer.getElement();
    if ((startElement != null || info.fromStart) && (endElement != null || info.toEnd)) {
      postProcessText(file,new TextRange(info.fromStart ? 0 : startElement.getTextRange().getStartOffset(),info.toEnd ? file.getTextLength() : endElement.getTextRange().getEndOffset()));
    }
    if (info.startPointer != null)     smartPointerManager.removePointer(info.startPointer);
    if (info.endPointer != null)     smartPointerManager.removePointer(info.endPointer);
  }
  if (caretKeeper != null) {
    caretKeeper.restoreCaretPosition();
  }
}
