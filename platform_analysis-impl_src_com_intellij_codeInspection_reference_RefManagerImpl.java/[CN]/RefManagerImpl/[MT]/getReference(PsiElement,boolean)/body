{
  if (ApplicationManager.getApplication().runReadAction(new Computable<Boolean>(){
    @Override public Boolean compute(){
      return elem == null || !elem.isValid() || elem instanceof LightElement || !(elem instanceof PsiDirectory) && !belongsToScope(elem,ignoreScope);
    }
  }
)) {
    return null;
  }
  return getFromRefTableOrCache(elem,new NullableFactory<RefElementImpl>(){
    @Override public RefElementImpl create(){
      return ApplicationManager.getApplication().runReadAction(new Computable<RefElementImpl>(){
        @Override @Nullable public RefElementImpl compute(){
          final RefManagerExtension extension=getExtension(elem.getLanguage());
          if (extension != null) {
            final RefElement refElement=extension.createRefElement(elem);
            if (refElement != null)             return (RefElementImpl)refElement;
          }
          if (elem instanceof PsiFile) {
            return new RefFileImpl((PsiFile)elem,RefManagerImpl.this);
          }
          if (elem instanceof PsiDirectory) {
            return new RefDirectoryImpl((PsiDirectory)elem,RefManagerImpl.this);
          }
          return null;
        }
      }
);
    }
  }
,new Consumer<RefElementImpl>(){
    @Override public void consume(    RefElementImpl element){
      element.initialize();
      for (      RefManagerExtension each : myExtensions.values()) {
        each.onEntityInitialized(element,elem);
      }
      fireNodeInitialized(element);
    }
  }
);
}
