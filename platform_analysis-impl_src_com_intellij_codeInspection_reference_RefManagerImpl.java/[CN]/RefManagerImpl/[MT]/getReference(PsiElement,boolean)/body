{
  if (ApplicationManager.getApplication().runReadAction(new Computable<Boolean>(){
    @Override public Boolean compute(){
      return elem == null || !elem.isValid() || elem instanceof LightElement || !(elem instanceof PsiDirectory) && !belongsToScope(elem,ignoreScope);
    }
  }
)) {
    return null;
  }
  return getFromRefTableOrCache(elem,new NullableFactory<RefElement>(){
    @Override public RefElement create(){
      return ApplicationManager.getApplication().runReadAction(new Computable<RefElementImpl>(){
        @Override @Nullable public RefElementImpl compute(){
          RefElementImpl result=null;
          final RefManagerExtension extension=getExtension(elem.getLanguage());
          if (extension != null) {
            final RefElement refElement=extension.createRefElement(elem);
            result=(RefElementImpl)refElement;
          }
 else           if (elem instanceof PsiFile) {
            result=new RefFileImpl((PsiFile)elem,RefManagerImpl.this);
          }
 else           if (elem instanceof PsiDirectory) {
            result=new RefDirectoryImpl((PsiDirectory)elem,RefManagerImpl.this);
          }
          if (result == null) {
            return null;
          }
          result.initialize();
          for (          RefManagerExtension each : myExtensions.values()) {
            each.onEntityInitialized(result,elem);
          }
          fireNodeInitialized(result);
          return result;
        }
      }
);
    }
  }
);
}
