{
  myLock.readLock().lock();
  T result;
  try {
    result=(T)myRefTable.get(ApplicationManager.getApplication().runReadAction(new Computable<PsiAnchor>(){
      @Override public PsiAnchor compute(){
        return PsiAnchor.create(element);
      }
    }
));
  }
  finally {
    myLock.readLock().unlock();
  }
  if (result != null)   return result;
  if (!isValidPointForReference()) {
    return null;
  }
  myLock.writeLock().lock();
  try {
    result=(T)myRefTable.get(ApplicationManager.getApplication().runReadAction(new Computable<PsiAnchor>(){
      @Override public PsiAnchor compute(){
        return PsiAnchor.create(element);
      }
    }
));
    if (result != null)     return result;
    result=factory.create();
    if (result == null)     return null;
    myRefTable.put(ApplicationManager.getApplication().runReadAction(new Computable<PsiAnchor>(){
      @Override public PsiAnchor compute(){
        return PsiAnchor.create(element);
      }
    }
),result);
  }
  finally {
    myLock.writeLock().unlock();
  }
  if (whenCached != null)   whenCached.consume(result);
  return result;
}
