{
  if ("#".equals(ref)) {
    return root;
  }
  final JsonSchemaObject found=ids.get(ref);
  if (found != null)   return found;
  if (!ref.startsWith("#/")) {
    int idx=ref.indexOf("#/");
    if (idx == -1)     throw new RuntimeException("Non-relative or erroneous reference: " + ref);
    if (!processCrossReferences)     return null;
    final String url=ref.substring(0,idx);
    final String relative=ref.substring(idx);
    return JsonSchemaCrossDefinitions.getInstance(project).findDefinition(url,relative,root);
  }
  ref=ref.substring(2);
  final String[] parts=ref.split("/");
  JsonSchemaObject current=root;
  for (int i=0; i < parts.length; i++) {
    if (current == null)     throw new RuntimeException("Incorrect reference: " + ref);
    final String part=parts[i];
    if ("definitions".equals(part)) {
      if (i == (parts.length - 1))       throw new RuntimeException("Incorrect definition reference: " + ref);
      current=current.getDefinitions().get(parts[++i]);
      continue;
    }
    if ("properties".equals(part)) {
      if (i == (parts.length - 1))       throw new RuntimeException("Incorrect properties reference: " + ref);
      current=current.getProperties().get(parts[++i]);
      continue;
    }
    current=current.getDefinitions().get(part);
  }
  if (current == null)   throw new RuntimeException("Incorrect reference: " + ref);
  return current;
}
