{
  if (trimFileScheme && url.startsWith(StandardFileSystems.FILE_PROTOCOL_PREFIX)) {
    return Urls.newLocalFileUrl(FileUtil.toCanonicalPath(VfsUtilCore.toIdeaUrl(url,true).substring(StandardFileSystems.FILE_PROTOCOL_PREFIX.length()),'/'));
  }
 else   if (baseUrl == null || url.contains(URLUtil.SCHEME_SEPARATOR) || url.startsWith("data:") || url.startsWith("blob:") || url.startsWith("javascript:")) {
    return Urls.parseEncoded(url);
  }
  String path=canonicalizePath(url,baseUrl,baseUrlIsFile);
  if (baseUrl.getScheme() == null && baseUrl.isInLocalFileSystem()) {
    return Urls.newLocalFileUrl(path);
  }
  if (isAbsolute(path)) {
    VirtualFile file=LocalFileFinder.findFile(path);
    if (file != null) {
      if (absoluteLocalPathToSourceIndex == null) {
        absoluteLocalPathToSourceIndex=createStringIntMap(rawSources.size());
        sourceIndexToAbsoluteLocalPath=new String[rawSources.size()];
      }
      absoluteLocalPathToSourceIndex.put(path,sourceIndex);
      sourceIndexToAbsoluteLocalPath[sourceIndex]=path;
      String canonicalPath=file.getCanonicalPath();
      if (canonicalPath != null && !canonicalPath.equals(path)) {
        absoluteLocalPathToSourceIndex.put(canonicalPath,sourceIndex);
      }
      return Urls.newLocalFileUrl(path);
    }
  }
  return new UrlImpl(baseUrl.getScheme(),baseUrl.getAuthority(),path,null);
}
