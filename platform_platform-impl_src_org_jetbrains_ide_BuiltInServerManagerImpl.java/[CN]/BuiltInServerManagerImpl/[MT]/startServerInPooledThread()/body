{
  Application application=ApplicationManager.getApplication();
  if (application.isUnitTestMode() && !enabledInUnitTestMode) {
    return null;
  }
  if (!started.compareAndSet(false,true)) {
    return null;
  }
  return application.executeOnPooledThread(new Runnable(){
    @Override public void run(){
      int defaultPort=getDefaultPort();
      int workerCount=1;
      if (Runtime.getRuntime().availableProcessors() > 1) {
        for (        CustomPortServerManager customPortServerManager : CustomPortServerManager.EP_NAME.getExtensions()) {
          if (customPortServerManager.getPort() != defaultPort) {
            workerCount=2;
            break;
          }
        }
      }
      try {
        server=new BuiltInServer();
        detectedPortNumber=server.start(workerCount,defaultPort,PORTS_COUNT,true);
      }
 catch (      ChannelException e) {
        LOG.info(e);
        String groupDisplayId="Built-in Server";
        Notifications.Bus.register(groupDisplayId,NotificationDisplayType.STICKY_BALLOON);
        new Notification(groupDisplayId,"Internal HTTP server disabled","Cannot start internal HTTP server. Git integration, JavaScript debugger and LiveEdit may operate with errors. " + "Please check your firewall settings and restart " + ApplicationNamesInfo.getInstance().getFullProductName(),NotificationType.ERROR).notify(null);
        return;
      }
      if (detectedPortNumber == -1) {
        LOG.info("built-in server cannot be started, cannot bind to port");
        return;
      }
      LOG.info("built-in server started, port " + detectedPortNumber);
      Disposer.register(ApplicationManager.getApplication(),server);
      ShutDownTracker.getInstance().registerShutdownTask(new Runnable(){
        @Override public void run(){
          if (!Disposer.isDisposed(server)) {
            Disposer.dispose(server);
          }
        }
      }
);
    }
  }
);
}
