{
  Preconditions.checkNotNull(myDocStringOwner,"For this action docstring owner must be supplied");
  final String replacementText=buildDocString();
  final Project project=myDocStringOwner.getProject();
  PyElementGenerator elementGenerator=PyElementGenerator.getInstance(project);
  final PyExpressionStatement replacement=elementGenerator.createDocstring(replacementText);
  final PyStringLiteralExpression docStringExpression=getDocStringExpression();
  if (docStringExpression != null) {
    docStringExpression.replace(replacement.getExpression());
  }
 else {
    PyStatementListContainer container=PyUtil.as(myDocStringOwner,PyStatementListContainer.class);
    if (container == null) {
      throw new IllegalStateException("Should be a function or class");
    }
    final PyStatementList statements=container.getStatementList();
    final String indentation=PyIndentUtil.getExpectedElementIndent(statements);
    final Document document=PsiDocumentManager.getInstance(project).getDocument(myDocStringOwner.getContainingFile());
    if (document != null) {
      final PsiElement beforeStatements=statements.getPrevSibling();
      final boolean onSameLine=!(beforeStatements instanceof PsiWhiteSpace) || !beforeStatements.textContains('\n');
      if (onSameLine || statements.getStatements().length == 0) {
        String replacementWithLineBreaks="\n" + indentation + replacementText;
        if (statements.getStatements().length > 0) {
          replacementWithLineBreaks+="\n" + indentation;
        }
        final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
        documentManager.doPostponedOperationsAndUnblockDocument(document);
        final TextRange range=beforeStatements.getTextRange();
        try {
          if (beforeStatements instanceof PsiWhiteSpace) {
            if (statements.getStatements().length > 0) {
              document.replaceString(range.getStartOffset(),range.getEndOffset(),replacementWithLineBreaks);
            }
 else {
              document.insertString(range.getStartOffset(),replacementWithLineBreaks);
            }
          }
 else {
            document.insertString(range.getEndOffset(),replacementWithLineBreaks);
          }
        }
  finally {
          documentManager.commitDocument(document);
        }
      }
 else {
        statements.addBefore(replacement,statements.getStatements()[0]);
      }
    }
  }
  myDocStringOwner=CodeInsightUtilCore.forcePsiPostprocessAndRestoreElement(myDocStringOwner);
  return myDocStringOwner;
}
