{
  final RefElementNode nodeToBeAdded=container.createNode(presentation);
  final Ref<Boolean> firstLevel=new Ref<Boolean>(true);
  RefElementNode prevNode=null;
  final Ref<RefElementNode> result=new Ref<RefElementNode>();
  while (true) {
    final RefElementNode currentNode=firstLevel.get() ? nodeToBeAdded : container.createNode(presentation);
    final UserObjectContainer finalContainer=container;
    final RefElementNode finalPrevNode=prevNode;
    TreeUtil.traverseDepth(parentNode,new TreeUtil.Traverse(){
      @Override public boolean accept(      Object node){
        if (node instanceof RefElementNode) {
          final RefElementNode refElementNode=(RefElementNode)node;
          final Object userObject=finalContainer.getUserObject();
          final Object object=node instanceof OfflineRefElementNode ? ((OfflineRefElementNode)refElementNode).getOfflineDescriptor() : refElementNode.getUserObject();
          if ((object == null || userObject.getClass().equals(object.getClass())) && finalContainer.areEqual(object,userObject)) {
            if (firstLevel.get()) {
              result.set(refElementNode);
              return false;
            }
 else {
              refElementNode.insertByOrder(finalPrevNode);
              result.set(nodeToBeAdded);
              return false;
            }
          }
        }
        return true;
      }
    }
);
    if (!result.isNull())     return result.get();
    if (!firstLevel.get()) {
      currentNode.insertByOrder(prevNode);
    }
    final UserObjectContainer owner=container.getOwner();
    if (owner == null) {
      parentNode.insertByOrder(currentNode);
      return nodeToBeAdded;
    }
    container=owner;
    prevNode=currentNode;
    firstLevel.set(false);
  }
}
