{
  StudyEditor studyEditor=StudyUtils.getSelectedStudyEditor(project);
  StudyState studyState=new StudyState(studyEditor);
  if (!studyState.isValid()) {
    return;
  }
  Task nextTask=getTargetTask(studyState.getTask());
  if (nextTask == null) {
    return;
  }
  for (  VirtualFile file : FileEditorManager.getInstance(project).getOpenFiles()) {
    FileEditorManager.getInstance(project).closeFile(file);
  }
  int nextTaskIndex=nextTask.getIndex();
  int lessonIndex=nextTask.getLesson().getIndex();
  Map<String,TaskFile> nextTaskFiles=nextTask.getTaskFiles();
  VirtualFile projectDir=project.getBaseDir();
  String lessonDirName=EduNames.LESSON + String.valueOf(lessonIndex);
  if (projectDir == null) {
    return;
  }
  VirtualFile lessonDir=projectDir.findChild(lessonDirName);
  if (lessonDir == null) {
    return;
  }
  String taskDirName=EduNames.TASK + String.valueOf(nextTaskIndex);
  VirtualFile taskDir=lessonDir.findChild(taskDirName);
  if (taskDir == null) {
    return;
  }
  if (nextTaskFiles.isEmpty()) {
    ProjectView.getInstance(project).select(taskDir,taskDir,false);
    return;
  }
  VirtualFile shouldBeActive=getFileToActivate(project,nextTaskFiles,taskDir);
  JTree tree=ProjectView.getInstance(project).getCurrentProjectViewPane().getTree();
  TreePath path=tree.getSelectionPath();
  if (path != null) {
    TreePath oldSelectionPath=path.getParentPath();
    if (oldSelectionPath != null) {
      tree.collapsePath(oldSelectionPath);
      tree.fireTreeCollapsed(oldSelectionPath);
    }
  }
  if (shouldBeActive != null) {
    ProjectView.getInstance(project).select(shouldBeActive,shouldBeActive,false);
    FileEditorManager.getInstance(project).openFile(shouldBeActive,true);
  }
  ToolWindow runToolWindow=ToolWindowManager.getInstance(project).getToolWindow(ToolWindowId.RUN);
  if (runToolWindow != null) {
    runToolWindow.hide(null);
  }
}
