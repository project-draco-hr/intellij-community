{
  final Set<String> paths;
synchronized (myStateLock) {
    myState.validateRecentProjects();
    paths=ContainerUtil.newLinkedHashSet(myState.recentPaths);
  }
  Set<String> openedPaths=new THashSet<String>();
  for (  Project openProject : ProjectManager.getInstance().getOpenProjects()) {
    ContainerUtil.addIfNotNull(openedPaths,getProjectPath(openProject));
  }
  paths.remove(null);
  paths.removeAll(openedPaths);
  List<AnAction> actions=new SmartList<AnAction>();
  Set<String> duplicates=getDuplicateProjectNames(openedPaths,paths);
  if (useGroups) {
    final List<ProjectGroup> groups=new ArrayList<ProjectGroup>(new ArrayList<ProjectGroup>(myState.groups));
    final List<String> projectPaths=new ArrayList<String>(paths);
    Collections.sort(groups,new Comparator<ProjectGroup>(){
      @Override public int compare(      ProjectGroup o1,      ProjectGroup o2){
        int ind1=getGroupIndex(o1);
        int ind2=getGroupIndex(o2);
        return ind1 == ind2 ? StringUtil.naturalCompare(o1.getName(),o2.getName()) : ind1 - ind2;
      }
      private int getGroupIndex(      ProjectGroup group){
        int index=-1;
        for (        String path : group.getProjects()) {
          final int i=projectPaths.indexOf(path);
          if (index >= 0 && index > i) {
            index=i;
          }
        }
        return index;
      }
    }
);
    for (    ProjectGroup group : groups) {
      paths.removeAll(group.getProjects());
    }
    for (    ProjectGroup group : groups) {
      final List<AnAction> children=new ArrayList<AnAction>();
      for (      String path : group.getProjects()) {
        final AnAction action=createOpenAction(path,duplicates);
        if (action != null) {
          children.add(action);
        }
      }
      actions.add(new ProjectGroupActionGroup(group,children));
      if (group.isExpanded()) {
        for (        AnAction child : children) {
          actions.add(child);
        }
      }
    }
  }
  for (  final String path : paths) {
    final AnAction action=createOpenAction(path,duplicates);
    if (action != null) {
      actions.add(action);
    }
  }
  if (actions.isEmpty()) {
    return AnAction.EMPTY_ARRAY;
  }
  if (addClearListItem) {
    AnAction manageAction=new DumbAwareAction("Manage projects..."){
      @Override public void actionPerformed(      AnActionEvent e){
        Disposable disposable=new Disposable(){
          @Override public void dispose(){
          }
        }
;
        NewRecentProjectPanel panel=new NewRecentProjectPanel(disposable);
        JList list=UIUtil.findComponentOfType(panel,JList.class);
        JBPopup popup=JBPopupFactory.getInstance().createComponentPopupBuilder(panel,list).setTitle("Recent Projects").setFocusable(true).setMovable(true).createPopup();
        Disposer.register(disposable,popup);
        popup.showCenteredInCurrentWindow(e.getProject());
      }
    }
;
    if (Registry.is("ide.manage.recent.project.action.available")) {
      actions.add(0,manageAction);
      actions.add(1,Separator.getInstance());
    }
    AnAction clearListAction=new DumbAwareAction(IdeBundle.message("action.clear.list")){
      @Override public void actionPerformed(      @NotNull AnActionEvent e){
        String message=IdeBundle.message("action.clear.list.message");
        String title=IdeBundle.message("action.clear.list.title");
        if (Messages.showOkCancelDialog(e.getProject(),message,title,Messages.getQuestionIcon()) == Messages.OK) {
synchronized (myStateLock) {
            myState.recentPaths.clear();
          }
          WelcomeFrame.clearRecents();
        }
      }
    }
;
    actions.add(Separator.getInstance());
    actions.add(clearListAction);
  }
  return actions.toArray(new AnAction[actions.size()]);
}
