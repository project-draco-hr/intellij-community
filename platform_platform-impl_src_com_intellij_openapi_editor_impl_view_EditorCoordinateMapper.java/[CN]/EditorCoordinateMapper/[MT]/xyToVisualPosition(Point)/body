{
  int visualLine=yToVisualLine(Math.max(p.y,0));
  int logicalLine=visualToLogicalLine(visualLine);
  int lastColumn=0;
  float x=getStartX(logicalLine);
  if (logicalLine < myDocument.getLineCount()) {
    for (    VisualLineFragmentsIterator.Fragment fragment : VisualLineFragmentsIterator.create(myView,myDocument.getLineStartOffset(logicalLine))) {
      float nextX=fragment.getEndX();
      if (p.x <= nextX) {
        return new VisualPosition(visualLine,fragment.xToVisualColumn(p.x));
      }
 else {
        x=nextX;
        lastColumn=fragment.getEndVisualColumn();
      }
    }
  }
  return new VisualPosition(visualLine,lastColumn + spacePixelsToColumns((int)(p.x - x)));
}
