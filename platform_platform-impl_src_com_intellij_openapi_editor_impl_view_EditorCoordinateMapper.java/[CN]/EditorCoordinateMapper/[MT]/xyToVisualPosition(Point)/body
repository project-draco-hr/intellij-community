{
  int visualLine=yToVisualLine(Math.max(p.y,0));
  int logicalLine=visualToLogicalLine(visualLine);
  int lastColumn=0;
  float x=getStartX(logicalLine);
  if (logicalLine < myDocument.getLineCount()) {
    for (    VisualLineFragmentsIterator.Fragment fragment : VisualLineFragmentsIterator.create(myView,myDocument.getLineStartOffset(logicalLine))) {
      float nextX=fragment.getEndX();
      if (p.x <= nextX) {
        int[] column=fragment.xToVisualColumn(p.x);
        return new VisualPosition(visualLine,column[0],column[1] > 0);
      }
 else {
        x=nextX;
        lastColumn=fragment.getEndVisualColumn();
      }
    }
  }
  int plainSpaceWidth=myView.getPlainSpaceWidth();
  int remainingShift=(int)(p.x - x);
  int additionalColumns=remainingShift <= 0 ? 0 : (remainingShift + plainSpaceWidth / 2) / plainSpaceWidth;
  return new VisualPosition(visualLine,lastColumn + additionalColumns,remainingShift >= 0 && additionalColumns == remainingShift / plainSpaceWidth);
}
