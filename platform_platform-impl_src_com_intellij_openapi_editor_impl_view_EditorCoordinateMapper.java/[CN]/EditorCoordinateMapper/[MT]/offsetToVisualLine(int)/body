{
  int textLength=myDocument.getTextLength();
  if (offset < 0 || textLength == 0) {
    return 0;
  }
  offset=Math.min(offset,textLength);
  FoldRegion outermostCollapsed=myFoldingModel.getCollapsedRegionAtOffset(offset);
  if (outermostCollapsed != null && offset > outermostCollapsed.getStartOffset()) {
    offset=outermostCollapsed.getStartOffset();
  }
  return myDocument.getLineNumber(offset) - myFoldingModel.getFoldedLinesCountBefore(offset);
}
