{
  int line=pos.line;
  if (line >= myDocument.getLineCount())   return myDocument.getTextLength();
  int lineStartOffset=myDocument.getLineStartOffset(line);
  if (ApplicationManager.getApplication().isDispatchThread()) {
    LineLayout lineLayout=myView.getLineLayout(line);
    return lineStartOffset + lineLayout.logicalColumnToOffset(pos.column);
  }
 else {
    int lineEndOffset=myDocument.getLineEndOffset(line);
    CharSequence text=myDocument.getImmutableCharSequence();
    int tabSize=myView.getTabSize();
    int column=0;
    for (int i=lineStartOffset; i < lineEndOffset; i++) {
      if (text.charAt(i) == '\t') {
        column=(column / tabSize + 1) * tabSize;
      }
 else {
        column++;
      }
      if (pos.column < column)       return i;
    }
    return lineEndOffset;
  }
}
