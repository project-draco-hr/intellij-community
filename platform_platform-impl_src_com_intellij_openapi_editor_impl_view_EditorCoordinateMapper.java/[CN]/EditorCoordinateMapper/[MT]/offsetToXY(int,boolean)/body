{
  offset=Math.max(0,Math.min(myDocument.getTextLength(),offset));
  int line=myDocument.getLineNumber(offset);
  int intraLineOffset=offset - myDocument.getLineStartOffset(line);
  int y=visualLineToY(line);
  float x=line == 0 ? myView.getPrefixTextWidthInPixels() : 0;
  if (myDocument.getTextLength() > 0 && (intraLineOffset > 0 || leanTowardsLargerOffsets)) {
    LineLayout lineLayout=myView.getLineLayout(line);
    for (    LineLayout.Fragment fragment : lineLayout.getFragmentsInVisualOrder()) {
      if (intraLineOffset > fragment.getStartOffset() && intraLineOffset < fragment.getEndOffset() || intraLineOffset == fragment.getStartOffset() && leanTowardsLargerOffsets || intraLineOffset == fragment.getEndOffset() && !leanTowardsLargerOffsets) {
        x=fragment.absoluteOffsetToX(x,intraLineOffset);
        break;
      }
 else {
        x=fragment.advance(x);
      }
    }
  }
  return new Point((int)x,y);
}
