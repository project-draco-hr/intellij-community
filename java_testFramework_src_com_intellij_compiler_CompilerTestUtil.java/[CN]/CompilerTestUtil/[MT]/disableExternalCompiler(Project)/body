{
  ApplicationManagerEx.getApplicationEx().doNotSave(true);
  final JavaAwareProjectJdkTableImpl table=JavaAwareProjectJdkTableImpl.getInstanceEx();
  new WriteAction(){
    @Override protected void run(    @NotNull final Result result){
      Module[] modules=ModuleManager.getInstance(project).getModules();
      Sdk internalJdk=table.getInternalJdk();
      List<Module> modulesToRestore=new ArrayList<Module>();
      for (      Module module : modules) {
        Sdk sdk=ModuleRootManager.getInstance(module).getSdk();
        if (sdk != null && sdk.equals(internalJdk)) {
          modulesToRestore.add(module);
        }
      }
      table.removeJdk(internalJdk);
      for (      Module module : modulesToRestore) {
        ModuleRootModificationUtil.setModuleSdk(module,internalJdk);
      }
      BuildManager.getInstance().clearState(project);
    }
  }
.execute();
}
