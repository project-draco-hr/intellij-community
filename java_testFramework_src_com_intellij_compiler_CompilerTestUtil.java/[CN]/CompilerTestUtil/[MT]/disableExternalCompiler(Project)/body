{
  try {
    EdtTestUtil.runInEdtAndWait(new ThrowableRunnable<Throwable>(){
      @Override public void run() throws Throwable {
        JavaAwareProjectJdkTableImpl table=JavaAwareProjectJdkTableImpl.getInstanceEx();
        AccessToken token=WriteAction.start();
        try {
          Sdk internalJdk=table.getInternalJdk();
          List<Module> modulesToRestore=new SmartList<Module>();
          for (          Module module : ModuleManager.getInstance(project).getModules()) {
            Sdk sdk=ModuleRootManager.getInstance(module).getSdk();
            if (sdk != null && sdk.equals(internalJdk)) {
              modulesToRestore.add(module);
            }
          }
          table.removeJdk(internalJdk);
          for (          Module module : modulesToRestore) {
            ModuleRootModificationUtil.setModuleSdk(module,internalJdk);
          }
          BuildManager.getInstance().clearState(project);
        }
  finally {
          token.finish();
        }
      }
    }
);
  }
  finally {
    ApplicationManagerEx.getApplicationEx().doNotSave(true);
  }
}
