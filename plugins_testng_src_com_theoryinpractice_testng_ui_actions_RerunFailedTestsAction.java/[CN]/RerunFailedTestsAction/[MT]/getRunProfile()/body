{
  final TestNGConfiguration configuration=(TestNGConfiguration)getModel().getProperties().getConfiguration();
  final List<AbstractTestProxy> failedTests=getFailedTests(configuration.getProject());
  return new MyRunProfile(configuration){
    @NotNull public Module[] getModules(){
      return Module.EMPTY_ARRAY;
    }
    public RunProfileState getState(    @NotNull Executor executor,    @NotNull ExecutionEnvironment env) throws ExecutionException {
      return new TestNGRunnableState(env,configuration){
        @Override protected SearchingForTestsTask createSearchingForTestsTask(        ServerSocket serverSocket,        final TestNGConfiguration config,        final File tempFile){
          return new SearchingForTestsTask(serverSocket,config,tempFile,client){
            @Override protected void fillTestObjects(            final Map<PsiClass,Collection<PsiMethod>> classes) throws CantRunException {
              final GlobalSearchScope scope=config.getConfigurationModule().getSearchScope();
              final Project project=config.getProject();
              for (              AbstractTestProxy proxy : failedTests) {
                final Location location=proxy.getLocation(project,scope);
                if (location != null) {
                  final PsiElement element=location.getPsiElement();
                  if (element instanceof PsiMethod && element.isValid()) {
                    final PsiMethod psiMethod=(PsiMethod)element;
                    PsiClass psiClass=psiMethod.getContainingClass();
                    if (psiClass != null && psiClass.hasModifierProperty(PsiModifier.ABSTRACT)) {
                      final AbstractTestProxy parent=proxy.getParent();
                      final PsiElement elt=parent != null ? parent.getLocation(project,scope).getPsiElement() : null;
                      if (elt instanceof PsiClass) {
                        psiClass=(PsiClass)elt;
                      }
                    }
                    Collection<PsiMethod> psiMethods=classes.get(psiClass);
                    if (psiMethods == null) {
                      psiMethods=new ArrayList<PsiMethod>();
                      classes.put(psiClass,psiMethods);
                    }
                    psiMethods.add(psiMethod);
                  }
                }
              }
            }
          }
;
        }
      }
;
    }
  }
;
}
