{
  indicator.setText("Building graph...");
  MutableGraph graph=GraphBuilder.build(commits,allRefs);
  GraphModel graphModel=new GraphModelImpl(graph);
  final GraphPrintCellModel printCellModel=new GraphPrintCellModelImpl(graphModel.getGraph());
  graphModel.addUpdateListener(new Consumer<UpdateRequest>(){
    @Override public void consume(    UpdateRequest key){
      printCellModel.recalculate(key);
    }
  }
);
  final RefsModel refsModel=new RefsModel(allRefs,indexGetter);
  graphModel.getFragmentManager().setUnconcealedNodeFunction(new Function<Node,Boolean>(){
    @NotNull @Override public Boolean fun(    @NotNull Node key){
      if (key.getDownEdges().isEmpty() || key.getUpEdges().isEmpty() || refsModel.isBranchRef(key.getCommitIndex())) {
        return true;
      }
 else {
        return false;
      }
    }
  }
);
  return new DataPack(graphModel,refsModel,printCellModel,hashGetter,indexGetter);
}
