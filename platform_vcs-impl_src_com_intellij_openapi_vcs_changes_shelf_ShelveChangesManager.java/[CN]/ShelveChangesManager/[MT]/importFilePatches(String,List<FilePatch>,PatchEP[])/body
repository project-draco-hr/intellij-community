{
  try {
    File schemePatchDir=generateUniqueSchemePatchDir(fileName);
    File patchPath=getPatchFileInConfigDir(fileName,schemePatchDir);
    myFileProcessor.savePathFile(new CompoundShelfFileProcessor.ContentProvider(){
      @Override public void writeContentTo(      final Writer writer,      CommitContext commitContext) throws IOException {
        UnifiedDiffWriter.write(myProject,patches,writer,"\n",patchTransitExtensions,commitContext);
      }
    }
,patchPath,new CommitContext());
    final ShelvedChangeList changeList=new ShelvedChangeList(patchPath.toString(),fileName.replace('\n',' '),new SmartList<ShelvedBinaryFile>());
    changeList.setName(schemePatchDir.getName());
    mySchemeManager.addNewScheme(changeList,false);
    return changeList;
  }
  finally {
    notifyStateChanged();
  }
}
