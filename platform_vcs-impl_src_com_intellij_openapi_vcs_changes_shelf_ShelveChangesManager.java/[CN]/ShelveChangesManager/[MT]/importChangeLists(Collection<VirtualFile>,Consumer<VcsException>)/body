{
  final List<ShelvedChangeList> result=new ArrayList<ShelvedChangeList>(files.size());
  try {
    final FilesProgress filesProgress=new FilesProgress(files.size(),"Processing ");
    for (    VirtualFile file : files) {
      filesProgress.updateIndicator(file);
      final String description=file.getNameWithoutExtension().replace('_',' ');
      File schemeDir=generateUniqueSchemePatchDir(description);
      final File patchPath=getPatchFileInConfigDir(description,schemeDir);
      final ShelvedChangeList list=new ShelvedChangeList(patchPath.getPath(),description,new SmartList<ShelvedBinaryFile>(),file.getTimeStamp());
      list.setName(patchPath.getName());
      try {
        final List<TextFilePatch> patchesList=loadPatches(myProject,file.getPath(),new CommitContext());
        if (!patchesList.isEmpty()) {
          FileUtil.copy(new File(file.getPath()),patchPath);
          mySchemesManager.addNewScheme(list,false);
          result.add(list);
        }
      }
 catch (      IOException e) {
        exceptionConsumer.consume(new VcsException(e));
      }
catch (      PatchSyntaxException e) {
        exceptionConsumer.consume(new VcsException(e));
      }
    }
  }
  finally {
    notifyStateChanged();
  }
  return result;
}
