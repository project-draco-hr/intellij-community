{
  final Git git=ServiceManager.getService(Git.class);
  final GitRepository repository=GithubUtil.getGitRepository(project,file);
  if (repository == null) {
    GithubNotifications.showError(project,CANNOT_CREATE_PULL_REQUEST,"Can't find git repository");
    return;
  }
  final Pair<GitRemote,String> remote=GithubUtil.findGithubRemote(repository);
  if (remote == null) {
    GithubNotifications.showError(project,CANNOT_CREATE_PULL_REQUEST,"Can't find GitHub remote");
    return;
  }
  final String remoteUrl=remote.getSecond();
  final String remoteName=remote.getFirst().getName();
  String upstreamUrl=GithubUtil.findUpstreamRemote(repository);
  final GithubFullPath upstreamUserAndRepo=upstreamUrl == null || !GithubUrlUtil.isGithubUrl(upstreamUrl) ? null : GithubUrlUtil.getUserAndRepositoryFromRemoteUrl(upstreamUrl);
  final GithubFullPath userAndRepo=GithubUrlUtil.getUserAndRepositoryFromRemoteUrl(remoteUrl);
  if (userAndRepo == null) {
    GithubNotifications.showError(project,CANNOT_CREATE_PULL_REQUEST,"Can't process remote: " + remoteUrl);
    return;
  }
  final GitLocalBranch currentBranch=repository.getCurrentBranch();
  if (currentBranch == null) {
    GithubNotifications.showError(project,CANNOT_CREATE_PULL_REQUEST,"No current branch");
    return;
  }
  final GithubInfo info=loadGithubInfoWithModal(project,userAndRepo,upstreamUserAndRepo);
  if (info == null) {
    return;
  }
  String suggestedBranch=info.getRepo().getParent() == null ? null : info.getRepo().getParent().getUserName() + ":master";
  final GithubCreatePullRequestDialog dialog=new GithubCreatePullRequestDialog(project,info.getBranches(),suggestedBranch);
  DialogManager.show(dialog);
  if (!dialog.isOK()) {
    return;
  }
  new Task.Backgroundable(project,"Creating pull request..."){
    @Override public void run(    @NotNull ProgressIndicator indicator){
      LOG.info("Pushing current branch");
      indicator.setText("Pushing current branch...");
      GitCommandResult result=git.push(repository,remoteName,remoteUrl,currentBranch.getName(),true);
      if (!result.success()) {
        GithubNotifications.showError(project,CANNOT_CREATE_PULL_REQUEST,"Push failed:<br/>" + result.getErrorOutputAsHtmlString());
        return;
      }
      LOG.info("Performing create request");
      indicator.setText("Performing create request...");
      GithubPullRequest request=createPullRequest(project,info,dialog,currentBranch.getName(),upstreamUserAndRepo);
      if (request == null) {
        return;
      }
      GithubNotifications.showInfoURL(project,"Successfully created pull request","Pull Request #" + request.getNumber(),request.getHtmlUrl());
    }
  }
.queue();
}
