{
  try {
    final EvaluationContextImpl thisEvaluationContext=getEvaluationContext(evaluationContext);
    final ExpressionEvaluator evaluator;
    if (Registry.is("debugger.compiling.evaluator")) {
      evaluator=new CompilingEvaluator(getEvaluationText());
    }
 else {
      evaluator=DebuggerInvocationUtil.commitAndRunReadAction(myProject,new EvaluatingComputable<ExpressionEvaluator>(){
        public ExpressionEvaluator compute() throws EvaluateException {
          final PsiElement psiContext=PositionUtil.getContextElement(evaluationContext);
          return getEffectiveCodeFragmentFactory(psiContext).getEvaluatorBuilder().build(getEvaluationCode(thisEvaluationContext),ContextUtil.getSourcePosition(thisEvaluationContext));
        }
      }
);
    }
    if (!thisEvaluationContext.getDebugProcess().isAttached()) {
      throw EvaluateExceptionUtil.PROCESS_EXITED;
    }
    StackFrameProxyImpl frameProxy=thisEvaluationContext.getFrameProxy();
    if (frameProxy == null) {
      throw EvaluateExceptionUtil.NULL_STACK_FRAME;
    }
    final Value value=evaluator.evaluate(thisEvaluationContext);
    if (value instanceof ObjectReference) {
      ObjectReference objRef=(ObjectReference)value;
      if (VirtualMachineProxyImpl.isCollected(objRef)) {
        throw EvaluateExceptionUtil.OBJECT_WAS_COLLECTED;
      }
      thisEvaluationContext.getSuspendContext().keep(objRef);
    }
    myModifier=evaluator.getModifier();
    setLvalue(myModifier != null);
    return value;
  }
 catch (  final EvaluateException ex) {
    throw new EvaluateException(ex.getLocalizedMessage(),ex);
  }
catch (  ObjectCollectedException ex) {
    throw EvaluateExceptionUtil.OBJECT_WAS_COLLECTED;
  }
}
