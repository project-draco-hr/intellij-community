{
  try {
    final EvaluationContextImpl thisEvaluationContext=getEvaluationContext(evaluationContext);
    SourcePosition position=ContextUtil.getSourcePosition(evaluationContext);
    PsiElement psiContext=ContextUtil.getContextElement(evaluationContext,position);
    ExpressionEvaluator evaluator=null;
    try {
      evaluator=DebuggerInvocationUtil.commitAndRunReadAction(myProject,new EvaluatingComputable<ExpressionEvaluator>(){
        public ExpressionEvaluator compute() throws EvaluateException {
          return DebuggerUtilsEx.findAppropriateCodeFragmentFactory(getEvaluationText(),psiContext).getEvaluatorBuilder().build(getEvaluationCode(thisEvaluationContext),position);
        }
      }
);
    }
 catch (    UnsupportedExpressionException ex) {
      if (Registry.is("debugger.compiling.evaluator") && psiContext != null) {
        evaluator=DebuggerInvocationUtil.commitAndRunReadAction(myProject,new EvaluatingComputable<ExpressionEvaluator>(){
          public ExpressionEvaluator compute() throws EvaluateException {
            PsiFile psiFile=psiContext.getContainingFile();
            PsiCodeFragment fragment=createCodeFragment(psiContext);
            try {
              ExtractLightMethodObjectHandler.ExtractedData data=ExtractLightMethodObjectHandler.extractLightMethodObject(myProject,psiFile,fragment,CompilingEvaluator.getGeneratedClassName());
              if (data != null) {
                return new CompilingEvaluatorImpl(evaluationContext,psiContext,data);
              }
            }
 catch (            PrepareFailedException e) {
              LOG.info(e);
            }
            return null;
          }
        }
);
      }
      if (evaluator == null) {
        throw ex;
      }
    }
    if (!thisEvaluationContext.getDebugProcess().isAttached()) {
      throw EvaluateExceptionUtil.PROCESS_EXITED;
    }
    StackFrameProxyImpl frameProxy=thisEvaluationContext.getFrameProxy();
    if (frameProxy == null) {
      throw EvaluateExceptionUtil.NULL_STACK_FRAME;
    }
    Value value=evaluator.evaluate(thisEvaluationContext);
    DebuggerUtilsEx.keep(value,thisEvaluationContext);
    myModifier=evaluator.getModifier();
    setLvalue(myModifier != null);
    return value;
  }
 catch (  final EvaluateException ex) {
    throw new EvaluateException(ex.getLocalizedMessage(),ex);
  }
catch (  ObjectCollectedException ex) {
    throw EvaluateExceptionUtil.OBJECT_WAS_COLLECTED;
  }
}
