{
  if (rejectIfClosed(callback)) {
    return;
  }
  int sequence=handler.getUpdatedSequence(message);
  callbackMap.put(sequence,callback);
  boolean success;
  try {
    success=handler.write(message);
  }
 catch (  Throwable e) {
    try {
      failedToSend(sequence);
    }
  finally {
      CommandProcessor.LOG.error("Failed to send",e);
    }
    return;
  }
  if (!success) {
    failedToSend(sequence);
  }
}
