{
  PsiElement newStart=lowerStartElementIfNeeded(start,end);
  PsiElement newEnd=lowerEndElementIfNeeded(start,end);
  if (newStart == null || newEnd == null) {
    return PsiElement.EMPTY_ARRAY;
  }
  PsiElement commonParent=findCommonAncestorForWholeRange(newStart,newEnd);
  if (commonParent != null) {
    return new PsiElement[]{commonParent};
  }
  PsiElement newStartParent=getParent(newStart);
  if (newStartParent != null && newStartParent.getFirstChild() == newStart && newStart.getFirstChild() == null) {
    newStart=newStartParent;
  }
  PsiElement newEndParent=getParent(newEnd);
  if (newEndParent != null && newEndParent.getLastChild() == newEnd && newEnd.getFirstChild() == null) {
    newEnd=newEndParent;
  }
  if (getParent(newStart) == getParent(newEnd)) {
    return new PsiElement[]{newStart,newEnd};
  }
  return PsiElement.EMPTY_ARRAY;
}
