{
  final boolean smRunner=Registry.is("testng_sm_runner");
  if (smRunner) {
    return startSMRunner(executor);
  }
  OSProcessHandler processHandler=startProcess();
  final TreeRootNode unboundOutputRoot=new TreeRootNode();
  final TestNGConsoleView console=new TestNGConsoleView(config,getEnvironment(),unboundOutputRoot,executor);
  console.initUI();
  unboundOutputRoot.setPrinter(console.getPrinter());
  Disposer.register(console,unboundOutputRoot);
  JavaRunConfigurationExtensionManager.getInstance().attachExtensionsToProcess(config,processHandler,runnerSettings);
  final SearchingForTestsTask task=createSearchingForTestsTask(myServerSocket,config,myTempFile);
  processHandler.addProcessListener(new ProcessAdapter(){
    private boolean myStarted=false;
    @Override public void processTerminated(    final ProcessEvent event){
      unboundOutputRoot.flush();
      if (mySearchForTestIndicator != null && !mySearchForTestIndicator.isCanceled()) {
        task.finish();
      }
    }
    @Override public void startNotified(    final ProcessEvent event){
      TestNGRemoteListener listener=new TestNGRemoteListener(console,unboundOutputRoot);
      if (config.isSaveOutputToFile()) {
        unboundOutputRoot.setOutputFilePath(config.getOutputFilePath());
      }
      client.prepareListening(listener,config.getProject(),port);
      myStarted=true;
      mySearchForTestIndicator=new BackgroundableProcessIndicator(task);
      ProgressManager.getInstance().runProcessWithProgressAsynchronously(task,mySearchForTestIndicator);
    }
    @Override public void processWillTerminate(    ProcessEvent event,    boolean willBeDestroyed){
      final TestNGResults resultsView=console.getResultsView();
      if (resultsView != null) {
        resultsView.finish(myStarted);
      }
    }
    private int myInsertIndex=0;
    @Override public void onTextAvailable(    final ProcessEvent event,    final Key outputType){
      final TestProxy currentTest=console.getCurrentTest();
      final String text=event.getText();
      final ConsoleViewContentType consoleViewType=ConsoleViewContentType.getConsoleViewType(outputType);
      final Printable printable=new Printable(){
        @Override public void printOn(        final Printer printer){
          printer.print(text,consoleViewType);
        }
      }
;
      if (currentTest != null) {
        currentTest.addLast(printable);
      }
 else {
        unboundOutputRoot.insert(printable,myInsertIndex);
      }
      myInsertIndex++;
    }
  }
);
  console.attachToProcess(processHandler);
  RerunFailedTestsAction rerunFailedTestsAction=new RerunFailedTestsAction(console,console.getProperties());
  rerunFailedTestsAction.setModelProvider(new Getter<TestFrameworkRunningModel>(){
    @Override public TestFrameworkRunningModel get(){
      return console.getResultsView();
    }
  }
);
  final DefaultExecutionResult result=new DefaultExecutionResult(console,processHandler);
  result.setRestartActions(rerunFailedTestsAction);
  return result;
}
