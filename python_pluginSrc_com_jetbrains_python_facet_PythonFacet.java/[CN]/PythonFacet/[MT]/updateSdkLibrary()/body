{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      final Module module=getModule();
      final ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
      final ModifiableRootModel model=rootManager.getModifiableModel();
      boolean modelChanged=false;
      final Sdk sdk=getConfiguration().getSdk();
      final String name=(sdk != null) ? getFacetLibraryName(sdk.getName()) : null;
      boolean librarySeen=false;
      for (      OrderEntry entry : model.getOrderEntries()) {
        if (entry instanceof LibraryOrderEntry) {
          final String libraryName=((LibraryOrderEntry)entry).getLibraryName();
          if (name != null && name.equals(libraryName)) {
            librarySeen=true;
            continue;
          }
          if (libraryName != null && libraryName.endsWith(PYTHON_FACET_LIBRARY_NAME_SUFFIX)) {
            model.removeOrderEntry(entry);
            modelChanged=true;
          }
        }
      }
      if (!librarySeen && name != null) {
        Library library=LibraryTablesRegistrar.getInstance().getLibraryTable().getLibraryByName(name);
        if (library == null) {
          library=PythonSdkTableListener.addLibrary(sdk);
          PyBuiltinCache.clearInstanceCache();
        }
        model.addLibraryEntry(library);
        modelChanged=true;
      }
      if (modelChanged) {
        model.commit();
      }
 else {
        model.dispose();
      }
    }
  }
);
}
