{
  HgPromptCommandExecutor commandExecutor=new HgPromptCommandExecutor(project);
  commandExecutor.setShowOutput(true);
  List<String> arguments=new LinkedList<String>();
  if (!StringUtil.isEmptyOrSpaces(revision)) {
    arguments.add("--rev");
    arguments.add(revision);
  }
  DvcsUtil.workingTreeChangeStarted(project);
  try {
    final HgCommandResult result=commandExecutor.executeInCurrentThread(repo,"merge",arguments);
    project.getMessageBus().syncPublisher(HgVcs.BRANCH_TOPIC).update(project,null);
    return result;
  }
  finally {
    DvcsUtil.workingTreeChangeFinished(project);
  }
}
