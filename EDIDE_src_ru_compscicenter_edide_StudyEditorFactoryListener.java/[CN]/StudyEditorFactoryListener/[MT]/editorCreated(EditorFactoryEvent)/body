{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      try {
        VirtualFile vfOpenedFile=FileDocumentManager.getInstance().getFile(event.getEditor().getDocument());
        if (vfOpenedFile != null) {
          String fileName=vfOpenedFile.getNameWithoutExtension() + ".meta";
          InputStream metaIS=StudyEditorFactoryListener.class.getResourceAsStream(fileName);
          if (metaIS == null) {
            return;
          }
          BufferedReader metaReader=new BufferedReader(new InputStreamReader(metaIS));
          int replaceNum=Integer.parseInt(metaReader.readLine());
          System.out.println("replaceNum = " + replaceNum);
          int startOffset0=0;
          PsiFile psiOpenFile=PsiManager.getInstance(event.getEditor().getProject()).findFile(vfOpenedFile);
          TemplateBuilder builder=TemplateBuilderFactory.getInstance().createTemplateBuilder(psiOpenFile);
          for (int i=0; i < replaceNum; i++) {
            int line=Integer.parseInt(metaReader.readLine()) - 1;
            int lineOffset=event.getEditor().getDocument().getLineStartOffset(line);
            int startOffset=lineOffset + Integer.parseInt(metaReader.readLine());
            if (i == 0) {
              startOffset0=startOffset;
            }
            System.out.println("startOffset = " + startOffset);
            String textToWrite=metaReader.readLine();
            String answer=metaReader.readLine();
            event.getEditor().getDocument().createRangeMarker(startOffset,startOffset + textToWrite.length());
            int endOffset=startOffset + textToWrite.length();
            TextRange range=new TextRange(startOffset,endOffset);
            builder.replaceRange(range,textToWrite);
          }
          Template template=((TemplateBuilderImpl)builder).buildInlineTemplate();
          Project project=event.getEditor().getProject();
          TemplateManager.getInstance(project).startTemplate(event.getEditor(),template);
          event.getEditor().getCaretModel().moveToOffset(startOffset0);
        }
      }
 catch (      IOException e) {
        System.out.println("Something wrong with meta file");
      }
    }
  }
);
}
