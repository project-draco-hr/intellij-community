{
  FileDocumentManager fileDocumentManager=FileDocumentManager.getInstance();
  VirtualFile openedFile=fileDocumentManager.getFile(e.getEditor().getDocument());
  StudyTaskManager taskManager=StudyTaskManager.getInstance(e.getEditor().getProject());
  TaskFile selectedTaskFile=taskManager.getTaskFile(openedFile);
  Window selectedWindow=selectedTaskFile.getSelectedWindow();
  Editor editor=e.getEditor();
  LogicalPosition pos=editor.xyToLogicalPosition(e.getMouseEvent().getPoint());
  Window window=myTaskFile.getTaskWindow(editor,pos);
  if (selectedWindow != null && selectedWindow != window) {
    DefaultActionGroup defaultActionGroup=new DefaultActionGroup();
    AnAction action=ActionManager.getInstance().getAction("CheckAction");
    AnAction resolveAction=ActionManager.getInstance().getAction("ResolveAction");
    AnAction nextAction=ActionManager.getInstance().getAction("NextWindow");
    AnAction prevAction=ActionManager.getInstance().getAction("PrevWindowAction");
    defaultActionGroup.add(action);
    defaultActionGroup.add(resolveAction);
    defaultActionGroup.add(nextAction);
    defaultActionGroup.add(prevAction);
    ListPopup popUp=JBPopupFactory.getInstance().createActionGroupPopup("What should we do with selected task window?",defaultActionGroup,DataManager.getInstance().getDataContext(e.getEditor().getComponent()),JBPopupFactory.ActionSelectionAid.MNEMONICS,true);
    popUp.showInBestPositionFor(DataManager.getInstance().getDataContext(e.getEditor().getComponent()));
    return;
  }
  if (window == null) {
    myTaskFile.drawAllWindows(editor);
    return;
  }
  if (selectedWindow == null) {
    editor.getMarkupModel().removeAllHighlighters();
    selectedTaskFile.setSelectedWindow(window);
    if (window.isResolveStatus()) {
      window.draw(editor,false,true);
    }
 else {
      window.draw(editor,true,true);
    }
  }
 else {
    if (!(selectedWindow == window)) {
      DefaultActionGroup defaultActionGroup=new DefaultActionGroup();
      AnAction action=ActionManager.getInstance().getAction("CheckAction");
      AnAction resolveAction=ActionManager.getInstance().getAction("ResolveAction");
      AnAction nextAction=ActionManager.getInstance().getAction("NextWindow");
      defaultActionGroup.add(action);
      defaultActionGroup.add(resolveAction);
      defaultActionGroup.add(nextAction);
      ListPopup popUp=JBPopupFactory.getInstance().createActionGroupPopup("What should we do with selected task window?",defaultActionGroup,DataManager.getInstance().getDataContext(e.getEditor().getComponent()),JBPopupFactory.ActionSelectionAid.MNEMONICS,true);
      popUp.showInBestPositionFor(DataManager.getInstance().getDataContext(e.getEditor().getComponent()));
    }
  }
}
