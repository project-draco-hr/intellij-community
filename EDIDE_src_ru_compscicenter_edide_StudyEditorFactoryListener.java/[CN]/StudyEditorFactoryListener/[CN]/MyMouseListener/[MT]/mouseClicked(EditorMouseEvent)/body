{
  Window selectedWindow=StudyTaskManager.getInstance(e.getEditor().getProject()).getSelectedWindow();
  Editor editor=e.getEditor();
  LogicalPosition pos=editor.xyToLogicalPosition(e.getMouseEvent().getPoint());
  Window window=myTaskFile.getTaskWindow(editor,pos);
  if (selectedWindow != null && selectedWindow != window) {
    DefaultActionGroup defaultActionGroup=new DefaultActionGroup();
    AnAction action=ActionManager.getInstance().getAction("ru.compscicenter.edide.actions.CheckAction");
    AnAction resolveAction=ActionManager.getInstance().getAction("ru.compscicenter.edide.actions.ResolveAction");
    AnAction nextAction=ActionManager.getInstance().getAction("NextWindow");
    AnAction prevAction=ActionManager.getInstance().getAction("PrevWindowAction");
    defaultActionGroup.add(action);
    defaultActionGroup.add(resolveAction);
    defaultActionGroup.add(nextAction);
    defaultActionGroup.add(prevAction);
    ListPopup popUp=JBPopupFactory.getInstance().createActionGroupPopup("What should we do with selected task window?",defaultActionGroup,DataManager.getInstance().getDataContext(e.getEditor().getComponent()),JBPopupFactory.ActionSelectionAid.MNEMONICS,true);
    popUp.showInBestPositionFor(DataManager.getInstance().getDataContext(e.getEditor().getComponent()));
    return;
  }
  if (window == null) {
    myTaskFile.drawAllWindows(editor);
    return;
  }
  StudyTaskManager taskManager=StudyTaskManager.getInstance(e.getEditor().getProject());
  if (taskManager.getSelectedWindow() == null) {
    editor.getMarkupModel().removeAllHighlighters();
    taskManager.setSelectedWindow(window);
    if (window.isResolveStatus()) {
      window.draw(editor,false);
    }
 else {
      window.draw(editor,true);
    }
  }
 else {
    if (!(taskManager.getSelectedWindow() == window)) {
      DefaultActionGroup defaultActionGroup=new DefaultActionGroup();
      AnAction action=ActionManager.getInstance().getAction("ru.compscicenter.edide.actions.CheckAction");
      AnAction resolveAction=ActionManager.getInstance().getAction("ru.compscicenter.edide.actions.ResolveAction");
      AnAction nextAction=ActionManager.getInstance().getAction("NextWindow");
      defaultActionGroup.add(action);
      defaultActionGroup.add(resolveAction);
      defaultActionGroup.add(nextAction);
      ListPopup popUp=JBPopupFactory.getInstance().createActionGroupPopup("What should we do with selected task window?",defaultActionGroup,DataManager.getInstance().getDataContext(e.getEditor().getComponent()),JBPopupFactory.ActionSelectionAid.MNEMONICS,true);
      popUp.showInBestPositionFor(DataManager.getInstance().getDataContext(e.getEditor().getComponent()));
    }
  }
}
