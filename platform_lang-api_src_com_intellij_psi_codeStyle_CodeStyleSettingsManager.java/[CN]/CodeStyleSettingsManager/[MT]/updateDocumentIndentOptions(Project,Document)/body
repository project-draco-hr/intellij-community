{
  if (!project.isDisposed()) {
    PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
    if (documentManager != null) {
      PsiFile file=documentManager.getPsiFile(document);
      if (file != null) {
        final Ref<FileIndentOptionsProvider> providerRef=new Ref<FileIndentOptionsProvider>();
        CommonCodeStyleSettings.IndentOptions indentOptions=getSettings(project).getIndentOptionsByFile(file,null,true,new Processor<FileIndentOptionsProvider>(){
          @Override public boolean process(          FileIndentOptionsProvider provider){
            providerRef.set(provider);
            return true;
          }
        }
);
        IndentOptionsInDocumentKeeper.storeIntoDocument(document,indentOptions,providerRef.get());
      }
    }
  }
}
