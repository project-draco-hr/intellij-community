{
  ExecutionEnvironment environment=null;
  ExecutionEnvironmentProvider environmentProvider=ServiceManager.getService(myProject,ExecutionEnvironmentProvider.class);
  if (environmentProvider != null) {
    environment=environmentProvider.createExecutionEnvironment(myProject,myRunProfile,myExecutor,myTarget,myRunnerSettings,myConfigurationSettings,myRunnerAndConfigurationSettings);
  }
  if (environment == null && myRunner == null) {
    if (myRunnerId == null) {
      myRunner=RunnerRegistry.getInstance().getRunner(myExecutor.getId(),myRunProfile);
    }
 else {
      myRunner=RunnerRegistry.getInstance().findRunnerById(myRunnerId);
    }
  }
  if (environment == null && myRunner == null) {
    throw new IllegalStateException("Runner must be specified");
  }
  if (environment == null) {
    environment=new ExecutionEnvironment(myRunProfile,myExecutor,myTarget,myProject,myRunnerSettings,myConfigurationSettings,myContentToReuse,myRunnerAndConfigurationSettings,myRunner);
  }
  if (myAssignNewId) {
    environment.assignNewExecutionId();
  }
  if (myDataContext != null) {
    environment.setDataContext(myDataContext);
  }
  myUserData.copyUserDataTo(environment);
  return environment;
}
