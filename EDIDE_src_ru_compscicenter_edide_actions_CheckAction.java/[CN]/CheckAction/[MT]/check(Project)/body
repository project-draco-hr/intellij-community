{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        @Override public void run(){
          final Editor selectedEditor=StudyEditor.getSelectedEditor(project);
          if (selectedEditor != null) {
            final FileDocumentManager fileDocumentManager=FileDocumentManager.getInstance();
            final VirtualFile openedFile=fileDocumentManager.getFile(selectedEditor.getDocument());
            if (openedFile != null) {
              StudyTaskManager taskManager=StudyTaskManager.getInstance(project);
              final TaskFile selectedTaskFile=taskManager.getTaskFile(openedFile);
              if (selectedTaskFile != null) {
                FileDocumentManager.getInstance().saveAllDocuments();
                final VirtualFile taskDir=openedFile.getParent();
                Task currentTask=selectedTaskFile.getTask();
                StudyRunAction runAction=(StudyRunAction)ActionManager.getInstance().getAction(StudyRunAction.ACTION_ID);
                if (runAction != null) {
                  runAction.run(project);
                }
                final StudyTestRunner testRunner=new StudyTestRunner(currentTask,taskDir);
                Process testProcess=null;
                try {
                  testProcess=testRunner.launchTests(project,openedFile.getPath());
                }
 catch (                ExecutionException e) {
                  LOG.error(e);
                }
                if (testProcess != null) {
                  final int testNum=currentTask.getTestNum();
                  String failedMessage=testRunner.getPassedTests(testProcess);
                  final int testPassed=testRunner.getTestPassed();
                  if (testPassed != 0 && failedMessage == null) {
                    currentTask.setStatus(StudyStatus.Solved);
                    StudyUtils.updateStudyToolWindow(project);
                    selectedTaskFile.drawAllWindows(selectedEditor);
                    ProjectView.getInstance(project).refresh();
                    createTestResultPopUp("Congratulations!",JBColor.GREEN,project);
                    return;
                  }
                  final TaskFile taskFileCopy=new TaskFile();
                  final VirtualFile copyWithAnswers=getCopyWithAnswers(taskDir,openedFile,selectedTaskFile,taskFileCopy);
                  for (                  final TaskWindow taskWindow : taskFileCopy.getTaskWindows()) {
                    check(project,taskWindow,copyWithAnswers,taskFileCopy,selectedTaskFile,selectedEditor.getDocument(),testRunner);
                  }
                  try {
                    copyWithAnswers.delete(this);
                  }
 catch (                  IOException e) {
                    LOG.error(e);
                  }
                  if (failedMessage == null) {
                    failedMessage="";
                  }
                  selectedTaskFile.drawAllWindows(selectedEditor);
                  String result=String.format("%d from %d tests failed\n %s",testNum - testPassed,testNum,failedMessage);
                  createTestResultPopUp(result,JBColor.RED,project);
                }
              }
            }
          }
        }
      }
,null,null);
    }
  }
);
}
