{
  rebuild();
  for (  FoldingListener listener : myListeners) {
    listener.onFoldProcessingEnd();
  }
  myEditor.updateCaretCursor();
  myEditor.recalculateSizeAndRepaint();
  myEditor.getGutterComponentEx().updateSize();
  myEditor.getGutterComponentEx().repaint();
  for (  Caret caret : myCaretsToMove) {
    Integer savedOffset=caret.getUserData(SAVED_CARET_OFFSET);
    if (savedOffset != null) {
      caret.moveToOffset(savedOffset);
    }
  }
  myCaretsToMove.clear();
  for (  Caret caret : myEditor.getCaretModel().getAllCarets()) {
    LogicalPosition caretPosition=caret.getLogicalPosition().withoutVisualPositionInfo();
    int caretOffset=myEditor.logicalPositionToOffset(caretPosition);
    int selectionStart=caret.getSelectionStart();
    int selectionEnd=caret.getSelectionEnd();
    int offsetToUse=-1;
    FoldRegion collapsed=myFoldTree.fetchOutermost(caretOffset);
    Integer savedOffset=caret.getUserData(SAVED_CARET_OFFSET);
    if (savedOffset != null) {
      FoldRegion collapsedAtSaved=myFoldTree.fetchOutermost(savedOffset);
      offsetToUse=collapsedAtSaved == null ? savedOffset : collapsedAtSaved.getStartOffset();
    }
    if (collapsed != null && offsetToUse < 0) {
      offsetToUse=collapsed.getStartOffset();
    }
    if (moveCaretFromCollapsedRegion && caret.isUpToDate()) {
      if (offsetToUse >= 0) {
        caret.moveToOffset(offsetToUse);
      }
 else {
        caret.moveToLogicalPosition(caretPosition);
      }
    }
    caret.putUserData(SAVED_CARET_OFFSET,savedOffset);
    if (isOffsetInsideCollapsedRegion(selectionStart) || isOffsetInsideCollapsedRegion(selectionEnd)) {
      caret.removeSelection();
    }
 else     if (selectionStart < myEditor.getDocument().getTextLength()) {
      caret.setSelection(selectionStart,selectionEnd);
    }
  }
  if (mySavedCaretShift > 0) {
    final ScrollingModel scrollingModel=myEditor.getScrollingModel();
    scrollingModel.disableAnimation();
    scrollingModel.scrollVertically(myEditor.visibleLineToY(myEditor.getCaretModel().getVisualPosition().line) - mySavedCaretShift);
    scrollingModel.enableAnimation();
  }
}
