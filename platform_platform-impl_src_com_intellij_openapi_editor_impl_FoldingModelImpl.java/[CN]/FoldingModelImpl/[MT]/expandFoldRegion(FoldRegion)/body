{
  assertIsDispatchThreadForEditor();
  if (region.isExpanded() || region.shouldNeverExpand())   return;
  if (!myIsBatchFoldingProcessing) {
    LOG.error("Fold regions must be collapsed or expanded inside batchFoldProcessing() only.");
  }
  for (  Caret caret : myEditor.getCaretModel().getAllCarets()) {
    Integer savedOffset=caret.getUserData(SAVED_CARET_OFFSET);
    if (savedOffset != null) {
      FoldRegion[] allCollapsed=myFoldTree.fetchCollapsedAt(savedOffset);
      if (allCollapsed.length == 1 && allCollapsed[0] == region) {
        myCaretsToMove.add(caret);
      }
    }
  }
  myFoldRegionsProcessed=true;
  ((FoldRegionImpl)region).setExpandedInternal(true);
  notifyListenersOnFoldRegionStateChange(region);
}
