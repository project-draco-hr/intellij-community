{
  assertIsDispatchThreadForEditor();
  boolean oldDontCollapseCaret=myDoNotCollapseCaret;
  myDoNotCollapseCaret|=dontCollapseCaret;
  boolean oldBatchFlag=myIsBatchFoldingProcessing;
  if (!oldBatchFlag) {
    mySavedCaretPositionBeforeBatchFolding=myEditor.visibleLineToY(myEditor.getCaretModel().getVisualPosition().line);
  }
  myIsBatchFoldingProcessing=true;
  myFoldTree.myCachedLastIndex=-1;
  try {
    operation.run();
  }
  finally {
    myFoldTree.myCachedLastIndex=-1;
    if (!oldBatchFlag) {
      if (myFoldRegionsProcessed) {
        notifyBatchFoldingProcessingDone(moveCaret);
        myFoldRegionsProcessed=false;
      }
      myIsBatchFoldingProcessing=false;
    }
    myDoNotCollapseCaret=oldDontCollapseCaret;
  }
}
