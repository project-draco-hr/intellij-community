{
  for (Iterator<VirtualFile> i=gitRoots.iterator(); i.hasNext(); ) {
    if (!GitRebaseUtils.isRebaseInTheProgress(i.next())) {
      i.remove();
    }
  }
  if (gitRoots.size() == 0) {
    Messages.showErrorDialog(project,GitBundle.getString("rebase.action.no.root"),GitBundle.getString("rebase.action.error"));
    return;
  }
  final VirtualFile root;
  if (gitRoots.size() == 1) {
    root=gitRoots.get(0);
  }
 else {
    if (!gitRoots.contains(defaultRoot)) {
      defaultRoot=gitRoots.get(0);
    }
    GitRebaseActionDialog d=new GitRebaseActionDialog(project,getActionName(),gitRoots,defaultRoot);
    d.show();
    root=d.selectRoot();
    if (root == null) {
      return;
    }
  }
  affectedRoots.add(root);
  GitSimpleHandler h=new GitSimpleHandler(project,root,GitCommand.REBASE);
  h.setStdoutSuppressed(false);
  h.addParameters("--abort");
  AccessToken token=DvcsUtil.workingTreeChangeStarted(project);
  try {
    GitHandlerUtil.doSynchronously(h,getActionName(),h.printableCommandLine());
  }
  finally {
    DvcsUtil.workingTreeChangeFinished(project,token);
  }
}
