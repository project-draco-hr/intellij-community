{
  JavaParameters javaParameters=javaCmdLine.getJavaParameters();
  String mainClass=javaParameters.getMainClass();
  if (ourMayUseLauncher && mainClass != null) {
    String moduleName=javaParameters.getModuleName();
    String rtJarPath=JavaSdkUtil.getIdeaRtJarPath();
    if (moduleName == null || new File(rtJarPath).isFile()) {
      try {
        ProcessProxyImpl proxy=new ProcessProxyImpl();
        String port=String.valueOf(proxy.getPortNumber());
        String binPath=PathManager.getBinPath();
        if (moduleName == null) {
          JavaSdkUtil.addRtJar(javaParameters.getClassPath());
          ParametersList vmParametersList=javaParameters.getVMParametersList();
          vmParametersList.defineProperty(ProcessProxyImpl.PROPERTY_PORT_NUMBER,port);
          vmParametersList.defineProperty(ProcessProxyImpl.PROPERTY_BIN_PATH,binPath);
          javaParameters.getProgramParametersList().prepend(mainClass);
          javaParameters.setMainClass(ProcessProxyImpl.LAUNCH_MAIN_CLASS);
        }
 else {
          javaParameters.getVMParametersList().add("-javaagent:" + rtJarPath + '='+ port+ ':'+ binPath);
        }
        return proxy;
      }
 catch (      IOException e) {
        Logger.getInstance(ProcessProxy.class).warn(e);
      }
    }
  }
  return null;
}
