{
  if (mySubstituted != null && mySubstituted.isValid()) {
    if (mySubstituted instanceof PsiNameIdentifierOwner) {
      if (Comparing.strEqual(myOldName,((PsiNameIdentifierOwner)mySubstituted).getName()))       return mySubstituted;
      final RangeMarker rangeMarker=mySubstitutedRange != null ? mySubstitutedRange : myRenameOffset;
      if (rangeMarker != null)       return PsiTreeUtil.findElementOfClassAtRange(mySubstituted.getContainingFile(),rangeMarker.getStartOffset(),rangeMarker.getEndOffset(),PsiNameIdentifierOwner.class);
    }
    return mySubstituted;
  }
  if (mySubstitutedRange != null) {
    final PsiFile psiFile=PsiDocumentManager.getInstance(myProject).getPsiFile(myEditor.getDocument());
    if (psiFile != null) {
      return PsiTreeUtil.findElementOfClassAtRange(psiFile,mySubstitutedRange.getStartOffset(),mySubstitutedRange.getEndOffset(),PsiNameIdentifierOwner.class);
    }
  }
  return getVariable();
}
