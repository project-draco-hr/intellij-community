{
  CharsetDecoder decoder=CharsetUtil.getDecoder(CharsetUtil.UTF_8);
  ByteBuffer in=buffer.nioBuffer(buffer.readerIndex(),byteCount);
  if (charBuffer == null) {
    charBuffer=CharBuffer.allocate((int)((double)in.remaining() * decoder.maxCharsPerByte()));
  }
  try {
    CoderResult cr=decoder.decode(in,charBuffer,true);
    if (!cr.isUnderflow()) {
      cr.throwException();
    }
    cr=decoder.flush(charBuffer);
    if (!cr.isUnderflow()) {
      cr.throwException();
    }
  }
 catch (  CharacterCodingException x) {
    throw new IllegalStateException(x);
  }
  buffer.skipBytes(byteCount);
  return charBuffer;
}
