{
  HashMap<VirtualFile,List<FilePath>> toUnindex=new HashMap<>();
  HashMap<VirtualFile,List<FilePath>> toUnversion=new HashMap<>();
  HashMap<VirtualFile,List<FilePath>> toRevert=new HashMap<>();
  List<FilePath> toDelete=new ArrayList<>();
  listener.determinate();
  for (  Change c : changes) {
switch (c.getType()) {
case NEW:
      registerFile(toUnversion,c.getAfterRevision().getFile(),exceptions);
    break;
case MOVED:
  registerFile(toRevert,c.getBeforeRevision().getFile(),exceptions);
registerFile(toUnindex,c.getAfterRevision().getFile(),exceptions);
toDelete.add(c.getAfterRevision().getFile());
break;
case MODIFICATION:
registerFile(toUnindex,c.getBeforeRevision().getFile(),exceptions);
registerFile(toRevert,c.getBeforeRevision().getFile(),exceptions);
break;
case DELETED:
registerFile(toRevert,c.getBeforeRevision().getFile(),exceptions);
break;
}
}
for (Map.Entry<VirtualFile,List<FilePath>> entry : toUnindex.entrySet()) {
listener.accept(entry.getValue());
try {
unindex(entry.getKey(),entry.getValue(),false);
}
 catch (VcsException e) {
exceptions.add(e);
}
}
for (Map.Entry<VirtualFile,List<FilePath>> entry : toUnversion.entrySet()) {
listener.accept(entry.getValue());
try {
unindex(entry.getKey(),entry.getValue(),true);
}
 catch (VcsException e) {
exceptions.add(e);
}
}
for (FilePath file : toDelete) {
listener.accept(file);
try {
final File ioFile=file.getIOFile();
if (ioFile.exists()) {
if (!ioFile.delete()) {
exceptions.add(new VcsException("Unable to delete file: " + file));
}
}
}
 catch (Exception e) {
exceptions.add(new VcsException("Unable to delete file: " + file,e));
}
}
AccessToken token=DvcsUtil.workingTreeChangeStarted(myProject);
try {
for (Map.Entry<VirtualFile,List<FilePath>> entry : toRevert.entrySet()) {
listener.accept(entry.getValue());
try {
revert(entry.getKey(),entry.getValue());
}
 catch (VcsException e) {
exceptions.add(e);
}
}
}
  finally {
DvcsUtil.workingTreeChangeFinished(myProject,token);
}
LocalFileSystem lfs=LocalFileSystem.getInstance();
HashSet<File> filesToRefresh=new HashSet<>();
for (Change c : changes) {
ContentRevision before=c.getBeforeRevision();
if (before != null) {
filesToRefresh.add(new File(before.getFile().getPath()));
}
ContentRevision after=c.getAfterRevision();
if (after != null) {
filesToRefresh.add(new File(after.getFile().getPath()));
}
}
lfs.refreshIoFiles(filesToRefresh);
for (GitRepository repo : GitUtil.getRepositoryManager(myProject).getRepositories()) {
repo.update();
}
}
