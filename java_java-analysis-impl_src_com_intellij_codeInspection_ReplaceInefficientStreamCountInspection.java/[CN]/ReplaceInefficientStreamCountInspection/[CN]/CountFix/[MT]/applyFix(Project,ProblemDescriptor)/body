{
  PsiElement element=descriptor.getStartElement();
  if (!(element instanceof PsiMethodCallExpression))   return;
  PsiMethodCallExpression countCall=(PsiMethodCallExpression)element;
  PsiElement countName=countCall.getMethodExpression().getReferenceNameElement();
  if (countName == null)   return;
  PsiMethodCallExpression qualifierCall=getQualifierMethodCall(countCall);
  if (qualifierCall == null)   return;
  PsiMethod qualifier=qualifierCall.resolveMethod();
  if (!FileModificationService.getInstance().preparePsiElementForWrite(element.getContainingFile()))   return;
  PsiElementFactory factory=JavaPsiFacade.getElementFactory(project);
  if (myFlatMapMode) {
    replaceFlatMap(countName,qualifierCall,qualifier,factory);
  }
 else {
    replaceSimpleCount(countCall,qualifierCall,qualifier,factory);
  }
}
