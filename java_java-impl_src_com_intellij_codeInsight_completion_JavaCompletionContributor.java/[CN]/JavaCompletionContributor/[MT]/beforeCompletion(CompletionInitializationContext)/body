{
  final PsiFile file=context.getFile();
  if (file instanceof PsiJavaFile) {
    if (context.getInvocationCount() > 0) {
      autoImport(file,context.getStartOffset() - 1,context.getEditor());
      PsiElement leaf=file.findElementAt(context.getStartOffset() - 1);
      if (leaf != null)       leaf=PsiTreeUtil.prevVisibleLeaf(leaf);
      PsiVariable variable=PsiTreeUtil.getParentOfType(leaf,PsiVariable.class);
      if (variable != null) {
        PsiTypeElement typeElement=variable.getTypeElement();
        if (typeElement != null) {
          PsiType type=typeElement.getType();
          if (type instanceof PsiClassType && ((PsiClassType)type).resolve() == null) {
            autoImportReference(file,context.getEditor(),typeElement.getInnermostComponentReferenceElement());
          }
        }
      }
    }
    JavaCompletionUtil.initOffsets(file,context.getOffsetMap());
    if (context.getCompletionType() == CompletionType.BASIC) {
      if (semicolonNeeded(context.getEditor(),file,context.getStartOffset())) {
        context.setDummyIdentifier(CompletionInitializationContext.DUMMY_IDENTIFIER.trim() + ";");
        return;
      }
      final PsiJavaCodeReferenceElement ref=PsiTreeUtil.findElementOfClassAtOffset(file,context.getStartOffset(),PsiJavaCodeReferenceElement.class,false);
      if (ref != null && !(ref instanceof PsiReferenceExpression)) {
        if (ref.getParent() instanceof PsiTypeElement) {
          context.setDummyIdentifier(CompletionInitializationContext.DUMMY_IDENTIFIER.trim() + ";");
        }
        if (JavaSmartCompletionContributor.AFTER_NEW.accepts(ref)) {
          final PsiReferenceParameterList paramList=ref.getParameterList();
          if (paramList != null && paramList.getTextLength() > 0) {
            context.getOffsetMap().addOffset(ConstructorInsertHandler.PARAM_LIST_START,paramList.getTextRange().getStartOffset());
            context.getOffsetMap().addOffset(ConstructorInsertHandler.PARAM_LIST_END,paramList.getTextRange().getEndOffset());
          }
        }
        return;
      }
      final PsiElement element=file.findElementAt(context.getStartOffset());
      if (psiElement().inside(PsiAnnotation.class).accepts(element)) {
        return;
      }
      context.setDummyIdentifier(CompletionInitializationContext.DUMMY_IDENTIFIER_TRIMMED);
    }
  }
}
