{
  final Set<String> usedWords=new HashSet<String>();
  final PsiElement position=parameters.getPosition();
  final boolean first=parameters.getInvocationCount() <= 1;
  final boolean isSwitchLabel=SWITCH_LABEL.accepts(position);
  final boolean isAfterNew=JavaClassNameCompletionContributor.AFTER_NEW.accepts(position);
  final boolean pkgContext=JavaCompletionUtil.inSomePackage(position);
  final PsiType[] expectedTypes=ExpectedTypesGetter.getExpectedTypes(parameters.getPosition(),true);
  LegacyCompletionContributor.processReferences(parameters,result,new PairConsumer<PsiReference,CompletionResultSet>(){
    @Override public void consume(    final PsiReference reference,    final CompletionResultSet result){
      if (reference instanceof PsiJavaReference) {
        final ElementFilter filter=getReferenceFilter(position);
        if (filter != null) {
          final PsiFile originalFile=parameters.getOriginalFile();
          JavaCompletionProcessor.Options options=JavaCompletionProcessor.Options.DEFAULT_OPTIONS.withCheckAccess(first).withFilterStaticAfterInstance(first).withShowInstanceInStaticContext(!first);
          for (          LookupElement element : JavaCompletionUtil.processJavaReference(position,(PsiJavaReference)reference,new ElementExtractorFilter(filter),options,result.getPrefixMatcher(),parameters)) {
            if (inheritors.alreadyProcessed(element)) {
              continue;
            }
            if (isSwitchLabel) {
              result.addElement(new IndentingDecorator(TailTypeDecorator.withTail(element,TailType.createSimpleTailType(':'))));
            }
 else {
              final LookupItem item=element.as(LookupItem.CLASS_CONDITION_KEY);
              if (originalFile instanceof PsiJavaCodeReferenceCodeFragment && !((PsiJavaCodeReferenceCodeFragment)originalFile).isClassesAccepted() && item != null) {
                item.setTailType(TailType.NONE);
              }
              if (item instanceof JavaMethodCallElement) {
                JavaMethodCallElement call=(JavaMethodCallElement)item;
                final PsiMethod method=call.getObject();
                if (method.getTypeParameters().length > 0) {
                  final PsiType returned=TypeConversionUtil.erasure(method.getReturnType());
                  PsiType matchingExpectation=returned == null ? null : ContainerUtil.find(expectedTypes,new Condition<PsiType>(){
                    @Override public boolean value(                    PsiType type){
                      return type.isAssignableFrom(returned);
                    }
                  }
);
                  if (matchingExpectation != null && SmartCompletionDecorator.hasUnboundTypeParams(method,matchingExpectation)) {
                    call.setInferenceSubstitutor(SmartCompletionDecorator.calculateMethodReturnTypeSubstitutor(method,matchingExpectation),position);
                  }
                }
              }
              result.addElement(element);
            }
          }
        }
        return;
      }
      if (reference instanceof PsiLabelReference) {
        LabelReferenceCompletion.processLabelReference(result,(PsiLabelReference)reference);
        return;
      }
      final Object[] variants=reference.getVariants();
      if (variants == null) {
        LOG.error("Reference=" + reference);
      }
      for (      Object completion : variants) {
        if (completion == null) {
          LOG.error("Position=" + position + "\n;Reference="+ reference+ "\n;variants="+ Arrays.toString(variants));
        }
        if (completion instanceof LookupElement && !inheritors.alreadyProcessed((LookupElement)completion)) {
          usedWords.add(((LookupElement)completion).getLookupString());
          result.addElement((LookupElement)completion);
        }
 else         if (completion instanceof PsiClass) {
          for (          JavaPsiClassReferenceElement item : JavaClassNameCompletionContributor.createClassLookupItems((PsiClass)completion,isAfterNew,JavaClassNameInsertHandler.JAVA_CLASS_INSERT_HANDLER,new Condition<PsiClass>(){
            @Override public boolean value(            PsiClass psiClass){
              return !inheritors.alreadyProcessed(psiClass) && JavaCompletionUtil.isSourceLevelAccessible(position,psiClass,pkgContext);
            }
          }
)) {
            usedWords.add(item.getLookupString());
            result.addElement(item);
          }
        }
 else {
          LookupElement element=LookupItemUtil.objectToLookupItem(completion);
          usedWords.add(element.getLookupString());
          result.addElement(element);
        }
      }
    }
  }
);
  return usedWords;
}
