{
  List<PsiDirectory> directories=ContainerUtil.newArrayList();
  for (  PsiDirectoryNode node : getSelectedNodes(PsiDirectoryNode.class)) {
    PsiDirectory directory=node.getValue();
    if (directory != null) {
      directories.add(directory);
      Object parentValue=node.getParent().getValue();
      if (parentValue instanceof PsiDirectory && Registry.is("projectView.choose.directory.on.compacted.middle.packages")) {
        while (true) {
          directory=directory.getParentDirectory();
          if (directory == null || directory.equals(parentValue)) {
            break;
          }
          directories.add(directory);
        }
      }
    }
  }
  if (!directories.isEmpty()) {
    return directories.toArray(new PsiDirectory[directories.size()]);
  }
  final PsiElement[] elements=getSelectedPSIElements();
  if (elements.length == 1) {
    final PsiElement element=elements[0];
    if (element instanceof PsiDirectory) {
      return new PsiDirectory[]{(PsiDirectory)element};
    }
 else     if (element instanceof PsiDirectoryContainer) {
      return ((PsiDirectoryContainer)element).getDirectories();
    }
 else {
      final PsiFile containingFile=element.getContainingFile();
      if (containingFile != null) {
        final PsiDirectory psiDirectory=containingFile.getContainingDirectory();
        if (psiDirectory != null) {
          return new PsiDirectory[]{psiDirectory};
        }
        final VirtualFile file=containingFile.getVirtualFile();
        if (file instanceof VirtualFileWindow) {
          final VirtualFile delegate=((VirtualFileWindow)file).getDelegate();
          final PsiFile delegatePsiFile=containingFile.getManager().findFile(delegate);
          if (delegatePsiFile != null && delegatePsiFile.getContainingDirectory() != null) {
            return new PsiDirectory[]{delegatePsiFile.getContainingDirectory()};
          }
        }
        return PsiDirectory.EMPTY_ARRAY;
      }
    }
  }
 else {
    final DefaultMutableTreeNode selectedNode=getSelectedNode();
    if (selectedNode != null) {
      return getSelectedDirectoriesInAmbiguousCase(selectedNode);
    }
  }
  return PsiDirectory.EMPTY_ARRAY;
}
