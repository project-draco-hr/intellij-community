{
  IElementType[] copy;
  ourRegistryReadLock.lock();
  try {
    copy=new IElementType[ourCounter - FIRST_TOKEN_INDEX];
    System.arraycopy(ourRegistry,0,copy,0,ourCounter - FIRST_TOKEN_INDEX);
  }
  finally {
    ourRegistryReadLock.unlock();
  }
  List<IElementType> matches=new ArrayList<IElementType>();
  for (  IElementType value : copy) {
    if (p.matches(value)) {
      matches.add(value);
    }
  }
  return matches.toArray(new IElementType[matches.size()]);
}
