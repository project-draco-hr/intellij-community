{
  PatchInfo patch=newVersion.findPatchForCurrentBuild();
  if (patch == null)   throw new IOException("No patch is available for current version");
  String productCode=ApplicationInfo.getInstance().getBuild().getProductCode();
  String fromBuildNumber=patch.getFromBuild().asStringWithoutProductCode();
  String toBuildNumber=newVersion.getNumber().asStringWithoutProductCode();
  String bundledJdk="";
  String jdkMacRedist=System.getProperty("idea.java.redist");
  if (jdkMacRedist != null && jdkMacRedist.lastIndexOf("jdk-bundled") >= 0) {
    bundledJdk="jdk-bundled".equals(jdkMacRedist) ? "-jdk-bundled" : "-custom-jdk-bundled";
  }
  String osSuffix="-" + patch.getOSSuffix();
  String fileName=productCode + "-" + fromBuildNumber+ "-"+ toBuildNumber+ "-patch"+ bundledJdk+ osSuffix+ ".jar";
  String url=new URL(new URL(getPatchesUrl()),fileName).toString();
  File tempFile=HttpRequests.request(url).connect(new HttpRequests.RequestProcessor<File>(){
    @Override public File process(    @NotNull HttpRequests.Request request) throws IOException {
      File tempFile=FileUtil.createTempFile("ij.platform.",".patch",true);
      OutputStream output=new BufferedOutputStream(new FileOutputStream(tempFile));
      try {
        NetUtils.copyStreamContent(indicator,request.getInputStream(),output,request.getConnection().getContentLength());
      }
  finally {
        output.close();
      }
      return tempFile;
    }
  }
);
  String patchFileName=("jetbrains.patch.jar." + PlatformUtils.getPlatformPrefix()).toLowerCase(Locale.ENGLISH);
  File patchFile=new File(FileUtil.getTempDirectory(),patchFileName);
  FileUtil.copy(tempFile,patchFile);
  FileUtil.delete(tempFile);
}
