{
  String url=null;
  if (descriptor instanceof PluginNode) {
    url=((PluginNode)descriptor).getDownloadUrl();
    if (url != null) {
      final String repositoryName=((PluginNode)descriptor).getRepositoryName();
      if (repositoryName != null) {
        final VirtualFile pluginFile=PluginDownloader.findPluginFile(url,repositoryName);
        if (pluginFile != null) {
          url=getPluginUrl(pluginFile);
        }
      }
    }
  }
  if (url == null) {
    String uuid=ApplicationManager.getApplication() == null ? UUID.randomUUID().toString() : getInstallationUID(PropertiesComponent.getInstance());
    String buildNumber=ApplicationManager.getApplication() != null ? ApplicationInfo.getInstance().getApiVersion() : ApplicationInfoImpl.getShadowInstance().getBuild().asString();
    url=RepositoryHelper.getDownloadUrl() + URLEncoder.encode(descriptor.getPluginId().getIdString(),"UTF8") + "&build="+ buildNumber+ "&uuid="+ URLEncoder.encode(uuid,"UTF8");
  }
  return url;
}
