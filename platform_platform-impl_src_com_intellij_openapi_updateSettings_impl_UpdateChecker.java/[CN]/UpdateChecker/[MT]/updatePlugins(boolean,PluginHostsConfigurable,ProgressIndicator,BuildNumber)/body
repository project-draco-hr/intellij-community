{
  final Map<PluginId,PluginDownloader> downloaded=new HashMap<PluginId,PluginDownloader>();
  final Set<String> failed=new HashSet<String>();
  for (  String host : getPluginHosts(hostsConfigurable)) {
    try {
      checkPluginsHost(host,downloaded,true,indicator,buildNumber);
    }
 catch (    ProcessCanceledException e) {
      return null;
    }
catch (    Exception e) {
      LOG.info(e);
      failed.add(host);
    }
  }
  final Map<String,IdeaPluginDescriptor> toUpdate=new HashMap<String,IdeaPluginDescriptor>();
  final IdeaPluginDescriptor[] installedPlugins=PluginManagerCore.getPlugins();
  for (  IdeaPluginDescriptor installedPlugin : installedPlugins) {
    if (!installedPlugin.isBundled()) {
      toUpdate.put(installedPlugin.getPluginId().getIdString(),installedPlugin);
    }
  }
  for (Iterator<PluginId> iterator=downloaded.keySet().iterator(); iterator.hasNext(); ) {
    if (!toUpdate.containsKey(iterator.next().getIdString())) {
      iterator.remove();
    }
  }
  final File installedTxt=new File(PathManager.getConfigPath(),PluginManager.INSTALLED_TXT);
  if (installedTxt.isFile()) {
    try {
      final String oldInstalledPlugins=FileUtil.loadFile(installedTxt);
      for (      String pluginId : oldInstalledPlugins.trim().split("\n")) {
        if (!toUpdate.containsKey(pluginId))         toUpdate.put(pluginId.trim(),null);
      }
    }
 catch (    IOException e) {
      LOG.error(e);
    }
    installedTxt.deleteOnExit();
  }
  final PluginManagerUISettings updateSettings=PluginManagerUISettings.getInstance();
  updateSettings.myOutdatedPlugins.clear();
  if (!toUpdate.isEmpty()) {
    try {
      final List<IdeaPluginDescriptor> process=RepositoryHelper.loadPluginsFromRepository(indicator);
      final List<String> disabledPlugins=PluginManagerCore.getDisabledPlugins();
      for (      IdeaPluginDescriptor loadedPlugin : process) {
        final String idString=loadedPlugin.getPluginId().getIdString();
        if (!toUpdate.containsKey(idString))         continue;
        final IdeaPluginDescriptor installedPlugin=toUpdate.get(idString);
        if (installedPlugin == null) {
          prepareToInstall(downloaded,loadedPlugin,indicator,buildNumber);
        }
 else         if (StringUtil.compareVersionNumbers(loadedPlugin.getVersion(),installedPlugin.getVersion()) > 0) {
          updateSettings.myOutdatedPlugins.add(idString);
          if (!disabledPlugins.contains(idString)) {
            prepareToInstall(downloaded,loadedPlugin,indicator,buildNumber);
          }
        }
      }
    }
 catch (    ProcessCanceledException ignore) {
      return null;
    }
catch (    Exception e) {
      showErrorMessage(manualCheck,e.getMessage());
    }
  }
  if (!failed.isEmpty()) {
    LOG.warn(IdeBundle.message("updates.error.plugin.description.failed",StringUtil.join(failed,",")));
  }
  return downloaded.isEmpty() ? null : downloaded.values();
}
