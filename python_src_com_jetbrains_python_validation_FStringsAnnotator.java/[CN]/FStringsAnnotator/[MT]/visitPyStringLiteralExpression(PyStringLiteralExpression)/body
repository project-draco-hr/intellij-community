{
  for (  ASTNode node : pyString.getStringNodes()) {
    final StringNodeInfo nodeInfo=new StringNodeInfo(node);
    final String nodeText=node.getText();
    if (nodeInfo.isFormatted()) {
      final int nodeContentEnd=nodeInfo.getContentRange().getEndOffset();
      final FStringParser.ParseResult result=FStringParser.parse(nodeText);
      boolean hasUnclosedBrace=false;
      for (      Fragment fragment : result.getFragments()) {
        final int fragContentEnd=fragment.getContentEndOffset();
        if (CharArrayUtil.isEmptyOrSpaces(nodeText,fragment.getLeftBraceOffset() + 1,fragment.getContentEndOffset())) {
          report("Empty expressions are not allowed inside f-strings",fragment.getContentRange(),node);
        }
        if (fragment.getRightBraceOffset() == -1) {
          hasUnclosedBrace=true;
        }
        if (fragment.getFirstHashOffset() != -1) {
          final TextRange range=TextRange.create(fragment.getFirstHashOffset(),fragment.getContentEndOffset());
          report("Expression fragments inside f-strings cannot include line comments",range,node);
        }
        for (int i=fragment.getLeftBraceOffset() + 1; i < fragment.getContentEndOffset(); i++) {
          final char c=nodeText.charAt(i);
          if (c == '\\') {
            reportCharacter("Expression fragments inside f-strings cannot include backslashes",i,node);
          }
        }
        if (fragContentEnd < nodeContentEnd && nodeText.charAt(fragContentEnd) == '!' && fragContentEnd + 1 < nodeContentEnd) {
          final char conversionChar=nodeText.charAt(fragContentEnd + 1);
          final int offset=fragContentEnd + 1;
          if (fragContentEnd + 1 == fragment.getRightBraceOffset() || conversionChar == ':') {
            reportEmpty("Conversion character is expected: should be one of 's', 'r', 'a'",offset,node);
          }
 else           if ("sra".indexOf(conversionChar) < 0) {
            reportCharacter("Illegal conversion character '" + conversionChar + "': should be one of 's', 'r', 'a'",offset,node);
          }
        }
      }
      for (      Integer offset : result.getSingleRightBraces()) {
        reportCharacter("Single '}' is not allowed inside f-strings",offset,node);
      }
      if (hasUnclosedBrace) {
        reportEmpty("'}' is expected",nodeContentEnd,node);
      }
    }
  }
}
