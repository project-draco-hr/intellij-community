{
  final PsiFile containingFile=root.getContainingFile();
  final TypeMigrationProcessor processor=new TypeMigrationProcessor(project,root,rules){
    @Override public void performRefactoring(    @NotNull final UsageInfo[] usages){
      super.performRefactoring(usages);
      if (editor != null) {
        ApplicationManager.getApplication().invokeLater(new Runnable(){
          public void run(){
            final List<PsiElement> result=new ArrayList<PsiElement>();
            for (            UsageInfo usage : usages) {
              final PsiElement element=usage.getElement();
              if (element == null || containingFile != element.getContainingFile())               continue;
              if (element instanceof PsiMethod) {
                result.add(((PsiMethod)element).getReturnTypeElement());
              }
 else               if (element instanceof PsiVariable) {
                result.add(((PsiVariable)element).getTypeElement());
              }
 else {
                result.add(element);
              }
            }
            RefactoringUtil.highlightAllOccurrences(project,PsiUtilCore.toPsiElementArray(result),editor);
          }
        }
);
      }
    }
  }
;
  processor.run();
}
