{
  final XDebugSession session=XDebuggerManager.getInstance(project).getCurrentSession();
  if (session == null) {
    return null;
  }
  final XDebuggerEvaluator evaluator=session.getDebugProcess().getEvaluator();
  if (evaluator == null) {
    return null;
  }
  return PsiDocumentManager.getInstance(project).commitAndRunReadAction(new Computable<XValueHint>(){
    @Override public XValueHint compute(){
      int offset=AbstractValueHint.calculateOffset(editor,point);
      Pair<TextRange,String> expressionData=getExpressionRange(evaluator,project,type,editor,offset);
      if (expressionData == null) {
        return null;
      }
      int textLength=editor.getDocument().getTextLength();
      TextRange range=expressionData.first;
      if (range.getStartOffset() > range.getEndOffset() || range.getStartOffset() < 0 || range.getEndOffset() > textLength) {
        LOG.error("invalid range: " + range + ", text length = "+ textLength+ ", evaluator: "+ evaluator);
        return null;
      }
      return new XValueHint(project,editor,point,type,expressionData,evaluator,session);
    }
  }
);
}
