{
  List<VirtualFile> topLevelContentRoots=ProjectViewDirectoryHelper.getInstance(myProject).getTopLevelRoots();
  Set<Module> modules=new LinkedHashSet<>(topLevelContentRoots.size());
  for (  VirtualFile root : topLevelContentRoots) {
    final Module module=ModuleUtil.findModuleForFile(root,myProject);
    if (module != null) {
      modules.add(module);
    }
  }
  ArrayList<AbstractTreeNode> nodes=new ArrayList<>();
  final PsiManager psiManager=PsiManager.getInstance(getProject());
  nodes.addAll(modulesAndGroups(modules.toArray(new Module[modules.size()])));
  final VirtualFile baseDir=getProject().getBaseDir();
  if (baseDir == null)   return nodes;
  final VirtualFile[] files=baseDir.getChildren();
  for (  VirtualFile file : files) {
    if (!file.isDirectory()) {
      if (ProjectFileIndex.SERVICE.getInstance(getProject()).getModuleForFile(file,false) == null) {
        nodes.add(new PsiFileNode(getProject(),psiManager.findFile(file),getSettings()));
      }
    }
  }
  if (getSettings().isShowLibraryContents()) {
    nodes.add(new ExternalLibrariesNode(getProject(),getSettings()));
  }
  return nodes;
}
