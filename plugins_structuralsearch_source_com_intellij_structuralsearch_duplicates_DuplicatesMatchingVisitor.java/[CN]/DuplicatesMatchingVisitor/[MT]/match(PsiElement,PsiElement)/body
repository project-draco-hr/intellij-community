{
  if (element1 == null || element2 == null) {
    return element1 == element2;
  }
  final int cost1=myTreeHasher.hash(element1,null,myNodeSpecificHasher).getCost();
  final int cost2=myTreeHasher.hash(element2,null,myNodeSpecificHasher).getCost();
  if (cost1 < myDiscardCost || cost2 < myDiscardCost) {
    return true;
  }
  final PsiElementRole role1=myNodeSpecificHasher.getDuplicatesProfile().getRole(element1);
  final PsiElementRole role2=myNodeSpecificHasher.getDuplicatesProfile().getRole(element2);
  if (role1 == role2 && mySkippedRoles.contains(role1)) {
    return true;
  }
  final EquivalenceDescriptorProvider descriptorProvider=EquivalenceDescriptorProvider.getInstance(element1);
  EquivalenceDescriptor descriptor1=descriptorProvider != null ? descriptorProvider.buildDescriptor(element1) : null;
  EquivalenceDescriptor descriptor2=descriptorProvider != null ? descriptorProvider.buildDescriptor(element2) : null;
  PsiElement newElement1=SkippingHandler.skipNodeIfNeccessary(element1,descriptor1,myNodeFilter);
  PsiElement newElement2=SkippingHandler.skipNodeIfNeccessary(element2,descriptor2,myNodeFilter);
  if (newElement1 != element1 || newElement2 != element2) {
    return match(newElement1,newElement2);
  }
  if (!element1.getClass().equals(element2.getClass())) {
    return false;
  }
  if (descriptor1 != null && descriptor2 != null) {
    return StructuralSearchProfileBase.match(descriptor1,descriptor2,this,mySkippedRoles,myNodeSpecificHasher.getDuplicatesProfile());
  }
  if (element1 instanceof LeafElement) {
    IElementType elementType1=((LeafElement)element1).getElementType();
    IElementType elementType2=((LeafElement)element2).getElementType();
    if (!mySettings.DISTINGUISH_LITERALS && myNodeSpecificHasher.getDuplicatesProfile().getLiterals().contains(elementType1) && myNodeSpecificHasher.getDuplicatesProfile().getLiterals().contains(elementType2)) {
      return true;
    }
    return element1.getText().equals(element2.getText());
  }
  if (element1.getFirstChild() == null && element1.getTextLength() == 0) {
    return element2.getFirstChild() == null && element2.getTextLength() == 0;
  }
  return matchSequentially(new FilteringNodeIterator(new SiblingNodeIterator(element1.getFirstChild()),getNodeFilter()),new FilteringNodeIterator(new SiblingNodeIterator(element2.getFirstChild()),getNodeFilter()));
}
