{
  if (element1 == null || element2 == null) {
    return element1 == element2;
  }
  final EquivalenceDescriptorProvider descriptorProvider=EquivalenceDescriptorProvider.getInstance(element1);
  EquivalenceDescriptor descriptor1=descriptorProvider != null ? descriptorProvider.buildDescriptor(element1) : null;
  EquivalenceDescriptor descriptor2=descriptorProvider != null ? descriptorProvider.buildDescriptor(element2) : null;
  PsiElement newElement1=skipNodeIfNeccessary(element1,descriptor1);
  PsiElement newElement2=skipNodeIfNeccessary(element2,descriptor2);
  if (newElement1 == null || newElement2 == null) {
    return newElement1 == newElement2;
  }
  if (descriptorProvider != null) {
    if (newElement1 != element1) {
      descriptor1=descriptorProvider.buildDescriptor(newElement1);
      element1=newElement1;
    }
    if (newElement2 != element2) {
      descriptor2=descriptorProvider.buildDescriptor(newElement2);
      element2=newElement2;
    }
  }
  if (!element1.getClass().equals(element2.getClass())) {
    return false;
  }
  if (descriptor1 != null && descriptor2 != null) {
    return StructuralSearchProfileImpl.match(descriptor1,descriptor2,this,mySkippedRoles);
  }
  if (element1 instanceof LeafElement) {
    IElementType elementType1=((LeafElement)element1).getElementType();
    IElementType elementType2=((LeafElement)element2).getElementType();
    if (!mySettings.DISTINGUISH_LITERALS && descriptorProvider != null && descriptorProvider.getLiterals().contains(elementType1) && descriptorProvider.getLiterals().contains(elementType2)) {
      return true;
    }
    return element1.getText().equals(element2.getText());
  }
  if (element1.getFirstChild() == null && element1.getTextLength() == 0) {
    return element2.getFirstChild() == null && element2.getTextLength() == 0;
  }
  return matchSequentially(new FilteringNodeIterator(new SiblingNodeIterator(element1.getFirstChild()),getNodeFilter()),new FilteringNodeIterator(new SiblingNodeIterator(element2.getFirstChild()),getNodeFilter()));
}
