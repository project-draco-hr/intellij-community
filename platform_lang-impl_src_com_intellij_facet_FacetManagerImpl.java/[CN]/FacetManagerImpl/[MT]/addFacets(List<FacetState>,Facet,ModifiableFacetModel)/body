{
  for (  FacetState child : facetStates) {
    final String typeId=child.getFacetType();
    if (typeId == null) {
      addInvalidFacet(child,model,underlyingFacet,ProjectBundle.message("error.message.facet.type.isn.t.specified"),null);
      continue;
    }
    final FacetType<?,?> type=myFacetTypeRegistry.findFacetType(typeId);
    if (type == null) {
      addInvalidFacet(child,model,underlyingFacet,ProjectBundle.message("error.message.unknown.facet.type.0",typeId),typeId);
      continue;
    }
    ModuleType moduleType=ModuleType.get(myModule);
    if (!type.isSuitableModuleType(moduleType)) {
      addInvalidFacet(child,model,underlyingFacet,ProjectBundle.message("error.message.0.facets.are.not.allowed.in.1",type.getPresentableName(),moduleType.getName()),null);
      continue;
    }
    FacetType<?,?> expectedUnderlyingType=null;
    FacetTypeId<?> underlyingTypeId=type.getUnderlyingFacetType();
    if (underlyingTypeId != null) {
      expectedUnderlyingType=myFacetTypeRegistry.findFacetType(underlyingTypeId);
      if (expectedUnderlyingType == null) {
        addInvalidFacet(child,model,underlyingFacet,ProjectBundle.message("error.message.cannot.find.underlying.facet.type.for.0",typeId),underlyingTypeId.toString());
        continue;
      }
    }
    FacetType actualUnderlyingType=underlyingFacet != null ? underlyingFacet.getType() : null;
    if (expectedUnderlyingType != null) {
      if (!expectedUnderlyingType.equals(actualUnderlyingType)) {
        addInvalidFacet(child,model,underlyingFacet,ProjectBundle.message("error.message.0.facet.must.be.placed.under.1.facet",type.getPresentableName(),expectedUnderlyingType.getPresentableName()),null);
        continue;
      }
    }
 else     if (actualUnderlyingType != null) {
      addInvalidFacet(child,model,underlyingFacet,ProjectBundle.message("error.message.0.cannot.be.placed.under.1",type.getPresentableName(),actualUnderlyingType.getPresentableName()),null);
      continue;
    }
    try {
      addFacet(type,child,underlyingFacet,model);
    }
 catch (    InvalidDataException e) {
      LOG.info(e);
      addInvalidFacet(child,model,underlyingFacet,ProjectBundle.message("error.message.cannot.load.facet.condiguration.0",e.getMessage()),null);
    }
  }
}
