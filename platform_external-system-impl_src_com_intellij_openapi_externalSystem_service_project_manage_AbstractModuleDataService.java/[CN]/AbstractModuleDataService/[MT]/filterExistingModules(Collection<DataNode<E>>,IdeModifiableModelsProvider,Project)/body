{
  Collection<DataNode<E>> result=ContainerUtilRt.newArrayList();
  for (  DataNode<E> node : modules) {
    ModuleData moduleData=node.getData();
    Module module=modelsProvider.findIdeModule(moduleData.getInternalName());
    if (module == null) {
      result.add(node);
    }
 else {
      if (!FileUtil.pathsEqual(module.getModuleFilePath(),moduleData.getModuleFilePath())) {
        modelsProvider.getModifiableModuleModel().disposeModule(module);
        result.add(node);
        Set<String> orphanFiles=project.getUserData(ORPHAN_MODULE_FILES);
        if (orphanFiles == null) {
          project.putUserData(ORPHAN_MODULE_FILES,orphanFiles=ContainerUtil.newHashSet());
        }
        orphanFiles.add(module.getModuleFilePath());
      }
 else {
        node.putUserData(MODULE_KEY,module);
      }
    }
  }
  return result;
}
