{
  Map<String,String> lookup=new HashMap<String,String>();
  for (  TemplateVariable v : variables) {
    lookup.put(v.getName(),v.getValue());
  }
  StringBuffer sb=new StringBuffer();
  Matcher m=PLACEHOLDER_PATTERN.matcher(s);
  while (m.find()) {
    String name=m.group(1);
    String replacement=lookup.get(name);
    if (replacement == null) {
      throw new Exception((String.format("Template variable '%s' is undefined",name)));
    }
    if (escape && !name.equals(GenericRepository.SERVER_URL)) {
      m.appendReplacement(sb,URLEncoder.encode(replacement,"utf-8"));
    }
 else {
      m.appendReplacement(sb,replacement);
    }
  }
  return m.appendTail(sb).toString();
}
