{
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    ApplicationManager.getApplication().assertIsDispatchThread();
    doRun();
    UIUtil.dispatchAllInvocationEvents();
    UIUtil.dispatchAllInvocationEvents();
    return;
  }
  if (ApplicationManager.getApplication().isWriteAccessAllowed()) {
    DumbService.getInstance(myProject).smartInvokeLater(new Runnable(){
      @Override public void run(){
        doRun();
      }
    }
);
  }
 else {
    doRun();
  }
}
