{
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    ApplicationManager.getApplication().assertIsDispatchThread();
    doRun();
    UIUtil.dispatchAllInvocationEvents();
    UIUtil.dispatchAllInvocationEvents();
    return;
  }
  if (ApplicationManager.getApplication().isWriteAccessAllowed()) {
    LOG.error("Refactorings should not be started inside write action\n because they start progress inside and any read action from the progress task would cause the deadlock",new Exception());
    DumbService.getInstance(myProject).smartInvokeLater(new Runnable(){
      @Override public void run(){
        doRun();
      }
    }
);
  }
 else {
    doRun();
  }
}
