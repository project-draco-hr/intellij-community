{
  final WebEditorOptions webEditorOptions=WebEditorOptions.getInstance();
  if (c == '>' && webEditorOptions != null && webEditorOptions.isAutomaticallyInsertClosingTag() && fileContainsXmlLanguage(editedFile)) {
    PsiDocumentManager.getInstance(project).commitAllDocuments();
    PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    FileViewProvider provider=editedFile.getViewProvider();
    int offset=editor.getCaretModel().getOffset();
    PsiElement element, elementAtCaret=null;
    if (offset < editor.getDocument().getTextLength()) {
      elementAtCaret=element=provider.findElementAt(offset,XMLLanguage.class);
      if (element == null && offset > 0) {
        elementAtCaret=element=provider.findElementAt(offset - 1,XMLLanguage.class);
      }
      if (!(element instanceof PsiWhiteSpace)) {
        boolean nonAcceptableDelimiter=true;
        if (element instanceof XmlToken) {
          IElementType tokenType=((XmlToken)element).getTokenType();
          if (tokenType == XmlTokenType.XML_START_TAG_START || tokenType == XmlTokenType.XML_END_TAG_START) {
            if (offset > 0) {
              PsiElement previousElement=provider.findElementAt(offset - 1,XMLLanguage.class);
              if (previousElement instanceof XmlToken) {
                tokenType=((XmlToken)previousElement).getTokenType();
                element=previousElement;
                nonAcceptableDelimiter=false;
              }
            }
          }
 else           if (tokenType == XmlTokenType.XML_NAME || tokenType == XmlTokenType.XML_TAG_NAME) {
            if (element.getNextSibling() instanceof PsiErrorElement) {
              nonAcceptableDelimiter=false;
            }
          }
          if (tokenType == XmlTokenType.XML_TAG_END || tokenType == XmlTokenType.XML_EMPTY_ELEMENT_END && element.getTextOffset() == offset - 1) {
            EditorModificationUtil.moveCaretRelatively(editor,1);
            editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
            return Result.STOP;
          }
        }
        if (nonAcceptableDelimiter)         return Result.CONTINUE;
      }
 else {
        PsiElement previousElement=provider.findElementAt(offset - 1,XMLLanguage.class);
        if (previousElement instanceof XmlToken) {
          final IElementType tokenType=((XmlToken)previousElement).getTokenType();
          if (tokenType == XmlTokenType.XML_EMPTY_ELEMENT_END) {
            return Result.STOP;
          }
        }
      }
      PsiElement parent=element.getParent();
      if (parent instanceof XmlText) {
        final String text=parent.getText();
        final int index=offset - parent.getTextOffset() - 1;
        if (index >= 0 && text.charAt(index) == '/') {
          return Result.CONTINUE;
        }
        element=parent.getPrevSibling();
      }
 else       if (parent instanceof XmlTag && !(element.getPrevSibling() instanceof XmlTag) && !(element.getPrevSibling() instanceof OuterLanguageElement)) {
        element=parent;
      }
 else       if (parent instanceof XmlAttributeValue) {
        element=parent;
      }
    }
 else {
      element=provider.findElementAt(editor.getDocument().getTextLength() - 1,XMLLanguage.class);
      if (element == null)       return Result.CONTINUE;
      element=element.getParent();
    }
    if (offset > 0 && offset <= editor.getDocument().getTextLength()) {
      if (editor.getDocument().getCharsSequence().charAt(offset - 1) == '/') {
        return Result.CONTINUE;
      }
    }
    if (element instanceof XmlAttributeValue) {
      element=element.getParent().getParent();
    }
    while (element instanceof PsiWhiteSpace || element instanceof OuterLanguageElement)     element=element.getPrevSibling();
    if (element instanceof XmlDocument) {
      element=element.getLastChild();
    }
    if (element == null)     return Result.CONTINUE;
    if (!(element instanceof XmlTag)) {
      if (element instanceof XmlTokenImpl && element.getPrevSibling() != null && element.getPrevSibling().getText().equals("<")) {
        EditorModificationUtil.insertStringAtCaret(editor,"</" + element.getText() + ">",false,0);
      }
      return Result.CONTINUE;
    }
    XmlTag tag=(XmlTag)element;
    if (XmlUtil.getTokenOfType(tag,XmlTokenType.XML_TAG_END) != null)     return Result.CONTINUE;
    if (XmlUtil.getTokenOfType(tag,XmlTokenType.XML_EMPTY_ELEMENT_END) != null)     return Result.CONTINUE;
    final XmlToken startToken=XmlUtil.getTokenOfType(tag,XmlTokenType.XML_START_TAG_START);
    if (startToken == null || !startToken.getText().equals("<"))     return Result.CONTINUE;
    String name=tag.getName();
    if (elementAtCaret instanceof XmlToken && ((XmlToken)elementAtCaret).getTokenType() == XmlTokenType.XML_NAME) {
      name=name.substring(0,offset - elementAtCaret.getTextOffset());
    }
    if (tag instanceof HtmlTag && HtmlUtil.isSingleHtmlTag(name))     return Result.CONTINUE;
    if (name.isEmpty())     return Result.CONTINUE;
    int tagOffset=tag.getTextRange().getStartOffset();
    final XmlToken nameToken=XmlUtil.getTokenOfType(tag,XmlTokenType.XML_NAME);
    if (nameToken != null && nameToken.getTextRange().getStartOffset() > offset)     return Result.CONTINUE;
    HighlighterIterator iterator=((EditorEx)editor).getHighlighter().createIterator(tagOffset);
    if (BraceMatchingUtil.matchBrace(editor.getDocument().getCharsSequence(),editedFile.getFileType(),iterator,true,true)) {
      PsiElement parent=tag.getParent();
      boolean hasBalance=true;
      loop:       while (parent instanceof XmlTag) {
        if (name.equals(((XmlTag)parent).getName())) {
          hasBalance=false;
          ASTNode astNode=XmlChildRole.CLOSING_TAG_NAME_FINDER.findChild(parent.getNode());
          if (astNode == null) {
            hasBalance=true;
            break;
          }
          for (PsiElement el=parent.getNextSibling(); el != null; el=el.getNextSibling()) {
            if (el instanceof PsiErrorElement && el.getText().startsWith("</" + name)) {
              hasBalance=true;
              break loop;
            }
          }
        }
        parent=parent.getParent();
      }
      if (hasBalance)       return Result.CONTINUE;
    }
    Collection<TextRange> cdataReformatRanges=null;
    final XmlElementDescriptor descriptor=tag.getDescriptor();
    EditorModificationUtil.insertStringAtCaret(editor,"</" + name + ">",false,0);
    if (descriptor instanceof XmlElementDescriptorWithCDataContent) {
      final XmlElementDescriptorWithCDataContent cDataContainer=(XmlElementDescriptorWithCDataContent)descriptor;
      cdataReformatRanges=ContainerUtil.newSmartList();
      if (cDataContainer.requiresCdataBracesInContext(tag)) {
        @NonNls final String cDataStart="><![CDATA[";
        final String inserted=cDataStart + "\n]]>";
        EditorModificationUtil.insertStringAtCaret(editor,inserted,false,cDataStart.length());
        int caretOffset=editor.getCaretModel().getOffset();
        if (caretOffset >= cDataStart.length()) {
          cdataReformatRanges.add(TextRange.from(caretOffset - cDataStart.length(),inserted.length() + 1));
        }
      }
    }
    if (cdataReformatRanges != null && !cdataReformatRanges.isEmpty()) {
      PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
      try {
        CodeStyleManager.getInstance(project).reformatText(file,cdataReformatRanges);
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
    return cdataReformatRanges != null && !cdataReformatRanges.isEmpty() ? Result.STOP : Result.CONTINUE;
  }
  return Result.CONTINUE;
}
