{
  XSourcePosition position=XDebuggerUtilImpl.getCaretPosition(project,event.getDataContext());
  if (position == null)   return;
  Editor editor=event.getData(CommonDataKeys.EDITOR);
  int lineStart=position.getLine();
  int linesEnd=lineStart;
  if (editor != null) {
    FoldRegion region=FoldingUtil.findFoldRegionStartingAtLine(editor,lineStart);
    if (region != null && !region.isExpanded()) {
      linesEnd=region.getDocument().getLineNumber(region.getEndOffset());
    }
  }
  VirtualFile file=position.getFile();
  final XBreakpointManager breakpointManager=XDebuggerManager.getInstance(project).getBreakpointManager();
  XLineBreakpointType<?>[] lineTypes=XDebuggerUtil.getInstance().getLineBreakpointTypes();
  XLineBreakpointType<?> typeWinner=null;
  int lineWinner=-1;
  for (int line=lineStart; line <= linesEnd; line++) {
    int maxPriority=0;
    for (    XLineBreakpointType<?> type : lineTypes) {
      maxPriority=Math.max(maxPriority,type.getPriority());
      final XLineBreakpoint<? extends XBreakpointProperties> breakpoint=breakpointManager.findBreakpointAtLine(type,file,line);
      if (breakpoint != null && myTemporary && !breakpoint.isTemporary()) {
        breakpoint.setTemporary(true);
      }
 else       if (type.canPutAt(file,line,project) || breakpoint != null) {
        if (typeWinner == null || type.getPriority() > typeWinner.getPriority()) {
          typeWinner=type;
          lineWinner=line;
        }
      }
    }
    if (typeWinner != null && typeWinner.getPriority() == maxPriority) {
      break;
    }
  }
  if (typeWinner != null) {
    XDebuggerUtil.getInstance().toggleLineBreakpoint(project,typeWinner,file,lineWinner,myTemporary);
  }
  ExpandRegionAction.expandRegionAtCaret(project,editor);
  if (editor != null && lineStart != lineWinner) {
    editor.getCaretModel().moveToOffset(editor.getDocument().getLineStartOffset(lineWinner));
  }
}
