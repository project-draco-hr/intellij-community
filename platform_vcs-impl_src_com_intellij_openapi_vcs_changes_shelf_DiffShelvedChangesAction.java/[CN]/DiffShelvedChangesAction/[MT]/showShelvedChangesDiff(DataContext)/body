{
  final Project project=CommonDataKeys.PROJECT.getData(dc);
  if (project == null)   return;
  if (ChangeListManager.getInstance(project).isFreezedWithNotification(null))   return;
  List<ShelvedChangeList> changeLists=ShelvedChangesViewManager.getShelvedLists(dc);
  ShelvedChangeList changeList=ObjectUtils.assertNotNull(ContainerUtil.getFirstItem(changeLists));
  final List<ShelvedChange> textChanges=changeList.getChanges(project);
  final List<ShelvedBinaryFile> binaryChanges=changeList.getBinaryFiles();
  final List<MyDiffRequestProducer> diffRequestProducers=new ArrayList<>();
  processTextChanges(project,textChanges,diffRequestProducers);
  processBinaryFiles(project,binaryChanges,diffRequestProducers);
  Collections.sort(diffRequestProducers,ChangeDiffRequestComparator.getInstance());
  final Set<Object> selectedChanges=new HashSet<>();
  selectedChanges.addAll(ShelvedChangesViewManager.getShelveChanges(dc));
  selectedChanges.addAll(ShelvedChangesViewManager.getBinaryShelveChanges(dc));
  int index=0;
  for (int i=0; i < diffRequestProducers.size(); i++) {
    MyDiffRequestProducer producer=diffRequestProducers.get(i);
    if (selectedChanges.contains(producer.getBinaryChange()) || selectedChanges.contains(producer.getTextChange())) {
      index=i;
      break;
    }
  }
  MyDiffRequestChain chain=new MyDiffRequestChain(diffRequestProducers,index);
  DiffManager.getInstance().showDiff(project,chain,DiffDialogHints.FRAME);
}
