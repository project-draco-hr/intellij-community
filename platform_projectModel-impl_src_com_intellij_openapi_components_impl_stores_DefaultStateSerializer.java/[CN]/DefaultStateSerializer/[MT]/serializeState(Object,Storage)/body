{
  if (state instanceof Element) {
    return (Element)state;
  }
 else   if (state instanceof JDOMExternalizable) {
    Element element=new Element("temp_element");
    ((JDOMExternalizable)state).writeExternal(element);
    return element;
  }
 else {
    return XmlSerializer.serialize(state,new SkipDefaultValuesSerializationFilters(){
      @Override public boolean accepts(      final Accessor accessor,      final Object bean){
        if (!super.accepts(accessor,bean)) {
          return false;
        }
        if (storage != null) {
          for (          Annotation annotation : accessor.getAnnotations()) {
            if (StorageId.class.isAssignableFrom(annotation.annotationType()) && !((StorageId)annotation).value().equals(storage.id())) {
              return false;
            }
          }
          return storage.isDefault();
        }
        return true;
      }
    }
);
  }
}
