{
  int relativeLevel=-1;
  InsertHandler<LookupElement> insertHandler=null;
  PyFromImportStatement fromImport=PsiTreeUtil.getParentOfType(myElement,PyFromImportStatement.class);
  if (fromImport != null && myElement.getParent() != fromImport) {
    PyReferenceExpression src=fromImport.getImportSource();
    if (src != null) {
      PsiElement modCandidate=src.getReference().resolve();
      if (modCandidate instanceof PyExpression) {
        addImportedNames(fromImport.getImportElements());
        PyExpression module=(PyExpression)modCandidate;
        PyType qualifierType=myContext.getType(module);
        if (qualifierType != null) {
          ProcessingContext ctx=new ProcessingContext();
          ctx.put(PyType.CTX_NAMES,myNamesAlready);
          Collections.addAll(myObjects,qualifierType.getCompletionVariants(myElement.getName(),myElement,ctx));
        }
        return myObjects.toArray();
      }
 else       if (modCandidate instanceof PsiDirectory) {
        fillFromDir((PsiDirectory)modCandidate,ImportKeywordHandler.INSTANCE);
        return myObjects.toArray();
      }
    }
 else {
      relativeLevel=fromImport.getRelativeLevel();
      if (relativeLevel > 0) {
        PsiDirectory relativeDir=ResolveImportUtil.stepBackFrom(myCurrentFile,relativeLevel);
        if (relativeDir != null) {
          addImportedNames(fromImport.getImportElements());
          fillFromDir(relativeDir,null);
        }
      }
    }
  }
 else {
    ASTNode n=myElement.getNode().getTreePrev();
    while (n != null && n.getElementType() == PyTokenTypes.DOT) {
      relativeLevel+=1;
      n=n.getTreePrev();
    }
    if (fromImport != null) {
      addImportedNames(fromImport.getImportElements());
      if (!alreadyHasImportKeyword()) {
        insertHandler=ImportKeywordHandler.INSTANCE;
      }
    }
 else {
      myNamesAlready.add(PyNames.FUTURE_MODULE);
      PyImportStatement importStatement=PsiTreeUtil.getParentOfType(myElement,PyImportStatement.class);
      if (importStatement != null) {
        addImportedNames(importStatement.getImportElements());
      }
    }
    if ((relativeLevel >= 0 || !ResolveImportUtil.isAbsoluteImportEnabledFor(myCurrentFile))) {
      final PsiDirectory containingDirectory=myCurrentFile.getContainingDirectory();
      if (containingDirectory != null) {
        QualifiedName thisQName=QualifiedNameFinder.findShortestImportableQName(containingDirectory);
        if (thisQName == null || thisQName.getComponentCount() == relativeLevel) {
          fillFromDir(ResolveImportUtil.stepBackFrom(myCurrentFile,relativeLevel),insertHandler);
        }
 else         if (thisQName.getComponentCount() > relativeLevel) {
          thisQName=thisQName.removeTail(relativeLevel);
          fillFromQName(thisQName,insertHandler);
        }
      }
    }
  }
  if (relativeLevel == -1) {
    fillFromQName(QualifiedName.fromComponents(),insertHandler);
  }
  return ArrayUtil.toObjectArray(myObjects);
}
