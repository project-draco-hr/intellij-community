{
  GrExpression qualifier=ref.getQualifierExpression();
  if (qualifier instanceof GrReferenceExpression) {
    if (((GrReferenceExpression)qualifier).resolve() instanceof PsiClass)     return null;
  }
  if (qualifier != null) {
    PsiType qType=qualifier.getType();
    if (qType instanceof PsiClassType) {
      PsiClassType.ClassResolveResult qResult=((PsiClassType)qType).resolveGenerics();
      PsiClass clazz=qResult.getElement();
      if (clazz != null) {
        PsiClass mapClass=JavaPsiFacade.getInstance(ref.getProject()).findClass(CommonClassNames.JAVA_UTIL_MAP,ref.getResolveScope());
        if (mapClass != null && mapClass.getTypeParameters().length == 2) {
          PsiSubstitutor substitutor=TypeConversionUtil.getClassSubstitutor(mapClass,clazz,qResult.getSubstitutor());
          if (substitutor != null) {
            PsiType substituted=substitutor.substitute(mapClass.getTypeParameters()[1]);
            if (substituted != null) {
              return PsiImplUtil.normalizeWildcardTypeByPosition(substituted,ref);
            }
          }
        }
      }
    }
  }
  return null;
}
