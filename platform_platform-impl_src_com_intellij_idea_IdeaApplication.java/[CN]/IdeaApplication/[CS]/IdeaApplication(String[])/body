{
  LOG.assertTrue(ourInstance == null);
  ourInstance=this;
  ArrayList<String> arguments=new ArrayList<String>();
  for (  String arg : args) {
    if (arg.startsWith("-D")) {
      String[] keyValue=arg.substring(2).split("=");
      if (keyValue.length == 2) {
        System.setProperty(keyValue[0],keyValue[1]);
        continue;
      }
    }
    arguments.add(arg);
  }
  myArgs=ArrayUtil.toStringArray(arguments);
  boolean isInternal=Boolean.getBoolean(IDEA_IS_INTERNAL_PROPERTY);
  boolean isUnitTest=Boolean.getBoolean(IDEA_IS_UNIT_TEST);
  boolean headless=Main.isHeadless();
  patchSystem(headless);
  if (Main.isCommandLine()) {
    if (CommandLineApplication.ourInstance == null) {
      new CommandLineApplication(isInternal,isUnitTest,headless);
    }
    if (isUnitTest) {
      myLoaded=true;
    }
  }
 else {
    Splash splash=null;
    if (myArgs.length == 0) {
      myStarter=getStarter();
      if (myStarter instanceof IdeStarter) {
        splash=((IdeStarter)myStarter).showSplash(myArgs);
      }
    }
    ApplicationManagerEx.createApplication(isInternal,isUnitTest,false,false,ApplicationManagerEx.IDEA_APPLICATION,splash);
  }
  if (myStarter == null) {
    myStarter=getStarter();
  }
  if (headless && myStarter instanceof ApplicationStarterEx && !((ApplicationStarterEx)myStarter).isHeadless()) {
    Main.showMessage("Startup Error","Application cannot start in headless mode",true);
    System.exit(Main.NO_GRAPHICS);
  }
  myStarter.premain(args);
}
