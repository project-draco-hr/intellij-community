{
  File tempDirectory=createTempDirectory();
  final VirtualFile root=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(tempDirectory);
  VirtualFile dir1=createChildDirectory(root,"dir1");
  VirtualFile dir2=createChildDirectory(root,"dir2");
  PsiTestUtil.addSourceRoot(getModule(),dir1);
  PsiTestUtil.addLibrary(getModule(),"mylib","",new String[]{dir2.getPath()},ArrayUtil.EMPTY_STRING_ARRAY);
  assertSourceIs(dir1);
  assertLibIs(dir2);
  delete(dir1);
  assertSourceIs(null);
  assertLibIs(dir2);
  myVirtualFilePointerManager.assertConsistency();
  rename(dir2,"dir1");
  myVirtualFilePointerManager.assertConsistency();
  assertSourceIs(dir2);
  assertLibIs(dir2);
  rename(dir2,"dir2");
  assertSourceIs(dir2);
  assertLibIs(dir2);
  dir1=createChildDirectory(root,"dir1");
  assertNotNull(dir1);
  assertSourceIs(dir2);
  assertLibIs(dir2);
  PsiTestUtil.removeAllRoots(getModule(),getTestProjectJdk());
}
