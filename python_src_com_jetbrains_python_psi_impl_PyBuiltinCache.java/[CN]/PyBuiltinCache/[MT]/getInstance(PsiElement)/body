{
  if (reference != null) {
    final Module module=ModuleUtil.findModuleForPsiElement(reference);
    final Project project=reference.getProject();
    ComponentManager instance_key=module != null ? module : project;
    PyBuiltinCache instance=ourInstanceCache.get(instance_key);
    if (instance != null) {
      return instance;
    }
    Sdk sdk=null;
    if (module != null) {
      sdk=PythonSdkType.findPythonSdk(module);
    }
 else {
      final PsiFile psifile=reference.getContainingFile();
      if (psifile != null) {
        final VirtualFile vfile=psifile.getVirtualFile();
        if (vfile != null) {
          final ProjectRootManager projectRootManager=ProjectRootManager.getInstance(project);
          sdk=projectRootManager.getProjectJdk();
          if (sdk == null) {
            final List<OrderEntry> orderEntries=projectRootManager.getFileIndex().getOrderEntriesForFile(vfile);
            for (            OrderEntry orderEntry : orderEntries) {
              if (orderEntry instanceof JdkOrderEntry) {
                sdk=((JdkOrderEntry)orderEntry).getJdk();
              }
            }
          }
        }
      }
    }
    if (sdk != null) {
      return getBuiltinsForSdk(project,instance_key,sdk);
    }
  }
  return DUD_INSTANCE;
}
