{
  if (psifile == null) {
    return null;
  }
  Project project=psifile.getProject();
  Module module=ModuleUtil.findModuleForPsiElement(psifile);
  Sdk sdk=null;
  if (module != null) {
    sdk=PythonSdkType.findPythonSdk(module);
  }
 else {
    final VirtualFile vfile=psifile.getVirtualFile();
    if (vfile != null) {
      final ProjectRootManager projectRootManager=ProjectRootManager.getInstance(project);
      sdk=projectRootManager.getProjectJdk();
      if (sdk == null) {
        final List<OrderEntry> orderEntries=projectRootManager.getFileIndex().getOrderEntriesForFile(vfile);
        for (        OrderEntry orderEntry : orderEntries) {
          if (orderEntry instanceof JdkOrderEntry) {
            sdk=((JdkOrderEntry)orderEntry).getJdk();
          }
 else           if (orderEntry instanceof ModuleLibraryOrderEntryImpl) {
            sdk=PythonSdkType.findPythonSdk(orderEntry.getOwnerModule());
          }
        }
      }
    }
 else     if (ApplicationManager.getApplication().isUnitTestMode()) {
      sdk=project.getUserData(TEST_SDK);
    }
  }
  return sdk;
}
