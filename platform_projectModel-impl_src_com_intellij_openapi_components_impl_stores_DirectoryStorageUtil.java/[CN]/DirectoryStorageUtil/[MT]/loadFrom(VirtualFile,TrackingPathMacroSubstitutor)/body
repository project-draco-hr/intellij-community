{
  if (dir == null || !dir.exists()) {
    return Collections.emptyMap();
  }
  StringInterner interner=new StringInterner();
  Map<String,Map<String,Element>> map=new THashMap<String,Map<String,Element>>();
  for (  VirtualFile file : dir.getChildren()) {
    if (!StringUtilRt.endsWithIgnoreCase(file.getNameSequence(),FileStorageCoreUtil.DEFAULT_EXT)) {
      continue;
    }
    try {
      if (file.getLength() == 0) {
        LOG.warn("Ignore empty file " + file.getPath());
        continue;
      }
      Element element=JDOMUtil.load(file.getInputStream());
      String name=FileStorageCoreUtil.getComponentNameIfValid(element);
      if (name == null) {
        continue;
      }
      if (!element.getName().equals(FileStorageCoreUtil.COMPONENT)) {
        LOG.error("Incorrect root tag name (" + element.getName() + ") in "+ file.getPresentableUrl());
        continue;
      }
      List<Element> elementChildren=element.getChildren();
      if (elementChildren.isEmpty()) {
        continue;
      }
      Element state=(Element)elementChildren.get(0).detach();
      if (JDOMUtil.isEmpty(state)) {
        continue;
      }
      JDOMUtil.internElement(state,interner);
      if (pathMacroSubstitutor != null) {
        pathMacroSubstitutor.expandPaths(state);
        pathMacroSubstitutor.addUnknownMacros(name,PathMacrosCollector.getMacroNames(state));
      }
      Map<String,Element> fileToState=map.get(name);
      if (fileToState == null) {
        fileToState=new THashMap<String,Element>();
        fileToState.put(file.getName(),state);
        map.put(name,fileToState);
      }
 else {
        fileToState.put(file.getName(),state);
      }
    }
 catch (    Throwable e) {
      LOG.warn("Unable to load state",e);
    }
  }
  return map;
}
