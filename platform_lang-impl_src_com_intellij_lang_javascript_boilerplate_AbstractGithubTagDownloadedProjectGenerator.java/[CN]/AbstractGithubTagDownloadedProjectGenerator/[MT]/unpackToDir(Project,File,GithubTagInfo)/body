{
  File zipArchiveFile=getCacheFile(tag);
  String primaryUrl=getPrimaryZipArchiveUrlForDownload(tag);
  boolean downloaded=false;
  if (primaryUrl != null) {
    try {
      downloadAndUnzip(project,primaryUrl,zipArchiveFile,extractToDir,false);
      downloaded=true;
    }
 catch (    GeneratorException e) {
      LOG.info("Can't download " + primaryUrl,e);
      FileUtil.delete(zipArchiveFile);
    }
  }
  if (!downloaded) {
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      throw new GeneratorException("Download " + tag.getZipballUrl() + " is skipped in unit test mode");
    }
    downloadAndUnzip(project,tag.getZipballUrl(),zipArchiveFile,extractToDir,true);
  }
}
