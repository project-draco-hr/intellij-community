{
  final PsiFile psiFile=file.getContainingFile();
  if (psiFile != null) {
    final Runnable action=new Runnable(){
      public void run(){
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          public void run(){
            if (project.isDisposed())             return;
            final PsiDocumentManager manager=PsiDocumentManager.getInstance(project);
            manager.commitDocument(manager.getDocument(psiFile));
          }
        }
);
      }
    }
;
    if (ApplicationManager.getApplication().isDispatchThread()) {
      action.run();
    }
 else {
      ApplicationManager.getApplication().invokeAndWait(action,ModalityState.defaultModalityState());
    }
  }
  if (project.isDisposed())   return;
  if (file instanceof PsiFile) {
    matchContext.getSink().processFile((PsiFile)file);
  }
  if (progress != null) {
    progress.setFraction((double)scannedFilesCount / totalFilesToScan);
  }
  ++scannedFilesCount;
  if (file instanceof PsiIdentifier) {
    file=file.getParent();
  }
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      match(file);
    }
  }
);
  file=null;
}
