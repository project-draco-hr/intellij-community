{
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  matchContext.clear();
  matchContext.setSink(new MatchConstraintsSink(sink,options.getMaxMatchesCount(),options.isDistinct(),options.isCaseSensitiveMatch()));
  matchContext.setOptions(options);
  matchContext.setMatcher(visitor);
  visitor.setMatchContext(matchContext);
  CompiledPattern compiledPattern=null;
synchronized (getClass()) {
    final LastMatchData data=lastMatchData != null ? lastMatchData.get() : null;
    if (data != null && options == data.lastOptions) {
      compiledPattern=data.lastPattern;
    }
    lastMatchData=null;
  }
  if (compiledPattern == null) {
    compiledPattern=PatternCompiler.compilePattern(project,options);
  }
  matchContext.setPattern(compiledPattern);
  return compiledPattern;
}
