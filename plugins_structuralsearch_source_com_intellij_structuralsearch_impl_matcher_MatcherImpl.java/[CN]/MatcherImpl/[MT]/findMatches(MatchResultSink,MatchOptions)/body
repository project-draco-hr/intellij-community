{
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  matchContext.clear();
  matchContext.setSink(new MatchConstraintsSink(sink,options.getMaxMatchesCount(),options.isDistinct(),options.isCaseSensitiveMatch()));
  matchContext.setOptions(options);
  matchContext.setMatcher(visitor);
  CompiledPattern compiledPattern=null;
synchronized (getClass()) {
    if (options == lastOptions) {
      compiledPattern=lastPattern;
    }
    lastOptions=null;
    lastPattern=null;
  }
  if (compiledPattern == null) {
    compiledPattern=PatternCompiler.compilePattern(project,options);
  }
  if (compiledPattern == null) {
    return;
  }
  matchContext.setPattern(compiledPattern);
  matchContext.getSink().setMatchingProcess(scheduler);
  scheduler.init();
  progress=matchContext.getSink().getProgressIndicator();
  visitor.setMatchContext(matchContext);
  if (isTesting) {
    final PsiElement[] elements=((LocalSearchScope)options.getScope()).getScope();
    for (    PsiElement element : elements) {
      match(element);
    }
    matchContext.getSink().matchingFinished();
    return;
  }
  final Language ourPatternLanguage=((LanguageFileType)options.getFileType()).getLanguage();
  SearchScope searchScope=compiledPattern.getScope();
  if (searchScope == null)   searchScope=options.getScope();
  if (searchScope instanceof GlobalSearchScope) {
    final GlobalSearchScope scope=(GlobalSearchScope)searchScope;
    final ContentIterator ci=new ContentIterator(){
      public boolean processFile(      VirtualFile fileOrDir){
        if (!fileOrDir.isDirectory()) {
          final PsiFile file=PsiManager.getInstance(project).findFile(fileOrDir);
          if ((options.getFileType() == StdFileTypes.JAVA && file instanceof PsiJavaFile) || (options.getFileType() != StdFileTypes.JAVA && file instanceof XmlFile)) {
            final FileViewProvider viewProvider=file.getViewProvider();
            for (            Language lang : viewProvider.getPrimaryLanguages()) {
              if (lang != ourPatternLanguage)               continue;
              ++totalFilesToScan;
              scheduler.addOneTask(new MatchOneFile(viewProvider.getPsi(lang)));
            }
          }
        }
        return true;
      }
    }
;
    final ProjectRootManager instance=ProjectRootManager.getInstance(project);
    final ProjectFileIndex projectFileIndex=instance.getFileIndex();
    final VirtualFile[] rootFiles=ApplicationManager.getApplication().runReadAction(new Computable<VirtualFile[]>(){
      public VirtualFile[] compute(){
        final VirtualFile[] contentRoots=instance.getContentRoots();
        List<VirtualFile> result=new ArrayList<VirtualFile>(contentRoots.length);
        for (        VirtualFile file : contentRoots)         result.add(file);
        if (scope.isSearchInLibraries()) {
          for (          VirtualFile file : instance.getRootFiles(ProjectRootType.SOURCE)) {
            if (projectFileIndex.isInLibrarySource(file)) {
              result.add(file);
            }
          }
        }
        return result.toArray(VirtualFile.EMPTY_ARRAY);
      }
    }
);
    HashSet<VirtualFile> visited=new HashSet<VirtualFile>(rootFiles.length);
    final VirtualFileFilter filter=new VirtualFileFilter(){
      public boolean accept(      VirtualFile file){
        if (!file.isDirectory())         return scope.contains(file);
        return true;
      }
    }
;
    for (    final VirtualFile rootFile : rootFiles) {
      if (visited.contains(rootFile))       continue;
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
          FileIndexImplUtil.iterateRecursively(rootFile,filter,ci);
        }
      }
);
      visited.add(rootFile);
    }
  }
 else {
    final PsiElement[] elementsToScan=((LocalSearchScope)searchScope).getScope();
    totalFilesToScan=elementsToScan.length;
    for (int i=0; i < elementsToScan.length; ++i) {
      final Language language=elementsToScan[i].getLanguage();
      if (language != JspxFileViewProvider.JAVA_HOLDER_METHOD_TREE_LANGUAGE && language == ourPatternLanguage) {
        scheduler.addOneTask(new MatchOneFile(elementsToScan[i]));
      }
      elementsToScan[i]=null;
    }
  }
  if (scheduler.getTaskQueueEndAction() == null) {
    scheduler.setTaskQueueEndAction(new Runnable(){
      public void run(){
        matchContext.getSink().matchingFinished();
      }
    }
);
  }
  scheduler.executeNext();
}
