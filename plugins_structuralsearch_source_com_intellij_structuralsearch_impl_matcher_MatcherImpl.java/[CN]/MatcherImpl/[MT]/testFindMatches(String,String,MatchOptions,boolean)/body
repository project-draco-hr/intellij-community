{
  CollectingMatchResultSink sink=new CollectingMatchResultSink();
  try {
    PsiElement[] elements=MatcherImplUtil.createTreeFromText(source,filePattern ? MatcherImplUtil.TreeContext.File : MatcherImplUtil.TreeContext.Block,options.getFileType(),project);
    options.setSearchPattern(pattern);
    options.setScope(new LocalSearchScope(elements));
    testFindMatches(sink,options);
  }
 catch (  IncorrectOperationException e) {
    throw new MalformedPatternException();
  }
  return sink.getMatches();
}
