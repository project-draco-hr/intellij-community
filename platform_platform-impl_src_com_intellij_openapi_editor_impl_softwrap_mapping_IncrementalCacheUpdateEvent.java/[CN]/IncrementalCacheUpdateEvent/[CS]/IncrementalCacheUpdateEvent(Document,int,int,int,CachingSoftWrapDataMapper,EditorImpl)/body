{
  myStartOffset=editor.myUseNewRendering ? editor.visualLineStartOffset(editor.offsetToVisualLine(startOffset) - 1) : mapper.getPreviousVisualLineStartOffset(startOffset);
  myMandatoryEndOffset=newEndOffset;
  myLengthDiff=newEndOffset - oldEndOffset;
  myStartLogicalPosition=editor.myUseNewRendering ? editor.offsetToLogicalPosition(myStartOffset) : mapper.offsetToLogicalPosition(myStartOffset);
  if (editor.myUseNewRendering) {
    myStartVisualPosition=editor.logicalToVisualPosition(myStartLogicalPosition);
  }
 else {
    LOG.assertTrue(myStartLogicalPosition.visualPositionAware);
    myStartVisualPosition=myStartLogicalPosition.toVisualPosition();
  }
  myOldEndLogicalLine=document.getLineNumber(oldEndOffset);
}
