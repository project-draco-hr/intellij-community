{
  Pair<Component,Rectangle> rendererAndBounds=getCellRendererAndBounds(key);
  ExpandedSubComponentProvider subComponentProvider=getExpandedSubComponentProvider();
  if (subComponentProvider != null && rendererAndBounds != null) {
    Component comp=rendererAndBounds.getFirst();
    myRendererPane.add(comp);
    try {
      comp.setBounds(rendererAndBounds.getSecond());
      comp.validate();
      Pair<Component,Rectangle> subComponent=subComponentProvider.getExpandedSubComponent(comp);
      if (subComponent == null) {
        rendererAndBounds=null;
      }
 else       if (subComponent.getSecond() == null) {
        rendererAndBounds=Pair.create(subComponent.getFirst(),rendererAndBounds.getSecond());
      }
 else {
        Point offset=rendererAndBounds.getSecond().getLocation();
        subComponent.getSecond().translate((int)offset.getX(),(int)offset.getY());
        rendererAndBounds=subComponent;
      }
    }
  finally {
      myRendererPane.remove(comp);
    }
  }
  if (rendererAndBounds == null)   return null;
  Component renderer=rendererAndBounds.first;
  if (!(renderer instanceof JComponent))   return null;
  if (((JComponent)renderer).getClientProperty(DISABLE_EXPANDABLE_HANDLER) != null)   return null;
  myKeyItemBounds=rendererAndBounds.second;
  Rectangle cellBounds=myKeyItemBounds;
  Rectangle visibleRect=getVisibleRect(key);
  if (cellBounds.y < visibleRect.y)   return null;
  int cellMaxY=cellBounds.y + cellBounds.height;
  int visMaxY=visibleRect.y + visibleRect.height;
  if (cellMaxY > visMaxY)   return null;
  int cellMaxX=cellBounds.x + cellBounds.width;
  int visMaxX=visibleRect.x + visibleRect.width;
  Point location=new Point(visMaxX,cellBounds.y);
  SwingUtilities.convertPointToScreen(location,myComponent);
  Rectangle screen=!Registry.is("ide.expansion.hints.on.all.screens") ? ScreenUtil.getScreenRectangle(location) : ScreenUtil.getAllScreensRectangle();
  int borderWidth=isPaintBorder() ? 1 : 0;
  int width=Math.min(screen.width + screen.x - location.x - borderWidth,cellMaxX - visMaxX);
  int height=cellBounds.height;
  if (width <= 0 || height <= 0)   return null;
  Dimension size=getImageSize(width,height);
  myImage=UIUtil.createImage(size.width,size.height,BufferedImage.TYPE_INT_RGB);
  Graphics2D g=myImage.createGraphics();
  g.setClip(null);
  doFillBackground(height,width,g);
  g.translate(cellBounds.x - visMaxX,0);
  doPaintTooltipImage(renderer,cellBounds,g,key);
  CustomLineBorder border=null;
  if (borderWidth > 0) {
    border=new CustomLineBorder(getBorderColor(),borderWidth,0,borderWidth,borderWidth);
    location.y-=borderWidth;
    size.width+=borderWidth;
    size.height+=borderWidth + borderWidth;
  }
  g.dispose();
  myRendererPane.remove(renderer);
  myTipComponent.setBorder(border);
  myTipComponent.setPreferredSize(size);
  return location;
}
