{
  new WriteCommandAction.Simple(module.getProject()){
    @Override protected void run() throws Throwable {
      LibraryTable libraryTable=ProjectLibraryTable.getInstance(module.getProject());
      Library library=libraryTable.createLibrary(libName);
      Library.ModifiableModel libraryModel=library.getModifiableModel();
      try {
        for (        VirtualFile root : classesRoots) {
          libraryModel.addRoot(root,OrderRootType.CLASSES);
        }
        libraryModel.commit();
      }
 catch (      Throwable t) {
        libraryModel.dispose();
        throw t;
      }
      model.addLibraryEntry(library);
      OrderEntry[] orderEntries=model.getOrderEntries();
      OrderEntry last=orderEntries[orderEntries.length - 1];
      System.arraycopy(orderEntries,0,orderEntries,1,orderEntries.length - 1);
      orderEntries[0]=last;
      model.rearrangeOrderEntries(orderEntries);
    }
  }
.execute().throwException();
}
