{
  StubElement stub=getStub();
  if (stub != null) {
    while (!(stub instanceof PsiFileStub)) {
      stub=stub.getParentStub();
    }
    PsiFile psi=(PsiFile)stub.getPsi();
    if (psi != null) {
      return psi;
    }
    ApplicationManager.getApplication().assertReadAccessAllowed();
synchronized (PsiLock.LOCK) {
      if (getStub() != null) {
        String reason=((PsiFileStubImpl<?>)stub).getInvalidationReason();
        PsiInvalidElementAccessException exception=new PsiInvalidElementAccessException(this,"no psi for file stub " + stub + ", invalidation reason="+ reason,null);
        if (PsiFileImpl.STUB_PSI_MISMATCH.equals(reason)) {
          throw new ProcessCanceledException(exception);
        }
        throw exception;
      }
    }
  }
  return mySubstrateRef.getContainingFile();
}
