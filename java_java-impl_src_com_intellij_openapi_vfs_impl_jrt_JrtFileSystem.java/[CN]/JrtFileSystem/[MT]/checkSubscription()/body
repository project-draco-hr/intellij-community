{
  if (mySubscribed.getAndSet(true))   return;
  Application app=ApplicationManager.getApplication();
  app.getMessageBus().connect(app).subscribe(VirtualFileManager.VFS_CHANGES,new BulkFileListener.Adapter(){
    @Override public void after(    @NotNull List<? extends VFileEvent> events){
      Set<VirtualFile> toRefresh=null;
      for (      VFileEvent event : events) {
        if (event.getFileSystem() instanceof LocalFileSystem && event instanceof VFileContentChangeEvent) {
          VirtualFile file=event.getFile();
          if (file != null) {
            String homePath=null;
            if ("modules".equals(file.getName()))             homePath=file.getParent().getParent().getPath();
 else             if ("jimage".equals(file.getExtension()))             homePath=file.getParent().getParent().getParent().getPath();
            if (homePath != null && myHandlers.remove(homePath) != null) {
              VirtualFile root=findFileByPath(composeRootPath(homePath));
              if (root != null) {
                ((NewVirtualFile)root).markDirtyRecursively();
                if (toRefresh == null)                 toRefresh=ContainerUtil.newHashSet();
                toRefresh.add(root);
              }
            }
          }
        }
      }
      if (toRefresh != null) {
        boolean async=!ApplicationManager.getApplication().isUnitTestMode();
        RefreshQueue.getInstance().refresh(async,true,null,toRefresh);
      }
    }
  }
);
}
