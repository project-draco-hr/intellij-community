{
  DuplocatorSettings settings=DuplocatorSettings.getInstance();
  boolean oldMethods=settings.DISTINGUISH_METHODS;
  boolean oldLits=settings.DISTINGUISH_LITERALS;
  boolean oldVars=settings.DISTINGUISH_VARIABLES;
  int oldLowerBound=settings.LOWER_BOUND;
  Set<String> oldSet=settings.SELECTED_PROFILES;
  try {
    settings.DISTINGUISH_METHODS=distinguishMethods;
    settings.DISTINGUISH_LITERALS=distinguishListerals;
    settings.DISTINGUISH_VARIABLES=distinguishVars;
    settings.LOWER_BOUND=lowerBound;
    settings.SELECTED_PROFILES=new com.intellij.util.containers.HashSet<String>();
    for (    Language language : getLanguages()) {
      settings.SELECTED_PROFILES.add(language.getDisplayName());
    }
    DuplicatesProfile[] profiles={new SSRDuplicatesProfile()};
    configureByFile(getBasePath() + fileName);
    String testName=FileUtil.getNameWithoutExtension(fileName);
    DuplocatorHashCallback collector=new DuplocatorHashCallback(settings.LOWER_BOUND);
    DuplocateManager.hash(new AnalysisScope(getFile()),collector,profiles,DuplocatorSettings.getInstance());
    DupInfo info=collector.getInfo();
    assertEquals(patternCount,info.getPatterns());
    Set<String> expectedFiles=readExpectedFiles(testName + suffix,patternCount);
    for (int i=0; i < info.getPatterns(); i++) {
      String s=toString(info,i);
      s=reduceWhitespaces(s);
      assertTrue("Expected one of the \n" + merge(expectedFiles) + " but was\n"+ s,expectedFiles.contains(s));
    }
  }
  finally {
    settings.SELECTED_PROFILES=oldSet;
    settings.DISTINGUISH_METHODS=oldMethods;
    settings.DISTINGUISH_LITERALS=oldLits;
    settings.DISTINGUISH_VARIABLES=oldVars;
    settings.LOWER_BOUND=oldLowerBound;
  }
}
