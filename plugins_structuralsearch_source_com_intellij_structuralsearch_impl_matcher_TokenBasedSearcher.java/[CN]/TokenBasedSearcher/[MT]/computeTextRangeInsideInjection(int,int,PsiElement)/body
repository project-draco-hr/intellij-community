{
  PsiFile file=context instanceof PsiFile ? (PsiFile)context : context.getContainingFile();
  PsiElement fileContext=file.getContext();
  if (fileContext instanceof PsiLanguageInjectionHost) {
    final int[] hostStart={0};
    final int[] hostEnd={0};
    ((PsiLanguageInjectionHost)fileContext).processInjectedPsi(new PsiLanguageInjectionHost.InjectedPsiVisitor(){
      @Override public void visit(      @NotNull PsiFile injectedPsi,      @NotNull List<PsiLanguageInjectionHost.Shred> places){
        if (places.size() == 0)         return;
        RangeMarker rangeMarker=places.get(0).getHostRangeMarker();
        hostStart[0]=rangeMarker.getStartOffset();
        hostEnd[0]=rangeMarker.getEndOffset();
      }
    }
);
    return new TextRange(start - hostStart[0],end - hostStart[0]);
  }
  return new TextRange(start,end);
}
