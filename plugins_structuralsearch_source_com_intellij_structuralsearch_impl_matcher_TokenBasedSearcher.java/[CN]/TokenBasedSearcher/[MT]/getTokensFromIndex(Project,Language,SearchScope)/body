{
  final List<Token> result=new ArrayList<Token>();
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      FileBasedIndex fileBasedIndex=FileBasedIndex.getInstance();
      Collection<TokenIndexKey> keys=fileBasedIndex.getAllKeys(TokenIndex.ID,project);
      for (      TokenIndexKey key : keys) {
        if (key.getLanguageId().equals(language.getID())) {
          List<List<Token>> list=fileBasedIndex.getValues(TokenIndex.ID,key,(GlobalSearchScope)scope);
          for (          List<Token> tokens : list) {
            result.addAll(tokens);
          }
        }
      }
    }
  }
);
  return result;
}
