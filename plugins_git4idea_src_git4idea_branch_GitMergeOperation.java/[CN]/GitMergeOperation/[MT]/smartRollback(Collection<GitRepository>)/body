{
  LOG.info("Starting smart rollback...");
  final GitCompoundResult result=new GitCompoundResult(myProject);
  Collection<VirtualFile> roots=GitUtil.getRootsFromRepositories(repositories);
  GitPreservingProcess preservingProcess=new GitPreservingProcess(myProject,myGit,roots,"merge",myBranchToMerge,GitVcsSettings.UpdateChangesPolicy.STASH,getIndicator(),new Runnable(){
    @Override public void run(){
      for (      GitRepository repository : repositories) {
        result.append(repository,rollback(repository));
      }
    }
  }
);
  preservingProcess.execute();
  LOG.info("Smart rollback completed.");
  return result;
}
