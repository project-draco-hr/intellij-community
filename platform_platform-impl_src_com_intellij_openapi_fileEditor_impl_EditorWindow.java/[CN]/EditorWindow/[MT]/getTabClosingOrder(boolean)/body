{
  final VirtualFile[] allFiles=getFiles();
  final Set<VirtualFile> histFiles=ContainerUtil.newLinkedHashSet(EditorHistoryManager.getInstance(getManager().getProject()).getFiles());
  LinkedHashSet<VirtualFile> closingOrder=ContainerUtil.newLinkedHashSet();
  for (  final VirtualFile file : allFiles) {
    if (!histFiles.contains(file)) {
      closingOrder.add(file);
    }
  }
  if (closeNonModifiedFilesFirst) {
    for (    final VirtualFile file : histFiles) {
      final EditorComposite composite=findFileComposite(file);
      if (composite != null && composite.getInitialFileTimeStamp() == file.getTimeStamp()) {
        closingOrder.add(file);
      }
    }
    for (int i=0; i < myTabbedPane.getTabCount(); i++) {
      final VirtualFile file=getFileAt(i);
      if (getEditorAt(i).getInitialFileTimeStamp() == file.getTimeStamp()) {
        closingOrder.add(file);
      }
    }
  }
  closingOrder.addAll(histFiles);
  for (int i=0; i < myTabbedPane.getTabCount(); i++) {
    closingOrder.add(getFileAt(i));
  }
  final VirtualFile selectedFile=getSelectedFile();
  closingOrder.remove(selectedFile);
  closingOrder.add(selectedFile);
  return closingOrder;
}
