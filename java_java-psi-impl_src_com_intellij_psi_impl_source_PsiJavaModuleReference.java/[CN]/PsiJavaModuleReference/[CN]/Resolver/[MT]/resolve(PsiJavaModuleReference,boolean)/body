{
  Project project=reference.getProject();
  GlobalSearchScope scope=null;
  if (!incompleteCode) {
    VirtualFile file=reference.getElement().getContainingFile().getVirtualFile();
    if (file != null) {
      Module module=FileIndexFacade.getInstance(project).getModuleForFile(file);
      if (module != null) {
        scope=module.getModuleWithDependenciesAndLibrariesScope(false);
      }
    }
  }
 else {
    scope=GlobalSearchScope.allScope(project);
  }
  if (scope != null) {
    JavaFileManager service=JavaFileManager.SERVICE.getInstance(project);
    Collection<PsiJavaModule> modules=service.findModules(reference.getCanonicalText(),scope);
    if (!modules.isEmpty()) {
      ResolveResult[] result=new ResolveResult[modules.size()];
      int i=0;
      for (      PsiJavaModule module : modules)       result[i++]=new PsiElementResolveResult(module);
      return result;
    }
  }
  return ResolveResult.EMPTY_ARRAY;
}
