{
  myRepository=repository;
  VirtualFile hgDir=myRepository.getHgDir();
  myWatchRequest=LocalFileSystem.getInstance().addRootToWatch(hgDir.getPath(),true);
  myRepositoryFiles=HgRepositoryFiles.getInstance(hgDir);
  DvcsUtil.visitVcsDirVfs(hgDir,HgRepositoryFiles.getSubDirRelativePaths());
  myBranchHeadsDir=VcsUtil.getVirtualFile(myRepositoryFiles.getBranchHeadsDirPath());
  myMqDir=VcsUtil.getVirtualFile(myRepositoryFiles.getMQDirPath());
  myProject=repository.getProject();
  myDirtyScopeManager=VcsDirtyScopeManager.getInstance(myProject);
  myUpdateQueue=new MergingUpdateQueue("HgRepositoryUpdate",TIME_SPAN,true,null,this,null,Alarm.ThreadToUse.POOLED_THREAD);
  myUpdateConfigQueue=new MergingUpdateQueue("HgConfigUpdate",TIME_SPAN,true,null,this,null,Alarm.ThreadToUse.POOLED_THREAD);
  if (!myProject.isDisposed()) {
    myMessageBusConnection=myProject.getMessageBus().connect();
    myMessageBusConnection.subscribe(VirtualFileManager.VFS_CHANGES,this);
  }
 else {
    myMessageBusConnection=null;
  }
}
