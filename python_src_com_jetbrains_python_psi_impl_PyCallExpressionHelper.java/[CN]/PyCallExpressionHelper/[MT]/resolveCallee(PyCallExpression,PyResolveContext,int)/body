{
  PyFunction.Flag wrappedFlag=null;
  boolean isConstructorCall=false;
  PyExpression callee=us.getCallee();
  PsiElement resolved;
  QualifiedResolveResult resolveResult=null;
  if (callee instanceof PyReferenceExpression) {
    PyReferenceExpression ref=(PyReferenceExpression)callee;
    resolveResult=ref.followAssignmentsChain(resolveContext);
    resolved=resolveResult.getElement();
  }
 else {
    resolved=callee;
  }
  if (resolved instanceof PyClass) {
    resolved=((PyClass)resolved).findInitOrNew(true);
    isConstructorCall=true;
  }
 else   if (resolved instanceof PyCallExpression) {
    PyCallExpression redefiningCall=(PyCallExpression)resolved;
    Pair<String,PyFunction> wrapperInfo=interpretAsStaticmethodOrClassmethodWrappingCall(redefiningCall,us);
    if (wrapperInfo != null) {
      resolved=wrapperInfo.getSecond();
      String wrapper_name=wrapperInfo.getFirst();
      if (PyNames.CLASSMETHOD.equals(wrapper_name)) {
        wrappedFlag=PyFunction.Flag.CLASSMETHOD;
      }
 else       if (PyNames.STATICMETHOD.equals(wrapper_name))       wrappedFlag=PyFunction.Flag.STATICMETHOD;
    }
  }
  if (resolved instanceof Callable) {
    Set<PyFunction.Flag> flags=resolved instanceof PyFunction ? PyUtil.detectDecorationsAndWrappersOf((PyFunction)resolved) : EnumSet.noneOf(PyFunction.Flag.class);
    if (wrappedFlag != null) {
      flags.add(PyFunction.Flag.WRAPPED);
      flags.add(wrappedFlag);
    }
    List<PyExpression> qualifiers=resolveResult != null ? resolveResult.getQualifiers() : Collections.<PyExpression>emptyList();
    boolean isByInstance=isConstructorCall || isQualifiedByInstance((Callable)resolved,qualifiers,resolveContext.getTypeEvalContext()) || resolved instanceof PyBoundFunction;
    PyExpression lastQualifier=qualifiers != null && qualifiers.isEmpty() ? null : qualifiers.get(qualifiers.size() - 1);
    boolean isByClass=lastQualifier == null ? false : isQualifiedByClass((Callable)resolved,lastQualifier,resolveContext.getTypeEvalContext());
    final Callable callable=(Callable)resolved;
    implicitOffset+=getImplicitArgumentCount(callable,flags,isConstructorCall,isByInstance,isByClass);
    implicitOffset=implicitOffset < 0 ? 0 : implicitOffset;
    return new PyCallExpression.PyMarkedCallee(callable,flags,implicitOffset,resolveResult != null ? resolveResult.isImplicit() : false);
  }
  return null;
}
