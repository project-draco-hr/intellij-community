{
  ExitCode exitCode=ExitCode.NOTHING_DONE;
  for (  CompiledClass compiledClass : outputConsumer.getCompiledClasses().values()) {
    if (Utils.IS_TEST_MODE || LOG.isDebugEnabled()) {
      LOG.info("checking " + compiledClass + " by "+ getClass());
    }
    final BinaryContent originalContent=compiledClass.getContent();
    final ClassReader reader=new FailSafeClassReader(originalContent.getBuffer(),originalContent.getOffset(),originalContent.getLength());
    final int version=getClassFileVersion(reader);
    if (IS_INSTRUMENTED_KEY.get(compiledClass,Boolean.FALSE) || !canInstrument(compiledClass,version)) {
      continue;
    }
    final ClassWriter writer=new InstrumenterClassWriter(reader,getAsmClassWriterFlags(version),finder);
    try {
      if (Utils.IS_TEST_MODE || LOG.isDebugEnabled()) {
        LOG.info("instrumenting " + compiledClass + " by "+ getClass());
      }
      final BinaryContent instrumented=instrument(context,compiledClass,reader,writer,finder);
      if (instrumented != null) {
        compiledClass.setContent(instrumented);
        finder.cleanCachedData(compiledClass.getClassName());
        IS_INSTRUMENTED_KEY.set(compiledClass,Boolean.TRUE);
        exitCode=ExitCode.OK;
      }
    }
 catch (    Throwable e) {
      LOG.info(e);
      final String message=e.getMessage();
      if (message != null) {
        context.processMessage(new CompilerMessage(getPresentableName(),message,compiledClass.getSourceFilesPaths(),BuildMessage.Kind.ERROR));
      }
 else {
        context.processMessage(new CompilerMessage(getPresentableName(),e));
      }
    }
  }
  return exitCode;
}
