{
  textFieldWithHistory.addPopupMenuListener(new PopupMenuListener(){
    @Override public void popupMenuWillBecomeVisible(    PopupMenuEvent e){
      List<String> newHistory=historyProvider.produce();
      Set<String> newHistorySet=ContainerUtil.newHashSet(newHistory);
      List<String> oldHistory=textFieldWithHistory.getHistory();
      List<String> mergedHistory=ContainerUtil.newArrayList();
      for (      String item : oldHistory) {
        if (!newHistorySet.contains(item)) {
          mergedHistory.add(item);
        }
      }
      mergedHistory.addAll(newHistory);
      textFieldWithHistory.setHistory(mergedHistory);
      setLongestAsPrototype(textFieldWithHistory,mergedHistory);
      textFieldWithHistory.removePopupMenuListener(this);
    }
    @Override public void popupMenuWillBecomeInvisible(    PopupMenuEvent e){
    }
    @Override public void popupMenuCanceled(    PopupMenuEvent e){
    }
  }
);
}
