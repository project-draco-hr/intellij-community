{
  final Map<String,IdeaPluginDescriptor> availableIds=new HashMap<String,IdeaPluginDescriptor>();
  for (  IdeaPluginDescriptor plugin : allPlugins) {
    availableIds.put(plugin.getPluginId().getIdString(),plugin);
  }
  final String pluginRepositoryUrl=FEATURE_IMPLEMENTATIONS_URL + "featureType=" + FileTypeFactory.FILE_TYPE_FACTORY_EP.getName();
  return HttpRequests.request(pluginRepositoryUrl).connect(new HttpRequests.RequestProcessor<Map<String,Set<Plugin>>>(){
    @Override public Map<String,Set<Plugin>> process(    @NotNull HttpRequests.Request request) throws IOException {
      final JsonReader jsonReader=new JsonReader(request.getReader());
      jsonReader.setLenient(true);
      final JsonElement jsonRootElement=new JsonParser().parse(jsonReader);
      final Map<String,Set<Plugin>> result=new HashMap<String,Set<Plugin>>();
      for (      JsonElement jsonElement : jsonRootElement.getAsJsonArray()) {
        final JsonObject jsonObject=jsonElement.getAsJsonObject();
        final String pluginId=StringUtil.unquoteString(jsonObject.get("pluginId").toString());
        final JsonElement bundledExt=jsonObject.get("bundled");
        boolean isBundled=Boolean.parseBoolean(bundledExt.toString());
        final IdeaPluginDescriptor fromServerPluginDescription=availableIds.get(pluginId);
        if (fromServerPluginDescription == null && !isBundled)         continue;
        final IdeaPluginDescriptor loadedPlugin=PluginManager.getPlugin(PluginId.getId(pluginId));
        if (loadedPlugin != null && loadedPlugin.isEnabled())         continue;
        if (loadedPlugin != null && fromServerPluginDescription != null && StringUtil.compareVersionNumbers(loadedPlugin.getVersion(),fromServerPluginDescription.getVersion()) >= 0) {
          continue;
        }
        if (fromServerPluginDescription != null && PluginManagerCore.isBrokenPlugin(fromServerPluginDescription))         continue;
        final JsonElement ext=jsonObject.get("implementationName");
        final String extension=StringUtil.unquoteString(ext.toString());
        Set<Plugin> pluginIds=result.get(extension);
        if (pluginIds == null) {
          pluginIds=new HashSet<Plugin>();
          result.put(extension,pluginIds);
        }
        final JsonElement pluginNameElement=jsonObject.get("pluginName");
        pluginIds.add(new Plugin(PluginId.getId(pluginId),pluginNameElement != null ? StringUtil.unquoteString(pluginNameElement.toString()) : null,isBundled));
      }
      saveExtensions(result);
      return result;
    }
  }
,null,LOG);
}
