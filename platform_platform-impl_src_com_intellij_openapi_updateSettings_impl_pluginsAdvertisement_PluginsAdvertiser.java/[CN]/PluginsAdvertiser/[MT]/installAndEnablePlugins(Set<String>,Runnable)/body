{
  ProgressManager.getInstance().run(new Task.Modal(null,"Search for plugins in repository",true){
    private final Set<PluginDownloader> myPlugins=new HashSet<PluginDownloader>();
    private List<IdeaPluginDescriptor> myAllPlugins;
    @Override public void run(    @NotNull ProgressIndicator indicator){
      try {
        myAllPlugins=RepositoryHelper.loadPluginsFromAllRepositories(indicator);
        for (        IdeaPluginDescriptor descriptor : PluginManagerCore.getPlugins()) {
          if (!descriptor.isEnabled() && pluginIds.contains(descriptor.getPluginId().getIdString())) {
            myPlugins.add(PluginDownloader.createDownloader(descriptor));
          }
        }
        for (        IdeaPluginDescriptor loadedPlugin : myAllPlugins) {
          if (pluginIds.contains(loadedPlugin.getPluginId().getIdString())) {
            myPlugins.add(PluginDownloader.createDownloader(loadedPlugin));
          }
        }
      }
 catch (      Exception e) {
        LOG.info(e);
      }
    }
    @Override public void onSuccess(){
      if (myAllPlugins != null) {
        final PluginsAdvertiserDialog advertiserDialog=new PluginsAdvertiserDialog(null,myPlugins.toArray(new PluginDownloader[myPlugins.size()]),PluginManagerMain.mapToPluginIds(myAllPlugins));
        if (advertiserDialog.showAndGet()) {
          onSuccess.run();
        }
      }
    }
  }
);
}
