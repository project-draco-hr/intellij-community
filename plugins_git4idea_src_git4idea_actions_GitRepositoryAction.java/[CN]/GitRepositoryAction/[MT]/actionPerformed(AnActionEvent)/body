{
  myDelayedTasks.clear();
  FileDocumentManager.getInstance().saveAllDocuments();
  final Project project=e.getRequiredData(CommonDataKeys.PROJECT);
  GitVcs vcs=GitVcs.getInstance(project);
  final List<VirtualFile> roots=getGitRoots(project,vcs);
  if (roots == null)   return;
  final VirtualFile[] vFiles=e.getData(CommonDataKeys.VIRTUAL_FILE_ARRAY);
  VirtualFile defaultRootVar=null;
  if (vFiles != null) {
    for (    VirtualFile file : vFiles) {
      final VirtualFile root=GitUtil.gitRootOrNull(file);
      if (root != null) {
        defaultRootVar=root;
        break;
      }
    }
  }
  if (defaultRootVar == null) {
    defaultRootVar=roots.get(0);
  }
  final VirtualFile defaultRoot=defaultRootVar;
  final Set<VirtualFile> affectedRoots=new HashSet<VirtualFile>();
  String actionName=getActionName();
  List<VcsException> exceptions=new ArrayList<VcsException>();
  try {
    perform(project,roots,defaultRoot,affectedRoots,exceptions);
  }
 catch (  VcsException ex) {
    exceptions.add(ex);
  }
  if (executeFinalTasksSynchronously()) {
    runFinalTasks(project,vcs,affectedRoots,actionName,exceptions);
  }
}
