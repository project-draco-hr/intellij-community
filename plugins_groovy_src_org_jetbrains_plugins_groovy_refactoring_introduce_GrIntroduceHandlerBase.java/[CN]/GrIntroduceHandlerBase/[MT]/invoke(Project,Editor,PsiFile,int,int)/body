{
  try {
    PsiDocumentManager.getInstance(project).commitAllDocuments();
    if (!(file instanceof GroovyFileBase)) {
      throw new GrRefactoringError(GroovyRefactoringBundle.message("only.in.groovy.files"));
    }
    if (!CommonRefactoringUtil.checkReadOnlyStatus(project,file)) {
      throw new GrRefactoringError(RefactoringBundle.message("readonly.occurences.found"));
    }
    GrExpression selectedExpr=findExpression(file,startOffset,endOffset);
    final GrVariable variable=findVariable(file,startOffset,endOffset);
    final StringPartInfo stringPart=StringPartInfo.findStringPart(file,startOffset,endOffset);
    if (variable != null) {
      checkVariable(variable);
    }
 else     if (selectedExpr != null) {
      checkExpression(selectedExpr);
    }
 else     if (stringPart != null) {
      checkStringLiteral(stringPart);
    }
 else {
      throw new GrRefactoringError(null);
    }
    final GrIntroduceContext context=getContext(project,editor,selectedExpr,variable,stringPart);
    if (!CommonRefactoringUtil.checkReadOnlyStatus(project,context.getOccurrences())) {
      return false;
    }
    checkOccurrences(context.getOccurrences());
    final boolean isInplace=isInplace(context);
    Pass<OccurrencesChooser.ReplaceChoice> callback=new Pass<OccurrencesChooser.ReplaceChoice>(){
      @Override public void pass(      final OccurrencesChooser.ReplaceChoice choice){
        final Settings settings=isInplace ? getSettingsForInplace(context,choice) : showDialog(context);
        if (settings == null)         return;
        CommandProcessor.getInstance().executeCommand(project,new Runnable(){
          public void run(){
            List<RangeMarker> occurrences=ContainerUtil.newArrayList();
            Document document=editor.getDocument();
            for (            PsiElement element : context.getOccurrences()) {
              occurrences.add(createRange(document,element));
            }
            RangeMarker expressionRangeMarker=createRange(document,context.getExpression());
            RangeMarker stringPartRangeMarker=createRange(document,context.getStringPart());
            RangeMarker varRangeMarker=createRange(document,context.getVar());
            GrVariable var=ApplicationManager.getApplication().runWriteAction(new Computable<GrVariable>(){
              @Override public GrVariable compute(){
                return runRefactoring(context,settings);
              }
            }
);
            if (isInplace && var != null) {
              InplaceVariableIntroducer<PsiElement> introducer=getIntroducer(var,context,settings,occurrences,varRangeMarker,expressionRangeMarker,stringPartRangeMarker);
              PsiDocumentManager.getInstance(project).doPostponedOperationsAndUnblockDocument(editor.getDocument());
              introducer.performInplaceRefactoring(getDialog(context).suggestNames());
            }
          }
        }
,getRefactoringName(),getRefactoringName());
      }
    }
;
    if (isInplace(context)) {
      Map<OccurrencesChooser.ReplaceChoice,List<Object>> occurrencesMap=fillChoice(context);
      new OccurrencesChooser<Object>(editor){
        @Override protected TextRange getOccurrenceRange(        Object occurrence){
          if (occurrence instanceof PsiElement) {
            return ((PsiElement)occurrence).getTextRange();
          }
 else           if (occurrence instanceof StringPartInfo) {
            return ((StringPartInfo)occurrence).getRange();
          }
 else {
            return null;
          }
        }
      }
.showChooser(callback,occurrencesMap);
    }
 else {
      callback.pass(null);
    }
    return true;
  }
 catch (  GrRefactoringError e) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactoringBundle.getCannotRefactorMessage(e.getMessage()),getRefactoringName(),getHelpID());
    return false;
  }
}
