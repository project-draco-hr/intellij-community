{
synchronized (lock) {
    if (pointer instanceof SmartPsiElementPointerImpl) {
      int refCount=((SmartPsiElementPointerImpl)pointer).incrementAndGetReferenceCount(-1);
      if (refCount == 0) {
        PsiElement element=((SmartPointerEx)pointer).getCachedElement();
        if (element != null) {
          element.putUserData(CACHED_SMART_POINTER_KEY,null);
        }
        PsiFile containingFile=pointer.getContainingFile();
        if (containingFile == null)         return false;
        Set<PointerReference> pointers=getPointers(containingFile.getViewProvider().getVirtualFile());
        if (pointers == null)         return false;
        SmartPointerElementInfo info=((SmartPsiElementPointerImpl)pointer).getElementInfo();
        info.cleanup();
        for (Iterator<PointerReference> iterator=pointers.iterator(); iterator.hasNext(); ) {
          if (pointer == iterator.next().get()) {
            iterator.remove();
            return true;
          }
        }
        return false;
      }
    }
  }
  return false;
}
