{
  if (!(pointer instanceof SmartPsiElementPointerImpl)) {
    return false;
  }
  PsiFile containingFile=pointer.getContainingFile();
  if (containingFile == null)   return false;
synchronized (lock) {
    int refCount=((SmartPsiElementPointerImpl)pointer).incrementAndGetReferenceCount(-1);
    if (refCount == 0) {
      PsiElement element=((SmartPointerEx)pointer).getCachedElement();
      if (element != null) {
        element.putUserData(CACHED_SMART_POINTER_KEY,null);
      }
      VirtualFile vFile=containingFile.getViewProvider().getVirtualFile();
      Set<PointerReference> pointers=getPointers(vFile);
      if (pointers == null)       return false;
      SmartPointerElementInfo info=((SmartPsiElementPointerImpl)pointer).getElementInfo();
      info.cleanup();
      for (Iterator<PointerReference> iterator=pointers.iterator(); iterator.hasNext(); ) {
        if (pointer == iterator.next().get()) {
          iterator.remove();
          if (pointers.isEmpty()) {
            vFile.putUserData(POINTERS_KEY,null);
          }
          return true;
        }
      }
    }
  }
  return false;
}
