{
  PsiElement navTarget=new WriteCommandAction<PsiElement>(selectedValue.getFile().getProject(),selectedValue.getFile()){
    @Override protected void run(    @NotNull Result<PsiElement> result) throws Throwable {
      Extensions extensions=PluginDescriptorChooser.findOrCreateExtensionsForEP(selectedValue,candidate.epName);
      Extension extension=extensions.addExtension(candidate.epName);
      XmlTag tag=extension.getXmlTag();
      PsiElement navTarget=null;
      String keyAttrName=KEY_MAP.get(candidate.beanClassName);
      if (keyAttrName != null) {
        XmlAttribute attr=tag.setAttribute(keyAttrName,"");
        navTarget=attr.getValueElement();
      }
      if (candidate.attributeName != null) {
        tag.setAttribute(candidate.attributeName,myExtensionClass.getQualifiedName());
      }
 else {
        XmlTag subTag=tag.createChildTag(candidate.tagName,null,myExtensionClass.getQualifiedName(),false);
        tag.addSubTag(subTag,false);
      }
      result.setResult(navTarget != null ? navTarget : extension.getXmlTag());
    }
  }
.execute().throwException().getResultObject();
  PsiNavigateUtil.navigate(navTarget);
}
