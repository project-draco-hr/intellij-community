{
  final ModifiableModelsProvider modifiableModelsProvider=ModifiableModelsProvider.SERVICE.getInstance();
  final ModifiableRootModel modifiableRootModel=ApplicationManager.getApplication().runReadAction(new Computable<ModifiableRootModel>(){
    @Override public ModifiableRootModel compute(){
      return modifiableModelsProvider.getModuleModifiableModel(module);
    }
  }
);
  try {
    task.consume(modifiableRootModel);
    if (modifiableRootModel.isChanged()) {
      doWriteAction(new Runnable(){
        @Override public void run(){
          modifiableModelsProvider.commitModuleModifiableModel(modifiableRootModel);
        }
      }
);
    }
 else {
      modifiableRootModel.dispose();
    }
  }
 catch (  Throwable t) {
    modifiableModelsProvider.disposeModuleModifiableModel(modifiableRootModel);
    ExceptionUtil.rethrowAllAsUnchecked(t);
  }
}
