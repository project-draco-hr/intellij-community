{
  final Library.ModifiableModel modifiableModel=library.getModifiableModel();
  try {
    task.consume(modifiableModel);
    if (modifiableModel.isChanged()) {
      doWriteAction(new Runnable(){
        @Override public void run(){
          modifiableModel.commit();
        }
      }
);
    }
 else {
      Disposer.dispose(modifiableModel);
    }
  }
 catch (  Throwable t) {
    Disposer.dispose(modifiableModel);
    ExceptionUtil.rethrowAllAsUnchecked(t);
  }
}
