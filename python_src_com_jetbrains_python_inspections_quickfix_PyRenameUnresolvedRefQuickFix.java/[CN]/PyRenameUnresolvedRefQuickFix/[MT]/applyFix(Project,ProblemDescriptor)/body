{
  final PsiElement element=descriptor.getPsiElement();
  final PyReferenceExpression referenceExpression=PsiTreeUtil.getParentOfType(element,PyReferenceExpression.class);
  if (referenceExpression == null)   return;
  ScopeOwner parentScope=ScopeUtil.getScopeOwner(referenceExpression);
  if (parentScope == null)   return;
  List<PyReferenceExpression> refs=collectExpressionsToRename(referenceExpression,parentScope);
  LookupElement[] items=collectLookupItems(referenceExpression,parentScope);
  final String name=referenceExpression.getReferencedName();
  ReferenceNameExpression refExpr=new ReferenceNameExpression(items,name);
  TemplateBuilderImpl builder=(TemplateBuilderImpl)TemplateBuilderFactory.getInstance().createTemplateBuilder(parentScope);
  for (  PyReferenceExpression expr : refs) {
    if (!expr.equals(referenceExpression)) {
      builder.replaceElement(expr,name,name,false);
    }
 else {
      builder.replaceElement(expr,name,refExpr,true);
    }
  }
  Editor editor=getEditor(project,element.getContainingFile());
  if (editor != null) {
    editor.getCaretModel().moveToOffset(parentScope.getTextRange().getStartOffset());
    Template template=builder.buildInlineTemplate();
    TemplateManager.getInstance(project).startTemplate(editor,template);
  }
}
