{
  if (host != null && descriptor instanceof PluginNode) {
    String url=((PluginNode)descriptor).getDownloadUrl();
    return new URI(url).isAbsolute() ? url : new URL(new URL(host),url).toExternalForm();
  }
 else {
    Application app=ApplicationManager.getApplication();
    ApplicationInfoEx appInfo=ApplicationInfoImpl.getShadowInstance();
    String buildNumberAsString=buildNumber != null ? buildNumber.asString() : app != null ? ApplicationInfo.getInstance().getApiVersion() : appInfo.getBuild().asString();
    URIBuilder uriBuilder=new URIBuilder(appInfo.getPluginsDownloadUrl());
    uriBuilder.addParameter("action","download");
    uriBuilder.addParameter("id",descriptor.getPluginId().getIdString());
    uriBuilder.addParameter("build",buildNumberAsString);
    uriBuilder.addParameter("uuid",PermanentInstallationID.get());
    return uriBuilder.build().toString();
  }
}
