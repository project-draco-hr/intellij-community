{
  final Holder<Object> defaultValue=new Holder<Object>();
  processSignature(signature);
  return new MethodVisitor(Opcodes.ASM5){
    @Override public void visitEnd(){
      if ((access & Opcodes.ACC_SYNTHETIC) == 0 || (access & Opcodes.ACC_BRIDGE) > 0) {
        myMethods.add(new MethodRepr(myContext,access,myContext.get(n),myContext.get(signature),desc,exceptions,defaultValue.get()));
      }
    }
    @Override public AnnotationVisitor visitAnnotation(    String desc,    boolean visible){
      return new AnnotationCrawler((TypeRepr.ClassType)TypeRepr.getType(myContext,myContext.get(desc)),"<init>".equals(n) ? ElemType.CONSTRUCTOR : ElemType.METHOD);
    }
    @Override public AnnotationVisitor visitAnnotationDefault(){
      return new AnnotationVisitor(Opcodes.ASM5){
        public void visit(        String name,        Object value){
          defaultValue.set(value);
        }
      }
;
    }
    @Override public AnnotationVisitor visitParameterAnnotation(    int parameter,    String desc,    boolean visible){
      return new AnnotationCrawler((TypeRepr.ClassType)TypeRepr.getType(myContext,myContext.get(desc)),ElemType.PARAMETER);
    }
    @Override public void visitLdcInsn(    Object cst){
      if (cst instanceof Type) {
        myUsages.add(UsageRepr.createClassUsage(myContext,myContext.get(((Type)cst).getInternalName())));
      }
      super.visitLdcInsn(cst);
    }
    @Override public void visitMultiANewArrayInsn(    String desc,    int dims){
      final TypeRepr.ArrayType typ=(TypeRepr.ArrayType)TypeRepr.getType(myContext,myContext.get(desc));
      final TypeRepr.AbstractType element=typ.getDeepElementType();
      if (element instanceof TypeRepr.ClassType) {
        final int className=((TypeRepr.ClassType)element).className;
        myUsages.add(UsageRepr.createClassUsage(myContext,className));
        myUsages.add(UsageRepr.createClassNewUsage(myContext,className));
      }
      typ.updateClassUsages(myContext,myName,myUsages);
      super.visitMultiANewArrayInsn(desc,dims);
    }
    @Override public void visitLocalVariable(    String n,    String desc,    String signature,    Label start,    Label end,    int index){
      processSignature(signature);
      TypeRepr.getType(myContext,myContext.get(desc)).updateClassUsages(myContext,myName,myUsages);
      super.visitLocalVariable(n,desc,signature,start,end,index);
    }
    @Override public void visitTryCatchBlock(    Label start,    Label end,    Label handler,    String type){
      if (type != null) {
        TypeRepr.createClassType(myContext,myContext.get(type)).updateClassUsages(myContext,myName,myUsages);
      }
      super.visitTryCatchBlock(start,end,handler,type);
    }
    @Override public void visitTypeInsn(    int opcode,    String type){
      final TypeRepr.AbstractType typ=type.startsWith("[") ? TypeRepr.getType(myContext,myContext.get(type)) : TypeRepr.createClassType(myContext,myContext.get(type));
      if (opcode == Opcodes.NEW) {
        myUsages.add(UsageRepr.createClassUsage(myContext,((TypeRepr.ClassType)typ).className));
        myUsages.add(UsageRepr.createClassNewUsage(myContext,((TypeRepr.ClassType)typ).className));
      }
 else       if (opcode == Opcodes.ANEWARRAY) {
        if (typ instanceof TypeRepr.ClassType) {
          myUsages.add(UsageRepr.createClassUsage(myContext,((TypeRepr.ClassType)typ).className));
          myUsages.add(UsageRepr.createClassNewUsage(myContext,((TypeRepr.ClassType)typ).className));
        }
      }
      typ.updateClassUsages(myContext,myName,myUsages);
      super.visitTypeInsn(opcode,type);
    }
    @Override public void visitFieldInsn(    int opcode,    String owner,    String name,    String desc){
      registerFieldUsage(opcode,owner,name,desc);
      super.visitFieldInsn(opcode,owner,name,desc);
    }
    @Override public void visitMethodInsn(    int opcode,    String owner,    String name,    String desc,    boolean itf){
      registerMethodUsage(owner,name,desc);
      super.visitMethodInsn(opcode,owner,name,desc,itf);
    }
    @Override public void visitInvokeDynamicInsn(    String methodName,    String desc,    Handle bsm,    Object... bsmArgs){
      final Type returnType=Type.getReturnType(desc);
      addClassUsage(TypeRepr.getType(myContext,returnType));
      for (      Object arg : bsmArgs) {
        if (arg instanceof Type) {
          final Type type=(Type)arg;
          if (type.getSort() == Type.METHOD) {
            for (            Type argType : type.getArgumentTypes()) {
              addClassUsage(TypeRepr.getType(myContext,argType));
            }
            addClassUsage(TypeRepr.getType(myContext,type.getReturnType()));
          }
 else {
            addClassUsage(TypeRepr.getType(myContext,type));
          }
        }
 else         if (arg instanceof Handle) {
          processMethodHandle((Handle)arg);
        }
      }
      if (LAMBDA_FACTORY_CLASS.equals(bsm.getOwner())) {
        if (returnType.getSort() == Type.OBJECT && bsmArgs.length >= 3) {
          if (bsmArgs[0] instanceof Type) {
            final Type samMethodType=(Type)bsmArgs[0];
            if (samMethodType.getSort() == Type.METHOD) {
              registerMethodUsage(returnType.getInternalName(),methodName,samMethodType.getDescriptor());
            }
          }
        }
      }
      super.visitInvokeDynamicInsn(methodName,desc,bsm,bsmArgs);
    }
    private void processMethodHandle(    Handle handle){
      final String memberOwner=handle.getOwner();
      if (myContext.get(memberOwner) != myName) {
        final String memberName=handle.getName();
        final String memberDescriptor=handle.getDesc();
        if (isFieldAccessHandle(handle)) {
          final int tag=handle.getTag();
          int opCode;
          if (tag == Opcodes.H_GETFIELD) {
            opCode=Opcodes.GETFIELD;
          }
 else           if (tag == Opcodes.H_GETSTATIC) {
            opCode=Opcodes.GETSTATIC;
          }
 else           if (tag == Opcodes.H_PUTFIELD) {
            opCode=Opcodes.PUTFIELD;
          }
 else           if (tag == Opcodes.H_PUTSTATIC) {
            opCode=Opcodes.PUTSTATIC;
          }
 else {
            opCode=Opcodes.H_GETFIELD;
          }
          registerFieldUsage(opCode,memberOwner,memberName,memberDescriptor);
        }
 else {
          registerMethodUsage(memberOwner,memberName,memberDescriptor);
        }
      }
    }
    private void registerFieldUsage(    int opcode,    String owner,    String fName,    String desc){
      final int fieldName=myContext.get(fName);
      final int fieldOwner=myContext.get(owner);
      final int descr=myContext.get(desc);
      if (opcode == Opcodes.PUTFIELD || opcode == Opcodes.PUTSTATIC) {
        myUsages.add(UsageRepr.createFieldAssignUsage(myContext,fieldName,fieldOwner,descr));
      }
      if (opcode == Opcodes.GETFIELD || opcode == Opcodes.GETSTATIC) {
        addClassUsage(TypeRepr.getType(myContext,descr));
      }
      myUsages.add(UsageRepr.createFieldUsage(myContext,fieldName,fieldOwner,descr));
    }
    private void registerMethodUsage(    String owner,    String name,    @Nullable String desc){
      final int methodOwner=myContext.get(owner);
      final int methodName=myContext.get(name);
      myUsages.add(UsageRepr.createMetaMethodUsage(myContext,methodName,methodOwner));
      if (desc != null) {
        myUsages.add(UsageRepr.createMethodUsage(myContext,methodName,methodOwner,desc));
        addClassUsage(TypeRepr.getType(myContext,Type.getReturnType(desc)));
      }
    }
    private void addClassUsage(    final TypeRepr.AbstractType type){
      TypeRepr.ClassType classType=null;
      if (type instanceof TypeRepr.ClassType) {
        classType=(TypeRepr.ClassType)type;
      }
 else       if (type instanceof TypeRepr.ArrayType) {
        final TypeRepr.AbstractType elemType=((TypeRepr.ArrayType)type).getDeepElementType();
        if (elemType instanceof TypeRepr.ClassType) {
          classType=(TypeRepr.ClassType)elemType;
        }
      }
      if (classType != null) {
        myUsages.add(UsageRepr.createClassUsage(myContext,classType.className));
      }
    }
  }
;
}
