{
  final DataContext dataContext=e.getDataContext();
  final PsiElement[] psiElements=LangDataKeys.PSI_ELEMENT_ARRAY.getData(dataContext);
  final Set<PsiElement> classes=RunConfigurationProducer.getInstance(PatternConfigurationProducer.class).collectTestMembers(psiElements,true);
  final Project project=CommonDataKeys.PROJECT.getData(dataContext);
  final List<JUnitConfiguration> patternConfigurations=collectPatternConfigurations(classes,project);
  if (patternConfigurations.size() == 1) {
    final JUnitConfiguration configuration=patternConfigurations.get(0);
    for (    PsiElement aClass : classes) {
      configuration.getPersistentData().getPatterns().add(PatternConfigurationDelegate.getQName(aClass));
    }
  }
 else {
    JBPopupFactory.getInstance().createListPopup(new BaseListPopupStep<JUnitConfiguration>("Choose suite to add",patternConfigurations){
      @Override public PopupStep onChosen(      JUnitConfiguration configuration,      boolean finalChoice){
        for (        PsiElement aClass : classes) {
          configuration.getPersistentData().getPatterns().add(PatternConfigurationDelegate.getQName(aClass));
        }
        return FINAL_CHOICE;
      }
      @Override public Icon getIconFor(      JUnitConfiguration configuration){
        return configuration.getIcon();
      }
      @NotNull @Override public String getTextFor(      JUnitConfiguration value){
        return value.getName();
      }
    }
).showInBestPositionFor(dataContext);
  }
}
