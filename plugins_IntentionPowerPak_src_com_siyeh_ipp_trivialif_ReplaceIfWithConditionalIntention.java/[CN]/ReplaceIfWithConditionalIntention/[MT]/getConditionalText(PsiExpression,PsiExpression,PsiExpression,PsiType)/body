{
  condition=ParenthesesUtils.stripParentheses(condition);
  thenValue=ParenthesesUtils.stripParentheses(thenValue);
  elseValue=ParenthesesUtils.stripParentheses(elseValue);
  thenValue=expandDiamondsWhenNeeded(thenValue,requiredType);
  if (thenValue == null) {
    return null;
  }
  elseValue=expandDiamondsWhenNeeded(elseValue,requiredType);
  if (elseValue == null) {
    return null;
  }
  @NonNls final StringBuilder conditional=new StringBuilder();
  final String conditionText=getExpressionText(condition,true);
  conditional.append(conditionText).append('?');
  final PsiType thenType=thenValue.getType();
  final PsiType elseType=elseValue.getType();
  if (thenType instanceof PsiPrimitiveType && !PsiType.NULL.equals(thenType) && !(elseType instanceof PsiPrimitiveType)&& !(requiredType instanceof PsiPrimitiveType)) {
    final PsiPrimitiveType primitiveType=(PsiPrimitiveType)thenType;
    conditional.append(primitiveType.getBoxedTypeName());
    conditional.append(".valueOf(").append(thenValue.getText()).append("):");
    conditional.append(getExpressionText(elseValue,false));
  }
 else   if (elseType instanceof PsiPrimitiveType && !PsiType.NULL.equals(elseType) && !(thenType instanceof PsiPrimitiveType)&& !(requiredType instanceof PsiPrimitiveType)) {
    conditional.append(getExpressionText(thenValue,false));
    conditional.append(':');
    final PsiPrimitiveType primitiveType=(PsiPrimitiveType)elseType;
    conditional.append(primitiveType.getBoxedTypeName());
    conditional.append(".valueOf(").append(elseValue.getText()).append(')');
  }
 else {
    conditional.append(getExpressionText(thenValue,false));
    conditional.append(':');
    conditional.append(getExpressionText(elseValue,false));
  }
  return conditional.toString();
}
