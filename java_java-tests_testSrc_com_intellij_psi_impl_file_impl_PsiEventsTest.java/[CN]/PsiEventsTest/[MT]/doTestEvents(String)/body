{
  try {
    getPsiManager().addPsiTreeChangeListener(listener);
    eventsFired="";
    this.newText=newText;
    original=getFile().getText();
    Document document=PsiDocumentManager.getInstance(getProject()).getDocument(getFile());
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        document.setText(newText);
      }
    }
);
    PsiDocumentManager.getInstance(getProject()).commitAllDocuments();
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        document.setText(original);
      }
    }
);
    PsiDocumentManager.getInstance(getProject()).commitAllDocuments();
  }
  finally {
    getPsiManager().removePsiTreeChangeListener(listener);
  }
}
