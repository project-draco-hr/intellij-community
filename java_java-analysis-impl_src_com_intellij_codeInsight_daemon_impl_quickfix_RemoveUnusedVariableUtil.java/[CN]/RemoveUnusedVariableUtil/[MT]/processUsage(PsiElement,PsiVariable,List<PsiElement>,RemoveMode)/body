{
  if (!element.isValid())   return null;
  PsiElementFactory factory=JavaPsiFacade.getInstance(variable.getProject()).getElementFactory();
  while (element != null) {
    if (element instanceof PsiAssignmentExpression) {
      PsiAssignmentExpression expression=(PsiAssignmentExpression)element;
      PsiExpression lExpression=expression.getLExpression();
      if (!(lExpression instanceof PsiReferenceExpression) || variable != ((PsiReferenceExpression)lExpression).resolve()) {
        return null;
      }
      PsiExpression rExpression=expression.getRExpression();
      rExpression=PsiUtil.deparenthesizeExpression(rExpression);
      if (rExpression == null)       return true;
      boolean sideEffectFound=checkSideEffects(rExpression,variable,sideEffects);
      if (!(element.getParent() instanceof PsiExpressionStatement) || PsiUtil.isStatement(rExpression)) {
        if (deleteMode == RemoveMode.MAKE_STATEMENT || deleteMode == RemoveMode.DELETE_ALL && !(element.getParent() instanceof PsiExpressionStatement)) {
          element=replaceElementWithExpression(rExpression,factory,element);
          while (element.getParent() instanceof PsiParenthesizedExpression) {
            element=element.getParent().replace(element);
          }
          List<PsiElement> references=new ArrayList<PsiElement>();
          collectReferences(element,variable,references);
          deleteReferences(variable,references,deleteMode);
        }
 else         if (deleteMode == RemoveMode.DELETE_ALL) {
          deleteWholeStatement(element,factory);
        }
        return true;
      }
 else {
        if (deleteMode != RemoveMode.CANCEL) {
          deleteWholeStatement(element,factory);
        }
        return !sideEffectFound;
      }
    }
 else     if (element instanceof PsiExpressionStatement && deleteMode != RemoveMode.CANCEL) {
      final PsiElement parent=element.getParent();
      if (parent instanceof PsiIfStatement || parent instanceof PsiLoopStatement && ((PsiLoopStatement)parent).getBody() == element) {
        element.replace(JavaPsiFacade.getElementFactory(element.getProject()).createStatementFromText(";",element));
      }
 else {
        element.delete();
      }
      break;
    }
 else     if (element instanceof PsiVariable && element == variable) {
      PsiExpression expression=variable.getInitializer();
      if (expression != null) {
        expression=PsiUtil.deparenthesizeExpression(expression);
      }
      boolean sideEffectsFound=checkSideEffects(expression,variable,sideEffects);
      if (expression != null && PsiUtil.isStatement(expression) && variable instanceof PsiLocalVariable && !(variable.getParent() instanceof PsiDeclarationStatement && ((PsiDeclarationStatement)variable.getParent()).getDeclaredElements().length > 1)) {
        if (deleteMode == RemoveMode.MAKE_STATEMENT) {
          element=element.replace(createStatementIfNeeded(expression,factory,element));
          List<PsiElement> references=new ArrayList<PsiElement>();
          collectReferences(element,variable,references);
          deleteReferences(variable,references,deleteMode);
        }
 else         if (deleteMode == RemoveMode.DELETE_ALL) {
          element.delete();
        }
        return true;
      }
 else {
        if (deleteMode != RemoveMode.CANCEL) {
          if (element instanceof PsiField) {
            ((PsiField)element).normalizeDeclaration();
          }
          element.delete();
        }
        return !sideEffectsFound;
      }
    }
    element=element.getParent();
  }
  return true;
}
