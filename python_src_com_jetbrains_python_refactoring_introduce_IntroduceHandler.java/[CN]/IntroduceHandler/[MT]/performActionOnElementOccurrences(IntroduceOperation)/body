{
  final Editor editor=operation.getEditor();
  if (editor.getSettings().isVariableInplaceRenameEnabled() && !ApplicationManager.getApplication().isUnitTestMode()) {
    ensureName(operation);
    new OccurrencesChooser<PsiElement>(editor){
      @Override protected TextRange getOccurrenceRange(      PsiElement occurrence){
        return occurrence.getTextRange();
      }
    }
.showChooser(operation.getElement(),operation.getOccurrences(),new Pass<OccurrencesChooser.ReplaceChoice>(){
      @Override public void pass(      OccurrencesChooser.ReplaceChoice replaceChoice){
        operation.setReplaceAll(replaceChoice == OccurrencesChooser.ReplaceChoice.ALL);
        performInplaceIntroduce(operation);
      }
    }
);
  }
 else {
    performIntroduceWithDialog(operation);
  }
}
