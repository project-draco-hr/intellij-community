{
  final JavaParameters javaParameters=new JavaParameters();
  javaParameters.setUseClasspathJar(true);
  final Module module=getConfiguration().getConfigurationModule().getModule();
  Project project=getConfiguration().getProject();
  Sdk jdk=module == null ? ProjectRootManager.getInstance(project).getProjectSdk() : ModuleRootManager.getInstance(module).getSdk();
  javaParameters.setJdk(jdk);
  final String parameters=getConfiguration().getProgramParameters();
  getConfiguration().setProgramParameters(null);
  try {
    JavaParametersUtil.configureConfiguration(javaParameters,getConfiguration());
  }
  finally {
    getConfiguration().setProgramParameters(parameters);
  }
  javaParameters.getClassPath().addFirst(JavaSdkUtil.getIdeaRtJarPath());
  configureClasspath(javaParameters);
  final Object[] patchers=Extensions.getExtensions(ExtensionPoints.JUNIT_PATCHER);
  for (  Object patcher : patchers) {
    ((JUnitPatcher)patcher).patchJavaParameters(module,javaParameters);
  }
  for (  RunConfigurationExtension ext : Extensions.getExtensions(RunConfigurationExtension.EP_NAME)) {
    ext.updateJavaParameters(getConfiguration(),javaParameters,getRunnerSettings());
  }
  if (!StringUtil.isEmptyOrSpaces(parameters)) {
    javaParameters.getProgramParametersList().add("@name" + parameters);
  }
  return javaParameters;
}
