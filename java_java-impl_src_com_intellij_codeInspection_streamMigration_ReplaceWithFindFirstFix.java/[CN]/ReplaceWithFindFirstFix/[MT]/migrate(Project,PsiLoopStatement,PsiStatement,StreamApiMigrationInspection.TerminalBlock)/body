{
  PsiStatement statement=tb.getSingleStatement();
  PsiElementFactory elementFactory=JavaPsiFacade.getElementFactory(project);
  StringBuilder builder=generateStream(tb.getLastOperation());
  String stream=builder.append(".findFirst()").toString();
  if (statement instanceof PsiReturnStatement) {
    PsiReturnStatement returnStatement=(PsiReturnStatement)statement;
    PsiExpression value=returnStatement.getReturnValue();
    if (value == null)     return null;
    PsiReturnStatement nextReturnStatement=StreamApiMigrationInspection.getNextReturnStatement(loopStatement);
    if (nextReturnStatement == null)     return null;
    PsiExpression orElseExpression=nextReturnStatement.getReturnValue();
    if (!ExpressionUtils.isSimpleExpression(orElseExpression))     return null;
    stream=generateOptionalUnwrap(stream,tb,value,orElseExpression,null);
    restoreComments(loopStatement,body);
    boolean sibling=nextReturnStatement.getParent() == loopStatement.getParent();
    PsiElement replacement=loopStatement.replace(elementFactory.createStatementFromText("return " + stream + ";",loopStatement));
    if (sibling || !isReachable(nextReturnStatement)) {
      nextReturnStatement.delete();
    }
    return replacement;
  }
 else {
    PsiStatement[] statements=tb.getStatements();
    if (statements.length != 2)     return null;
    PsiAssignmentExpression assignment=ExpressionUtils.getAssignment(statements[0]);
    if (assignment == null) {
      if (!(statements[0] instanceof PsiExpressionStatement))       return null;
      PsiExpression expression=((PsiExpressionStatement)statements[0]).getExpression();
      restoreComments(loopStatement,body);
      return loopStatement.replace(elementFactory.createStatementFromText(stream + ".ifPresent(" + LambdaUtil.createLambda(tb.getVariable(),expression)+ ");",loopStatement));
    }
    PsiExpression lValue=assignment.getLExpression();
    if (!(lValue instanceof PsiReferenceExpression))     return null;
    PsiElement element=((PsiReferenceExpression)lValue).resolve();
    if (!(element instanceof PsiVariable))     return null;
    PsiVariable var=(PsiVariable)element;
    PsiExpression value=assignment.getRExpression();
    if (value == null)     return null;
    restoreComments(loopStatement,body);
    InitializerUsageStatus status=StreamApiMigrationInspection.getInitializerUsageStatus(var,loopStatement);
    if (status != InitializerUsageStatus.UNKNOWN) {
      PsiExpression initializer=var.getInitializer();
      if (initializer != null) {
        String replacementText=generateOptionalUnwrap(stream,tb,value,initializer,var.getType());
        return replaceInitializer(loopStatement,var,initializer,replacementText,status);
      }
    }
    PsiAssignmentExpression previousAssignment=ExpressionUtils.getAssignment(PsiTreeUtil.skipSiblingsBackward(loopStatement,PsiWhiteSpace.class,PsiComment.class));
    if (previousAssignment != null) {
      PsiExpression prevRValue=previousAssignment.getRExpression();
      PsiExpression prevLValue=previousAssignment.getLExpression();
      if (prevRValue != null && prevLValue instanceof PsiReferenceExpression && ((PsiReferenceExpression)prevLValue).resolve() == var) {
        previousAssignment.delete();
        return loopStatement.replace(elementFactory.createStatementFromText(var.getName() + " = " + generateOptionalUnwrap(stream,tb,value,prevRValue,var.getType())+ ";",loopStatement));
      }
    }
    return loopStatement.replace(elementFactory.createStatementFromText(var.getName() + " = " + generateOptionalUnwrap(stream,tb,value,lValue,var.getType())+ ";",loopStatement));
  }
}
