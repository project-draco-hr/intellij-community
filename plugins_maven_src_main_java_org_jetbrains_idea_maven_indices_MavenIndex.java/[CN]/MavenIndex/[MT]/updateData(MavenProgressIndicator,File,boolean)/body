{
  IndexData newData=new IndexData(newDataDir);
  try {
    doUpdateIndexData(newData,progress);
    newData.flush();
  }
 catch (  Throwable e) {
    newData.close(true);
    FileUtil.delete(newDataDir);
    if (e instanceof MavenServerIndexerException)     throw new MavenIndexException(e);
    if (e instanceof IOException)     throw new MavenIndexException(e);
    throw new RuntimeException(e);
  }
synchronized (this) {
    IndexData oldData=myData;
    myData=newData;
    myDataDirName=newDataDir.getName();
    if (fullUpdate) {
      myUpdateTimestamp=System.currentTimeMillis();
    }
    oldData.close(true);
    for (    File each : FileUtil.notNullize(myDir.listFiles())) {
      if (each.getName().startsWith(DATA_DIR_PREFIX) && !each.getName().equals(myDataDirName)) {
        FileUtil.delete(each);
      }
    }
  }
}
