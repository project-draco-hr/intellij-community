{
  final long modificationStampBefore=myDocument.getModificationStamp();
  Update update=new Update(myFile){
    @Override public void setRejected(){
      super.setRejected();
      doFinish(getHighlights(),modificationStampBefore);
    }
    @Override public void run(){
      if (documentChanged(modificationStampBefore) || myProject.isDisposed()) {
        return;
      }
      doAnnotate();
      ApplicationManagerEx.getApplicationEx().tryRunReadAction(new Runnable(){
        @Override public void run(){
          if (documentChanged(modificationStampBefore) || myProject.isDisposed()) {
            return;
          }
          applyRelevant();
          doFinish(getHighlights(),modificationStampBefore);
        }
      }
);
    }
  }
;
  myExternalToolPassFactory.scheduleExternalActivity(update);
}
