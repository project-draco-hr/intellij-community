{
  DaemonCodeAnalyzerEx daemonCodeAnalyzer=DaemonCodeAnalyzerEx.getInstanceEx(myProject);
  daemonCodeAnalyzer.getFileStatusMap().markFileUpToDate(myDocument,getId());
  final long modificationStampBefore=myDocument.getModificationStamp();
  Update update=new Update(myFile){
    @Override public void setRejected(){
      super.setRejected();
      doFinish(Collections.<HighlightInfo>emptyList());
    }
    @Override public void run(){
      if (documentChanged(modificationStampBefore) || myProject.isDisposed()) {
        doFinish(Collections.<HighlightInfo>emptyList());
        return;
      }
      doAnnotate();
      if (!ApplicationManagerEx.getApplicationEx().tryRunReadAction(new Runnable(){
        @Override public void run(){
          if (documentChanged(modificationStampBefore) || myProject.isDisposed()) {
            doFinish(Collections.<HighlightInfo>emptyList());
            return;
          }
          collectHighlighters();
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            @Override public void run(){
              List<HighlightInfo> highlights=documentChanged(modificationStampBefore) || myProject.isDisposed() ? Collections.<HighlightInfo>emptyList() : getHighlights();
              doFinish(highlights);
            }
          }
,ModalityState.stateForComponent(myEditor.getComponent()));
        }
      }
)) {
        doFinish(Collections.<HighlightInfo>emptyList());
      }
    }
  }
;
  myExternalToolPassFactory.scheduleExternalActivity(update);
}
