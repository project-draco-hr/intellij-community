{
  final Pair<PsiElement,TextRange> data=anchor.getUserData(PyPsiUtils.SELECTION_BREAKS_AST_NODE);
  if (data != null) {
    anchor=data.first;
  }
  final PsiNamedElement parent=PsiTreeUtil.getParentOfType(anchor,PyFile.class,PyClass.class,PyFunction.class);
  if (parent instanceof PyFile || parent instanceof PyClass) {
    final PsiElement statement=PyPsiUtils.getStatement(parent,anchor);
    return (PyFunction)parent.addBefore(generatedMethod,statement);
  }
  return (PyFunction)parent.getParent().addBefore(generatedMethod,parent);
}
