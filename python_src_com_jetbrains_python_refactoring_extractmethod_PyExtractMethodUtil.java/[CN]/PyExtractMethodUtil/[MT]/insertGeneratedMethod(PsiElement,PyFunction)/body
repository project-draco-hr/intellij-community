{
  final Pair<PsiElement,TextRange> data=anchor.getUserData(PyPsiUtils.SELECTION_BREAKS_AST_NODE);
  if (data != null) {
    anchor=data.first;
  }
  final PsiNamedElement parent=PsiTreeUtil.getParentOfType(anchor,PyFile.class,PyFunction.class);
  if (parent instanceof PyFile) {
    final PsiElement statement=PyPsiUtils.getStatement(parent,anchor);
    PyPsiUtils.addBeforeInParent(statement,generatedMethod,createWhiteSpace(anchor.getProject()));
    return;
  }
  if (parent instanceof PyFunction) {
    if (parent.getParent() instanceof PyStatementList) {
      parent.getParent().addBefore(generatedMethod,parent);
      return;
    }
    PyPsiUtils.addBeforeInParent(parent,generatedMethod,createWhiteSpace(anchor.getProject()));
    return;
  }
  throw new IllegalStateException("Compound statement should not be null");
}
