{
  if (!fragment.getOutputVariables().isEmpty() && fragment.isReturnInstructionInside()) {
    CommonRefactoringUtil.showErrorHint(project,editor,"Cannot perform refactoring from expression with local variables modifications and return instructions inside code fragment",RefactoringBundle.message("error.title"),"refactoring.extractMethod");
    return;
  }
  final Pair<String,AbstractVariableData[]> data=getNameAndVariableData(project,fragment,statement1);
  if (data.first == null || data.second == null) {
    return;
  }
  final List<PsiElement> elementsRange=PyPsiUtils.collectElements(statement1,statement2);
  final String methodName=data.first;
  final AbstractVariableData[] variableData=data.second;
  if (fragment.getOutputVariables().isEmpty()) {
    CommandProcessor.getInstance().executeCommand(project,new Runnable(){
      public void run(){
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          public void run(){
            PyFunction generatedMethod=generateMethodFromElements(project,methodName,variableData,elementsRange);
            generatedMethod=insertGeneratedMethod(statement1,generatedMethod);
            final boolean isMethod=PyPsiUtils.isMethodContext(elementsRange.get(0));
            processParameters(project,generatedMethod,variableData,isMethod);
            final StringBuilder builder=new StringBuilder();
            if (fragment.isReturnInstructionInside()) {
              builder.append("return ");
            }
            if (isMethod) {
              builder.append("self.");
            }
            builder.append(methodName);
            builder.append("(").append(createCallArgsString(variableData)).append(")");
            PsiElement callElement=PyElementGenerator.getInstance(project).createFromText(PyCallExpression.class,builder.toString());
            callElement=replaceElements(elementsRange,callElement);
            setSelectionAndCaret(editor,callElement);
          }
        }
);
      }
    }
,"Extract method",null);
  }
 else {
    CommandProcessor.getInstance().executeCommand(project,new Runnable(){
      public void run(){
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          public void run(){
            final StringBuilder builder=new StringBuilder();
            for (            String s : fragment.getOutputVariables()) {
              if (builder.length() != 0) {
                builder.append(", ");
              }
              builder.append(s);
            }
            final List<PsiElement> newMethodElements=new ArrayList<PsiElement>(elementsRange);
            final PsiElement returnStatement=PyElementGenerator.getInstance(project).createFromText(PyElement.class,"return " + builder.toString());
            newMethodElements.add(returnStatement);
            PyFunction generatedMethod=generateMethodFromElements(project,methodName,variableData,newMethodElements);
            generatedMethod=(PyFunction)CodeStyleManager.getInstance(project).reformat(generatedMethod);
            generatedMethod=insertGeneratedMethod(statement1,generatedMethod);
            final boolean isMethod=PyPsiUtils.isMethodContext(elementsRange.get(0));
            processParameters(project,generatedMethod,variableData,isMethod);
            builder.append(" = ");
            if (isMethod) {
              builder.append("self.");
            }
            builder.append(methodName).append("(");
            builder.append(createCallArgsString(variableData)).append(")");
            PsiElement callElement=PyElementGenerator.getInstance(project).createFromText(PyElement.class,builder.toString());
            callElement=replaceElements(elementsRange,callElement);
            setSelectionAndCaret(editor,callElement);
          }
        }
);
      }
    }
,"Extract method",null);
  }
}
