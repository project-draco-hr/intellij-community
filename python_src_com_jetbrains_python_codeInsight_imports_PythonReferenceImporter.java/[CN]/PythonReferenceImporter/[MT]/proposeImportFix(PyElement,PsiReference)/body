{
  final String text=reference.getElement().getText();
  final String refText=reference.getRangeInElement().substring(text);
  final Module module=ModuleUtil.findModuleForPsiElement(node);
  if (module != null && PythonSdkType.findPythonSdk(module) == null) {
    return null;
  }
  ScopeOwner scopeOwner=PsiTreeUtil.getParentOfType(node,ScopeOwner.class);
  if (scopeOwner != null && ControlFlowCache.getScope(scopeOwner).containsDeclaration(refText)) {
    return null;
  }
  AutoImportQuickFix fix=new AutoImportQuickFix(node,reference,!PyCodeInsightSettings.getInstance().PREFER_FROM_IMPORT);
  Set<String> seen_file_names=new HashSet<String>();
  CollectProcessor import_prc=new CollectProcessor(IS_IMPORT_STATEMENT);
  PyResolveUtil.treeCrawlUp(import_prc,node);
  List<PsiElement> result=import_prc.getResult();
  PsiFile existing_import_file=null;
  if (!result.isEmpty()) {
    for (    PsiElement stmt : import_prc.getResult()) {
      for (      PyImportElement ielt : ((PyImportStatement)stmt).getImportElements()) {
        final PyReferenceExpression src=ielt.getImportReferenceExpression();
        if (src != null) {
          PsiElement dst=src.getReference().resolve();
          if (dst instanceof PyFileImpl) {
            PyFileImpl dstFile=(PyFileImpl)dst;
            String name=ielt.getImportReferenceExpression().getReferencedName();
            seen_file_names.add(name);
            PsiElement res=dstFile.findExportedName(refText);
            if (res != null && !(res instanceof PyFile) && !(res instanceof PyImportElement) && dstFile.equals(res.getContainingFile())) {
              existing_import_file=dstFile;
              fix.addImport(res,dstFile,ielt);
            }
          }
        }
      }
    }
  }
  ProgressManager.checkCanceled();
  addSymbolImportCandidates(node,refText,fix,seen_file_names,existing_import_file);
  for (  PyImportCandidateProvider provider : Extensions.getExtensions(PyImportCandidateProvider.EP_NAME)) {
    provider.addImportCandidates(reference,refText,fix);
  }
  if (fix.getCandidatesCount() > 0) {
    fix.sortCandidates();
    return fix;
  }
  return null;
}
