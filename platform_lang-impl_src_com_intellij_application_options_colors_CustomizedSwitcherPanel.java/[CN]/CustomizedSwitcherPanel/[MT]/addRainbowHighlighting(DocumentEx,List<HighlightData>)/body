{
  List<TextAttributesKey> keys=RainbowHighlighter.getRainbowKeys();
  if (!keys.isEmpty()) {
    List<HighlightData> newData=new ArrayList<HighlightData>();
    int i=0;
    HashMap<String,Integer> id2index=new HashMap<String,Integer>();
    for (    HighlightData d : data) {
      if (((RainbowColorSettingsPage)myPage).isRainbowType(d.getHighlightKey())) {
        String id=document.getText(TextRange.create(d.getStartOffset(),d.getEndOffset()));
        Integer index=id2index.get(id);
        if (index == null) {
          index=i++ % keys.size();
          id2index.put(id,index);
        }
        TextAttributesKey type=keys.get(index);
        HighlightData rainbow=new HighlightData(d.getStartOffset(),d.getEndOffset(),type);
        newData.add(rainbow);
        newData.add(d);
        newData.add(rainbow);
      }
 else {
        newData.add(d);
      }
    }
    data.clear();
    data.addAll(newData);
  }
}
