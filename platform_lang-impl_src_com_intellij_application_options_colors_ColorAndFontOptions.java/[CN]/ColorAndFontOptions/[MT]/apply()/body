{
  if (myApplyCompleted) {
    return;
  }
  try {
    EditorColorsManager myColorsManager=EditorColorsManager.getInstance();
    SchemesManager<EditorColorsScheme,EditorColorsSchemeImpl> schemeManager=((EditorColorsManagerImpl)myColorsManager).getSchemeManager();
    List<EditorColorsScheme> result=new ArrayList<>(mySchemes.values().size());
    boolean activeSchemeModified=false;
    EditorColorsScheme activeOriginalScheme=mySelectedScheme.getOriginalScheme();
    for (    MyColorScheme scheme : mySchemes.values()) {
      if (!activeSchemeModified && activeOriginalScheme == scheme.getOriginalScheme()) {
        activeSchemeModified=scheme.isModified();
      }
      if (!scheme.isDefault()) {
        scheme.apply();
      }
      result.add(scheme.getOriginalScheme());
    }
    boolean refreshEditors=activeSchemeModified && schemeManager.getCurrentScheme() == activeOriginalScheme;
    schemeManager.setSchemes(result,activeOriginalScheme);
    if (refreshEditors) {
      EditorColorsManagerImpl.schemeChangedOrSwitched();
    }
    final boolean dark=ColorUtil.isDark(activeOriginalScheme.getDefaultBackground());
    final String productName=ApplicationInfoEx.getInstanceEx().getFullApplicationName();
    final LafManager lafManager=LafManager.getInstance();
    if (dark && !UIUtil.isUnderDarcula()) {
      if (Messages.showYesNoDialog("Looks like you have set a dark editor theme. Would you like to set dark theme for entire " + productName,"Change " + productName + " theme?",Messages.getQuestionIcon()) == Messages.YES) {
        lafManager.setCurrentLookAndFeel(new DarculaLookAndFeelInfo());
        DarculaInstaller.install();
      }
    }
 else     if (!dark && UIUtil.isUnderDarcula()) {
      if (lafManager instanceof LafManagerImpl && Messages.showYesNoDialog("Looks like you have set a bright editor theme. Would you like to set bright theme for entire " + productName,"Change " + productName + " theme",Messages.getQuestionIcon()) == Messages.YES) {
        lafManager.setCurrentLookAndFeel(((LafManagerImpl)lafManager).getDefaultLaf());
        DarculaInstaller.uninstall();
      }
    }
    reset();
  }
  finally {
    myApplyCompleted=true;
  }
}
