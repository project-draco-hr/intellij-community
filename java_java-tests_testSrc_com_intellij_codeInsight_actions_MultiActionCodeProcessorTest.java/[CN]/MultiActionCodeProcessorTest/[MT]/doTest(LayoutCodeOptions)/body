{
  myFixture.configureByFile(getTestDataPath() + getTestName(true) + "_before.java");
  CodeProcessor processor=new CodeProcessor(myFixture.getFile(),myFixture.getEditor(),options);
  if (options.getTextRangeType() == VCS_CHANGED_TEXT) {
    CaretModel model=myFixture.getEditor().getCaretModel();
    List<TextRange> ranges=ContainerUtil.mapNotNull(model.getAllCarets(),new Function<Caret,TextRange>(){
      @Override public TextRange fun(      Caret caret){
        if (caret.hasSelection()) {
          return new TextRange(caret.getSelectionStart(),caret.getSelectionEnd());
        }
        return null;
      }
    }
);
    myFixture.getFile().putUserData(FormatChangedTextUtil.CHANGED_RANGES,ranges);
  }
  processor.processCode();
  myFixture.checkResultByFile(getTestName(true) + "_after.java");
}
