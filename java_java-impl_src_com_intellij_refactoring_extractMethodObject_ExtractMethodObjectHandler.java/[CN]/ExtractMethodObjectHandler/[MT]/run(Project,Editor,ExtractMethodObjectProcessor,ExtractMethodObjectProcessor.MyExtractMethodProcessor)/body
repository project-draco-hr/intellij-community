{
  final RangeMarker marker;
  if (editor != null) {
    final int offset=editor.getCaretModel().getOffset();
    marker=editor.getDocument().createRangeMarker(new TextRange(offset,offset));
  }
 else {
    marker=null;
  }
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    public void run(){
      PostprocessReformattingAspect.getInstance(project).postponeFormattingInside(new Runnable(){
        public void run(){
          try {
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              @Override public void run(){
                extractProcessor.doRefactoring();
              }
            }
);
            processor.run();
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              public void run(){
                processor.runChangeSignature();
              }
            }
);
          }
 catch (          IncorrectOperationException e) {
            LOG.error(e);
          }
          PsiDocumentManager.getInstance(project).commitAllDocuments();
          if (processor.isCreateInnerClass()) {
            processor.moveUsedMethodsToInner();
            PsiDocumentManager.getInstance(project).commitAllDocuments();
            if (editor != null) {
              DuplicatesImpl.processDuplicates(extractProcessor,project,editor);
            }
          }
          ApplicationManager.getApplication().runWriteAction(new Runnable(){
            @Override public void run(){
              if (processor.isCreateInnerClass()) {
                processor.changeInstanceAccess(project);
              }
              final PsiElement method=processor.getMethod();
              LOG.assertTrue(method != null);
              method.delete();
            }
          }
);
        }
      }
);
    }
  }
,ExtractMethodObjectProcessor.REFACTORING_NAME,ExtractMethodObjectProcessor.REFACTORING_NAME);
  if (editor != null) {
    editor.getCaretModel().moveToOffset(marker.getStartOffset());
    marker.dispose();
    editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  }
}
