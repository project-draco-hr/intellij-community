{
  final String active=getActiveToolWindowId();
  appendRequestFocusInEditorComponentCmd(commandList,forced).doWhenDone(new Runnable(){
    @Override public void run(){
      final ArrayList<FinalizableCommand> commandList=new ArrayList<FinalizableCommand>();
      if (LOG.isDebugEnabled()) {
        LOG.debug("editor activated");
      }
      deactivateWindows(null,commandList);
      myActiveStack.clear();
      execute(commandList);
    }
  }
).doWhenRejected(new Runnable(){
    @Override public void run(){
      if (forced) {
        getFocusManagerImpl(myProject).requestFocus(new FocusCommand(){
          @NotNull @Override public ActionCallback run(){
            final ArrayList<FinalizableCommand> commandList=new ArrayList<FinalizableCommand>();
            final WindowInfoImpl toReactivate=getInfo(active);
            final boolean reactivateLastActive=toReactivate != null && !isToHideOnDeactivation(toReactivate);
            deactivateWindows(reactivateLastActive ? active : null,commandList);
            execute(commandList);
            if (reactivateLastActive) {
              activateToolWindow(active,false,true);
            }
 else {
              if (active != null) {
                myActiveStack.remove(active,false);
              }
              if (!myActiveStack.isEmpty()) {
                activateToolWindow(myActiveStack.peek(),false,true);
              }
            }
            return ActionCallback.DONE;
          }
        }
,false);
      }
    }
  }
);
}
