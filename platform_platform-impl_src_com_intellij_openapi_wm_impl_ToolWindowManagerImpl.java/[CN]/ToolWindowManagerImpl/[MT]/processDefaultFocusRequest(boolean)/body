{
  if (ModalityState.NON_MODAL.equals(ModalityState.current())) {
    final String activeId=getActiveToolWindowId();
    if (isEditorComponentActive() || activeId == null || getToolWindow(activeId) == null) {
      activateEditorComponent(forced,true);
    }
 else {
      activateToolWindow(activeId,forced,true);
    }
    return ActionCallback.DONE;
  }
  Window activeWindow=KeyboardFocusManager.getCurrentKeyboardFocusManager().getActiveWindow();
  if (activeWindow != null) {
    JRootPane root=null;
    if (activeWindow instanceof JDialog) {
      root=((JDialog)activeWindow).getRootPane();
    }
 else     if (activeWindow instanceof JFrame) {
      root=((JFrame)activeWindow).getRootPane();
    }
    if (root != null) {
      JComponent toFocus=IdeFocusTraversalPolicy.getPreferredFocusedComponent(root);
      if (toFocus != null) {
        if (DialogWrapper.findInstance(toFocus) != null) {
          return ActionCallback.DONE;
        }
        return IdeFocusManager.findInstanceByComponent(toFocus).requestFocus(toFocus,forced);
      }
    }
  }
  return ActionCallback.REJECTED;
}
