{
  PsiElement element=PsiUtilCore.getElementAtOffset(file,offset);
  ASTNode node=element.getNode();
  if (node != null && node.getElementType() == TokenType.WHITE_SPACE) {
    return CharArrayUtil.shiftForwardUntil(text,offset,"\n");
  }
  for (PsiElement parent=element.getParent(); parent != null; parent=parent.getParent()) {
    ASTNode parentNode=parent.getNode();
    if (parentNode == null || (parentNode.getStartOffset() != offset && parentNode.getStartOffset() != offset - 2)) {
      break;
    }
    element=parent;
  }
  if (element.getTextOffset() != offset && element.getTextOffset() != offset - 2) {
    return CharArrayUtil.shiftForwardUntil(text,offset,"\n");
  }
 else {
    return element.getTextRange().getEndOffset();
  }
}
