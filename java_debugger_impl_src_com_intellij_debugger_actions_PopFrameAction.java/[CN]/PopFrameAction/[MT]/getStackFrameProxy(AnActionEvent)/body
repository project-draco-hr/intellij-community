{
  DebuggerTreeNodeImpl selectedNode=getSelectedNode(e.getDataContext());
  if (selectedNode != null) {
    NodeDescriptorImpl descriptor=selectedNode.getDescriptor();
    if (descriptor instanceof StackFrameDescriptorImpl) {
      if (selectedNode.getNextSibling() != null) {
        StackFrameDescriptorImpl frameDescriptor=((StackFrameDescriptorImpl)descriptor);
        return frameDescriptor.getFrameProxy();
      }
      return null;
    }
 else     if (descriptor instanceof ThreadDescriptorImpl || descriptor instanceof ThreadGroupDescriptorImpl) {
      return null;
    }
  }
  Project project=e.getProject();
  if (project != null) {
    XDebugSession session=XDebuggerManager.getInstance(project).getCurrentSession();
    if (session != null) {
      XStackFrame frame=session.getCurrentStackFrame();
      if (frame instanceof JavaStackFrame) {
        StackFrameProxyImpl proxy=((JavaStackFrame)frame).getStackFrameProxy();
        return !proxy.isBottom() ? proxy : null;
      }
    }
  }
  DebuggerContextImpl debuggerContext=DebuggerAction.getDebuggerContext(e.getDataContext());
  StackFrameProxyImpl frameProxy=debuggerContext.getFrameProxy();
  if (frameProxy == null || frameProxy.isBottom()) {
    return null;
  }
  return frameProxy;
}
