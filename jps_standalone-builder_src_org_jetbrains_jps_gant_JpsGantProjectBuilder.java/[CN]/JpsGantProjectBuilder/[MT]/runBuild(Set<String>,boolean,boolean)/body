{
  if (!myDryRun) {
    myBuildInfoPrinter.printBlockOpenedMessage(this,"compile");
    info("##teamcity[blockOpened name='compile']");
    final AntMessageHandler messageHandler=new AntMessageHandler();
    AntLoggerFactory.ourMessageHandler=new AntMessageHandler();
    AntLoggerFactory.ourFileLoggerFactory=myFileLoggerFactory;
    Logger.setFactory(AntLoggerFactory.class);
    boolean forceBuild=!myBuildIncrementally;
    List<TargetTypeBuildScope> scopes=new ArrayList<TargetTypeBuildScope>();
    for (    JavaModuleBuildTargetType type : JavaModuleBuildTargetType.ALL_TYPES) {
      if (includeTests || !type.isTests()) {
        List<String> namesToCompile=new ArrayList<String>(allModules ? getAllModules() : modulesSet);
        if (type.isTests()) {
          namesToCompile.removeAll(myCompiledModuleTests);
          myCompiledModuleTests.addAll(namesToCompile);
        }
 else {
          namesToCompile.removeAll(myCompiledModules);
          myCompiledModules.addAll(namesToCompile);
        }
        if (namesToCompile.isEmpty())         continue;
        TargetTypeBuildScope.Builder builder=TargetTypeBuildScope.newBuilder().setTypeId(type.getTypeId()).setForceBuild(forceBuild);
        if (allModules) {
          scopes.add(builder.setAllTargets(true).build());
        }
 else         if (!modulesSet.isEmpty()) {
          scopes.add(builder.addAllTargetId(modulesSet).build());
        }
      }
    }
    info("Starting build; incremental: " + myBuildIncrementally + ", cache directory: "+ myDataStorageRoot.getAbsolutePath());
    info("Build scope: " + (allModules ? "all" : modulesSet.size()) + " modules, "+ (includeTests ? "including tests" : "production only"));
    long compilationStart=System.currentTimeMillis();
    try {
      Standalone.runBuild(myModelLoader,myDataStorageRoot,messageHandler,scopes,false);
    }
 catch (    Throwable e) {
      error(e);
    }
    if (messageHandler.myFailed) {
      error("Compilation failed");
    }
 else     if (!myStatisticsReported) {
      myBuildInfoPrinter.printStatisticsMessage(this,"Compilation time, ms",String.valueOf(System.currentTimeMillis() - compilationStart));
      myStatisticsReported=true;
    }
    myBuildInfoPrinter.printBlockClosedMessage(this,"compile");
  }
 else {
    info("Building skipped as we're running dry");
  }
}
