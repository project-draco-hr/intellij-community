{
  Task.Backgroundable task=new Task.Backgroundable(getProject(),"Scanning files to inspect"){
    @Override public void run(    @NotNull ProgressIndicator indicator){
      try {
        final FileIndex fileIndex=ProjectRootManager.getInstance(getProject()).getFileIndex();
        scope.accept(new Processor<VirtualFile>(){
          @Override public boolean process(          final VirtualFile file){
            indicator.checkCanceled();
            if (ProjectCoreUtil.isProjectOrWorkspaceFile(file) || !fileIndex.isInContent(file))             return true;
            PsiFile psiFile=ApplicationManager.getApplication().runReadAction(new Computable<PsiFile>(){
              @Override public PsiFile compute(){
                if (getProject().isDisposed())                 throw new ProcessCanceledException();
                PsiFile psi=PsiManager.getInstance(getProject()).findFile(file);
                Document document=psi == null ? null : shouldProcess(psi,headlessEnvironment,localScopeFiles);
                if (document != null) {
                  return psi;
                }
                return null;
              }
            }
);
            if (psiFile != null) {
              try {
                LOG.assertTrue(!ApplicationManager.getApplication().isReadAccessAllowed());
                outFilesToInspect.put(psiFile);
              }
 catch (              InterruptedException e) {
                LOG.error(e);
              }
            }
            indicator.checkCanceled();
            return true;
          }
        }
);
      }
 catch (      ProcessCanceledException e) {
      }
 finally {
        try {
          outFilesToInspect.put(TOMBSTONE);
        }
 catch (        InterruptedException e) {
          LOG.error(e);
        }
      }
    }
  }
;
  return ((CoreProgressManager)ProgressManager.getInstance()).runProcessWithProgressAsynchronously(task,progressIndicator,null);
}
