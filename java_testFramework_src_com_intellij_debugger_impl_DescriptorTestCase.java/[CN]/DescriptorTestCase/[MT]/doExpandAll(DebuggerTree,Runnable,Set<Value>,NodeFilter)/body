{
  invokeRatherLater(tree.getDebuggerContext().getSuspendContext(),new Runnable(){
    @Override public void run(){
      boolean anyCollapsed=false;
      for (int i=0; i < tree.getRowCount(); i++) {
        final DebuggerTreeNode treeNode=(DebuggerTreeNode)tree.getPathForRow(i).getLastPathComponent();
        if (tree.isCollapsed(i) && !treeNode.isLeaf()) {
          final NodeDescriptor nodeDescriptor=treeNode.getDescriptor();
          boolean shouldExpand=filter == null || filter.shouldExpand(treeNode);
          if (shouldExpand) {
            if (nodeDescriptor instanceof ValueDescriptor) {
              final Value value=((ValueDescriptor)nodeDescriptor).getValue();
              shouldExpand=!alreadyExpanded.contains(value);
              if (shouldExpand) {
                alreadyExpanded.add(value);
              }
            }
          }
          if (shouldExpand) {
            anyCollapsed=true;
            tree.expandRow(i);
          }
        }
      }
      if (anyCollapsed) {
        doExpandAll(tree,runnable,alreadyExpanded,filter);
      }
 else {
        runnable.run();
      }
    }
  }
);
}
