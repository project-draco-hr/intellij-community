{
  ApplicationManager.getApplication().saveAll();
  chanceToFillRoots();
  if (myRoots.length == 0)   return;
  final List<Pair<VcsException,VirtualFile>> exceptions=new LinkedList<Pair<VcsException,VirtualFile>>();
  final SvnVcs vcs=SvnVcs.getInstance(myProject);
  final Task.Backgroundable task=new Task.Backgroundable(myProject,SvnBundle.message(myTitleKey),true){
    public void run(    @NotNull final ProgressIndicator indicator){
      indicator.setIndeterminate(true);
      VirtualFile currentRoot;
      for (      VirtualFile root : myRoots) {
        currentRoot=root;
        try {
          final File path=new File(root.getPath());
          indicator.setText(SvnBundle.message("action.Subversion.cleanup.progress.text",path));
          ProgressTracker handler=new ProgressTracker(){
            @Override public void consume(            ProgressEvent event) throws SVNException {
            }
            @Override public void checkCancelled() throws SVNCancelException {
              if (indicator.isCanceled())               throw new SVNCancelException();
            }
          }
;
          vcs.getFactory(path).createCleanupClient().cleanup(path,handler);
        }
 catch (        VcsException ex) {
          exceptions.add(Pair.create(ex,currentRoot));
        }
      }
    }
    @Override public void onCancel(){
      onSuccess();
    }
    @Override public void onSuccess(){
      if (myProject.isDisposed()) {
        return;
      }
      final VcsDirtyScopeManager manager=VcsDirtyScopeManager.getInstance(myProject);
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          ApplicationManager.getApplication().runWriteAction(new Runnable(){
            public void run(){
              if (myProject.isDisposed()) {
                return;
              }
              for (              final VirtualFile root : myRoots) {
                root.refresh(false,true);
              }
            }
          }
);
        }
      }
);
      for (      final VirtualFile root : myRoots) {
        if (root.isDirectory()) {
          manager.dirDirtyRecursively(root);
        }
 else {
          manager.fileDirty(root);
        }
      }
      if (!exceptions.isEmpty()) {
        final List<VcsException> vcsExceptions=new LinkedList<VcsException>();
        for (        Pair<VcsException,VirtualFile> pair : exceptions) {
          final VcsException exception=pair.first;
          vcsExceptions.add(new VcsException(SvnBundle.message("action.Subversion.cleanup.error.message",FileUtil.toSystemDependentName(pair.second.getPath()),((exception == null) ? "" : exception.getMessage()))));
        }
        final AbstractVcsHelper helper=AbstractVcsHelper.getInstance(myProject);
        helper.showErrors(vcsExceptions,SvnBundle.message(myTitleKey));
      }
    }
  }
;
  ProgressManager.getInstance().run(task);
}
