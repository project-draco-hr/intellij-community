{
  if (myIterator == null) {
    myExpandableIndents=myExpandableIndentsRef.get();
    myIndentAdjuster=myIndentAdjusterRef.get();
    myIterator=myExpandableIndents.keySet().iterator();
  }
  if (!myIterator.hasNext()) {
    setDone(true);
    return;
  }
  final ExpandableIndent indent=myIterator.next();
  Collection<AbstractBlockWrapper> blocksToExpandIndent=myExpandableIndents.get(indent);
  if (shouldExpand(blocksToExpandIndent)) {
    for (    AbstractBlockWrapper block : blocksToExpandIndent) {
      indent.setEnforceIndent(true);
      reindentNewLineChildren(block);
      indent.setEnforceIndent(false);
    }
  }
  restoreAlignments(myBlocksToRealign);
  myBlocksToRealign.clear();
}
