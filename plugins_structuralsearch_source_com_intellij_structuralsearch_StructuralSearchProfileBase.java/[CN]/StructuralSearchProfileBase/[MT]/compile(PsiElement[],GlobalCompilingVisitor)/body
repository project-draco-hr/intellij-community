{
  final PsiElement topElement=elements[0].getParent();
  final PsiElement element=elements.length > 1 ? topElement : elements[0];
  element.accept(new MyCompilingVisitor(globalVisitor,topElement));
  element.accept(new PsiRecursiveElementVisitor(){
    @Override public void visitElement(    PsiElement element){
      super.visitElement(element);
      if (isIgnoredNode(element)) {
        return;
      }
      CompiledPattern pattern=globalVisitor.getContext().getPattern();
      MatchingHandler handler=pattern.getHandler(element);
      if (!(handler instanceof SubstitutionHandler) && !(handler instanceof TopLevelMatchingHandler) && !(handler instanceof LightTopLevelMatchingHandler)) {
        pattern.setHandler(element,new SkippingHandler(handler));
      }
      if (handler instanceof LightTopLevelMatchingHandler) {
        MatchingHandler delegate=((LightTopLevelMatchingHandler)handler).getDelegate();
        if (!(delegate instanceof SubstitutionHandler)) {
          pattern.setHandler(element,new LightTopLevelMatchingHandler(new SkippingHandler(delegate)));
        }
      }
    }
  }
);
  final Language baseLanguage=element.getContainingFile().getLanguage();
  globalVisitor.getContext().getPattern().setStrategy(new MatchingStrategy(){
    @Override public boolean continueMatching(    PsiElement start){
      Language language=start.getLanguage();
      PsiFile file=start.getContainingFile();
      if (file != null) {
        Language fileLanguage=file.getLanguage();
        if (fileLanguage.isKindOf(language)) {
          language=fileLanguage;
        }
      }
      return language == baseLanguage;
    }
    @Override public boolean shouldSkip(    PsiElement element,    PsiElement elementToMatchWith){
      return StructuralSearchProfileBase.shouldSkip(element,elementToMatchWith);
    }
  }
);
}
