{
  final AsyncResult<String> result=new AsyncResult<String>();
  final Disposable connection=Disposer.newDisposable();
  result.doWhenProcessed(new Runnable(){
    @Override public void run(){
      Disposer.dispose(connection);
    }
  }
);
  WindowSystemPlaybackCall.findProject().doWhenDone(new Consumer<Project>(){
    @Override public void consume(    Project project){
      final MessageBusConnection bus=project.getMessageBus().connect(connection);
      bus.subscribe(DaemonCodeAnalyzer.DAEMON_EVENT_TOPIC,new DaemonCodeAnalyzer.DaemonListenerAdapter(){
        @Override public void daemonFinished(){
          context.flushAwtAndRunInEdt(result.createSetDoneRunnable());
        }
        @Override public void daemonCancelEventOccurred(        @NotNull String reason){
          result.setDone();
        }
      }
);
    }
  }
).doWhenRejected(new Runnable(){
    @Override public void run(){
      result.setRejected("Cannot find project");
    }
  }
);
  return result;
}
