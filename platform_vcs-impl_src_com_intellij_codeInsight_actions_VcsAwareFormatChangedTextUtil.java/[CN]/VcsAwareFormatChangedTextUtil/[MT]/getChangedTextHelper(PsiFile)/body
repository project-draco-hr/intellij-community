{
  Project project=file.getProject();
  Document document=PsiDocumentManager.getInstance(project).getDocument(file);
  if (document == null)   return null;
  FormatRangesInfo cachedChangedTextHelper=getCachedChangedLines(project,document);
  if (cachedChangedTextHelper != null) {
    return cachedChangedTextHelper;
  }
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    CharSequence testContent=file.getUserData(TEST_REVISION_CONTENT);
    if (testContent != null) {
      return calculateContextReformatHelper(document,testContent);
    }
  }
  Change change=ChangeListManager.getInstance(project).getChange(file.getVirtualFile());
  if (change == null) {
    return null;
  }
  if (change.getType() == Change.Type.NEW) {
    return new VcsAwareFormatRangesInfo(file.getTextRange());
  }
  String contentFromVcs=getRevisionedContentFrom(change);
  return contentFromVcs != null ? calculateContextReformatHelper(document,contentFromVcs) : null;
}
