{
  if (atCaret == null) {
    return;
  }
  PsiElement parent=atCaret.getParent();
  if (parent instanceof PsiCodeBlock) {
    final PsiCodeBlock block=(PsiCodeBlock)parent;
    if (block.getStatements().length > 0 && block.getStatements()[0] == atCaret) {
      atCaret=block;
    }
  }
 else   if (parent instanceof PsiForStatement) {
    atCaret=parent;
  }
  if (parent instanceof PsiIfStatement && atCaret == ((PsiIfStatement)parent).getElseBranch()) {
    PsiFile file=atCaret.getContainingFile();
    Document document=file.getViewProvider().getDocument();
    if (document != null) {
      TextRange elseIfRange=atCaret.getTextRange();
      int lineStart=document.getLineStartOffset(document.getLineNumber(elseIfRange.getStartOffset()));
      CodeStyleManager.getInstance(atCaret.getProject()).reformatText(file,lineStart,elseIfRange.getEndOffset());
      return;
    }
  }
  super.reformat(atCaret);
}
