{
  EduDocumentListener listener=new EduDocumentListener(taskFile,false);
  document.addDocumentListener(listener);
  taskFile.sortAnswerPlaceholders();
  for (int i=taskFile.getAnswerPlaceholders().size() - 1; i >= 0; i--) {
    final AnswerPlaceholder answerPlaceholder=taskFile.getAnswerPlaceholders().get(i);
    if (answerPlaceholder.getRealStartOffset(document) > document.getTextLength() || answerPlaceholder.getRealStartOffset(document) + answerPlaceholder.getPossibleAnswerLength() > document.getTextLength()) {
      LOG.error("Wrong startOffset: " + answerPlaceholder.getRealStartOffset(document) + "; document: "+ file.getPath());
      return;
    }
    replaceAnswerPlaceholder(project,document,answerPlaceholder);
  }
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          FileDocumentManager.getInstance().saveDocument(document);
        }
      }
);
    }
  }
,"Create Student File","Create Student File");
  document.removeDocumentListener(listener);
}
