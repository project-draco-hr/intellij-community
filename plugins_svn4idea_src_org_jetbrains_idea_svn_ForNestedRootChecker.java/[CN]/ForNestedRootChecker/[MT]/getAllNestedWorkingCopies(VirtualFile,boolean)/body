{
  final LinkedList<Node> workItems=new LinkedList<Node>();
  final LinkedList<Node> result=new LinkedList<Node>();
  workItems.add(new Node(root));
  while (!workItems.isEmpty()) {
    final Node item=workItems.removeFirst();
    checkCancelled();
    final Node vcsElement=resolveVcsElement(item.getFile());
    if (vcsElement != null && (!item.inVcs() || !item.sameVcsItem(vcsElement))) {
      result.add(vcsElement);
      if (!goIntoNested) {
        continue;
      }
    }
    final VirtualFile file=item.getFile();
    if (file.isDirectory() && (!SvnUtil.isAdminDirectory(file))) {
      for (      VirtualFile child : file.getChildren()) {
        checkCancelled();
        if (myRootIterator.acceptFolderUnderVcs(root,child)) {
          workItems.add(vcsElement == null ? new Node(child) : vcsElement.append(child));
        }
      }
    }
  }
  return result;
}
