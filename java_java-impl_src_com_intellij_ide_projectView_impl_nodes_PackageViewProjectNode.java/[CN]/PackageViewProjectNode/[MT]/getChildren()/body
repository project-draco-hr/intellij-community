{
  if (getSettings().isShowModules()) {
    final List<Module> allModules=new ArrayList<>(Arrays.asList(ModuleManager.getInstance(getProject()).getModules()));
    for (Iterator<Module> it=allModules.iterator(); it.hasNext(); ) {
      final Module module=it.next();
      final VirtualFile[] sourceRoots=ModuleRootManager.getInstance(module).getSourceRoots();
      if (sourceRoots.length == 0) {
        it.remove();
      }
    }
    return modulesAndGroups(allModules.toArray(new Module[allModules.size()]));
  }
 else {
    final ProjectRootManager projectRootManager=ProjectRootManager.getInstance(myProject);
    final PsiManager psiManager=PsiManager.getInstance(myProject);
    final List<AbstractTreeNode> children=new ArrayList<>();
    final Set<PsiPackage> topLevelPackages=new HashSet<>();
    for (    final VirtualFile root : projectRootManager.getContentSourceRoots()) {
      final PsiDirectory directory=psiManager.findDirectory(root);
      if (directory == null) {
        continue;
      }
      final PsiPackage directoryPackage=JavaDirectoryService.getInstance().getPackage(directory);
      if (directoryPackage == null || PackageUtil.isPackageDefault(directoryPackage)) {
        final PsiDirectory[] subdirectories=directory.getSubdirectories();
        for (        PsiDirectory subdirectory : subdirectories) {
          final PsiPackage aPackage=JavaDirectoryService.getInstance().getPackage(subdirectory);
          if (aPackage != null && !PackageUtil.isPackageDefault(aPackage)) {
            topLevelPackages.add(aPackage);
          }
        }
        children.addAll(ProjectViewDirectoryHelper.getInstance(myProject).getDirectoryChildren(directory,getSettings(),false));
      }
 else {
        topLevelPackages.add(directoryPackage);
      }
    }
    for (    final PsiPackage psiPackage : topLevelPackages) {
      PackageUtil.addPackageAsChild(children,psiPackage,null,getSettings(),false);
    }
    if (getSettings().isShowLibraryContents()) {
      children.add(new PackageViewLibrariesNode(getProject(),null,getSettings()));
    }
    return children;
  }
}
