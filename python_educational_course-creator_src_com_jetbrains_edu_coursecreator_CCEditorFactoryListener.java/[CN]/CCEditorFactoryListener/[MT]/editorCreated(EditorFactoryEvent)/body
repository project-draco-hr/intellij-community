{
  Editor editor=event.getEditor();
  Project project=editor.getProject();
  if (project == null) {
    return;
  }
  VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(editor.getDocument());
  if (virtualFile == null) {
    return;
  }
  Course course=CCProjectService.getInstance(project).getCourse();
  if (course == null) {
    return;
  }
  final VirtualFile taskDir=virtualFile.getParent();
  if (taskDir == null || !taskDir.getName().contains("task")) {
    return;
  }
  final VirtualFile lessonDir=taskDir.getParent();
  if (lessonDir == null)   return;
  final Lesson lesson=course.getLesson(lessonDir.getName());
  final Task task=lesson.getTask(taskDir.getName());
  final TaskFile taskFile=task.getTaskFile(virtualFile.getName());
  if (taskFile == null) {
    return;
  }
  TaskFileModificationListener listener=new TaskFileModificationListener(taskFile);
  CCProjectService.addDocumentListener(editor.getDocument(),listener);
  editor.getDocument().addDocumentListener(listener);
  EditorActionManager.getInstance().setReadonlyFragmentModificationHandler(editor.getDocument(),new TaskWindowDeleteHandler(editor));
  CCProjectService.getInstance(project).drawTaskWindows(virtualFile,editor);
  editor.getColorsScheme().setColor(EditorColors.READONLY_FRAGMENT_BACKGROUND_COLOR,null);
  taskFile.createGuardedBlocks(editor);
}
