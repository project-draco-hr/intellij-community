{
  final Application application=ApplicationManager.getApplication();
  IS_UNIT_TEST_MODE=application.isUnitTestMode();
  myProjectManager=projectManager;
  final String systemPath=PathManager.getSystemPath();
  File system=new File(systemPath);
  try {
    system=system.getCanonicalFile();
  }
 catch (  IOException e) {
    LOG.info(e);
  }
  mySystemDirectory=system;
  projectManager.addProjectManagerListener(new ProjectWatcher());
  final MessageBusConnection conn=application.getMessageBus().connect();
  conn.subscribe(VirtualFileManager.VFS_CHANGES,new BulkFileListener.Adapter(){
    @Override public void after(    @NotNull List<? extends VFileEvent> events){
      if (shouldTriggerMake(events)) {
        scheduleAutoMake();
      }
    }
    private boolean shouldTriggerMake(    List<? extends VFileEvent> events){
      if (PowerSaveMode.isEnabled()) {
        return false;
      }
      Project project=null;
      ProjectFileIndex fileIndex=null;
      for (      VFileEvent event : events) {
        final VirtualFile eventFile=event.getFile();
        if (eventFile == null) {
          continue;
        }
        if (!eventFile.isValid()) {
          return true;
        }
        if (project == null) {
          project=getCurrentContextProject();
          if (project == null) {
            return false;
          }
          fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
        }
        if (fileIndex.isInContent(eventFile)) {
          if (ProjectCoreUtil.isProjectOrWorkspaceFile(eventFile)) {
            continue;
          }
          return true;
        }
      }
      return false;
    }
  }
);
  conn.subscribe(BatchFileChangeListener.TOPIC,new BatchFileChangeListener.Adapter(){
    public void batchChangeStarted(    Project project){
      cancelAutoMakeTasks(project);
    }
  }
);
  EditorFactory.getInstance().getEventMulticaster().addDocumentListener(new DocumentAdapter(){
    @Override public void documentChanged(    DocumentEvent e){
      scheduleProjectSave();
    }
  }
);
  ShutDownTracker.getInstance().registerShutdownTask(new Runnable(){
    @Override public void run(){
      stopListening();
    }
  }
);
  JobScheduler.getScheduler().scheduleAtFixedRate(new Runnable(){
    @Override public void run(){
      runCommand(myGCTask);
    }
  }
,3,180,TimeUnit.MINUTES);
}
