{
  final List<Project> openProjects=getOpenProjects();
  if (openProjects.isEmpty()) {
    return null;
  }
  if (openProjects.size() == 1) {
    return openProjects.get(0);
  }
  if (window == null) {
    window=KeyboardFocusManager.getCurrentKeyboardFocusManager().getActiveWindow();
    if (window == null) {
      return null;
    }
  }
  Component comp=window;
  while (true) {
    final Container _parent=comp.getParent();
    if (_parent == null) {
      break;
    }
    comp=_parent;
  }
  Project project=null;
  if (comp instanceof IdeFrame) {
    project=((IdeFrame)comp).getProject();
  }
  if (project == null) {
    project=CommonDataKeys.PROJECT.getData(DataManager.getInstance().getDataContext(comp));
  }
  return isValidProject(project) ? project : null;
}
