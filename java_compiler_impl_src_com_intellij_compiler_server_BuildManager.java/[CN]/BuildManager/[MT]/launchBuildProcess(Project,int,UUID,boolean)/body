{
  final String compilerPath;
  final String vmExecutablePath;
  JavaSdkVersion sdkVersion=null;
  final String forcedCompiledJdkHome=Registry.stringValue(COMPILER_PROCESS_JDK_PROPERTY);
  if (StringUtil.isEmptyOrSpaces(forcedCompiledJdkHome)) {
    final Pair<Sdk,JavaSdkVersion> pair=getBuildProcessRuntimeSdk(project);
    final Sdk projectJdk=pair.first;
    sdkVersion=pair.second;
    final Sdk internalJdk=JavaAwareProjectJdkTableImpl.getInstanceEx().getInternalJdk();
    final JavaSdkType projectJdkType=(JavaSdkType)projectJdk.getSdkType();
    if (FileUtil.pathsEqual(projectJdk.getHomePath(),internalJdk.getHomePath())) {
      final JavaCompiler systemCompiler=ToolProvider.getSystemJavaCompiler();
      if (systemCompiler == null) {
        throw new ExecutionException("No system java compiler is provided by the JRE. Make sure tools.jar is present in IntelliJ IDEA classpath.");
      }
      compilerPath=ClasspathBootstrap.getResourcePath(systemCompiler.getClass());
    }
 else {
      compilerPath=projectJdkType.getToolsPath(projectJdk);
      if (compilerPath == null) {
        throw new ExecutionException("Cannot determine path to 'tools.jar' library for " + projectJdk.getName() + " ("+ projectJdk.getHomePath()+ ")");
      }
    }
    vmExecutablePath=projectJdkType.getVMExecutablePath(projectJdk);
  }
 else {
    compilerPath=new File(forcedCompiledJdkHome,"lib/tools.jar").getAbsolutePath();
    vmExecutablePath=new File(forcedCompiledJdkHome,"bin/java").getAbsolutePath();
  }
  final CompilerConfiguration projectConfig=CompilerConfiguration.getInstance(project);
  final CompilerWorkspaceConfiguration config=CompilerWorkspaceConfiguration.getInstance(project);
  final GeneralCommandLine cmdLine=new GeneralCommandLine();
  cmdLine.setExePath(vmExecutablePath);
  boolean isProfilingMode=false;
  String userDefinedHeapSize=null;
  final List<String> userAdditionalOptionsList=new SmartList<String>();
  final String userAdditionalVMOptions=config.COMPILER_PROCESS_ADDITIONAL_VM_OPTIONS;
  final boolean userLocalOptionsActive=!StringUtil.isEmptyOrSpaces(userAdditionalVMOptions);
  final String additionalOptions=userLocalOptionsActive ? userAdditionalVMOptions : projectConfig.getBuildProcessVMOptions();
  if (!StringUtil.isEmptyOrSpaces(additionalOptions)) {
    final StringTokenizer tokenizer=new StringTokenizer(additionalOptions," ",false);
    while (tokenizer.hasMoreTokens()) {
      final String option=tokenizer.nextToken();
      if (StringUtil.startsWithIgnoreCase(option,"-Xmx")) {
        if (userLocalOptionsActive) {
          userDefinedHeapSize=option;
        }
      }
 else {
        if ("-Dprofiling.mode=true".equals(option)) {
          isProfilingMode=true;
        }
        userAdditionalOptionsList.add(option);
      }
    }
  }
  if (userDefinedHeapSize != null) {
    cmdLine.addParameter(userDefinedHeapSize);
  }
 else {
    final int heapSize=projectConfig.getBuildProcessHeapSize(JavacConfiguration.getOptions(project,JavacConfiguration.class).MAXIMUM_HEAP_SIZE);
    cmdLine.addParameter("-Xmx" + heapSize + "m");
  }
  if (SystemInfo.isMac && sdkVersion != null && JavaSdkVersion.JDK_1_6.equals(sdkVersion) && Registry.is("compiler.process.32bit.vm.on.mac")) {
    cmdLine.addParameter("-d32");
  }
  cmdLine.addParameter("-Djava.awt.headless=true");
  if (sdkVersion != null && sdkVersion.ordinal() < JavaSdkVersion.JDK_1_9.ordinal()) {
    cmdLine.addParameter("-Djava.endorsed.dirs=\"\"");
  }
  if (IS_UNIT_TEST_MODE) {
    cmdLine.addParameter("-Dtest.mode=true");
  }
  cmdLine.addParameter("-Djdt.compiler.useSingleThread=true");
  if (requestProjectPreload) {
    cmdLine.addParameter("-Dpreload.project.path=" + FileUtil.toCanonicalPath(getProjectPath(project)));
    cmdLine.addParameter("-Dpreload.config.path=" + FileUtil.toCanonicalPath(PathManager.getOptionsPath()));
  }
  final String shouldGenerateIndex=System.getProperty(GlobalOptions.GENERATE_CLASSPATH_INDEX_OPTION);
  if (shouldGenerateIndex != null) {
    cmdLine.addParameter("-D" + GlobalOptions.GENERATE_CLASSPATH_INDEX_OPTION + "="+ shouldGenerateIndex);
  }
  cmdLine.addParameter("-D" + GlobalOptions.COMPILE_PARALLEL_OPTION + "="+ Boolean.toString(config.PARALLEL_COMPILATION));
  cmdLine.addParameter("-D" + GlobalOptions.REBUILD_ON_DEPENDENCY_CHANGE_OPTION + "="+ Boolean.toString(config.REBUILD_ON_DEPENDENCY_CHANGE));
  if (Boolean.TRUE.equals(Boolean.valueOf(System.getProperty("java.net.preferIPv4Stack","false")))) {
    cmdLine.addParameter("-Djava.net.preferIPv4Stack=true");
  }
  cmdLine.addParameter("-Dio.netty.initialSeedUniquifier=" + ThreadLocalRandom.getInitialSeedUniquifier());
  for (  String option : userAdditionalOptionsList) {
    cmdLine.addParameter(option);
  }
  if (isProfilingMode) {
    cmdLine.addParameter("-agentlib:yjpagent=disablealloc,delay=10000,sessionname=ExternalBuild");
  }
  int debugPort=-1;
  if (myBuildProcessDebuggingEnabled) {
    debugPort=Registry.intValue("compiler.process.debug.port");
    if (debugPort <= 0) {
      try {
        debugPort=NetUtils.findAvailableSocketPort();
      }
 catch (      IOException e) {
        throw new ExecutionException("Cannot find free port to debug build process",e);
      }
    }
    if (debugPort > 0) {
      cmdLine.addParameter("-XX:+HeapDumpOnOutOfMemoryError");
      cmdLine.addParameter("-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=" + debugPort);
    }
  }
  if (!Registry.is("compiler.process.use.memory.temp.cache")) {
    cmdLine.addParameter("-D" + GlobalOptions.USE_MEMORY_TEMP_CACHE_OPTION + "=false");
  }
  cmdLine.setCharset(mySystemCharset);
  cmdLine.addParameter("-D" + CharsetToolkit.FILE_ENCODING_PROPERTY + "="+ mySystemCharset.name());
  cmdLine.addParameter("-D" + JpsGlobalLoader.FILE_TYPES_COMPONENT_NAME_KEY + "="+ FileTypeManagerImpl.getFileTypeComponentName());
  String[] propertiesToPass={"user.language","user.country","user.region",PathManager.PROPERTY_PATHS_SELECTOR,"idea.case.sensitive.fs"};
  for (  String name : propertiesToPass) {
    final String value=System.getProperty(name);
    if (value != null) {
      cmdLine.addParameter("-D" + name + "="+ value);
    }
  }
  cmdLine.addParameter("-D" + PathManager.PROPERTY_HOME_PATH + "="+ PathManager.getHomePath());
  cmdLine.addParameter("-D" + PathManager.PROPERTY_CONFIG_PATH + "="+ PathManager.getConfigPath());
  cmdLine.addParameter("-D" + PathManager.PROPERTY_PLUGINS_PATH + "="+ PathManager.getPluginsPath());
  cmdLine.addParameter("-D" + GlobalOptions.LOG_DIR_OPTION + "="+ FileUtil.toSystemIndependentName(getBuildLogDirectory().getAbsolutePath()));
  final File workDirectory=getBuildSystemDirectory();
  workDirectory.mkdirs();
  cmdLine.addParameter("-Djava.io.tmpdir=" + FileUtil.toSystemIndependentName(workDirectory.getPath()) + "/"+ TEMP_DIR_NAME);
  for (  BuildProcessParametersProvider provider : project.getExtensions(BuildProcessParametersProvider.EP_NAME)) {
    final List<String> args=provider.getVMArguments();
    cmdLine.addParameters(args);
  }
  if (!cmdLine.getParametersList().hasProperty(JAVA_EXT_DIRS_PROPERTY)) {
    cmdLine.getParametersList().addProperty(JAVA_EXT_DIRS_PROPERTY,"\"\"");
  }
  @SuppressWarnings("UnnecessaryFullyQualifiedName") final Class<?> launcherClass=org.jetbrains.jps.cmdline.Launcher.class;
  final List<String> launcherCp=new ArrayList<String>();
  launcherCp.add(ClasspathBootstrap.getResourcePath(launcherClass));
  launcherCp.add(compilerPath);
  ClasspathBootstrap.appendJavaCompilerClasspath(launcherCp);
  launcherCp.addAll(BuildProcessClasspathManager.getLauncherClasspath(project));
  cmdLine.addParameter("-classpath");
  cmdLine.addParameter(classpathToString(launcherCp));
  cmdLine.addParameter(launcherClass.getName());
  final List<String> cp=ClasspathBootstrap.getBuildProcessApplicationClasspath(true);
  cp.addAll(myClasspathManager.getBuildProcessPluginsClasspath(project));
  if (isProfilingMode) {
    cp.add(new File(workDirectory,"yjp-controller-api-redist.jar").getPath());
  }
  cmdLine.addParameter(classpathToString(cp));
  cmdLine.addParameter(BuildMain.class.getName());
  cmdLine.addParameter(Boolean.valueOf(System.getProperty("java.net.preferIPv6Addresses","false")) ? "::1" : "127.0.0.1");
  cmdLine.addParameter(Integer.toString(port));
  cmdLine.addParameter(sessionId.toString());
  cmdLine.addParameter(FileUtil.toSystemIndependentName(workDirectory.getPath()));
  cmdLine.setWorkDirectory(workDirectory);
  try {
    ApplicationManager.getApplication().getMessageBus().syncPublisher(BuildManagerListener.TOPIC).beforeBuildProcessStarted(project,sessionId);
  }
 catch (  Throwable e) {
    LOG.error(e);
  }
  final Process process=cmdLine.createProcess();
  final OSProcessHandler processHandler=new OSProcessHandler(process,null,mySystemCharset,BuildMain.class.getName() + " external process"){
    @Override protected boolean shouldDestroyProcessRecursively(){
      return true;
    }
    @Override protected boolean useNonBlockingRead(){
      return false;
    }
  }
;
  processHandler.addProcessListener(new ProcessAdapter(){
    @Override public void onTextAvailable(    ProcessEvent event,    Key outputType){
      final String text=event.getText();
      if (!StringUtil.isEmptyOrSpaces(text)) {
        LOG.info("BUILDER_PROCESS [" + outputType.toString() + "]: "+ text.trim());
      }
    }
  }
);
  if (debugPort > 0) {
    processHandler.putUserData(COMPILER_PROCESS_DEBUG_PORT,debugPort);
  }
  return processHandler;
}
