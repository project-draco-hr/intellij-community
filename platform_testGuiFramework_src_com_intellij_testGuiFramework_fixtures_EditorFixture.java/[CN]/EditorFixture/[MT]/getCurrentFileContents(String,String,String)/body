{
  return execute(new GuiQuery<String>(){
    @Override @Nullable protected String executeInEDT() throws Throwable {
      FileEditorManager manager=FileEditorManager.getInstance(myFrame.getProject());
      Editor editor=manager.getSelectedTextEditor();
      if (editor != null) {
        CaretModel caretModel=editor.getCaretModel();
        Caret primaryCaret=caretModel.getPrimaryCaret();
        int offset=primaryCaret.getOffset();
        int start=primaryCaret.getSelectionStart();
        int end=primaryCaret.getSelectionEnd();
        if (start == end) {
          start=-1;
          end=-1;
        }
        Document document=editor.getDocument();
        int lineStart=0;
        int lineEnd=document.getTextLength();
        String text=document.getText(new TextRange(lineStart,lineEnd));
        StringBuilder sb=new StringBuilder(text.length() + 10);
        for (int i=0, n=text.length(); i < n; i++) {
          if (selectBegin != null && start == i) {
            sb.append(selectBegin);
          }
          if (caret != null && offset == i) {
            sb.append(caret);
          }
          sb.append(text.charAt(i));
          if (selectEnd != null && end == i + 1) {
            sb.append(selectEnd);
          }
        }
        return sb.toString();
      }
      return null;
    }
  }
);
}
