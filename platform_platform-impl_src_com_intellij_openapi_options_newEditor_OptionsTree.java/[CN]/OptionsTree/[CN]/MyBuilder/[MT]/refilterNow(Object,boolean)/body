{
  final List<Object> toRestore=new ArrayList<Object>();
  if (myFilter.myContext.isHoldingFilter() && !myWasHoldingFilter && myToExpandOnResetFilter == null) {
    myToExpandOnResetFilter=myBuilder.getUi().getExpandedElements();
  }
 else   if (!myFilter.myContext.isHoldingFilter() && myWasHoldingFilter && myToExpandOnResetFilter != null) {
    toRestore.addAll(myToExpandOnResetFilter);
    myToExpandOnResetFilter=null;
  }
  myWasHoldingFilter=myFilter.myContext.isHoldingFilter();
  ActionCallback result=super.refilterNow(preferredSelection,adjustSelection);
  myRefilteringNow=true;
  return result.doWhenDone(new Runnable(){
    public void run(){
      myRefilteringNow=false;
      if (!myFilter.myContext.isHoldingFilter() && getSelectedElements().isEmpty()) {
        restoreExpandedState(toRestore);
      }
    }
  }
);
}
