{
  if (myMarkers.isEmpty())   return;
  myState=State.APPLYING;
  final Document document=myEditor.getDocument();
  final Runnable apply=new Runnable(){
    @Override public void run(){
      for (      Couple<RangeMarker> couple : myMarkers) {
        final RangeMarker leader=couple.first;
        final RangeMarker support=couple.second;
        final String name=document.getText(new TextRange(leader.getStartOffset(),leader.getEndOffset()));
        document.replaceString(support.getStartOffset(),support.getEndOffset(),name);
      }
    }
  }
;
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      final LookupImpl lookup=(LookupImpl)LookupManager.getActiveLookup(myEditor);
      if (lookup != null) {
        lookup.performGuardedChange(apply);
      }
 else {
        apply.run();
      }
    }
  }
);
  myState=State.TRACKING;
}
