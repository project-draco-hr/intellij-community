{
  final DataContext dataContext=e.getDataContext();
  final Project project=CommonDataKeys.PROJECT.getData(dataContext);
  if (project == null) {
    return null;
  }
  VirtualFile file=e.getData(CommonDataKeys.VIRTUAL_FILE);
  HgRepositoryManager repositoryManager=HgUtil.getRepositoryManager(project);
  return file != null ? repositoryManager.getRepositoryForFile(file) : HgUtil.getCurrentRepository(project);
}
