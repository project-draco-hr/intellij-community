{
  final Ref<TextRange> currentRange=Ref.create(null);
  PsiDocumentManager.getInstance(project).commitAndRunReadAction(new Runnable(){
    @Override public void run(){
      try {
        PsiElement elementAtCursor=DebuggerUtilsEx.findElementAt(PsiDocumentManager.getInstance(project).getPsiFile(document),offset);
        if (elementAtCursor == null) {
          return;
        }
        Pair<PsiElement,TextRange> pair=findExpression(elementAtCursor,sideEffectsAllowed);
        if (pair != null) {
          currentRange.set(pair.getSecond());
        }
      }
 catch (      IndexNotReadyException ignored) {
      }
    }
  }
);
  return currentRange.get();
}
