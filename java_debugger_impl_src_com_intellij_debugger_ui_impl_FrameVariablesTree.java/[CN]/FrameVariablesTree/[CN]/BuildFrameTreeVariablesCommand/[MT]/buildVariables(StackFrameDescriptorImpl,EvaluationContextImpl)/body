{
  final DebuggerContextImpl debuggerContext=getDebuggerContext();
  final SourcePosition sourcePosition=debuggerContext.getSourcePosition();
  if (sourcePosition == null) {
    return;
  }
  try {
    if (!XDebuggerSettingsManager.getInstance().getDataViewSettings().isAutoExpressions() && !myAutoWatchMode) {
      super.buildVariables(stackDescriptor,evaluationContext);
    }
 else {
      final Map<String,LocalVariableProxyImpl> visibleVariables=getVisibleVariables(stackDescriptor.getFrameProxy());
      final EvaluationContextImpl evalContext=debuggerContext.createEvaluationContext();
      final Pair<Set<String>,Set<TextWithImports>> usedVars=ApplicationManager.getApplication().runReadAction(new Computable<Pair<Set<String>,Set<TextWithImports>>>(){
        @Override public Pair<Set<String>,Set<TextWithImports>> compute(){
          return findReferencedVars(visibleVariables.keySet(),sourcePosition,evalContext);
        }
      }
);
      if (myAutoWatchMode) {
        for (        String var : usedVars.first) {
          final LocalVariableDescriptorImpl descriptor=myNodeManager.getLocalVariableDescriptor(stackDescriptor,visibleVariables.get(var));
          myChildren.add(myNodeManager.createNode(descriptor,evaluationContext));
        }
      }
 else {
        super.buildVariables(stackDescriptor,evaluationContext);
      }
      final EvaluationContextImpl evalContextCopy=evaluationContext.createEvaluationContext(evaluationContext.getThisObject());
      evalContextCopy.setAutoLoadClasses(false);
      for (      TextWithImports text : usedVars.second) {
        myChildren.add(myNodeManager.createNode(myNodeManager.getWatchItemDescriptor(stackDescriptor,text,null),evalContextCopy));
      }
    }
  }
 catch (  EvaluateException e) {
    if (e.getCause() instanceof AbsentInformationException) {
      final StackFrameProxyImpl frame=stackDescriptor.getFrameProxy();
      final Collection<Value> argValues=frame.getArgumentValues();
      int index=0;
      for (      Value argValue : argValues) {
        final ArgumentValueDescriptorImpl descriptor=myNodeManager.getArgumentValueDescriptor(stackDescriptor,index++,argValue,false);
        final DebuggerTreeNodeImpl variableNode=myNodeManager.createNode(descriptor,evaluationContext);
        myChildren.add(variableNode);
      }
      myChildren.add(myNodeManager.createMessageNode(MessageDescriptor.LOCAL_VARIABLES_INFO_UNAVAILABLE));
      try {
        Map<DecompiledLocalVariable,Value> values=LocalVariablesUtil.fetchValues(frame);
        for (        Map.Entry<DecompiledLocalVariable,Value> entry : values.entrySet()) {
          DecompiledLocalVariable var=entry.getKey();
          final ArgumentValueDescriptorImpl descriptor=myNodeManager.getArgumentValueDescriptor(stackDescriptor,var.getSlot(),entry.getValue(),var.isParam());
          final DebuggerTreeNodeImpl variableNode=myNodeManager.createNode(descriptor,evaluationContext);
          myChildren.add(variableNode);
        }
      }
 catch (      Exception ex) {
        LOG.info(ex);
      }
    }
 else {
      throw e;
    }
  }
}
