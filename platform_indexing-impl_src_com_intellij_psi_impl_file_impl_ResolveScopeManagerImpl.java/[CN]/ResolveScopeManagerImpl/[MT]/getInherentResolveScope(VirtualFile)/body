{
  ProjectFileIndex projectFileIndex=myProjectRootManager.getFileIndex();
  Module module=projectFileIndex.getModuleForFile(vFile);
  if (module != null) {
    boolean includeTests=TestSourcesFilter.isTestSources(vFile,myProject);
    return GlobalSearchScope.moduleWithDependenciesAndLibrariesScope(module,includeTests);
  }
  if (!projectFileIndex.isInLibrarySource(vFile) && !projectFileIndex.isInLibraryClasses(vFile)) {
    GlobalSearchScope allScope=GlobalSearchScope.allScope(myProject);
    if (!allScope.contains(vFile)) {
      return GlobalSearchScope.fileScope(myProject,vFile).uniteWith(allScope);
    }
    return allScope;
  }
  return LibraryScopeCache.getInstance(myProject).getLibraryScope(projectFileIndex.getOrderEntriesForFile(vFile));
}
