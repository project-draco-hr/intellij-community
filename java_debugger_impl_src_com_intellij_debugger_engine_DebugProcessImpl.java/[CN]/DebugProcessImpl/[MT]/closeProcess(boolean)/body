{
  DebuggerManagerThreadImpl.assertIsManagerThread();
  if (myState.compareAndSet(State.INITIAL,State.DETACHING) || myState.compareAndSet(State.ATTACHED,State.DETACHING)) {
    try {
      getManagerThread().close();
    }
  finally {
      final VirtualMachineProxyImpl vm=myVirtualMachineProxy;
      myVirtualMachineProxy=null;
      myPositionManager=null;
      myReturnValueWatcher=null;
      myNodeRenderersMap.clear();
      myRenderers.clear();
      DebuggerUtils.cleanupAfterProcessFinish(this);
      myState.compareAndSet(State.DETACHING,State.DETACHED);
      try {
        myDebugProcessDispatcher.getMulticaster().processDetached(this,closedByUser);
      }
  finally {
        if (vm != null) {
          try {
            vm.dispose();
          }
 catch (          Throwable ignored) {
          }
        }
        myWaitFor.up();
      }
    }
  }
}
