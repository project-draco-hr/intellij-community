{
  final MatchResultImpl saveResult=context.hasResult() ? context.getResult() : null;
  context.setResult(null);
  try {
    if (patternNodes.hasNext() && !matchedNodes.hasNext()) {
      return validateSatisfactionOfHandlers(patternNodes,context);
    }
    Set<PsiElement> matchedElements=null;
    for (; patternNodes.hasNext(); patternNodes.advance()) {
      int matchedOccurs=0;
      final PsiElement patternNode=patternNodes.current();
      final CompiledPattern pattern=context.getPattern();
      final MatchingHandler handler=pattern.getHandler(patternNode);
      final PsiElement startMatching=matchedNodes.current();
      do {
        final PsiElement element=handler.getPinnedNode(null);
        final PsiElement matchedNode=(element != null) ? element : matchedNodes.current();
        if (element == null)         matchedNodes.advance();
        if (!matchedNodes.hasNext())         matchedNodes.reset();
        if (matchedOccurs <= maxOccurs && (matchedElements == null || !matchedElements.contains(matchedNode))) {
          if (handler.match(patternNode,matchedNode,context)) {
            ++matchedOccurs;
            if (matchedElements == null)             matchedElements=new HashSet<PsiElement>();
            matchedElements.add(matchedNode);
            if (handler.shouldAdvanceThePatternFor(patternNode,matchedNode)) {
              break;
            }
          }
 else           if (element != null) {
            return false;
          }
          clearingVisitor.clearState(pattern,patternNode);
        }
        if (startMatching == matchedNodes.current()) {
          final boolean result=validateSatisfactionOfHandlers(patternNodes,context) && matchedOccurs >= minOccurs && matchedOccurs <= maxOccurs;
          if (result && context.getMatchedElementsListener() != null) {
            context.getMatchedElementsListener().matchedElements(matchedElements);
          }
          return result;
        }
      }
 while (true);
      if (!handler.shouldAdvanceThePatternFor(patternNode,null)) {
        patternNodes.rewind();
      }
    }
    final boolean result=validateSatisfactionOfHandlers(patternNodes,context);
    if (result && context.getMatchedElementsListener() != null) {
      context.getMatchedElementsListener().matchedElements(matchedElements);
    }
    return result;
  }
  finally {
    if (saveResult != null) {
      if (context.hasResult()) {
        saveResult.getMatches().addAll(context.getResult().getMatches());
      }
      context.setResult(saveResult);
    }
  }
}
