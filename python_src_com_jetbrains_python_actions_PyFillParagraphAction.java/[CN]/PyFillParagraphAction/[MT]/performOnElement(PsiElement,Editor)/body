{
  final Document document=editor.getDocument();
  final TextRange textRange=getTextRange(element,editor);
  final String text=textRange.substring(element.getContainingFile().getText());
  final List<String> strings=StringUtil.split(text,"\n",true);
  StringBuilder stringBuilder=new StringBuilder();
  for (  String string : strings) {
    stringBuilder.append(StringUtil.trimStart(string.trim(),getPrefix(element))).append(" ");
  }
  final String newText=stringBuilder.toString();
  CommandProcessor.getInstance().executeCommand(element.getProject(),new Runnable(){
    public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          document.replaceString(textRange.getStartOffset(),textRange.getEndOffset(),getPrefix(element) + newText);
          final CodeFormatterFacade codeFormatter=new CodeFormatterFacade(CodeStyleSettingsManager.getSettings(element.getProject()));
          codeFormatter.doWrapLongLinesIfNecessary(editor,element.getProject(),document,textRange.getStartOffset(),textRange.getStartOffset() + newText.length() + 1);
        }
      }
);
    }
  }
,null,document);
}
