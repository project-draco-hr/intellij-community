{
  VirtualFile virtualFile=LocalFileSystem.getInstance().refreshAndFindFileByPath(FileUtil.toSystemIndependentName(file.toString()));
  if (virtualFile != null) {
    return virtualFile;
  }
  Path absoluteFile=file.toAbsolutePath();
  Path parentFile=absoluteFile.getParent();
  Files.createDirectories(parentFile);
  final VirtualFile parentVirtualFile=LocalFileSystem.getInstance().refreshAndFindFileByPath(FileUtil.toSystemIndependentName(parentFile.toString()));
  if (parentVirtualFile == null) {
    throw new IOException(ProjectBundle.message("project.configuration.save.file.not.found",parentFile));
  }
  if (ApplicationManager.getApplication().isWriteAccessAllowed()) {
    return parentVirtualFile.createChildData(requestor,file.getFileName().toString());
  }
  AccessToken token=WriteAction.start();
  try {
    return parentVirtualFile.createChildData(requestor,file.getFileName().toString());
  }
  finally {
    token.finish();
  }
}
