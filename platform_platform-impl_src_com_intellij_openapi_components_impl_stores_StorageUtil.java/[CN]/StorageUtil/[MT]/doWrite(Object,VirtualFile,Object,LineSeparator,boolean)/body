{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Save " + file.getPresentableUrl());
  }
  AccessToken token=WriteAction.start();
  try {
    OutputStream out=file.getOutputStream(requestor);
    try {
      if (prependXmlProlog) {
        out.write(XML_PROLOG);
        out.write(lineSeparator.getSeparatorBytes());
      }
      if (content instanceof Element) {
        JDOMUtil.writeParent((Element)content,out,lineSeparator.getSeparatorString());
      }
 else {
        ((BufferExposingByteArrayOutputStream)content).writeTo(out);
      }
    }
  finally {
      out.close();
    }
  }
 catch (  FileNotFoundException e) {
    final BufferExposingByteArrayOutputStream byteArray=content instanceof Element ? writeToBytes((Element)content,lineSeparator.getSeparatorString()) : ((BufferExposingByteArrayOutputStream)content);
    throw new ReadOnlyModificationException(file,e,new StateStorage.SaveSession(){
      @Override public void save() throws IOException {
        doWrite(requestor,file,byteArray,lineSeparator,prependXmlProlog);
      }
    }
);
  }
 finally {
    token.finish();
  }
}
