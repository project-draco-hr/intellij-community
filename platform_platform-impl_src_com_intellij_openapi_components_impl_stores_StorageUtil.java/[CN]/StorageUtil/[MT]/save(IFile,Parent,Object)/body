{
  try {
    String lineSeparator;
    String oldText;
    if (file.exists()) {
      VirtualFile vFile=LocalFileSystem.getInstance().findFileByIoFile(file);
      Couple<String> pair=loadFile(vFile);
      lineSeparator=pair.second;
      oldText=pair.first;
    }
 else {
      oldText=null;
      lineSeparator=SystemProperties.getLineSeparator();
      file.createParentDirs();
    }
    String text=JDOMUtil.writeParent(element,lineSeparator);
    if (text.equals(oldText)) {
      return null;
    }
    AccessToken token=ApplicationManager.getApplication().acquireWriteActionLock(DocumentRunnable.IgnoreDocumentRunnable.class);
    try {
      VirtualFile virtualFile=getOrCreateVirtualFile(requestor,file);
      byte[] bytes=text.getBytes(CharsetToolkit.UTF8);
      virtualFile.setBinaryContent(bytes,-1,-1,requestor);
      return virtualFile;
    }
  finally {
      token.finish();
    }
  }
 catch (  IOException e) {
    throw new StateStorageException(e);
  }
}
