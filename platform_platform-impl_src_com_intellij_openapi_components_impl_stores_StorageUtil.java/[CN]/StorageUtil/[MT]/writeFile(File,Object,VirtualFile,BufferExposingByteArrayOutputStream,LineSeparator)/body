{
  AccessToken token=ApplicationManager.getApplication().acquireWriteActionLock(DocumentRunnable.IgnoreDocumentRunnable.class);
  try {
    if (virtualFile == null || !virtualFile.isValid()) {
      virtualFile=getOrCreateVirtualFile(requestor,file);
    }
    OutputStream out=virtualFile.getOutputStream(requestor);
    try {
      if (lineSeparatorIfPrependXmlProlog != null) {
        out.write(XML_PROLOG);
        out.write(lineSeparatorIfPrependXmlProlog.getSeparatorBytes());
      }
      content.writeTo(out);
    }
  finally {
      out.close();
    }
    return virtualFile;
  }
 catch (  FileNotFoundException e) {
    if (virtualFile == null) {
      throw e;
    }
 else {
      throw new ReadOnlyModificationException(virtualFile);
    }
  }
 finally {
    token.finish();
  }
}
