{
  AccessToken token=WriteAction.start();
  try {
    OutputStream out=file.getOutputStream(requestor);
    try {
      if (lineSeparatorIfPrependXmlProlog != null) {
        out.write(XML_PROLOG);
        out.write(lineSeparatorIfPrependXmlProlog.getSeparatorBytes());
      }
      content.writeTo(out);
    }
  finally {
      out.close();
    }
  }
 catch (  FileNotFoundException e) {
    if (proposedFile == null) {
      throw e;
    }
 else {
      throw new ReadOnlyModificationException(proposedFile,e,new StateStorage.SaveSession(){
        @Override public void save() throws IOException {
          doWrite(requestor,file,proposedFile,content,lineSeparatorIfPrependXmlProlog);
        }
      }
);
    }
  }
 finally {
    token.finish();
  }
}
