{
  VirtualFile virtualFile=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(file);
  if (virtualFile != null) {
    return virtualFile;
  }
  File absoluteFile=file.getAbsoluteFile();
  FileUtil.createParentDirs(absoluteFile);
  File parentFile=absoluteFile.getParentFile();
  final VirtualFile parentVirtualFile=StringUtil.isEmpty(parentFile.getPath()) ? null : LocalFileSystem.getInstance().refreshAndFindFileByIoFile(parentFile);
  if (parentVirtualFile == null) {
    throw new IOException(ProjectBundle.message("project.configuration.save.file.not.found",parentFile));
  }
  if (ApplicationManager.getApplication().isWriteAccessAllowed()) {
    return parentVirtualFile.createChildData(requestor,file.getName());
  }
  AccessToken token=WriteAction.start();
  try {
    return parentVirtualFile.createChildData(requestor,file.getName());
  }
  finally {
    token.finish();
  }
}
