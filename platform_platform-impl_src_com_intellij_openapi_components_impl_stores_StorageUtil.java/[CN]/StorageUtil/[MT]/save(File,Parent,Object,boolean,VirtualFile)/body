{
  if (isEmpty(element)) {
    try {
      deleteFile(file,requestor,cachedVirtualFile);
    }
 catch (    IOException e) {
      throw new StateStorageException(e);
    }
    return null;
  }
  VirtualFile virtualFile=cachedVirtualFile == null || !cachedVirtualFile.isValid() ? null : cachedVirtualFile;
  Parent document=!wrapAsDocument || element instanceof Document ? element : new Document((Element)element);
  try {
    BufferExposingByteArrayOutputStream byteOut;
    if (file.exists()) {
      if (virtualFile == null) {
        virtualFile=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(file);
      }
      Pair<byte[],String> pair=loadFile(virtualFile);
      byteOut=writeToBytes(document,pair.second);
      if (equal(pair.first,byteOut)) {
        return null;
      }
    }
 else {
      FileUtil.createParentDirs(file);
      byteOut=writeToBytes(document,SystemProperties.getLineSeparator());
    }
    return writeFile(file,requestor,virtualFile,byteOut,null);
  }
 catch (  IOException e) {
    throw new StateStorageException(e);
  }
}
