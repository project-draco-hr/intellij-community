{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Save " + file.getPresentableUrl());
  }
  String lineSeparator=(lineSeparatorIfPrependXmlProlog == null ? LineSeparator.LF : lineSeparatorIfPrependXmlProlog).getSeparatorString();
  AccessToken token=WriteAction.start();
  try {
    OutputStream out=file.getOutputStream(requestor);
    try {
      if (lineSeparatorIfPrependXmlProlog != null) {
        out.write(XML_PROLOG);
        out.write(lineSeparatorIfPrependXmlProlog.getSeparatorBytes());
      }
      if (content instanceof Element) {
        JDOMUtil.writeParent((Element)content,out,lineSeparator);
      }
 else {
        ((BufferExposingByteArrayOutputStream)content).writeTo(out);
      }
    }
  finally {
      out.close();
    }
  }
 catch (  FileNotFoundException e) {
    final BufferExposingByteArrayOutputStream byteArray=content instanceof Element ? writeToBytes((Element)content,lineSeparator) : ((BufferExposingByteArrayOutputStream)content);
    throw new ReadOnlyModificationException(file,e,new StateStorage.SaveSession(){
      @Override public void save() throws IOException {
        doWrite(requestor,file,byteArray,lineSeparatorIfPrependXmlProlog);
      }
    }
);
  }
 finally {
    token.finish();
  }
}
