{
  Sdk sdk=null;
  Module module=null;
  PyConsoleOptionsProvider.PyConsoleSettings settings=PyConsoleOptionsProvider.getInstance(project).getPythonConsoleSettings();
  String sdkHome=settings.getSdkHome();
  if (sdkHome != null) {
    sdk=PythonSdkType.findSdkByPath(sdkHome);
    if (settings.getModuleName() != null) {
      module=ModuleManager.getInstance(project).findModuleByName(settings.getModuleName());
    }
 else {
      module=contextModule;
      if (module == null && ModuleManager.getInstance(project).getModules().length > 0) {
        module=ModuleManager.getInstance(project).getModules()[0];
      }
    }
  }
  if (sdk == null && settings.isUseModuleSdk()) {
    if (contextModule != null) {
      module=contextModule;
    }
 else     if (settings.getModuleName() != null) {
      module=ModuleManager.getInstance(project).findModuleByName(settings.getModuleName());
    }
    if (module != null) {
      if (PythonSdkType.findPythonSdk(module) != null) {
        sdk=PythonSdkType.findPythonSdk(module);
      }
    }
  }
 else   if (contextModule != null) {
    module=contextModule;
    sdk=PythonSdkType.findPythonSdk(module);
  }
  if (sdk == null) {
    for (    Module m : ModuleManager.getInstance(project).getModules()) {
      if (PythonSdkType.findPythonSdk(module) != null) {
        sdk=PythonSdkType.findPythonSdk(module);
        module=m;
        break;
      }
    }
  }
  if (sdk == null) {
    if (PythonSdkType.getAllSdks().size() > 0) {
      sdk=PythonSdkType.getAllSdks().get(0);
    }
  }
  return Pair.create(sdk,module);
}
