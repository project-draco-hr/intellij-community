{
  final Collection<VirtualFile> changed=new ArrayList<VirtualFile>();
  for (  VirtualFile file : files) {
    boolean shouldRedetect=wasAutoDetectedBefore(file) && isDetectable(file);
    if (toLog()) {
      log("F: Redetect file: " + file.getName() + "; shouldRedetect: "+ shouldRedetect);
    }
    if (shouldRedetect) {
      int id=((VirtualFileWithId)file).getId();
      long flags=packedFlags.get(id);
      FileType before=fromCachedFlags(file,flags);
      if (toLog()) {
        log("F: reDetect(" + file.getName() + ") prepare to redetect. flags: "+ flags);
      }
      FileType after=getOrDetectByFile(file);
      if (after == null) {
        after=detectFromContentAndCache(file);
      }
 else {
        file.putUserData(DETECTED_FROM_CONTENT_FILE_TYPE_KEY,null);
        flags=0;
        packedFlags.set(id,flags);
      }
      if (toLog()) {
        log("F: After redetect file: " + file.getName() + "; before: "+ before.getName()+ "; after: "+ after.getName()+ "; now getFileType()="+ file.getFileType().getName());
      }
      if (before != after) {
        changed.add(file);
        LOG.debug(file + " type was re-detected. Was: " + before.getName()+ "; now: "+ after.getName());
      }
    }
  }
  if (!changed.isEmpty()) {
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      @Override public void run(){
        FileContentUtilCore.reparseFiles(changed);
      }
    }
,ApplicationManager.getApplication().getDisposed());
  }
}
