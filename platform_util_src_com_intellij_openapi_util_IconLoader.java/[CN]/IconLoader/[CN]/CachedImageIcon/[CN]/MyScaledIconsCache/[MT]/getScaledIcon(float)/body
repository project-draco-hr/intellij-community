{
  float effectiveScale=scale * JBUI.scale(1f);
  Icon icon=SoftReference.dereference(scaledIconsCache.get(effectiveScale));
  if (icon == null) {
    boolean needRetinaImage=(effectiveScale >= 1.5f || UIUtil.isRetina());
    Image image=getOrigImage(needRetinaImage);
    if (image != null) {
      Icon realIcon=getRealIcon();
      int width=(int)(realIcon.getIconWidth() * scale);
      int height=(int)(realIcon.getIconHeight() * scale);
      boolean isMacRetina=false;
      if (SystemInfo.isMac && UIUtil.isRetina()) {
        if (image instanceof JBHiDPIScaledImage) {
          Image hidpiImage=((JBHiDPIScaledImage)image).getDelegate();
          if (hidpiImage != null && hidpiImage.getWidth(null) == 2 * realIcon.getIconWidth()) {
            image=hidpiImage;
            width*=2;
            height*=2;
            isMacRetina=true;
          }
        }
      }
      BufferedImage resizedImage=Scalr.resize(ImageUtil.toBufferedImage(image),Scalr.Method.ULTRA_QUALITY,width,height);
      if (isMacRetina) {
        resizedImage=new JBHiDPIScaledImage(resizedImage,resizedImage.getWidth() / 2,resizedImage.getHeight() / 2,resizedImage.getType());
      }
      icon=getIcon(resizedImage);
      scaledIconsCache.put(effectiveScale,new SoftReference<Icon>(icon));
    }
  }
  return icon;
}
