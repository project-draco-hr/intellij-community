{
  float effectiveScale=scale * JBUI.scale(1f);
  Icon icon=SoftReference.dereference(scaledIconsCache.get(effectiveScale));
  if (icon == null) {
    boolean needRetinaImage=(effectiveScale >= 1.5f || UIUtil.isRetina());
    Image image=getOrigImage(needRetinaImage);
    if (image != null) {
      Image iconImage=getRealIcon().getImage();
      int width=(int)(ImageUtil.getRealWidth(iconImage) * scale);
      int height=(int)(ImageUtil.getRealHeight(iconImage) * scale);
      Image resizedImage=Scalr.resize(ImageUtil.toBufferedImage(image),Scalr.Method.ULTRA_QUALITY,width,height);
      if (UIUtil.isRetina())       resizedImage=RetinaImage.createFrom(resizedImage);
      icon=getIcon(resizedImage);
      scaledIconsCache.put(effectiveScale,new SoftReference<Icon>(icon));
    }
  }
  return icon;
}
