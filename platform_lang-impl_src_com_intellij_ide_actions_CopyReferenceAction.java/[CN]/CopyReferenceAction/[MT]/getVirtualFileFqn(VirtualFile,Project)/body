{
  final LogicalRoot logicalRoot=LogicalRootsManager.getLogicalRootsManager(project).findLogicalRoot(virtualFile);
  VirtualFile logicalRootFile=logicalRoot != null ? logicalRoot.getVirtualFile() : null;
  if (logicalRootFile != null && !virtualFile.equals(logicalRootFile)) {
    return ObjectUtils.assertNotNull(VfsUtilCore.getRelativePath(virtualFile,logicalRootFile,'/'));
  }
  VirtualFile outerMostRoot=null;
  VirtualFile each=virtualFile;
  ProjectFileIndex index=ProjectRootManager.getInstance(project).getFileIndex();
  while (each != null && (each=index.getContentRootForFile(each,false)) != null) {
    outerMostRoot=each;
    each=each.getParent();
  }
  if (outerMostRoot != null && !outerMostRoot.equals(virtualFile)) {
    String relative=VfsUtilCore.getRelativePath(virtualFile,outerMostRoot,'/');
    if (relative != null) {
      return relative;
    }
  }
  return virtualFile.getPath();
}
