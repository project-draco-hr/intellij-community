{
  PrintStream oldOut=System.out;
  PrintStream oldErr=System.err;
  try {
    System.setOut(new PrintStream(out));
    System.setErr(new PrintStream(err));
    if (ourCommandFileName != null) {
      if (!"none".equals(ourForkMode) || ourWorkingDirs != null && new File(ourWorkingDirs).length() > 0) {
        return JUnitForkedStarter.startForkedVMs(ourWorkingDirs,args,isJUnit4,listeners,name,out,err,ourForkMode,ourCommandFileName);
      }
    }
    IdeaTestRunner testRunner=(IdeaTestRunner)getAgentClass(isJUnit4).newInstance();
    testRunner.setStreams(out,err,0);
    return testRunner.startRunnerWithArgs(args,listeners,name,ourCount,!SM_RUNNER);
  }
 catch (  Exception e) {
    e.printStackTrace(System.err);
    return -2;
  }
 finally {
    System.setOut(oldOut);
    System.setErr(oldErr);
  }
}
