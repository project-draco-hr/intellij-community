{
  if (myProjectFrame != null) {
    DumbService.getInstance(myProjectFrame.getProject()).repeatUntilPassesInSmartMode(new Runnable(){
      @Override public void run(){
        myProjectFrame.waitForBackgroundTasksToFinish();
      }
    }
);
  }
  if (myRobot != null) {
    myRobot.cleanUpWithoutDisposingWindows();
    for (    Window window : Window.getWindows()) {
      if (window.isShowing() && window instanceof Dialog) {
        if (((Dialog)window).getModalityType() == Dialog.ModalityType.APPLICATION_MODAL) {
          fail("Modal dialog still active: " + window);
          myRobot.close(window);
        }
      }
    }
  }
}
