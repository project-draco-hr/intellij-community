{
  org.hibernate.Transaction tx=HibernateSessionFactory.currentSession().beginTransaction();
  Transaction t=new Transaction();
  t.setAmount(amount);
  t.setType(TransactionType.DEPOSIT);
  t.setStatus(TransactionStatus.PENDING);
  t.setCreateDate(new Date());
  t.setPlayer(player);
  saveNow(t);
  try {
    BillingInfo billingInfo=billCreditCard(player,t.getId(),info,amount,remoteHost,player.getUsername());
    t.setStatus(TransactionStatus.COMPLETED);
    t.setExternalId(billingInfo.getTransactionId());
    t.setProcessDate(new Date());
  }
 catch (  PaymentException e) {
    log.error("Payment problem",e);
  }
catch (  WrongAmountException e) {
    log.error("Wrong amount",e);
  }
  tx.commit();
}
