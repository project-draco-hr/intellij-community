{
  IdeDocumentHistory.getInstance(project).includeCurrentPlaceAsChangePlace();
  final PsiType type=FieldFromParameterUtils.getSubstitutedType(parameter);
  final JavaCodeStyleManager styleManager=JavaCodeStyleManager.getInstance(project);
  final String parameterName=parameter.getName();
  String propertyName=styleManager.variableNameToPropertyName(parameterName,VariableKind.PARAMETER);
  final PsiClass targetClass=PsiTreeUtil.getParentOfType(parameter,PsiClass.class);
  final PsiElement declarationScope=parameter.getDeclarationScope();
  if (!(declarationScope instanceof PsiMethod))   return;
  final PsiMethod method=(PsiMethod)declarationScope;
  final boolean isMethodStatic=method.hasModifierProperty(PsiModifier.STATIC);
  VariableKind kind=isMethodStatic ? VariableKind.STATIC_FIELD : VariableKind.FIELD;
  SuggestedNameInfo suggestedNameInfo=styleManager.suggestVariableName(kind,propertyName,null,type);
  String[] names=suggestedNameInfo.names;
  final boolean isFinal=!isMethodStatic && method.isConstructor();
  String name=names[0];
  if (targetClass != null) {
    for (    String curName : names) {
      if (!usedNames.contains(curName) && targetClass.findFieldByName(curName,false) != null) {
        name=curName;
        break;
      }
    }
  }
  if (usedNames.contains(name)) {
    for (    String curName : names) {
      if (!usedNames.contains(curName)) {
        name=curName;
        break;
      }
    }
  }
  final String fieldName=usedNames.add(name) ? name : JavaCodeStyleManager.getInstance(project).suggestUniqueVariableName(name,parameter,true);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      try {
        FieldFromParameterUtils.createFieldAndAddAssignment(project,targetClass,method,parameter,type,fieldName,isMethodStatic,isFinal);
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
  }
);
}
