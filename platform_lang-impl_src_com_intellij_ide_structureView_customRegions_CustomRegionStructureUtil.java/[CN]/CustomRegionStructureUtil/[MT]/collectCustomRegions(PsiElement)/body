{
  List<CustomRegionTreeElement> customRegions=new ArrayList<>();
  PsiElement child=rootElement.getFirstChild();
  CustomRegionTreeElement currRegionElement=null;
  CustomFoldingProvider provider=null;
  while (child != null) {
    if (child instanceof PsiComment && !child.textContains('\n')) {
      if (provider == null)       provider=getProvider(child);
      if (provider != null) {
        String commentText=child.getText();
        if (provider.isCustomRegionStart(commentText)) {
          if (currRegionElement == null) {
            currRegionElement=new CustomRegionTreeElement(child,provider);
            customRegions.add(currRegionElement);
          }
 else {
            currRegionElement=currRegionElement.createNestedRegion(child);
          }
        }
 else         if (provider.isCustomRegionEnd(commentText) && currRegionElement != null) {
          currRegionElement=currRegionElement.endRegion(child);
        }
      }
    }
    child=child.getNextSibling();
  }
  return customRegions;
}
