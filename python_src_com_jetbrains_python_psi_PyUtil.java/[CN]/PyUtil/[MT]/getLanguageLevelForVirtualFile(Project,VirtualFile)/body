{
  if (virtualFile instanceof VirtualFileWindow) {
    virtualFile=((VirtualFileWindow)virtualFile).getDelegate();
  }
  final VirtualFile folder=virtualFile.getParent();
  if (folder != null) {
    LanguageLevel level=folder.getUserData(LanguageLevel.KEY);
    if (level == null)     level=PythonLanguageLevelPusher.getFileLanguageLevel(project,virtualFile);
    return level;
  }
 else {
    final LanguageLevel level=virtualFile.getUserData(LanguageLevel.KEY);
    if (level != null)     return level;
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      final LanguageLevel languageLevel=LanguageLevel.FORCE_LANGUAGE_LEVEL;
      if (languageLevel != null) {
        return languageLevel;
      }
    }
    return guessLanguageLevelWithCaching(project);
  }
}
