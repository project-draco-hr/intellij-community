{
  PsiElement currentElement=elementToResolve;
  while (true) {
    final PsiReference reference=currentElement.getReference();
    if (reference == null) {
      break;
    }
    final PsiElement resolve=reference.resolve();
    if ((resolve == null) || resolve.equals(currentElement) || !inSameFile(resolve,currentElement)) {
      break;
    }
    currentElement=resolve;
  }
  return currentElement;
}
