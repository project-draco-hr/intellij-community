{
  int offset=fileText.indexOf(MARKER);
  assertTrue(offset >= 0);
  fileText=fileText.substring(0,offset) + fileText.substring(offset + MARKER.length());
  if (parentDir == null) {
    myFile=createFile(myModule,fileName,fileText);
  }
 else {
    VirtualFile existing=parentDir.findChild(fileName);
    if (existing != null) {
      myDocument=FileDocumentManager.getInstance().getDocument(existing);
      assertNotNull(myDocument);
      myDocument.setText(fileText);
      myFile=PsiManager.getInstance(getProject()).findFile(existing);
      assertNotNull(myFile);
      assertEquals(fileText,myFile.getText());
    }
 else {
      myFile=createFile(myModule,parentDir,fileName,fileText);
    }
  }
  PsiReference ref=myFile.findReferenceAt(offset);
  assertNotNull(ref);
  return ref;
}
