{
  int x=myGraphLayout.getLayoutIndex(firstChildIndex);
  int y=myGraphLayout.getLayoutIndex(currentNodeIndex);
  int k=1;
  PriorityQueue<GraphEdge> queue=new PriorityQueue<GraphEdge>(MAX_BLOCK_SIZE,new GraphEdgeComparator());
  queue.addAll(myWorkingGraph.getAdjacentEdges(currentNodeIndex,EdgeFilter.NORMAL_DOWN));
  Set<Integer> definitelyNotTails=ContainerUtil.newHashSet(MAX_BLOCK_SIZE);
  Set<Integer> tails=ContainerUtil.newHashSet(MAX_BLOCK_SIZE);
  boolean mergeWithOldCommit=false;
  while (!queue.isEmpty()) {
    GraphEdge nextEdge=queue.poll();
    Integer next=nextEdge.getDownNodeIndex();
    if (next == null)     return false;
    Integer upNodeIndex=nextEdge.getUpNodeIndex();
    if (next == firstChildIndex) {
      tails.add(upNodeIndex);
      mergeWithOldCommit=true;
    }
 else     if (next < currentNodeIndex + k) {
    }
 else     if (next == currentNodeIndex + k) {
      k++;
      queue.addAll(myWorkingGraph.getAdjacentEdges(next,EdgeFilter.NORMAL_DOWN));
      definitelyNotTails.add(upNodeIndex);
    }
 else     if (next > currentNodeIndex + k && next < firstChildIndex) {
      int li=myGraphLayout.getLayoutIndex(next);
      if (li > y) {
        return false;
      }
      if (li <= x) {
        if (!(li >= headIndex && li < nextHeadIndex)) {
          return false;
        }
      }
      k++;
      queue.addAll(myWorkingGraph.getAdjacentEdges(next,EdgeFilter.NORMAL_DOWN));
      if (visited.get(next)) {
        definitelyNotTails.add(upNodeIndex);
      }
    }
 else     if (next > firstChildIndex) {
      int li=myGraphLayout.getLayoutIndex(next);
      if (li > y) {
        return false;
      }
      if (li < x && !(li >= headIndex && li < nextHeadIndex)) {
        return false;
      }
 else {
        if (!definitelyNotTails.contains(upNodeIndex)) {
          tails.add(upNodeIndex);
          if (li != y && (li >= x)) {
            myWorkingGraph.removeEdge(upNodeIndex,next);
          }
        }
      }
    }
    if (k >= MAX_BLOCK_SIZE) {
      return false;
    }
    if (Math.abs(myTimestampGetter.getTimestamp(currentNodeIndex) - myTimestampGetter.getTimestamp(currentNodeIndex + k - 1)) > MAX_DELTA_TIME) {
      return false;
    }
  }
  for (  Integer tail : tails) {
    if (!LinearGraphUtils.getDownNodes(myWorkingGraph,tail).contains(firstChildIndex)) {
      myWorkingGraph.addEdge(tail,firstChildIndex);
    }
 else     if (mergeWithOldCommit) {
      myWorkingGraph.removeEdge(tail,firstChildIndex);
      myWorkingGraph.addEdge(tail,firstChildIndex);
    }
  }
  if (!tails.isEmpty() || mergeWithOldCommit) {
    myWorkingGraph.removeEdge(parent,firstChildIndex);
  }
  return true;
}
