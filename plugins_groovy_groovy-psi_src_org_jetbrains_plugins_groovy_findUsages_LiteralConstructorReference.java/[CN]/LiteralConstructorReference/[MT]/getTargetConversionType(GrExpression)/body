{
  final PsiElement parent=PsiUtil.skipParentheses(expression.getParent(),true);
  PsiType type=null;
  if (parent instanceof GrSafeCastExpression) {
    type=((GrSafeCastExpression)parent).getType();
  }
 else   if (parent instanceof GrAssignmentExpression && PsiTreeUtil.isAncestor(((GrAssignmentExpression)parent).getRValue(),expression,false)) {
    final PsiElement lValue=PsiUtil.skipParentheses(((GrAssignmentExpression)parent).getLValue(),false);
    if (lValue instanceof GrReferenceExpression) {
      type=((GrReferenceExpression)lValue).getNominalType();
    }
  }
 else   if (parent instanceof GrVariable) {
    type=((GrVariable)parent).getDeclaredType();
  }
 else   if (parent instanceof GrNamedArgument) {
    for (    PsiType expected : GroovyExpectedTypesProvider.getDefaultExpectedTypes(expression)) {
      expected=filterOutTrashTypes(expected);
      if (expected != null)       return (PsiClassType)expected;
    }
  }
 else {
    final GrControlFlowOwner controlFlowOwner=ControlFlowUtils.findControlFlowOwner(expression);
    if (controlFlowOwner instanceof GrOpenBlock && controlFlowOwner.getParent() instanceof GrMethod) {
      if (ControlFlowUtils.isReturnValue(expression,controlFlowOwner)) {
        type=((GrMethod)controlFlowOwner.getParent()).getReturnType();
        if (PsiType.BOOLEAN.equals(TypesUtil.unboxPrimitiveTypeWrapper(type)) || TypesUtil.isEnum(type) || PsiUtil.isCompileStatic(expression)|| TypesUtil.isClassType(type,CommonClassNames.JAVA_LANG_STRING)|| TypesUtil.isClassType(type,CommonClassNames.JAVA_LANG_CLASS)) {
          type=null;
        }
      }
    }
  }
  if (PsiType.BOOLEAN.equals(type)) {
    type=TypesUtil.boxPrimitiveType(type,expression.getManager(),expression.getResolveScope());
  }
  return filterOutTrashTypes(type);
}
