{
  key.get().set(EncryptionUtil.genPasswordKey(password));
  database.clear();
  try {
    storePassword(null,MasterKeyPasswordSafe.class,testKey(password),TEST_PASSWORD_VALUE);
    if (encrypt) {
      database.setPasswordInfo(encryptPassword(password));
    }
 else {
      database.setPasswordInfo(ArrayUtil.EMPTY_BYTE_ARRAY);
    }
  }
 catch (  PasswordSafeException e) {
    throw new IllegalStateException("There should be no problem with password at this point",e);
  }
}
