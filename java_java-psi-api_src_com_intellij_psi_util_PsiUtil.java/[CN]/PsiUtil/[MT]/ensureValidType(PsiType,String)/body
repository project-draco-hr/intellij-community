{
  if (!type.isValid()) {
    TimeoutUtil.sleep(1);
    if (type.isValid()) {
      LOG.error("PsiType resurrected: " + type + " of "+ type.getClass()+ " "+ customMessage);
      return;
    }
    if (type instanceof PsiClassType) {
      try {
        PsiClass psiClass=((PsiClassType)type).resolve();
        if (psiClass != null) {
          ensureValid(psiClass);
        }
      }
 catch (      PsiInvalidElementAccessException e) {
        throw customMessage == null ? e : new RuntimeException(customMessage,e);
      }
    }
    throw new AssertionError("Invalid type: " + type + " of class "+ type.getClass()+ " "+ customMessage);
  }
  for (  PsiAnnotation annotation : type.getAnnotations()) {
    try {
      PsiUtilCore.ensureValid(annotation);
    }
 catch (    PsiInvalidElementAccessException e) {
      throw customMessage == null ? e : new RuntimeException(customMessage,e);
    }
  }
}
