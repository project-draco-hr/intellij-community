{
  PsiType oldSubstituted=substituted;
  PsiElement captureContext=context;
  if (substituted instanceof PsiCapturedWildcardType) {
    final PsiCapturedWildcardType captured=(PsiCapturedWildcardType)substituted;
    substituted=captured.getWildcard();
    captureContext=captured.getContext();
  }
  PsiType glb=null;
  PsiType originalBound=PsiType.NULL;
  if (substituted instanceof PsiWildcardType) {
    final PsiType[] boundTypes=typeParameter.getExtendsListTypes();
    PsiManager manager=typeParameter.getManager();
    originalBound=!((PsiWildcardType)substituted).isSuper() ? ((PsiWildcardType)substituted).getBound() : null;
    glb=originalBound;
    for (    PsiType boundType : boundTypes) {
      PsiType substitutedBoundType=captureSubstitutor.substitute(boundType);
      if (substitutedBoundType != null && !(substitutedBoundType instanceof PsiWildcardType) && !substitutedBoundType.equalsToText(CommonClassNames.JAVA_LANG_OBJECT)) {
        if (originalBound instanceof PsiArrayType && substitutedBoundType instanceof PsiArrayType && !originalBound.isAssignableFrom(substitutedBoundType)&& !substitutedBoundType.isAssignableFrom(originalBound)) {
          continue;
        }
        if (originalBound == null || !TypeConversionUtil.erasure(substitutedBoundType).isAssignableFrom(TypeConversionUtil.erasure(originalBound)) && !TypeConversionUtil.erasure(substitutedBoundType).isAssignableFrom(originalBound)) {
          if (glb == null) {
            glb=substitutedBoundType;
          }
 else {
            glb=GenericsUtil.getGreatestLowerBound(glb,substitutedBoundType);
          }
        }
      }
    }
    if (glb != null) {
      if (!((PsiWildcardType)substituted).isSuper()) {
        substituted=glb instanceof PsiCapturedWildcardType ? ((PsiCapturedWildcardType)glb).getWildcard() : PsiWildcardType.createExtends(manager,glb);
      }
 else {
        if (captureContext != null) {
          final PsiCapturedWildcardType capturedWildcardType=oldSubstituted instanceof PsiCapturedWildcardType ? (PsiCapturedWildcardType)oldSubstituted : (PsiCapturedWildcardType)captureSubstitutor.substitute(typeParameter);
          LOG.assertTrue(capturedWildcardType != null);
          capturedWildcardType.setUpperBound(glb);
          return capturedWildcardType;
        }
      }
    }
  }
  if (captureContext != null) {
    LOG.assertTrue(substituted instanceof PsiWildcardType,substituted);
    substituted=oldSubstituted instanceof PsiCapturedWildcardType && substituted.equals(((PsiCapturedWildcardType)oldSubstituted).getWildcard()) ? oldSubstituted : captureSubstitutor.substitute(typeParameter);
    LOG.assertTrue(substituted instanceof PsiCapturedWildcardType);
    if (glb != null) {
      ((PsiCapturedWildcardType)substituted).setUpperBound(glb);
    }
  }
  return substituted;
}
