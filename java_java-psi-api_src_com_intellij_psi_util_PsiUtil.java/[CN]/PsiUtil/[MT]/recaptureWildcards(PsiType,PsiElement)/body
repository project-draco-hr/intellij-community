{
  if (type instanceof PsiClassType) {
    final PsiClassType.ClassResolveResult resolveResult=((PsiClassType)type).resolveGenerics();
    final PsiClass aClass=resolveResult.getElement();
    if (aClass != null) {
      final PsiSubstitutor substitutor=resolveResult.getSubstitutor();
      PsiSubstitutor resultSubstitution=null;
      for (      PsiTypeParameter parameter : substitutor.getSubstitutionMap().keySet()) {
        final PsiType substitute=substitutor.substitute(parameter);
        if (substitute instanceof PsiCapturedWildcardType) {
          if (resultSubstitution == null)           resultSubstitution=substitutor;
          resultSubstitution=resultSubstitution.put(parameter,((PsiCapturedWildcardType)substitute).getWildcard());
        }
      }
      if (resultSubstitution != null) {
        final PsiElementFactory factory=JavaPsiFacade.getElementFactory(context.getProject());
        return captureToplevelWildcards(factory.createType(aClass,resultSubstitution),context);
      }
    }
  }
 else   if (type instanceof PsiArrayType) {
    return recaptureWildcards(((PsiArrayType)type).getComponentType(),context).createArrayType();
  }
  return type;
}
