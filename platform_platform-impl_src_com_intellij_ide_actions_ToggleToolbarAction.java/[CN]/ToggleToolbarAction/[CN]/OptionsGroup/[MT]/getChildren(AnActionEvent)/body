{
  ContentManager contentManager=myToolWindow.getContentManager();
  Content selectedContent=contentManager.getSelectedContent();
  JComponent contentComponent=selectedContent != null ? selectedContent.getComponent() : null;
  if (contentComponent == null)   return EMPTY_ARRAY;
  List<AnAction> result=ContainerUtil.newSmartList();
  boolean addSeparator=false;
  for (  final ActionToolbar toolbar : iterateToolbars(contentComponent)) {
    JComponent c=toolbar.getComponent();
    if (c.isVisible() || !c.isValid())     continue;
    if (!result.isEmpty())     result.add(Separator.getInstance());
    List<AnAction> actions=toolbar.getActions(false);
    for (    AnAction action : actions) {
      if (!(action instanceof Separator && (addSeparator=true)) && action instanceof ToggleAction && !result.contains(action)) {
        if (addSeparator && result.size() > 1 && !(result.get(result.size() - 2) instanceof Separator)) {
          result.add(Separator.getInstance());
        }
        result.add(action);
        addSeparator=false;
      }
    }
  }
  boolean popup=result.size() > 3;
  setPopup(popup);
  if (!popup && !result.isEmpty())   result.add(Separator.getInstance());
  return result.toArray(new AnAction[result.size()]);
}
