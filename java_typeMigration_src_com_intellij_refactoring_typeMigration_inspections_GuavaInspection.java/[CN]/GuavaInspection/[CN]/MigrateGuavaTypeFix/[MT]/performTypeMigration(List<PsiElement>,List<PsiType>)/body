{
  PsiFile containingFile=null;
  SearchScope typeMigrationScope=GlobalSearchScope.EMPTY_SCOPE;
  for (  PsiElement element : elements) {
    final PsiFile currentContainingFile=element.getContainingFile();
    if (containingFile == null) {
      containingFile=currentContainingFile;
    }
 else {
      LOG.assertTrue(containingFile.isEquivalentTo(currentContainingFile));
    }
    typeMigrationScope=typeMigrationScope.union(element.getUseScope());
  }
  LOG.assertTrue(containingFile != null);
  if (!FileModificationService.getInstance().prepareFileForWrite(containingFile))   return;
  try {
    final TypeMigrationRules rules=new TypeMigrationRules();
    rules.setBoundScope(typeMigrationScope);
    TypeMigrationProcessor.runHighlightingTypeMigration(containingFile.getProject(),null,rules,elements.toArray(new PsiElement[elements.size()]),createMigrationTypeFunction(elements,types),true);
    UndoUtil.markPsiFileForUndo(containingFile);
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
}
