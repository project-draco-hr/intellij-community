{
  final Iterator<PsiType> initialTypeIterator=initialTypes.iterator();
  final Iterator<PsiType> targetTypeIterator=targetTypes.iterator();
  final List<PsiElement> validElement=new ArrayList<PsiElement>();
  final List<Boolean> isIterableList=new ArrayList<Boolean>(elements.size());
  final List<TypeConversionDescriptorBase> conversionList=new ArrayList<TypeConversionDescriptorBase>(elements.size());
  for (  PsiElement element : elements) {
    final PsiType initialType=initialTypeIterator.next();
    final PsiType targetType=targetTypeIterator.next();
    if (element.isValid()) {
      PsiMethodCallExpression expr=(PsiMethodCallExpression)element;
      final TypeMigrationRules rules=new TypeMigrationRules();
      rules.setBoundScope(element.getUseScope());
      conversionList.add(rules.findConversion(initialType,targetType,expr.resolveMethod(),expr,new TypeMigrationLabeler(rules,targetType)));
      isIterableList.add(isIterable(expr));
      validElement.add(element);
    }
  }
  if (!validElement.isEmpty()) {
    final PsiFile file=validElement.get(0).getContainingFile();
    if (!FileModificationService.getInstance().prepareFileForWrite(file))     return;
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        final Iterator<Boolean> isIterableIterator=isIterableList.iterator();
        final Iterator<TypeConversionDescriptorBase> conversionIterator=conversionList.iterator();
        for (        PsiElement element : validElement) {
          PsiElement replacedExpression=TypeMigrationReplacementUtil.replaceExpression((PsiExpression)element,project,conversionIterator.next());
          if (isIterableIterator.next()) {
            final String expressionText=replacedExpression.getText() + ".collect(java.util.stream.Collectors.toList())";
            replacedExpression=replacedExpression.replace(JavaPsiFacade.getElementFactory(project).createExpressionFromText(expressionText,replacedExpression));
          }
          JavaCodeStyleManager.getInstance(project).shortenClassReferences(replacedExpression);
        }
        UndoUtil.markPsiFileForUndo(file);
      }
    }
);
  }
}
