{
  if (file instanceof VirtualFileWindow) {
    return;
  }
  Language prevSubstitutedLang=SUBSTITUTED_LANG_KEY.get(file);
  final Language prevLang=ObjectUtils.notNull(prevSubstitutedLang,originalLang);
  if (!haveCommonAncestorLanguage(substitutedLang,prevLang)) {
    if (file.replace(SUBSTITUTED_LANG_KEY,prevSubstitutedLang,substitutedLang)) {
      if (ApplicationManager.getApplication().isDispatchThread() && myReparsingInProgress) {
        return;
      }
      if (ApplicationManager.getApplication().isUnitTestMode()) {
        return;
      }
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          LOG.info("Reparsing " + file.getPath() + " because of language substitution "+ prevLang.getID()+ "->"+ substitutedLang.getID());
          myReparsingInProgress=true;
          FileContentUtilCore.reparseFiles(file);
          myReparsingInProgress=false;
        }
      }
,ModalityState.defaultModalityState());
    }
  }
}
