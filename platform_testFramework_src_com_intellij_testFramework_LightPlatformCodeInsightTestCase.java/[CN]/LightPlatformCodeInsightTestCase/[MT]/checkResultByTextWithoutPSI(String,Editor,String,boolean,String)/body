{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      final Document fakeDocument=EditorFactory.getInstance().createDocument(fileText);
      if (ignoreTrailingSpaces) {
        ((DocumentImpl)fakeDocument).stripTrailingSpaces(getProject());
      }
      EditorTestUtil.CaretAndSelectionState carets=EditorTestUtil.extractCaretAndSelectionMarkers(fakeDocument);
      String newFileText=fakeDocument.getText();
      String fileText=editor.getDocument().getText();
      String failMessage=getMessage("Text mismatch",message);
      if (filePath != null && !newFileText.equals(fileText)) {
        throw new FileComparisonFailure(failMessage,newFileText,fileText,filePath);
      }
      assertEquals(failMessage,newFileText,fileText);
      EditorTestUtil.verifyCaretAndSelectionState(editor,carets,message);
    }
  }
);
}
