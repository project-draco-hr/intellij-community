{
  return new WriteCommandAction<Document>(null){
    @Override protected void run(    @NotNull Result<Document> result) throws Throwable {
      final Document fakeDocument=new DocumentImpl(fileText);
      EditorTestUtil.CaretAndSelectionState caretsState=EditorTestUtil.extractCaretAndSelectionMarkers(fakeDocument);
      if (checkCaret) {
        assertTrue("No caret specified in " + fileName,caretsState.hasExplicitCaret());
      }
      String newFileText=fakeDocument.getText();
      Document document;
      try {
        document=setupFileEditorAndDocument(fileName,newFileText);
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
      EditorTestUtil.setCaretsAndSelection(myEditor,caretsState);
      setupEditorForInjectedLanguage();
      result.setResult(document);
    }
  }
.execute().getResultObject();
}
