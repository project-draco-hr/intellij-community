{
  return new WriteCommandAction<Document>(null){
    @Override protected void run(    @NotNull Result<Document> result) throws Throwable {
      if (myVFile != null) {
        PsiDocumentManager.getInstance(ourProject).commitAllDocuments();
        FileEditorManager.getInstance(ourProject).closeFile(myVFile);
        try {
          myVFile.delete(this);
        }
 catch (        IOException e) {
          LOG.error(e);
        }
        myVFile=null;
      }
      final Document fakeDocument=new DocumentImpl(fileText);
      EditorTestUtil.CaretsState caretsState=EditorTestUtil.extractCaretAndSelectionMarkers(fakeDocument);
      String newFileText=fakeDocument.getText();
      Document document;
      try {
        document=setupFileEditorAndDocument(fileName,newFileText);
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
      setupCaretAndSelection(caretsState,newFileText);
      setupEditorForInjectedLanguage();
      result.setResult(document);
    }
  }
.execute().getResultObject();
}
