{
  if (!needModify(parent)) {
    return children;
  }
  Collection<AbstractTreeNode> nodes=new ArrayList<AbstractTreeNode>();
  for (  AbstractTreeNode node : children) {
    Project project=node.getProject();
    if (project != null) {
      if (node.getValue() instanceof PsiDirectory) {
        PsiDirectory nodeValue=(PsiDirectory)node.getValue();
        if (!nodeValue.getName().contains(Task.USER_TESTS)) {
          StudyDirectoryNode newNode=new StudyDirectoryNode(project,nodeValue,settings);
          nodes.add(newNode);
        }
      }
 else {
        if (parent instanceof StudyDirectoryNode) {
          if (node instanceof PsiFileNode) {
            PsiFileNode psiFileNode=(PsiFileNode)node;
            VirtualFile virtualFile=psiFileNode.getVirtualFile();
            if (virtualFile == null) {
              return nodes;
            }
            TaskFile taskFile=StudyTaskManager.getInstance(project).getTaskFile(virtualFile);
            if (taskFile != null) {
              nodes.add(node);
            }
            String parentName=parent.getName();
            if (parentName != null) {
              if (parentName.equals(Course.SANDBOX_DIR)) {
                nodes.add(node);
              }
            }
          }
        }
      }
    }
  }
  return nodes;
}
