{
  Set<Language> languages=new SmartHashSet<Language>();
  Map<String,Language> langIds=new SmartHashMap<String,Language>();
  Set<String> dialects=new SmartHashSet<String>();
  calculateDialects(inside,languages,langIds,dialects);
  calculateDialects(outside,languages,langIds,dialects);
  MultiMap<T,String> toolToLanguages=new MultiMap<T,String>(){
    @NotNull @Override protected Collection<String> createCollection(){
      return new SmartHashSet<String>();
    }
    @NotNull @Override protected Collection<String> createEmptyCollection(){
      return Collections.emptySet();
    }
  }
;
  for (  T wrapper : toolWrappers) {
    ProgressManager.checkCanceled();
    String language=wrapper.getLanguage();
    if (language == null) {
      toolToLanguages.put(wrapper,null);
      continue;
    }
    Language lang=langIds.get(language);
    if (lang != null) {
      toolToLanguages.putValue(wrapper,language);
      if (wrapper.applyToDialects()) {
        for (        Language dialect : lang.getDialects()) {
          toolToLanguages.putValue(wrapper,dialect.getID());
        }
      }
    }
 else     if (wrapper.applyToDialects() && dialects.contains(language)) {
      toolToLanguages.putValue(wrapper,language);
    }
  }
  return toolToLanguages;
}
