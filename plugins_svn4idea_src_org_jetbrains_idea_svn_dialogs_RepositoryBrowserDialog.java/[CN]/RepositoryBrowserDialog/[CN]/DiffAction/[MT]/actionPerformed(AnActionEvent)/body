{
  SVNURL root;
  RepositoryTreeNode node=getRepositoryBrowser().getSelectedNode();
  if (node == null) {
    return;
  }
  while (node.getSVNDirEntry() != null) {
    node=(RepositoryTreeNode)node.getParent();
  }
  root=node.getURL();
  final RepositoryTreeNode selectedNode=getSelectedNode();
  if (selectedNode == null) {
    return;
  }
  SVNURL sourceURL=selectedNode.getURL();
  DiffOptionsDialog dialog=new DiffOptionsDialog(myProject,root,sourceURL);
  if (dialog.showAndGet()) {
    SVNURL targetURL=dialog.getTargetURL();
    if (dialog.isReverseDiff()) {
      targetURL=sourceURL;
      sourceURL=dialog.getTargetURL();
    }
    final SVNURL sURL=sourceURL;
    final SVNURL tURL=targetURL;
    Runnable command;
    boolean cancelable;
    if (dialog.isUnifiedDiff()) {
      final File targetFile=dialog.getTargetFile();
      command=new Runnable(){
        public void run(){
          targetFile.getParentFile().mkdirs();
          doUnifiedDiff(targetFile,sURL,tURL);
        }
      }
;
      cancelable=false;
    }
 else {
      command=new Runnable(){
        public void run(){
          try {
            doGraphicalDiff(sURL,tURL);
          }
 catch (          final VcsException ex) {
            boolean isCancelled=ex instanceof SvnBindException && ((SvnBindException)ex).contains(SVNErrorCode.CANCELLED);
            if (!isCancelled) {
              WaitForProgressToShow.runOrInvokeLaterAboveProgress(new Runnable(){
                public void run(){
                  Messages.showErrorDialog(myProject,ex.getMessage(),"Error");
                }
              }
,null,myProject);
            }
          }
        }
      }
;
      cancelable=true;
    }
    ProgressManager.getInstance().runProcessWithProgressSynchronously(command,SvnBundle.message("progress.computing.difference"),cancelable,myProject);
  }
}
