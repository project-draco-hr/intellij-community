{
  if (jdkName == null)   return null;
  if (USE_INTERNAL_JAVA.equals(jdkName)) {
    return JavaAwareProjectJdkTableImpl.getInstanceEx().getInternalJdk();
  }
  if (USE_PROJECT_JDK.equals(jdkName)) {
    if (project != null) {
      Sdk res=ProjectRootManager.getInstance(project).getProjectSdk();
      if (res != null)       return res;
      Module[] modules=ModuleManager.getInstance(project).getModules();
      for (      Module module : modules) {
        Sdk sdk=ModuleRootManager.getInstance(module).getSdk();
        if (sdk != null && sdk.getSdkType() instanceof JavaSdkType)         return sdk;
      }
    }
    if (project == null) {
      Sdk recent=ProjectJdkTable.getInstance().findMostRecentSdkOfType(JavaSdk.getInstance());
      if (recent != null)       return recent;
      return JavaAwareProjectJdkTableImpl.getInstanceEx().getInternalJdk();
    }
    throw new ProjectJdkNotFoundException();
  }
  if (USE_JAVA_HOME.equals(jdkName)) {
    final String javaHome=System.getenv("JAVA_HOME");
    if (StringUtil.isEmptyOrSpaces(javaHome)) {
      throw new UndefinedJavaHomeException();
    }
    if (JdkUtil.checkForJdk(new File(javaHome)) || JdkUtil.checkForJre(javaHome)) {
      final Sdk jdk=JavaSdk.getInstance().createJdk("",javaHome);
      if (jdk == null) {
        throw new InvalidJavaHomeException(javaHome);
      }
      return jdk;
    }
 else {
      throw new InvalidJavaHomeException(javaHome);
    }
  }
  for (  Sdk projectJdk : ProjectJdkTable.getInstance().getAllJdks()) {
    if (projectJdk.getName().equals(jdkName)) {
      if (projectJdk.getHomePath() != null && (JdkUtil.checkForJdk(new File(projectJdk.getHomePath())) || JdkUtil.checkForJre(projectJdk.getHomePath()))) {
        return projectJdk;
      }
 else {
        throw new InvalidSdkException(projectJdk.getHomePath());
      }
    }
  }
  return null;
}
