{
  EditorFoldingInfo info=EditorFoldingInfo.get(myEditor);
  FoldingModelEx foldingModel=(FoldingModelEx)myEditor.getFoldingModel();
  Map<TextRange,Boolean> rangeToExpandStatusMap=new THashMap<>();
  FoldingUpdate.FoldingMap elementsToFold=new FoldingUpdate.FoldingMap(myElementsToFoldMap);
  removeInvalidRegions(info,foldingModel,elementsToFold,rangeToExpandStatusMap);
  Map<FoldRegion,Boolean> shouldExpand=new THashMap<>();
  Map<FoldingGroup,Boolean> groupExpand=new THashMap<>();
  List<FoldRegion> newRegions=addNewRegions(info,foldingModel,elementsToFold,rangeToExpandStatusMap,shouldExpand,groupExpand);
  applyExpandStatus(newRegions,shouldExpand,groupExpand);
  foldingModel.clearDocumentRangesModificationStatus();
}
