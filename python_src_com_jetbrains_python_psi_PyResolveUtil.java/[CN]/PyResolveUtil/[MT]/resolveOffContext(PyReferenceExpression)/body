{
  PsiElement ret=null;
  PsiElement our_cap=getConcealingParent(refex);
  ResolveProcessor proc=new ResolveProcessor(refex.getReferencedName());
  if (our_cap != null) {
    PsiElement cap=our_cap;
    while (true) {
      cap=getConcealingParent(cap);
      if (cap == null)       cap=refex.getContainingFile();
      ret=treeCrawlUp(proc,cap,true);
      if ((ret != null) && !PsiTreeUtil.isAncestor(our_cap,ret,true)) {
        if (!refersFromMethodToClass(our_cap,ret)) {
          break;
        }
      }
      if (cap instanceof PsiFile)       break;
    }
  }
  return ret;
}
