{
  if (expr == null || !expr.isValid() || oldExpr == null)   return;
  PsiElementFactory factory=JavaPsiFacade.getInstance(myProject).getElementFactory();
  PsiElement newExpr=expr;
  if (oldExpr instanceof PsiReferenceExpression) {
    final PsiReferenceExpression oldRef=(PsiReferenceExpression)oldExpr;
    final JavaResolveResult adv=oldRef.advancedResolve(false);
    final PsiElement scope=getClassContainingResolve(adv);
    final PsiElement clss=PsiTreeUtil.getParentOfType(oldExpr,PsiClass.class,PsiLambdaExpression.class);
    if (clss != null && scope != null) {
      final PsiElement subj=adv.getElement();
      if (subj instanceof PsiParameter) {
        PsiParameterList parameterList=myMethodToReplaceIn.getParameterList();
        if (subj.getParent() != parameterList)         return;
        final PsiParameter parameter=(PsiParameter)subj;
        int index=parameterList.getParameterIndex(parameter);
        if (index < 0)         return;
        if (index < myActualArgs.length) {
          PsiExpression actualArg=myActualArgs[index];
          PsiExpression initializer=actualArg;
          final PsiType parameterType=parameter.getType();
          if (parameter.isVarArgs() && parameterType instanceof PsiEllipsisType) {
            final String varargsJoin=StringUtil.join(ContainerUtil.map2Array(myActualArgs,String.class,new Function<PsiExpression,String>(){
              @Override public String fun(              PsiExpression expression){
                return expression != null ? expression.getText() : "null";
              }
            }
),index + 1,myActualArgs.length,",");
            String newArrayInitializer="new " + ((PsiEllipsisType)parameterType).toArrayType().getCanonicalText() + " {"+ varargsJoin+ "}";
            initializer=replaceInitializerWithVarargSubstitution(factory,parameter,initializer,newArrayInitializer);
          }
          if (RefactoringUtil.verifySafeCopyExpression(actualArg) == RefactoringUtil.EXPR_COPY_PROHIBITED) {
            newExpr=newExpr.replace(factory.createExpressionFromText(getTempVar(actualArg,initializer),null));
          }
 else {
            newExpr=newExpr.replace(initializer);
          }
        }
      }
 else       if ((subj instanceof PsiField || subj instanceof PsiMethod) && oldRef.getQualifierExpression() == null && PsiTreeUtil.isAncestor(clss,scope,false)) {
        boolean isStatic=subj instanceof PsiField && ((PsiField)subj).hasModifierProperty(PsiModifier.STATIC) || subj instanceof PsiMethod && ((PsiMethod)subj).hasModifierProperty(PsiModifier.STATIC);
        if (myInstanceRef != null && !isStatic) {
          String name=((PsiNamedElement)subj).getName();
          PsiReferenceExpression newRef=(PsiReferenceExpression)factory.createExpressionFromText("a." + name,null);
          newRef=(PsiReferenceExpression)CodeStyleManager.getInstance(myProject).reformat(newRef);
          PsiExpression instanceRef=getInstanceRef(factory);
          newRef.getQualifierExpression().replace(instanceRef);
          newRef=(PsiReferenceExpression)newExpr.replace(newRef);
          newExpr=newRef.getReferenceNameElement();
        }
      }
      if (subj instanceof PsiField && PsiTreeUtil.isAncestor(scope,clss,false)) {
        if (myReplaceFieldsWithGetters != IntroduceParameterRefactoring.REPLACE_FIELDS_WITH_GETTERS_NONE) {
          if (myReplaceFieldsWithGetters == IntroduceParameterRefactoring.REPLACE_FIELDS_WITH_GETTERS_ALL || myReplaceFieldsWithGetters == IntroduceParameterRefactoring.REPLACE_FIELDS_WITH_GETTERS_INACCESSIBLE && !JavaPsiFacade.getInstance(myProject).getResolveHelper().isAccessible((PsiMember)subj,newExpr,null)) {
            newExpr=replaceFieldWithGetter(newExpr,(PsiField)subj,oldRef.getQualifierExpression() == null && !((PsiField)subj).hasModifierProperty(PsiModifier.STATIC));
          }
        }
      }
    }
  }
 else   if (oldExpr instanceof PsiThisExpression && (((PsiThisExpression)oldExpr).getQualifier() == null || myManager.areElementsEquivalent(((PsiThisExpression)oldExpr).getQualifier().resolve(),myMethodToReplaceIn.getContainingClass()))) {
    if (myInstanceRef != null) {
      newExpr.replace(getInstanceRef(factory));
    }
    return;
  }
 else   if (oldExpr instanceof PsiSuperExpression && ((PsiSuperExpression)oldExpr).getQualifier() == null) {
    if (myInstanceRef != null) {
      newExpr.replace(getInstanceRef(factory));
    }
    return;
  }
  PsiElement[] oldChildren=oldExpr.getChildren();
  PsiElement[] newChildren=newExpr.getChildren();
  if (oldChildren.length == newChildren.length) {
    for (int i=0; i < oldChildren.length; i++) {
      resolveOldReferences(newChildren[i],oldChildren[i]);
    }
  }
}
