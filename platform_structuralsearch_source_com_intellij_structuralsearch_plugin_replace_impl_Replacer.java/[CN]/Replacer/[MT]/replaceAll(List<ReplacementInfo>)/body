{
  PsiElement lastAffectedElement=null;
  PsiElement currentAffectedElement;
  for (  ReplacementInfo info : resultPtrList) {
    PsiElement element=info.getMatch(0);
    initContextAndHandler(element);
    if (replaceHandler != null) {
      replaceHandler.prepare(info);
    }
  }
  for (  final ReplacementInfo aResultPtrList : resultPtrList) {
    currentAffectedElement=doReplace(aResultPtrList);
    if (currentAffectedElement != lastAffectedElement) {
      if (lastAffectedElement != null)       reformatAndPostProcess(lastAffectedElement);
      lastAffectedElement=currentAffectedElement;
    }
  }
  reformatAndPostProcess(lastAffectedElement);
}
