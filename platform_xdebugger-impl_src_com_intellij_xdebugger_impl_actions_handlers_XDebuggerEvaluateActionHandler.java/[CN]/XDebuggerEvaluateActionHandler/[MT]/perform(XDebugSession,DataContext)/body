{
  XDebuggerEditorsProvider editorsProvider=session.getDebugProcess().getEditorsProvider();
  XStackFrame stackFrame=session.getCurrentStackFrame();
  final XDebuggerEvaluator evaluator=session.getDebugProcess().getEvaluator();
  if (evaluator == null) {
    return;
  }
  Editor editor=CommonDataKeys.EDITOR.getData(dataContext);
  XExpression expression=null;
  if (editor != null) {
    expression=evaluator.getEditorExpression(editor,CommonDataKeys.PSI_FILE.getData(dataContext));
  }
  Language language=calcLanguage(stackFrame,dataContext);
  if (expression != null && !Comparing.equal(language,expression.getLanguage())) {
    expression=new XExpressionImpl(expression.getExpression(),language,expression.getCustomInfo(),expression.getMode());
  }
  if (expression == null) {
    XValue value=XDebuggerTreeActionBase.getSelectedValue(dataContext);
    if (value != null) {
      String text=value.getEvaluationExpression();
      if (!StringUtil.isEmpty(text)) {
        expression=new XExpressionImpl(text,language,null);
      }
    }
  }
  if (expression == null) {
    expression=new XExpressionImpl("",language,null);
  }
  new XDebuggerEvaluationDialog(session,editorsProvider,evaluator,expression,stackFrame == null ? null : stackFrame.getSourcePosition()).show();
}
