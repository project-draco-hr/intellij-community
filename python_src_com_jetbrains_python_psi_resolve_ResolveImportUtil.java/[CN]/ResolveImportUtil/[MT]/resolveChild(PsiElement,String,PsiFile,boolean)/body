{
  PsiDirectory dir=null;
  PsiElement ret=null;
  ResolveProcessor processor=null;
  if (parent instanceof PyFile) {
    boolean is_dir=(parent.getCopyableUserData(PyFile.KEY_IS_DIRECTORY) == Boolean.TRUE);
    PyFile pfparent=(PyFile)parent;
    if (!is_dir) {
      processor=new ResolveProcessor(referencedName);
      ret=PyResolveUtil.treeCrawlUp(processor,true,parent);
      if (ret != null)       return ret;
    }
 else {
      dir=pfparent.getContainingDirectory();
    }
  }
 else   if (parent instanceof PsiDirectory) {
    dir=(PsiDirectory)parent;
  }
 else   if (parent instanceof PsiDirectoryContainer) {
    final PsiDirectoryContainer container=(PsiDirectoryContainer)parent;
    for (    PsiDirectory childDir : container.getDirectories()) {
      final PsiElement result=resolveInDirectory(referencedName,containingFile,childDir,processor);
      if (fileOnly && !(result instanceof PsiFile) && !(result instanceof PsiDirectory))       return null;
      if (result != null)       return result;
    }
  }
  if (dir != null) {
    final PsiElement result=resolveInDirectory(referencedName,containingFile,dir,processor);
    if (fileOnly && !(result instanceof PsiFile) && !(result instanceof PsiDirectory))     return null;
    return result;
  }
  return ret;
}
