{
  if (qualifiedName == null)   return Collections.emptyList();
  String marker=StringUtil.join(qualifiedName.getComponents(),".") + "#" + Integer.toString(relative_level);
  Set<String> being_imported=ourBeingImported.get();
  if (being_imported.contains(marker))   return Collections.emptyList();
  try {
    being_imported.add(marker);
    if (relative_level > 0) {
      final PsiElement module=resolveModuleAt(stepBackFrom(source_file,relative_level),source_file,qualifiedName);
      return module != null ? Collections.singletonList(module) : Collections.<PsiElement>emptyList();
    }
 else {
      if (import_is_absolute) {
        return resolveModulesInRoots(qualifiedName,source_file);
      }
 else {
        final PsiDirectory dir=source_file.getOriginalFile().getContainingDirectory();
        PsiElement module=resolveModuleAt(dir,source_file,qualifiedName);
        if (module != null) {
          return Collections.singletonList(module);
        }
        List<PsiElement> found_in_roots=resolveModulesInRoots(qualifiedName,source_file);
        if (found_in_roots.size() > 0)         return found_in_roots;
        boolean has_djando_facet=false;
        final Module source_module=ModuleUtil.findModuleForPsiElement(source_file);
        if (source_module != null) {
          has_djando_facet=FacetManager.getInstance(source_module).getFacetByType(DjangoFacetType.ID) != null;
        }
        if (has_djando_facet) {
          ResolveInRootVisitor visitor=new ResolveInRootAsTopPackageVisitor(qualifiedName,source_file.getManager(),source_file,true);
          visitRoots(source_file,visitor);
          return visitor.results;
        }
        return Collections.emptyList();
      }
    }
  }
  finally {
    being_imported.remove(marker);
  }
}
