{
  if (qualifiedName == null || sourceFile == null) {
    return Collections.emptyList();
  }
  final String marker=StringUtil.join(qualifiedName.getComponents(),".") + "#" + Integer.toString(relativeLevel);
  final Set<String> beingImported=ourBeingImported.get();
  if (beingImported.contains(marker)) {
    return Collections.emptyList();
  }
  try {
    beingImported.add(marker);
    final QualifiedNameResolver visitor=new QualifiedNameResolver(qualifiedName).fromElement(sourceFile);
    if (relativeLevel > 0) {
      visitor.withRelative(relativeLevel).withoutRoots();
    }
 else {
      if (!importIsAbsolute) {
        visitor.withRelative(0);
      }
    }
    final List<PsiFileSystemItem> results=visitor.resultsAsList();
    if (results.isEmpty() && relativeLevel == 0 && !importIsAbsolute) {
      final PsiDirectory containingDirectory=sourceFile.getContainingDirectory();
      if (containingDirectory != null) {
        final PyQualifiedName containingPath=findCanonicalImportPath(containingDirectory,null);
        if (containingPath != null && containingPath.getComponentCount() > 0) {
          final PyQualifiedName absolutePath=containingPath.append(qualifiedName.toString());
          final QualifiedNameResolver absoluteVisitor=new QualifiedNameResolver(absolutePath).fromElement(sourceFile);
          return absoluteVisitor.resultsAsList();
        }
      }
    }
    return results;
  }
  finally {
    beingImported.remove(marker);
  }
}
