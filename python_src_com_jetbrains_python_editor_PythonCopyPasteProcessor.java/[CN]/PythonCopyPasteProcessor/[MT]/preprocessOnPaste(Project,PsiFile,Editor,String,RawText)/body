{
  if (!CodeInsightSettings.getInstance().INDENT_TO_CARET_ON_PASTE) {
    return text;
  }
  final CaretModel caretModel=editor.getCaretModel();
  final Document document=editor.getDocument();
  String newText=text;
  if (file instanceof PyFile && (StringUtil.startsWithWhitespace(text) || StringUtil.endsWithLineBreak(text) || StringUtil.splitByLines(text).length > 1)) {
    if (text.endsWith("\n"))     text=text.substring(0,text.length() - 1);
    final int caretOffset=caretModel.getOffset();
    final PsiElement element=PsiUtilCore.getElementAtOffset(file,caretOffset - 1);
    final int lineNumber=document.getLineNumber(caretOffset);
    final int offset=getLineStartSafeOffset(document,lineNumber);
    final PsiElement element1=PsiUtilCore.getElementAtOffset(file,offset);
    if (element instanceof PsiWhiteSpace && element == element1) {
      final List<String> strings=StringUtil.split(element.getText(),"\n");
      if (StringUtil.countChars(element.getText(),'\n') > 2) {
        newText=text + " ";
      }
 else {
        newText=text + "\n" + strings.get(strings.size() - 1);
        if (!element.getText().endsWith("\n"))         caretModel.moveToOffset(element.getTextRange().getEndOffset());
      }
    }
  }
  return newText;
}
