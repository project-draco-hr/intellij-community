{
  if (!CodeInsightSettings.getInstance().INDENT_TO_CARET_ON_PASTE) {
    return text;
  }
  final CaretModel caretModel=editor.getCaretModel();
  final Document document=editor.getDocument();
  String newText=text;
  if (file instanceof PyFile) {
    final int caretOffset=caretModel.getOffset();
    final int lineNumber=document.getLineNumber(caretOffset);
    final int lineStartOffset=getLineStartSafeOffset(document,lineNumber);
    final List<String> strings=StringUtil.split(text,"\n");
    if (StringUtil.countChars(text,'\n') > 0 || StringUtil.startsWithWhitespace(text)) {
      final PsiElement element=PsiUtilCore.getElementAtOffset(file,caretOffset - 1);
      if (PsiTreeUtil.getParentOfType(element,PyStringLiteralExpression.class) != null)       return text;
      caretModel.moveToOffset(lineStartOffset);
      String spaceString;
      int indent=0;
      if (strings.size() > 0) {
        spaceString=strings.get(0);
        indent=StringUtil.findFirst(spaceString,CharFilter.NOT_WHITESPACE_FILTER);
        if (indent < 0)         indent=StringUtil.isEmptyOrSpaces(spaceString) ? spaceString.length() : 0;
        if (!StringUtil.startsWithWhitespace(spaceString) && strings.size() > 1) {
          spaceString=strings.get(1);
          indent=StringUtil.findFirst(spaceString,CharFilter.NOT_WHITESPACE_FILTER);
          if (indent < 0)           indent=StringUtil.isEmptyOrSpaces(spaceString) ? spaceString.length() : 0;
          final String trimmed=StringUtil.trimLeading(strings.get(0));
          if (trimmed.startsWith("def ") || trimmed.startsWith("if ") || trimmed.startsWith("try:")|| trimmed.startsWith("class ")|| trimmed.startsWith("for ")|| trimmed.startsWith("elif ")|| trimmed.startsWith("else:")|| trimmed.startsWith("except")|| trimmed.startsWith("while ")) {
            indent=StringUtil.findFirst(spaceString,CharFilter.NOT_WHITESPACE_FILTER) / 2;
            if (indent < 0)             indent=0;
          }
        }
      }
      if (!StringUtil.isEmptyOrSpaces(text))       text=StringUtil.trimTrailing(text);
      if (!StringUtil.startsWithWhitespace(text)) {
        if (indent > 0)         newText=StringUtil.repeat(" ",indent) + text;
 else         newText=new String(text);
      }
 else {
        newText=new String(text);
      }
      if (element instanceof PsiWhiteSpace && (StringUtil.countChars(element.getText(),'\n') <= 2 && !StringUtil.isEmptyOrSpaces(text))) {
        newText+="\n";
      }
 else       newText=new String(newText);
    }
  }
  return newText;
}
