{
  PsiElement nonWS=PyUtil.findNextAtOffset(file,caretOffset,PsiWhiteSpace.class);
  if (nonWS != null) {
    final IElementType nonWSType=nonWS.getNode().getElementType();
    if (nonWSType == PyTokenTypes.ELSE_KEYWORD || nonWSType == PyTokenTypes.ELIF_KEYWORD || nonWSType == PyTokenTypes.EXCEPT_KEYWORD || nonWSType == PyTokenTypes.FINALLY_KEYWORD) {
      lineNumber-=1;
      nonWS=PyUtil.findNextAtOffset(file,getLineStartSafeOffset(document,lineNumber),PsiWhiteSpace.class);
    }
  }
  if (nonWS != null && document.getLineNumber(nonWS.getTextOffset()) == lineNumber) {
    return PyIndentUtil.getLineIndent(document,lineNumber);
  }
  int lineStartOffset=getLineStartSafeOffset(document,lineNumber);
  final PsiElement ws=file.findElementAt(lineStartOffset);
  if (ws != null) {
    PyStatementList statementList=ObjectUtils.chooseNotNull(as(ws.getNextSibling(),PyStatementList.class),as(ws.getPrevSibling(),PyStatementList.class));
    if (statementList != null && statementList.getStatements().length == 0) {
      return PyIndentUtil.getExpectedElementIndent(statementList);
    }
    final PyStatementListContainer container=PsiTreeUtil.getParentOfType(ws,PyStatementListContainer.class);
    if (container != null) {
      return PyIndentUtil.getElementIndent(container.getStatementList());
    }
  }
  return document.getText(TextRange.create(lineStartOffset,caretOffset));
}
