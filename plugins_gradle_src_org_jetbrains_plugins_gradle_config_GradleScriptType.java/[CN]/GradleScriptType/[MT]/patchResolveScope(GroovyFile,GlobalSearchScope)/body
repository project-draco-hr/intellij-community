{
  if (!FileUtilRt.extensionEquals(file.getName(),GradleConstants.EXTENSION))   return baseScope;
  final Collection<VirtualFile> files;
  GlobalSearchScope result=GlobalSearchScope.notScope(baseScope);
  final Module module=ModuleUtilCore.findModuleForPsiElement(file);
  if (module != null) {
    for (    OrderEntry entry : ModuleRootManager.getInstance(module).getOrderEntries()) {
      if (entry instanceof JdkOrderEntry) {
        GlobalSearchScope scopeForSdk=LibraryScopeCache.getInstance(module.getProject()).getScopeForSdk((JdkOrderEntry)entry);
        result=result.uniteWith(scopeForSdk);
      }
    }
    String modulePath=module.getOptionValue(ExternalSystemConstants.LINKED_PROJECT_PATH_KEY);
    if (modulePath == null)     return result;
    files=GradleBuildClasspathManager.getInstance(file.getProject()).getModuleClasspathEntries(modulePath);
    for (    final VirtualFile root : files) {
      result=result.uniteWith(new NonClasspathDirectoryScope(root));
    }
    result=new ExternalModuleBuildGlobalSearchScope(result,modulePath);
  }
  return result;
}
