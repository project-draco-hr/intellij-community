{
  if (state instanceof JavaCommandLine) {
    final JavaParameters parameters=((JavaCommandLine)state).getJavaParameters();
    runCustomPatchers(parameters,environment.getExecutor(),environment.getRunProfile());
    RemoteConnection connection=DebuggerManagerImpl.createDebugParameters(parameters,true,DebuggerSettings.getInstance().DEBUGGER_TRANSPORT,"",false);
    return attachVirtualMachine(state,environment,connection,true);
  }
  if (state instanceof PatchedRunnableState) {
    final RemoteConnection connection=doPatch(new JavaParameters(),environment.getRunnerSettings());
    return attachVirtualMachine(state,environment,connection,true);
  }
  if (state instanceof RemoteState) {
    final RemoteConnection connection=createRemoteDebugConnection((RemoteState)state,environment.getRunnerSettings());
    return attachVirtualMachine(state,environment,connection,false);
  }
  return null;
}
