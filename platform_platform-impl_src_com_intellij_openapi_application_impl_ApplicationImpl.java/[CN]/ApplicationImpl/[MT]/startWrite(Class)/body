{
  Status status=getStatus();
  assertIsDispatchThread(status,"Write access is allowed from event dispatch thread only");
  boolean writeActionPending=myWriteActionPending;
  myWriteActionPending=true;
  long start=System.currentTimeMillis();
  try {
    ActivityTracker.getInstance().inc();
    fireBeforeWriteActionStart(clazz);
    try {
      if (!myLock.isWriteLocked()) {
        assertNoPsiLock();
        if ((status.stamp=myLock.tryWriteLock()) == 0) {
          final AtomicBoolean lockAcquired=new AtomicBoolean(false);
          if (ourDumpThreadsOnLongWriteActionWaiting > 0) {
            executeOnPooledThread(new Runnable(){
              @Override public void run(){
                while (!lockAcquired.get()) {
                  TimeoutUtil.sleep(ourDumpThreadsOnLongWriteActionWaiting);
                  if (!lockAcquired.get()) {
                    PerformanceWatcher.getInstance().dumpThreads("waiting",true);
                  }
                }
              }
            }
);
          }
          status.stamp=myLock.writeLockInterruptibly();
          lockAcquired.set(true);
        }
      }
    }
 catch (    InterruptedException e) {
      throw new RuntimeInterruptedException(e);
    }
  }
  finally {
    myWriteActionPending=writeActionPending;
  }
  myWriteActionsStack.push(clazz);
  if (LOG.isDebugEnabled()) {
    long end=System.currentTimeMillis();
    writePauses.add(end - start);
  }
  fireWriteActionStarted(clazz);
}
