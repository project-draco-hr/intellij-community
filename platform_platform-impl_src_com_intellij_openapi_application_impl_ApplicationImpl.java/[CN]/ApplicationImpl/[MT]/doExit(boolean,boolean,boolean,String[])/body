{
  try {
    if (!force && !confirmExitIfNeeded(exitConfirmed)) {
      return;
    }
    getMessageBus().syncPublisher(AppLifecycleListener.TOPIC).appClosing();
    myDisposeInProgress=true;
    if (!force && !canExit()) {
      return;
    }
    saveSettings();
    if (allowListenersToCancel && !canExit()) {
      return false;
    }
    final boolean success=disposeSelf(allowListenersToCancel);
    if (!success || isUnitTestMode() || Boolean.getBoolean("idea.test.guimode")) {
      if (Boolean.getBoolean("idea.test.guimode")) {
        IdeaApplication.getInstance().shutdown();
      }
      return;
    }
    int exitCode=0;
    if (restart && Restarter.isSupported()) {
      try {
        Restarter.scheduleRestart(beforeRestart);
      }
 catch (      Throwable t) {
        LOG.error("Restart failed",t);
        Main.showMessage("Restart failed",t);
        exitCode=Main.RESTART_FAILED;
      }
    }
    System.exit(exitCode);
  }
  finally {
    myDisposeInProgress=false;
    myExitInProgress=false;
  }
}
