{
  try {
    if (!force && !confirmExitIfNeeded(exitConfirmed)) {
      saveAll();
      return;
    }
    getMessageBus().syncPublisher(AppLifecycleListener.TOPIC).appClosing();
    myDisposeInProgress=true;
    saveSettings();
    if (!force && !canExit()) {
      return;
    }
    boolean success=disposeSelf(!force);
    if (!success || isUnitTestMode()) {
      return;
    }
    int exitCode=0;
    if (restart && Restarter.isSupported()) {
      try {
        exitCode=Restarter.scheduleRestart();
      }
 catch (      IOException e) {
        LOG.warn("Cannot restart",e);
      }
    }
    System.exit(exitCode);
  }
  finally {
    myDisposeInProgress=false;
    myExitInProgress=false;
  }
}
