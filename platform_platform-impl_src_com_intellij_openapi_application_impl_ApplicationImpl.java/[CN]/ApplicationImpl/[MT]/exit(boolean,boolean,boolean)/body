{
  if (exiting)   return;
  exiting=true;
  try {
    if (!force && getDefaultModalityState() != ModalityState.NON_MODAL) {
      return;
    }
    Runnable runnable=new Runnable(){
      @Override public void run(){
        if (!confirmExitIfNeeded(force)) {
          saveAll();
          return;
        }
        getMessageBus().syncPublisher(AppLifecycleListener.TOPIC).appClosing();
        myDisposeInProgress=true;
        if (!doExit(allowListenersToCancel,restart)) {
          myDisposeInProgress=false;
        }
      }
    }
;
    if (!isDispatchThread()) {
      invokeLater(runnable,ModalityState.NON_MODAL);
    }
 else {
      runnable.run();
    }
  }
  finally {
    exiting=false;
  }
}
