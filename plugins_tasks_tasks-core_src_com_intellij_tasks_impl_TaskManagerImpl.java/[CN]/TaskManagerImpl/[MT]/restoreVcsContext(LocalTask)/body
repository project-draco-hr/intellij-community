{
  if (!isVcsEnabled())   return task;
  List<ChangeListInfo> changeLists=task.getChangeLists();
  if (!changeLists.isEmpty()) {
    ChangeListInfo info=changeLists.get(0);
    LocalChangeList changeList=myChangeListManager.getChangeList(info.id);
    if (changeList == null) {
      changeList=myChangeListManager.addChangeList(info.name,info.comment);
      info.id=changeList.getId();
    }
    myChangeListManager.setDefaultChangeList(changeList);
  }
  List<BranchInfo> branches=task.getBranches(false);
  MultiMap<String,BranchInfo> multiMap=new MultiMap<String,BranchInfo>();
  for (  BranchInfo branch : branches) {
    multiMap.putValue(branch.repository,branch);
  }
  for (  String repo : multiMap.keySet()) {
    Collection<BranchInfo> infos=multiMap.get(repo);
    if (infos.size() > 1) {
      List<BranchInfo> existing=getAllBranches(repo);
      for (Iterator<BranchInfo> iterator=infos.iterator(); iterator.hasNext(); ) {
        BranchInfo info=iterator.next();
        if (!existing.contains(info)) {
          iterator.remove();
          if (infos.size() == 1) {
            break;
          }
        }
      }
    }
  }
  VcsTaskHandler.TaskInfo info=fromBranches(new ArrayList<BranchInfo>(multiMap.values()));
  switchBranch(info);
  return task;
}
