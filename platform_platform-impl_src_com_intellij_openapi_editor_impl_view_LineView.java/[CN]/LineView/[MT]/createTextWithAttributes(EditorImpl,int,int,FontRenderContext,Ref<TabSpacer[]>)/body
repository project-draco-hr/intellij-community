{
  String text=editor.getDocument().getImmutableCharSequence().subSequence(startOffset,endOffset).toString();
  AttributedString string=createAttributedString(text);
  FontPreferences fontPreferences=editor.getColorsScheme().getFontPreferences();
  List<Integer> tabRendererPositions=new ArrayList<Integer>();
  IterationState it=new IterationState(editor,startOffset,endOffset,true,false,false);
  while (!it.atEnd()) {
    TextAttributes attributes=it.getMergedAttributes();
    setFontAttributes(string,it.getStartOffset() - startOffset,it.getEndOffset() - startOffset,attributes.getFontType(),attributes.getForegroundColor(),fontPreferences,tabRendererPositions);
    it.advance();
  }
  insertTabRenderers(editor,string,tabRendererPositions,fontRenderContext,tabs,startOffset == 0);
  return string.getIterator();
}
