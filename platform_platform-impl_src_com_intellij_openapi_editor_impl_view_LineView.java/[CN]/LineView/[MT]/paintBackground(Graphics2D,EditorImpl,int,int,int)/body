{
  IterationState it=new IterationState(editor,startOffset,endOffset,editor.isPaintSelection());
  if (myLayout != null) {
    while (!it.atEnd()) {
      paintBackground(g,editor,myLayout,it.getStartOffset() - startOffset,it.getEndOffset() - startOffset,it.getMergedAttributes());
      it.advance();
    }
  }
  int lastSegmentX=paintAfterLineEndBackgroundSegments(g,editor,it,getWidthInPixels(),plainSpaceWidth);
  if (endOffset < editor.getDocument().getTextLength()) {
    Color color=EditorView.getBackgroundColor(editor,it.getPastLineEndBackgroundAttributes());
    paintBackgroundTillClipRightBoundary(g,editor,color,lastSegmentX);
  }
 else {
    if (it.hasPastFileEndBackgroundSegments()) {
      lastSegmentX=paintAfterLineEndBackgroundSegments(g,editor,it,lastSegmentX,plainSpaceWidth);
    }
    Color color=it.getPastFileEndBackground();
    paintBackgroundTillClipRightBoundary(g,editor,color,lastSegmentX);
  }
}
