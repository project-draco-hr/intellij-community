{
  final String userDefined=System.getProperty(COVERAGE_AGENT_PATH);
  if (userDefined != null && new File(userDefined).exists()) {
    agentPath=userDefined;
  }
 else {
    agentPath=new File(agentPath).getParent();
  }
  if (!SystemInfo.isWindows && agentPath.contains(" ")) {
    File dir=new File(PathManager.getSystemPath(),"coverageJars");
    if (dir.getAbsolutePath().contains(" ")) {
      try {
        dir=FileUtil.createTempDirectory("coverage","jars");
        if (dir.getAbsolutePath().contains(" ")) {
          LOG.info("Coverage agent not used since the agent path contains spaces: " + agentPath + "\n"+ "One can move the agent libraries to a directory with no spaces in path and specify its path in idea.properties as "+ COVERAGE_AGENT_PATH+ "=<path>");
          return agentPath;
        }
      }
 catch (      IOException e) {
        LOG.info(e);
        return agentPath;
      }
    }
    try {
      LOG.info("Coverage jars were copied to " + dir.getPath());
      FileUtil.copyDir(new File(agentPath),dir,new FileFilter(){
        @Override public boolean accept(        File file){
          final String fileName=file.getName();
          return fileName.startsWith("coverage-") || fileName.startsWith("asm-all") || fileName.startsWith("trove4j");
        }
      }
);
      return dir.getPath();
    }
 catch (    IOException e) {
      LOG.info(e);
    }
  }
  return agentPath;
}
