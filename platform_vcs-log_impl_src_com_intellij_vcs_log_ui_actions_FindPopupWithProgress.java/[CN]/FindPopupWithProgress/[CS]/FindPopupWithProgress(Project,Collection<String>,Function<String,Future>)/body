{
  myFunction=function;
  myTextField=new TextFieldWithProgress(project,variants){
    @Override public void onOk(){
      if (myFuture == null) {
        final Future future=myFunction.fun(getText().trim());
        myFuture=future;
        showProgress();
        ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
          @Override public void run(){
            try {
              future.get();
              okPopup();
            }
 catch (            CancellationException ex) {
              cancelPopup();
            }
catch (            InterruptedException ex) {
              cancelPopup();
            }
catch (            ExecutionException ex) {
              LOG.error(ex);
              cancelPopup();
            }
          }
        }
);
      }
    }
  }
;
  myPopup=JBPopupFactory.getInstance().createComponentPopupBuilder(myTextField,myTextField.getPreferableFocusComponent()).setCancelOnClickOutside(true).setCancelOnWindowDeactivation(true).setCancelKeyEnabled(true).setRequestFocus(true).createPopup();
  myPopup.addListener(new JBPopupListener.Adapter(){
    @Override public void onClosed(    LightweightWindowEvent event){
      if (!event.isOk()) {
        if (myFuture != null) {
          myFuture.cancel(true);
        }
      }
      myFuture=null;
      myTextField.hideProgress();
    }
  }
);
  final JBTextField field=new JBTextField(20);
  final Dimension size=field.getPreferredSize();
  final Insets insets=myTextField.getBorder().getBorderInsets(myTextField);
  size.height+=6 + insets.top + insets.bottom;
  size.width+=4 + insets.left + insets.right;
  myPopup.setSize(size);
}
