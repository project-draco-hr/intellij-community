{
  final Map<String,String> attrs=new HashMap<>();
  attrs.put("name",testIdentifier.getDisplayName());
  attrs.put("id",testIdentifier.getUniqueId().toString());
  if (duration > 0) {
    attrs.put("duration",Long.toString(duration));
  }
  if (reason != null) {
    attrs.put("message",reason);
  }
  try {
    if (ex != null) {
      final StringWriter stringWriter=new StringWriter();
      final PrintWriter writer=new PrintWriter(stringWriter);
      ex.printStackTrace(writer);
      final ComparisonFailureData failureData;
      if (ex instanceof AssertionFailedError && ((AssertionFailedError)ex).isActualDefined() && ((AssertionFailedError)ex).isExpectedDefined()) {
        final ValueWrapper actual=((AssertionFailedError)ex).getActual();
        final ValueWrapper expected=((AssertionFailedError)ex).getExpected();
        failureData=new ComparisonFailureData(expected.getStringRepresentation(),actual.getStringRepresentation());
      }
 else {
        failureData=ExpectedPatterns.createExceptionNotification(ex);
      }
      ComparisonFailureData.registerSMAttributes(failureData,stringWriter.toString(),ex.getMessage(),attrs,ex);
    }
  }
  finally {
    myPrintStream.println("\n" + MapSerializerUtil.asString(messageName,attrs));
  }
}
