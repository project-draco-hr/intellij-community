{
  final String displayName=testIdentifier.getDisplayName();
  if (testIdentifier.isTest()) {
    final long duration=getDuration();
    if (status == TestExecutionResult.Status.FAILED) {
      testFailure(testIdentifier,MapSerializerUtil.TEST_FAILED,throwableOptional,duration,reason,true);
    }
 else     if (status == TestExecutionResult.Status.ABORTED) {
      testFailure(testIdentifier,MapSerializerUtil.TEST_IGNORED,throwableOptional,duration,reason,true);
    }
    testFinished(testIdentifier,duration);
    myFinishCount++;
  }
 else   if (!myRoots.contains(testIdentifier)) {
    String messageName=null;
    if (status == TestExecutionResult.Status.FAILED) {
      messageName=MapSerializerUtil.TEST_FAILED;
    }
 else     if (status == TestExecutionResult.Status.ABORTED) {
      messageName=MapSerializerUtil.TEST_IGNORED;
    }
    if (messageName != null && myFinishCount == 0) {
      final Set<TestIdentifier> descendants=myTestPlan.getDescendants(testIdentifier);
      if (!descendants.isEmpty()) {
        for (        TestIdentifier childIdentifier : descendants) {
          testStarted(childIdentifier);
          testFailure(childIdentifier,messageName,throwableOptional,0,reason,true);
          testFinished(childIdentifier,0);
        }
      }
 else {
        testStarted(testIdentifier);
        testFailure(testIdentifier,messageName,throwableOptional,0,reason,true);
        testFinished(testIdentifier,0);
        myFinishCount++;
      }
    }
    myPrintStream.println("##teamcity[testSuiteFinished " + idAndName(testIdentifier,displayName) + "\']");
  }
}
