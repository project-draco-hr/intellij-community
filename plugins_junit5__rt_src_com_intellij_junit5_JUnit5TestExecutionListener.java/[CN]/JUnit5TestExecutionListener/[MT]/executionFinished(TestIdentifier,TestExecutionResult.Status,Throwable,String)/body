{
  final String displayName=testIdentifier.getDisplayName();
  if (testIdentifier.isTest()) {
    final long duration=System.currentTimeMillis() - myCurrentTestStart;
    if (status == TestExecutionResult.Status.FAILED) {
      testFailure(testIdentifier,MapSerializerUtil.TEST_FAILED,throwableOptional,duration,reason);
    }
 else     if (status == TestExecutionResult.Status.ABORTED) {
      testFailure(testIdentifier,MapSerializerUtil.TEST_IGNORED,throwableOptional,duration,reason);
    }
    testFinished(testIdentifier,duration);
    myFinishCount++;
  }
 else   if (!myRoots.contains(testIdentifier)) {
    String messageName=null;
    if (status == TestExecutionResult.Status.FAILED) {
      messageName=MapSerializerUtil.TEST_FAILED;
    }
 else     if (status == TestExecutionResult.Status.ABORTED) {
      messageName=MapSerializerUtil.TEST_IGNORED;
    }
    if (messageName != null && myFinishCount == 0) {
      for (      TestIdentifier childIdentifier : myTestPlan.getDescendants(testIdentifier)) {
        testStarted(childIdentifier);
        testFailure(childIdentifier,messageName,throwableOptional,0,reason);
        testFinished(childIdentifier,0);
      }
    }
    myPrintStream.println("##teamcity[testSuiteFinished " + idAndName(testIdentifier,displayName) + "\']");
  }
}
