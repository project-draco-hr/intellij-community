{
  for (  LinkedList<UndoableGroup> each : getAffectedStacks(clearGlobal,refs)) {
    while (!each.isEmpty()) {
      clearStacksFrom(each.getLast());
    }
  }
  Set<DocumentReference> stacksToDrop=new THashSet<DocumentReference>();
  for (  Map.Entry<DocumentReference,LinkedList<UndoableGroup>> each : myDocumentStacks.entrySet()) {
    if (each.getValue().isEmpty())     stacksToDrop.add(each.getKey());
  }
  for (  DocumentReference each : stacksToDrop) {
    myDocumentStacks.remove(each);
  }
  cleanWeaklyTrackedEmptyStacks(myDocumentsWithStacks);
  cleanWeaklyTrackedEmptyStacks(myLightVirtualFilesWithStacks);
}
