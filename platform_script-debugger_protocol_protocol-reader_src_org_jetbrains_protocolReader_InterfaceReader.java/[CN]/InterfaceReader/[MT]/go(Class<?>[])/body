{
  for (  Class<?> typeClass : classes) {
    createIfNotExists(typeClass);
  }
  boolean hasUnresolved=true;
  while (hasUnresolved) {
    hasUnresolved=false;
    for (int i=0, n=refs.size(); i < n; i++) {
      TypeRef<?> ref=refs.get(i);
      TypeHandler<?> type=typeToTypeHandler.get(ref.typeClass);
      if (type == null) {
        createIfNotExists(ref.typeClass);
        hasUnresolved=true;
        type=typeToTypeHandler.get(ref.typeClass);
        if (type == null) {
          throw new IllegalStateException();
        }
      }
      ref.set(type);
    }
  }
  for (  SubtypeCaster subtypeCaster : subtypeCasters) {
    ExistingSubtypeAspect subtypeSupport=subtypeCaster.getSubtypeHandler().getSubtypeSupport();
    if (subtypeSupport != null) {
      subtypeSupport.setSubtypeCaster(subtypeCaster);
    }
  }
  return typeToTypeHandler;
}
