{
  final Editor editor=event.getEditor();
  final Project project=editor.getProject();
  if (project == null) {
    return;
  }
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          Document document=editor.getDocument();
          VirtualFile openedFile=FileDocumentManager.getInstance().getFile(document);
          if (openedFile != null) {
            StudyTaskManager taskManager=StudyTaskManager.getInstance(project);
            TaskFile taskFile=taskManager.getTaskFile(openedFile);
            if (taskFile != null) {
              EditorActionManager.getInstance().setReadonlyFragmentModificationHandler(document,new InvalidTaskFileModificationHandler());
              taskFile.navigateToFirstTaskWindow(editor);
              editor.addEditorMouseListener(new WindowSelectionListener(taskFile));
              StudyDocumentListener listener=new StudyDocumentListener(taskFile,project);
              StudyEditor.addDocumentListener(document,listener);
              document.addDocumentListener(listener);
              taskFile.drawAllWindows(editor);
              if (!taskFile.isValid()) {
                document.createGuardedBlock(0,document.getTextLength());
                EditorNotifications.getInstance(project).updateNotifications(openedFile);
                editor.getMarkupModel().removeAllHighlighters();
              }
            }
          }
        }
      }
);
    }
  }
);
}
