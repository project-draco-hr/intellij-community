{
  final Collection<PsiClass> classes=JavaShortClassNameIndex.getInstance().get(name,myManager.getProject(),scope);
  if (classes.isEmpty())   return PsiClass.EMPTY_ARRAY;
  ArrayList<PsiClass> list=new ArrayList<PsiClass>(classes.size());
  Map<String,List<PsiClass>> uniqueQName2Classes=new THashMap<String,List<PsiClass>>(classes.size());
  List<PsiClass> hiddenClasses=null;
  OuterLoop:   for (  PsiClass aClass : classes) {
    VirtualFile vFile=aClass.getContainingFile().getVirtualFile();
    if (!scope.contains(vFile))     continue;
    String qName=aClass.getQualifiedName();
    if (qName != null) {
      List<PsiClass> previousQNamedClasses=uniqueQName2Classes.get(qName);
      List<PsiClass> qNamedClasses;
      if (previousQNamedClasses != null) {
        qNamedClasses=new SmartList<PsiClass>();
        for (        PsiClass previousClass : previousQNamedClasses) {
          VirtualFile previousClassVFile=previousClass.getContainingFile().getVirtualFile();
          int res=scope.compare(previousClassVFile,vFile);
          if (res > 0) {
            continue OuterLoop;
          }
 else           if (res < 0) {
            if (hiddenClasses == null)             hiddenClasses=new SmartList<PsiClass>();
            hiddenClasses.add(previousClass);
            qNamedClasses.add(aClass);
          }
 else {
            qNamedClasses.add(aClass);
          }
        }
      }
 else {
        qNamedClasses=new SmartList<PsiClass>(aClass);
      }
      uniqueQName2Classes.put(qName,qNamedClasses);
    }
    list.add(aClass);
  }
  if (hiddenClasses != null)   list.removeAll(hiddenClasses);
  return list.toArray(new PsiClass[list.size()]);
}
