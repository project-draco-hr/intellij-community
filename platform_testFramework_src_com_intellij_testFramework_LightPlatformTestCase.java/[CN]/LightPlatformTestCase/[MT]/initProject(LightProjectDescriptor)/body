{
  ourProjectDescriptor=descriptor;
  final File projectFile=FileUtil.createTempFile("light_temp_",ProjectFileType.DOT_DEFAULT_EXTENSION);
  new WriteCommandAction.Simple(null){
    @SuppressWarnings("AssignmentToStaticFieldFromInstanceMethod") @Override protected void run() throws Throwable {
      if (ourProject != null) {
        closeAndDeleteProject();
      }
 else {
        cleanPersistedVFSContent();
      }
      LocalFileSystem.getInstance().refreshAndFindFileByIoFile(projectFile);
      ByteArrayOutputStream buffer=new ByteArrayOutputStream();
      new Throwable(projectFile.getPath()).printStackTrace(new PrintStream(buffer));
      ourProject=PlatformTestCase.createProject(projectFile,LIGHT_PROJECT_MARK + buffer);
      ourPathToKeep=projectFile.getPath();
      if (!ourHaveShutdownHook) {
        ourHaveShutdownHook=true;
        registerShutdownHook();
      }
      ourPsiManager=null;
      LightProjectDescriptor.ProjectInfo projectInfo=ourProjectDescriptor.setUpProject(ourProject);
      ourModule=projectInfo.module;
      ourSourceRoot=projectInfo.moduleSourcesRoot;
    }
  }
.execute().throwException();
  ((VirtualFilePointerManagerImpl)VirtualFilePointerManager.getInstance()).storePointers();
}
