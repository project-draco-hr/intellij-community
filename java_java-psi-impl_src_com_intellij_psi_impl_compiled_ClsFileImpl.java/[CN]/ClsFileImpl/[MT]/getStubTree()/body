{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  StubTree stubTree=dereference(myStub);
  if (stubTree != null)   return stubTree;
synchronized (myStubLock) {
    stubTree=dereference(myStub);
    if (stubTree != null)     return stubTree;
    stubTree=(StubTree)StubTreeLoader.getInstance().readOrBuild(getProject(),getVirtualFile(),this);
    if (stubTree == null) {
      LOG.warn("Class file is corrupted: " + getVirtualFile().getPresentableUrl());
      stubTree=new StubTree(new PsiJavaFileStubImpl("corrupted.classfiles",true));
    }
    myStub=new SoftReference<StubTree>(stubTree);
    ((PsiFileStubImpl)stubTree.getRoot()).setPsi(this);
  }
  return stubTree;
}
