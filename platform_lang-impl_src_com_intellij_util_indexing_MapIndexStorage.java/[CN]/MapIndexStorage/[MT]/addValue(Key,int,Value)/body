{
  try {
    if (myKeyHashToVirtualFileMapping != null) {
      myKeyHashToVirtualFileMapping.enumerate(new int[]{myKeyDescriptor.getHashCode(key),inputId});
      int lastScannedId=myLastScannedId;
      if (lastScannedId != 0) {
        ourInvalidatedSessionIds.cacheOrGet(lastScannedId,Boolean.TRUE);
        myLastScannedId=0;
      }
    }
    myMap.markDirty();
    if (!myKeyIsUniqueForIndexedFile) {
      read(key).addValue(inputId,value);
      return;
    }
    ChangeTrackingValueContainer<Value> cached;
    try {
      l.lock();
      cached=myCache.getIfCached(key);
    }
  finally {
      l.unlock();
    }
    if (cached != null) {
      cached.addValue(inputId,value);
      return;
    }
    ChangeTrackingValueContainer<Value> valueContainer=new ChangeTrackingValueContainer<Value>(null);
    valueContainer.addValue(inputId,value);
    myMap.put(key,valueContainer);
  }
 catch (  IOException e) {
    throw new StorageException(e);
  }
}
